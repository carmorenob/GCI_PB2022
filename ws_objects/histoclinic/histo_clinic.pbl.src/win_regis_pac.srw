$PBExportHeader$win_regis_pac.srw
$PBExportComments$Primerita
forward
global type win_regis_pac from window
end type
type ole_1 from olecustomcontrol within win_regis_pac
end type
type p_foto_org from picture within win_regis_pac
end type
type pb_9 from picturebutton within win_regis_pac
end type
type pb_8 from picturebutton within win_regis_pac
end type
type pb_7 from picturebutton within win_regis_pac
end type
type p_foto from picture within win_regis_pac
end type
type dw_4 from datawindow within win_regis_pac
end type
type sle_1 from singlelineedit within win_regis_pac
end type
type dw_2 from datawindow within win_regis_pac
end type
type tab_1 from tab within win_regis_pac
end type
type tabpage_1 from userobject within tab_1
end type
type dw_7 from datawindow within tabpage_1
end type
type pb_ayuda from picturebutton within tabpage_1
end type
type pb_refresh from picturebutton within tabpage_1
end type
type cb_guarda from picturebutton within tabpage_1
end type
type dw_1 from datawindow within tabpage_1
end type
type gb_4 from groupbox within tabpage_1
end type
type dw_6 from datawindow within tabpage_1
end type
type tabpage_1 from userobject within tab_1
dw_7 dw_7
pb_ayuda pb_ayuda
pb_refresh pb_refresh
cb_guarda cb_guarda
dw_1 dw_1
gb_4 gb_4
dw_6 dw_6
end type
type tab_afilia from userobject within tab_1
end type
type dw_req from datawindow within tab_afilia
end type
type tab_3 from tab within tab_afilia
end type
type tabpage_8 from userobject within tab_3
end type
type pb_3 from picturebutton within tabpage_8
end type
type pb_1 from picturebutton within tabpage_8
end type
type cb_save from picturebutton within tabpage_8
end type
type cb_dele from picturebutton within tabpage_8
end type
type dw_emppacg from datawindow within tabpage_8
end type
type tabpage_8 from userobject within tab_3
pb_3 pb_3
pb_1 pb_1
cb_save cb_save
cb_dele cb_dele
dw_emppacg dw_emppacg
end type
type tabpage_6 from userobject within tab_3
end type
type pb_exp from picturebutton within tabpage_6
end type
type dw_tree from datawindow within tabpage_6
end type
type tabpage_6 from userobject within tab_3
pb_exp pb_exp
dw_tree dw_tree
end type
type tab_3 from tab within tab_afilia
tabpage_8 tabpage_8
tabpage_6 tabpage_6
end type
type cbx_act from checkbox within tab_afilia
end type
type cb_inser from picturebutton within tab_afilia
end type
type dw_esco from datawindow within tab_afilia
end type
type dw_serv from datawindow within tab_afilia
end type
type dw_empac from datawindow within tab_afilia
end type
type gb_1 from groupbox within tab_afilia
end type
type tab_afilia from userobject within tab_1
dw_req dw_req
tab_3 tab_3
cbx_act cbx_act
cb_inser cb_inser
dw_esco dw_esco
dw_serv dw_serv
dw_empac dw_empac
gb_1 gb_1
end type
type tabpage_2 from userobject within tab_1
end type
type pb_ayuda2 from picturebutton within tabpage_2
end type
type cb_4 from picturebutton within tabpage_2
end type
type cb_3 from picturebutton within tabpage_2
end type
type cb_2 from picturebutton within tabpage_2
end type
type dw_3 from datawindow within tabpage_2
end type
type tabpage_2 from userobject within tab_1
pb_ayuda2 pb_ayuda2
cb_4 cb_4
cb_3 cb_3
cb_2 cb_2
dw_3 dw_3
end type
type tabpage_3 from userobject within tab_1
end type
type pb_ayuda3 from picturebutton within tabpage_3
end type
type cb_ultimo from picturebutton within tabpage_3
end type
type cb_posterior from picturebutton within tabpage_3
end type
type cb_guardar from picturebutton within tabpage_3
end type
type cb_borrar from picturebutton within tabpage_3
end type
type cb_adic from picturebutton within tabpage_3
end type
type cb_anterior from picturebutton within tabpage_3
end type
type cb_primero from picturebutton within tabpage_3
end type
type dw_hist_lab from datawindow within tabpage_3
end type
type tabpage_3 from userobject within tab_1
pb_ayuda3 pb_ayuda3
cb_ultimo cb_ultimo
cb_posterior cb_posterior
cb_guardar cb_guardar
cb_borrar cb_borrar
cb_adic cb_adic
cb_anterior cb_anterior
cb_primero cb_primero
dw_hist_lab dw_hist_lab
end type
type tabpage_4 from userobject within tab_1
end type
type pb_ayuda4 from picturebutton within tabpage_4
end type
type cb_ultimo1 from picturebutton within tabpage_4
end type
type cb_posterior1 from picturebutton within tabpage_4
end type
type cb_guardar1 from picturebutton within tabpage_4
end type
type cb_borrar1 from picturebutton within tabpage_4
end type
type cb_adic1 from picturebutton within tabpage_4
end type
type cb_anterior1 from picturebutton within tabpage_4
end type
type cb_primero1 from picturebutton within tabpage_4
end type
type dw_5 from datawindow within tabpage_4
end type
type tabpage_4 from userobject within tab_1
pb_ayuda4 pb_ayuda4
cb_ultimo1 cb_ultimo1
cb_posterior1 cb_posterior1
cb_guardar1 cb_guardar1
cb_borrar1 cb_borrar1
cb_adic1 cb_adic1
cb_anterior1 cb_anterior1
cb_primero1 cb_primero1
dw_5 dw_5
end type
type biometria from userobject within tab_1
end type
type pb_save from picturebutton within biometria
end type
type dw_huella_pac from datawindow within biometria
end type
type dw_biometria from datawindow within biometria
end type
type log_es from listbox within biometria
end type
type cbx_log from checkbox within biometria
end type
type p_imagen from picture within biometria
end type
type mle_1 from multilineedit within biometria
end type
type biometria from userobject within tab_1
pb_save pb_save
dw_huella_pac dw_huella_pac
dw_biometria dw_biometria
log_es log_es
cbx_log cbx_log
p_imagen p_imagen
mle_1 mle_1
end type
type tabpage_5 from userobject within tab_1
end type
type nm_3 from statictext within tabpage_5
end type
type nm_2 from statictext within tabpage_5
end type
type nm_1 from statictext within tabpage_5
end type
type cbx_2 from checkbox within tabpage_5
end type
type cbx_3 from checkbox within tabpage_5
end type
type cbx_1 from checkbox within tabpage_5
end type
type pb_printx from picturebutton within tabpage_5
end type
type hsb_1 from hscrollbar within tabpage_5
end type
type st_cuantos from statictext within tabpage_5
end type
type p_3 from picture within tabpage_5
end type
type p_2 from picture within tabpage_5
end type
type p_1 from picture within tabpage_5
end type
type pb_save_imagx from picturebutton within tabpage_5
end type
type pb_del_imagx from picturebutton within tabpage_5
end type
type pb_imagx from picturebutton within tabpage_5
end type
type tabpage_5 from userobject within tab_1
nm_3 nm_3
nm_2 nm_2
nm_1 nm_1
cbx_2 cbx_2
cbx_3 cbx_3
cbx_1 cbx_1
pb_printx pb_printx
hsb_1 hsb_1
st_cuantos st_cuantos
p_3 p_3
p_2 p_2
p_1 p_1
pb_save_imagx pb_save_imagx
pb_del_imagx pb_del_imagx
pb_imagx pb_imagx
end type
type cambios from userobject within tab_1
end type
type pb_5 from picturebutton within cambios
end type
type pb_4 from pb_report within cambios
end type
type pb_2 from picturebutton within cambios
end type
type dw_cambio from datawindow within cambios
end type
type cambios from userobject within tab_1
pb_5 pb_5
pb_4 pb_4
pb_2 pb_2
dw_cambio dw_cambio
end type
type docs from userobject within tab_1
end type
type pb_print from picturebutton within docs
end type
type pb_save_imag from picturebutton within docs
end type
type pb_del_imag from picturebutton within docs
end type
type pb_imag from picturebutton within docs
end type
type dw_imagenes from datawindow within docs
end type
type docs from userobject within tab_1
pb_print pb_print
pb_save_imag pb_save_imag
pb_del_imag pb_del_imag
pb_imag pb_imag
dw_imagenes dw_imagenes
end type
type tab_1 from tab within win_regis_pac
tabpage_1 tabpage_1
tab_afilia tab_afilia
tabpage_2 tabpage_2
tabpage_3 tabpage_3
tabpage_4 tabpage_4
biometria biometria
tabpage_5 tabpage_5
cambios cambios
docs docs
end type
type gb_3 from groupbox within win_regis_pac
end type
end forward

global type win_regis_pac from window
integer width = 5111
integer height = 2492
boolean titlebar = true
string title = "Datos generales paciente"
boolean controlmenu = true
boolean minbox = true
boolean maxbox = true
boolean hscrollbar = true
boolean vscrollbar = true
boolean resizable = true
long backcolor = 134217732
string icon = "paciente.ico"
string pointer = "Arrow!"
integer unitsperline = 10
integer linesperpage = 10
integer unitspercolumn = 10
integer columnsperpage = 10
integer toolbarwidth = 18
integer toolbarheight = 16
ole_1 ole_1
p_foto_org p_foto_org
pb_9 pb_9
pb_8 pb_8
pb_7 pb_7
p_foto p_foto
dw_4 dw_4
sle_1 sle_1
dw_2 dw_2
tab_1 tab_1
gb_3 gb_3
end type
global win_regis_pac win_regis_pac

type variables
DataWindowChild ciudad,barrio,ciudad_fam,contra,entrepano,estan,gc_emp,gc_regimen,idw_escola,idw_paren
long nuevo,xant,yant,li_dias
blob imags[],objs[]
string exte[],borrar[],l_contrato, l_repositorio,nom_imag[]

int i_nro_imags=0,i_actual_image,i_nobjs[],imprime[],ContDedos= 0, pos_x,pos_y
Blob lp_image,tot_b
long ancho_ori, alto_ori
boolean l_cambio_foto

end variables

forward prototypes
public subroutine blanquea ()
public function integer f_grabar_emp ()
public function integer grabar ()
public function string f_retorno_mail (mailreturncode a_mailreturncode)
public function integer setphoto ()
public subroutine setscroll ()
end prototypes

public subroutine blanquea ();dw_2.reset()
tab_1.tab_afilia.dw_empac.reset()
tab_1.tab_afilia.tab_3.tabpage_8.dw_emppacg.reset()
tab_1.tabpage_1.dw_1.reset()
tab_1.tabpage_2.dw_3.reset()
tab_1.tabpage_3.dw_hist_lab.reset()
tab_1.tabpage_4.dw_5.reset()
dw_4.reset()

end subroutine

public function integer f_grabar_emp ();choose case tab_1.tabpage_1.dw_1.getitemstring(1,'tu')
	case '1'//contribu
	
	case '2'//subsi

	case '3'//vincula
		
	case '4'//part
		
	case '5'//otro
end choose
if tab_1.tab_afilia.tab_3.tabpage_8.dw_emppacg.update()<1 then return -1
return 1
end function

public function integer grabar ();if not f_demo('pac') then return -1
if tab_1.tabpage_1.dw_1.rowcount()>0 then
	dw_2.accepttext()
	tab_1.tabpage_1.dw_1.accepttext()
	if isnull(w_principal.dw_1.getitemstring(1,"documento")) or w_principal.dw_1.getitemstring(1,"documento")='' then
		messagebox("Atención","Debe digitar el documento del paciente")
		return -1
	end if
	if isnull(tab_1.tabpage_1.dw_1.getitemstring(1,"cdepto")) then
		messagebox("Atención","Debe digitar el Departamento del paciente")
		return -1
	end if
	if isnull(tab_1.tabpage_1.dw_1.getitemstring(1,"cciudad")) then
		messagebox("Atención","Debe digitar ciudad del paciente")
		return -1
	end if
	if isnull(dw_2.getitemstring(1,"sexo")) then
		messagebox("Atención","Debe digitar el sexo del paciente")
		return -1
	end if
	if isnull(dw_2.getitemstring(1,"nombre1")) then
		messagebox("Atención","Debe digitar el nombre1 del paciente")
		return -1
	end if
	if isnull(dw_2.getitemstring(1,"apellido1")) then
		messagebox("Atención","Debe digitar el apellido1 del paciente")
		return -1
	end if
	if isnull(dw_2.getitemdatetime(1,"fnacimiento")) then
		messagebox("Atención","Debe digitar la fecha de nacimiento del paciente")
		return -1
	end if
	if isnull(dw_2.getitemstring(1,"estrato")) then
		messagebox("Atención","Debe digitar el estrato del paciente")
		return -1
	end if
	if isnull(tab_1.tabpage_1.dw_1.getitemstring(1,"tu") ) then
		messagebox("Atención","Debe digitar el Tipo de Usuario del paciente")
		return -1
	end if
	if isnull(tab_1.tabpage_1.dw_1.getitemstring(1,"direccion") ) or trim(tab_1.tabpage_1.dw_1.getitemstring(1,"direccion"))='' then
		messagebox("Atención","Debe digitar la dirección del paciente")
		return -1
	end if
	if isnull(tab_1.tabpage_1.dw_1.getitemstring(1,"ocodigo") ) then
		messagebox("Atención","Debe digitar Ocupacion del Paciente")
		return -1
	end if
	if isnull(tab_1.tabpage_1.dw_1.getitemstring(1,"grupoae") ) then
		messagebox("Atención","Debe digitar Pertenecia Etnica del Paciente")
		return -1
	end if
	if isnull(tab_1.tabpage_1.dw_1.getitemstring(1,"escolaridad") ) then
		messagebox("Atención","Debe digitar Escolaridad del Paciente")
		return -1
	end if
	if tab_1.tabpage_1.dw_1.getitemstring(1,"tpais")='1' and isnull(tab_1.tabpage_1.dw_1.getitemstring(1,"pais") ) then
		messagebox("Atención","Debe digitar Pais del Paciente")
		return -1
	end if
	int l_largo
	string l_formato,ll_dias
	long l_edad_ini,l_edad_fin,l_calculo
	
	select  largo,formato,edad_ini,edad_fin into : l_largo,: l_formato,:l_edad_ini,:l_edad_fin from tipoidentificacion where codtipoident=:tipdoc;
	if l_edad_fin<=90 then ll_dias='dias' else ll_dias='años' 
	l_calculo=f_dias_365(dw_2.getitemdatetime(1,'fnacimiento'),datetime(today(),now()))
	
	if l_calculo< l_edad_ini or l_calculo> l_edad_fin then
		messagebox('Error',UPPER('Inconsistencias en datos no aplica edad para el documento debe estar entre '+string(int(l_edad_ini/360))+' y ' +string(int(l_edad_fin/360)) + ll_dias))
		return 1
	end if
    if not f_valid_nu(tipdoc,docu,l_largo,l_formato) then
		setnull(docu)
		w_principal.dw_1.setitem(1,"documento",docu)
		return 1
	end if
	if not f_hasta() then 
		messagebox("Atención","Su periodo de validez ha caducado, comuníquese con GCI Ltda. para reactivarlo")
		return -1
	end if
	tab_1.tabpage_1.dw_1.setitem(1,"nombre1",RightTrim(LeftTrim(dw_2.getitemstring(1,"nombre1"))))
	tab_1.tabpage_1.dw_1.setitem(1,"nombre2",RightTrim(LeftTrim(dw_2.getitemstring(1,"nombre2"))))
	tab_1.tabpage_1.dw_1.setitem(1,"apellido1",RightTrim(LeftTrim(dw_2.getitemstring(1,"apellido1"))))
	tab_1.tabpage_1.dw_1.setitem(1,"apellido2",RightTrim(LeftTrim(dw_2.getitemstring(1,"apellido2"))))
	tab_1.tabpage_1.dw_1.setitem(1,"fnacimiento",dw_2.getitemdatetime(1,"fnacimiento"))
	tab_1.tabpage_1.dw_1.setitem(1,"sexo",dw_2.getitemstring(1,"sexo"))
	tab_1.tabpage_1.dw_1.setitem(1,"estrato",dw_2.getitemstring(1,"estrato"))
	tab_1.tabpage_1.dw_1.setitem(1,"usuario",usuario)
	tab_1.tabpage_1.dw_1.setitem(1,"fecha_captura",datetime(today(),now()))
	tab_1.tabpage_1.dw_1.setitem(1,"fecha_muerte",dw_2.getitemdatetime(1,"fecha_muerte"))
	tab_1.tabpage_1.dw_1.setitem(1,"estado",dw_2.getitemstring(1,"estado"))
	tab_1.tabpage_1.dw_1.setitem(1,"est_civil",dw_2.getitemstring(1,"est_civil"))
	
	if es_nuevo then
		tab_1.tabpage_1.dw_1.setitem(1,"tipodoc",tipdoc)
		tab_1.tabpage_1.dw_1.setitem(1,"documento",docu)
		histo=dw_2.getitemstring(1,"historia")
		tab_1.tabpage_1.dw_1.setitem(1,"historia",histo)
	end if

	tab_1.tabpage_1.dw_1.accepttext()
	tab_1.tabpage_1.dw_6.accepttext()

	delete from pacientes_pvunerable
	where tipodoc=:tipdoc and documento=:docu;
	if sqlca.sqlcode=-1 then
		messagebox("Error pacientes_pvunerable",sqlca.sqlerrtext)
		rollback;
		return -1
	end if

	int l_i,l_fila
	for  l_i = 1 to tab_1.tabpage_1.dw_6.rowcount()		
		if tab_1.tabpage_1.dw_6.getitemnumber(l_i,'dato')=1 then
			l_fila=tab_1.tabpage_1.dw_7.insertrow(0)
			tab_1.tabpage_1.dw_7.setitem(l_fila,"tipodoc",tipdoc)
			tab_1.tabpage_1.dw_7.setitem(l_fila ,"documento",docu)
			tab_1.tabpage_1.dw_7.setitem(l_fila ,"cod_pvulnera",tab_1.tabpage_1.dw_6.getitemstring(l_i,'cod_pvulnera'))
			tab_1.tabpage_1.dw_7.setitem( l_fila ,"fecha",datetime(today(),now()))
			tab_1.tabpage_1.dw_7.setitem(l_fila ,"usu_atiende",usuario)
		end if
	next	
	
	if tab_1.tabpage_1.dw_1.update()=-1 then
		sle_1.triggerevent(itemchanged!)
		return -1
	end if
	
	if tab_1.tabpage_1.dw_7.update()=-1 then
		sle_1.triggerevent(itemchanged!)		
		return -1
	end if		
	choose case tab_1.tabpage_1.dw_1.getitemstring(1,'tu')
		case '1'//contribu
		case '2'//subsi
		case '3'//vincu
		case '4'//particu
			int ll_contrato
			SELECT count(1) into :ll_contrato FROM contratos WHERE (((contratos.codemp)='0') AND ((contratos.codcontrato)='1'));
			if isnull(ll_contrato) or ll_contrato=0 then 

			else
				if tab_1.tab_afilia.tab_3.tabpage_8.dw_emppacg.find("codemp='0' and codcontrato='1'",1,tab_1.tab_afilia.tab_3.tabpage_8.dw_emppacg.rowcount())=0 then
					INSERT INTO emppac ( TipoDoc, Documento, CodEmp, CodContrato, CodTa, Carnet )
					values (:tipdoc,:docu,'0','1','0','0');
					if sqlca.sqlcode=-1 then 
						messagebox("Error insertando en Emppac",sqlca.sqlerrtext)
						return -1
					end if
					tab_1.tab_afilia.tab_3.tabpage_8.dw_emppacg.retrieve(tipdoc,docu)
				end if
			end if
		case '5'//otro
	end choose
	es_nuevo=false
	w_principal.dw_1.retrieve(tipdoc,docu)
	tab_1.tabpage_2.enabled=true
	tab_1.tabpage_3.enabled=true
	tab_1.tab_afilia.enabled=true
	tab_1.tabpage_4.enabled=true
	if 	l_cambio_foto then
		updateblob pacientes set fotografia = :tot_b
		where tipodoc=:tipdoc and documento=:docu;
		if SQLCA.SQLCode <> 0 then
			MessageBox("SQL error",SQLCA.SQLErrText,Information!)
		end if
		commit;
		l_cambio_foto=false
	end if
	
end if
return 1
end function

public function string f_retorno_mail (mailreturncode a_mailreturncode);string s
choose case a_MailReturnCode
	case mailReturnAccessDenied!
		s = 'Access Denied'
	case mailReturnAttachmentNotFound!
		s = 'Attachment Not Found'
	case mailReturnAttachmentOpenFailure!
		s = 'Attachment Open Failure'
	case mailReturnAttachmentWriteFailure!
		s = 'Attachment Write Failure'
	case mailReturnDiskFull!
		s = 'Disk Full'
	case mailReturnFailure!
		s = 'Failure'
	case mailReturnInsufficientMemory!
		s = 'Insufficient Memory'
	case mailReturnInvalidMessage!
		s = 'Invalid Message'
	case mailReturnLoginFailure!
		s = 'Login Failure'
	case mailReturnMessageInUse!
		s = 'Message In Use'
	case mailReturnNoMessages!
		s = 'No Messages'
	case mailReturnSuccess!
		s = 'Success'
	case mailReturnTextTooLarge!
		s = 'Text Too Large'
	case mailReturnTooManyFiles!
		s = 'Too Many Files'
	case mailReturnTooManyRecipients!
		s = 'Too Many Recipients'
	case mailReturnTooManySessions!
		s = 'Too Many Sessions'
	case mailReturnUnknownRecipient!
		s = 'Unknown Recipient'
	case mailReturnUserAbort!
		s = 'User Abort'

	case else
		s = 'Other'
end choose
return s

end function

public function integer setphoto ();//long h, w, r_alto, r_ancho
//r_ancho = 320
//h = alto_ori
//w = ancho_ori
//r_alto = round(r_ancho*h/w,0)
//if h > r_alto and w > r_ancho then
//	if h > w then
//		w = round(w * (r_alto/h),0)
//		h = r_alto
//	else
//		h = round(h * (r_ancho/w),0)
//		w = r_ancho		
//	end if
//elseif h > r_alto then
//	w = round(w * (r_alto/h),0)
//	h = r_alto
//elseif w > r_ancho then
//	h = round(h * (r_ancho/w),0)
//	w = r_ancho		
//end if
//p_5.Resize(w,h)
Return 0
end function

public subroutine setscroll ();//double altura
//
//altura = tab_1.p_foto.height
//if tab_1.p_foto.p_4.y + tab_1.p_foto.p_4.height >= altura then
//	tab_1.p_foto.vsb_1.Visible = TRUE
//	if tab_1.p_foto.p_4.width + tab_1.p_foto.p_4.x >= tab_1.width then
//		tab_1.p_foto.vsb_1.x = tab_1.width -  tab_1.p_foto.vsb_1.width - 50
//	else
//		tab_1.p_foto.vsb_1.x = tab_1.p_foto.p_4.x + tab_1.p_foto.p_4.width
//	end if
//	tab_1.p_foto.vsb_1.y = tab_1.p_foto.p_4.y
//	tab_1.p_foto.vsb_1.Height = altura - tab_1.p_foto.vsb_1.y - 50
//	tab_1.p_foto.vsb_1.MinPosition = 0
//	tab_1.p_foto.vsb_1.MaxPosition = tab_1.p_foto.p_4.y + tab_1.p_foto.p_4.Height - altura
//else
//	tab_1.p_foto.vsb_1.Visible = FALSE
//end if
//
//if tab_1.p_foto.p_4.x + tab_1.p_foto.p_4.width > tab_1.width then
//	tab_1.p_foto.hsb_2.Visible = TRUE
//	tab_1.p_foto.hsb_2.x = tab_1.p_foto.p_4.x
//	if tab_1.p_foto.p_4.height + tab_1.p_foto.p_4.y >= altura then
//		tab_1.p_foto.hsb_2.y = altura - tab_1.p_foto.hsb_2.height
//	else
//		tab_1.p_foto.hsb_2.y = tab_1.p_foto.p_4.y + tab_1.p_foto.p_4.height
//	end if			
//	tab_1.p_foto.hsb_2.width = tab_1.width - tab_1.p_foto.hsb_2.x - 100
//	tab_1.p_foto.hsb_2.MinPosition = 0
//	tab_1.p_foto.hsb_2.MaxPosition = tab_1.p_foto.p_4.x + tab_1.p_foto.p_4.width - tab_1.width
//else
//	tab_1.p_foto.hsb_2.Visible = FALSE
//end if
//
end subroutine

on win_regis_pac.create
this.ole_1=create ole_1
this.p_foto_org=create p_foto_org
this.pb_9=create pb_9
this.pb_8=create pb_8
this.pb_7=create pb_7
this.p_foto=create p_foto
this.dw_4=create dw_4
this.sle_1=create sle_1
this.dw_2=create dw_2
this.tab_1=create tab_1
this.gb_3=create gb_3
this.Control[]={this.ole_1,&
this.p_foto_org,&
this.pb_9,&
this.pb_8,&
this.pb_7,&
this.p_foto,&
this.dw_4,&
this.sle_1,&
this.dw_2,&
this.tab_1,&
this.gb_3}
end on

on win_regis_pac.destroy
destroy(this.ole_1)
destroy(this.p_foto_org)
destroy(this.pb_9)
destroy(this.pb_8)
destroy(this.pb_7)
destroy(this.p_foto)
destroy(this.dw_4)
destroy(this.sle_1)
destroy(this.dw_2)
destroy(this.tab_1)
destroy(this.gb_3)
end on

event open;tab_1.tabpage_1.dw_1.GetChild('cciudad', ciudad)
tab_1.tabpage_1.dw_1.GetChild('cbarrio', barrio)
ciudad.settransobject(sqlca)
barrio.settransobject(sqlca)
ciudad_fam.retrieve()
ciudad.retrieve()
barrio.retrieve()
dw_2.settransobject(sqlca)
tab_1.tabpage_1.dw_1.settransobject(sqlca)
tab_1.tabpage_1.dw_6.settransobject(sqlca)
tab_1.tabpage_1.dw_7.settransobject(sqlca)
tab_1.tabpage_2.dw_3.settransobject(sqlca)
tab_1.tabpage_3.dw_hist_lab.settransobject(sqlca)
dw_4.settransobject(sqlca)
dw_4.retrieve(tipdoc,docu)
tab_1.cambios.dw_cambio.retrieve(tipdoc,docu)
tab_1.docs.dw_imagenes.retrieve(tipdoc,docu)

tab_1.tabpage_4.dw_5.settransobject(sqlca)
tab_1.tab_afilia.tab_3.tabpage_8.dw_emppacg.settransobject(sqlca)
w_principal.ArrangeSheets ( layer!)

string l_version,l_errors
byte majorVersion=0, minorVersion=0
g_captura=false
if g_sensor=true then
	tab_1.biometria.visible=true
else
	tab_1.biometria.visible=false
end if
If g_biometria='1' then
	If l_error < 0 Then
		l_errors=f_biometria_error(l_error)
		f_biometria_escribe_log(tab_1.biometria.log_es,l_errors)
	Else
		f_biometria_escribe_log(tab_1.biometria.log_es,"Biométrica Inicializada Satisfactoriamente")
		l_error =w_principal.huella_total.object.GetGrFingerVersion(ref majorVersion, ref minorVersion)
		If l_error = GRFINGER_FULL Then l_version = "FULL"
		If l_error  = GRFINGER_LIGHT Then l_version = "LIGHT"
		f_biometria_escribe_log(tab_1.biometria.log_es,'Version SDK Griaule '+string(majorVersion) +'.' +string(minorVersion) + '.' +' Licencia Tipo '+l_version)
		w_principal.pac_template.template = Blob(Space(10000))
		tab_1.biometria.dw_huella_pac.retrieve(tipdoc,docu)
		tab_1.biometria.dw_biometria.Modify("p_mano.FileName = '"+ f_biometria_muestra_imagen(tab_1.biometria.dw_huella_pac,tipdoc,docu,ContDedos,'paci')+"'")
	End If
end If

selectblob fotografia into :tot_b from pacientes
where tipodoc=:tipdoc and documento=:docu;
if SQLCA.SQLCode < 0 then
	MessageBox("SQL error",SQLCA.SQLErrText,Information!)
end if
if not isNull(tot_b) then
	p_foto.SetPicture(tot_b)
	p_foto.Show()
else
	setnull(tot_b)
	p_foto.SetPicture(tot_b)
end if
l_cambio_foto=false
SELECT cadena into :l_contrato
FROM parametros_gen
WHERE (((codigo_para)=37));
if sqlca.sqlnrows=0 then
	messagebox('Atencíon','No hay parametro 37')
	return 
end if

SELECT cadena into :l_repositorio
FROM parametros_gen
WHERE (((codigo_para)=27));
if sqlca.sqlnrows=0 then
	messagebox('Atencíon','No hay parametro 27')
	return
end if

if isnull(l_repositorio) then
	messagebox('Atencíon','No hay Repositorio para Almacenamiento')
	return
end if


end event

event resize;if this.height>=1888 then 
	this.vscrollbar=false
else
	this.vscrollbar=true
end if
if this.width>=3584 then 
	this.hscrollbar=false
else
	this.hscrollbar=true
end if
end event

event closequery;if tab_1.tabpage_1.dw_1.rowcount() =0 then return
if not isnull(w_principal.dw_1.getitemstring(1,"documento")) AND (isnull(tab_1.tabpage_1.dw_1.getitemdatetime(1,"fecha_captura")) OR (DaysAfter(date(tab_1.tabpage_1.dw_1.getitemdatetime(1,"fecha_captura")),date(now()))> 365)) then
	messagebox("Atención","Actualicé Datos de paciente")
	return 1
else
	return 0
end if
end event

type ole_1 from olecustomcontrol within win_regis_pac
boolean visible = false
integer x = 4850
integer y = 48
integer width = 128
integer height = 112
integer taborder = 100
borderstyle borderstyle = stylelowered!
long backcolor = 0
boolean focusrectangle = false
string binarykey = "win_regis_pac.win"
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
end type

type p_foto_org from picture within win_regis_pac
boolean visible = false
integer x = 4832
integer y = 172
integer width = 133
integer height = 80
boolean originalsize = true
borderstyle borderstyle = stylelowered!
boolean focusrectangle = false
end type

type pb_9 from picturebutton within win_regis_pac
integer x = 4686
integer y = 324
integer width = 146
integer height = 128
integer taborder = 90
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean originalsize = true
string picturename = "camara_2.jpg"
string powertiptext = "Seleccionar Cámara"
end type

event clicked;ole_1.object.TwainSelectSource()
end event

type pb_8 from picturebutton within win_regis_pac
integer x = 4686
integer y = 172
integer width = 146
integer height = 128
integer taborder = 100
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
boolean originalsize = true
string picturename = "camara_3.jpg"
string powertiptext = "Obtener foto desde Camara"
end type

event clicked;string ls_filename_read
long ll_arch,ll_leyo,nImageID,ojo

ole_1.object.setlicensenumber('0430003366978686356442456')
If ole_1.object.TwainOpenDefaultSource() Then
	
	ole_1.object.TwainSetCurrentResolution (300)
	ole_1.object.TwainSetCurrentPixelType (2) //RGB
	ole_1.object.TwainSetCurrentBitDepth (8) //24 bpp
	
	nImageID = ole_1.object.TwainAcquireToGdPictureImage(1)

//	ls_filename_read=i_st.as_tdoc+i_st.as_docu+'.jpg'
	ls_filename_read='foto.jpg'
	If nImageID <> 0 Then

		ojo=(ole_1.object.Getwidth ()  -(147*ole_1.object.GetHeight()/185))/2
	
		ole_1.object.CropLeft (ojo)
		ole_1.object.Cropright (ojo)
		
		ole_1.object.ResizeImage (147, 185, 3)
		ole_1.object.SaveAsJPEG('c:\windows\temp\'+ls_filename_read, 80)
		ole_1.object.CloseImage(nImageID)
	End If
	ole_1.object.TwainCloseSource()
	
	ll_arch=fileopen('c:\windows\temp\'+ls_filename_read,StreamMode! )
	if ll_arch=-1 then 
		messagebox('Error','no se pudo abrir el archivo')
		return
	end if
	ll_leyo= filereadex(ll_arch,tot_b)
	if ll_leyo<=0 then 
		messagebox('Error','no se pudo leer desde el archivo')
		return
	end if
	fileclose(ll_arch)
	p_foto.setpicture(tot_b)
Else
	messagebox('Error obteniendo imagen',"No se puede abrir el dispositivo, su estado es: "+ trim(String(ole_1.object.TwainGetState)))
End If

end event

type pb_7 from picturebutton within win_regis_pac
integer x = 4686
integer y = 32
integer width = 146
integer height = 128
integer taborder = 70
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
boolean originalsize = true
string picturename = "foto.jpg"
string powertiptext = "Traer Foto desde archivo"
end type

event clicked;string ls_path,ls_new_name,ls_filename
long ll_arch,ll_leyo,nImageID,ojo

GetFileOpenName("Selecione Archivo de Fotos",ls_path,ls_filename,"JPG","JPEG Files (*.JPG),*.JPG, Bitmap Files (*.BMP),*.BMP, GIF Files (*.GIF),*.GIF, WindosMetaFile Files (*.WMF),*.WMF")
long flen, bytes_read,li_FileNum,loops,i
blob b
SetPointer(HourGlass!)
flen = FileLength(ls_path)
li_FileNum = FileOpen(ls_path, textMode!, Read!, LockRead!)
bytes_read = FileReadex(li_FileNum, tot_b)
FileClose(li_FileNum)

p_foto_org.setpicture(tot_b)
if p_foto_org.width>672 or p_foto_org.height>740 then 
	ole_1.object.setlicensenumber('0438337627995006659412372')
	nImageID=ole_1.object.CreateImageFromFile (ls_path)
	ojo=(ole_1.object.Getwidth ()  -(147*ole_1.object.GetHeight()/185))/2
		
	ole_1.object.CropLeft (ojo)
	ole_1.object.Cropright (ojo)
	ole_1.object.ResizeImage (147, 185, 3)
	ole_1.object.SaveAsJPEG('c:\windows\temp\foto.jpg', 80)
	ole_1.object.CloseImage(nImageID)
	
	ll_arch=fileopen('c:\windows\temp\foto.jpg',StreamMode! )
	if ll_arch=-1 then 
		messagebox('Error','no se pudo abrir el archivo')
		return
	end if
	ll_leyo= filereadex(ll_arch,tot_b)
	if ll_leyo<=0 then 
		messagebox('Error','no se pudo leer desde el archivo')
		return
	end if
	fileclose(ll_arch)
	p_foto.setpicture(tot_b)
	l_cambio_foto=true
else
	p_foto.setpicture(tot_b)
	l_cambio_foto=true
end if
end event

type p_foto from picture within win_regis_pac
integer x = 4050
integer y = 20
integer width = 617
integer height = 408
boolean border = true
borderstyle borderstyle = stylelowered!
boolean focusrectangle = false
end type

type dw_4 from datawindow within win_regis_pac
boolean visible = false
integer x = 87
integer y = 2244
integer width = 416
integer height = 44
integer taborder = 50
string dataobject = "dw_imprime_objeto"
boolean hscrollbar = true
boolean vscrollbar = true
boolean border = false
boolean livescroll = true
end type

type sle_1 from singlelineedit within win_regis_pac
boolean visible = false
integer x = 1010
integer y = 40
integer width = 512
integer height = 64
integer taborder = 10
string dragicon = "none!"
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
string pointer = "ibeam!"
long textcolor = 33554432
boolean enabled = false
borderstyle borderstyle = stylelowered!
end type

event modified;string depto,ciud
contra.settransobject(sqlca)
contra.retrieve("%",clugar,'%')


//contra.setfilter("#1='a'")
//contra.filter()
if tab_1.tab_afilia.dw_empac.rowcount()=0 then tab_1.tab_afilia.dw_empac.insertrow(0);
if dw_2.retrieve(tipdoc,docu)<1 then 
	es_nuevo = true
	dw_2.insertrow(0);
	//dw_2.modify("historia.edit.DisplayOnly=FALSE")
	dw_2.setitem(1,"historia",docu)
	tab_1.tabpage_1.dw_1.reset();
	tab_1.tabpage_2.enabled=false
	tab_1.tabpage_3.enabled=false
	tab_1.tab_afilia.enabled=false
	tab_1.tabpage_4.enabled=false
	tab_1.tabpage_1.dw_1.insertrow(0);
	tab_1.tabpage_1.dw_1.setitem(1,"fingreso",datetime(today(),now()))
	tab_1.tabpage_1.dw_1.setitem(1,"fech_crea_histo",datetime(today(),now()))
	tab_1.tabpage_1.dw_1.setitem(1,"tpais",tipo_pais)
	tab_1.tabpage_2.dw_3.reset()
	tab_1.tabpage_3.dw_hist_lab.reset()
	tab_1.tab_afilia.dw_empac.reset()
	tab_1.tabpage_4.dw_5.reset()
	tab_1.tab_afilia.dw_empac.insertrow(0);
	contra.retrieve("%",clugar,'%')
	tab_1.tab_afilia.tab_3.tabpage_8.dw_emppacg.reset()
	tab_1.docs.dw_imagenes.reset()
	tab_1.tabpage_1.dw_6.reset()
	tab_1.tabpage_1.dw_6.retrieve(tipdoc,docu)
else
	es_nuevo=false
	tab_1.tabpage_2.enabled=true
	tab_1.tabpage_3.enabled=true
	tab_1.tab_afilia.enabled=true
	//dw_2.modify("historia.edit.DisplayOnly=TRUE")
	histo=dw_2.getitemstring(1,"historia")
	depto=dw_2.getitemstring(1,"cdepto")
	ciud=dw_2.getitemstring(1,"cciudad")
	ciudad.setfilter("cdepto='"+depto+"'")
	ciudad.filter()
	barrio.setfilter("cdepto='"+depto+"' and cciudad='"+ciud+"'")
	barrio.filter()
	tab_1.tabpage_1.dw_1.retrieve(tipdoc,docu)
	tab_1.tabpage_2.dw_3.retrieve(histo)
	tab_1.tabpage_3.dw_hist_lab.retrieve(histo)
	tab_1.tab_afilia.tab_3.tabpage_8.dw_emppacg.retrieve(tipdoc,docu)
	tab_1.tabpage_4.dw_5.retrieve(histo)
	tab_1.docs.dw_imagenes.retrieve(tipdoc,docu)
	tab_1.tabpage_1.dw_6.retrieve(tipdoc,docu)
end if;
li_dias=w_principal.dw_1.getitemnumber(1,'dias')
idw_escola.setfilter(string(li_dias)+">=edadini  and  "+string(li_dias)+"<=edadfin ")
idw_escola.filter()
	string esp
	esp="codescolaridad='"+tab_1.tabpage_1.dw_1.getitemstring(1,'escolaridad')+"'"
if idw_escola.find("codescolaridad='"+tab_1.tabpage_1.dw_1.getitemstring(1,'escolaridad')+"'",1, idw_escola.rowcount())<=0 then

	setnull(esp)
	tab_1.tabpage_1.dw_1.setitem(1,"escolaridad",esp)		
end if
dw_2.setfocus();
//tab_1.tabpage_5.event mostrar_fotos()


end event

type dw_2 from datawindow within win_regis_pac
integer x = 50
integer y = 100
integer width = 3886
integer height = 324
integer taborder = 40
string dragicon = "none!"
string dataobject = "dw_gral"
boolean border = false
boolean livescroll = true
end type

event itemchanged;if this.getcolumnname()='historia' then
	this.accepttext()
	tab_1.tabpage_1.dw_1.setitem(1,"historia",this.getitemstring(this.getrow(),"historia"))	
end if

if this.getcolumnname()='fnacimiento' and es_nuevo then
	w_principal.dw_1.setitem(1,'fnacimiento',date(data))
	w_principal.dw_1.accepttext()
	li_dias=w_principal.dw_1.getitemnumber(1,'dias')
	idw_escola.setfilter(string(li_dias)+">=edadini  and  "+string(li_dias)+"<=edadfin ")
	idw_escola.filter()
end if
this.accepttext()
end event

type tab_1 from tab within win_regis_pac
event mousemove pbm_mousemove
event mover ( )
integer x = 23
integer y = 460
integer width = 4951
integer height = 1772
integer taborder = 20
string dragicon = "none!"
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
string pointer = "Arrow!"
long backcolor = 79741120
boolean fixedwidth = true
boolean raggedright = true
boolean focusonbuttondown = true
boolean powertips = true
alignment alignment = center!
integer selectedtab = 1
tabpage_1 tabpage_1
tab_afilia tab_afilia
tabpage_2 tabpage_2
tabpage_3 tabpage_3
tabpage_4 tabpage_4
biometria biometria
tabpage_5 tabpage_5
cambios cambios
docs docs
end type

on tab_1.create
this.tabpage_1=create tabpage_1
this.tab_afilia=create tab_afilia
this.tabpage_2=create tabpage_2
this.tabpage_3=create tabpage_3
this.tabpage_4=create tabpage_4
this.biometria=create biometria
this.tabpage_5=create tabpage_5
this.cambios=create cambios
this.docs=create docs
this.Control[]={this.tabpage_1,&
this.tab_afilia,&
this.tabpage_2,&
this.tabpage_3,&
this.tabpage_4,&
this.biometria,&
this.tabpage_5,&
this.cambios,&
this.docs}
end on

on tab_1.destroy
destroy(this.tabpage_1)
destroy(this.tab_afilia)
destroy(this.tabpage_2)
destroy(this.tabpage_3)
destroy(this.tabpage_4)
destroy(this.biometria)
destroy(this.tabpage_5)
destroy(this.cambios)
destroy(this.docs)
end on

event selectionchanged;choose case tab_1.selectedtab
	case 2
		tab_1.tab_afilia.cbx_act.triggerevent(clicked!)
end choose
end event

type tabpage_1 from userobject within tab_1
event mousemove pbm_mousemove
integer x = 18
integer y = 112
integer width = 4914
integer height = 1644
string dragicon = "none!"
long backcolor = 67108864
string pointer = "Arrow!"
string text = "Datos Identificación"
long tabtextcolor = 33554432
string picturename = "paciente.ico"
long picturemaskcolor = 536870912
dw_7 dw_7
pb_ayuda pb_ayuda
pb_refresh pb_refresh
cb_guarda cb_guarda
dw_1 dw_1
gb_4 gb_4
dw_6 dw_6
end type

on tabpage_1.create
this.dw_7=create dw_7
this.pb_ayuda=create pb_ayuda
this.pb_refresh=create pb_refresh
this.cb_guarda=create cb_guarda
this.dw_1=create dw_1
this.gb_4=create gb_4
this.dw_6=create dw_6
this.Control[]={this.dw_7,&
this.pb_ayuda,&
this.pb_refresh,&
this.cb_guarda,&
this.dw_1,&
this.gb_4,&
this.dw_6}
end on

on tabpage_1.destroy
destroy(this.dw_7)
destroy(this.pb_ayuda)
destroy(this.pb_refresh)
destroy(this.cb_guarda)
destroy(this.dw_1)
destroy(this.gb_4)
destroy(this.dw_6)
end on

type dw_7 from datawindow within tabpage_1
boolean visible = false
integer x = 2793
integer y = 1048
integer width = 731
integer height = 400
integer taborder = 80
string title = "none"
string dataobject = "dw_pacientes_vulnerable"
boolean border = false
boolean livescroll = true
end type

type pb_ayuda from picturebutton within tabpage_1
boolean visible = false
integer x = 4704
integer y = 392
integer width = 146
integer height = 128
integer taborder = 60
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
string text = "           &y"
boolean originalsize = true
string picturename = "ayuda.gif"
string disabledname = "d_ayuda.gif"
string powertiptext = "Ayuda sobre como crear Pacientes [Alt+Y]"
end type

type pb_refresh from picturebutton within tabpage_1
integer x = 4704
integer y = 252
integer width = 146
integer height = 128
integer taborder = 60
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
string text = "           &r"
boolean originalsize = true
string picturename = "refrescar.GIF"
string disabledname = "d_refrescar.GIF"
string powertiptext = "Refrescar [Alt+R]"
end type

event clicked;sle_1.triggerevent(modified!)
end event

type cb_guarda from picturebutton within tabpage_1
integer x = 4704
integer y = 108
integer width = 146
integer height = 128
integer taborder = 60
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "        &g"
boolean originalsize = true
string picturename = "guardar2.GIF"
string disabledname = "d_guardar2.GIF"
alignment htextalign = left!
end type

event clicked;if f_permiso_boton(this,'PACG')=0 then return -1
if grabar()=-1 then
	rollback;
else
	commit;
	w_principal.dw_1.setcolumn(2)
	w_principal.dw_1.triggerevent(itemchanged!)
end if
end event

type dw_1 from datawindow within tabpage_1
event mousemove pbm_mousemove
integer x = 32
integer y = 120
integer width = 4663
integer height = 856
integer taborder = 20
string dragicon = "none!"
string dataobject = "dw_rest_pac"
boolean border = false
end type

event itemchanged;string depto,ciud,nul,des
setnull(nul)
setnull(des)
tab_1.tabpage_1.dw_1.accepttext()
depto=tab_1.tabpage_1.dw_1.getitemstring(1,"cdepto")
ciud=tab_1.tabpage_1.dw_1.getitemstring(1,"cciudad")
CHOOSE CASE tab_1.tabpage_1.dw_1.getcolumnname()
CASE "cdepto"
	ciudad.setfilter("cdepto='"+data+"'")
	ciudad.filter()
	tab_1.tabpage_1.dw_1.setitem(1,"cciudad",nul)
	tab_1.tabpage_1.dw_1.setitem(1,"cbarrio",nul)
CASE "cciudad"
	barrio.setfilter("cdepto='"+depto+"' and cciudad='"+ciud+"'")
	barrio.filter()
	tab_1.tabpage_1.dw_1.setitem(1,"cbarrio",nul)
CASE "ocodigo"	
	string todo
	
	select todo,des_ocup into :nul,:des 
	FROM ocupaciones INNER JOIN ocupa_version ON ocupaciones.version = ocupa_version.c_version
	WHERE (((ocupaciones.codigo)=:data) AND ((ocupaciones.AGRUPA)='0')  AND ((ocupa_version.val_hasta)>getdate()));
	if not isNull(nul) then
		setitem(1,"codocup",nul)
		setitem(1,"ocodigo",data)
		setitem(1,"des_ocup",des)
	else
		setnull(nul)
		setitem(1,"codocup",nul)
		setitem(1,"ocodigo",nul)
		setitem(1,"des_ocup",nul)
		return 1
	end if

CASE "tel","tel1"		
	if not match(data,"^[0-9]+$") then
		 if tab_1.tabpage_1.dw_1.getcolumnname()='tel' then
			tab_1.tabpage_1.dw_1.setitem(1,"tel",nul)
		else
			tab_1.tabpage_1.dw_1.setitem(1,"tel1",nul)		
		end if
		return 1
	end if

CASE "email"
		if not match(data,'^[a-zA-Z0-9][a-zA-Z\0-9\-_\.]*[^.]\@[^.][a-zA-Z\0-9\-_\.]+\.[a-zA-Z\0-9\-_\.]*[a-zA-Z\0-9]+$') then
			tab_1.tabpage_1.dw_1.setitem(1,"email",nul)
			return 1
		end if
END CHOOSE
tab_1.tabpage_1.dw_1.accepttext()

end event

event doubleclicked;if getcolumnname()<>"ocodigo" then return
st_edadsexo st_es
st_diag st_d
openwithparm(w_busca_ocupacion,st_es)
st_d=message.powerobjectparm
if not isValid(st_d) then return
if not isNull(st_d.codrip) then
	setitem(1,"codocup",st_d.codgeral)
	setitem(1,"ocodigo",st_d.codrip)
	setitem(1,"des_ocup",st_d.descripcion)
end if
end event

event constructor;settransobject(sqlca)
getchild('escolaridad',idw_escola)
idw_escola.settransobject(sqlca)
insertrow(1)

end event

type gb_4 from groupbox within tabpage_1
integer x = 78
integer y = 980
integer width = 4805
integer height = 644
integer taborder = 80
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 67108864
string text = "Población Vulnerable"
end type

type dw_6 from datawindow within tabpage_1
integer x = 110
integer y = 1044
integer width = 4613
integer height = 552
integer taborder = 70
boolean bringtotop = true
string title = "none"
string dataobject = "dw_pacientes_vulnerable"
boolean vscrollbar = true
boolean border = false
boolean livescroll = true
end type

type tab_afilia from userobject within tab_1
event mousemove pbm_mousemove
integer x = 18
integer y = 112
integer width = 4914
integer height = 1644
string dragicon = "none!"
long backcolor = 79741120
string pointer = "Arrow!"
string text = "Afiliación"
long tabtextcolor = 33554432
string picturename = "editar.ico"
long picturemaskcolor = 536870912
dw_req dw_req
tab_3 tab_3
cbx_act cbx_act
cb_inser cb_inser
dw_esco dw_esco
dw_serv dw_serv
dw_empac dw_empac
gb_1 gb_1
end type

on tab_afilia.create
this.dw_req=create dw_req
this.tab_3=create tab_3
this.cbx_act=create cbx_act
this.cb_inser=create cb_inser
this.dw_esco=create dw_esco
this.dw_serv=create dw_serv
this.dw_empac=create dw_empac
this.gb_1=create gb_1
this.Control[]={this.dw_req,&
this.tab_3,&
this.cbx_act,&
this.cb_inser,&
this.dw_esco,&
this.dw_serv,&
this.dw_empac,&
this.gb_1}
end on

on tab_afilia.destroy
destroy(this.dw_req)
destroy(this.tab_3)
destroy(this.cbx_act)
destroy(this.cb_inser)
destroy(this.dw_esco)
destroy(this.dw_serv)
destroy(this.dw_empac)
destroy(this.gb_1)
end on

type dw_req from datawindow within tab_afilia
integer x = 101
integer y = 272
integer width = 4731
integer height = 392
integer taborder = 80
string title = "none"
string dataobject = "dw_req_contrato"
boolean vscrollbar = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;//this.modify("t_1.width=2700")
//this.modify("descripcion.width=2600")
this.settransobject(sqlca)


end event

type tab_3 from tab within tab_afilia
event create ( )
event destroy ( )
integer x = 46
integer y = 728
integer width = 4850
integer height = 896
integer taborder = 70
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long backcolor = 79741120
boolean raggedright = true
boolean focusonbuttondown = true
integer selectedtab = 1
tabpage_8 tabpage_8
tabpage_6 tabpage_6
end type

on tab_3.create
this.tabpage_8=create tabpage_8
this.tabpage_6=create tabpage_6
this.Control[]={this.tabpage_8,&
this.tabpage_6}
end on

on tab_3.destroy
destroy(this.tabpage_8)
destroy(this.tabpage_6)
end on

type tabpage_8 from userobject within tab_3
event create ( )
event destroy ( )
integer x = 18
integer y = 112
integer width = 4814
integer height = 768
long backcolor = 79741120
string text = "EAPB Actual"
long tabtextcolor = 33554432
long tabbackcolor = 79741120
string picturename = "contrato.ico"
long picturemaskcolor = 536870912
pb_3 pb_3
pb_1 pb_1
cb_save cb_save
cb_dele cb_dele
dw_emppacg dw_emppacg
end type

on tabpage_8.create
this.pb_3=create pb_3
this.pb_1=create pb_1
this.cb_save=create cb_save
this.cb_dele=create cb_dele
this.dw_emppacg=create dw_emppacg
this.Control[]={this.pb_3,&
this.pb_1,&
this.cb_save,&
this.cb_dele,&
this.dw_emppacg}
end on

on tabpage_8.destroy
destroy(this.pb_3)
destroy(this.pb_1)
destroy(this.cb_save)
destroy(this.cb_dele)
destroy(this.dw_emppacg)
end on

type pb_3 from picturebutton within tabpage_8
integer x = 4645
integer y = 428
integer width = 146
integer height = 128
integer taborder = 80
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
string text = "              &y"
boolean originalsize = true
string picturename = "ayuda.gif"
string disabledname = "d_ayuda.gif"
alignment htextalign = left!
end type

event clicked;ShowHelp(dir_insta+"Gciltda.hlp", keyword!,"Afiliación del Paciente")
end event

type pb_1 from picturebutton within tabpage_8
integer x = 4645
integer y = 292
integer width = 146
integer height = 128
integer taborder = 70
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean originalsize = true
string picturename = "print2.gif"
string disabledname = "d_print2.gif"
alignment htextalign = left!
end type

event clicked;if tab_1.tabpage_1.dw_1.rowcount()=0 and tab_1.tab_afilia.dw_empac.rowcount()=0 then return
int l_fila,l_ret
string l_eps,l_conts,td_c,doc_c,ls_archivo,is_path,ls_desemp,l_email,p_nombre
string l_servidor, l_puerto,l_usuario,l_clave,l_autentica,l_conexion,l_desc, l_nombre,l_asunto
uo_datastore dw_for

SELECT servidor, puerto, usuario, clave, autentica, conexion into 
	  :l_servidor, :l_puerto,:l_usuario,:l_clave,:l_autentica,:l_conexion
FROM ips_correos
WHERE c_ips='01' and ctipo='EA02';
if isnull(l_servidor) then
	messageBox('Atención','No se ha configurado el correo para EA02')
	return 0
end if

l_fila=tab_1.tab_afilia.tab_3.tabpage_8.dw_emppacg.getrow()
l_eps=tab_1.tab_afilia.tab_3.tabpage_8.dw_emppacg.getitemstring(l_fila,"codemp")
l_conts=tab_1.tab_afilia.tab_3.tabpage_8.dw_emppacg.getitemstring(l_fila,"codcontrato")
ls_desemp=tab_1.tab_afilia.tab_3.tabpage_8.dw_emppacg.getitemstring(l_fila,"desemp")
is_path=tab_1.tab_afilia.tab_3.tabpage_8.dw_emppacg.getitemstring(l_fila,"repositorio")
l_email=tab_1.tab_afilia.tab_3.tabpage_8.dw_emppacg.getitemstring(l_fila,"correo_bd")
if isNull(l_email) or l_email = '' then
	messageBox('Atención','No se ha configurado el correo de la empresa '+ls_desemp)
	return 0
end if
ls_archivo = 'solicita_'+docu+'_1'+'_'+string(datetime(today(),now()),'yyyymmddhhmmss')

dw_for=create uo_datastore
dw_for.DataObject = 'asis_int_informe_incosist'
dw_for.settransobject(sqlca)
if dw_for.retrieve(tipdoc,docu,l_eps,l_conts) > 0 then
	if isnull(is_path) or trim(is_path) = '' then
		is_path = "c:\"
		do 
		loop until getFolder('Seleccione repositorio para la empresa',is_path) = 1
		is_path = is_path + '\'
		update empresa set repositorio = :is_path from empresa where codemp = :l_eps;
		IF SQLCA.SQLCode = -1 THEN
			MessageBox("No pudo actualizarse repositorio para la empresa. Se continuará el proceso.", SQLCA.SQLErrText)
		END IF
	end if		
	ls_archivo = 'solicita_'+docu+'_1'+'_'+string(datetime(today(),now()),'yyyymmddhhmmss')
	dw_for.SetItem(1,'nom_usuario',g_descrip_usu)
	dw_for.modify("DataWindow.Printer= 'Foxit Reader PDF Printer'") 
	dw_for.modify("DataWindow.print.documentname='"+ls_archivo+"'") 	
	if dw_for.print()=-1 then 
		MessageBox('Atención','No se pudo generar el PDF ')
		return -1
	end if
	l_ret = 0
	do while not fileExists(is_path + ls_archivo+'.PDF')
		sleep(1)
		l_ret++
		if l_ret >= 10 then
			messageBox('Atención','Se excedió tiempo de espera de archivo pdf')
			Return -1
		end if
	loop
	l_nombre=f_envia_mail(l_servidor, l_puerto,l_usuario,l_clave,l_autentica,l_conexion,l_email,l_asunto,l_desc,p_nombre,ls_archivo,'')
	FileDelete(ls_archivo)	
else
	MessageBox('Atención','No se generó reporte. No se recuperó información de la base de datos')
end if
end event

type cb_save from picturebutton within tabpage_8
integer x = 4645
integer y = 160
integer width = 146
integer height = 128
integer taborder = 70
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
string text = "               &g"
boolean originalsize = true
string picturename = "guardar2.GIF"
string disabledname = "d_guardar2.GIF"
alignment htextalign = left!
string powertiptext = "Guardar datos de Afilización [Alt+G]"
end type

event clicked;if f_grabar_emp()=-1 then
	rollback;
else
	tab_1.tab_afilia.dw_empac.reset()
	contra.reset()
	contra.insertrow(1)
	tab_1.tab_afilia.dw_empac.insertrow(1)
	commit;
	if isvalid(w_hist_gral) then w_hist_gral.triggerevent(open!)
	if isvalid(w_apoyo_diag2) then w_apoyo_diag2.triggerevent(open!)
	if isvalid(w_factura) then w_factura.triggerevent(open!)
	if isvalid(w_rec_caja) then w_rec_caja.triggerevent(open!)
	if isvalid(w_admision) then w_admision.triggerevent(open!)
	if isvalid(w_asig_cita) then w_asig_cita.triggerevent(open!)
end if
tab_1.tab_afilia.cbx_act.triggerevent(clicked!)
end event

type cb_dele from picturebutton within tabpage_8
integer x = 4645
integer y = 28
integer width = 146
integer height = 128
integer taborder = 70
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
string text = "             &b"
boolean originalsize = true
string picturename = "borrar_fila.GIF"
string disabledname = "d_borrar_fila.GIF"
alignment htextalign = left!
string powertiptext = "Borrar [Alt+B]"
end type

event clicked;long fila,cuantos,j
string emp,cont,newemp,newcont
fila=tab_1.tab_afilia.tab_3.tabpage_8.dw_emppacg.getrow()
if fila<1 then return
if w_principal.dw_1.getitemstring(1,'estado')='1' then
  messagebox("Atención","Este Paciente esta Fallecido no puede borrar contratos")
  return
end if
emp=tab_1.tab_afilia.tab_3.tabpage_8.dw_emppacg.getitemstring(fila,"codemp")
cont=tab_1.tab_afilia.tab_3.tabpage_8.dw_emppacg.getitemstring(fila,"codcontrato")
select count(cemp) into :cuantos from hospadmi where tipodoc=:tipdoc and documento=:docu and cemp=:emp and  ccontrato=:cont and (estado='1' or estado='2');
if cuantos>0 then
	messagebox("Atención","El paciente tiene con esta empresa y contrato un ingreso en Hospitalización y/o Urgencias activo, no puede borrar este contrato. Para borrarlo debe cambiar el responsable de la admisión.")
	return
end if
select count(cemp) into :cuantos from factcpo where tipodoc=:tipdoc and documento=:docu and cemp=:emp and  ccontrato=:cont;
if cuantos>0 then
	messagebox("Atención","El paciente tiene con esta empresa y contrato Servicios Fcaturados , no puede borrar este contrato. Para borrarlo debe cambiar el responsable de la admisión.")
	return
end if


cuantos=tab_1.tab_afilia.dw_serv.retrieve(tipdoc,docu,emp,cont)
if cuantos>0 then
	tab_1.tab_afilia.dw_esco.retrieve(tipdoc,docu,emp,cont)
	if tab_1.tab_afilia.dw_esco.rowcount()>0 then
		messagebox("Atención",'El paciente tiene servicios prestados con esta empresa y contrato y no se le pueden asignar a otra empresa ya que no se le ha asignado otra, debe asignarle primero una para poder borrar esta afiliación')
		return
	elseif tab_1.tab_afilia.dw_esco.rowcount()>1 then
		openwithparm(w_escoge,tab_1.tab_afilia.dw_esco)
		if message.doubleparm=0 then return
		newemp=tab_1.tab_afilia.dw_esco.getitemstring(message.doubleparm,'codemp')
		newcont=tab_1.tab_afilia.dw_esco.getitemstring(message.doubleparm,'codcontrato')
	else
		newemp=tab_1.tab_afilia.dw_esco.getitemstring(1,'codemp')
		newcont=tab_1.tab_afilia.dw_esco.getitemstring(1,'codcontrato')
	end if
end if
for j=1 to cuantos
	tab_1.tab_afilia.dw_serv.setitem(j,'cemp',newemp)
	tab_1.tab_afilia.dw_serv.setitem(j,'ccontrato',newcont)
next
if tab_1.tab_afilia.dw_serv.update()=-1 then
	rollback;
	return
end if
tab_1.tab_afilia.tab_3.tabpage_8.dw_emppacg.deleterow(0)
if f_grabar_emp()=-1 then
	rollback;
else
	commit;
end if
	
end event

type dw_emppacg from datawindow within tabpage_8
integer x = 50
integer y = 28
integer width = 4581
integer height = 704
integer taborder = 70
string title = "none"
string dataobject = "dw_empacguarda_ori"
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event rowfocuschanged;tab_1.tab_afilia.tab_3.tabpage_6.dw_tree.retrieve(tab_1.tab_afilia.tab_3.tabpage_8.dw_emppacg.getitemstring(tab_1.tab_afilia.tab_3.tabpage_8.dw_emppacg.getrow(),"codemp"),tab_1.tab_afilia.tab_3.tabpage_8.dw_emppacg.getitemstring(tab_1.tab_afilia.tab_3.tabpage_8.dw_emppacg.getrow(),"codcontrato"))
end event

event retrieveend;tab_1.tab_afilia.tab_3.tabpage_6.dw_tree.retrieve(tab_1.tab_afilia.tab_3.tabpage_8.dw_emppacg.getitemstring(tab_1.tab_afilia.tab_3.tabpage_8.dw_emppacg.getrow(),"codemp"),tab_1.tab_afilia.tab_3.tabpage_8.dw_emppacg.getitemstring(tab_1.tab_afilia.tab_3.tabpage_8.dw_emppacg.getrow(),"codcontrato"))
end event

type tabpage_6 from userobject within tab_3
integer x = 18
integer y = 112
integer width = 4814
integer height = 768
long backcolor = 79741120
string text = "Arbol de Servicios"
long tabtextcolor = 33554432
long tabbackcolor = 79741120
string picturename = "tree.ico"
long picturemaskcolor = 536870912
pb_exp pb_exp
dw_tree dw_tree
end type

on tabpage_6.create
this.pb_exp=create pb_exp
this.dw_tree=create dw_tree
this.Control[]={this.pb_exp,&
this.dw_tree}
end on

on tabpage_6.destroy
destroy(this.pb_exp)
destroy(this.dw_tree)
end on

type pb_exp from picturebutton within tabpage_6
integer x = 4613
integer y = 32
integer width = 146
integer height = 128
integer taborder = 30
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean originalsize = true
string picturename = "export.gif"
alignment htextalign = left!
string powertiptext = "Exporta arbol de Servicios"
end type

event clicked;if dw_tree.rowcount()>0 then
	openwithparm(w_export,dw_tree)
end if
end event

type dw_tree from datawindow within tabpage_6
integer x = 82
integer y = 28
integer width = 4489
integer height = 708
integer taborder = 50
string title = "none"
string dataobject = "dw_arbol_servicios_cont"
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;settransobject(sqlca)


end event

type cbx_act from checkbox within tab_afilia
integer x = 2258
integer y = 868
integer width = 585
integer height = 64
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Mostrar solo los Activos"
boolean checked = true
end type

event clicked;if checked then
	tab_1.tab_afilia.tab_3.tabpage_8.dw_emppacg.setfilter('estado="1"')
else
	tab_1.tab_afilia.tab_3.tabpage_8.dw_emppacg.setfilter('')
end if
tab_1.tab_afilia.tab_3.tabpage_8.dw_emppacg.filter()

end event

type cb_inser from picturebutton within tab_afilia
integer x = 4681
integer y = 92
integer width = 146
integer height = 128
integer taborder = 50
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
string text = "           &i"
string picturename = "insertar.GIF"
string disabledname = "d_insertar.GIF"
string powertiptext = "Insertar [Alt+I]"
end type

event clicked;if w_principal.dw_1.getitemstring(1,'estado')='1' then
  messagebox("Atención","Este Paciente esta Fallecido no puede adicionar contratos")
  return
end if

if tab_1.tab_afilia.dw_empac.rowcount()>0 and contra.rowcount()>0 then
	long fila, l_consec,i
	string codem,codcont,codtipaf,carnet
	dw_empac.accepttext()
	codem=dw_empac.getitemstring(1,"codemp")
	codcont=dw_empac.getitemstring(1,"codcontrato")
	codtipaf=dw_empac.getitemstring(1,"codta")
	if contra.getitemstring(contra.getrow(),"tafil")='1' and codtipaf='0' then
		messagebox("Atención","Este Contrato exige tipo de afiliado, debe escogerlo para continuar")
		return
	end if
	if isnull(codem) or codem="" or isnull(codcont) or codcont=""  then 
		messagebox("Atención","Escoja Empresa, Contrato y Tipo Afiliado")
		return
	end if
	carnet=tab_1.tab_afilia.dw_empac.getitemstring(1,"carnet")
	if codcont<>"" and codem<>"" then //and carnet<>"" then
		tab_1.tab_afilia.tab_3.tabpage_8.dw_emppacg.setfilter("codemp='"+codem+"' and codcontrato='"+codcont+ "'")
		tab_1.tab_afilia.tab_3.tabpage_8.dw_emppacg.Filter()
		if tab_1.tab_afilia.tab_3.tabpage_8.dw_emppacg.rowcount() = 0 then
			If isnull(l_consec) or l_consec=0  then
				l_consec=f_trae_n_emp(codem,codcont)
				for i= 1 to tab_1.tab_afilia.tab_3.tabpage_8.dw_emppacg.rowcount() 
					tab_1.tab_afilia.tab_3.tabpage_8.dw_emppacg.setitem(i,"item",l_consec)
				next
			End if
		Else
			l_consec=tab_1.tab_afilia.tab_3.tabpage_8.dw_emppacg.getitemnumber(1,"promedio")
		End If	
		tab_1.tab_afilia.tab_3.tabpage_8.dw_emppacg.setfilter('estado="1"')		
		tab_1.tab_afilia.tab_3.tabpage_8.dw_emppacg.Filter()
		fila=tab_1.tab_afilia.tab_3.tabpage_8.dw_emppacg.insertrow(0)
		tab_1.tab_afilia.tab_3.tabpage_8.dw_emppacg.setitem(fila,"tipodoc",tipdoc)
		tab_1.tab_afilia.tab_3.tabpage_8.dw_emppacg.setitem(fila,"documento",docu)
		tab_1.tab_afilia.tab_3.tabpage_8.dw_emppacg.setitem(fila,"codemp",codem)
		tab_1.tab_afilia.tab_3.tabpage_8.dw_emppacg.setitem(fila,"codcontrato",codcont)
		tab_1.tab_afilia.tab_3.tabpage_8.dw_emppacg.setitem(fila,"carnet",carnet)
		tab_1.tab_afilia.tab_3.tabpage_8.dw_emppacg.setitem(fila,"codta",codtipaf)
		tab_1.tab_afilia.tab_3.tabpage_8.dw_emppacg.setitem(fila,"item",l_consec)
		if f_grabar_emp()=-1 then
			rollback;
			tab_1.tab_afilia.tab_3.tabpage_8.dw_emppacg.deleterow(fila)
		else
			commit;
			tab_1.tab_afilia.tab_3.tabpage_8.dw_emppacg.retrieve(tipdoc,docu)
		end if
	end if
end if
end event

type dw_esco from datawindow within tab_afilia
boolean visible = false
integer x = 4677
integer y = 816
integer width = 155
integer height = 108
integer taborder = 50
boolean enabled = false
string title = "none"
string dataobject = "dw_escoje_emp_reemp"
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;settransobject(sqlca)
end event

type dw_serv from datawindow within tab_afilia
boolean visible = false
integer x = 4261
integer y = 664
integer width = 110
integer height = 108
integer taborder = 40
boolean enabled = false
string title = "none"
string dataobject = "dw_cambia_emp_serv_nofactu"
boolean border = false
boolean livescroll = true
end type

event constructor;settransobject(sqlca)
end event

type dw_empac from datawindow within tab_afilia
event mousemove pbm_mousemove
integer x = 96
integer y = 92
integer width = 4229
integer height = 144
integer taborder = 50
string dragicon = "none!"
string dataobject = "dw_emppac"
boolean border = false
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event itemchanged;string codem,l_null,regim

setnull(l_null)
if this.getcolumnname() = "codemp" then
	this.accepttext()
	setitem(1,'ctreg',l_null)
	setitem(1,'codcontrato',l_null)
	codem=this.getitemstring(1,"codemp")
	gc_regimen.retrieve(codem)
end if
if this.getcolumnname() = "ctreg" then
	this.accepttext()
	codem=this.getitemstring(1,"codemp")
	setitem(row,'codcontrato',l_null)
	regim=this.getitemstring(1,"ctreg")
	if l_contrato='1' then
	   contra.retrieve(codem,clugar,regim)
	else
		contra.retrieve(codem,l_null,regim)
	end if
	dw_req.reset()
	this.setitem(1,"tafil",contra.getitemstring(contra.getrow(),'tafilr'))
	this.setitem(1,"codta",'')
end if
if this.getcolumnname() = "codcontrato" then
	codem=this.getitemstring(1,"codemp")
	dw_req.retrieve(codem,data)
	this.setitem(1,"tafil",contra.getitemstring(contra.getrow(),'tafilr'))
end if
end event

event constructor;this.getchild('codcontrato',contra)
this.getchild('codcontrato',gc_emp)
this.getchild('ctreg',gc_regimen)
contra.settransobject(sqlca)
gc_regimen.settransobject(sqlca)
gc_emp.settransobject(sqlca)
this.settransobject(sqlca)

end event

type gb_1 from groupbox within tab_afilia
integer x = 46
integer y = 16
integer width = 4837
integer height = 692
integer taborder = 20
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long backcolor = 80269524
string text = "Escoja Empresa y Contrato a Agregar:"
end type

type tabpage_2 from userobject within tab_1
event mousemove pbm_mousemove
integer x = 18
integer y = 112
integer width = 4914
integer height = 1644
string dragicon = "none!"
long backcolor = 67108864
string pointer = "Arrow!"
string text = "Grupo Familiar"
long tabtextcolor = 33554432
string picturename = "grupo_familiar.ico"
long picturemaskcolor = 536870912
pb_ayuda2 pb_ayuda2
cb_4 cb_4
cb_3 cb_3
cb_2 cb_2
dw_3 dw_3
end type

on tabpage_2.create
this.pb_ayuda2=create pb_ayuda2
this.cb_4=create cb_4
this.cb_3=create cb_3
this.cb_2=create cb_2
this.dw_3=create dw_3
this.Control[]={this.pb_ayuda2,&
this.cb_4,&
this.cb_3,&
this.cb_2,&
this.dw_3}
end on

on tabpage_2.destroy
destroy(this.pb_ayuda2)
destroy(this.cb_4)
destroy(this.cb_3)
destroy(this.cb_2)
destroy(this.dw_3)
end on

event dragdrop;tab_1.tabpage_2.dw_3.deleterow(0)
end event

event constructor;tab_1.tabpage_2.backcolor=rgb(245,245,245)
end event

type pb_ayuda2 from picturebutton within tabpage_2
integer x = 2816
integer y = 1404
integer width = 146
integer height = 128
integer taborder = 70
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
string text = "         &y"
boolean originalsize = true
string picturename = "ayuda.gif"
string disabledname = "d_ayuda.gif"
alignment htextalign = left!
string powertiptext = "Ayuda sobre Composición Familiar [Alt+Y]"
end type

event clicked;ShowHelp(dir_insta+"Gciltda.hlp", keyword!,"Composición Familiar del Paciente")
end event

type cb_4 from picturebutton within tabpage_2
integer x = 2638
integer y = 1404
integer width = 146
integer height = 128
integer taborder = 80
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
string text = "         $g"
boolean originalsize = true
string picturename = "guardar2.GIF"
string disabledname = "d_guardar2.GIF"
alignment htextalign = left!
string powertiptext = "Guardar [Alt+G]"
end type

event clicked;if tab_1.tabpage_2.dw_3.update()<1 then
	rollback;
else
	commit;
	tab_1.tabpage_1.cb_guarda.triggerevent(clicked!)
end if
end event

type cb_3 from picturebutton within tabpage_2
integer x = 2459
integer y = 1404
integer width = 146
integer height = 128
integer taborder = 70
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
string text = "          &b"
boolean originalsize = true
string picturename = "borrar_fila.GIF"
string disabledname = "d_borrar_fila.GIF"
alignment htextalign = left!
string powertiptext = "Borrar Registro [ALt+B]"
end type

event clicked;if tab_1.tabpage_2.dw_3.rowcount()<0 then return
tab_1.tabpage_2.dw_3.deleterow(0)
tab_1.tabpage_2.cb_4.triggerevent(clicked!)
end event

type cb_2 from picturebutton within tabpage_2
integer x = 2286
integer y = 1404
integer width = 146
integer height = 128
integer taborder = 80
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
string text = "          &i"
boolean originalsize = true
string picturename = "Insertar.GIF"
string disabledname = "d_Insertar.GIF"
alignment htextalign = left!
string powertiptext = "Insertar Registro [Alt+I]"
end type

event clicked;long fila,cuenta,i
fila=tab_1.tabpage_2.dw_3.insertrow(0);
tab_1.tabpage_2.dw_3.setitem(fila,"nhistoria",histo)
for i=1 to fila
	if tab_1.tabpage_2.dw_3.Find("contador="+string(i), 1, fila)<1 then
		tab_1.tabpage_2.dw_3.setitem(fila,"contador",i)
	end if
next

end event

type dw_3 from datawindow within tabpage_2
event mousemove pbm_mousemove
integer x = 59
integer y = 96
integer width = 4791
integer height = 1260
integer taborder = 40
string dragicon = "none!"
string dataobject = "dw_comp_familiar"
boolean hscrollbar = true
boolean vscrollbar = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event doubleclicked;if tab_1.tabpage_2.dw_3.getcolumnname()<>"ocodigo" then return
st_edadsexo st_es
st_diag st_d
openwithparm(w_busca_ocupacion,st_es)
st_d=message.powerobjectparm
if not isValid(st_d) then return
if not isNull(st_d.codrip) then
	tab_1.tabpage_2.dw_3.setitem(1,"ocupacion",st_d.codgeral)
	tab_1.tabpage_2.dw_3.setitem(1,"ocodigo",st_d.codrip)
	tab_1.tabpage_2.dw_3.setitem(1,"des_ocup",st_d.descripcion)
end if

end event

event itemchanged;accepttext()
if getcolumnname()="documento"  then
	string n1,n2,a1,a2,sx,ltd,ldc,cd,oc,dr,te,es,dp

	ltd=getitemstring(row,"tipodoc")
	ldc=getitemstring(row,"documento")

	if tipdoc=ltd and docu=ldc then
		messagebox('Atención', 'No puede ser el mismo paciente parte del grupo familiar')
		return
	end if
	
	SELECT NOMBRE1, NOMBRE2, APELLIDO1, APELLIDO2,  SEXO,CDEPTO,CCIUDAD, CODOCUP, DIRECCION, TEL,ESCOLARIDAD
	into :n1,:n2,:a1,:a2,:sx,:dp,:cd,:oc,:dr,:te,:es
	FROM PACIENTES
	WHERE (((TIPODOC)=:ltd) AND ((DOCUMENTO)=:ldc));
	if not isnull(n1) then
		setitem(row,"nombre1",n1)
		setitem(row,"nombre2",n2)
		setitem(row,"apellido1",a1)
		setitem(row,"apellido2",a2)
		setitem(row,"sexo",sx)
		setitem(row,"direccion",dr)
		setitem(row,"telefono",te)
		setitem(row,"cdepto",dp)
		setitem(row,"cciudad",cd)
		setitem(row,"ocupacion",oc)
		setitem(row,"escolaridad",es)
	end if
end if
if getcolumnname()="cdepto"  then
	ciudad_fam.setfilter("cdepto='"+data+"'")
	ciudad_fam.filter()
end if
if getcolumnname()="sexo"  then
	idw_paren.setfilter("sexo in ('0','"+data+"')")
	idw_paren.filter()
end if


accepttext()
end event

event constructor;dw_3.GetChild('cciudad', ciudad_fam)
ciudad_fam.settransobject(sqlca)
dw_3.GetChild('parentesco', idw_paren)
idw_paren.settransobject(sqlca)
ciudad_fam.InsertRow(0)
end event

type tabpage_3 from userobject within tab_1
event mousemove pbm_mousemove
integer x = 18
integer y = 112
integer width = 4914
integer height = 1644
string dragicon = "none!"
long backcolor = 67108864
string pointer = "Arrow!"
string text = "Historia Ocupacional"
long tabtextcolor = 33554432
string picturename = "cargo.ico"
long picturemaskcolor = 536870912
pb_ayuda3 pb_ayuda3
cb_ultimo cb_ultimo
cb_posterior cb_posterior
cb_guardar cb_guardar
cb_borrar cb_borrar
cb_adic cb_adic
cb_anterior cb_anterior
cb_primero cb_primero
dw_hist_lab dw_hist_lab
end type

on tabpage_3.create
this.pb_ayuda3=create pb_ayuda3
this.cb_ultimo=create cb_ultimo
this.cb_posterior=create cb_posterior
this.cb_guardar=create cb_guardar
this.cb_borrar=create cb_borrar
this.cb_adic=create cb_adic
this.cb_anterior=create cb_anterior
this.cb_primero=create cb_primero
this.dw_hist_lab=create dw_hist_lab
this.Control[]={this.pb_ayuda3,&
this.cb_ultimo,&
this.cb_posterior,&
this.cb_guardar,&
this.cb_borrar,&
this.cb_adic,&
this.cb_anterior,&
this.cb_primero,&
this.dw_hist_lab}
end on

on tabpage_3.destroy
destroy(this.pb_ayuda3)
destroy(this.cb_ultimo)
destroy(this.cb_posterior)
destroy(this.cb_guardar)
destroy(this.cb_borrar)
destroy(this.cb_adic)
destroy(this.cb_anterior)
destroy(this.cb_primero)
destroy(this.dw_hist_lab)
end on

type pb_ayuda3 from picturebutton within tabpage_3
integer x = 2162
integer y = 816
integer width = 146
integer height = 128
integer taborder = 60
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
string text = "          &y"
boolean originalsize = true
string picturename = "ayuda.gif"
string disabledname = "d_ayuda.gif"
alignment htextalign = left!
string powertiptext = "Ayuda sobre Historia Laboral [Alt+Y]"
end type

event clicked;ShowHelp(dir_insta+"Gciltda.hlp", keyword!,"Historia Laboral del Paciente")
end event

type cb_ultimo from picturebutton within tabpage_3
integer x = 2016
integer y = 816
integer width = 146
integer height = 128
integer taborder = 70
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean originalsize = true
string picturename = "ultimo.GIF"
string disabledname = "d_ultimo.GIF"
string powertiptext = "Ultimo"
end type

event clicked;tab_1.tabpage_3.dw_hist_lab.scrolltorow(tab_1.tabpage_3.dw_hist_lab.rowcount())
end event

type cb_posterior from picturebutton within tabpage_3
integer x = 1865
integer y = 816
integer width = 146
integer height = 128
integer taborder = 70
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean originalsize = true
string picturename = "adelante_1.GIF"
string disabledname = "d_adelante_1.GIF"
string powertiptext = "Siguiente"
end type

event clicked;tab_1.tabpage_3.dw_hist_lab.scrollnextrow()
end event

type cb_guardar from picturebutton within tabpage_3
integer x = 1719
integer y = 816
integer width = 146
integer height = 128
integer taborder = 70
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean originalsize = true
string picturename = "guardar2.GIF"
string disabledname = "d_guardar2.GIF"
alignment htextalign = left!
string powertiptext = "Guardar"
end type

event clicked;if tab_1.tabpage_3.dw_hist_lab.update()<1 then
	rollback;
	tab_1.tabpage_3.dw_hist_lab.retrieve(histo)
else
	commit;
	tab_1.tabpage_1.cb_guarda.triggerevent(clicked!)
end if
end event

type cb_borrar from picturebutton within tabpage_3
integer x = 1568
integer y = 816
integer width = 146
integer height = 128
integer taborder = 70
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean originalsize = true
string picturename = "borrar_fila.GIF"
string disabledname = "d_borrar_fila.GIF"
alignment htextalign = left!
string powertiptext = "Borrar"
end type

event clicked;tab_1.tabpage_3.dw_hist_lab.deleterow(0);
end event

type cb_adic from picturebutton within tabpage_3
integer x = 1417
integer y = 816
integer width = 146
integer height = 128
integer taborder = 70
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean originalsize = true
string picturename = "insertar.GIF"
string disabledname = "d_insertar.GIF"
alignment htextalign = left!
string powertiptext = "Insertar"
end type

event clicked;long fila,cuenta,i
fila=tab_1.tabpage_3.dw_hist_lab.insertrow(0);
tab_1.tabpage_3.dw_hist_lab.setitem(fila,"nhistoria",histo)
for i=1 to fila
	if tab_1.tabpage_3.dw_hist_lab.Find("contador="+string(i), 1, fila)<1 then
		tab_1.tabpage_3.dw_hist_lab.setitem(fila,"contador",i)
	end if
next
tab_1.tabpage_3.dw_hist_lab.scrolltorow(FILA)
end event

type cb_anterior from picturebutton within tabpage_3
integer x = 1266
integer y = 816
integer width = 146
integer height = 128
integer taborder = 60
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean originalsize = true
string picturename = "atras.GIF"
string disabledname = "d_atras.GIF"
alignment htextalign = left!
string powertiptext = "Anterior"
end type

event clicked;tab_1.tabpage_3.dw_hist_lab.scrollpriorrow()
end event

type cb_primero from picturebutton within tabpage_3
integer x = 1115
integer y = 816
integer width = 146
integer height = 128
integer taborder = 70
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean originalsize = true
string picturename = "atras_1.GIF"
string disabledname = "d_atras_1.GIF"
alignment htextalign = left!
string powertiptext = "Primero"
end type

event clicked;tab_1.tabpage_3.dw_hist_lab.scrolltorow(1)
end event

type dw_hist_lab from datawindow within tabpage_3
event mousemove pbm_mousemove
integer x = 101
integer y = 92
integer width = 3237
integer height = 692
integer taborder = 50
string dragicon = "none!"
string dataobject = "dw_hist_labo"
boolean border = false
end type

event rowfocuschanging;if KeyDown(KeyDownArrow!) OR KeyDown(KeyUpArrow!) or keydown(keytab!) or keydown(keyenter!)then 
	this.scrolltorow(currentrow)
	return 1
end if
end event

type tabpage_4 from userobject within tab_1
event mousemove pbm_mousemove
integer x = 18
integer y = 112
integer width = 4914
integer height = 1644
long backcolor = 79741120
string text = "Ubicación"
long tabtextcolor = 33554432
long tabbackcolor = 79741120
string picturename = "audita.ico"
long picturemaskcolor = 536870912
pb_ayuda4 pb_ayuda4
cb_ultimo1 cb_ultimo1
cb_posterior1 cb_posterior1
cb_guardar1 cb_guardar1
cb_borrar1 cb_borrar1
cb_adic1 cb_adic1
cb_anterior1 cb_anterior1
cb_primero1 cb_primero1
dw_5 dw_5
end type

on tabpage_4.create
this.pb_ayuda4=create pb_ayuda4
this.cb_ultimo1=create cb_ultimo1
this.cb_posterior1=create cb_posterior1
this.cb_guardar1=create cb_guardar1
this.cb_borrar1=create cb_borrar1
this.cb_adic1=create cb_adic1
this.cb_anterior1=create cb_anterior1
this.cb_primero1=create cb_primero1
this.dw_5=create dw_5
this.Control[]={this.pb_ayuda4,&
this.cb_ultimo1,&
this.cb_posterior1,&
this.cb_guardar1,&
this.cb_borrar1,&
this.cb_adic1,&
this.cb_anterior1,&
this.cb_primero1,&
this.dw_5}
end on

on tabpage_4.destroy
destroy(this.pb_ayuda4)
destroy(this.cb_ultimo1)
destroy(this.cb_posterior1)
destroy(this.cb_guardar1)
destroy(this.cb_borrar1)
destroy(this.cb_adic1)
destroy(this.cb_anterior1)
destroy(this.cb_primero1)
destroy(this.dw_5)
end on

event dragdrop;dw_5.scrolltorow(dw_5.rowcount())
end event

type pb_ayuda4 from picturebutton within tabpage_4
integer x = 2103
integer y = 804
integer width = 146
integer height = 128
integer taborder = 80
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
string text = "          &y"
boolean originalsize = true
string picturename = "ayuda.gif"
string disabledname = "d_ayuda.gif"
string powertiptext = "Ayuda sobre Ubicación de Historia Clínica [ALt+Y]"
end type

event clicked;ShowHelp(dir_insta+"Gciltda.hlp", keyword!,"Ubicación de historia Clínica")
end event

type cb_ultimo1 from picturebutton within tabpage_4
integer x = 1957
integer y = 804
integer width = 146
integer height = 128
integer taborder = 60
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean originalsize = true
string picturename = "Ultimo.gif"
string disabledname = "d_Ultimo.gif"
string powertiptext = "Ultimo"
end type

type cb_posterior1 from picturebutton within tabpage_4
integer x = 1806
integer y = 804
integer width = 146
integer height = 128
integer taborder = 90
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean originalsize = true
string picturename = "adelante_1.GIF"
string disabledname = "d_adelante_1.GIF"
string powertiptext = "Siguiente"
end type

event clicked;tab_1.tabpage_4.dw_5.scrollnextrow()
end event

type cb_guardar1 from picturebutton within tabpage_4
integer x = 1655
integer y = 804
integer width = 146
integer height = 128
integer taborder = 80
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean originalsize = true
string picturename = "guardar2.GIF"
string disabledname = "d_guardar2.GIF"
string powertiptext = "Guardar"
end type

event clicked;if nuevo=1 then
	UPDATE Historiaubica SET Historiaubica.estado = '1'
	WHERE Historiaubica.NHistoria=:histo;
end if
nuevo=0
if tab_1.tabpage_4.dw_5.update()<1 then
	rollback;
	tab_1.tabpage_4.dw_5.retrieve(histo)
	cb_adic1.enabled=true
else
	commit;
	tab_1.tabpage_1.cb_guarda.triggerevent(clicked!)
	cb_adic1.enabled=true
end if
end event

type cb_borrar1 from picturebutton within tabpage_4
integer x = 1504
integer y = 804
integer width = 146
integer height = 128
integer taborder = 80
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean originalsize = true
string picturename = "borrar_fila.GIF"
string disabledname = "d_borrar_fila.GIF"
string powertiptext = "Borrar"
end type

event clicked;tab_1.tabpage_4.dw_5.deleterow(0);
end event

type cb_adic1 from picturebutton within tabpage_4
integer x = 1349
integer y = 804
integer width = 146
integer height = 128
integer taborder = 90
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
string picturename = "insertar.GIF"
string disabledname = "d_insertar.GIF"
string powertiptext = "Insertar"
end type

event clicked;long fila,cuenta,i,ultimo
string estados
estados="0"
fila=tab_1.tabpage_4.dw_5.insertrow(1);
tab_1.tabpage_4.dw_5.setitem(fila,"nhistoria",histo)
tab_1.tabpage_4.dw_5.setitem(fila,3,datetime(today()))
nuevo=1
select max(historiaubica.ntraslado) into :ultimo
from historiaubica
where historiaubica.nhistoria=:histo;
if isnull(ultimo) then ultimo=0
ultimo++
tab_1.tabpage_4.dw_5.setitem(fila,2,ultimo)
tab_1.tabpage_4.dw_5.setitem(fila,7,estados)
tab_1.tabpage_4.dw_5.scrolltorow(FILA)
this.enabled=false
end event

type cb_anterior1 from picturebutton within tabpage_4
integer x = 1193
integer y = 804
integer width = 146
integer height = 128
integer taborder = 80
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean originalsize = true
string picturename = "atras.GIF"
string disabledname = "d_atras.GIF"
string powertiptext = "Anterior"
end type

event clicked;tab_1.tabpage_4.dw_5.scrollpriorrow()
end event

type cb_primero1 from picturebutton within tabpage_4
integer x = 1042
integer y = 804
integer width = 146
integer height = 128
integer taborder = 70
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean originalsize = true
string picturename = "atras_1.GIF"
string disabledname = "d_atras_1.GIF"
string powertiptext = "Primero"
end type

event clicked;tab_1.tabpage_4.dw_5.scrolltorow(1)
end event

type dw_5 from datawindow within tabpage_4
event mousemove pbm_mousemove
integer x = 151
integer y = 76
integer width = 2967
integer height = 648
integer taborder = 70
string title = "none"
string dataobject = "dw_traslado_hc"
boolean border = false
boolean livescroll = true
end type

event rowfocuschanging;if KeyDown(KeyDownArrow!) OR KeyDown(KeyUpArrow!) or keydown(keytab!) or keydown(keyenter!)then 
	this.scrolltorow(currentrow)
	return 1
end if
end event

event itemchanged;if this.getcolumnname()="archivo" then
	estan.setfilter("archivo='"+data+"'")
	estan.filter()
	this.setitem(this.getrow(),"estan","")
	this.setitem(this.getrow(),"entrepano","")
end if
if this.getcolumnname()="estan" then
	entrepano.setfilter("estan='"+data+"'")
	entrepano.filter()
	this.setitem(this.getrow(),"entrepano","")
end if
end event

event constructor;tab_1.tabpage_4.dw_5.getchild('estan',estan)
tab_1.tabpage_4.dw_5.getchild('entrepano',entrepano)
estan.settransobject(sqlca)
entrepano.settransobject(sqlca)
end event

type biometria from userobject within tab_1
integer x = 18
integer y = 112
integer width = 4914
integer height = 1644
long backcolor = 79741120
string text = "Biometria"
long tabtextcolor = 33554432
long tabbackcolor = 79741120
string picturename = "finger.ico"
long picturemaskcolor = 536870912
pb_save pb_save
dw_huella_pac dw_huella_pac
dw_biometria dw_biometria
log_es log_es
cbx_log cbx_log
p_imagen p_imagen
mle_1 mle_1
end type

on biometria.create
this.pb_save=create pb_save
this.dw_huella_pac=create dw_huella_pac
this.dw_biometria=create dw_biometria
this.log_es=create log_es
this.cbx_log=create cbx_log
this.p_imagen=create p_imagen
this.mle_1=create mle_1
this.Control[]={this.pb_save,&
this.dw_huella_pac,&
this.dw_biometria,&
this.log_es,&
this.cbx_log,&
this.p_imagen,&
this.mle_1}
end on

on biometria.destroy
destroy(this.pb_save)
destroy(this.dw_huella_pac)
destroy(this.dw_biometria)
destroy(this.log_es)
destroy(this.cbx_log)
destroy(this.p_imagen)
destroy(this.mle_1)
end on

type pb_save from picturebutton within biometria
integer x = 78
integer y = 1064
integer width = 146
integer height = 128
integer taborder = 80
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean enabled = false
boolean originalsize = true
string picturename = "guardar2.GIF"
string disabledname = "d_guardar2.GIF"
end type

event clicked;long	l_fila,ll_handle
String ls_error, ls_test
Blob  lblob_aux
int donde

ls_test="tipodoc='"+tipdoc+"' and documento='"+docu+"' and dedo="+string(ContDedos)
l_fila=dw_huella_pac.find(ls_test,1,dw_huella_pac.rowcount())
If l_fila=0 then
	l_fila	= dw_huella_pac.InsertRow(0)
	dw_huella_pac.setitem(l_fila,'tipodoc',tipdoc)
	dw_huella_pac.setitem(l_fila,'documento',docu)
	dw_huella_pac.setitem(l_fila,'dedo',ContDedos)
End if
ll_handle = FileOpen( gbiometria_filePathName, StreamMode!)
if ll_handle < 1 then
	f_biometria_escribe_log(log_es,'Error al abrir el archivo temporal de imagen')
	return -1
End if
FileReadEx(ll_handle, lp_image)
FileClose(ll_handle)

If dw_huella_pac.update()=-1 then
	rollback;
	f_biometria_escribe_log(log_Es,'Error grabando datos Biometricos')
	return -1
End if

UPDATEBLOB pacientes_biometria SET datos_huella =  :w_principal.pac_template.template
WHERE (((tipodoc)=:tipdoc) AND ((documento)=:docu) AND (dedo=:ContDedos));		
If SQLCA.SQLCode <> 0 then
	Rollback;
	MessageBox( 'Error', 'Error al Grabar el Patrón de la Huella ')
	Return -1
Else
	Commit;
End if
dw_huella_pac.retrieve(tipdoc,docu)
p_imagen.picturename=f_biometria_muestra_imagen(dw_huella_pac,tipdoc,docu,ContDedos,'pac')
dw_biometria.enabled=true
p_imagen.picturename = "Erroneo.png"
pb_save.enabled=false
g_captura=false
return 1
end event

type dw_huella_pac from datawindow within biometria
boolean visible = false
integer x = 2103
integer y = 1064
integer width = 1303
integer height = 188
integer taborder = 70
string title = "none"
string dataobject = "dw_biometria_pacientes"
boolean livescroll = true
borderstyle borderstyle = styleraised!
end type

event constructor;settransobject(sqlca)
end event

type dw_biometria from datawindow within biometria
integer x = 1024
integer y = 100
integer width = 914
integer height = 936
integer taborder = 30
string dataobject = "dw_biometria_imagen"
boolean livescroll = true
borderstyle borderstyle = styleraised!
end type

event clicked;if 	g_captura=false  then 
	If 	dwo.name='p_indice' then
		ContDedos=2
		this.SetItem(row, 'indice', 2)
		f_biometria_escribe_log(log_es,"Capture Huella del dedo INDICE ")
		dw_biometria.Modify("p_mano.FileName = '"+ f_biometria_muestra_imagen(dw_huella_pac,tipdoc,docu,ContDedos,'paci')+"'")
		dw_biometria.enabled=false
	End if
	
	If dwo.name='p_medio' then
		ContDedos=3
		this.SetItem(row, 'indice', 3)
		f_biometria_escribe_log(log_es,"Capture Huella del dedo MEDIO")
		dw_biometria.Modify("p_mano.FileName = '"+ f_biometria_muestra_imagen(dw_huella_pac,tipdoc,docu,ContDedos,'paci')+"'")
	end if
	
	If dwo.name='p_anular' then
		ContDedos=4
		this.SetItem(row, 'indice', 4)
		f_biometria_escribe_log(log_es,"Capture Huella del dedo ANULAR")
		dw_biometria.Modify("p_mano.FileName = '"+ f_biometria_muestra_imagen(dw_huella_pac,tipdoc,docu,ContDedos,'paci')+"'")
	end if
	g_captura=true
	
	//If (pos_x>=905 and pos_x<=1042) and (pos_y>=884 and pos_y<=808) then
	//	ContDedos=1
	//     f_biometria_escribe_log(log_es,"Capture Huella del dedo PULGAR")
	//		p_dedo.picturename=f_biometria_muestra_imagen(dw_huella,'cc',documentos,ContDedos)
	//end if
	
	//If (pos_x>=1315 and pos_x<=1481) and (pos_y>=476 and pos_y<=540) then
	//	ContDedos=5
	//     f_biometria_escribe_log(log_es,"Capture Huella del dedo MEÑIQUE")
	//		p_dedo.picturename=f_biometria_muestra_imagen(dw_huella,'cc',documentos,ContDedos)
	//end if
end if
	

end event

event constructor;dw_biometria.InsertRow(0)
end event

type log_es from listbox within biometria
integer x = 2071
integer y = 576
integer width = 2153
integer height = 460
integer taborder = 30
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 15793151
boolean sorted = false
borderstyle borderstyle = stylelowered!
end type

type cbx_log from checkbox within biometria
integer x = 2075
integer y = 500
integer width = 777
integer height = 64
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Mostar Log del Lector de Huellas"
boolean checked = true
end type

type p_imagen from picture within biometria
integer x = 69
integer y = 100
integer width = 914
integer height = 936
boolean originalsize = true
string picturename = "erroNEO.png"
boolean border = true
borderstyle borderstyle = styleraised!
boolean focusrectangle = false
end type

type mle_1 from multilineedit within biometria
integer x = 2071
integer y = 100
integer width = 2194
integer height = 316
integer taborder = 30
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 15793151
string text = "Para captuar la huella dactilar, haga click sobre el dedo de la mano que desea inscribir.  Para borrar la huella dactilar inscrita de click sobre el dedo que deseae incribala nuevamente.  Los dedos inscritos aparecen en color verde o de manera resaltada."
alignment alignment = center!
integer limit = 500
borderstyle borderstyle = stylelowered!
end type

type tabpage_5 from userobject within tab_1
event create ( )
event destroy ( )
event mover_fotos ( integer p_cual )
event mostrar_fotos ( )
boolean visible = false
integer x = 18
integer y = 112
integer width = 4914
integer height = 1644
boolean enabled = false
long backcolor = 67108864
string text = "Documentos"
long tabtextcolor = 33554432
long tabbackcolor = 79741120
string picturename = "scanner.ico"
long picturemaskcolor = 536870912
nm_3 nm_3
nm_2 nm_2
nm_1 nm_1
cbx_2 cbx_2
cbx_3 cbx_3
cbx_1 cbx_1
pb_printx pb_printx
hsb_1 hsb_1
st_cuantos st_cuantos
p_3 p_3
p_2 p_2
p_1 p_1
pb_save_imagx pb_save_imagx
pb_del_imagx pb_del_imagx
pb_imagx pb_imagx
end type

on tabpage_5.create
this.nm_3=create nm_3
this.nm_2=create nm_2
this.nm_1=create nm_1
this.cbx_2=create cbx_2
this.cbx_3=create cbx_3
this.cbx_1=create cbx_1
this.pb_printx=create pb_printx
this.hsb_1=create hsb_1
this.st_cuantos=create st_cuantos
this.p_3=create p_3
this.p_2=create p_2
this.p_1=create p_1
this.pb_save_imagx=create pb_save_imagx
this.pb_del_imagx=create pb_del_imagx
this.pb_imagx=create pb_imagx
this.Control[]={this.nm_3,&
this.nm_2,&
this.nm_1,&
this.cbx_2,&
this.cbx_3,&
this.cbx_1,&
this.pb_printx,&
this.hsb_1,&
this.st_cuantos,&
this.p_3,&
this.p_2,&
this.p_1,&
this.pb_save_imagx,&
this.pb_del_imagx,&
this.pb_imagx}
end on

on tabpage_5.destroy
destroy(this.nm_3)
destroy(this.nm_2)
destroy(this.nm_1)
destroy(this.cbx_2)
destroy(this.cbx_3)
destroy(this.cbx_1)
destroy(this.pb_printx)
destroy(this.hsb_1)
destroy(this.st_cuantos)
destroy(this.p_3)
destroy(this.p_2)
destroy(this.p_1)
destroy(this.pb_save_imagx)
destroy(this.pb_del_imagx)
destroy(this.pb_imagx)
end on

event mover_fotos(integer p_cual);if p_cual<1 then 	
	p_1.visible=false
	p_2.visible=false
	p_3.visible=false
	hsb_1.position=1
	return
end if
tab_1.tabpage_5.nm_1.enabled=false
tab_1.tabpage_5.nm_2.enabled=false
tab_1.tabpage_5.nm_3.enabled=false
tab_1.tabpage_5.cbx_1.checked=false
tab_1.tabpage_5.cbx_2.checked=false
tab_1.tabpage_5.cbx_3.checked=false
i_actual_image=p_cual
st_cuantos.text='Imagen: '+string(p_cual)+' de '+string(i_nro_imags)

p_1.setfocus()
p_1.setpicture(imags[p_cual])
p_1.visible=true
tab_1.tabpage_5.cbx_1.enabled=true
tab_1.tabpage_5.nm_1.visible=true
tab_1.tabpage_5.nm_1.text=nom_imag[p_cual]
if imprime[p_cual]=1 then
	tab_1.tabpage_5.cbx_1.checked=true
else
	tab_1.tabpage_5.cbx_1.checked=false
end if
p_cual ++
if p_cual>i_nro_imags then 
	p_2.visible=false
	p_3.visible=false
	return
end if
p_2.setpicture(imags[p_cual])
p_2.visible=true
tab_1.tabpage_5.cbx_2.enabled=true
tab_1.tabpage_5.nm_2.visible=true
tab_1.tabpage_5.nm_2.text=nom_imag[p_cual]
if imprime[p_cual]=1 then
	tab_1.tabpage_5.cbx_2.checked=true
else
	tab_1.tabpage_5.cbx_2.checked=false
end if
p_cual ++
if p_cual>i_nro_imags then 
	p_3.visible=false
	return
end if
p_3.setpicture(imags[p_cual])
p_3.visible=true
tab_1.tabpage_5.cbx_3.enabled=true
tab_1.tabpage_5.nm_3.visible=true
tab_1.tabpage_5.nm_3.text=nom_imag[p_cual]
if imprime[p_cual]=1 then
	tab_1.tabpage_5.cbx_3.checked=true
else
	tab_1.tabpage_5.cbx_3.checked=false
end if

end event

event mostrar_fotos();
//
//select max(nro_imag) into :i_nro_imags from pacientes_imagen 
//where tipodoc=:tipdoc and documento=:docu;
//if sqlca.sqlcode=-1 then messagebox("Error leyendo pacientes_imagen",sqlca.sqlerrtext)
//if isnull(i_nro_imags) then i_nro_imags=0
//long j,l_tot_ima=1
//blob l_tt
//string l_nom_imag,l_exte
//
//sqlca.autocommit=true
//for j=1 to i_nro_imags
//	select nombre_imagen,url_imagen,extension into  :l_nom_imag,:docpath,:l_exte
//	from pacientes_imagen 
//	where tipodoc=:tipdoc and documento=:docu and nro_imag=:j;
//	if sqlca.sqlcode=-1 then messagebox("Error leyendo pacientes_imagen",sqlca.sqlerrtext)
//	if not isnull(l_nom_imag) then 
//		nom_imag[l_tot_ima]=l_nom_imag
//		if l_exte<>'pdf' then
//			l_tt=f_lee_file_fisico(docpath)
//		else
//			docpath=l_repositorio+'\'+'pdf.jpg'
//			l_tt=f_lee_file_fisico(docpath)
//		end if
//		exte[l_tot_ima]=l_exte
//		if string(l_tt)='!' then return
//		imags[l_tot_ima]=l_tt
//		imprime[l_tot_ima]=0
//		i_nobjs[l_tot_ima]=j
//		l_tot_ima++
//		setnull(l_nom_imag)
//	end if
//next
// i_nro_imags=l_tot_ima -1
// hsb_1.maxposition=i_nro_imags
//sqlca.autocommit=false
//if i_nro_imags=0 then
//	for j=1 to upperbound(imags[])
//		setnull(imags[j])
//	next
//	for j=1 to upperbound(objs[])
//		setnull(objs[j])
//	next
//	for j=1 to upperbound(exte[])
//		setnull(exte[j])
//	next
//	event mover_fotos(0)
//	hsb_1.position=0
//	st_cuantos.text=''
//else
//	event mover_fotos(1)
//	hsb_1.position=1
//	p_1.setfocus()
//	p_1.event getfocus()
//end if
end event

type nm_3 from statictext within tabpage_5
boolean visible = false
integer x = 2304
integer y = 1176
integer width = 576
integer height = 60
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 134217752
string text = "none"
boolean border = true
borderstyle borderstyle = stylelowered!
boolean focusrectangle = false
end type

type nm_2 from statictext within tabpage_5
boolean visible = false
integer x = 1157
integer y = 1176
integer width = 576
integer height = 60
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 134217752
string text = "none"
boolean border = true
borderstyle borderstyle = stylelowered!
boolean focusrectangle = false
end type

type nm_1 from statictext within tabpage_5
boolean visible = false
integer x = 18
integer y = 1176
integer width = 576
integer height = 60
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 134217752
string text = "none"
boolean border = true
borderstyle borderstyle = stylelowered!
boolean focusrectangle = false
end type

type cbx_2 from checkbox within tabpage_5
integer x = 1152
integer width = 343
integer height = 64
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
boolean enabled = false
string text = "Imprime"
boolean automatic = false
end type

type cbx_3 from checkbox within tabpage_5
integer x = 2309
integer width = 343
integer height = 64
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
boolean enabled = false
string text = "Imprime"
boolean automatic = false
end type

type cbx_1 from checkbox within tabpage_5
integer x = 18
integer width = 343
integer height = 64
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
boolean enabled = false
string text = "Imprime"
boolean automatic = false
end type

type pb_printx from picturebutton within tabpage_5
integer x = 539
integer y = 1368
integer width = 146
integer height = 128
integer taborder = 10
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean originalsize = true
string picturename = "print2.gif"
alignment htextalign = left!
string powertiptext = "Imprimir  Imagen"
end type

event clicked;//string file_jpg, extension,ret,file_pdf,lruta_pdf
//long job
//int l_y=0, l_inc=3900
//blob tota_b
//integer li_FileNum,pr,sitio=1
//setnull(file_pdf)
//setnull(file_jpg)
//
//if i_nro_imags=0 then return
//
//for pr=1 to i_nro_imags
//	if imprime[pr]= 1 then 
//		tota_b=imags[pr]
//		if isNull(tota_b) then
//			 return 
//		else
//			extension =exte[pr]
//			if extension<>'pdf' then 
//				file_jpg ="c:\windows\temp\"+string(pr)+string(today(),'yyyymmddhhmmss') +"." +extension
//				borrar[sitio]=file_jpg
//				li_FileNum = FileOpen(file_jpg, StreamMode!, Write!, LockWrite!, Replace!)
//				if isNull(li_FileNum) or li_FileNum < 1 then
//					MessageBox('Atención','Error creando archivo temporal de imágen')
//					Return -1
//				end if
//				FileWriteEx ( li_FileNum, tota_b)
//				FileClose(li_FileNum)
//				ret = dw_4.Modify("p_"+string(sitio)+".Filename='"+file_jpg+"'")
//				if ret <> '' then 
//					MessageBox('','')
//					ret = dw_4.Modify("p_"+string(sitio)+".Filename=''")
//				end if
//	
//				ret = dw_4.Modify("p_"+string(sitio)+".visible='1'")
//				if ret <> '' then 
//					MessageBox('','')
//					ret = dw_4.Modify("p_"+string(sitio)+".visible='1'")
//				end if
//				ret = dw_4.Modify("p_"+string(sitio)+".x='23'")
//				if ret <> '' then 
//					MessageBox('','')
//					ret = dw_4.Modify("p_"+string(sitio)+".x='23'")
//				end if
//				if sitio> 1 then 	 l_y= l_y+l_inc
//				ret = dw_4.Modify("p_"+string(sitio)+".y='"+string( l_y)+"'")
//				if ret <> '' then 
//					MessageBox('','')
//					ret = dw_4.Modify("p_"+string(sitio)+".y='"+string( l_y)+"'")
//				end if
//				ret = dw_4.Modify("p_"+string(sitio)+".height='3500'")
//				if ret <> '' then 
//					MessageBox('','')
//					ret = dw_4.Modify("p_"+string(sitio)+".width='3470'")
//				end if
//				ret = dw_4.Modify("p_"+string(sitio)+".width='3470'")
//				if ret <> '' then 
//					MessageBox('','')
//					ret = dw_4.Modify("p_"+string(sitio)+".height='3500'")
//				end if			
//				 sitio++
//				if sitio=5 then pr=i_nro_imags
//			else
//				if isnull(file_pdf) then
//					file_pdf='"'+l_repositorio+'\'+tipdoc+docu+'\'+nom_imag[pr]+'"'
//				else
//					file_pdf+=' "'+l_repositorio+'\'+tipdoc+docu+'\'+nom_imag[pr]+'"'
//				end if
//			end if 
//		end if
//	 else
//		continue
//	end if
//next
//if not isnull(file_pdf) then 
//	file_pdf=lruta_pdf+file_pdf
//	run(file_pdf,maximized!)
//end if
//if sitio>1 then 
//	job = PrintOpen( )
//	PrintDataWindow(job, dw_4)
//	PrintClose(job)
//end if
//for pr=1 to sitio -1
//	file_jpg= borrar[pr]
//	//if isnull(tmp_file) then continue
//	FileDelete(file_jpg)		
//next
//
//
//

end event

type hsb_1 from hscrollbar within tabpage_5
integer x = 5
integer y = 1260
integer width = 3406
integer height = 72
boolean stdheight = false
integer minposition = 1
integer maxposition = 10
integer position = 1
end type

event pageright;IF Position > MaxPosition - 3 THEN
   Position = MaxPosition
ELSE
   Position = Position + 3
END IF
tab_1.tabpage_5.event mover_fotos(position)
end event

event lineleft;if position<=1 then return
IF Position < MinPosition + 1 THEN
   Position = MinPosition
ELSE
   Position = Position - 1
END IF
tab_1.tabpage_5.event mover_fotos(position)

end event

event lineright;if position=maxposition then return
IF Position > MaxPosition - 1 THEN
   Position = MaxPosition
ELSE
   Position = Position + 1
END IF
tab_1.tabpage_5.event mover_fotos(position)
end event

event moved;if scrollpos=position then return
tab_1.tabpage_5.event mover_fotos(scrollpos)

end event

event pageleft;IF Position < MinPosition + 3 THEN
   Position = MinPosition
ELSE
   Position = Position - 3
END IF
tab_1.tabpage_5.event mover_fotos(position)
end event

type st_cuantos from statictext within tabpage_5
integer x = 2766
integer y = 1388
integer width = 645
integer height = 68
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 134217752
alignment alignment = center!
boolean border = true
borderstyle borderstyle = stylelowered!
boolean focusrectangle = false
end type

type p_3 from picture within tabpage_5
boolean visible = false
integer x = 2304
integer y = 72
integer width = 1106
integer height = 1092
integer taborder = 70
borderstyle borderstyle = styleshadowbox!
string powertiptext = "Doble click para ampliar"
end type

event getfocus;border=true
p_1.border=false
p_2.border=false
st_cuantos.text='Imagen: '+string(hsb_1.position+2)+' de '+string(i_nro_imags)
i_actual_image=hsb_1.position +2

end event

event clicked;if tab_1.tabpage_5.cbx_3.checked=true then 
	imprime[i_actual_image]=0
	tab_1.tabpage_5.cbx_3.checked=false
else
	imprime[i_actual_image]=1
	tab_1.tabpage_5.cbx_3.checked=true
end if
end event

type p_2 from picture within tabpage_5
boolean visible = false
integer x = 1157
integer y = 72
integer width = 1106
integer height = 1096
integer taborder = 60
borderstyle borderstyle = styleshadowbox!
string powertiptext = "Doble click para ampliar"
end type

event getfocus;border=true
p_1.border=false
p_3.border=false
st_cuantos.text='Imagen: '+string(hsb_1.position+1)+' de '+string(i_nro_imags)
i_actual_image=hsb_1.position +1

end event

event clicked;if tab_1.tabpage_5.cbx_2.checked=true then 
	imprime[i_actual_image]=0
	tab_1.tabpage_5.cbx_1.checked=false
else
	imprime[i_actual_image]=1
	tab_1.tabpage_5.cbx_2.checked=true
end if
end event

type p_1 from picture within tabpage_5
boolean visible = false
integer x = 14
integer y = 72
integer width = 1106
integer height = 1100
integer taborder = 50
borderstyle borderstyle = styleshadowbox!
string powertiptext = "Doble click para ampliar"
end type

event getfocus;border=true
p_2.border=false
p_3.border=false
st_cuantos.text='Imagen: '+string(hsb_1.position)+' de '+string(i_nro_imags)
i_actual_image=hsb_1.position

end event

event clicked;if tab_1.tabpage_5.cbx_1.checked=true then 
	imprime[i_actual_image]=0
	tab_1.tabpage_5.cbx_1.checked=false
else
	imprime[i_actual_image]=1
	tab_1.tabpage_5.cbx_1.checked=true
end if
end event

type pb_save_imagx from picturebutton within tabpage_5
integer x = 361
integer y = 1368
integer width = 146
integer height = 128
integer taborder = 40
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
string picturename = "guardar2.gif"
alignment htextalign = left!
string powertiptext = "Guardar Imágenes"
end type

event clicked;//if isnull(l_repositorio) then
//	messagebox('Atencíon','No hay Repositorio para Almacenamiento')
//	return
//end if
//
//long l_j,fila_ins
//string  l_rutao,l_rutad,ls_path_pac
//integer li_filenum 
//
//ls_path_pac =l_repositorio+'\'+tipdoc+docu
//IF not FileExists(ls_path_pac) THEN 
//li_filenum=CreateDirectory ( ls_path_pac ) 
//	If li_filenum<>1 then 
//		MessageBox(" Atencion","No pudo crear directorio en Repositorio") 
//		return
//	End if 
//End If
//
//if dw_2.rowcount()=0 then 	return
//select max(nro_imag) into :fila_ins from pacientes_imagen 
//where tipodoc=:tipdoc and documento=:docu ;
//if sqlca.sqlcode=-1 then
//	messagebox("Error leyendo pacientes_imagen",sqlca.sqlerrtext)
//	rollback;
//	return
//end if
//if isnull(fila_ins) then fila_ins=0
//fila_ins++
//sqlca.autocommit=true
//for l_j=1 to upperbound(docname[])
//	if upperbound(docname[])=1 then
//		l_rutao= docpath
//	else
//		l_rutao= docpath+'\'+docname[l_j]
//	end if
//	i_nobjs[l_j]=fila_ins
// 	l_rutad=l_repositorio+'\'+tipdoc+docu+'\'+docname[l_j]
//	insert into pacientes_imagen (tipodoc,documento,nro_imag,nombre_imagen,extension,url_imagen)
//	values(:tipdoc,:docu,:fila_ins,:docname[l_j],right(:docname[l_j],3),:l_rutad);
//	if sqlca.sqlcode=-1 then
//		messagebox("Error insertando en Pacientes_imagen",sqlca.sqlerrtext)
//		rollback;
//		return
//	end if
//	//mover el archivo de la carpeta
//	 If FileCopy (l_rutao,l_rutad,TRUE)<0 then	
//		 messagebox('Alerta','Error copiando archivo  '+l_rutao)
//		continue
//	else
//		//  FileDelete(l_rutao)
//	end if
//	fila_ins++
//next
//sqlca.autocommit=false
//commit;
end event

type pb_del_imagx from picturebutton within tabpage_5
integer x = 187
integer y = 1372
integer width = 146
integer height = 128
integer taborder = 30
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean originalsize = true
string picturename = "borrar_fila.gif"
alignment htextalign = left!
string powertiptext = "Borrar Imagen"
end type

event clicked;if isnull(l_repositorio) then
	messagebox('Atencíon','No hay Repositorio para Almacenamiento')
	return
end if

long j
if i_nro_imags=0 then return
int l_elim
l_elim=i_nobjs[i_actual_image]
delete from pacientes_imagen 
where tipodoc=:tipdoc and documento=:docu and nro_imag=:l_elim;
if sqlca.sqlcode=-1 then messagebox("Error borrando pacientes_imagen",sqlca.sqlerrtext)
commit;

for j=i_actual_image to i_nro_imags -1
	imags[j]=imags[j +1]
	i_nobjs[j]=i_nobjs[j+1]
	imprime[j]=0
next
if i_nro_imags >=1 then i_nro_imags --
hsb_1.maxposition=i_nro_imags
if i_actual_image -2 < 1 then 
	i_actual_image=1
else
	i_actual_image -=2
end if
hsb_1.position=i_actual_image
if i_nro_imags=0 then i_actual_image=0
tab_1.tabpage_5.event mover_fotos(i_actual_image)

end event

type pb_imagx from picturebutton within tabpage_5
integer x = 14
integer y = 1372
integer width = 146
integer height = 128
integer taborder = 20
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean originalsize = true
string picturename = "llevar.gif"
alignment htextalign = left!
boolean map3dcolors = true
string powertiptext = "Cargar Imágenes"
end type

event clicked;//if dw_2.rowcount()=0 then
//	messagebox("Atención",'No se han capturado datos paciente, no puede adicionar imágenes')
//	return
//end if
//int ret,cuantos,i
//
//ret = GetFileOpenName("Escoger Imágenes", docpath, docname[],"JPG","JPEG Files (*.JPG),*.JPG, PDF Files (*.PDF),*.PDF")
//IF ret < 1 THEN return
//cuantos= Upperbound(docname)
//blob tt
//if cuantos=0 then return
//if cuantos>1 then
//	for i=1 to cuantos
//		exte[i_nro_imags+i] = right(docname[i],3)
//		if exte[i_nro_imags+i]<>'pdf' then
//			tt=f_lee_file_fisico(string(docpath)+"\"+(string(docname[i])))
//			nom_imag[i_nro_imags+i]=docname[i]
//		else
//			tt=f_lee_file_fisico(l_repositorio+'\'+'pdf.jpg')
//			nom_imag[i_nro_imags+i]=docname[i]
//		end if
//		if string(tt)='!' then continue
//		imags[i_nro_imags+i]=tt
//		i_nobjs[i_nro_imags+i]=0
//		imprime[i_nro_imags+i] =0
//	next
//else
//	exte[i_nro_imags+1] = right(docname[1],3)
//	if exte[i_nro_imags+1]<>'pdf' then
//		tt=f_lee_file_fisico(docpath)
//		nom_imag[i_nro_imags+1]=docname[1]
//	else
//		tt=f_lee_file_fisico(l_repositorio+'\'+'pdf.jpg')
//		nom_imag[i_nro_imags+1]=docname[1]
//	end if
//	if string(tt)='!' then return
//	imags[i_nro_imags+1]=tt
//	i_nobjs[i_nro_imags+1]=0
//	imprime[i_nro_imags+1] =0
//end if
//i_nro_imags+=cuantos
//st_cuantos.text=string(i_nro_imags)
//hsb_1.maxposition=i_nro_imags
//if i_nro_imags -2 <1 then 
//	i_actual_image=1
//else
//	i_actual_image=i_nro_imags -2
//end if
//hsb_1.position=i_actual_image
//tab_1.tabpage_5.event mover_fotos(i_actual_image)
//
end event

type cambios from userobject within tab_1
integer x = 18
integer y = 112
integer width = 4914
integer height = 1644
long backcolor = 79741120
string text = "Cambios Documento"
long tabtextcolor = 33554432
long tabbackcolor = 79741120
string picturename = "cambio_resp.ico"
long picturemaskcolor = 536870912
pb_5 pb_5
pb_4 pb_4
pb_2 pb_2
dw_cambio dw_cambio
end type

on cambios.create
this.pb_5=create pb_5
this.pb_4=create pb_4
this.pb_2=create pb_2
this.dw_cambio=create dw_cambio
this.Control[]={this.pb_5,&
this.pb_4,&
this.pb_2,&
this.dw_cambio}
end on

on cambios.destroy
destroy(this.pb_5)
destroy(this.pb_4)
destroy(this.pb_2)
destroy(this.dw_cambio)
end on

type pb_5 from picturebutton within cambios
integer x = 4741
integer y = 216
integer width = 146
integer height = 128
integer taborder = 100
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean originalsize = true
string picturename = "guardar.gif"
end type

event clicked;if dw_cambio.update()=-1 then
	rollback;
	return
end if
commit;

end event

type pb_4 from pb_report within cambios
integer x = 4741
integer y = 352
integer taborder = 90
string powertiptext = "INCOSNISTENCIA BASE DE DATOS"
string cod_rep = "INBD"
string nombre_rep = "INCOSNISTENCIA BASE DE DATOS"
string tipo_rep = "interno!"
end type

event clicked;call super::clicked;any par[7]
par[1]=tipdoc
par[2]=docu
par[3]=tab_1.tab_afilia.tab_3.tabpage_8.dw_emppacg.getitemstring(tab_1.tab_afilia.tab_3.tabpage_8.dw_emppacg.getrow(),"codemp")
par[4]=tab_1.tab_afilia.tab_3.tabpage_8.dw_emppacg.getitemstring(tab_1.tab_afilia.tab_3.tabpage_8.dw_emppacg.getrow(),"codcontrato")
par[5]=dw_cambio.getitemstring(dw_cambio.getrow(),"tipodoc_ant")
par[6]=dw_cambio.getitemstring(dw_cambio.getrow(),"documento_ant")
par[7]=usuario
imprimir(par,'','0')
end event

type pb_2 from picturebutton within cambios
integer x = 4736
integer y = 76
integer width = 146
integer height = 128
integer taborder = 60
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean originalsize = true
string picturename = "insertar.gif"
end type

event clicked;int fila

fila=dw_cambio.insertrow(0)
dw_cambio.scrolltorow(fila)
dw_cambio.setfocus()
dw_cambio.setitem(fila,'tipodoc',tipdoc)
dw_cambio.setitem(fila,'documento',docu)
dw_cambio.setitem(fila,'tipodoc_ant',tipdoc)
dw_cambio.setitem(fila,'documento_ant',docu)
dw_cambio.setitem(fila,'nombre1',w_principal.dw_1.getitemstring(1,'nombre1'))
dw_cambio.setitem(fila,'nombre2',w_principal.dw_1.getitemstring(1,'nombre2'))
dw_cambio.setitem(fila,'apellido1',w_principal.dw_1.getitemstring(1,'apellido1'))
dw_cambio.setitem(fila,'apellido2',w_principal.dw_1.getitemstring(1,'apellido2'))
dw_cambio.setitem(fila,'fnacimiento',w_principal.dw_1.getitemdatetime(1,'fnacimiento'))
dw_cambio.setitem(fila,'usuario',usuario)
dw_cambio.setitem(fila,'fecha',now())

end event

type dw_cambio from datawindow within cambios
integer x = 82
integer y = 68
integer width = 4622
integer height = 1392
integer taborder = 110
string dataobject = "dw_pacientes_cambio"
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;settransobject(sqlca)
end event

type docs from userobject within tab_1
integer x = 18
integer y = 112
integer width = 4914
integer height = 1644
long backcolor = 79741120
string text = "Documentos"
long tabtextcolor = 33554432
long tabbackcolor = 79741120
string picturename = "scanner.ico"
long picturemaskcolor = 536870912
pb_print pb_print
pb_save_imag pb_save_imag
pb_del_imag pb_del_imag
pb_imag pb_imag
dw_imagenes dw_imagenes
end type

on docs.create
this.pb_print=create pb_print
this.pb_save_imag=create pb_save_imag
this.pb_del_imag=create pb_del_imag
this.pb_imag=create pb_imag
this.dw_imagenes=create dw_imagenes
this.Control[]={this.pb_print,&
this.pb_save_imag,&
this.pb_del_imag,&
this.pb_imag,&
this.dw_imagenes}
end on

on docs.destroy
destroy(this.pb_print)
destroy(this.pb_save_imag)
destroy(this.pb_del_imag)
destroy(this.pb_imag)
destroy(this.dw_imagenes)
end on

type pb_print from picturebutton within docs
integer x = 3717
integer y = 508
integer width = 146
integer height = 128
integer taborder = 30
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean originalsize = true
string picturename = "print2.gif"
string powertiptext = "Imprimir Imagenes"
end type

event clicked;if dw_2.rowcount()=0 then 	return
string file_pdf
int li_f

dw_imagenes.setredraw(false)
dw_imagenes.setfilter("impr=1" )
dw_imagenes.filter()
if dw_2.rowcount()=0 then 
	dw_imagenes.setfilter('')
	dw_imagenes.filter()
	dw_imagenes.setredraw(true)
	return
end if
for li_f=1 to dw_imagenes.rowcount()
	if upper(dw_imagenes.getitemstring(li_f,'extension'))='PDF' then 
		file_pdf=gs_pdf+' '+dw_imagenes.getitemstring(li_f,'url_imagen')
		run(file_pdf,maximized!)
	else
		long Job
		Job = PrintOpen( )
		PrintBitmap(Job, dw_imagenes.getitemstring(li_f,'url_imagen'), 500,500, 0,0)
		PrintClose(Job)
	end if
	dw_imagenes.setitem(li_f,'impr',0)
next
dw_imagenes.setfilter('')
dw_imagenes.filter()
dw_imagenes.setredraw(true)
end event

type pb_save_imag from picturebutton within docs
integer x = 3712
integer y = 372
integer width = 146
integer height = 128
integer taborder = 100
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean originalsize = true
string picturename = "guardar2.gif"
string powertiptext = "Guardar Imagenes"
end type

event clicked;if dw_2.rowcount()=0 then 	return
if isnull(l_repositorio) then
	messagebox('Atencíon','No hay Repositorio para Almacenamiento')
	return
end if

//mover el archivo de la carpeta

string  l_rutao,l_rutad,ls_path_pac
integer li_f
ls_path_pac =l_repositorio+'\'+tipdoc+docu
IF not FileExists(ls_path_pac) THEN 
	li_f=CreateDirectory ( ls_path_pac ) 
	If li_f<>1 then 
		MessageBox(" Atencion","No pudo crear directorio en Repositorio") 
		return
	End If
End if
dw_imagenes.setfilter("impr=2" )
dw_imagenes.filter()
for li_f=1 to dw_imagenes.rowcount()
	l_rutad=l_repositorio+'\'+tipdoc+docu+'\'+dw_imagenes.getitemstring(li_f,'nombre_imagen')
	l_rutao= dw_imagenes.getitemstring(li_f,'rutao')
 	If FileCopy (l_rutao,l_rutad,TRUE)<0 then	
		 messagebox('Alerta','Error copiando archivo  '+l_rutao)
		continue
	else
		//  FileDelete(l_rutao)
	end if
next

If dw_imagenes.update()=-1 then
	rollback;
End if
commit;
dw_imagenes.setfilter('' )
dw_imagenes.filter()
dw_imagenes.retrieve(tipdoc,docu)

end event

type pb_del_imag from picturebutton within docs
integer x = 3712
integer y = 232
integer width = 146
integer height = 128
integer taborder = 90
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean originalsize = true
string picturename = "borrar_fila.gif"
string powertiptext = "Borrar Imagen"
end type

event clicked;dw_imagenes.deleterow(0);
end event

type pb_imag from picturebutton within docs
integer x = 3712
integer y = 84
integer width = 146
integer height = 128
integer taborder = 30
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean originalsize = true
string picturename = "llevar.gif"
alignment htextalign = left!
string powertiptext = "Cargar Imagen"
end type

event clicked;if dw_2.rowcount()=0 then
	messagebox("Atención",'No se han capturado datos paciente, no puede adicionar imágenes')
	return
end if
int ret,cuantos,i,maximos,fila
string ls_path_pac,docname[],docpath

ls_path_pac =l_repositorio+'\'+tipdoc+docu
maximos=dw_imagenes.getitemnumber(1,'maximos')
if isnull(maximos) then maximos=0
maximos=maximos+1

ret = GetFileOpenName("Escoger Imágenes", docpath, docname[],"JPG","JPEG Files (*.JPG),*.JPG, PDF Files (*.PDF),*.PDF")
IF ret < 1 THEN return
cuantos= Upperbound(docname)
if cuantos=0 then return
if cuantos>1 then
	for i=1 to cuantos
		fila=dw_imagenes.insertrow(0)
		dw_imagenes.setitem(fila,'tipodoc',tipdoc)
		dw_imagenes.setitem(fila,'documento',docu)
		dw_imagenes.setitem(fila,'nro_imag',maximos)
		dw_imagenes.setitem(fila,'extension',right(docname[i],3))
		dw_imagenes.setitem(fila,'nombre_imagen',docname[i])
		dw_imagenes.setitem(fila,'url_imagen',l_repositorio+'\'+tipdoc+docu+'\'+docname[i])
		dw_imagenes.setitem(fila,'impr',2)
		dw_imagenes.setitem(fila,'rutao',docpath+'\'+docname[i])
		maximos=maximos+1
	next
else
	fila=dw_imagenes.insertrow(0)
	dw_imagenes.setitem(fila,'tipodoc',tipdoc)
	dw_imagenes.setitem(fila,'documento',docu)
	dw_imagenes.setitem(fila,'nro_imag',maximos)
	dw_imagenes.setitem(fila,'extension',right(docname[1],3))
	dw_imagenes.setitem(fila,'nombre_imagen',docname[1])
	dw_imagenes.setitem(fila,'url_imagen',l_repositorio+'\'+tipdoc+docu+'\'+docname[1])
	dw_imagenes.setitem(fila,'rutao',docpath)
	dw_imagenes.setitem(fila,'impr',2)
end if


end event

type dw_imagenes from datawindow within docs
integer x = 82
integer y = 84
integer width = 3570
integer height = 1412
integer taborder = 90
string title = "none"
string dataobject = "dw_pacientes_imagen"
boolean vscrollbar = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;settransobject(sqlca)
end event

type gb_3 from groupbox within win_regis_pac
integer x = 23
integer width = 3973
integer height = 440
integer taborder = 30
integer textsize = -9
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long backcolor = 80269524
string text = "Datos Generales"
end type


Start of PowerBuilder Binary Data Section : Do NOT Edit
01win_regis_pac.bin 
2B00000600e011cfd0e11ab1a1000000000000000000000000000000000003003e0009fffe00000006000000000000000000000001000000010000000000001000fffffffe00000000fffffffe0000000000000000fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffdfffffffeffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff006f00520074006f004500200074006e00790072000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000050016ffffffffffffffffffffffff000000000000000000000000000000000000000000000000000000000000000000000000fffffffe00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffffffffffffffffffffffff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffffffffffffffffffffffff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffffffffffffffffffffffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11win_regis_pac.bin 
End of PowerBuilder Binary Data Section : No Source Expected After This Point

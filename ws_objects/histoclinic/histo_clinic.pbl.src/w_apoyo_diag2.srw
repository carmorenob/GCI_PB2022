$PBExportHeader$w_apoyo_diag2.srw
forward
global type w_apoyo_diag2 from window
end type
type dw_profe_valida from datawindow within w_apoyo_diag2
end type
type dw_lab from datawindow within w_apoyo_diag2
end type
type dw_trae from datawindow within w_apoyo_diag2
end type
type ddlb_archivos from listbox within w_apoyo_diag2
end type
type dw_prof_resu from datawindow within w_apoyo_diag2
end type
type dw_his_acu from datawindow within w_apoyo_diag2
end type
type dw_canasta from datawindow within w_apoyo_diag2
end type
type dw_sum_cab from datawindow within w_apoyo_diag2
end type
type pb_print_pend from picturebutton within w_apoyo_diag2
end type
type pb_buscar from picturebutton within w_apoyo_diag2
end type
type st_2 from statictext within w_apoyo_diag2
end type
type dw_area from datawindow within w_apoyo_diag2
end type
type st_3 from statictext within w_apoyo_diag2
end type
type cb_revisar from picturebutton within w_apoyo_diag2
end type
type cb_hosp from picturebutton within w_apoyo_diag2
end type
type st_9 from statictext within w_apoyo_diag2
end type
type em_muestra from editmask within w_apoyo_diag2
end type
type em_fecha from editmask within w_apoyo_diag2
end type
type dw_cont_det from datawindow within w_apoyo_diag2
end type
type pb_del from picturebutton within w_apoyo_diag2
end type
type pb_newing from picturebutton within w_apoyo_diag2
end type
type dw_emp from datawindow within w_apoyo_diag2
end type
type dw_hist from datawindow within w_apoyo_diag2
end type
type dw_tip_ingres from datawindow within w_apoyo_diag2
end type
type dw_historial from datawindow within w_apoyo_diag2
end type
type gb_4 from groupbox within w_apoyo_diag2
end type
type tab_1 from tab within w_apoyo_diag2
end type
type tp_1 from userobject within tab_1
end type
type st_7 from statictext within tp_1
end type
type st_5 from statictext within tp_1
end type
type dp_2 from datepicker within tp_1
end type
type dp_1 from datepicker within tp_1
end type
type hpb_1 from hprogressbar within tp_1
end type
type pb_9 from pb_report within tp_1
end type
type pb_8 from picturebutton within tp_1
end type
type st_4 from statictext within tp_1
end type
type pb_notas from picturebutton within tp_1
end type
type sle_2 from singlelineedit within tp_1
end type
type pb_save_insumo from picturebutton within tp_1
end type
type pb_citas from picturebutton within tp_1
end type
type pb_find from picturebutton within tp_1
end type
type mle_1 from multilineedit within tp_1
end type
type st_8 from statictext within tp_1
end type
type sle_autoriza from singlelineedit within tp_1
end type
type sle_1 from singlelineedit within tp_1
end type
type st_1 from statictext within tp_1
end type
type dw_procs from datawindow within tp_1
end type
type pb_cargar_res from picturebutton within tp_1
end type
type cb_borra from picturebutton within tp_1
end type
type st_6 from statictext within tp_1
end type
type cb_trae from picturebutton within tp_1
end type
type cb_traerec from picturebutton within tp_1
end type
type pb_print from pb_report within tp_1
end type
type pb_print_reci from pb_report within tp_1
end type
type pb_print_factu from pb_report within tp_1
end type
type tp_1 from userobject within tab_1
st_7 st_7
st_5 st_5
dp_2 dp_2
dp_1 dp_1
hpb_1 hpb_1
pb_9 pb_9
pb_8 pb_8
st_4 st_4
pb_notas pb_notas
sle_2 sle_2
pb_save_insumo pb_save_insumo
pb_citas pb_citas
pb_find pb_find
mle_1 mle_1
st_8 st_8
sle_autoriza sle_autoriza
sle_1 sle_1
st_1 st_1
dw_procs dw_procs
pb_cargar_res pb_cargar_res
cb_borra cb_borra
st_6 st_6
cb_trae cb_trae
cb_traerec cb_traerec
pb_print pb_print
pb_print_reci pb_print_reci
pb_print_factu pb_print_factu
end type
type tp_4 from userobject within tab_1
end type
type pb_7 from picturebutton within tp_4
end type
type dw_tomas from datawindow within tp_4
end type
type pb_6 from picturebutton within tp_4
end type
type dw_lista3 from datawindow within tp_4
end type
type pb_5 from picturebutton within tp_4
end type
type tp_4 from userobject within tab_1
pb_7 pb_7
dw_tomas dw_tomas
pb_6 pb_6
dw_lista3 dw_lista3
pb_5 pb_5
end type
type tp_2 from userobject within tab_1
end type
type gb_2 from groupbox within tp_2
end type
type dw_campos from datawindow within tp_2
end type
type dw_lista1 from datawindow within tp_2
end type
type pb_1 from picturebutton within tp_2
end type
type dw_rescpo from datawindow within tp_2
end type
type pb_2 from picturebutton within tp_2
end type
type tab_2 from tab within tp_2
end type
type resul from userobject within tab_2
end type
type pb_insert from picturebutton within resul
end type
type pb_cerrar from picturebutton within resul
end type
type pb_save_resul from picturebutton within resul
end type
type dw_l from datawindow within resul
end type
type dw_res from datawindow within resul
end type
type dw_serving from datawindow within resul
end type
type resul from userobject within tab_2
pb_insert pb_insert
pb_cerrar pb_cerrar
pb_save_resul pb_save_resul
dw_l dw_l
dw_res dw_res
dw_serving dw_serving
end type
type procesa from userobject within tab_2
end type
type pb_sevn from picturebutton within procesa
end type
type pb_deln from picturebutton within procesa
end type
type pb_insn from picturebutton within procesa
end type
type dw_notas from datawindow within procesa
end type
type procesa from userobject within tab_2
pb_sevn pb_sevn
pb_deln pb_deln
pb_insn pb_insn
dw_notas dw_notas
end type
type tab_2 from tab within tp_2
resul resul
procesa procesa
end type
type tp_2 from userobject within tab_1
gb_2 gb_2
dw_campos dw_campos
dw_lista1 dw_lista1
pb_1 pb_1
dw_rescpo dw_rescpo
pb_2 pb_2
tab_2 tab_2
end type
type tp_3 from userobject within tab_1
end type
type pb_print_img from picturebutton within tp_3
end type
type dw_imagenes from datawindow within tp_3
end type
type pb_edit_imag from picturebutton within tp_3
end type
type pb_save_imag from picturebutton within tp_3
end type
type pb_del_imag from picturebutton within tp_3
end type
type st_cuantos from statictext within tp_3
end type
type pb_imag from picturebutton within tp_3
end type
type pb_3 from picturebutton within tp_3
end type
type dw_lista2 from datawindow within tp_3
end type
type pb_4 from picturebutton within tp_3
end type
type tp_3 from userobject within tab_1
pb_print_img pb_print_img
dw_imagenes dw_imagenes
pb_edit_imag pb_edit_imag
pb_save_imag pb_save_imag
pb_del_imag pb_del_imag
st_cuantos st_cuantos
pb_imag pb_imag
pb_3 pb_3
dw_lista2 dw_lista2
pb_4 pb_4
end type
type tab_1 from tab within w_apoyo_diag2
tp_1 tp_1
tp_4 tp_4
tp_2 tp_2
tp_3 tp_3
end type
type dw_mvto_cpo from datawindow within w_apoyo_diag2
end type
type dw_lote from datawindow within w_apoyo_diag2
end type
end forward

shared variables


end variables

global type w_apoyo_diag2 from window
integer width = 6245
integer height = 2440
boolean titlebar = true
string title = "Apoyo Diagnóstico"
boolean controlmenu = true
boolean maxbox = true
boolean resizable = true
windowtype windowtype = child!
windowstate windowstate = maximized!
long backcolor = 67108864
string icon = "ap_dx.ico"
dw_profe_valida dw_profe_valida
dw_lab dw_lab
dw_trae dw_trae
ddlb_archivos ddlb_archivos
dw_prof_resu dw_prof_resu
dw_his_acu dw_his_acu
dw_canasta dw_canasta
dw_sum_cab dw_sum_cab
pb_print_pend pb_print_pend
pb_buscar pb_buscar
st_2 st_2
dw_area dw_area
st_3 st_3
cb_revisar cb_revisar
cb_hosp cb_hosp
st_9 st_9
em_muestra em_muestra
em_fecha em_fecha
dw_cont_det dw_cont_det
pb_del pb_del
pb_newing pb_newing
dw_emp dw_emp
dw_hist dw_hist
dw_tip_ingres dw_tip_ingres
dw_historial dw_historial
gb_4 gb_4
tab_1 tab_1
dw_mvto_cpo dw_mvto_cpo
dw_lote dw_lote
end type
global w_apoyo_diag2 w_apoyo_diag2

type variables
string i_tipoing,i_codarea,i_clughis,i_cluging,i_nautoriza,i_cod_doc
string l_repositorios,i_alm,i_cdoc_cons='SC',i_emp,i_cont,int_cliente
boolean i_pideconf,i_print,i_cambio_insumo
long i_fila,i_contador,i_ningreso,i_nserving,i_nservadx,i_muestra,i_itemcpo,i_nrepor
string is_202
datawindowchild idw_area,idw_lista1,idw_profe,idw_lista2,idw_lista3
datetime i_fecha
int ntomas
transaction sqllab

end variables

forward prototypes
public function string f_revisa_planes ()
public function string f_valida_usuarios (string p_usu, string p_area)
public function integer f_borrar_resultados ()
public function integer f_abrir_reporte ()
public subroutine refres_lista ()
public function integer f_faltan ()
public subroutine cambia_est (datawindow p_dw, string p_new_est)
public function integer f_pregunta ()
public function integer new_ingre (string p_emp, string p_cont, long p_nsoat, string p_clug_soat)
public subroutine lf_titulo ()
public function integer f_insert_proc (string p_cod, string p_procequiv, string p_maneq, string p_emp, string p_cont, string p_plan, string p_autoriza, long p_nfact, string p_clugfac, integer p_nitemfac, long p_nreci, string p_clugrec, integer p_itemrec, integer p_nitemrec, long p_ncita, string p_clug_cita, integer p_nservcita, integer p_seccant, datetime p_fechacit, datetime p_horacit, long p_contador_os, string p_clug_os, integer p_norden, integer p_nitem_os, integer p_facturar, string p_tipofac, string p_obser, string p_estado)
public function integer f_crear_resultados (string p_clugarrep, string p_usuvalida, datetime p_fecvalida, string p_intfz)
end prototypes

public function string f_revisa_planes ();long j
for j= 1 to dw_cont_det.rowcount()
	if f_proc_plan(tab_1.tp_1.sle_1.text,dw_cont_det.getitemstring(j,"cplan")) then 
//		fila_cont_det=j
		return dw_cont_det.getitemstring(j,"cplan")
	end if
next
return ""
end function

public function string f_valida_usuarios (string p_usu, string p_area);long cuantos
SELECT Count(USUGRUPO.CODGRUPO) into :cuantos
FROM AreaAdxSeg INNER JOIN USUGRUPO ON AreaAdxSeg.CODGRUPO = USUGRUPO.CODGRUPO
WHERE AreaAdxSeg.CodAADX=:p_area AND USUGRUPO.usuario=:p_usu;
if sqlca.sqlcode=-1 then
	messagebox('Error leyendo Permisos',sqlca.sqlerrtext)
	return '!'
end if
if cuantos=0 then return '!'
return p_usu
end function

public function integer f_borrar_resultados ();long nfact,nrepor,fila,l_nserv,item,nnul
string cod_doc,snul
setnull(snul)
setnull(nnul)
setnull(nfact)
fila=tab_1.tp_1.dw_procs.getrow()
select nfactura into :nfact from serviciosingreso where clugar=:i_clughis and contador=:i_contador and nservicio=:i_nserving;
if not isnull(nfact) then
	messagebox("Error","Este procedimiento ya se encuentra facturado, no puede borrar sus resultados")
	return -1
end if
nrepor=tab_1.tp_1.dw_procs.getitemnumber(fila,"nrepor")
if isnull(nrepor) then return 0
if messagebox("Atención","Está seguro que desea borrar los resultados de este procedimiento",question!,yesno!,1)=2 then return -1
item=tab_1.tp_1.dw_procs.getitemnumber(fila,"item")
cod_doc=tab_1.tp_1.dw_procs.getitemstring(fila,"coddoc")

tab_1.tp_1.dw_procs.setitem(fila,"estado","1")
tab_1.tp_1.dw_procs.setitem(fila,"nrepor",nnul)
tab_1.tp_1.dw_procs.setitem(fila,"item",nnul)
tab_1.tp_1.dw_procs.setitem(fila,"clugar_res",snul)
tab_1.tp_1.dw_procs.setitem(fila,"coddoc",snul)
if tab_1.tp_1.dw_procs.update()=-1 then goto error

delete from resultadosval where coddoc=:cod_doc and nrepor=:nrepor and item=:item;
if sqlca.sqlcode=-1 then
	messagebox("Error borrando de Resultadosval",sqlca.sqlerrtext)
	goto error
end if
delete from resultadosimag where coddoc=:cod_doc and nrepor=:nrepor and item=:item;
if sqlca.sqlcode=-1 then
	messagebox("Error borrando de ResultadosImag",sqlca.sqlerrtext)
	goto error
end if
delete from resultadoscpo where coddoc=:cod_doc and nrepor=:nrepor and item=:item;
if sqlca.sqlcode=-1 then
	messagebox("Error borrando de ResultadosCpo",sqlca.sqlerrtext)
	goto error
end if
if i_tipoing<>'1' then
	long conta_os,norden,item_os
	string clug_os
	conta_os=tab_1.tp_1.dw_procs.getitemnumber(fila,'contador_os')
	clug_os=tab_1.tp_1.dw_procs.getitemstring(fila,'clugar_os')
	norden=tab_1.tp_1.dw_procs.getitemnumber(fila,'nsolicitud_os')
	item_os=tab_1.tp_1.dw_procs.getitemnumber(fila,'item_os')
	update oscuerpo set estado='1',suministrada = suministrada -1
	where contador=:conta_os and clugar=:clug_os and nsolicitud=:norden and item=:item_os;
	if sqlca.sqlcode=-1 then
		messagebox("Error actualizando oscuerpo",sqlca.sqlerrtext)
		goto error
	end if
end if
delete from serviciosingreso where contador=:i_contador and nservicio=:i_nserving and clugar=:i_clughis;
if sqlca.sqlcode=-1 then
	messagebox("Error borrando de ServiciosIngreso",sqlca.sqlerrtext)
	goto error
end if
commit;
tab_1.tp_1.dw_procs.triggerevent(rowfocuschanged!)
return 1
error:
rollback;
dw_hist.event p_rowfocuschanged()
return -1
end function

public function integer f_abrir_reporte ();long nrepor,fila
string cod_doc,estado
fila=tab_1.tp_1.dw_procs.getrow()
nrepor=tab_1.tp_1.dw_procs.getitemnumber(fila,"nrepor")
cod_doc=tab_1.tp_1.dw_procs.getitemstring(fila,"coddoc")
select estado into :estado from resultadoscab where coddoc=:cod_doc and nrepor=:nrepor;
if estado="2" then
	if messagebox("Atención","Está seguro que desa abrir este reporte para modificarlo ?",question!,yesno!,1)=2 then return -1
	update resultadoscab set estado='1' where coddoc=:cod_doc and nrepor=:nrepor;
	if sqlca.sqlcode=-1 then
		messagebox("Error actualizando estado de Resultadoscab",sqlca.sqlerrtext)
		rollback;
		return -1
	else
		commit;
		messagebox("Apertura de Reporte","El reporte fue abierto con éxito")
		return 1
	end if
else
	messagebox("Atención","Este Reporte no se encuentra cerrado")
	return 1
end if

end function

public subroutine refres_lista ();idw_lista1.retrieve(i_codarea,i_ningreso,i_cluging)
idw_lista1.scrolltorow(tab_1.tp_1.dw_procs.getrow())
idw_lista2.retrieve(i_codarea,i_ningreso,i_cluging)
idw_lista2.scrolltorow(tab_1.tp_1.dw_procs.getrow())
idw_lista3.retrieve(i_codarea,i_ningreso,i_cluging)
idw_lista3.scrolltorow(tab_1.tp_1.dw_procs.getrow())
end subroutine

public function integer f_faltan ();//revisa todos los campos de resultados por si faclta alguno
long filas,hay,i,cual,fila,semanas,dias
double cohortes,ldb_nulo
datetime fechas,fp_part
string ls_nulo

fila=tab_1.tp_1.dw_procs.getrow()
hay=tab_1.tp_2.tab_2.resul.dw_res.rowcount()
filas=tab_1.tp_2.dw_campos.rowcount()
if hay<filas then
	cohortes=f_valida_usuario_cohorte_materna(tipdoc, docu)
	if cohortes>0 then 
		Select fp_eco, sgp_eco, dgp_eco ,fp_part into :fechas,:semanas,:dias,:fp_part
		From pacientes_cohortes 
		Where (((tipodoc)=:tipdoc) AND ((documento)=:docu) AND ((id_cohorte_pac)=:cohortes)  AND ((pacientes_cohortes.fp_eco)<>:fechas));
	end if
	for i=1 to filas
		cual = tab_1.tp_2.tab_2.resul.dw_res.find("consecampo="+string(tab_1.tp_2.dw_campos.getitemnumber(i,'consecampo')),1,hay)
		if cual = 0 then
			cual=tab_1.tp_2.tab_2.resul.dw_res.insertrow(0)
			tab_1.tp_2.tab_2.resul.dw_res.setitem(cual,'consecampo',tab_1.tp_2.dw_campos.getitemnumber(i,'consecampo'))
			tab_1.tp_2.tab_2.resul.dw_res.setitem(cual,'codproced',tab_1.tp_1.dw_procs.getitemstring(fila,'codproced'))
			tab_1.tp_2.tab_2.resul.dw_res.setitem(cual,'nombrecampo',tab_1.tp_2.dw_campos.getitemstring(i,'nombrecampo'))
			tab_1.tp_2.tab_2.resul.dw_res.setitem(cual,'nivel',tab_1.tp_2.dw_campos.getitemnumber(i,'nivel'))
			tab_1.tp_2.tab_2.resul.dw_res.setitem(cual,'coddoc',i_cod_doc)
			tab_1.tp_2.tab_2.resul.dw_res.setitem(cual,'clugar',i_cluging)//i_clughis)
			tab_1.tp_2.tab_2.resul.dw_res.setitem(cual,'nrepor',i_nrepor)
			tab_1.tp_2.tab_2.resul.dw_res.setitem(cual,'item',i_itemcpo)
			tab_1.tp_2.tab_2.resul.dw_res.setitem(cual,'tipocampo',tab_1.tp_2.dw_campos.getitemstring(i,'tipocampo'))
			setnull(ls_nulo)
			setnull(ldb_nulo)
			
			if isnull(tab_1.tp_2.dw_campos.getitemstring(i,'moda1')) or tab_1.tp_2.dw_campos.getitemstring(i,'moda1')='' then
				tab_1.tp_2.tab_2.resul.dw_res.setitem(cual,'resultado1',ls_nulo)
			else
				tab_1.tp_2.tab_2.resul.dw_res.setitem(cual,'resultado1',tab_1.tp_2.dw_campos.getitemstring(i,'moda1'))
			end if
			
			if isnull(tab_1.tp_2.dw_campos.getitemstring(i,'moda2')) then
				tab_1.tp_2.tab_2.resul.dw_res.setitem(cual,'resultado2',ldb_nulo)
			else
				tab_1.tp_2.tab_2.resul.dw_res.setitem(cual,'resultado2',tab_1.tp_2.dw_campos.getitemnumber(i,'moda2'))
			end if
			
			if isnull(tab_1.tp_2.dw_campos.getitemString(i,'moda3')) or tab_1.tp_2.dw_campos.getitemString(i,'moda3')='' then
				tab_1.tp_2.tab_2.resul.dw_res.setitem(cual,'resultado3',ls_nulo)
			else
				tab_1.tp_2.tab_2.resul.dw_res.setitem(cual,'resultado3',tab_1.tp_2.dw_campos.getitemString(i,'moda3'))
			end if
			if isnull(tab_1.tp_2.dw_campos.getitemString(i,'moda4')) or tab_1.tp_2.dw_campos.getitemString(i,'moda4')='' then
				tab_1.tp_2.tab_2.resul.dw_res.setitem(cual,'resultado4',ls_nulo)
			else
				tab_1.tp_2.tab_2.resul.dw_res.setitem(cual,'resultado4',tab_1.tp_2.dw_campos.getitemString(i,'moda4'))
			end if
				
			if isnull(tab_1.tp_2.dw_campos.getitemString(i,'moda5')) or tab_1.tp_2.dw_campos.getitemString(i,'moda5')='' then
				if tab_1.tp_2.dw_campos.getitemstring(i,'tipocampo')='5' then
					tab_1.tp_2.tab_2.resul.dw_res.setitem(cual,'resultado5','0')
				else
					tab_1.tp_2.tab_2.resul.dw_res.setitem(cual,'resultado5',ls_nulo)
				end if
			else
				tab_1.tp_2.tab_2.resul.dw_res.setitem(cual,'resultado5',tab_1.tp_2.dw_campos.getitemString(i,'moda5'))
			end if
			
			if isnull(tab_1.tp_2.dw_campos.getitemString(i,'moda6')) or tab_1.tp_2.dw_campos.getitemString(i,'moda6')='' then
				if tab_1.tp_2.dw_campos.getitemstring(i,'tipocampo')='6' then
					tab_1.tp_2.tab_2.resul.dw_res.setitem(cual,'resultado6','0')
				else
					tab_1.tp_2.tab_2.resul.dw_res.setitem(cual,'resultado6',ls_nulo)
				end if
			else
				tab_1.tp_2.tab_2.resul.dw_res.setitem(cual,'resultado6',tab_1.tp_2.dw_campos.getitemString(i,'moda6'))
			end if
			
			tab_1.tp_2.tab_2.resul.dw_res.setitem(cual,'orden',tab_1.tp_2.dw_campos.getitemNumber(i,'orden'))
			tab_1.tp_2.tab_2.resul.dw_res.setitem(cual,'umedida',tab_1.tp_2.dw_campos.getitemstring(i,'umedida'))
			tab_1.tp_2.tab_2.resul.dw_res.setitem(cual,'indvalor',tab_1.tp_2.dw_campos.getitemstring(i,'indvalor'))
			tab_1.tp_2.tab_2.resul.dw_res.setitem(cual,'obligatorio',tab_1.tp_2.dw_campos.getitemstring(i,'obligatorio'))
			tab_1.tp_2.tab_2.resul.dw_res.setitem(cual,'formula',tab_1.tp_2.dw_campos.getitemstring(i,'formula'))
			tab_1.tp_2.tab_2.resul.dw_res.setitem(cual,'eco',tab_1.tp_2.dw_campos.getitemstring(i,'eco'))
			tab_1.tp_2.tab_2.resul.dw_res.setitem(cual,'edi',tab_1.tp_2.dw_campos.getitemstring(i,'edi'))
			tab_1.tp_2.tab_2.resul.dw_res.setitem(cual,'consecampo_cop',tab_1.tp_2.dw_campos.getitemnumber(i,'consecampo_cop'))
			
			if tab_1.tp_2.dw_campos.getitemstring(i,'eco')='1' then
				if date(fechas)<>date('01/01/1900') then 
					tab_1.tp_2.tab_2.resul.dw_res.setitem(cual,'fecha',fechas)
				else
					tab_1.tp_2.tab_2.resul.dw_res.setitem(cual,'fecha',today())
				end if
			end if
			if tab_1.tp_2.dw_campos.getitemstring(i,'eco')='2' then
				if not isnull(semanas) then 
					tab_1.tp_2.tab_2.resul.dw_res.setitem(cual,'resultado2',semanas)
				end if
			end if
			if tab_1.tp_2.dw_campos.getitemstring(i,'eco')='3' then
				if not isnull(dias) then 
					tab_1.tp_2.tab_2.resul.dw_res.setitem(cual,'resultado2',dias)
				end if
			end if		
			if tab_1.tp_2.dw_campos.getitemstring(i,'eco')='4' then
				if not isnull(dias) then 
					tab_1.tp_2.tab_2.resul.dw_res.setitem(cual,'resultado6',fp_part)
				end if
			end if					
		end if
	next
end if
tab_1.tp_2.tab_2.resul.dw_res.Sort()
if tab_1.tp_2.tab_2.resul.dw_res.rowcount()>0 then tab_1.tp_2.tab_2.resul.dw_res.event rowfocuschanging(1,1)
return 1
end function

public subroutine cambia_est (datawindow p_dw, string p_new_est);long j
for j=1 to p_dw.rowcount()
	p_dw.setitem(j,'estado',p_new_est)
next
end subroutine

public function integer f_pregunta ();if not i_cambio_insumo then return 0 //no continua
dw_canasta.setfilter('')
dw_canasta.filter()
if dw_canasta.rowcount()=0 then return 0
i_alm=f_alm_de_apoyodx(i_codarea)
choose case messagebox("Atención",'No ha guardado los insumos utilizados en el ingreso.Desea Guardarlos ahora?',question!,yesNo!,1)
	case 1
		if f_guarda_insumos(dw_sum_cab,dw_canasta,dw_mvto_cpo,dw_lote,i_cdoc_cons,i_clughis,i_alm,i_contador)=-1 then
			rollback;
			return 1
		else
			commit;
			dw_sum_cab.resetupdate()
			dw_canasta.resetupdate()
			dw_mvto_cpo.resetupdate()
			dw_lote.resetupdate()
			i_cambio_insumo=false
			return 0
		end if 
	case 2
		return 0
end choose

end function

public function integer new_ingre (string p_emp, string p_cont, long p_nsoat, string p_clug_soat);if not f_hasta() then 
	messagebox("Atención","Su periodo de validez ha caducado, comuníquese con GCI Ltda. para reactivarlo")
	return -1
end if
if not f_demo('pac') then return -1
////////////// ojo para que no metan goles ^

if docu="" or tipdoc="" then return -1
if dw_emp.rowcount()= 0 then
	Messagebox("Error","Este paciente no tiene empresa asignada, asignele una en la ficha del Paciente")
	return  -1
end if
if f_pregunta()=1 then return -1

if dw_hist.rowcount()>0 then
	if date(dw_hist.getitemdatetime(1,'fecha'))=today() then
		if messagebox('Atención','Está tratando de insertar un nuevo ingreso para la fecha de hoy. Desea continuar.?',question!,yesno!,1)=2 then return -1
	end if
end if
long donde
donde=dw_emp.find("codemp='"+p_emp+"' and codcontrato='"+p_cont+"'",1,dw_emp.rowcount())
if donde=0 then
	messagebox('Atención','El paciente ya no tiene la Empresa y Contrato con el que se facturó')
	return -1
else
	dw_emp.setrow(donde)
end if
if i_tipoing='1' then
	dw_historial.insertrow(1)
	dw_historial.setitem(1,"fecha",datetime(today(),time(string(now()))))
	dw_historial.setitem(1,"tipodoc",tipdoc)
	dw_historial.setitem(1,"documento",docu)
	dw_historial.setitem(1,"indapdx",'1')
	i_contador=f_trae_ndoc('HIS',clugar,'Historial')
	i_clughis=clugar
	dw_historial.setitem(1,"contador",i_contador)
	dw_historial.setitem(1,"clugar",i_clughis)
	dw_historial.setitem(1,"consec_soat",p_nsoat)
	dw_historial.setitem(1,"clugar_soat",p_clug_soat)
	if dw_historial.update()=-1 then
		dw_historial.deleterow(1)
		dw_historial.resetupdate()
		rollback;
		return -1
	end if
	//por nueva tabla para ligar ingresos al abrir cuenta en soat
	if not isnull(p_nsoat) then
		dw_his_acu.insertrow(1)
		dw_his_acu.setitem(1,"contador",i_contador)
		dw_his_acu.setitem(1,"clugar",i_clughis)
		dw_his_acu.setitem(1,"consec_soat",p_nsoat)
		dw_his_acu.setitem(1,"clugar_soat",p_clug_soat)
		if dw_his_acu.update()=-1 then
			dw_his_acu.deleterow(1)
			dw_his_acu.resetupdate()
			rollback;
			return -1
		end if
	end if
end if
long conta2
conta2=i_contador //porque cuando dw_hist.insertrow(1) contador pasa a null
dw_hist.insertrow(1)
dw_hist.setitem(1,'fecha',datetime(today(),time(string(now()))))
dw_hist.setitem(1,'clugar',clugar)
dw_hist.setitem(1,'usuario',usuario)
datetime ahora,ahora2
ahora=datetime(today(),time("00:00"))
ahora2=datetime(today(),time("23:59:59"))
long muestra
if em_muestra.enabled then
	SELECT Max(IngresoADX.Muestra) into :muestra
	FROM IngresoADX
	WHERE ingresoadx.fecha between :ahora and :ahora2;
	if sqlca.sqlcode=-1 then 
		messagebox("Error consulando muestras",sqlca.sqlerrtext)
		return -1
	end if
	if isnull(muestra) then muestra=0;
	muestra++
else
	setnull(muestra)
end if
long ningre
SELECT Max(NIngreso) into :ningre
FROM IngresoADX where clugar=:clugar and CodAADX=:i_codarea;
if isnull(ningre) then ningre=0;
ningre++
dw_hist.setitem(1,'muestra',muestra)
dw_hist.setitem(1,'codaadx',i_codarea)
dw_hist.setitem(1,'tipodoc',tipdoc)
dw_hist.setitem(1,'documento',docu)
dw_hist.setitem(1,'ningreso',ningre)
dw_hist.setitem(1,'contador',conta2)
dw_hist.setitem(1,'clugar_his',i_clughis)//si es de hosp/urg el contador y el clugar vienen de alla
dw_hist.setitem(1,'tipo_ingres',i_tipoing)
if dw_hist.update()<1 then
	rollback;
	triggerevent(open!)
	return -1
else
	commit;
	dw_hist.setrow(1)
	dw_hist.event p_rowfocuschanged()
	if isvalid(w_hist_gral) then w_hist_gral.triggerevent(open!)
	return 1
end if
end function

public subroutine lf_titulo ();select nombre into :g_descrip_usu from usuarios where usuario=:usuario;
title='Apoyo Diagnóstico :'+g_descrip_usu +'('+usuario+')'
end subroutine

public function integer f_insert_proc (string p_cod, string p_procequiv, string p_maneq, string p_emp, string p_cont, string p_plan, string p_autoriza, long p_nfact, string p_clugfac, integer p_nitemfac, long p_nreci, string p_clugrec, integer p_itemrec, integer p_nitemrec, long p_ncita, string p_clug_cita, integer p_nservcita, integer p_seccant, datetime p_fechacit, datetime p_horacit, long p_contador_os, string p_clug_os, integer p_norden, integer p_nitem_os, integer p_facturar, string p_tipofac, string p_obser, string p_estado);//parametros:
//	p_cod:cod_cups
//	procequiv
//	man_eq

//	empresa
//	contrato
//	plan
// autoriza

//	nfactura
//	clug_fac
//	item_fac

//	nreci
//	clug_rec
//	item_rec
//	nitem_rec

// ncita
// clugar_cita
// nserv_cita
// sec_cant_cit
// fecha_cit
// hora_cit

// conta_os
// clug_os
// norden
// nitem_os

//	facturar

//if i_clughis<>clugar then 
//	messagebox("Atención","No puede modificar los datos de este ingreso debido a que esta area de Apoyo diagnóstico pertenece al lugar:"+i_clughis)
//	return -1
//end if
long numgc,nro_tomas
setnull(numgc)

If p_estado='1' then
	SELECT GClinico.CodGC INTO :numgc
	FROM ((GClinico INNER JOIN ProcGClinico ON GClinico.CODGC = ProcGClinico.CODGC) INNER JOIN Proced ON ProcGClinico.CODPROCED = Proced.CODPROCED) INNER JOIN PM_CUPS_VERSION ON Proced.COD_VERSION = PM_CUPS_VERSION.COD_VERSION
	WHERE (((GClinico.CodAADX)=:i_codarea) AND ((ProcGClinico.CodProced)=:p_cod) AND ((Proced.estado)='1') AND ((getdate()) Between PM_CUPS_VERSION.VALIDO_INICIO And PM_CUPS_VERSION.VALIDO_HASTA));
	if isnull(numgc) then
		string ls_cod
		
		ls_cod=mid(p_cod,1,pos(p_cod,'_')-1)
		
		SELECT GClinico.CodGC,Proced.CODPROCED INTO :numgc,:p_cod
		FROM ((GClinico INNER JOIN ProcGClinico ON GClinico.CODGC = ProcGClinico.CODGC) INNER JOIN Proced ON ProcGClinico.CODPROCED = Proced.CODPROCED) INNER JOIN PM_CUPS_VERSION ON Proced.COD_VERSION = PM_CUPS_VERSION.COD_VERSION
		WHERE (((GClinico.CodAADX)=:i_codarea) AND ((proced.Cod_cups)=:ls_cod) AND ((Proced.estado)='1') AND ((getdate()) Between PM_CUPS_VERSION.VALIDO_INICIO And PM_CUPS_VERSION.VALIDO_HASTA));	
		if isnull(numgc) then
			messagebox("Atención","Este procedimiento no existe, no está activo o no pertenece a un grupo clínico del area")
			return -1
		end if
	end if
else
	SELECT GClinico.CodGC INTO :numgc
	FROM (GClinico INNER JOIN ProcGClinico ON GClinico.CODGC = ProcGClinico.CODGC) INNER JOIN Proced ON ProcGClinico.CODPROCED = Proced.CODPROCED
	WHERE (((GClinico.CodAADX)=:i_codarea) AND ((ProcGClinico.CodProced)=:p_cod) AND ((Proced.estado)='1'));
end if
if isnull(numgc) then
	messagebox("Atención","Este procedimiento no existe, no está activo o no pertenece a un grupo clínico del area")
	return -1
end if

string cod,descr,per_atiende, ria2 ,tipo_proc,cod_doc,cod_cups,cod_ver,ls_ririas
setnull(cod)
setnull(ntomas)
setnull(cod_cups)
setnull(cod_ver)
SELECT ProcGClinico.CodProced, Proced.Descripcion, Proced.Rips ,Proced.tipoproc ,coddoc ,ProcGClinico.nro_tomas,proced.cod_cups,proced.cod_version,proced.ririas
into :cod,:descr,:ria2,:tipo_proc , :cod_doc,:nro_tomas,:cod_cups,:cod_ver,:ls_ririas
FROM (ProcGClinico INNER JOIN Proced ON ProcGClinico.CODPROCED = Proced.CODPROCED) INNER JOIN PM_CUPS_VERSION ON Proced.COD_VERSION = PM_CUPS_VERSION.COD_VERSION
WHERE (((ProcGClinico.CodProced)=:p_cod) AND ((ProcGClinico.CodGC)=:numgc) AND ((getdate()) Between PM_CUPS_VERSION.VALIDO_INICIO And PM_CUPS_VERSION.VALIDO_HASTA));
if isnull(cod) or cod="" then
	messagebox("Atención","Procedimiento no pertenece a este grupo clínico o no existe")
else
	if isnull(ria2) then 
		messagebox("Error","Este procedimiento no tiene código de RIPS")
		return -1
	end if
	if isnull(p_emp) or p_emp='' then	setnull(p_emp)
	if isnull(p_cont) or p_cont='' then	setnull(p_cont)
	if isnull(p_plan) or p_plan='' then	setnull(p_plan)

	long fila,l,l_i
	for l=1 to tab_1.tp_1.dw_procs.rowcount()
		if tab_1.tp_1.dw_procs.find('nproced='+string(l),1,tab_1.tp_1.dw_procs.rowcount())=0 then exit
	next
	fila=tab_1.tp_1.dw_procs.insertrow(0)
	tab_1.tp_1.dw_procs.setitem(fila,"nproced",l)
	tab_1.tp_1.dw_procs.scrolltorow(fila)
	tab_1.tp_1.dw_procs.setitem(fila,"cod_version",cod_ver)
	tab_1.tp_1.dw_procs.setitem(fila,"cod_cups",cod_cups)
	tab_1.tp_1.dw_procs.setitem(fila,"codproced",cod)
	tab_1.tp_1.dw_procs.setitem(fila,"cemp",p_emp)
	tab_1.tp_1.dw_procs.setitem(fila,"ccontrato",p_cont)
	tab_1.tp_1.dw_procs.setitem(fila,"cplan",p_plan)
	tab_1.tp_1.dw_procs.setitem(fila,"descripcion",descr)
	tab_1.tp_1.dw_procs.setitem(fila,"ningreso",i_ningreso)
	tab_1.tp_1.dw_procs.setitem(fila,"clugar",i_cluging)
	tab_1.tp_1.dw_procs.setitem(fila,"codaadx",i_codarea)
	tab_1.tp_1.dw_procs.setitem(fila,"codgc",numgc)
	tab_1.tp_1.dw_procs.setitem(fila,"ria",ria2)
	tab_1.tp_1.dw_procs.setitem(fila,"TipoProc",tipo_proc)
	tab_1.tp_1.dw_procs.setitem(fila,"ncita",p_ncita)
	tab_1.tp_1.dw_procs.setitem(fila,"clugar_cita",p_clug_cita)
	tab_1.tp_1.dw_procs.setitem(fila,"sec_cant_cita",p_seccant)
	tab_1.tp_1.dw_procs.setitem(fila,"nservicio",p_nservcita)
	tab_1.tp_1.dw_procs.setitem(fila,"fecha",p_fechacit)
	tab_1.tp_1.dw_procs.setitem(fila,"hora",p_horacit)
	tab_1.tp_1.dw_procs.setitem(fila,"nfact",p_nfact)
	tab_1.tp_1.dw_procs.setitem(fila,"clugar_fac",p_clugfac)
	tab_1.tp_1.dw_procs.setitem(fila,"tipo_fac",p_tipofac)	
	tab_1.tp_1.dw_procs.setitem(fila,"nitem",p_nitemfac)
	tab_1.tp_1.dw_procs.setitem(fila,"nrcaj",p_nreci)
	tab_1.tp_1.dw_procs.setitem(fila,"clugar_rec",p_clugrec)
	tab_1.tp_1.dw_procs.setitem(fila,"cprocedeq",p_procequiv)
	tab_1.tp_1.dw_procs.setitem(fila,"cmanual",p_maneq)
	tab_1.tp_1.dw_procs.setitem(fila,"contador_os",p_contador_os)
	tab_1.tp_1.dw_procs.setitem(fila,"clugar_os",p_clug_os)
	tab_1.tp_1.dw_procs.setitem(fila,"nsolicitud_os",p_norden)
	tab_1.tp_1.dw_procs.setitem(fila,"item_os",p_nitem_os)
	tab_1.tp_1.dw_procs.setitem(fila,"facturar",p_facturar)
	tab_1.tp_1.dw_procs.setitem(fila,"observaciones",p_obser)
	tab_1.tp_1.dw_procs.setitem(fila,"nro_tomas",nro_tomas)
	tab_1.tp_1.dw_procs.setitem(fila,"ririas",ls_ririas)	

	if nro_tomas>1 then 
		for l_i = 1 to nro_tomas
			fila=tab_1.tp_4.dw_tomas.insertrow(0)
			tab_1.tp_4.dw_tomas.setitem(fila,"ningreso",i_ningreso)
			tab_1.tp_4.dw_tomas.setitem(fila,"nproced",l)
			tab_1.tp_4.dw_tomas.setitem(fila,"clugar",i_cluging)
			tab_1.tp_4.dw_tomas.setitem(fila,"codaadx",i_codarea)
			tab_1.tp_4.dw_tomas.setitem(fila,"item",l_i)
			if l_i=1 then 
				tab_1.tp_4.dw_tomas.setitem(fila,"fecha",dw_hist.getitemdatetime(dw_hist.getrow(),'fecha'))
			end if
			tab_1.tp_4.dw_tomas.setitem(fila,"usuario",usuario)
			tab_1.tp_4.dw_tomas.setitem(fila,"estado",'0')
		next
		tab_1.tp_4.enabled=true
		tab_1.tp_4.visible=true
	end if
	
	string coduf , codcc
	select cufuncional,cccosto into :coduf,:codcc from gclinico where codgc=:numgc;
	tab_1.tp_1.dw_procs.setitem(fila,"cufuncional",coduf)
	tab_1.tp_1.dw_procs.setitem(fila,"cccosto",codcc)
	if not isnull(p_nreci) then 
		update tesorecajcab set muestra=:i_muestra where nrcaj=:p_nreci and clugar=:p_clugrec;
		if sqlca.sqlcode= -1 then
			messagebox("Error actualizando número de muestra de recibo de caja",sqlca.sqlerrtext)
			tab_1.tp_1.dw_procs.deleterow(fila)
			tab_1.tp_1.dw_procs.resetupdate()
			return -1
		end if
	end if
	if not isnull(p_nfact) then 
		update factcab set muestra=:i_muestra where nfact=:p_nfact and clugar=:p_clugfac;
		if sqlca.sqlcode= -1 then
			messagebox("Error actualizando número de muestra de factura",sqlca.sqlerrtext)
			tab_1.tp_1.dw_procs.deleterow(fila)
			tab_1.tp_1.dw_procs.resetupdate()
			return -1
		end if
	end if
	tab_1.tp_1.dw_procs.setitem(fila,"items",p_itemrec)
	tab_1.tp_1.dw_procs.setitem(fila,"nitem_rec",p_nitemrec)
	if p_autoriza="" then setnull(p_autoriza)
	tab_1.tp_1.dw_procs.setitem(fila,"autorizacion",p_autoriza)
	if tab_1.tp_1.dw_procs.update()<1 then
		tab_1.tp_1.dw_procs.deleterow(fila)
		tab_1.tp_1.dw_procs.resetupdate()
		return -1
	else
		if tab_1.tp_4.dw_tomas.update()<1 then
			tab_1.tp_4.dw_tomas.resetupdate()
			return -1
		end if
		if not isnull(p_nreci) and not isnull(p_itemrec) and not isnull(p_nitemrec) then
			update tesoredetalle set servadx='1' where nrcaj=:p_nreci and clugar=:p_clugrec and items=:p_itemrec and nitem=:p_nitemrec;
			if sqlca.sqlcode=-1 then
				messagebox("Error actualizando estado de servadx en tesoredetalle",sqlca.sqlerrtext)
				tab_1.tp_1.dw_procs.deleterow(fila)
				tab_1.tp_1.dw_procs.resetupdate()
				return -1
			end if
		end if
		if not isnull(p_nfact) and not isnull(p_clugfac) and not isnull(p_nitemfac) then
			update factcpo set servadx='1' where nfact=:p_nfact and clugar=:p_clugfac and nitem=:p_nitemfac and tipo=:p_tipofac;
			if sqlca.sqlcode=-1 then
				messagebox("Error actualizando estado de servadx en factcpo",sqlca.sqlerrtext)
				tab_1.tp_1.dw_procs.deleterow(fila)
				tab_1.tp_1.dw_procs.resetupdate()
				return -1
			end if
		end if
	end if
end if
dw_emp.event rowfocuschanged(dw_emp.getrow())
return 1
end function

public function integer f_crear_resultados (string p_clugarrep, string p_usuvalida, datetime p_fecvalida, string p_intfz);long fila,n_campos,cod_grp
string estado,cod_proc,tip_impre
fila=tab_1.tp_1.dw_procs.getrow()
estado=tab_1.tp_1.dw_procs.getitemstring(fila,"estado")
i_nrepor=tab_1.tp_1.dw_procs.getitemnumber(fila,'nrepor')

cod_grp=tab_1.tp_1.dw_procs.getitemnumber(fila,"codgc")
cod_proc=tab_1.tp_1.dw_procs.getitemstring(fila,"codproced")
i_cod_doc=tab_1.tp_1.dw_procs.getitemstring(fila,"coddoc")
if p_clugarrep='SI' then 
	p_clugarrep=tab_1.tp_1.dw_procs.getitemstring(fila,"clugar")////ojoooooooooooooo
end if

if isnull(i_nrepor) then
	if tab_1.tp_2.dw_campos.retrieve(tab_1.tp_1.dw_procs.getitemnumber(fila,'codgc'),tab_1.tp_1.dw_procs.getitemstring(fila,'codproced'))=0 then
		Messagebox("Error","Este procedimiento no tiene configurado campos de resultados")
		return -1
	end if
	SELECT GClinico.TipoImpre, ProcGClinico.CodDoc
	into :tip_impre , :i_cod_doc
	FROM GClinico INNER JOIN ProcGClinico ON GClinico.CodGC = ProcGClinico.CodGC
	WHERE GClinico.CodGC=:cod_grp AND GClinico.CodAADX=:i_codarea AND ProcGClinico.CodProced=:cod_proc;
	if sqlca.sqlcode=-1 then
		messagebox('Error leyendo Tipo de Impresión',sqlca.sqlerrtext)
		return -1
	end if
	choose case tip_impre
		case "1"      ///// general por grupo clinico
			SELECT Max(ResultadosCab.NRepor) into :i_nrepor
			FROM ResultadosCab INNER JOIN ResultadosCpo ON (ResultadosCab.NRepor = ResultadosCpo.NRepor) AND (ResultadosCab.clugar = ResultadosCpo.clugar) AND (ResultadosCab.CodDoc = ResultadosCpo.CodDoc)
			WHERE (((ResultadosCab.clugar)=:p_clugarrep) AND ((ResultadosCab.CodDoc)=:i_cod_doc) AND ((ResultadosCab.NIngreso)=:i_ningreso) AND ((ResultadosCab.clugar_indx)=:p_clugarrep) AND ((ResultadosCab.CodAADX)=:i_codarea) AND ((ResultadosCab.Estado)='1') AND ((ResultadosCpo.CodGC)=:cod_grp));
	
		case "2"     ////// separado con formato propio
			SELECT Max(ResultadosCab.NRepor) into :i_nrepor
			FROM ResultadosCab INNER JOIN ResultadosCpo ON (ResultadosCab.clugar = ResultadosCpo.clugar) AND (ResultadosCab.NRepor = ResultadosCpo.NRepor) AND (ResultadosCab.CodDoc = ResultadosCpo.CodDoc)
			WHERE (((ResultadosCpo.CodProced)=:cod_proc) AND ((ResultadosCab.CodDoc)=:i_cod_doc) AND ((ResultadosCpo.clugar)=:p_clugarrep) AND ((ResultadosCab.NIngreso)=:i_ningreso) AND ((ResultadosCab.clugar_indx)=:i_clughis) AND ((ResultadosCab.CodAADX)=:i_codarea) AND ((ResultadosCab.Estado)='1'));
			
		case "3"		////  general por area
			SELECT Max(ResultadosCab.NRepor) into :i_nrepor
			FROM ResultadosCab
			WHERE (((ResultadosCab.CodDoc)=:i_cod_doc) AND ((ResultadosCab.clugar)=:p_clugarrep) AND ((ResultadosCab.NIngreso)=:i_ningreso) AND ((ResultadosCab.clugar_indx)=:p_clugarrep) AND ((ResultadosCab.CodAADX)=:i_codarea) AND ((ResultadosCab.Estado)='1'));
	end choose
	if sqlca.sqlcode=-1 then
		messagebox('Error leyendo ResultadosCab',sqlca.sqlerrtext)
		return -1
	end if
	if isnull(i_nrepor) then 
		i_nrepor=f_trae_ndoc(i_cod_doc,p_clugarrep,'Documento del area '+i_codarea)
		if i_nrepor=-1 then
			rollback;
			return -1
		end if

		INSERT INTO ResultadosCab ( CodDoc,clugar,nrepor,clugar_indx,CodAADX, NIngreso, TipoDoc, Documento, Fecha, Estado )
		values( :i_Cod_Doc,:p_clugarrep,:i_nrepor,:i_cluging, :i_codarea, :i_NIngreso, :tipdoc, :docu, :p_fecvalida, '1');
		if sqlca.sqlcode=-1 then
			messagebox("Error",SQLCA.sqlerrtext)
			rollback;
			return -1
		end if
	end if
else
	tab_1.tp_2.dw_campos.retrieve(tab_1.tp_1.dw_procs.getitemnumber(fila,'codgc'),tab_1.tp_1.dw_procs.getitemstring(fila,'codproced'))
end if
////////////////////
if tab_1.tp_2.tab_2.resul.dw_serving.retrieve(i_contador,i_clughis,i_nserving)=0 then
	if tab_1.tp_2.tab_2.resul.dw_serving.event insertar()=-1 then
		rollback;
		return -1
	end if
else
	i_nserving=tab_1.tp_2.tab_2.resul.dw_serving.getitemnumber(1,"nservicio")
end if
if tab_1.tp_2.dw_rescpo.retrieve(tab_1.tp_1.dw_procs.getitemstring(fila,'coddoc'),tab_1.tp_1.dw_procs.getitemnumber(fila,'nrepor'),tab_1.tp_1.dw_procs.getitemnumber(fila,'item'),tab_1.tp_1.dw_procs.getitemstring(fila,'clugar'))=0 then
	if tab_1.tp_2.dw_rescpo.event insertar(p_clugarrep,p_usuvalida,p_fecvalida,p_intfz)=-1 then
		rollback;
		return -1
	end if
	tab_1.tp_1.dw_procs.setitem(fila,"estado","5")
	tab_1.tp_1.dw_procs.setitem(fila,"coddoc",i_Cod_Doc)
	tab_1.tp_1.dw_procs.setitem(fila,"clugar_res",p_clugarrep)
	tab_1.tp_1.dw_procs.setitem(fila,'nrepor',i_nrepor)
	tab_1.tp_1.dw_procs.setitem(fila,"item",i_itemcpo)
	if tab_1.tp_1.dw_procs.update()=-1 then
		messagebox("Error","Error actualizando estado de examen")
		rollback;
		return -1
	else
		commit;
	end if
else
	if p_clugarrep='SI' then 
		if isnull(tab_1.tp_2.dw_rescpo.getitemstring(1,'profesional')) then tab_1.tp_2.dw_rescpo.setitem(1,'profesional',g_profe)
	end if
	i_itemcpo=tab_1.tp_2.dw_rescpo.getitemnumber(1,'item')
end if
tab_1.tp_1.dw_procs.setitem(fila,'nserving',i_nserving)
tab_1.tp_2.tab_2.resul.dw_res.retrieve(tab_1.tp_1.dw_procs.getitemstring(fila,'coddoc'),tab_1.tp_1.dw_procs.getitemnumber(fila,'nrepor'),tab_1.tp_1.dw_procs.getitemnumber(fila,'item'),tab_1.tp_1.dw_procs.getitemstring(fila,'codproced'),tab_1.tp_1.dw_procs.getitemstring(fila,'clugar'))


f_faltan()
return 1
end function

on w_apoyo_diag2.create
this.dw_profe_valida=create dw_profe_valida
this.dw_lab=create dw_lab
this.dw_trae=create dw_trae
this.ddlb_archivos=create ddlb_archivos
this.dw_prof_resu=create dw_prof_resu
this.dw_his_acu=create dw_his_acu
this.dw_canasta=create dw_canasta
this.dw_sum_cab=create dw_sum_cab
this.pb_print_pend=create pb_print_pend
this.pb_buscar=create pb_buscar
this.st_2=create st_2
this.dw_area=create dw_area
this.st_3=create st_3
this.cb_revisar=create cb_revisar
this.cb_hosp=create cb_hosp
this.st_9=create st_9
this.em_muestra=create em_muestra
this.em_fecha=create em_fecha
this.dw_cont_det=create dw_cont_det
this.pb_del=create pb_del
this.pb_newing=create pb_newing
this.dw_emp=create dw_emp
this.dw_hist=create dw_hist
this.dw_tip_ingres=create dw_tip_ingres
this.dw_historial=create dw_historial
this.gb_4=create gb_4
this.tab_1=create tab_1
this.dw_mvto_cpo=create dw_mvto_cpo
this.dw_lote=create dw_lote
this.Control[]={this.dw_profe_valida,&
this.dw_lab,&
this.dw_trae,&
this.ddlb_archivos,&
this.dw_prof_resu,&
this.dw_his_acu,&
this.dw_canasta,&
this.dw_sum_cab,&
this.pb_print_pend,&
this.pb_buscar,&
this.st_2,&
this.dw_area,&
this.st_3,&
this.cb_revisar,&
this.cb_hosp,&
this.st_9,&
this.em_muestra,&
this.em_fecha,&
this.dw_cont_det,&
this.pb_del,&
this.pb_newing,&
this.dw_emp,&
this.dw_hist,&
this.dw_tip_ingres,&
this.dw_historial,&
this.gb_4,&
this.tab_1,&
this.dw_mvto_cpo,&
this.dw_lote}
end on

on w_apoyo_diag2.destroy
destroy(this.dw_profe_valida)
destroy(this.dw_lab)
destroy(this.dw_trae)
destroy(this.ddlb_archivos)
destroy(this.dw_prof_resu)
destroy(this.dw_his_acu)
destroy(this.dw_canasta)
destroy(this.dw_sum_cab)
destroy(this.pb_print_pend)
destroy(this.pb_buscar)
destroy(this.st_2)
destroy(this.dw_area)
destroy(this.st_3)
destroy(this.cb_revisar)
destroy(this.cb_hosp)
destroy(this.st_9)
destroy(this.em_muestra)
destroy(this.em_fecha)
destroy(this.dw_cont_det)
destroy(this.pb_del)
destroy(this.pb_newing)
destroy(this.dw_emp)
destroy(this.dw_hist)
destroy(this.dw_tip_ingres)
destroy(this.dw_historial)
destroy(this.gb_4)
destroy(this.tab_1)
destroy(this.dw_mvto_cpo)
destroy(this.dw_lote)
end on

event open;dw_emp.reset()
dw_emp.retrieve(tipdoc,docu)
i_pideconf=true
string area_default

ddlb_archivos.DirList ("C:\windows\temp\*.jpg",0)
Integer index
For index=1 To ddlb_archivos.totalItems ( )
     FileDelete ( ddlb_archivos.text(index))
Next

lf_titulo()
if isnull(dw_area.getitemstring(1,1)) then
	if ls_pro=32 THEN	 RegistryGet ("HKEY_LOCAL_MACHINE\SOFTWARE\GCI\", "AREAAPDX", Regstring!, area_default)
	if ls_pro=64 THEN	RegistryGet ("HKEY_CURRENT_USER\SOFTWARE\GCI\", "AREAAPDX", Regstring!, area_default)
	if f_valida_usuarios(usuario,area_default)='!' then return
	dw_area.setitem(1,1,area_default)
	if dw_area.event itemchanged(1,dw_area.object.codaadx,area_default)<>0 then
		close(this)
		return
	end if
else
	if dw_area.event itemchanged(1,dw_area.object.codaadx,dw_area.getitemstring(1,1))<>0 then 
		close(this)
		return
	end if				
end if

SELECT cadena into :l_repositorios
FROM parametros_gen
WHERE (((codigo_para)=27));
if sqlca.sqlnrows=0 then
	messagebox('Atencíon','No hay parametro 27')
	return
end if

if isnull(l_repositorios) then
	messagebox('Atencíon','No hay Repositorio para Almacenamiento')
	return
end if
string ls_int

SELECT cadena into :ls_int
FROM parametros_gen
WHERE (((codigo_para)=65));
if sqlca.sqlnrows=0 then
	messagebox('Atencíon','No hay parametro 65')
	return
end if

SELECT cadena into :is_202
FROM parametros_gen
WHERE (((codigo_para)=81));
if sqlca.sqlnrows=0 then
	messagebox('Atencíon','No hay parametro 81')
	return
end if

if ls_int='1' or idw_area.getitemstring(idw_area.getrow(),'interfaz')='0' then
	tab_1.tp_1.pb_8.visible=false
end if
end event

event timer;timer(0)
if i_fila=dw_hist.getrow() then return
dw_hist.event p_rowfocuschanged()

end event

event closequery;ddlb_archivos.DirList ("C:\windows\temp\*.jpg",0)
Integer index
For index=1 To ddlb_archivos.totalItems ( )
     FileDelete ( ddlb_archivos.text(index))
Next
return f_pregunta()
disconnect using sqllab;

end event

event resize;tab_1.resize(newwidth - 50 , newheight - 770)
tab_1.tp_1.dw_procs.height=  tab_1.height -650
tab_1.tp_1.pb_save_insumo.y= tab_1.height -300
tab_1.tp_1.pb_cargar_res.y=tab_1.height -300
tab_1.tp_1.cb_borra.y=tab_1.height -300
tab_1.tp_1.pb_print.y=tab_1.height -300
tab_1.tp_1.pb_8.y=tab_1.height -300
tab_1.tp_1.st_5.y=tab_1.height -300
tab_1.tp_1.hpb_1.y=tab_1.height -300
tab_1.tp_1.st_5.y=tab_1.height -320
tab_1.tp_1.dp_1.y=tab_1.height -320
tab_1.tp_1.st_7.y=tab_1.height -220
tab_1.tp_1.dp_2.y=tab_1.height -220

tab_1.tp_2.tab_2.width=tab_1.width - 50
tab_1.tp_2.tab_2.height=tab_1.height - 270

tab_1.tp_2.tab_2.resul.dw_res.height=tab_1.tp_2.tab_2.height - 450

tab_1.tp_2.tab_2.procesa.dw_notas.width=tab_1.tp_2.tab_2.width - 450
tab_1.tp_2.tab_2.procesa.dw_notas.height=tab_1.tp_2.tab_2.height - 100

tab_1.tp_3.width=tab_1.width - 50
tab_1.tp_3.height=tab_1.height - 170

tab_1.tp_3.dw_imagenes.height=tab_1.tp_3.height - 170

tab_1.tp_2.tab_2.procesa.pb_insn.x=tab_1.tp_2.tab_2.procesa.dw_notas.width + 100
tab_1.tp_2.tab_2.procesa.pb_deln.x=tab_1.tp_2.tab_2.procesa.dw_notas.width + 100
tab_1.tp_2.tab_2.procesa.pb_sevn.x=tab_1.tp_2.tab_2.procesa.dw_notas.width + 100
end event

type dw_profe_valida from datawindow within w_apoyo_diag2
boolean visible = false
integer x = 3026
integer y = 84
integer width = 302
integer height = 44
integer taborder = 80
string title = "none"
string dataobject = "dw_profe_valida_interfaz_quimberlab"
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

type dw_lab from datawindow within w_apoyo_diag2
boolean visible = false
integer x = 3383
integer y = 20
integer width = 82
integer height = 64
integer taborder = 150
string title = "none"
string dataobject = "dw_lab_integra"
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

type dw_trae from datawindow within w_apoyo_diag2
boolean visible = false
integer x = 3090
integer y = 16
integer width = 215
integer height = 56
integer taborder = 60
string title = "none"
string dataobject = "dw_trae_resul_equipo"
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

type ddlb_archivos from listbox within w_apoyo_diag2
boolean visible = false
integer x = 1897
integer y = 2316
integer width = 480
integer height = 56
integer taborder = 50
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 15793151
borderstyle borderstyle = stylelowered!
end type

type dw_prof_resu from datawindow within w_apoyo_diag2
boolean visible = false
integer x = 1449
integer y = 2316
integer width = 402
integer height = 96
integer taborder = 40
string title = "none"
string dataobject = "dw_profe_resultados"
boolean resizable = true
boolean livescroll = true
end type

event constructor;settransobject(SQLCA)
end event

type dw_his_acu from datawindow within w_apoyo_diag2
boolean visible = false
integer x = 489
integer y = 2364
integer width = 448
integer height = 92
integer taborder = 30
boolean bringtotop = true
string title = "none"
string dataobject = "dw_historial_acumcab"
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;dw_his_acu.settransobject(SQLCA)
end event

type dw_canasta from datawindow within w_apoyo_diag2
string tag = "tabla: serving_insumo"
boolean visible = false
integer x = 1449
integer y = 64
integer width = 279
integer height = 52
integer taborder = 110
string title = "none"
string dataobject = "dw_insum_cext"
boolean hscrollbar = true
boolean vscrollbar = true
boolean resizable = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;settransobject(sqlca)
end event

event dberror;return f_dw_error(sqldbcode,sqlerrtext,sqlsyntax,dataobject)
end event

type dw_sum_cab from datawindow within w_apoyo_diag2
string tag = "tabla: sum_mvto_cab"
boolean visible = false
integer x = 2107
integer y = 88
integer width = 183
integer height = 36
integer taborder = 90
string title = "none"
string dataobject = "dw_sum_mvto_cab_insumos"
boolean hscrollbar = true
boolean vscrollbar = true
boolean resizable = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;settransobject(sqlca)
end event

event dberror;return f_dw_error(sqldbcode,sqlerrtext,sqlsyntax,dataobject)
end event

type pb_print_pend from picturebutton within w_apoyo_diag2
integer x = 3680
integer y = 16
integer width = 96
integer height = 80
integer taborder = 50
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string picturename = "print.gif"
alignment htextalign = left!
string powertiptext = "Imprimir Resulados Pendientes de impresión"
end type

event clicked;if isnull(dw_area.getitemstring(1,1)) or isnull(dw_tip_ingres.getitemstring(1,1)) then return
openwithparm(w_print_apdx,dw_area.getitemstring(1,1))
end event

type pb_buscar from picturebutton within w_apoyo_diag2
integer x = 1271
integer width = 146
integer height = 128
integer taborder = 60
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
boolean originalsize = true
string picturename = "buscar2.gif"
string disabledname = "d_buscar2.gif"
alignment htextalign = left!
string powertiptext = "Revisar Historial y Pendientes por Area"
end type

event clicked;if isnull(dw_area.getitemstring(1,1)) then return
openwithparm(w_trab_labo,dw_area.getitemstring(1,1))
end event

type st_2 from statictext within w_apoyo_diag2
integer x = 3826
integer y = 20
integer width = 398
integer height = 56
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Buscar X Muestra"
boolean focusrectangle = false
end type

type dw_area from datawindow within w_apoyo_diag2
integer y = 16
integer width = 1184
integer height = 76
integer taborder = 10
string title = "none"
string dataobject = "dw_areagral"
boolean border = false
boolean livescroll = true
end type

event constructor;settransobject(sqlca)
getchild('codaadx',idw_area)
idw_area.settransobject(sqlca)
idw_area.retrieve()
insertrow(1)
end event

event itemchanged;if isnull(data) then
	dw_hist.reset()
else
	if f_pregunta()=1 then 
		settext(getitemstring(1,1))
		setitem(1,1,getitemstring(1,1))
		return 2
	end if
end if
if data<>getitemstring(1,1) or (data<>'' and isnull(getitemstring(1,1))) then // si es igual no es necesario (lo mandó open())
	if f_valida_usuarios(usuario,data)='!' then
		open(w_conecta_evol)
		if message.stringparm='!' then 
			setitem(1,1,getitemstring(1,1))
			settext(getitemstring(1,1))
			return 1
		end if
		if f_valida_usuarios(message.stringparm,data)='!' then
			setitem(1,1,getitemstring(1,1))
			settext(getitemstring(1,1))
			return 1
		end if
		usuario=message.stringparm
		lf_titulo()
		f_poblar_menus()
		string tt
		SELECT Min(Profe.CodProf) into :tt FROM Profe WHERE Profe.usuario=:usuario;
		if not isnull(tt) and tt<>'' and tt<>g_profe then g_profe=tt
	end if
end if

i_alm=idw_area.getitemstring(idw_area.getrow(),'codalmacen')
if i_alm='' or isnull(i_alm) then
	settext(getitemstring(1,1))
	setitem(1,1,getitemstring(1,1))
	messagebox('Atención','No ha configurado almacen para el Area de Apoyo Diagnóstico')
	return -1
end if
i_codarea=data

if idw_area.getitemstring(idw_area.getrow(),'muestra')='1' then 
	em_muestra.enabled=true
	em_fecha.enabled=true
else
	em_muestra.enabled=false
	em_fecha.enabled=false
end if
if isnull(idw_area.getitemstring(idw_area.getrow(),'codesp')) then
	idw_profe.reset()
	messagebox("Atención",'Esta área de apoyo diagnóstico no tiene configurada una especialidad debe agregarsela para poder capturar resultados')
else
	idw_profe.retrieve(idw_area.getitemstring(idw_area.getrow(),'codesp'))
end if
dw_tip_ingres.event itemchanged(1,dw_tip_ingres.object.codtingre,dw_tip_ingres.getitemstring(1,1))
end event

type st_3 from statictext within w_apoyo_diag2
integer x = 14
integer y = 96
integer width = 544
integer height = 52
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Empresas del Paciente:"
boolean focusrectangle = false
end type

type cb_revisar from picturebutton within w_apoyo_diag2
event mousemove pbm_mousemove
integer x = 3488
integer y = 392
integer width = 146
integer height = 128
integer taborder = 140
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean enabled = false
string text = "            "
string picturename = "buscar.GIF"
string disabledname = "d_buscar.gif"
alignment htextalign = left!
string powertiptext = "Revisar pacientes con Pruebas pendientes (Hosp/Urg)"
end type

event clicked;if not f_hasta() then 
	messagebox("Atención","Su periodo de validez ha caducado, comuníquese con GCI Ltda. para reactivarlo")
	return
end if
////////////// ojo para que no metan goles ^
openwithparm(w_paci_sinapdx2,'apoyo')

end event

type cb_hosp from picturebutton within w_apoyo_diag2
event mousemove pbm_mousemove
integer x = 3488
integer y = 516
integer width = 146
integer height = 128
integer taborder = 150
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean enabled = false
string text = "            "
boolean originalsize = true
string picturename = "LLEVAR.GIF"
string disabledname = "d_llevar.gif"
alignment htextalign = left!
string powertiptext = "Atender Servicios de Hosp/Urg"
end type

event clicked;if not f_hasta() then 
	messagebox("Atención","Su periodo de validez ha caducado, comuníquese con GCI Ltda. para reactivarlo")
	return
end if
////////////// ojo para que no metan goles ^

if docu="" or tipdoc="" then return
if dw_emp.rowcount()= 0 then
	Messagebox("Error","Este paciente no tiene empresa asignada, asignele una en la ficha del Paciente")
	return
end if
open(w_os_apdx)
refres_lista()

end event

type st_9 from statictext within w_apoyo_diag2
integer x = 1431
integer y = 12
integer width = 370
integer height = 56
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Tipo de Ingreso:"
boolean focusrectangle = false
end type

type em_muestra from editmask within w_apoyo_diag2
integer x = 4645
integer y = 16
integer width = 315
integer height = 76
integer taborder = 40
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 16777215
boolean enabled = false
string text = "none"
borderstyle borderstyle = stylelowered!
string mask = "######"
end type

event modified;if text="" then return
if f_pregunta()=1 then return 2
datetime fecha_m1,fecha_m2
long n_muestra,donde
string t_doc,doc
fecha_m1=datetime(date(em_fecha.text),time("00:00:00"))
fecha_m2=datetime(date(em_fecha.text),time("23:59:59"))
n_muestra=long(text)
setnull(doc)
SELECT IngresoADX.TipoDoc, IngresoADX.Documento , tipo_ingres into :t_doc , :doc ,:i_tipoing
FROM IngresoADX
WHERE (((IngresoADX.Fecha) Between :fecha_m1 And :fecha_m2) AND ((IngresoADX.Muestra)=:n_muestra)) and CodAADX=:i_codarea and ((IngresoADX.clugar)=:clugar);
if isnull(doc) then
	messagebox("Atención","Este número de muestra no fué encontrado para esta fecha")
	return
end if
dw_tip_ingres.setitem(1,1,i_tipoing)
dw_tip_ingres.event itemchanged(1,dw_tip_ingres.object.codtingre,i_tipoing)
if tipdoc<>t_doc or docu<>doc  then
	w_principal.dw_1.setitem(1,1,t_doc)
	w_principal.dw_1.setitem(1,2,doc)
	w_principal.dw_1.setcolumn(2)
	w_principal.dw_1.triggerevent(itemchanged!)
end if
donde=dw_hist.find("fecha >= datetime('"+string(fecha_m1,"dd/mm/yyyy hh:mm:ss")+"') and fecha <= datetime('"+string(fecha_m2,"dd/mm/yyyy hh:mm:ss")+"') and muestra="+text,1,dw_hist.rowcount())
dw_hist.scrolltorow(donde)
end event

type em_fecha from editmask within w_apoyo_diag2
integer x = 4238
integer y = 16
integer width = 384
integer height = 76
integer taborder = 30
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 16777215
boolean enabled = false
string text = "none"
borderstyle borderstyle = stylelowered!
maskdatatype maskdatatype = datemask!
string mask = "dd/mm/yyyy"
boolean spin = true
end type

event constructor;this.text=string(today(),"dd/mm/yyyy")
end event

event modified;em_muestra.text=""
end event

type dw_cont_det from datawindow within w_apoyo_diag2
boolean visible = false
integer x = 23
integer y = 2352
integer width = 466
integer height = 116
boolean bringtotop = true
boolean enabled = false
string title = "none"
string dataobject = "dw_cont_deta"
boolean hscrollbar = true
boolean vscrollbar = true
boolean resizable = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;this.settransobject(sqlca)
end event

type pb_del from picturebutton within w_apoyo_diag2
event mousemove pbm_mousemove
integer x = 3488
integer y = 264
integer width = 146
integer height = 128
integer taborder = 120
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
string text = "            &x"
boolean originalsize = true
string picturename = "borrar_fila.GIF"
string disabledname = "d_borrar_fila.gif"
alignment htextalign = left!
string powertiptext = "Borrar Ingreso [Alt+X]"
end type

event clicked;long contador
string clug
clug=i_clughis
contador=i_contador
dw_hist.deleterow(0)
if dw_hist.update()<1 then
	rollback;
	parent.triggerevent(open!)
else
	DELETE 	FROM ACUMCAB_HISTORIAL
	WHERE (ACUMCAB_HISTORIAL.CONTADOR=:contador ) AND (ACUMCAB_HISTORIAL.CLUGAR=:clug);
	if SQLCA.sqlcode =-1 then
		Messagebox("Error",SQLCA.sqlerrtext)
		rollback;
		parent.triggerevent(open!)
	end if
	delete from historial where contador= :contador and clugar=:clug;
	if SQLCA.sqlcode =-1 then
		Messagebox("Error",SQLCA.sqlerrtext)
		rollback;
		parent.triggerevent(open!)
	else
		commit;
		i_fila=0
		dw_hist.event rowfocuschanged(dw_hist.getrow())
	end if
end if
end event

type pb_newing from picturebutton within w_apoyo_diag2
event mousemove pbm_mousemove
integer x = 3488
integer y = 136
integer width = 146
integer height = 128
integer taborder = 100
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
string text = "            &i"
boolean originalsize = true
string picturename = "insertar.GIF"
string disabledname = "d_insertar.gif"
alignment htextalign = left!
string powertiptext = "Nuevo Ingreso [Alt+I]"
end type

event clicked;if not f_hasta() then 
	messagebox("Atención","Su periodo de validez ha caducado, comuníquese con GCI Ltda. para reactivarlo")
	return -1
end if
if not f_demo('pac') then return -1
////////////// ojo para que no metan goles ^
if w_principal.dw_1.getitemstring(1,'estado')='1' then
  messagebox("Atención","Este Paciente esta Fallecido no puede adicionar servicios")
  return
end if
if docu="" or tipdoc="" then return -1
long consec_soat
string clugar_soat
setnull(consec_soat)
setnull(clugar_soat)
if i_emp="" then
	if dw_emp.rowcount()= 0 then
		Messagebox("Error","Este paciente no tiene empresa asignada, asignele una en la ficha del Paciente")
		return  -1
	end if
	if f_pregunta()=1 then return
	
	if dw_hist.rowcount()>0 then
		if date(dw_hist.getitemdatetime(1,'fecha'))=today() then
			if messagebox('Atención','Está tratando de insertar un nuevo ingreso para la fecha de hoy. Desea continuar.?',question!,yesno!,1)=2 then return -1
		end if
	end if


	st_soat st
	if dw_emp.getitemstring(dw_emp.getrow(),'soat')='1' and not isvalid(w_lleva_factu_apdx) then
		if not isnull(i_contador) then
			select consec_soat,clugar_soat into :consec_soat,:clugar_soat from historial where contador=:i_contador and clugar=:i_clughis;
		end if
		if isnull(consec_soat) then
			st.nsoat=consec_soat
			st.newemp=dw_emp.getitemstring(dw_emp.getrow(),"codemp")
			st.newcont=dw_emp.getitemstring(dw_emp.getrow(),"codcontrato")
			st.contador=i_contador
			st.clug_his=i_clughis
			openwithparm(w_soat,st)
			if message.stringparm="!" or not isvalid(message.powerobjectparm) then return -1
			st=message.powerobjectparm
			clugar_soat=st.clug_soat
			consec_soat=st.nsoat
		end if
	end if
end if
if i_tipoing='1' then
	dw_historial.insertrow(1)
	dw_historial.setitem(1,"fecha",datetime(today(),time(string(now()))))
	dw_historial.setitem(1,"tipodoc",tipdoc)
	dw_historial.setitem(1,"documento",docu)
	dw_historial.setitem(1,"indapdx",'1')
	i_contador=f_trae_ndoc('HIS',clugar,'Historial')
	i_clughis=clugar
	dw_historial.setitem(1,"contador",i_contador)
	dw_historial.setitem(1,"clugar",i_clughis)
	dw_historial.setitem(1,"consec_soat",consec_soat)
	dw_historial.setitem(1,"clugar_soat",clugar_soat)
	if dw_historial.update()=-1 then
		dw_historial.deleterow(1)
		dw_historial.resetupdate()
		rollback;
		return -1
	end if
	//por nueva tabla para ligar ingresos al abrir cuenta en soat
	if not isnull(consec_soat) then
		dw_his_acu.insertrow(1)
		dw_his_acu.setitem(1,"contador",i_contador)
		dw_his_acu.setitem(1,"clugar",i_clughis)
		dw_his_acu.setitem(1,"consec_soat",consec_soat)
		dw_his_acu.setitem(1,"clugar_soat",clugar_soat)
		if dw_his_acu.update()=-1 then
			dw_his_acu.deleterow(1)
			dw_his_acu.resetupdate()
			rollback;
			return -1
		end if
	end if
end if
long conta2
conta2=i_contador //porque cuando dw_hist.insertrow(1) contador pasa a null
dw_hist.insertrow(1)
dw_hist.setitem(1,'fecha',datetime(today(),time(string(now()))))
dw_hist.setitem(1,'clugar',clugar)
dw_hist.setitem(1,'usuario',usuario)
datetime ahora,ahora2
ahora=datetime(today(),time("00:00"))
ahora2=datetime(today(),time("23:59:59"))
long muestra
if em_muestra.enabled then
	SELECT Max(IngresoADX.Muestra) into :muestra
	FROM IngresoADX
	WHERE ingresoadx.fecha between :ahora and :ahora2 and CodAADX=:i_codarea;
	if sqlca.sqlcode=-1 then 
		messagebox("Error consulando muestras",sqlca.sqlerrtext)
		return -1
	end if
	if isnull(muestra) then muestra=0;
	muestra++
else
	setnull(muestra)
end if
long ningre
SELECT Max(NIngreso) into :ningre
FROM IngresoADX where clugar=:clugar and CodAADX=:i_codarea;
if isnull(ningre) then ningre=0;
ningre++
dw_hist.setitem(1,'muestra',muestra)
dw_hist.setitem(1,'codaadx',i_codarea)
dw_hist.setitem(1,'tipodoc',tipdoc)
dw_hist.setitem(1,'documento',docu)
dw_hist.setitem(1,'ningreso',ningre)
dw_hist.setitem(1,'contador',conta2)
dw_hist.setitem(1,'clugar_his',i_clughis)//si es de hosp/urg el contador y el clugar vienen de alla
dw_hist.setitem(1,'tipo_ingres',i_tipoing)
if dw_hist.update()<1 then
	rollback;
	parent.triggerevent(open!)
	return -1
else
	commit;
	dw_hist.setrow(1)
	dw_hist.event p_rowfocuschanged()
	if isvalid(w_hist_gral) then w_hist_gral.triggerevent(open!)
	return 1
end if
end event

type dw_emp from datawindow within w_apoyo_diag2
integer x = 14
integer y = 152
integer width = 3401
integer height = 512
integer taborder = 80
string title = "none"
string dataobject = "dw_empacguarda"
boolean hscrollbar = true
boolean vscrollbar = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event rowfocuschanged;long fila
string ls_int
fila=getrow()
if fila<1 then return
dw_cont_det.retrieve(getitemstring(fila,"codemp"),getitemstring(fila,"codcontrato"),i_tipoing)

SELECT cadena into :ls_int
FROM parametros_gen
WHERE (((codigo_para)=65));

if ls_int='1' or idw_area.getitemstring(idw_area.getrow(),'interfaz')='0' then
	tab_1.tp_1.pb_8.visible=false
else
		tab_1.tp_1.pb_8.visible=true
end if



end event

event constructor;settransobject(SQLCA)
end event

type dw_hist from datawindow within w_apoyo_diag2
event p_rowfocuschanged ( )
integer x = 3735
integer y = 156
integer width = 2395
integer height = 456
integer taborder = 160
boolean bringtotop = true
string title = "none"
string dataobject = "dw_ingr_apdx"
boolean hscrollbar = true
boolean vscrollbar = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event p_rowfocuschanged();i_fila=getrow()
dw_sum_cab.reset()
dw_canasta.reset()
dw_lote.reset()
dw_mvto_cpo.reset()
if i_fila<1 then return
if isnull(getitemnumber(i_fila,'contador')) then return
i_contador=getitemnumber(i_fila,'contador')
i_clughis=getitemstring(i_fila,'clugar_his')
i_cluging=getitemstring(i_fila,'clugar')
i_ningreso=getitemnumber(i_fila,'ningreso')
i_muestra=getitemnumber(i_fila,'muestra')
i_fecha=getitemdatetime(i_fila,'fecha')
string dx,sal_nom,sal_cod
if i_tipoing='1' then
	dx=getitemstring(i_fila,'codgeral')
else
	dx=getitemstring(i_fila,'diagingre')
end if
if  dx <> "" then 
	SELECT  Diags.DesDiag, Diags.cod_rips into :sal_nom,:sal_cod
	FROM Diags
	where Diags.CodGeral=:dx;
	dx='('+sal_cod+') '+sal_nom
	tab_1.tp_1.sle_2.text='('+sal_cod+') '+sal_nom
	tab_1.tp_1.st_4.visible=true
	tab_1.tp_1.sle_2.visible=true
end if

tab_1.tp_1.dw_procs.retrieve(i_codarea,i_ningreso,i_cluging)

idw_lista1.retrieve(i_codarea,i_ningreso,i_cluging)
idw_lista2.retrieve(i_codarea,i_ningreso,i_cluging)
idw_lista3.retrieve(i_codarea,i_ningreso,i_cluging)
dw_sum_cab.retrieve(i_contador,i_clughis)
if dw_canasta.retrieve(i_contador,i_clughis)>0 then
	dw_lote.retrieve(i_contador,i_clughis)
	dw_mvto_cpo.retrieve(i_contador,i_clughis)
end if
tab_1.tp_2.tab_2.procesa.dw_notas.retrieve(i_cluging,i_codarea,i_ningreso,i_nservadx)
tab_1.tp_2.tab_2.selecttab(1)

end event

event constructor;settransobject(SQLCA)
end event

event rowfocuschanged;timer(0.3)
tab_1.tp_1.dw_procs.reset()
long nul
setnull(nul)
tab_1.tp_2.dw_lista1.setitem(1,1,nul)
idw_lista1.reset()
tab_1.tp_3.dw_lista2.setitem(1,1,nul)
idw_lista2.reset()
tab_1.tp_4.dw_lista3.setitem(1,1,nul)
idw_lista3.reset()
end event

event rowfocuschanging;return f_pregunta()
end event

type dw_tip_ingres from datawindow within w_apoyo_diag2
integer x = 1815
integer y = 16
integer width = 1102
integer height = 80
integer taborder = 20
string title = "none"
string dataobject = "dw_tip_ingres_drop"
boolean border = false
boolean livescroll = true
end type

event constructor;settransobject(sqlca)
insertrow(1)
setitem(1,1,'1')
end event

event itemchanged;string actual
actual=getitemstring(1,1)
if isnull(data) then return
if f_pregunta()=1 then
	settext(actual)
	setitem(1,1,actual)
	return 2
end if
i_tipoing=data
tab_1.tp_1.sle_2.text=''
tab_1.tp_1.st_4.visible=false
tab_1.tp_1.sle_2.visible=false
choose case i_tipoing
	case "1" //cext
		cb_hosp.enabled=false
		cb_revisar.enabled=false
		pb_newing.enabled=true
		pb_del.enabled=true
		tab_1.tp_1.sle_1.enabled=true
		tab_1.tp_1.cb_trae.enabled=true
		tab_1.tp_1.cb_traerec.enabled=true
		tab_1.tp_1.pb_find.enabled=true
		
	case else //urg hosp, ambula
		cb_hosp.enabled=true
		cb_revisar.enabled=true
		pb_newing.enabled=false
		pb_del.enabled=false
		tab_1.tp_1.sle_1.enabled=false
		tab_1.tp_1.cb_trae.enabled=false
		tab_1.tp_1.cb_traerec.enabled=false
		tab_1.tp_1.pb_find.enabled=false
end choose
dw_emp.triggerevent(rowfocuschanged!)
dw_hist.reset()
i_fila=0
dw_hist.retrieve(i_codarea,tipdoc,docu,i_tipoing)

end event

type dw_historial from datawindow within w_apoyo_diag2
boolean visible = false
integer x = 974
integer y = 2316
integer width = 448
integer height = 92
boolean bringtotop = true
string title = "none"
string dataobject = "dw_historial"
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;dw_historial.settransobject(SQLCA)
end event

type gb_4 from groupbox within w_apoyo_diag2
integer x = 3694
integer y = 104
integer width = 2487
integer height = 556
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Ingresos Anteriores:"
borderstyle borderstyle = styleraised!
end type

type tab_1 from tab within w_apoyo_diag2
event create ( )
event destroy ( )
integer y = 676
integer width = 6167
integer height = 1636
integer taborder = 170
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long backcolor = 67108864
boolean fixedwidth = true
boolean raggedright = true
boolean focusonbuttondown = true
boolean powertips = true
alignment alignment = center!
integer selectedtab = 1
tp_1 tp_1
tp_4 tp_4
tp_2 tp_2
tp_3 tp_3
end type

on tab_1.create
this.tp_1=create tp_1
this.tp_4=create tp_4
this.tp_2=create tp_2
this.tp_3=create tp_3
this.Control[]={this.tp_1,&
this.tp_4,&
this.tp_2,&
this.tp_3}
end on

on tab_1.destroy
destroy(this.tp_1)
destroy(this.tp_4)
destroy(this.tp_2)
destroy(this.tp_3)
end on

type tp_1 from userobject within tab_1
event create ( )
event destroy ( )
integer x = 18
integer y = 112
integer width = 6130
integer height = 1508
long backcolor = 67108864
string text = "Procedimientos"
long tabtextcolor = 33554432
string picturename = "ap_dx.ico"
long picturemaskcolor = 536870912
string powertiptext = "Historial de procedimientos del Ingreso"
st_7 st_7
st_5 st_5
dp_2 dp_2
dp_1 dp_1
hpb_1 hpb_1
pb_9 pb_9
pb_8 pb_8
st_4 st_4
pb_notas pb_notas
sle_2 sle_2
pb_save_insumo pb_save_insumo
pb_citas pb_citas
pb_find pb_find
mle_1 mle_1
st_8 st_8
sle_autoriza sle_autoriza
sle_1 sle_1
st_1 st_1
dw_procs dw_procs
pb_cargar_res pb_cargar_res
cb_borra cb_borra
st_6 st_6
cb_trae cb_trae
cb_traerec cb_traerec
pb_print pb_print
pb_print_reci pb_print_reci
pb_print_factu pb_print_factu
end type

on tp_1.create
this.st_7=create st_7
this.st_5=create st_5
this.dp_2=create dp_2
this.dp_1=create dp_1
this.hpb_1=create hpb_1
this.pb_9=create pb_9
this.pb_8=create pb_8
this.st_4=create st_4
this.pb_notas=create pb_notas
this.sle_2=create sle_2
this.pb_save_insumo=create pb_save_insumo
this.pb_citas=create pb_citas
this.pb_find=create pb_find
this.mle_1=create mle_1
this.st_8=create st_8
this.sle_autoriza=create sle_autoriza
this.sle_1=create sle_1
this.st_1=create st_1
this.dw_procs=create dw_procs
this.pb_cargar_res=create pb_cargar_res
this.cb_borra=create cb_borra
this.st_6=create st_6
this.cb_trae=create cb_trae
this.cb_traerec=create cb_traerec
this.pb_print=create pb_print
this.pb_print_reci=create pb_print_reci
this.pb_print_factu=create pb_print_factu
this.Control[]={this.st_7,&
this.st_5,&
this.dp_2,&
this.dp_1,&
this.hpb_1,&
this.pb_9,&
this.pb_8,&
this.st_4,&
this.pb_notas,&
this.sle_2,&
this.pb_save_insumo,&
this.pb_citas,&
this.pb_find,&
this.mle_1,&
this.st_8,&
this.sle_autoriza,&
this.sle_1,&
this.st_1,&
this.dw_procs,&
this.pb_cargar_res,&
this.cb_borra,&
this.st_6,&
this.cb_trae,&
this.cb_traerec,&
this.pb_print,&
this.pb_print_reci,&
this.pb_print_factu}
end on

on tp_1.destroy
destroy(this.st_7)
destroy(this.st_5)
destroy(this.dp_2)
destroy(this.dp_1)
destroy(this.hpb_1)
destroy(this.pb_9)
destroy(this.pb_8)
destroy(this.st_4)
destroy(this.pb_notas)
destroy(this.sle_2)
destroy(this.pb_save_insumo)
destroy(this.pb_citas)
destroy(this.pb_find)
destroy(this.mle_1)
destroy(this.st_8)
destroy(this.sle_autoriza)
destroy(this.sle_1)
destroy(this.st_1)
destroy(this.dw_procs)
destroy(this.pb_cargar_res)
destroy(this.cb_borra)
destroy(this.st_6)
destroy(this.cb_trae)
destroy(this.cb_traerec)
destroy(this.pb_print)
destroy(this.pb_print_reci)
destroy(this.pb_print_factu)
end on

type st_7 from statictext within tp_1
boolean visible = false
integer x = 3333
integer y = 1388
integer width = 123
integer height = 64
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 67108864
string text = "FF"
boolean focusrectangle = false
end type

type st_5 from statictext within tp_1
boolean visible = false
integer x = 3333
integer y = 1300
integer width = 146
integer height = 64
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 67108864
string text = "FI"
boolean focusrectangle = false
end type

type dp_2 from datepicker within tp_1
boolean visible = false
integer x = 3538
integer y = 1388
integer width = 686
integer height = 100
integer taborder = 32
boolean border = true
borderstyle borderstyle = stylelowered!
date maxdate = Date("2999-12-31")
date mindate = Date("1800-01-01")
datetime value = DateTime(Date("2025-03-03"), Time("09:58:00.000000"))
integer textsize = -10
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
integer calendarfontweight = 400
boolean todaysection = true
boolean todaycircle = true
end type

type dp_1 from datepicker within tp_1
boolean visible = false
integer x = 3529
integer y = 1284
integer width = 686
integer height = 100
integer taborder = 100
boolean border = true
borderstyle borderstyle = stylelowered!
date maxdate = Date("2999-12-31")
date mindate = Date("1800-01-01")
datetime value = DateTime(Date("2025-03-03"), Time("09:58:00.000000"))
integer textsize = -10
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
integer calendarfontweight = 400
boolean todaysection = true
boolean todaycircle = true
end type

type hpb_1 from hprogressbar within tp_1
boolean visible = false
integer x = 3982
integer y = 1360
integer width = 2103
integer height = 68
unsignedinteger maxposition = 100
unsignedinteger position = 50
integer setstep = 10
end type

type pb_9 from pb_report within tp_1
integer x = 4283
integer y = 28
integer taborder = 80
string picturename = "barras.gif"
string powertiptext = "Imprime Eqtiquetea"
string cod_rep = "ELAB"
string nombre_rep = "Imprime Etiqueta"
string tipo_rep = "interno!"
end type

event clicked;call super::clicked;if dw_hist.rowcount()=0 then return
any par[3]
string envio,ls_registro ,as_path_salida,as_archivo
uo_datastore dw_for

//Para definir los formatos de impresora zebra http://labelary.com/viewer.html
par[1]=dw_hist.getitemstring(dw_hist.getrow(),"codaadx")
par[2]=dw_hist.getitemstring(dw_hist.getrow(),"clugar")
par[3]=dw_hist.getitemnumber(dw_hist.getrow(),"ningreso")

dw_for=create uo_datastore
if g_motor='anywhere' then
	dw_for.DataObject = 'asis_int_codbarras_lab'
end if
if g_motor='sql' then
	dw_for.DataObject = 'asis_int_codbarras_lab_sql'
end if

dw_for.settransobject(sqlca)
dw_for.retrieve(par[1],par[2],par[3])

int li,ll_retorno 

string zebra
SELECT cadena into :zebra
FROM parametros_gen
WHERE (((codigo_para)=49));
if sqlca.sqlnrows=0 then
	messagebox('Atencíon','No hay parametro 49')
	return
end if	 

as_path_salida="c:\windows\temp\"
as_archivo='generado.txt'
FILEDELETE(as_path_salida + as_archivo )
if dw_for.rowcount()>0 then 
	Int li_archivo
	li_archivo= FileOpen(as_path_salida + as_archivo ,LineMode!,Write!,lockwrite!)
	for li=1 to dw_for.rowcount()
		ls_registro=dw_for.getitemstring(li,'salida')
		FileWrite(li_archivo, ls_registro)
	next
	FileClose(li_archivo)
	ls_registro="cmd.exe /c "+ 'COPY /B "'+as_path_salida + as_archivo+  '"  "'+zebra+'"'

	n_runandwait in_rwait
	int 	li_cmd 
	string ls_msg 
	li_cmd  = in_rwait.of_run(ls_registro, normal!)
	CHOOSE CASE li_cmd 
		CASE in_rwait.WAIT_COMPLETE
			ls_msg = "The process completed normally!"
		CASE in_rwait.WAIT_TIMEOUT
			ls_msg = "The process was terminated after 5 seconds!"
		CASE -1
			ls_msg = "The process was not created!"
		CASE ELSE
			ls_msg = "The process completed with return code: " + String(li_cmd)
	END CHOOSE
end if


end event

type pb_8 from picturebutton within tp_1
integer x = 3086
integer y = 1320
integer width = 146
integer height = 128
integer taborder = 22
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean originalsize = true
string picturename = "interfaz.gif"
alignment htextalign = left!
string powertiptext = "Trear Resultados desde Interfaz"
end type

event clicked;SELECT cadena into :int_cliente
FROM parametros_gen
WHERE (((codigo_para)=57));
if sqlca.sqlnrows=0 then
	messagebox('Atencíon','No hay parametro 57')
	return
end if
long l_t

if isnull(int_cliente) then
	messagebox('Atencíon','No hay Indetificacion Cliente Interfaz')
	return
end if

if not isvalid(sqllab) then 
	sqllab = create transaction
else
	disconnect using sqllab;
end if
if f_conecta_lab(sqllab)=-1 then
	return
end if	

If upper(int_cliente)='CEDES' then 
	dw_trae.dataobject='dw_trae_resul_equipo'		
	dw_trae.settransobject(SQLCA)
	dw_lab.dataobject='dw_lab_integra'
	dw_lab.settransobject(sqllab)
end if

If upper(int_cliente)='QIMBERLAB' then 
	if g_motor='postgres' then
		dw_trae.dataobject='dw_trae_resul_equipo_quiber'		
	else
		dw_trae.dataobject='dw_trae_resul_equipo_quiber_sql'
	end if
	dw_trae.settransobject(SQLCA)
	
	if g_motor='postgres' then
		dw_lab.dataobject='dw_lab_integra_quimber'
	else
		dw_lab.dataobject='dw_lab_integra_quimber_sql'
	end if
	dw_lab.settransobject(sqllab)	
	
	if g_motor='postgres' then
		dw_profe_valida.dataobject='dw_profe_valida_interfaz_quimberlab'
	else
		dw_profe_valida.dataobject='dw_profe_valida_interfaz_quimberlab_sql'
	end if
	dw_profe_valida.settransobject(SQLCA)
	
	if dw_profe_valida.retrieve(CLUGAR)>0 then
		l_t= 1
		for l_t= 1 to dw_profe_valida.rowcount()
			messagebox('Atencion Hay profesional validando datos sin correspondencia en Gci',dw_profe_valida.getitemstring(l_t,'usuariovalida'))
		next
		disconnect using sqllab;
		return
	end if
end if
w_principal.SetMicroHelp ( 'Termino Validacion de Profe')
datetime fi,ff
date fec

fec=dp_1.datevalue 
fi=datetime(date(fec),time('00:00'))
fec =dp_2.datevalue 
ff=datetime(date(fec),time('23:59'))

//dw_trae.retrieve(CLUGAR,fi,ff)
dw_trae.retrieve(CLUGAR)
w_principal.SetMicroHelp ( 'Termino Trae')

//dw_lab.retrieve(CLUGAR,fi,ff)
dw_lab.retrieve(CLUGAR)
w_principal.SetMicroHelp ( 'Termino LAB')

if dw_lab.rowcount()=0 then 
	disconnect using sqllab;
	return
end if
tab_1.tp_1.hpb_1.Position = 0
tab_1.tp_1.hpb_1.MinPosition = 0
tab_1.tp_1.hpb_1.MaxPosition =  dw_trae.rowcount()
tab_1.tp_1.hpb_1.SetRange (0,10)
if dw_trae.rowcount()>0 then
	long ningreso,fila,fila1,fila2,consec,l_muestra,l_ks,ll_ctos
	decimal ordentre
	datetime l_fecha,ld_fechavalida
	boolean lb_paso
	string cups,codproced,ordenhis,ls_sede,ls_profevalida

	SetPointer(Hourglass!)
//	dw_emp.SetRedraw(FALSE)
//	dw_hist.SetRedraw(FALSE)
//	dw_procs.SetRedraw(FALSE)
	tab_1.tp_1.hpb_1.visible=true

	l_t= 1
	dw_trae.SetRedraw(FALSE)
	w_principal.SetMicroHelp ( 'Termino Lectura de '+string(dw_trae.RowCount()))
	ll_ctos=dw_trae.RowCount()
	do while l_t <=dw_trae.RowCount()
		lb_paso=false
		l_ks=0
	
		w_principal.SetMicroHelp ( 'Registro '+string(l_t) +' de '+string(ll_ctos))
		if l_t=1 or ningreso<>dw_trae.getitemnumber(l_t,'ningreso') then
			ningreso=dw_trae.getitemnumber(l_t,'ningreso')
			If upper(int_cliente)='CEDES' then 
				tipdoc=dw_trae.getitemstring(l_t,'tipodoc')
				docu=dw_trae.getitemstring(l_t,'documento')
			end if
			If upper(int_cliente)='QIMBERLAB' then 
				tipdoc=dw_trae.getitemstring(l_t,'tipodocumento')
				docu=dw_trae.getitemstring(l_t,'documentopaciente')
			end if
			i_tipoing=dw_trae.getitemstring(l_t,'tipo_ingres')
			i_cluging=dw_trae.getitemstring(l_t,'clu_ing')
			l_muestra=dw_trae.getitemnumber(l_t,'muestra')
			l_fecha=dw_trae.getitemdatetime(l_t,'fecha')
			em_muestra.text=string(l_muestra)
			em_fecha.text=string(date(l_fecha))
			w_principal.dw_1.setitem(1,1,tipdoc)
			w_principal.dw_1.setitem(1,2,docu)
			w_principal.dw_1.setcolumn(2)
			w_principal.dw_1.triggerevent(itemchanged!)
			em_muestra.event modified()	
			ningreso=dw_trae.getitemnumber(l_t,'ningreso')
		end if
		if dw_hist.rowcount()>0 then
			dw_hist.event p_rowfocuschanged()
			If upper(int_cliente)='CEDES' then 
				cups=dw_trae.getitemstring(l_t,'codproced')
				codproced=cups
				ls_sede='SI'
				setnull(ls_profevalida)
				ls_profevalida=g_profe
				ld_fechavalida=datetime(today(),now())
			end if
			If upper(int_cliente)='QIMBERLAB' then 
				cups=dw_trae.getitemstring(l_t,'cod_cups')
				codproced=dw_trae.getitemstring(l_t,'codproced')
				ls_sede=dw_trae.getitemstring(l_t,'sede')
				ls_profevalida=upper(dw_trae.getitemstring(l_t,'usuariovalida'))
				ld_fechavalida=dw_trae.getitemdatetime(l_t,'fechavalida')
			end if
			
			fila = tab_1.tp_1.dw_procs.Find("cod_cups='"+cups+"'" ,1,tab_1.tp_1.dw_procs.RowCount()) 
			tab_1.tp_1.dw_procs.SetRow(fila)
			
			if  tab_1.tp_1.dw_procs.getitemstring(fila,'estado')='2' and upper(int_cliente)='CEDES'  then 
				l_t=l_t + 1
				hpb_1.Position = l_t
				continue
			end if
			if fila > 0 then	
				if  tab_1.tp_1.dw_procs.getitemstring(fila,'estado')='1' or &
					tab_1.tp_1.dw_procs.getitemstring(fila,'estado')='5'  then
					if f_crear_resultados(ls_sede,ls_profevalida,ld_fechavalida,'0')<>1 then 
						exit
						return
					end if
				end if
				
				if  tab_1.tp_1.dw_procs.getitemstring(fila,'estado')='1' or &
					tab_1.tp_1.dw_procs.getitemstring(fila,'estado')='2' or &
					tab_1.tp_1.dw_procs.getitemstring(fila,'estado')='5' or &
					tab_1.tp_1.dw_procs.getitemstring(fila,'estado')='3' or &
					tab_1.tp_1.dw_procs.getitemstring(fila,'estado')='7' then
					
					tab_1.post selecttab(3)
					dw_trae.setfilter("codproced='"+codproced+"' and ningreso="+string(ningreso))
					dw_trae.filter()
					for l_ks=1 to dw_trae.RowCount()
						w_principal.SetMicroHelp ( 'Registro '+string(l_t+l_ks) +' de '+string(ll_ctos))
						consec=dw_trae.getitemnumber(l_ks,'consecampo')
						fila1=tab_1.tp_2.tab_2.resul.dw_res.Find("consecampo="+string(consec),1,tab_1.tp_2.tab_2.resul.dw_res.rowcount())
						
						if fila1>0 and (tab_1.tp_1.dw_procs.getitemstring(fila,'estado')='1' or &
							tab_1.tp_1.dw_procs.getitemstring(fila,'estado')='2' or &
							tab_1.tp_1.dw_procs.getitemstring(fila,'estado')='5' ) then
							
							choose case dw_trae.getitemstring(l_ks,'tipocampo')
							case '1'
								If upper(int_cliente)='CEDES' then 
									tab_1.tp_2.tab_2.resul.dw_res.setitem(fila1,'resultado1',dw_trae.getitemstring(l_ks,'res_valor'))
								end if
								If upper(int_cliente)='QIMBERLAB' then 
									if dw_trae.getitemstring(l_ks,'resultado')='MEMO' then
										lb_paso=true
										tab_1.tp_2.tab_2.resul.dw_res.setitem(fila1,'resultado1',dw_trae.getitemstring(l_ks,'comentarioexamen'))
									else
										tab_1.tp_2.tab_2.resul.dw_res.setitem(fila1,'resultado1',dw_trae.getitemstring(l_ks,'resultado'))
									end if
								end if			
								
							case '2'
								If upper(int_cliente)='CEDES' then 
									tab_1.tp_2.tab_2.resul.dw_res.setitem(fila1,'resultado2',double(dw_trae.getitemstring(l_ks,'res_valor')))
								end if
								If upper(int_cliente)='QIMBERLAB' then 
									tab_1.tp_2.tab_2.resul.dw_res.setitem(fila1,'resultado2',double(dw_trae.getitemstring(l_ks,'resultado')))
									double refi
									string ls_recibe
									ls_recibe=f_con_val_ref_quimberlab(dw_trae.getitemstring(l_ks,'valorrefmin')) 
									if not isnull(ls_recibe) then 
										refi=double(ls_recibe)
										tab_1.tp_2.tab_2.resul.dw_res.setitem(fila1,'ref_min',refi)
									end if	
									
									ls_recibe=f_con_val_ref_quimberlab(dw_trae.getitemstring(l_ks,'valorrefmax'))
									if not isnull(ls_recibe) then 
										refi=double(ls_recibe)
										tab_1.tp_2.tab_2.resul.dw_res.setitem(fila1,'ref_max',refi)								
									end if
								end if			
								
							case '3'
								If upper(int_cliente)='CEDES' then 
									tab_1.tp_2.tab_2.resul.dw_res.setitem(fila1,'resultado3',dw_trae.getitemstring(l_ks,'res_valor'))
								end if
								
								If upper(int_cliente)='QIMBERLAB' then								
									if dw_trae.getitemstring(l_ks,'resultado')='MEMO' then
										lb_paso=true
										tab_1.tp_2.tab_2.resul.dw_res.setitem(fila1,'resultado3',dw_trae.getitemstring(l_ks,'comentarioexamen'))
									else
										tab_1.tp_2.tab_2.resul.dw_res.setitem(fila1,'resultado3',dw_trae.getitemstring(l_ks,'resultado'))
									end if									
									tab_1.tp_2.tab_2.resul.dw_res.setitem(fila1,'ref_min',dw_trae.getitemstring(l_ks,'valorrefmin'))
									tab_1.tp_2.tab_2.resul.dw_res.setitem(fila1,'ref_max',dw_trae.getitemstring(l_ks,'valorrefmax'))
								end if
								
							case '4'							
								If upper(int_cliente)='CEDES' then 
									tab_1.tp_2.tab_2.resul.dw_res.setitem(fila1,'resultado4',dw_trae.getitemstring(l_ks,'res_valor'))
								end if
								If upper(int_cliente)='QIMBERLAB' then 
									if dw_trae.getitemstring(l_ks,'resultado')='MEMO' then
										lb_paso=true
										tab_1.tp_2.tab_2.resul.dw_res.setitem(fila1,'resultado4',dw_trae.getitemstring(l_ks,'comentarioexamen'))
									else
										tab_1.tp_2.tab_2.resul.dw_res.setitem(fila1,'resultado4',dw_trae.getitemstring(l_ks,'resultado'))
									end if
								end if	
								
							case '5'
								If upper(int_cliente)='CEDES' then 
									tab_1.tp_2.tab_2.resul.dw_res.setitem(fila,'resultado5',dw_trae.getitemstring(l_ks,'res_valor'))
								end if
								If upper(int_cliente)='QIMBERLAB' then
									tab_1.tp_2.tab_2.resul.dw_res.setitem(fila1,'resultado5',dw_trae.getitemstring(l_ks,'resultado'))
								end if	
								
							case '6'
								If upper(int_cliente)='CEDES' then 
									tab_1.tp_2.tab_2.resul.dw_res.setitem(fila1,'resultado6',dw_trae.getitemstring(l_ks,'res_valor'))
								end if
								If upper(int_cliente)='QIMBERLAB' then 
									if isnull(dw_trae.getitemstring(l_ks,'resultado')) then 
										tab_1.tp_2.tab_2.resul.dw_res.setitem(fila1,'resultado6','0')
									else
										tab_1.tp_2.tab_2.resul.dw_res.setitem(fila1,'resultado6','1')
									end if
								end if								
							end choose
							
							If upper(int_cliente)='CEDES' then 
								consec=dw_trae.getitemnumber(l_ks,'res_id')
								fila1=dw_lab.Find("res_id="+string(consec),1,dw_lab.rowcount())
								dw_lab.setitem(fila1,'res_estado',1)
							end if
						end if							
			
						If upper(int_cliente)='QIMBERLAB' then 
							if lb_paso=false and not isnull(dw_trae.getitemstring(l_ks,'comentarioexamen')) and len(dw_trae.getitemstring(l_ks,'comentarioexamen'))>0 then
								tab_1.tp_2.tab_2.resul.dw_res.setitem(fila1,'comentarios',dw_trae.getitemstring(l_ks,'comentarioexamen'))
							end if
							ordenhis=dw_trae.getitemstring(l_ks,'ordenhis')
							ls_sede=dw_trae.getitemstring(l_ks,'sede')
							ordentre=dw_trae.getitemnumber(l_ks,'ordenenterprise')
							cups=dw_trae.getitemstring(l_ks,'codigoexamen')
							docu=dw_trae.getitemstring(l_ks,'documentopaciente')
							fila2=dw_lab.Find("ordenhis='"+ordenhis+"' and sede='"+ls_sede+"' and codigoexamen='"+cups+"' and documentopaciente='"+docu+"' and ordenenterprise="+string(ordentre),1,dw_lab.rowcount())
							if fila2=0 then
								messagebox("","ordenhis='"+ordenhis+"' and sede='"+ls_sede+"' and codigoexamen='"+cups+"' and documentopaciente='"+docu+"' and ordenenterprise="+string(ordentre))
							end if
							dw_lab.setitem(fila2,'estado',4)
						end if
					next
					dw_trae.setfilter("")
					dw_trae.filter()
					 if (tab_1.tp_1.dw_procs.getitemstring(fila,'estado')='1' or &
						tab_1.tp_1.dw_procs.getitemstring(fila,'estado')='2' or &
						tab_1.tp_1.dw_procs.getitemstring(fila,'estado')='5' ) then 
						
						tab_1.tp_2.tab_2.resul.pb_save_resul.event clicked()
						tab_1.tp_2.tab_2.resul.pb_cerrar.event clicked()
					
					end if
					if dw_lab.update(TRUE,FALSE) = -1 then
						rollback;
						exit
					end if
					
					commit;
					l_t=l_t + l_ks - 1
				else
					l_t=l_t + 1
				end if
			else
				l_t=l_t + 1
			end if
			//l_t=l_t + l_ks - 1
		end if
		hpb_1.Position = l_t
		if l_t> dw_trae.RowCount() then continue
	loop
	if dw_lab.update(TRUE,FALSE) = -1 then
		rollback;
	end if
	commit;
else
	 messagebox('Atención','No hay resultados para Cargar')
end if

disconnect using sqllab;
SetPointer(Arrow!)
hpb_1.visible=false
//dw_hist.SetRedraw(TRUE)
//dw_procs.SetRedraw(TRUE)
//dw_emp.SetRedraw(TRUE)
tab_1.tp_1.hpb_1.visible=false

end event

type st_4 from statictext within tp_1
integer x = 5
integer y = 172
integer width = 288
integer height = 52
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Diagnostico:"
boolean focusrectangle = false
end type

type pb_notas from picturebutton within tp_1
integer x = 1271
integer y = 28
integer width = 146
integer height = 128
integer taborder = 17
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
boolean originalsize = true
string picturename = "contrato.gif"
alignment htextalign = left!
end type

event clicked;st_notas st_not
st_not.contador=i_contador
st_not.clugar=i_clughis
st_not.profe=g_profe
st_not.ventana='APDX'
//st_not.empresa=dw_inf.getitemstring(1,'desemp')
openwithparm(w_notaspac,st_not)
end event

type sle_2 from singlelineedit within tp_1
boolean visible = false
integer x = 315
integer y = 168
integer width = 5765
integer height = 60
integer taborder = 140
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 255
long backcolor = 15793151
borderstyle borderstyle = stylelowered!
end type

type pb_save_insumo from picturebutton within tp_1
integer x = 2016
integer y = 1320
integer width = 146
integer height = 128
integer taborder = 20
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean originalsize = true
string picturename = "guardar2.gif"
string powertiptext = "Guardar Insumos Utilizados"
end type

event clicked;if messageBox('Atención','Va a guardar el consumo de insumos para todos los productos de la muestra. Desea Continuar?',QUESTION!,YESNO!) = 2 then return
if f_guarda_insumos(dw_sum_cab,dw_canasta,dw_mvto_cpo,dw_lote,i_cdoc_cons,i_clughis,i_alm,i_contador)=-1 then
	rollback;
else
	commit;
	i_cambio_insumo=false
	dw_sum_cab.resetupdate()
	dw_canasta.resetupdate()
	dw_mvto_cpo.resetupdate()
	dw_lote.resetupdate()
end if

end event

type pb_citas from picturebutton within tp_1
integer x = 1115
integer y = 28
integer width = 146
integer height = 128
integer taborder = 14
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
boolean originalsize = true
string picturename = "asig_cita.gif"
alignment htextalign = left!
end type

event clicked;if i_codarea='' or isnull(i_codarea) then return
if i_tipoing<>'1' then return
openwithparm(w_citas_asig,i_codarea)
end event

type pb_find from picturebutton within tp_1
integer x = 672
integer y = 28
integer width = 146
integer height = 128
integer taborder = 2
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean originalsize = true
string picturename = "buscar.gif"
string disabledname = "d_buscar.gif"
string powertiptext = "Buscar Procedimiento"
end type

event clicked;if dw_hist.rowcount()=0 then return
if dw_procs.rowcount()>0 then 
	if not isnull (dw_procs.getitemnumber(1,'nfact')) and isnull (dw_procs.getitemnumber(1,'nrcaj')) then return
	if isnull (dw_procs.getitemnumber(1,'nfact')) and not isnull (dw_procs.getitemnumber(1,'nrcaj')) then return
end if
st_busca_apdx st
st.cod_area=i_codarea
st.des_area=idw_area.getitemstring(idw_area.getrow(),'descripciongc')
st.sle=sle_1
openwithparm(w_busca_apdx,st)
refres_lista()

end event

type mle_1 from multilineedit within tp_1
boolean visible = false
integer x = 2368
integer y = 20
integer width = 1600
integer height = 140
integer taborder = 6
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 255
long backcolor = 15793151
boolean autovscroll = true
boolean displayonly = true
borderstyle borderstyle = stylelowered!
end type

type st_8 from statictext within tp_1
integer x = 1527
integer y = 4
integer width = 293
integer height = 56
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Autorización:"
boolean focusrectangle = false
end type

type sle_autoriza from singlelineedit within tp_1
integer x = 1531
integer y = 68
integer width = 475
integer height = 88
integer taborder = 5
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 16777215
integer limit = 15
borderstyle borderstyle = stylelowered!
end type

event modified;i_nautoriza=trim(text)
end event

type sle_1 from singlelineedit within tp_1
integer x = 315
integer y = 56
integer width = 338
integer height = 84
integer taborder = 1
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 16777215
borderstyle borderstyle = stylelowered!
end type

event modified;if docu='' or tipdoc='' or dw_emp.rowcount()=0 or dw_hist.rowcount()=0 then return -1
if dw_procs.rowcount()>0 then 
	if not isnull (dw_procs.getitemnumber(1,'nfact')) and isnull (dw_procs.getitemnumber(1,'nrcaj')) then return
	if isnull (dw_procs.getitemnumber(1,'nfact')) and not isnull (dw_procs.getitemnumber(1,'nrcaj')) then return
end if
text=trim(text)
if text="" then return -1
if dw_emp.getitemstring(dw_emp.getrow(),"estado")='0' then
	messagebox('Atención','El contrato seleccionado no está activo, no se le puede cargar servicios')
	return -1
end if
if i_clughis<>clugar then 
	messagebox("Atención","No puede modificar los datos de este ingreso debido a que esta area de Apoyo diagnóstico pertenece al lugar:"+i_clughis)
	return -1
end if
if date(dw_hist.getitemdatetime(dw_hist.getrow(),'fecha'))<>today() then
	if messagebox("Atención",'Está tratando de agregar un procedimiento a un ingreso que no es de hoy. Desea continuar.?',question!,yesno!,1)=2 then
		text=''
		return -1
	end if
end if
string snul
long nnul
datetime fnul
setnull(fnul)
setnull(snul)
setnull(nnul)
//	p_cod,procequiv,man_eq,empresa,contrato,plan,autoriza,nfactura,clug_fac,item_fac,nreci
//	clug_rec,item_rec,nitem_rec,ncita,clug_cita,nserv_cita,sec_cant_cit,fecha_cit,hora_cit, conta_os
// clug_os,norden,nitem_os,facturar,tipo_fac,observa
if f_insert_proc(text,snul,snul,snul,snul,snul,sle_autoriza.text,nnul,snul,nnul,nnul,snul,nnul,nnul,nnul,snul, & 
		nnul,nnul,fnul,fnul,nnul,snul,nnul,nnul,nnul,snul,snul,'1')=-1 then
	rollback;
	text=''
	return -1
else
	commit;
	refres_lista()
end if
text=''
return 1
end event

type st_1 from statictext within tp_1
integer x = 5
integer y = 68
integer width = 357
integer height = 56
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Digite Código:"
boolean focusrectangle = false
end type

type dw_procs from datawindow within tp_1
integer y = 316
integer width = 6094
integer height = 956
integer taborder = 9
string title = "none"
string dataobject = "dw_servadx"
boolean maxbox = true
boolean hscrollbar = true
boolean vscrollbar = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;settransobject(SQLCA)
end event

event doubleclicked;if getrow()<1 then return
pb_cargar_res.post triggerevent(clicked!)
end event

event rbuttondown;if row<1 then return
scrolltorow(row)
if getitemstring(getrow(),"estado")="2" or getitemstring(getrow(),"estado")="5" then 
	w_principal.m_principal.m_3.m_3_5.m_3_5_2.PopMenu (w_principal.PointerX(), w_principal.PointerY())
end if
end event

event rowfocuschanged;tab_1.tp_2.tab_2.resul.dw_serving.reset()
tab_1.tp_2.dw_rescpo.reset()
tab_1.tp_2.tab_2.resul.dw_res.reset()
setnull(i_nrepor)
setnull(i_nserving)
setnull(i_nservadx)
if getrow()<1 then 
	mle_1.visible=false
	return
end if

i_nrepor=getitemnumber(getrow(),'nrepor')
i_nserving=getitemnumber(getrow(),'nserving')
i_nservadx=getitemnumber(getrow(),'nproced')
ntomas=getitemnumber(getrow(),'nro_tomas')
tab_1.tp_2.dw_lista1.setitem(1,1,getitemnumber(getrow(),'nproced'))
tab_1.tp_3.dw_lista2.setitem(1,1,getitemnumber(getrow(),'nproced'))
tab_1.tp_4.dw_lista3.setitem(1,1,getitemnumber(getrow(),'nproced'))
tab_1.tp_2.tab_2.resul.dw_serving.retrieve(i_contador,i_clughis,i_nserving)
if tab_1.tp_2.dw_rescpo.retrieve(getitemstring(getrow(),'coddoc'),getitemnumber(getrow(),'nrepor'),getitemnumber(getrow(),'item'),getitemstring(getrow(),'clugar'))>0 then
	i_itemcpo=tab_1.tp_2.dw_rescpo.getitemnumber(1,'item')
	i_cod_doc=tab_1.tp_2.dw_rescpo.getitemstring(1,'coddoc')
end if
if tab_1.tp_2.tab_2.resul.dw_res.retrieve(getitemstring(getrow(),'coddoc'),getitemnumber(getrow(),'nrepor'),getitemnumber(getrow(),'item'),getitemstring(getrow(),'codproced'),getitemstring(getrow(),'clugar'))>0 then
	tab_1.tp_2.dw_campos.retrieve(getitemnumber(getrow(),'codgc'),getitemstring(getrow(),'codproced'))
	tab_1.tp_2.tab_2.resul.pb_insert.enabled=false
	if getitemstring(getrow(),'estado')='2' then
		tab_1.tp_2.tab_2.resul.pb_cerrar.enabled=true
	else
		tab_1.tp_2.tab_2.resul.pb_cerrar.enabled=false
	end if
else
	tab_1.tp_2.tab_2.resul.pb_insert.enabled=true
	tab_1.tp_2.tab_2.resul.pb_cerrar.enabled=false
end if
if ntomas>1 then
	tab_1.tp_4.enabled=true
	tab_1.tp_4.visible=true
	tab_1.tp_4.dw_tomas.retrieve(i_cluging,i_codarea,i_ningreso,getitemnumber(getrow(),'nproced'))
else
	tab_1.tp_4.enabled=false
	tab_1.tp_4.visible=false
	tab_1.tp_4.dw_tomas.reset()
end if

long conta_os,norden,item_os
string clug_os
conta_os=getitemnumber(getrow(),"contador_os")
clug_os=getitemstring(getrow(),'clugar_os')
norden=getitemnumber(getrow(),"nsolicitud_os")
item_os=getitemnumber(getrow(),"item_os")
if not isnull(conta_os) and not isnull(norden) and not isnull(item_os) then
	select observaciones into :mle_1.text from oscuerpo 
	where contador=:conta_os and clugar=:clug_os and Nsolicitud=:norden and Item=:item_os;
	if mle_1.text<>"" and not isnull(mle_1.text) then mle_1.visible=true
else
	mle_1.visible=false
end if
if getitemstring(getrow(),"estado")="2" or getitemstring(getrow(),"estado")="5" then 
	w_principal.m_principal.m_3.m_3_5.m_3_5_2.m_3_5_2_1.enabled=true
	w_principal.m_principal.m_3.m_3_5.m_3_5_2.m_3_5_2_2.enabled=true
else
	w_principal.m_principal.m_3.m_3_5.m_3_5_2.m_3_5_2_1.enabled=false
	w_principal.m_principal.m_3.m_3_5.m_3_5_2.m_3_5_2_2.enabled=false
end if
tab_1.tp_3.dw_imagenes.retrieve(getitemstring(getrow(),'coddoc'),getitemstring(getrow(),'clugar'),getitemnumber(getrow(),'nrepor'),getitemnumber(getrow(),'item'))
end event

event dberror;rollback;
return 0
end event

event buttonclicked;if dwo.name='b_1' then
	st_xa_canastas st
	st.cproc=getitemstring(row,'codproced')
	st.sexo=w_principal.dw_1.getitemstring(1,'sexo')
	st.edad_dias=w_principal.dw_1.getitemnumber(1,'dias')
	st.dw_canasta=dw_canasta
	st.dw_lote=dw_lote
	st.contador=i_contador
	st.clugar=i_clughis
	st.nserv=i_nserving
	//st.item=i_nserving
	st.alm=i_alm
	openwithparm(w_canasta_articulo,st)
	if message.stringparm='ok' then i_cambio_insumo=TRUE
end if
if dwo.name='b_2' then
	If dw_procs.rowcount()=0 then return
	uo_report lci_rep
	lci_rep=create uo_report
	lci_rep.cod_rep=getitemstring(row,'codproced')
	lci_rep.v_preliminar=true
	lci_rep.dialogo=false
	lci_rep.tipo_rep='consenti!'
	any par[2]
	par[1]=i_contador
	par[2]=i_clughis
	lci_rep.imprimir(par,'','0')
end if
end event

event clicked;if row>0 and getrow()<>row then setrow(row)
end event

type pb_cargar_res from picturebutton within tp_1
event mousemove pbm_mousemove
integer x = 2551
integer y = 1320
integer width = 146
integer height = 128
integer taborder = 10
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
string text = "            &t"
boolean originalsize = true
string picturename = "editar.GIF"
string disabledname = "d_editar.gif"
alignment htextalign = left!
string powertiptext = "Registrar Resultados [Alt+T]"
end type

event clicked;if dw_procs.rowcount()<1 then return
string estado
long fila
fila=dw_procs.getrow()
estado=dw_procs.getitemstring(fila,"estado")
choose case estado
	case '6'
		messagebox("Atención","Este Examen se encuentra anulado")
		return
	case '1','5'//pendiente,registrado sin result
		if tag='1' then //tag lo asigna f_inicia_boton en constructor
			if f_permiso_boton(this,'APDX')=0 then return
			lf_titulo()
		end if
		if isnull(dw_procs.getitemnumber(fila,'nrepor')) then
			if messagebox("Atención","Está seguro que desea Ingresar o modificar resultados de este procedimiento, esto le implica que no lo puede borrar.",Question!,YesNo!,1) = 2 then return
		end if
		if f_crear_resultados('SI',g_profe,datetime(today(), now()),'1')=1 then 
			tab_1.post selecttab(3)//porque el son of the bitch cuando está en ambiente XP no dejaba el tp_2 como activo
		end if
	case '2' //realizado
		tab_1.post selecttab(3)//porque el son of the bitch cuando está en ambiente XP no dejaba el tp_2 como activo
end choose
tab_1.tp_2.tab_2.resul.pb_insert.enabled=false
tab_1.tp_2.tab_2.resul.dw_serving.post setfocus()//porque el son of the bitch cuando está en ambiente XP no dejaba el tp_2 como activo
tab_1.tp_2.tab_2.selecttab(1)


end event

event constructor;f_inicia_boton(this,'APDX')
end event

type cb_borra from picturebutton within tp_1
event mousemove pbm_mousemove
integer x = 2729
integer y = 1320
integer width = 146
integer height = 128
integer taborder = 11
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
string text = "            &B"
boolean originalsize = true
string picturename = "anular_doc.gif"
string disabledname = "d_anular_doc.gif"
alignment htextalign = left!
string powertiptext = "Borrar Resultados [Alt+B]"
end type

event clicked;if dw_procs.rowcount()<1 then return

if f_permiso_boton(this,'APDX')=0 then return
long nservic,nre,nfa,nitr,nitemrec,nitfa,nrepor,nhosp,norden,nitem_os,conta_os
string pr,clug_fac,clug_rec,cod_doc,clug_os,tingre_hadm,estado_int,estadop
cod_doc=dw_procs.getitemstring(dw_procs.getrow(),"coddoc")
nrepor=dw_procs.getitemnumber(dw_procs.getrow(),"nrepor")
estadop=dw_procs.getitemstring(dw_procs.getrow(),"estado")
if not isnull(cod_doc) or not isnull(nrepor) then 
	messagebox("Atención","No puede Borrar este procedimiento por que ya tiene resultados")
	return
end if
nre=dw_procs.getitemnumber(dw_procs.getrow(),"nrcaj")
clug_rec=dw_procs.getitemstring(dw_procs.getrow(),"clugar_rec")
nitr=dw_procs.getitemnumber(dw_procs.getrow(),"items")
nitemrec=dw_procs.getitemnumber(dw_procs.getrow(),"nitem_rec")
estado_int=dw_procs.getitemstring(dw_procs.getrow(),"estado_int")
if estado_int='1' and estadop<>'1' then 
	messagebox("Atención","Producto en interfaz con equipo Biomedico no lo puede eliminar")
	return
end if

long ll_ncita,ll_nserv,ll_sec_cant
datetime ldt_fecha,ldt_hora
string ls_clug_cita

ls_clug_cita=dw_procs.getitemstring(dw_procs.getrow(),"clugar_cita")
ll_ncita=dw_procs.getitemnumber(dw_procs.getrow(),"ncita")
ll_nserv=dw_procs.getitemnumber(dw_procs.getrow(),"nservicio")
ll_sec_cant=dw_procs.getitemnumber(dw_procs.getrow(),"sec_cant_cita")
ldt_fecha=dw_procs.getitemdatetime(dw_procs.getrow(),"fecha")
ldt_hora=dw_procs.getitemdatetime(dw_procs.getrow(),"hora")
update serciosturno set control='1',contador=null,clugar_ser=null,nservicio_ingreso=null 
where ncita=:ll_ncita and clugar=:ls_clug_cita and nservicio=:ll_nserv and sec_cant=:ll_sec_cant and fecha=:ldt_fecha and hora=:ldt_hora;
if sqlca.sqlcode=-1 then 
	messagebox("Error actualizando citas",sqlca.sqlerrtext)
	rollback;
	return
end if
update citasasig set estado='3' where ncita=:ll_ncita and clugar=:ls_clug_cita;
if sqlca.sqlcode=-1 then 
	messagebox("Error actualizando citas",sqlca.sqlerrtext)
	rollback;
	return
end if

if not isnull(nre) and not isnull(nitr) and not isnull(nitemrec) then
	update tesoredetalle set servadx=null where nrcaj=:nre and clugar=:clug_rec and items=:nitr and nitem=:nitemrec; 
	if sqlca.sqlcode=-1 then
		messagebox("Error actualizando estado de recibo de caja",sqlca.sqlerrtext)
		rollback;
		dw_hist.triggerevent(rowfocuschanged!)
		return
	end if
end if
nfa=dw_procs.getitemnumber(dw_procs.getrow(),"nfact")
clug_fac=dw_procs.getitemstring(dw_procs.getrow(),"clugar_fac")
nitfa=dw_procs.getitemnumber(dw_procs.getrow(),"nitem")
if not isnull(nfa) and not isnull(nitfa) then
	update factcpo set servadx=null where nfact=:nfa and clugar=:clug_fac and nitem=:nitfa;
	if sqlca.sqlcode=-1 then
		messagebox("Error actualizando estado de Factura",sqlca.sqlerrtext)
		rollback;
		dw_hist.triggerevent(rowfocuschanged!)
		return
	end if
end if
conta_os=dw_procs.getitemnumber(dw_procs.getrow(),'contador_os')
if not isnull(conta_os) then
	norden=dw_procs.getitemnumber(dw_procs.getrow(),'nsolicitud_os')
	nitem_os=dw_procs.getitemnumber(dw_procs.getrow(),'item_os')
	clug_os=dw_procs.getitemstring(dw_procs.getrow(),'clugar_os')
	UPDATE oscuerpo SET suministrada = suministrada -1,estado='1',en_apdx='0'
	WHERE contador=:conta_os and clugar=:clug_os and nsolicitud=:norden and item=:nitem_os;
	if sqlca.sqlcode=-1 then
		messagebox("Error actualizando estado de Oscuerpo",sqlca.sqlerrtext)
		rollback;
		dw_hist.triggerevent(rowfocuschanged!)
		return
	end if
	update oscabeza set estado='1' where
	contador=:conta_os and clugar=:clug_os and nsolicitud=:norden ;
	if sqlca.sqlcode=-1 then
		messagebox("Error actualizando estado de Oscabeza",sqlca.sqlerrtext)
		rollback;
		dw_hist.triggerevent(rowfocuschanged!)
		return
	end if
end if

tab_1.tp_4.dw_tomas.deleterow(tab_1.tp_4.dw_tomas.getrow())
if tab_1.tp_4.dw_tomas.update()=-1 then 
	rollback;
	dw_hist.triggerevent(rowfocuschanged!)
	return
end if

dw_procs.deleterow(dw_procs.getrow())
if dw_procs.update()=-1 then 
	rollback;
	dw_hist.triggerevent(rowfocuschanged!)
else
	commit;
	refres_lista()
end if
end event

type st_6 from statictext within tp_1
integer y = 244
integer width = 6085
integer height = 72
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Procedimientos asignados hasta el momento:"
boolean border = true
borderstyle borderstyle = styleraised!
boolean focusrectangle = false
end type

type cb_trae from picturebutton within tp_1
event mousemove pbm_mousemove
integer x = 818
integer y = 28
integer width = 146
integer height = 128
integer taborder = 3
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
string text = "            &d"
boolean originalsize = true
string picturename = "tfactura.gif"
string disabledname = "d_tfactura.gif"
alignment htextalign = left!
string powertiptext = "Traer procedimientos Facturados [Alt+D]"
end type

event clicked;if isnull(dw_area.getitemstring(1,1)) or tipdoc='' or docu='' then return
openwithparm(w_lleva_factu_apdx,idw_area.getitemstring(idw_area.getrow(),'varios_fact'))
refres_lista()
end event

type cb_traerec from picturebutton within tp_1
event mousemove pbm_mousemove
integer x = 965
integer y = 28
integer width = 146
integer height = 128
integer taborder = 4
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean originalsize = true
string picturename = "trecibo.gif"
string disabledname = "d_trecibo.gif"
alignment htextalign = left!
string powertiptext = "Traer procedimientos de Recibos de caja"
end type

event clicked;if isnull(dw_area.getitemstring(1,1)) or tipdoc='' or docu='' then return
open(w_lleva_reci_apdx)
refres_lista()
end event

type pb_print from pb_report within tp_1
integer x = 2907
integer y = 1320
integer taborder = 12
string picturename = "print2.gif"
string disabledname = "d_print2.gif"
string powertiptext = "Imprimir Resultados"
string nombre_rep = "Impresión de Apoyo Diagnóstico"
string tipo_rep = "documento!"
end type

event clicked;call super::clicked;long nrepor
IF dw_procs.rowcount()=0 then return
dw_procs.triggerevent(rowfocuschanged!)
nrepor=dw_procs.getitemnumber(dw_procs.getrow(),"nrepor")
if isnull(nrepor) then return

string carreta,nom_arch,clug,cod_doc
nom_arch=""
carreta=""
if dw_procs.getitemstring(dw_procs.getrow(),"estado")<>'7' then 
	messagebox('Atención','No se puede imprimir el resultado porque no se ha cerrado el Resultado')
	return
end if
cod_doc=dw_procs.getitemstring(dw_procs.getrow(),"coddoc")
nrepor=dw_procs.getitemnumber(dw_procs.getrow(),"nrepor")
clug=dw_procs.getitemstring(dw_procs.getrow(),"clugar")
//if clug<>clugar then
//	messagebox("Atención","No puede imprimir estos resultados debido a que el area de Apoyo Diagnóstico es de otro lugar")
//	return
//end if
if isnull(cod_doc) or isnull(nrepor) then return
cod_rep=cod_doc
i_clugar=clug
nombre_rep='Reporte de Apoyo Diagnóstico -Area: '+i_codarea
if inicia('documento!',cod_rep,clug)=-1 then return
if report.dw_rep.retrieve(cod_doc,nrepor,clug)=0 then 
	messagebox("Error","No se encuentran resultados para este documento")
	return
end if

string est
select ResultadosCab.Estado into :est from ResultadosCab WHERE ResultadosCab.CodDoc=:cod_doc AND ResultadosCab.NRepor=:nrepor and clugar=:clug;
if sqlca.sqlcode=-1 then
	messagebox("Error, intente nuevamente",sqlca.sqlerrtext)
	return
end if
if est='1' then
	if MessageBox("Atención","Al imprimir los resultados no podrá modificarlos luego.~r~nEstá seguro que desea realizar esto ?.",question!,yesno!,1)=2 then return
end if

//para firma
if dw_prof_resu.retrieve(cod_doc,clug,nrepor)>0 then
	int  li_FileNum,l_i
	string  i_tempo, err, stx, ret,l_prof,tmp_file//,tmp_file_mod[]
	blob b_firma
	
	for l_i=1 to dw_prof_resu.rowcount()
		l_prof=dw_prof_resu.getitemstring(l_i,'profesional')
		selectblob firma into :b_firma from profe
		where codprof=:l_prof ;
		if SQLCA.SQLCode <> 0 then
			MessageBox("SQL error",SQLCA.SQLErrText,Information!)
			return -1
		end if
		i_tempo="c:\windows\temp\"
		tmp_file = i_tempo +l_prof+cod_doc+clug+string(nrepor)+".jpg"
		li_FileNum = FileOpen(tmp_file, StreamMode!, Write!, LockWrite!, Replace!)
		if isNull(li_FileNum) or li_FileNum < 1 then
			MessageBox('Atención','Error creando archivo temporal de imágen')
			Return -1
		end if
		FileWriteEx ( li_FileNum, b_firma)
		FileClose(li_FileNum)
	next
end if
///para firmas

any par[3]
par[1]=cod_doc
par[2]=nrepor
par[3]=clug
if imprimir(par,'','0')=1 then
	UPDATE ResultadosCab SET Estado = '2'
	WHERE ResultadosCab.CodDoc=:cod_doc AND ResultadosCab.NRepor=:nrepor and clugar=:clug;
	if sqlca.sqlcode= -1 then
		rollback;
		messagebox("Error actualizando estado de ResultadosCab",sqlca.sqlerrtext)
	else
		commit;
	end if
//	for l_i=1 to dw_prof_resu.rowcount()
//		FileDelete(tmp_file_mod[l_i])
//	next
end if
end event

type pb_print_reci from pb_report within tp_1
integer x = 3995
integer y = 28
integer taborder = 7
string text = "          &R"
string picturename = "print3.gif"
string disabledname = "d_print3.gif"
string powertiptext = "Imprimir Recibo de Caja [Alt+R]"
string cod_rep = "RC"
string nombre_rep = "Recibo de Caja"
string tipo_rep = "documento!"
end type

event clicked;call super::clicked;if dw_procs.rowcount()=0 then return
if isnull(dw_procs.getitemnumber(dw_procs.getrow(),"nrcaj")) then return
any par[2]
par[1]=dw_procs.getitemnumber(dw_procs.getrow(),"nrcaj")
par[2]=dw_procs.getitemstring(dw_procs.getrow(),"clugar_rec")
imprimir(par,'','0')

end event

type pb_print_factu from pb_report within tp_1
integer x = 4142
integer y = 28
integer taborder = 8
integer textsize = -5
integer weight = 700
string facename = "Small Fonts"
string text = "&F"
string picturename = "print3.gif"
alignment htextalign = center!
vtextalign vtextalign = top!
string powertiptext = "Imprimir Factura [Alt+F]"
string cod_rep = "FV"
string nombre_rep = "Factura"
string tipo_rep = "documento!"
end type

event clicked;call super::clicked;if dw_procs.rowcount()=0 then return
any par[4]
par[1]=dw_procs.getitemnumber(dw_procs.getrow(),"nfact")
par[2]='1'
par[3]=dw_procs.getitemstring(dw_procs.getrow(),"clugar_fac")
par[4]=dw_procs.getitemstring(dw_procs.getrow(),"tipo_fac")
imprimir(par,'','0')

end event

type tp_4 from userobject within tab_1
boolean visible = false
integer x = 18
integer y = 112
integer width = 6130
integer height = 1508
boolean enabled = false
long backcolor = 67108864
string text = "Tomas"
long tabtextcolor = 33554432
string picturename = "muestra.ico"
long picturemaskcolor = 536870912
pb_7 pb_7
dw_tomas dw_tomas
pb_6 pb_6
dw_lista3 dw_lista3
pb_5 pb_5
end type

on tp_4.create
this.pb_7=create pb_7
this.dw_tomas=create dw_tomas
this.pb_6=create pb_6
this.dw_lista3=create dw_lista3
this.pb_5=create pb_5
this.Control[]={this.pb_7,&
this.dw_tomas,&
this.pb_6,&
this.dw_lista3,&
this.pb_5}
end on

on tp_4.destroy
destroy(this.pb_7)
destroy(this.dw_tomas)
destroy(this.pb_6)
destroy(this.dw_lista3)
destroy(this.pb_5)
end on

type pb_7 from picturebutton within tp_4
integer x = 3008
integer y = 164
integer width = 146
integer height = 128
integer taborder = 150
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean originalsize = true
string picturename = "refrescar.GIF"
string powertiptext = "Actualiza Fecha"
end type

event clicked;if dw_tomas.getrow()<>1 and isnull(dw_tomas.getitemdatetime(dw_tomas.getrow(),'fecha'))then 
	dw_tomas.setitem(dw_tomas.getrow(),"fecha",datetime(today(),now()))
end if
if tab_1.tp_4.dw_tomas.update()<1 then
	tab_1.tp_4.dw_tomas.resetupdate()
	return -1
end if
end event

type dw_tomas from datawindow within tp_4
integer x = 59
integer y = 152
integer width = 2912
integer height = 1328
integer taborder = 130
string title = "none"
string dataobject = "dw_servadx_muestra"
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;settransobject(SQLCA)
end event

type pb_6 from picturebutton within tp_4
integer x = 2277
integer width = 105
integer height = 92
integer taborder = 70
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
string picturename = "adelante_1.gif"
alignment htextalign = left!
string powertiptext = "Siguiente Procedimiento"
end type

event clicked;tab_1.tp_1.dw_procs.scrollnextrow()
end event

type dw_lista3 from datawindow within tp_4
integer x = 101
integer width = 2167
integer height = 108
integer taborder = 20
boolean bringtotop = true
string title = "none"
string dataobject = "dw_drop_servadx_toma"
boolean border = false
boolean livescroll = true
end type

event constructor;getchild('nproced',idw_lista3)
idw_lista3.settransobject(sqlca)
insertrow(1)
end event

event itemchanged;accepttext()
tab_1.tp_1.dw_procs.scrolltorow(idw_lista3.getrow())
end event

type pb_5 from picturebutton within tp_4
integer width = 105
integer height = 92
integer taborder = 10
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
string picturename = "atras.gif"
alignment htextalign = left!
string powertiptext = "Anterior Procedimiento"
end type

event clicked;tab_1.tp_1.dw_procs.scrollpriorrow()
end event

type tp_2 from userobject within tab_1
event create ( )
event destroy ( )
integer x = 18
integer y = 112
integer width = 6130
integer height = 1508
long backcolor = 67108864
string text = "Resultados"
long tabtextcolor = 33554432
string picturename = "resultados.ico"
long picturemaskcolor = 536870912
string powertiptext = "Muestra los resultados del Procedimiento Seleccionado"
gb_2 gb_2
dw_campos dw_campos
dw_lista1 dw_lista1
pb_1 pb_1
dw_rescpo dw_rescpo
pb_2 pb_2
tab_2 tab_2
end type

on tp_2.create
this.gb_2=create gb_2
this.dw_campos=create dw_campos
this.dw_lista1=create dw_lista1
this.pb_1=create pb_1
this.dw_rescpo=create dw_rescpo
this.pb_2=create pb_2
this.tab_2=create tab_2
this.Control[]={this.gb_2,&
this.dw_campos,&
this.dw_lista1,&
this.pb_1,&
this.dw_rescpo,&
this.pb_2,&
this.tab_2}
end on

on tp_2.destroy
destroy(this.gb_2)
destroy(this.dw_campos)
destroy(this.dw_lista1)
destroy(this.pb_1)
destroy(this.dw_rescpo)
destroy(this.pb_2)
destroy(this.tab_2)
end on

type gb_2 from groupbox within tp_2
integer y = 488
integer width = 3502
integer height = 12
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
end type

type dw_campos from datawindow within tp_2
boolean visible = false
integer x = 5847
integer width = 128
integer height = 120
boolean enabled = false
string title = "none"
string dataobject = "dw_cap_val_resul"
boolean vscrollbar = true
boolean resizable = true
boolean livescroll = true
end type

event constructor;settransobject(SQLCA)
end event

type dw_lista1 from datawindow within tp_2
integer x = 128
integer y = 8
integer width = 2167
integer height = 108
integer taborder = 20
boolean bringtotop = true
string title = "none"
string dataobject = "dw_drop_servadx"
boolean border = false
boolean livescroll = true
end type

event constructor;getchild('nproced',idw_lista1)
idw_lista1.settransobject(sqlca)
insertrow(1)
end event

event itemchanged;accepttext()
tab_1.tp_1.dw_procs.scrolltorow(idw_lista1.getrow())
end event

type pb_1 from picturebutton within tp_2
integer width = 146
integer height = 128
integer taborder = 10
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean originalsize = true
string picturename = "atras.gif"
alignment htextalign = left!
string powertiptext = "Anterior Procedimiento"
end type

event clicked;tab_1.tp_1.dw_procs.scrollpriorrow()
end event

type dw_rescpo from datawindow within tp_2
event type integer insertar ( string p_lugar,  string p_uvalida,  datetime p_fvalida,  string p_intfz )
integer x = 2487
integer y = 8
integer width = 2944
integer height = 84
integer taborder = 40
boolean bringtotop = true
string title = "none"
string dataobject = "dw_resul_cpo"
boolean border = false
boolean livescroll = true
end type

event type integer insertar(string p_lugar, string p_uvalida, datetime p_fvalida, string p_intfz);long fila

fila=tab_1.tp_1.dw_procs.getrow()
insertrow(1)

select max(item) into :i_itemcpo from resultadoscpo 
where coddoc=:i_Cod_Doc and clugar=:i_cluging and nrepor=:i_NRepor;
if sqlca.sqlcode=-1 then
	messagebox("Error leyendo ResultadosCpo",sqlca.sqlerrtext)
	return -1
end if
if isnull(i_itemcpo) then i_itemcpo=0
i_itemcpo++
setitem(1,"item",i_itemcpo)
setitem(1,"coddoc",i_Cod_Doc)
setitem(1,"clugar",i_cluging)
setitem(1,"nrepor",i_NRepor)
setitem(1,"codgc",tab_1.tp_1.dw_procs.getitemnumber(fila,'codgc'))
setitem(1,"Nomuestra",w_apoyo_diag2.dw_hist.getitemnumber(w_apoyo_diag2.dw_hist.getrow(),'muestra'))
setitem(1,"codproced",tab_1.tp_1.dw_procs.getitemstring(fila,'codproced'))
setitem(1,"IndResul",'1')
setitem(1,"descripcion",tab_1.tp_1.dw_procs.getitemstring(fila,'descripcion'))
setitem(1,"fecharesul",p_fvalida)
if p_intfz='1' then
	setitem(1,"fecha_intfaz",datetime(today(),now()))
end if
setitem(1,"usuario",p_uvalida)
setitem(1,"contador",w_apoyo_diag2.i_contador)
setitem(1,"clugar_ser",w_apoyo_diag2.i_clughis)
setitem(1,"nservicio",i_nserving)
//setitem(1,'profesional',g_profe)
setitem(1,'profesional',p_uvalida)
if update()=-1 then return -1
return 1
end event

event constructor;settransobject(SQLCA)
getchild('profesional',idw_profe)
idw_profe.settransobject(sqlca)
end event

type pb_2 from picturebutton within tp_2
integer x = 2295
integer y = 4
integer width = 146
integer height = 128
integer taborder = 30
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean originalsize = true
string picturename = "adelante_1.gif"
alignment htextalign = left!
string powertiptext = "Siguiente Procedimiento"
end type

event clicked;tab_1.tp_1.dw_procs.scrollnextrow()
end event

type tab_2 from tab within tp_2
integer x = 5
integer y = 136
integer width = 6094
integer height = 1352
integer taborder = 80
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Small Fonts"
long backcolor = 67108864
boolean raggedright = true
boolean focusonbuttondown = true
boolean showtext = false
boolean perpendiculartext = true
tabposition tabposition = tabsonleft!
alignment alignment = right!
resul resul
procesa procesa
end type

on tab_2.create
this.resul=create resul
this.procesa=create procesa
this.Control[]={this.resul,&
this.procesa}
end on

on tab_2.destroy
destroy(this.resul)
destroy(this.procesa)
end on

type resul from userobject within tab_2
event create ( )
event destroy ( )
integer x = 146
integer y = 16
integer width = 5929
integer height = 1320
long backcolor = 67108864
string text = "Resultado"
long tabtextcolor = 33554432
string picturename = "anula_salida.ico"
long picturemaskcolor = 536870912
pb_insert pb_insert
pb_cerrar pb_cerrar
pb_save_resul pb_save_resul
dw_l dw_l
dw_res dw_res
dw_serving dw_serving
end type

on resul.create
this.pb_insert=create pb_insert
this.pb_cerrar=create pb_cerrar
this.pb_save_resul=create pb_save_resul
this.dw_l=create dw_l
this.dw_res=create dw_res
this.dw_serving=create dw_serving
this.Control[]={this.pb_insert,&
this.pb_cerrar,&
this.pb_save_resul,&
this.dw_l,&
this.dw_res,&
this.dw_serving}
end on

on resul.destroy
destroy(this.pb_insert)
destroy(this.pb_cerrar)
destroy(this.pb_save_resul)
destroy(this.dw_l)
destroy(this.dw_res)
destroy(this.dw_serving)
end on

type pb_insert from picturebutton within resul
integer x = 5623
integer y = 440
integer width = 146
integer height = 128
integer taborder = 100
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean enabled = false
boolean originalsize = true
string picturename = "editar.GIF"
string disabledname = "d_editar.GIF"
end type

event clicked;tab_1.tp_1.pb_cargar_res.event clicked()

end event

type pb_cerrar from picturebutton within resul
integer x = 5627
integer y = 292
integer width = 146
integer height = 128
integer taborder = 100
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean originalsize = true
string picturename = "cerrar.gif"
string disabledname = "d_cerrar.gif"
end type

event clicked;i_print=true
if i_fecha > tab_1.tp_2.dw_rescpo.getitemdatetime(1,"fecharesul") then
	messagebox("Atención","No se puede atender con fecha menor a la del ingreso")
	return 
end if

int l_i
if dw_res.getitemnumber(dw_res.getrow(),'nulos')>0 then
	for l_i= dw_res.rowcount() to 1 step -1
		if dw_res.getitemnumber(l_i,'si_nulo')=1 then
			dw_res.deleterow(l_i)
		end if
	next
end if

if dw_res.getitemnumber(dw_res.getrow(),'faltantes')>0 then
	messagebox("Atención","Faltan datos obligatorios")
	return 
end if

if tab_1.tp_2.tab_2.resul.pb_save_resul.event clicked()=-1 then 
	i_print=false
	return
end if
i_print=false

tab_1.tp_1.dw_procs.setitem(tab_1.tp_1.dw_procs.getrow(),'estado','7')
tab_1.tp_1.dw_procs.setitem(tab_1.tp_1.dw_procs.getrow(),'veri','1')
tab_1.tp_1.dw_procs.setitem(tab_1.tp_1.dw_procs.getrow(),'fecha_cierre',datetime(today(),now()))
if tab_1.tp_1.dw_procs.update(true,false)=-1 then //el rollback está en dberror
	tab_1.tp_1.dw_procs.setitem(tab_1.tp_1.dw_procs.getrow(),'estado','2')
	tab_1.tp_1.dw_procs.resetupdate()
	return
end if
commit;

string ls_proced, ls_clugarrec,ls_coddoc
double ldb_nrepor
for l_i= 1 to tab_1.tp_1.dw_procs.rowcount() 

	if tab_1.tp_1.dw_procs.getitemstring(l_i,'estado')='7' then
		ls_proced= tab_1.tp_1.dw_procs.getitemstring(l_i,'codproced')
	
		gf_validar_proc_diag_cohorte(&
			tipdoc,docu,w_principal.dw_1.getitemstring(1,'sexo'),&
			w_principal.dw_1.getitemnumber(1,'dias'),ls_proced,'',i_contador,i_clughis,'1')

	end if

	if not isnull(tab_1.tp_1.dw_procs.getitemstring(l_i,'ririas')) and tab_1.tp_1.dw_procs.getitemstring(l_i,'estado')='7'  and tab_1.tp_1.dw_procs.getitemstring(l_i,'veri')='1' then
		if is_202='1' then
			ldb_nrepor=tab_1.tp_1.dw_procs.getitemnumber(l_i,'nrepor') 
			ls_clugarrec=tab_1.tp_1.dw_procs.getitemstring(l_i,'clugar_res')
			ls_coddoc=tab_1.tp_1.dw_procs.getitemstring(l_i,'coddoc')
	
			gf_validar_202_apdx(	tipdoc,docu,w_principal.dw_1.getitemstring(1,'sexo'),&
				w_principal.dw_1.getitemnumber(1,'dias'),ls_proced,&
				tab_1.tp_1.dw_procs.getitemstring(l_i,'ririas'),&
				ls_coddoc,ldb_nrepor,ls_clugarrec,'1')	
				
			tab_1.tp_1.dw_procs.setitem(l_i,'veri','0')
		end if
	end if
next

tab_1.tp_1.dw_procs.resetupdate()
cambia_est(dw_res,'7')
end event

type pb_save_resul from picturebutton within resul
integer x = 5627
integer y = 144
integer width = 146
integer height = 128
integer taborder = 30
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean originalsize = true
string picturename = "guardar2.GIF"
end type

event clicked;if dw_res.accepttext()=-1 then return
if dw_res.rowcount()>0 then
	if dw_res.getitemstring(1,'estado')='7' then return
end if
string revisa
select ResultadosCab.Estado into :revisa from ResultadosCab
WHERE ResultadosCab.CodDoc=:i_cod_doc and clugar=:i_cluging
AND ResultadosCab.NRepor=:i_nrepor;
if not i_print then
	if revisa='2' then
		messagebox("Atención","Estos resultados ya fueron impresos, por lo tanto no los puede modificar")
		return -1
	end if
end if
if revisa='3' then
	messagebox("Atención","Estos resultados están anulados, por lo tanto no los puede modificar")
	return -1
end if
if i_fecha > tab_1.tp_2.dw_rescpo.getitemdatetime(1,"fecharesul") then
	messagebox("Atención","No se puede atender con fecha menor a la del ingreso")
	return -1
end if
if dw_res.rowcount()=0 then return -1
if tab_1.tp_2.dw_rescpo.getitemstring(1,"profesional")="" or isnull(tab_1.tp_2.dw_rescpo.getitemstring(1,"profesional")) then
	messagebox("Atención","Elija el profesional")
	return -1
end if
if dw_serving.getitemstring(1,"estado") = "2" then
	messagebox("Atención","Complete los datos de RIPS")
	return -1
end if

if tab_1.tp_2.dw_rescpo.update(true,false)=-1 then
	rollback;
	return -1
end if
if tab_1.tp_2.tab_2.resul.dw_res.getitemnumber(tab_1.tp_2.tab_2.resul.dw_res.getrow(),'faltantes')>0 then
	messagebox("Atención","Faltan datos obligatorios")
	return  -1
end if
dw_serving.setitem(1,"estria","1")
dw_serving.setitem(1,"cprof",tab_1.tp_2.dw_rescpo.getitemstring(1,"profesional"))
dw_serving.setitem(1,"fecha",tab_1.tp_2.dw_rescpo.getitemdatetime(1,"fecharesul"))
if dw_serving.update(true,false)=-1 then
	rollback;
	return -1
end if
if tab_1.tp_2.tab_2.resul.dw_res.update(true,false)=-1 then
	rollback;
	return -1
end if
tab_1.tp_1.dw_procs.setitem(tab_1.tp_1.dw_procs.getrow(),"estado","2")
if tab_1.tp_1.dw_procs.update(true,false)= -1 then
	rollback;
	return -1
else
	commit;
end if
int li=0,semanas=0,dias=0
double cohortes

cohortes=f_valida_usuario_cohorte_materna(tipdoc, docu)
if cohortes>0 then 
	datetime fechas
	tab_1.tp_2.tab_2.resul.dw_res.setfilter("eco<>'0'")
	tab_1.tp_2.tab_2.resul.dw_res.filter()
	for li=1 to tab_1.tp_2.tab_2.resul.dw_res.rowcount()
		if tab_1.tp_2.tab_2.resul.dw_res.getitemstring(li,'eco')='1' then
			fechas=tab_1.tp_2.tab_2.resul.dw_res.getitemdatetime(li,'fecha')
			UPDATE pacientes_cohortes SET fp_eco =:fechas
			WHERE (((tipodoc)=:tipdoc) AND ((documento)=:docu) AND ((id_cohorte_pac)=:cohortes)  AND ((pacientes_cohortes.fp_eco) is null));
		end if
		if tab_1.tp_2.tab_2.resul.dw_res.getitemstring(li,'eco')='2' then
			semanas=tab_1.tp_2.tab_2.resul.dw_res.getitemnumber(li,'resultado2')
			UPDATE pacientes_cohortes SET sgp_eco =:semanas
			WHERE (((tipodoc)=:tipdoc) AND ((documento)=:docu) AND ((id_cohorte_pac)=:cohortes) AND ((pacientes_cohortes.sgp_eco) is null));	
		end if
		if tab_1.tp_2.tab_2.resul.dw_res.getitemstring(li,'eco')='3' then
			dias=tab_1.tp_2.tab_2.resul.dw_res.getitemnumber(li,'resultado2')
			UPDATE pacientes_cohortes SET dgp_eco =:dias
			WHERE (((tipodoc)=:tipdoc) AND ((documento)=:docu) AND ((id_cohorte_pac)=:cohortes) AND ((pacientes_cohortes.dgp_eco) is null));	
		end if		
		if tab_1.tp_2.tab_2.resul.dw_res.getitemstring(li,'eco')='4' then
			fechas=tab_1.tp_2.tab_2.resul.dw_res.getitemdatetime(li,'fecha')
			UPDATE pacientes_cohortes SET fp_part =:fechas
			WHERE (((tipodoc)=:tipdoc) AND ((documento)=:docu) AND ((id_cohorte_pac)=:cohortes)  AND ((pacientes_cohortes.fp_part) is null));
		end if		
		if sqlca.sqlcode= -1 then
			messagebox("Error actualizando datos ecografia",sqlca.sqlerrtext)
			return -1
		end if		
	next
	commit;
	tab_1.tp_2.tab_2.resul.dw_res.setfilter('')
	tab_1.tp_2.tab_2.resul.dw_res.filter()
end if

tab_1.tp_2.dw_rescpo.resetupdate()
dw_serving.resetupdate()
cambia_est(dw_res,'2')
dw_res.resetupdate()
tab_1.tp_1.dw_procs.resetupdate()
pb_cerrar.enabled=true
end event

type dw_l from datawindow within resul
boolean visible = false
integer x = 5582
integer y = 36
integer width = 242
integer height = 76
integer taborder = 50
string title = "none"
string dataobject = "dw_pgclista"
boolean border = false
boolean livescroll = true
end type

event constructor;setTransObject(SQLCA)

end event

type dw_res from datawindow within resul
integer x = 14
integer y = 412
integer width = 5477
integer height = 892
integer taborder = 90
string title = "none"
string dataobject = "dw_xa_resul"
boolean hscrollbar = true
boolean vscrollbar = true
boolean border = false
boolean livescroll = true
end type

event constructor;settransobject(SQLCA)
end event

event itemchanged;long ll_rmin,ll_rmax,ll_item,ll_dias
string ls_codp,ls_sexo

AcceptText()
choose case dwo.name
	case 'resultado2'
		if not isnull(getitemnumber(row,'num_min')) and not isnull(getitemnumber(row,'num_max')) then
			if real(data)<getitemnumber(row,'num_min') or real(data)>getitemnumber(row,'num_max') then
				if messagebox('Atención','El valor no se encuentra dentro del Rango configurado, desea continuar aún así?',question!,yesno!,2)=2 then
					settext('')
					return 2
				end if
			end if
		end if
		ls_codp=getitemstring(row,'codproced')
		ll_item=getitemnumber(row,'item')
		if w_principal.dw_1.getitemstring(1,'sexo')='M' then ls_sexo='1'
		if w_principal.dw_1.getitemstring(1,'sexo')='F' then ls_sexo='2'
	
		ll_dias=w_principal.dw_1.getitemnumber(1,'dias')
		
		SELECT 
			ref_min, ref_max into :ll_rmin,:ll_rmax
		FROM
			valornormal
		WHERE 
			(((valornormal.codproced)=:ls_codp) AND ((valornormal.conse_campo)=:ll_item) 
			AND ((valornormal.sexo) in('0',:ls_sexo)) AND (:ll_dias>= (valornormal.edad_min)) 
			AND (:ll_dias <=(valornormal.edad_max)) 
			AND ((valornormal.estado)='1'));
			
		setitem(row,'ref_min',ll_rmin)
		setitem(row,'ref_max',ll_rmax)
		
		int copia_cmp,filas
		string edi
		setnull(copia_cmp)
		copia_cmp=getitemnumber(row,'consecampo')
		setnull(copia_cmp)
		
		copia_cmp=getitemnumber(row,'consecampo_cop')
		edi=getitemstring(row,'edi')
		if not isnull(copia_cmp) and edi='1' then
			filas=dw_res.find("consecampo="+string(copia_cmp),1,dw_res.rowcount())
			if filas>0 then
				if getitemnumber(filas,'resultado2')=0 then
					setitem(filas,'resultado2',real(data))
				end if
			end if
		end if		
AcceptText()
end choose
end event

event rowfocuschanging;if newrow<1 then return
if getItemString(newrow,'tipocampo') = '4' then
	string valor, modifica = "resultado4.values='"
	int i
	dw_l.Retrieve(GetItemString(newrow,'codproced'),GetItemNumber(newrow,'consecampo'))
	for i = 1 to dw_l.RowCount()
		valor = dw_l.GetItemString(i,'nombre')
		if not isNull(valor) and valor<>'' then
			modifica = modifica+valor+"~t"+valor+"/"
		end if
	next	
	Modify(modifica + "'")
end if
end event

event buttonclicked;string ls_formula,ls_column,ls_result,l_sex,l_pedazo,f_ant1
long j,fin,k,fila,l_numcampo,jp,fp
decimal ld_valor
int fila_ant,li_cipa,li_csis,li_duf,li_frf,li_fru,li_verd

if dwo.name<>'b_vref' then
	if dwo.name='b_for' then
		dw_res.SetRedraw(false)
		f_ant1 =dw_res.describe("datawindow.table.filter")
		ls_formula=this.getitemstring(row,'formula')
	
		l_numcampo=this.getitemnumber(row,'consecampo')
		fila_ant=row
		j=pos(ls_formula,'#',1)
		dw_res.setfilter("")
		dw_res.Filter( )
		do while j>0
			fin=len(ls_formula) +1
			k=pos(ls_formula,',',j+1)
			if k<fin and k<>0 then fin=k
			k=pos(ls_formula,'/',j+1)
			if k<fin and k<>0 then fin=k
			k=pos(ls_formula,'=',j+1)
			if k<fin and k<>0 then fin=k
			k=pos(ls_formula,'D',j+1)
			if k<fin and k<>0 then fin=k
			k=pos(ls_formula,'*',j+1)
			if k<fin and k<>0 then fin=k
			k=pos(ls_formula,'-',j+1)
			if k<fin and k<>0 then fin=k
			k=pos(ls_formula,'+',j+1)
			if k<fin and k<>0 then fin=k
			k=pos(ls_formula,'(',j+1)
			if k<fin and k<>0 then fin=k
			k=pos(ls_formula,')',j+1)
			if k<fin and k<>0 then fin=k
			k=pos(ls_formula,'"',j+1)
			if k<fin and k<>0 then fin=k
			k=pos(ls_formula,'if',j+1)
			if k<fin and k<>0 then fin=k+2
			k=pos(ls_formula,'edad',j+1)
			if k<fin and k<>0 then fin=k+4
			k=pos(ls_formula,'sexo',j+1)
			if k<fin and k<>0 then fin=k+4
			k=pos(ls_formula,'plantilla',j+1)
			if k<fin and k<>0 then fin=k+9
			k=pos(ls_formula,'campo',j+1)
			if k<fin and k<>0 then fin=k+5
			ls_column=mid(ls_formula,j,fin - j)
			ls_column=mid(ls_column,2)
			fila= dw_res.find('consecampo='+ls_column,1,dw_res.rowcount())
			if fila<0 then return
			if this.getitemstring(fila,'tipocampo') ='8' then 
				ls_formula=mid(ls_formula,1, j - 1 )+'date("'+string(dw_res.getitemdatetime(fila ,'fecha'),'dd/mm/yyyy')+'")'+mid(ls_formula,fin)
			Else
				setnull(ld_valor)
				if fila<> 0 then
					ld_valor=dw_res.getitemnumber(fila ,'resultado2')	
				 end if
				if isnull(ld_valor) then ld_valor=0 
				ls_formula=mid(ls_formula,1, j - 1 )+string(ld_valor)+mid(ls_formula,fin)
			End If
			j=pos(ls_formula,'#',1)
		loop
		if f_ant1<>'?' then 
			dw_res.setfilter(f_ant1)
			dw_res.Filter( )
			dw_res.SetRedraw(true)
		end if
	
		if  getitemstring(row,'tipocampo')='9' or getitemstring(row,'tipocampo')='10' then
			ls_result=describe("evaluate('"+ls_formula+"',0)")
			if getitemstring(row,'tipocampo')='9' then setitem(row,'fecha',date(ls_result))
			if getitemstring(row,'tipocampo')='10' then setitem(row,'resultado2',dec(ls_result))
		end if
		fila= dw_res.find('consecampo='+ls_column,1,dw_res.rowcount())
		if fila<= 0 then  return
		dw_res.SetRedraw(true)
		dw_res.scrolltorow(row) 
	else
		AcceptText()
	
		st_rte st
		st.c_prof =tab_1.tp_2.dw_rescpo.getitemstring(1,"profesional")
		st.dw_pac = w_principal.dw_1
		st.empresa=getitemstring(row,'resultado3')
		st.codplantilla=tab_1.tp_1.dw_procs.getitemstring(tab_1.tp_1.dw_procs.getrow(),"cod_cups")
		st.c_otro=dw_res.getitemstring(1,'estado')
		st.numcampo=getitemnumber(row,'consecampo')
		st.ventana = 'A'
		openwithparm(w_edita_campo_apdx,st)
		if message.stringparm='!' then return
		if dw_res.getitemstring(1,'estado')<>'7' then
			setitem(row,'resultado3',message.stringparm)
		end if
	end if
Else
	string ls_sexo
	if dw_res.rowcount()>0 then
		if dw_res.getitemstring(1,'estado')='7' then return
	end if
	
	open(w_val_norm)
	if w_principal.dw_1.getitemstring(1,"sexo")='M' then
		ls_sexo='1'
	else
		ls_sexo='2'
	end if
	w_val_norm.dw_1.retrieve(getitemstring(row,'codproced'),getitemnumber(row,'consecampo'),ls_sexo,w_principal.dw_1.getitemnumber(1,"dias"))
	w_val_norm.st_1.text='1'
	w_val_norm.setfocus()
End if
end event

type dw_serving from datawindow within resul
event type integer insertar ( )
integer x = 14
integer y = 16
integer width = 5371
integer height = 396
integer taborder = 80
string title = "none"
string dataobject = "dw_estad_rip_cext"
boolean border = false
boolean livescroll = true
end type

event type integer insertar();long fila
fila=tab_1.tp_1.dw_procs.getrow()
if tab_1.tp_1.dw_procs.getitemstring(fila,'clugar')<>clugar then
	messagebox("Atención","No hay resultados para ese documento, y no los puede crear porque son de un lugar diferente")
	return -1
end if
insertrow(1)
setitem(1,"ambitoproced",'1')

setitem(1,"contador",w_apoyo_diag2.i_contador)
setitem(1,"clugar",w_apoyo_diag2.i_clughis)
setitem(1,"cproced",tab_1.tp_1.dw_procs.getitemstring(fila,'codproced'))
setitem(1,"finalidadproced",tab_1.tp_1.dw_procs.getitemstring(fila,'TipoProc'))

setitem(1,"cemp",tab_1.tp_1.dw_procs.getitemstring(fila,'cemp'))
setitem(1,"ccontrato",tab_1.tp_1.dw_procs.getitemstring(fila,'ccontrato'))
setitem(1,"cplan",tab_1.tp_1.dw_procs.getitemstring(fila,'cplan'))
setitem(1,"facturar",tab_1.tp_1.dw_procs.getitemnumber(fila,'facturar'))

setitem(1,"cprocedeq",tab_1.tp_1.dw_procs.getitemstring(fila,'cprocedeq'))
setitem(1,"cmanual",tab_1.tp_1.dw_procs.getitemstring(fila,'cmanual'))

setitem(1,"rips",tab_1.tp_1.dw_procs.getitemstring(fila,'ria'))
setitem(1,"cufuncional",tab_1.tp_1.dw_procs.getitemstring(fila,'cufuncional'))
setitem(1,"cccosto",tab_1.tp_1.dw_procs.getitemstring(fila,'cccosto'))
select max(nservicio) into :i_nserving from serviciosingreso 
where contador=:w_apoyo_diag2.i_contador and clugar=:w_apoyo_diag2.i_clughis;
if sqlca.sqlcode=-1 then
	messagebox("Error leyendo serviciosIngreso",sqlca.sqlerrtext)
	return -1
end if
if isnull(i_nserving) then i_nserving=0
i_nserving++
setitem(1,"nservicio",i_nserving)
setitem(1,"cantidad",1)
setitem(1,"estria",'1')
setitem(1,"nfactura",tab_1.tp_1.dw_procs.getitemnumber(fila,'nfact'))
setitem(1,"nitem_fac",tab_1.tp_1.dw_procs.getitemnumber(fila,'nitem'))
setitem(1,"clugar_fac",tab_1.tp_1.dw_procs.getitemstring(fila,'clugar_fac'))
setitem(1,"tipo_fac",tab_1.tp_1.dw_procs.getitemstring(fila,'tipo_fac'))
setitem(1,"nrcaj",tab_1.tp_1.dw_procs.getitemnumber(fila,'nrcaj'))
setitem(1,"clugar_rec",tab_1.tp_1.dw_procs.getitemstring(fila,'clugar_rec'))
setitem(1,"nitem_rec",tab_1.tp_1.dw_procs.getitemnumber(fila,'nitem_rec'))
setitem(1,"items",tab_1.tp_1.dw_procs.getitemnumber(fila,'nitem_rec'))
setitem(1,"usuario",usuario)
setitem(1,"nautoriza",tab_1.tp_1.dw_procs.getitemstring(fila,'autorizacion'))
setitem(1,"fecha",datetime(today(),now()))
setitem(1,"conta_orden",tab_1.tp_1.dw_procs.getitemnumber(fila,'contador_os'))
setitem(1,"clug_orden",tab_1.tp_1.dw_procs.getitemstring(fila,'clugar_os'))
setitem(1,"norden_serv",tab_1.tp_1.dw_procs.getitemnumber(fila,'nsolicitud_os'))
setitem(1,"item_orden",tab_1.tp_1.dw_procs.getitemnumber(fila,'item_os'))

long ncita,nservcita,seccantcita,nfact,nitemfc,nrec,itemrec,nitemrec,conta_os,norden,nitem_os
string clugfac,clugrec,clug_os,clug_cita,tipofac,ls_dx

setnull(ls_dx)
if i_tipoing<>'1' then
	select diagingre into :ls_dx
	from hospadmi
	where (((contador)=:w_apoyo_diag2.i_contador) and ((clugar_his)=:w_apoyo_diag2.i_clughis));
	if sqlca.sqlcode=-1 then
		messagebox("Error en interface Hospadmin",sqlca.sqlerrtext)
		return -1
	end if
else
	nfact=tab_1.tp_1.dw_procs.getitemnumber(fila,'nfact')
	clugfac=tab_1.tp_1.dw_procs.getitemstring(fila,'clugar_fac')
	tipofac=tab_1.tp_1.dw_procs.getitemstring(fila,'tipo_fac')
	nitemfc=tab_1.tp_1.dw_procs.getitemnumber(fila,'nitem')
	select oscabeza.codgeral into :ls_dx
	from oscuerpo inner join oscabeza on (oscuerpo.nsolicitud = oscabeza.nsolicitud) and (oscuerpo.clugar = oscabeza.clugar) and (oscuerpo.contador = oscabeza.contador)
	where (((oscuerpo.nfact)=:nfact) and ((oscuerpo.clugar_fact)=:clugfac) and ((oscuerpo.tipo_fact)=:tipofac) and ((oscuerpo.nitem_fact)=:nitemfc));
	if sqlca.sqlcode=-1 then
		messagebox("Error en interface oscuerpo",sqlca.sqlerrtext)
		return -1
	end if
end if
if not isnull(ls_dx) or ls_dx<>'' then 
	setitem(1,"diagprin", ls_dx)
end if
if update()=-1 then return -1

// ------------------------ C O H O R T E S -------------------------
setnull(ls_dx)
gf_validar_proc_diag_cohorte(&
	tipdoc,docu,w_principal.dw_1.getitemstring(1,'sexo'),&
	w_principal.dw_1.getitemnumber(1,'dias'),tab_1.tp_1.dw_procs.getitemstring(fila,'codproced'),ls_dx,w_apoyo_diag2.i_contador ,w_apoyo_diag2.i_clughis,'0')

// ------------------------ C O H O R T E S -------------------------


///////////////////// C A N A S T A S
st_xa_canastas st
st.cproc=tab_1.tp_1.dw_procs.getitemstring(fila,'codproced')
st.sexo=w_principal.dw_1.getitemstring(1,'sexo')
st.edad_dias=w_principal.dw_1.getitemnumber(1,'dias')
st.dw_canasta=dw_canasta
st.dw_lote=dw_lote
st.contador=i_contador
st.clugar=i_clughis
st.nserv=i_nserving
st.alm=i_alm
openwithparm(w_canasta_articulo,st)
if message.stringparm='!' then return -1
if message.stringparm<>'NI' then i_cambio_insumo=TRUE
/////////////////////    F I N     C A N A S T A S

ncita=tab_1.tp_1.dw_procs.getitemnumber(fila,'ncita')
nservcita=tab_1.tp_1.dw_procs.getitemnumber(fila,'nservicio')
seccantcita=tab_1.tp_1.dw_procs.getitemnumber(fila,'sec_cant_cita')
clug_cita=tab_1.tp_1.dw_procs.getitemstring(fila,'clugar_cita')
if not isnull(ncita) and not isnull(nservcita) and not isnull(seccantcita) then
	update serciosturno set contador=:w_apoyo_diag2.i_contador ,clugar_ser=:w_apoyo_diag2.i_clughis, 
	nservicio_ingreso=:i_nserving
	where ncita=:ncita and clugar=:clug_cita and nservicio=:nservcita and 
	sec_cant=:seccantcita;
	if sqlca.sqlcode=-1 then 
		messagebox("Error en interface con citas",sqlca.sqlerrtext)
		return -1
	end if
end if
nfact=tab_1.tp_1.dw_procs.getitemnumber(fila,'nfact')
clugfac=tab_1.tp_1.dw_procs.getitemstring(fila,'clugar_fac')
tipofac=tab_1.tp_1.dw_procs.getitemstring(fila,'tipo_fac')
nitemfc=tab_1.tp_1.dw_procs.getitemnumber(fila,'nitem')
if not isnull(nfact) and not isnull(nitemfc) then
	update factcpo set contador=:w_apoyo_diag2.i_contador , clugar_ser=:w_apoyo_diag2.i_clughis,
	nservicio=:i_nserving
	where nfact=:nfact and nitem=:nitemfc and clugar=:clugfac and tipo=:tipofac;
	if sqlca.sqlcode=-1 then 
		messagebox("Error en interface con Facturación",sqlca.sqlerrtext)
		return -1
	end if
end if
nrec=tab_1.tp_1.dw_procs.getitemnumber(fila,'nrcaj')
itemrec=tab_1.tp_1.dw_procs.getitemnumber(fila,'items')
nitemrec=tab_1.tp_1.dw_procs.getitemnumber(fila,'nitem_rec')
clugrec=tab_1.tp_1.dw_procs.getitemstring(fila,'clugar_rec')
if not isnull(nrec) and not isnull(itemrec) and not isnull(nitemrec) then
	update tesoredetalle set contador=:w_apoyo_diag2.i_contador,clugar_his=:w_apoyo_diag2.i_clughis 
	where nrcaj=:nrec and clugar=:clugrec and items=:itemrec and nitem=:nitemrec;
	if sqlca.sqlcode=-1 then 
		messagebox("Error en interface de con Recibos de Caja",sqlca.sqlerrtext)
		return -1
	end if
end if

conta_os=tab_1.tp_1.dw_procs.getitemnumber(fila,'contador_os')
norden=tab_1.tp_1.dw_procs.getitemnumber(fila,'nsolicitud_os')
clug_os=tab_1.tp_1.dw_procs.getitemstring(fila,'clugar_os')
nitem_os=tab_1.tp_1.dw_procs.getitemnumber(fila,'item_os')
long solic,sumin,j
if not isnull(conta_os) and not isnull(norden) and not isnull(nitem_os) then
	SELECT Count(ServiciosADX.Item) INTO :sumin
	FROM ServiciosADX INNER JOIN ResultadosCpo ON (ServiciosADX.Item = ResultadosCpo.Item) AND (ServiciosADX.NRepor = ResultadosCpo.NRepor) AND (ServiciosADX.clugar_res = ResultadosCpo.clugar) AND (ServiciosADX.CodDoc = ResultadosCpo.CodDoc)
	WHERE ServiciosADX.contador_os=:conta_os AND ServiciosADX.clugar_os=:clug_os AND 
	ServiciosADX.Nsolicitud_os=:norden AND ServiciosADX.item_os=:nitem_os;
	if sqlca.sqlcode=-1 then
		messagebox("Error en interface de con Ordenes de Servicio(count serviciosadx.item)",sqlca.sqlerrtext)
		return -1
	end if
	select solicitada into :solic from oscuerpo 
	where contador=:conta_os and clugar=:clug_os and nsolicitud=:norden and item=:nitem_os;
	if sqlca.sqlcode=-1 then
		messagebox("Error leyendo en interface de con Ordenes de Servicio",sqlca.sqlerrtext)
		return -1
	end if
	if sumin>=solic then
		update oscuerpo set estado='2' 
		where contador=:conta_os and clugar=:clug_os and nsolicitud=:norden and item=:nitem_os;
		if sqlca.sqlcode=-1 then 
			messagebox("Error en interface de con Ordenes de Servicio (actualizando estado)",sqlca.sqlerrtext)
			return -1
		end if
	end if
	select count(item) into :j from oscuerpo
	where contador=:conta_os and clugar=:clug_os and nsolicitud=:norden and estado='1';
	if sqlca.sqlcode=-1 then
		messagebox("Error en interface de con Ordenes de Servicio (count item )",sqlca.sqlerrtext)
		return -1
	end if
	if j=0 then 
		update oscabeza set estado='2' 
		where contador=:conta_os and clugar=:clug_os and nsolicitud=:norden ;
		if sqlca.sqlcode=-1 then
			messagebox("Error actualizando estado de orden de servicio",sqlca.sqlerrtext)
			return -1
		end if
		if isvalid(w_new_at_os) then w_new_at_os.dw_historial.triggerevent(rowfocuschanged!)
	end if
end if
if isvalid(w_new_at_os) then w_new_at_os.uo_1.dw_oscab.triggerevent(rowfocuschanged!)
if isvalid(w_new_sala_qx) then w_new_sala_qx.tab_servicios.tabpage_1.dw_serv_ing.triggerevent(rowfocuschanged!)
retrieve(i_contador,i_clughis,i_nserving)
return 1
end event

event constructor;settransobject(SQLCA)
object.pa_todos.visible=false
object.desdiag.y = 216
object.desdiag.width=2167
object.remite.visible=false
object.view_estado.y=216
object.gb_1.visible=false
object.t_2.y=292

end event

event doubleclicked;string colu,pedazo
colu=dwo.name
pedazo=right(colu,4)
choose case colu
	case 'codrip_prin','codrip_rel1','codrip_rel2','codrip_comp'
		if getcolumnname()<>dwo.name then return
		st_edadsexo st_es
		st_es.edad=w_principal.dw_1.getitemnumber(1,'dias')
		st_es.sexo=w_principal.dw_1.getitemstring(1,'sexo')
		st_es.antece='0'
		if getitemstring(getrow(),'rips')='1' then
			st_es.proced='0'
		else
			st_es.proced='1'
		end if		
		openwithparm(w_busca_diag,st_es)
		st_diag st_diag
		st_diag=message.powerobjectparm
		if not isvalid(st_diag) then return
		setitem(1,'diag'+pedazo,st_diag.codgeral)
		setitem(1,'codrip_'+pedazo,st_diag.codrip)
		setitem(1,'desdiag_'+pedazo,st_diag.descripcion)
		setitem(1,'desdiag',st_diag.descripcion)
end choose
accepttext()
end event

event itemchanged;choose case getcolumnname()
	case 'codrip_prin','codrip_rel1','codrip_rel2','codrip_comp'
		string este,pedazo
		st_return_diags st
		
		pedazo=right(getcolumnname(),4)
		if trim(gettext())<>'' then
			st=f_check_diag(trim(gettext()),w_principal.dw_1.getitemstring(1,'sexo'),w_principal.dw_1.getitemnumber(1,'dias'),este,'0',this.getitemstring(row,'rips'),'0')
			if st.descrip_diag='' then
				settext(getitemstring(1,getcolumnname()))
				return 1
			end if
			setitem(1,'desdiag_'+pedazo,st.descrip_diag)
			setitem(1,'diag'+pedazo,este)
			setitem(1,'desdiag',st.descrip_diag)
		else
			string nulo
			setnull(nulo)
			setitem(1,'desdiag_'+pedazo,nulo)
			setitem(1,'diag'+pedazo,nulo)
			setitem(1,'desdiag',nulo)
		end if
end choose
accepttext()
end event

event itemfocuschanged;if row<1 or rowcount()<1 then return
choose case dwo.name
	case 'codrip_prin'
		setitem(1,'desdiag',getitemstring(1,'desdiag_prin'))
	case 'codrip_rel1'
		setitem(1,'desdiag',getitemstring(1,'desdiag_rel1'))
	case 'codrip_rel2'
		setitem(1,'desdiag',getitemstring(1,'desdiag_rel2'))
	case 'codrip_comp'
		setitem(1,'desdiag',getitemstring(1,'desdiag_comp'))
end choose
end event

type procesa from userobject within tab_2
integer x = 146
integer y = 16
integer width = 5929
integer height = 1320
long backcolor = 67108864
string text = " Procesamiento"
long tabtextcolor = 33554432
string picturename = "notas_adm.ico"
long picturemaskcolor = 536870912
pb_sevn pb_sevn
pb_deln pb_deln
pb_insn pb_insn
dw_notas dw_notas
end type

on procesa.create
this.pb_sevn=create pb_sevn
this.pb_deln=create pb_deln
this.pb_insn=create pb_insn
this.dw_notas=create dw_notas
this.Control[]={this.pb_sevn,&
this.pb_deln,&
this.pb_insn,&
this.dw_notas}
end on

on procesa.destroy
destroy(this.pb_sevn)
destroy(this.pb_deln)
destroy(this.pb_insn)
destroy(this.dw_notas)
end on

type pb_sevn from picturebutton within procesa
integer x = 5765
integer y = 312
integer width = 146
integer height = 128
integer taborder = 19
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Small Fonts"
boolean originalsize = true
string picturename = "guardar2.GIF"
alignment htextalign = right!
end type

event clicked;if f_permiso_boton(this,'APDX')=0 then return
if tab_1.tp_1.dw_procs.getitemstring(tab_1.tp_1.dw_procs.getrow(),"estado")<>"1" then 
	messagebox("Atención",'Esta producto ya se encuentra atendido. No la puede modificar')
	return 
end if
if dw_notas.update(true,false)=-1 then
	rollback;
	return 
end if
commit;
tab_1.tp_2.tab_2.procesa.dw_notas.retrieve(i_cluging,i_codarea,i_ningreso,i_nservadx)
end event

type pb_deln from picturebutton within procesa
integer x = 5765
integer y = 172
integer width = 146
integer height = 128
integer taborder = 30
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Small Fonts"
boolean originalsize = true
string picturename = "anulardoc.gif"
alignment htextalign = right!
end type

event clicked;if f_permiso_boton(this,'APDX')=0 then return
 if tab_1.tp_1.dw_procs.getitemstring(tab_1.tp_1.dw_procs.getrow(),"estado")<>"1" then 
	messagebox("Atención",'Esta admisión ya se encuentra cerrada. No la puede modificar')
	return 
end if

If messageBox('Atención','Está seguro de querer cambiar el estado de la observación ?',question!,yesno!,2) = 2 then Return 

long ldb_ning,ldb_item,ldb_nproc,ldb_fila
string ls_cling

ldb_fila=dw_notas.getrow()

ls_cling=dw_notas.getitemstring(ldb_fila,"clugar")
ldb_ning=dw_notas.getitemnumber(ldb_fila,"ningreso")
ldb_nproc=dw_notas.getitemnumber(ldb_fila,"nproced")
ldb_item=dw_notas.getitemnumber(ldb_fila,"item")

st_xa_anular st_anula
st_anula.tipo='AX'
openwithparm (w_motiv_anula,st_anula)
st_anula=message.powerobjectparm
if not isValid(st_anula) then return
datetime fec_anu
fec_anu=datetime(today(),now())
update serviciosadx_notas set estado='2',fecha_anula =:fec_anu,motiv_anula=:st_anula.observacion,cod_anula=:st_anula.motivo,usu_anula =:usuario
WHERE (((clugar)=:ls_cling) AND ((codaadx)=:i_codarea) AND ((ningreso)=:ldb_ning) AND ((nproced)=:ldb_nproc) AND ((item)=:ldb_item));
if sqlca.sqlcode=-1 then 
	messagebox("Error actualizando el estado de serviciosadx_notas",sqlca.sqlerrtext)
	rollback;
	RETURN
end if
commit;
dw_notas.ReselectRow(ldb_fila) 
end event

type pb_insn from picturebutton within procesa
integer x = 5765
integer y = 32
integer width = 146
integer height = 128
integer taborder = 100
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Small Fonts"
boolean originalsize = true
string picturename = "insertar.GIF"
alignment htextalign = right!
end type

event clicked;if f_permiso_boton(this,'APDX')=0 then return
if tab_1.tp_1.dw_procs.rowcount()<1 then return
if w_principal.dw_1.getitemstring(1,'estado')='1' then
  messagebox("Atención","Este Paciente esta Fallecido no puede adicionar Observaciones")
  return
end if
double ldb_fila
ldb_fila=tab_1.tp_1.dw_procs.getrow()

if tab_1.tp_1.dw_procs.getitemstring(ldb_fila,"estado")<>"1" then 
	messagebox("Atención",'Esta admisión ya se encuentra cerrada. No la puede modificar')
	return -1
end if
int maximo,fila
maximo=dw_notas.getitemnumber(1,'totales')
if isnull(maximo) then maximo=0
maximo++
fila=dw_notas.insertrow(0)
dw_notas.setitem(fila,"clugar",tab_1.tp_1.dw_procs.getitemstring(ldb_fila,"clugar"))
dw_notas.setitem(fila,"codaadx",i_codarea)
dw_notas.setitem(fila,"ningreso",tab_1.tp_1.dw_procs.getitemnumber(ldb_fila,"ningreso"))
dw_notas.setitem(fila,"nproced",tab_1.tp_1.dw_procs.getitemnumber(ldb_fila,"nproced"))
dw_notas.setitem(fila,"item",maximo)
dw_notas.Setitem(fila,"Usuario",usuario)
dw_notas.setitem(fila,"fecha",datetime(today(),time(string(now()))))
end event

type dw_notas from datawindow within procesa
integer x = 59
integer y = 36
integer width = 5669
integer height = 1244
integer taborder = 80
string title = "none"
string dataobject = "dw_serviciosadx_notas"
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;settransobject(SQLCA)

end event

type tp_3 from userobject within tab_1
integer x = 18
integer y = 112
integer width = 6130
integer height = 1508
long backcolor = 67108864
string text = "Imágenes"
long tabtextcolor = 33554432
string picturename = "rx.ico"
long picturemaskcolor = 536870912
string powertiptext = "Si el Área permite Imágenes, se muestran las del procedimeinto seleccionado"
pb_print_img pb_print_img
dw_imagenes dw_imagenes
pb_edit_imag pb_edit_imag
pb_save_imag pb_save_imag
pb_del_imag pb_del_imag
st_cuantos st_cuantos
pb_imag pb_imag
pb_3 pb_3
dw_lista2 dw_lista2
pb_4 pb_4
end type

on tp_3.create
this.pb_print_img=create pb_print_img
this.dw_imagenes=create dw_imagenes
this.pb_edit_imag=create pb_edit_imag
this.pb_save_imag=create pb_save_imag
this.pb_del_imag=create pb_del_imag
this.st_cuantos=create st_cuantos
this.pb_imag=create pb_imag
this.pb_3=create pb_3
this.dw_lista2=create dw_lista2
this.pb_4=create pb_4
this.Control[]={this.pb_print_img,&
this.dw_imagenes,&
this.pb_edit_imag,&
this.pb_save_imag,&
this.pb_del_imag,&
this.st_cuantos,&
this.pb_imag,&
this.pb_3,&
this.dw_lista2,&
this.pb_4}
end on

on tp_3.destroy
destroy(this.pb_print_img)
destroy(this.dw_imagenes)
destroy(this.pb_edit_imag)
destroy(this.pb_save_imag)
destroy(this.pb_del_imag)
destroy(this.st_cuantos)
destroy(this.pb_imag)
destroy(this.pb_3)
destroy(this.dw_lista2)
destroy(this.pb_4)
end on

type pb_print_img from picturebutton within tp_3
integer x = 4992
integer y = 524
integer width = 146
integer height = 128
integer taborder = 90
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
string picturename = "print2.gif"
alignment htextalign = left!
string powertiptext = "Imprimir Imagenes"
end type

event clicked;if tab_1.tp_2.dw_rescpo.rowcount()=0 then
	dw_imagenes.setfilter('')
	dw_imagenes.filter()
	dw_imagenes.setredraw(true)
	return
end if

string file_pdf
int li_f

dw_imagenes.setredraw(false)
dw_imagenes.setfilter("impr=1" )
dw_imagenes.filter()

for li_f=1 to dw_imagenes.rowcount()
	if upper(dw_imagenes.getitemstring(li_f,'extension'))='PDF' then 
		file_pdf=gs_pdf+' '+dw_imagenes.getitemstring(li_f,'url_imagen')
		run(file_pdf,maximized!)
	else
		long Job
		Job = PrintOpen( )
		PrintBitmap(Job, dw_imagenes.getitemstring(li_f,'url_imagen'), 500,500, 0,0)
		PrintClose(Job)
	end if
	dw_imagenes.setitem(li_f,'impr',0)
next
dw_imagenes.setfilter('')
dw_imagenes.filter()
dw_imagenes.setredraw(true)
end event

type dw_imagenes from datawindow within tp_3
integer x = 9
integer y = 128
integer width = 4942
integer height = 1364
integer taborder = 19
string title = "none"
string dataobject = "dw_resultados_imagen"
boolean border = false
boolean livescroll = true
end type

event constructor;settransobject(sqlca)

end event

event rowfocuschanged;if upper(dw_imagenes.getitemstring(dw_imagenes.getrow(),'extension'))='PDF' then 
	tab_1.tp_3.pb_edit_imag.enabled=false
else
	tab_1.tp_3.pb_edit_imag.enabled=true
end if
end event

type pb_edit_imag from picturebutton within tp_3
integer x = 4992
integer y = 668
integer width = 146
integer height = 128
integer taborder = 20
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean originalsize = true
string picturename = "buscar2.gif"
string disabledname = "d_buscar2.gif"
alignment htextalign = left!
string powertiptext = "Ver / Editar Imagen"
end type

event clicked;if dw_imagenes.rowcount()=0 then  return 
st_edita_imag st
int i_nobjs,regi,numarc
blob objs

regi=tab_1.tp_3.dw_imagenes.getitemnumber(dw_imagenes.getrow(),'nro_imag')
st.ruta=tab_1.tp_3.dw_imagenes.getitemstring(dw_imagenes.getrow(),'url_imagen')
st.nobjs=tab_1.tp_3.dw_imagenes.getitemnumber(dw_imagenes.getrow(),'nro_notas')
selectblob comentario into :objs from resultadosimag 
where coddoc=:i_cod_doc and clugar=:i_cluging and nrepor=:i_nrepor and item=:i_itemcpo and nro_imag=:regi;
st.objetos=objs
openwithparm(w_muestra_imag,st)
st=message.powerobjectparm
i_nobjs=st.nobjs
if i_nobjs>0 then
	tab_1.tp_3.dw_imagenes.setitem(dw_imagenes.getrow(),'nro_notas',i_nobjs)
	tab_1.tp_3.dw_imagenes.update()
	updateblob resultadosimag set comentario=:objs where
	coddoc=:i_cod_doc and clugar=:i_cluging and nrepor=:i_nrepor and item=:i_itemcpo and nro_imag=:regi;
	if sqlca.sqlcode=-1 then
		messagebox("Error Actualizando ResultadosImag",sqlca.sqlerrtext)
		rollback;
		return
	end if
	
	commit;

else
	setnull(st.objetos)
end if

end event

type pb_save_imag from picturebutton within tp_3
integer x = 4992
integer y = 384
integer width = 146
integer height = 128
integer taborder = 20
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
string picturename = "guardar.gif"
alignment htextalign = left!
string powertiptext = "Guardar Imágenes"
end type

event clicked;if tab_1.tp_2.dw_rescpo.rowcount()=0 then return
string  l_rutao,l_rutad,ls_path_pac
integer li_f
ls_path_pac =l_repositorios+'\'+tipdoc+docu
IF not FileExists(ls_path_pac) THEN 
	li_f=CreateDirectory ( ls_path_pac ) 
	If li_f<>1 then 
		MessageBox(" Atencion","No pudo crear directorio en Repositorio") 
		return
	End If
End if
dw_imagenes.setfilter("impr=2" )
dw_imagenes.filter()
for li_f=1 to dw_imagenes.rowcount()
	l_rutad=l_repositorios+'\'+tipdoc+docu+'\'+dw_imagenes.getitemstring(li_f,'nombre_imagen')
	l_rutao= dw_imagenes.getitemstring(li_f,'rutao')
 	If FileCopy (l_rutao,l_rutad,TRUE)<0 then	
		 messagebox('Alerta','Error copiando archivo  '+l_rutao)
		continue
	else
		//  FileDelete(l_rutao)
	end if
next

If dw_imagenes.update()=-1 then
	rollback;
End if
commit;
dw_imagenes.setfilter('')
dw_imagenes.filter()
dw_imagenes.retrieve(tab_1.tp_1.dw_procs.getitemstring(tab_1.tp_1.dw_procs.getrow(),'coddoc'),tab_1.tp_1.dw_procs.getitemstring(tab_1.tp_1.dw_procs.getrow(),'clugar'),tab_1.tp_1.dw_procs.getitemnumber(tab_1.tp_1.dw_procs.getrow(),'nrepor'),tab_1.tp_1.dw_procs.getitemnumber(tab_1.tp_1.dw_procs.getrow(),'item'))


end event

type pb_del_imag from picturebutton within tp_3
integer x = 4992
integer y = 244
integer width = 146
integer height = 128
integer taborder = 20
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
string picturename = "borrar_fila.gif"
alignment htextalign = left!
string powertiptext = "Borrar Imagen"
end type

event clicked;dw_imagenes.deleterow(0);
end event

type st_cuantos from statictext within tp_3
integer x = 3136
integer y = 12
integer width = 1152
integer height = 68
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
alignment alignment = center!
boolean border = true
borderstyle borderstyle = stylelowered!
boolean focusrectangle = false
end type

type pb_imag from picturebutton within tp_3
integer x = 4992
integer y = 104
integer width = 146
integer height = 128
integer taborder = 40
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean originalsize = true
string picturename = "llevar.gif"
alignment htextalign = left!
string powertiptext = "Cargar Imágenes"
end type

event clicked;if tab_1.tp_2.dw_rescpo.rowcount()=0 then
	messagebox("Atención",'No se han capturado los resultados del examen, no puede adicionar imágenes')
	return
end if
if idw_area.getitemstring(idw_area.getrow(),'imagen')='0' then
	messagebox("Atención",'El área de Apoyo Diagnóstico no se encuentra configurada para manejar imágenes')
	return
end if

int ret,cuantos,i,maximos,fila
string ls_path_pac,docname[],docpath

ls_path_pac =l_repositorios+'\'+tipdoc+docu
maximos=dw_imagenes.getitemnumber(1,'maximos')
if isnull(maximos) then maximos=0
maximos=maximos+1

ret = GetFileOpenName("Escoger Imágenes", docpath, docname[],"JPG","JPEG Files (*.JPG),*.JPG, PDF Files (*.PDF),*.PDF")
IF ret < 1 THEN return
cuantos= Upperbound(docname)
if cuantos=0 then return
if cuantos>1 then
	for i=1 to cuantos
		fila=dw_imagenes.insertrow(0)
		dw_imagenes.setitem(fila,'coddoc',i_cod_doc)
		dw_imagenes.setitem(fila,'clugar',i_cluging)
		dw_imagenes.setitem(fila,'nrepor',i_nrepor)
		dw_imagenes.setitem(fila,'item',i_itemcpo)
		dw_imagenes.setitem(fila,'nro_imag',maximos)
		dw_imagenes.setitem(fila,'extension',right(docname[i],3))
		dw_imagenes.setitem(fila,'nombre_imagen',docname[i])
		dw_imagenes.setitem(fila,'url_imagen',l_repositorios+'\'+tipdoc+docu+'\'+docname[i])
		dw_imagenes.setitem(fila,'impr',2)
		dw_imagenes.setitem(fila,'rutao',docpath+'\'+docname[i])
		maximos=maximos+1
	next
else
	fila=dw_imagenes.insertrow(0)
	dw_imagenes.setitem(fila,'coddoc',i_cod_doc)
	dw_imagenes.setitem(fila,'clugar',i_cluging)
	dw_imagenes.setitem(fila,'nrepor',i_nrepor)
	dw_imagenes.setitem(fila,'item',i_itemcpo)
	dw_imagenes.setitem(fila,'nro_imag',maximos)
	dw_imagenes.setitem(fila,'extension',right(docname[1],3))
	dw_imagenes.setitem(fila,'nombre_imagen',docname[1])
	dw_imagenes.setitem(fila,'url_imagen',l_repositorios+'\'+tipdoc+docu+'\'+docname[1])
	dw_imagenes.setitem(fila,'rutao',docpath)
	dw_imagenes.setitem(fila,'impr',2)
end if
end event

type pb_3 from picturebutton within tp_3
integer width = 146
integer height = 128
integer taborder = 10
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean originalsize = true
string picturename = "atras.gif"
alignment htextalign = left!
string powertiptext = "Anterior Procedimiento"
end type

event clicked;tab_1.tp_1.dw_procs.scrollpriorrow()
end event

type dw_lista2 from datawindow within tp_3
integer x = 110
integer width = 2254
integer height = 116
integer taborder = 20
string title = "none"
string dataobject = "dw_drop_servadx"
boolean border = false
boolean livescroll = true
end type

event constructor;getchild('nproced',idw_lista2)
idw_lista2.settransobject(sqlca)
insertrow(1)
end event

event itemchanged;accepttext()
tab_1.tp_1.dw_procs.scrolltorow(idw_lista2.getrow())
end event

type pb_4 from picturebutton within tp_3
integer x = 2377
integer width = 146
integer height = 128
integer taborder = 30
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean originalsize = true
string picturename = "adelante_1.gif"
alignment htextalign = left!
string powertiptext = "Siguiente Procedimiento"
end type

event clicked;tab_1.tp_1.dw_procs.scrollnextrow()
end event

type dw_mvto_cpo from datawindow within w_apoyo_diag2
string tag = "tabla: sum_mvto_cpo"
boolean visible = false
integer x = 663
integer y = 72
integer width = 155
integer height = 68
integer taborder = 70
boolean bringtotop = true
string title = "none"
string dataobject = "dw_sum_mvto_cpo_costos"
boolean hscrollbar = true
boolean vscrollbar = true
boolean resizable = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;settransobject(sqlca)
end event

event dberror;return f_dw_error(sqldbcode,sqlerrtext,sqlsyntax,dataobject)
end event

type dw_lote from datawindow within w_apoyo_diag2
string tag = "tabla: sum_lote_mov"
boolean visible = false
integer x = 2926
integer y = 16
integer width = 82
integer height = 48
integer taborder = 130
boolean bringtotop = true
string title = "none"
string dataobject = "dw_mov_lote_item"
boolean hscrollbar = true
boolean vscrollbar = true
boolean resizable = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;settransobject(sqlca)
end event

event dberror;return f_dw_error(sqldbcode,sqlerrtext,sqlsyntax,dataobject)
end event


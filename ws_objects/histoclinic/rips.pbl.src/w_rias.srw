$PBExportHeader$w_rias.srw
forward
global type w_rias from window
end type
type dw_electronica from uo_datawindow within w_rias
end type
type gb_1 from groupbox within w_rias
end type
type gb_4 from groupbox within w_rias
end type
type dw_getar from datawindow within w_rias
end type
type dw_temp from datawindow within w_rias
end type
type dw_det_lote from datawindow within w_rias
end type
type dw_export from datawindow within w_rias
end type
type dw_trae from datawindow within w_rias
end type
type rb_10 from radiobutton within w_rias
end type
type rb_9 from radiobutton within w_rias
end type
type dw_tipin from datawindow within w_rias
end type
type tab_2 from tab within w_rias
end type
type tp2_1 from userobject within tab_2
end type
type rb_json from radiobutton within tp2_1
end type
type rb_txt from radiobutton within tp2_1
end type
type cbx_7 from checkbox within tp2_1
end type
type cbx_at from checkbox within tp2_1
end type
type cbx_6 from checkbox within tp2_1
end type
type cbx_5 from checkbox within tp2_1
end type
type cbx_2 from checkbox within tp2_1
end type
type t1 from tab within tp2_1
end type
type tp1 from userobject within t1
end type
type dw_ria from datawindow within tp1
end type
type cbx_replica from checkbox within tp1
end type
type st_10 from statictext within tp1
end type
type st_2 from statictext within tp1
end type
type st_3 from statictext within tp1
end type
type st_4 from statictext within tp1
end type
type st_5 from statictext within tp1
end type
type st_6 from statictext within tp1
end type
type pb_buscar from picturebutton within tp1
end type
type st_cuantos from statictext within tp1
end type
type st_11 from statictext within tp1
end type
type stt_diag from statictext within tp1
end type
type rb_completo from radiobutton within tp1
end type
type rb_incompleto from radiobutton within tp1
end type
type rb_todos from radiobutton within tp1
end type
type barra from hprogressbar within tp1
end type
type cbx_1 from checkbox within tp1
end type
type em_21 from editmask within tp1
end type
type sle_7 from singlelineedit within tp1
end type
type rb_2 from radiobutton within tp1
end type
type rb_1 from radiobutton within tp1
end type
type pb_ayuda from picturebutton within tp1
end type
type pb_guardar from picturebutton within tp1
end type
type pb_trae from picturebutton within tp1
end type
type drop_tipo from dropdownlistbox within tp1
end type
type st_7 from statictext within tp1
end type
type gb_6 from groupbox within tp1
end type
type gb_3 from groupbox within tp1
end type
type gb_2 from groupbox within tp1
end type
type st_tdoc from statictext within tp1
end type
type st_docu from statictext within tp1
end type
type st_paciente from statictext within tp1
end type
type st_sexo from statictext within tp1
end type
type st_edad from statictext within tp1
end type
type st_nfact from statictext within tp1
end type
type dw_1 from datawindow within tp1
end type
type em_11 from editmask within tp1
end type
type sle_6 from singlelineedit within tp1
end type
type tp1 from userobject within t1
dw_ria dw_ria
cbx_replica cbx_replica
st_10 st_10
st_2 st_2
st_3 st_3
st_4 st_4
st_5 st_5
st_6 st_6
pb_buscar pb_buscar
st_cuantos st_cuantos
st_11 st_11
stt_diag stt_diag
rb_completo rb_completo
rb_incompleto rb_incompleto
rb_todos rb_todos
barra barra
cbx_1 cbx_1
em_21 em_21
sle_7 sle_7
rb_2 rb_2
rb_1 rb_1
pb_ayuda pb_ayuda
pb_guardar pb_guardar
pb_trae pb_trae
drop_tipo drop_tipo
st_7 st_7
gb_6 gb_6
gb_3 gb_3
gb_2 gb_2
st_tdoc st_tdoc
st_docu st_docu
st_paciente st_paciente
st_sexo st_sexo
st_edad st_edad
st_nfact st_nfact
dw_1 dw_1
em_11 em_11
sle_6 sle_6
end type
type fac from userobject within t1
end type
type pb_7 from picturebutton within fac
end type
type dw_fact from datawindow within fac
end type
type fac from userobject within t1
pb_7 pb_7
dw_fact dw_fact
end type
type tmod from userobject within t1
end type
type dw_mod from datawindow within tmod
end type
type tmod from userobject within t1
dw_mod dw_mod
end type
type tp2 from userobject within t1
end type
type pb_4 from picturebutton within tp2
end type
type dw_act_final from datawindow within tp2
end type
type tp2 from userobject within t1
pb_4 pb_4
dw_act_final dw_act_final
end type
type t1 from tab within tp2_1
tp1 tp1
fac fac
tmod tmod
tp2 tp2
end type
type rb_4 from radiobutton within tp2_1
end type
type rb_3 from radiobutton within tp2_1
end type
type tab_1 from tab within tp2_1
end type
type tp_1 from userobject within tab_1
end type
type cbx_4 from checkbox within tp_1
end type
type pb_2 from picturebutton within tp_1
end type
type pb_1 from picturebutton within tp_1
end type
type em_2 from editmask within tp_1
end type
type st_9 from statictext within tp_1
end type
type em_1 from editmask within tp_1
end type
type st_8 from statictext within tp_1
end type
type dw_empresa from datawindow within tp_1
end type
type pb_3 from picturebutton within tp_1
end type
type st_1 from statictext within tp_1
end type
type cbx_activos from checkbox within tp_1
end type
type mle_objeto from multilineedit within tp_1
end type
type dw_contgenera from datawindow within tp_1
end type
type tp_1 from userobject within tab_1
cbx_4 cbx_4
pb_2 pb_2
pb_1 pb_1
em_2 em_2
st_9 st_9
em_1 em_1
st_8 st_8
dw_empresa dw_empresa
pb_3 pb_3
st_1 st_1
cbx_activos cbx_activos
mle_objeto mle_objeto
dw_contgenera dw_contgenera
end type
type tp_p from userobject within tab_1
end type
type rb_16 from radiobutton within tp_p
end type
type rb_15 from radiobutton within tp_p
end type
type rb_14 from radiobutton within tp_p
end type
type dw_facturas from datawindow within tp_p
end type
type st_19 from statictext within tp_p
end type
type dw_radica from datawindow within tp_p
end type
type tab_3 from tab within tp_p
end type
type det from userobject within tab_3
end type
type pb_diacc from picturebutton within det
end type
type pb_8 from picturebutton within det
end type
type pb_diac from picturebutton within det
end type
type pb_anula from picturebutton within det
end type
type pb_dian from picturebutton within det
end type
type pb_radvi from picturebutton within det
end type
type dw_det from datawindow within det
end type
type det from userobject within tab_3
pb_diacc pb_diacc
pb_8 pb_8
pb_diac pb_diac
pb_anula pb_anula
pb_dian pb_dian
pb_radvi pb_radvi
dw_det dw_det
end type
type nota from userobject within tab_3
end type
type pb_impnota from picturebutton within nota
end type
type pb_connota from picturebutton within nota
end type
type pb_gnota from picturebutton within nota
end type
type pb_brr from picturebutton within nota
end type
type pb_diann from picturebutton within nota
end type
type pb_insn from picturebutton within nota
end type
type dw_nc from datawindow within nota
end type
type nota from userobject within tab_3
pb_impnota pb_impnota
pb_connota pb_connota
pb_gnota pb_gnota
pb_brr pb_brr
pb_diann pb_diann
pb_insn pb_insn
dw_nc dw_nc
end type
type tab_3 from tab within tp_p
det det
nota nota
end type
type tp_p from userobject within tab_1
rb_16 rb_16
rb_15 rb_15
rb_14 rb_14
dw_facturas dw_facturas
st_19 st_19
dw_radica dw_radica
tab_3 tab_3
end type
type tab_1 from tab within tp2_1
tp_1 tp_1
tp_p tp_p
end type
type rb_defecto from radiobutton within tp2_1
end type
type cb_dir from commandbutton within tp2_1
end type
type gb_8 from groupbox within tp2_1
end type
type gb_5 from groupbox within tp2_1
end type
type sle_dir from singlelineedit within tp2_1
end type
type gb_12 from groupbox within tp2_1
end type
type tp2_1 from userobject within tab_2
rb_json rb_json
rb_txt rb_txt
cbx_7 cbx_7
cbx_at cbx_at
cbx_6 cbx_6
cbx_5 cbx_5
cbx_2 cbx_2
t1 t1
rb_4 rb_4
rb_3 rb_3
tab_1 tab_1
rb_defecto rb_defecto
cb_dir cb_dir
gb_8 gb_8
gb_5 gb_5
sle_dir sle_dir
gb_12 gb_12
end type
type tp2_3 from userobject within tab_2
end type
type pb_6 from picturebutton within tp2_3
end type
type pb_5 from picturebutton within tp2_3
end type
type sle_ant from singlelineedit within tp2_3
end type
type cb_2 from commandbutton within tp2_3
end type
type rb_13 from radiobutton within tp2_3
end type
type cbx_12 from checkbox within tp2_3
end type
type cbx_11 from checkbox within tp2_3
end type
type cbx_10 from checkbox within tp2_3
end type
type cbx_9 from checkbox within tp2_3
end type
type cbx_8 from checkbox within tp2_3
end type
type rb_12 from radiobutton within tp2_3
end type
type rb_11 from radiobutton within tp2_3
end type
type dw_radica_ant from datawindow within tp2_3
end type
type dw_empre from datawindow within tp2_3
end type
type em_6 from editmask within tp2_3
end type
type em_5 from editmask within tp2_3
end type
type st_21 from statictext within tp2_3
end type
type gb_10 from groupbox within tp2_3
end type
type gb_11 from groupbox within tp2_3
end type
type tp2_3 from userobject within tab_2
pb_6 pb_6
pb_5 pb_5
sle_ant sle_ant
cb_2 cb_2
rb_13 rb_13
cbx_12 cbx_12
cbx_11 cbx_11
cbx_10 cbx_10
cbx_9 cbx_9
cbx_8 cbx_8
rb_12 rb_12
rb_11 rb_11
dw_radica_ant dw_radica_ant
dw_empre dw_empre
em_6 em_6
em_5 em_5
st_21 st_21
gb_10 gb_10
gb_11 gb_11
end type
type tp2_2 from userobject within tab_2
end type
type cbx_3 from checkbox within tp2_2
end type
type rb_6 from radiobutton within tp2_2
end type
type rb_5 from radiobutton within tp2_2
end type
type pb_lote from picturebutton within tp2_2
end type
type st_18 from statictext within tp2_2
end type
type st_17 from statictext within tp2_2
end type
type sle_log from singlelineedit within tp2_2
end type
type st_16 from statictext within tp2_2
end type
type cb_1 from commandbutton within tp2_2
end type
type st_15 from statictext within tp2_2
end type
type sle_sale from singlelineedit within tp2_2
end type
type rb_tod from radiobutton within tp2_2
end type
type rb_activ from radiobutton within tp2_2
end type
type st_14 from statictext within tp2_2
end type
type dw_cont from datawindow within tp2_2
end type
type st_13 from statictext within tp2_2
end type
type dw_emp from datawindow within tp2_2
end type
type st_12 from statictext within tp2_2
end type
type em_4 from editmask within tp2_2
end type
type em_3 from editmask within tp2_2
end type
type gb_7 from groupbox within tp2_2
end type
type gb_9 from groupbox within tp2_2
end type
type tp2_2 from userobject within tab_2
cbx_3 cbx_3
rb_6 rb_6
rb_5 rb_5
pb_lote pb_lote
st_18 st_18
st_17 st_17
sle_log sle_log
st_16 st_16
cb_1 cb_1
st_15 st_15
sle_sale sle_sale
rb_tod rb_tod
rb_activ rb_activ
st_14 st_14
dw_cont dw_cont
st_13 st_13
dw_emp dw_emp
st_12 st_12
em_4 em_4
em_3 em_3
gb_7 gb_7
gb_9 gb_9
end type
type tab_2 from tab within w_rias
tp2_1 tp2_1
tp2_3 tp2_3
tp2_2 tp2_2
end type
type rb_7 from radiobutton within w_rias
end type
type rb_8 from radiobutton within w_rias
end type
type dw_lug from datawindow within w_rias
end type
end forward

global type w_rias from window
integer width = 7008
integer height = 2700
boolean titlebar = true
string title = "Generador de RIPS"
boolean controlmenu = true
boolean minbox = true
boolean maxbox = true
boolean resizable = true
windowtype windowtype = child!
long backcolor = 67108864
string icon = "rips.ico"
dw_electronica dw_electronica
gb_1 gb_1
gb_4 gb_4
dw_getar dw_getar
dw_temp dw_temp
dw_det_lote dw_det_lote
dw_export dw_export
dw_trae dw_trae
rb_10 rb_10
rb_9 rb_9
dw_tipin dw_tipin
tab_2 tab_2
rb_7 rb_7
rb_8 rb_8
dw_lug dw_lug
end type
global w_rias w_rias

type variables
datawindowchild idw_contrato,idw_emp,gc_regimen
long i_NRO_DIG,i_numarc,l_dec_fact
string is_anterior,is_orden,is_concatena_fac,is_decual,is_capiv='0',is_repo_rips
string is_rips_cd,is_elec, is_objeto
boolean ibn_paso=false
uo_report i_rep
end variables

forward prototypes
public subroutine cuenta ()
public function integer genera_forecat (long p_nrad, string p_clug_rad, datetime p_fecha_fin, boolean p_faltan)
public function integer lf_genera_act_final (long p_nrad, string p_clug_rad)
public function integer genera_furips (double p_nrad, string p_clug_rad, datetime p_fecha_fin, boolean p_faltan, string p_tipo_rad)
public function st_nradica lf_trae_ndoc (string p_decual, string p_cdoc)
public function long f_rips (boolean p_faltan, long p_nradica, string p_clug_rad, datawindow p_dw_conts, string p_decual, boolean p_cups, long p_cero, string p_por_lugar, string p_reserva, string p_tipo_rad)
end prototypes

public subroutine cuenta ();tab_2.tp2_1.t1.tp1.st_cuantos.text=string(tab_2.tp2_1.t1.tp1.dw_ria.rowcount())+" registro(s)"

end subroutine

public function integer genera_forecat (long p_nrad, string p_clug_rad, datetime p_fecha_fin, boolean p_faltan);string nom_arch,docname,real_name[3]
long j,i,nro_regs[3]
boolean hubo=false
////////////////////// AA
dw_trae.dataobject="dr_forecat_aa"
dw_trae.settransobject(sqlca)
if dw_trae.retrieve(p_nrad,p_clug_rad,p_fecha_fin)>0 then
	nro_regs[1]=dw_trae.rowcount()
	hubo=true
	dw_export.dataobject="dr_export_forecat_aa"
	for j=1 to dw_trae.rowcount()
		i=dw_export.insertrow(0)
		dw_export.setitem(i,'c_ips',dw_trae.getitemstring(j,'c_supersalud'))
		dw_export.setitem(i,'tdoc',dw_trae.getitemstring(j,'tipodoc'))
		dw_export.setitem(i,'docu',dw_trae.getitemstring(j,'documento'))
		dw_export.setitem(i,'ape1',dw_trae.getitemstring(j,'apellido1'))
		dw_export.setitem(i,'ape2',dw_trae.getitemstring(j,'apellido2'))
		dw_export.setitem(i,'nom1',dw_trae.getitemstring(j,'nombre1'))
		dw_export.setitem(i,'nom2',dw_trae.getitemstring(j,'nombre2'))
		dw_export.setitem(i,'edad',string(dw_trae.getitemnumber(j,'edad')))
		dw_export.setitem(i,'umed_ed',dw_trae.getitemstring(j,'u_med'))
		dw_export.setitem(i,'sexo',dw_trae.getitemstring(j,'sexo'))
		dw_export.setitem(i,'cdepto',dw_trae.getitemstring(j,'cdepto'))
		dw_export.setitem(i,'cod_ciudad',dw_trae.getitemstring(j,'cciudad'))
		dw_export.setitem(i,'tel',right(dw_trae.getitemstring(j,'tel'),9))
		dw_export.setitem(i,'natura',dw_trae.getitemstring(j,'naturaleza'))
		dw_export.setitem(i,'sitio',dw_trae.getitemstring(j,'sitio'))
		dw_export.setitem(i,'fecha',string(dw_trae.getitemdatetime(j,'fecha'),'dd/mm/yyyy'))
		dw_export.setitem(i,'hora',string(dw_trae.getitemdatetime(j,'fecha'),'HH:mm'))
		dw_export.setitem(i,'cdepto_evento',dw_trae.getitemstring(j,'cdepto_even'))
		dw_export.setitem(i,'ciudad_evento',dw_trae.getitemstring(j,'codciudad_even'))
		dw_export.setitem(i,'zona',dw_trae.getitemstring(j,'zona'))
		dw_export.setitem(i,'informe',left(dw_trae.getitemstring(j,'informe'),255))
	next
	nom_arch="AA"+string(p_nrad)
	docname=nom_arch
//	//if tab_2.tp2_1.rb_names.checked then//preguntar una a uno
//		//docname es el largo y nom_arc el solo archivito
//		if GetFileSaveName("Archivo de Accidentes o Eventos ("+nom_arch+")",docname, nom_arch, "txt", "Archivos de Texto (*.txt),*.txt" )<>1 then
//			if p_faltan then messagebox("Atención",'Aún así se generó la radicación Nro:'+string(p_nrad))
//			return 0
//		end if
	//else//mandarlos todos al directorio
		docname=tab_2.tp2_1.sle_dir.text+'\'+nom_arch+'.txt'
		nom_arch+='.txt'
//	end if
	if dw_export.saveas(docname,CSV!,false)=-1 then
		if p_faltan then
			Messagebox("Error guardando archivo de usuarios","No se puede guardar el archivo, revise el espacio o el estado del disco.~r~nLa radiciación generará aún así.")
		else
			Messagebox("Error guardando archivo de usuarios","No se puede guardar el archivo, revise el espacio o el estado del disco.")
		end if
	else
		f_quita_espacio_rips(docname)
	end if
	real_name[1]=mid(nom_arch,1,len(nom_arch) -4)
end if
////////////////////// fin AA
////////////////////// VH
dw_trae.dataobject="dr_forecat_vh"
dw_trae.settransobject(sqlca)
if dw_trae.retrieve(p_nrad,p_clug_rad)>0 then
	nro_regs[2]=dw_trae.rowcount()
	hubo=true
	dw_export.dataobject="dr_export_forecat_vh"
	for j=1 to dw_trae.rowcount()
		i=dw_export.insertrow(0)
		dw_export.setitem(i, 'c_ips',dw_trae.getitemstring(j, 'c_supersalud'))
		dw_export.setitem(i, 'tdoc',dw_trae.getitemstring(j, 'tipodoc'))
		dw_export.setitem(i, 'documento',dw_trae.getitemstring(j, 'documento'))
		dw_export.setitem(i, 'asegurado',dw_trae.getitemstring(j, 'asegurado'))
		dw_export.setitem(i, 'marca',dw_trae.getitemstring(j, 'marca'))
		dw_export.setitem(i, 'placa',dw_trae.getitemstring(j, 'placa_acc'))
		if lower(dw_trae.getitemstring(j, 'tipo_vehi'))='campero' then
			dw_export.setitem(i, 'clase','cp')
		else
			dw_export.setitem(i, 'clase',lower(left(dw_trae.getitemstring(j, 'tipo_vehi'),2)))
		end if
		dw_export.setitem(i, 'seguro',dw_trae.getitemstring(j, 'nombre_seguro'))
		dw_export.setitem(i, 'poliza',dw_trae.getitemstring(j, 'npoliza'))
		dw_export.setitem(i, 'fecha_pol',string(dw_trae.getitemdatetime(j, 'desde'),'dd/mm/yyyy'))
		dw_export.setitem(i, 'fecha_fin_pol',string(dw_trae.getitemdatetime(j, 'fecha_termina'),'dd/mm/yyyy'))
		dw_export.setitem(i, 'ape1_prop',dw_trae.getitemstring(j, 'ape1_prop'))
		dw_export.setitem(i, 'ape2_prop',dw_trae.getitemstring(j, 'ape2_prop'))
		dw_export.setitem(i, 'nom1_prop',dw_trae.getitemstring(j, 'nom1_prop'))
		dw_export.setitem(i, 'nom2_prop',dw_trae.getitemstring(j, 'nom2_prop'))
		dw_export.setitem(i, 'tdoc_prop',dw_trae.getitemstring(j, 'tdoc_prop'))
		dw_export.setitem(i, 'docu_prop',dw_trae.getitemstring(j, 'docu_prop'))
		dw_export.setitem(i, 'cdepto_prop',dw_trae.getitemstring(j, 'depart_prop'))
		dw_export.setitem(i, 'ciudad_prop',dw_trae.getitemstring(j, 'ciudad_prop'))
		dw_export.setitem(i, 'direcc_prop',dw_trae.getitemstring(j, 'direcc_prop'))
		dw_export.setitem(i, 'tel_prop',right(dw_trae.getitemstring(j, 'tel_prop'),9))
		dw_export.setitem(i, 'ape1_cond',dw_trae.getitemstring(j, 'apellidos_cond'))
		dw_export.setitem(i, 'ape2_cond',dw_trae.getitemstring(j, 'ape2_cond'))
		dw_export.setitem(i, 'nom1_cond',dw_trae.getitemstring(j, 'nombres_cond'))
		dw_export.setitem(i, 'nom2_cond',dw_trae.getitemstring(j, 'nom2_cond'))
		dw_export.setitem(i, 'tdoc_cond',dw_trae.getitemstring(j, 'tdoc_cond'))
		dw_export.setitem(i, 'docu_cond',dw_trae.getitemstring(j, 'docu_cond'))
		dw_export.setitem(i, 'cdepto_cond',dw_trae.getitemstring(j, 'depart_cond'))
		dw_export.setitem(i, 'ciudad_cond',dw_trae.getitemstring(j, 'ciudad_cond'))
		dw_export.setitem(i, 'direcc_cond',dw_trae.getitemstring(j, 'direcc_cond'))
		dw_export.setitem(i, 'tel_cond',right(dw_trae.getitemstring(j, 'tel_cond'),9))
	next
	nom_arch="VH"+string(p_nrad)
	docname=nom_arch
//	if tab_2.tp2_1.rb_names.checked then//preguntar una a uno
//		//docname es el largo y nom_arc el solo archivito
//		if GetFileSaveName("Archivo de Vehículos("+nom_arch+")",docname, nom_arch, "txt", "Archivos de Texto (*.txt),*.txt" )<>1 then
//			if p_faltan then messagebox("Atención",'Aún así se generó la radicación Nro:'+string(p_nrad))
//			return 0
//		end if
//	else//mandarlos todos al directorio
		docname=tab_2.tp2_1.sle_dir.text+'\'+nom_arch+'.txt'
		nom_arch+='.txt'
//	end if
	if dw_export.saveas(docname,CSV!,false)=-1 then
		if p_faltan then
			Messagebox("Error guardando archivo de vehículos","No se puede guardar el archivo, revise el espacio o el estado del disco.~r~nLa radiciación generará aún así.")
		else
			Messagebox("Error guardando archivo de vehículos","No se puede guardar el archivo, revise el espacio o el estado del disco.")
		end if
	else
		f_quita_espacio_rips(docname)
	end if
	real_name[2]=mid(nom_arch,1,len(nom_arch) -4)
end if
////////////////////// fin VH
////////////////////// AV
dw_trae.dataobject="dr_forecat_av"
dw_trae.settransobject(sqlca)
if dw_trae.retrieve(p_nrad,p_clug_rad)>0 then
	nro_regs[3]=dw_trae.rowcount()
	hubo=true
	dw_export.dataobject="dr_export_forecat_av"
	for j=1 to dw_trae.rowcount()
		i=dw_export.insertrow(0)
		dw_export.setitem(i, 'c_ips',dw_trae.getitemstring(j, 'c_supersalud'))
		dw_export.setitem(i, 'tdoc',dw_trae.getitemstring(j, 'tipodoc'))
		dw_export.setitem(i, 'docu',dw_trae.getitemstring(j, 'documento'))
		dw_export.setitem(i, 'fecha_aten',string(dw_trae.getitemdatetime(j, 'fecha_aten'),'dd/mm/yyyy'))
		dw_export.setitem(i, 'cod_cons',dw_trae.getitemstring(j, 'cproced'))
		if isnull(dw_trae.getitemstring(j, 'diag_prin')) then
			dw_export.setitem(i, 'ding',dw_trae.getitemstring(j, 'diag_c')) //el de consulta externa en serviciosingreso
			dw_export.setitem(i, 'degr',dw_trae.getitemstring(j, 'diag_c'))
		else
			dw_export.setitem(i, 'ding',dw_trae.getitemstring(j, 'diag_prin'))
			dw_export.setitem(i, 'degr',dw_trae.getitemstring(j, 'diag_egr'))
		end if
		dw_export.setitem(i, 'valor_cons',string(dw_trae.getitemnumber(j, 'vproced'),'######'))
//		dw_export.setitem(i, 'cod_proc',dw_trae.getitemstring(j, 'cproc'))
		dw_export.setitem(i, 'cod_proc',dw_trae.getitemstring(j, 'cod_cups'))
		dw_export.setitem(i, 'cant_proc',string(dw_trae.getitemnumber(j, 'cant_procs'),'###'))
		dw_export.setitem(i, 'v_procs',string(dw_trae.getitemnumber(j, 'vl_procs'),'######'))
		dw_export.setitem(i, 't_medica',dw_trae.getitemstring(j, 'tmedica'))
		dw_export.setitem(i, 'c_medica',dw_trae.getitemstring(j, 'c_medica'))
		dw_export.setitem(i, 'nom_medica',dw_trae.getitemstring(j, 'medica'))
		dw_export.setitem(i, 'forma_farma',dw_trae.getitemstring(j, 'forma_farma'))
		dw_export.setitem(i, 'concent',dw_trae.getitemstring(j, 'conc_med'))
		dw_export.setitem(i, 'umed',dw_trae.getitemstring(j, 'u_med'))
		dw_export.setitem(i, 'cant_medi',string(dw_trae.getitemnumber(j, 'cant_med'),'########'))
		dw_export.setitem(i, 'vtot_med',string(dw_trae.getitemnumber(j, 'vtot_med'),'########'))
		dw_export.setitem(i, 't_serv',dw_trae.getitemstring(j, 't_serv'))
		dw_export.setitem(i, 'cant_otr',string(dw_trae.getitemnumber(j, 'canti_ot'),'###'))
		dw_export.setitem(i, 'vtot_otr',string(dw_trae.getitemnumber(j, 'vtot_otr'),'########'))
		dw_export.setitem(i, 'nfact',string(dw_trae.getitemnumber(j, 'nfact'),'########'))
		dw_export.setitem(i, 'fecha_fact',string(dw_trae.getitemdatetime(j, 'fecha'),'dd/mm/yyyy'))
		dw_export.setitem(i, 'vtot_fact',string(dw_trae.getitemnumber(j, 'vt_factu'),'#######'))
	next
	nom_arch="AV"+string(p_nrad)
	docname=nom_arch
//	if tab_2.tp2_1.rb_names.checked then//preguntar una a uno
//		//docname es el largo y nom_arc el solo archivito
//		if GetFileSaveName("Archivo de Atención de la víctima ("+nom_arch+")",docname, nom_arch, "txt", "Archivos de Texto (*.txt),*.txt" )<>1 then
//			if p_faltan then messagebox("Atención",'Aún así se generó la radicación Nro:'+string(p_nrad))
//			return 0
//		end if
//	else//mandarlos todos al directorio
		docname=tab_2.tp2_1.sle_dir.text+'\'+nom_arch+'.txt'
		nom_arch+='.txt'
//	end if
	if dw_export.saveas(docname,CSV!,false)=-1 then
		if p_faltan then
			Messagebox("Error guardando archivo de Atención de la víctima","No se puede guardar el archivo, revise el espacio o el estado del disco.~r~nLa radiciación generará aún así.")
		else
			Messagebox("Error guardando archivo de Atención de la víctima","No se puede guardar el archivo, revise el espacio o el estado del disco.")
		end if
	else
		f_quita_espacio_rips(docname)
	end if
	real_name[3]=mid(nom_arch,1,len(nom_arch) -4)
end if
////////////////////// fin AV
if hubo then
	dw_trae.dataobject='dr_forecat_ac'
	dw_trae.settransobject(sqlca)
	dw_trae.retrieve(p_nrad,p_clug_rad)
	dw_export.dataobject='dr_export_forecat_ac'
	if nro_regs[1]>0 then
		dw_export.insertrow(1)
		dw_export.setitem(1,'razon_soc',dw_trae.getitemstring(1,'nombre'))
		dw_export.setitem(1,'c_ips',dw_trae.getitemstring(1,'c_supersalud'))
		dw_export.setitem(1,'nit',dw_trae.getitemstring(1,'documento'))
		dw_export.setitem(1,'fechaini',string(dw_trae.getitemdatetime(1,'fecha_inicial'),'dd/mm/yyyy'))
		dw_export.setitem(1,'fechafin',string(dw_trae.getitemdatetime(1,'fecha_final'),'dd/mm/yyyy'))
		dw_export.setitem(1,'fecha_envio',string(dw_trae.getitemdatetime(1,'fecha_radica'),'dd/mm/yyyy'))
		dw_export.setitem(1,'nombre',real_name[1])
		dw_export.setitem(1,'total_reg',string(nro_regs[1]))
	end if
	if nro_regs[2]>0 then
		dw_export.insertrow(1)
		dw_export.setitem(1,'razon_soc',dw_trae.getitemstring(1,'nombre'))
		dw_export.setitem(1,'c_ips',dw_trae.getitemstring(1,'c_supersalud'))
		dw_export.setitem(1,'nit',dw_trae.getitemstring(1,'documento'))
		dw_export.setitem(1,'fechaini',string(dw_trae.getitemdatetime(1,'fecha_inicial'),'dd/mm/yyyy'))
		dw_export.setitem(1,'fechafin',string(dw_trae.getitemdatetime(1,'fecha_final'),'dd/mm/yyyy'))
		dw_export.setitem(1,'fecha_envio',string(dw_trae.getitemdatetime(1,'fecha_radica'),'dd/mm/yyyy'))
		dw_export.setitem(1,'nombre',real_name[2])
		dw_export.setitem(1,'total_reg',string(nro_regs[2]))
	end if
	if nro_regs[3]>0 then
		dw_export.insertrow(1)
		dw_export.setitem(1,'razon_soc',dw_trae.getitemstring(1,'nombre'))
		dw_export.setitem(1,'c_ips',dw_trae.getitemstring(1,'c_supersalud'))
		dw_export.setitem(1,'nit',dw_trae.getitemstring(1,'documento'))
		dw_export.setitem(1,'fechaini',string(dw_trae.getitemdatetime(1,'fecha_inicial'),'dd/mm/yyyy'))
		dw_export.setitem(1,'fechafin',string(dw_trae.getitemdatetime(1,'fecha_final'),'dd/mm/yyyy'))
		dw_export.setitem(1,'fecha_envio',string(dw_trae.getitemdatetime(1,'fecha_radica'),'dd/mm/yyyy'))
		dw_export.setitem(1,'nombre',real_name[3])
		dw_export.setitem(1,'total_reg',string(nro_regs[3]))
	end if
	nom_arch="AC"+string(p_nrad)
	docname=nom_arch
//	if tab_2.tp2_1.rb_names.checked then//preguntar una a uno
//		//docname es el largo y nom_arc el solo archivito
//		if GetFileSaveName("Archivo de Control ("+nom_arch+")",docname, nom_arch, "txt", "Archivos de Texto (*.txt),*.txt" )<>1 then
//			if p_faltan then messagebox("Atención",'Aún así se generó la radicación Nro:'+string(p_nrad))
//			return 0
//		end if
//	else//mandarlos todos al directorio
		docname=tab_2.tp2_1.sle_dir.text+'\'+nom_arch+'.txt'
		nom_arch+='.txt'
//	end if
	if dw_export.saveas(docname,CSV!,false)=-1 then
		if p_faltan then
			Messagebox("Error guardando archivo de Control","No se puede guardar el archivo, revise el espacio o el estado del disco.~r~nLa radiciación generará aún así.")
		else
			Messagebox("Error guardando archivo de Control","No se puede guardar el archivo, revise el espacio o el estado del disco.")
		end if
	else
		f_quita_espacio_rips(docname)
	end if
else
	messagebox('Atención','No hay registros para generar archivos')
end if
return 1
end function

public function integer lf_genera_act_final (long p_nrad, string p_clug_rad);long j,donde,cuantos,van=0
string act_fin,nul
setnull(nul)
datawindow dw
dw=tab_2.tp2_1.t1.tp2.dw_act_final
dw.reset()
dw_getar.retrieve()
dw_temp.dataobject='dw_actfinal_c_y_q'
dw_temp.settransobject(sqlca)
cuantos=dw_temp.retrieve(p_nrad,p_clug_rad,0)
if cuantos=-1 then return -1
if cuantos>0 then
	act_fin=''
	for j=1 to dw_temp.rowcount()
		if act_fin<>dw_temp.getitemstring(j,'cod_activid') then
			act_fin=dw_temp.getitemstring(j,'cod_activid')
			dw_getar.setfilter('cod_activid="'+act_fin+'"')
			dw_getar.filter()
			dw_getar.sort()
		end if
		donde=dw_getar.find('('+string(dw_temp.getitemnumber(j,'edad'))+' between edmin and edmax) and (sexo="T" or sexo="'+dw_temp.getitemstring(j,'sexo')+'")',1,dw_getar.rowcount())
		if donde=0 then
			dw_temp.setitem(j,'porcentaje',100)
			dw_temp.setitem(j,'getar',nul)
		else
			dw_temp.setitem(j,'porcentaje',dw_getar.getitemnumber(donde,'porcentaje'))
			dw_temp.setitem(j,'getar',dw_getar.getitemstring(donde,'codgetareo'))
		end if
	next
	dw.object.num_radicacion.primary=dw_temp.object.nradica.primary
	dw.object.clugar.primary=dw_temp.object.clugar_rad.primary
	dw.object.cod_activid.primary=dw_temp.object.cod_activid.primary
	dw.object.codgetareo.primary=dw_temp.object.getar.primary
	dw.object.nfact.primary=dw_temp.object.nfact.primary
	dw.object.clugar_fact.primary=dw_temp.object.clugar.primary
	dw.object.nitem_fact.primary=dw_temp.object.nitem.primary
	dw.object.edad_dias.primary=dw_temp.object.edad.primary
	dw.object.diagprin.primary=dw_temp.object.diagprin.primary
	dw.object.valor_tot.primary = dw_temp.object.valor.primary
	dw.object.porcentaje.primary=dw_temp.object.porcentaje.primary
	dw.object.nfactu.primary=dw_temp.object.nfact.primary
	dw.object.clug_factu.primary=dw_temp.object.clugar.primary
	dw.object.item.primary=dw_temp.object.fila.primary
	if dw.update()=-1 then return -1
	dw.reset()
end if
van+=cuantos
dw_temp.dataobject='dw_actfinal_p'
dw_temp.settransobject(sqlca)
cuantos=dw_temp.retrieve(p_nrad,p_clug_rad,van)
if cuantos=-1 then return -1
if cuantos>0 then
	act_fin=''
	for j=1 to dw_temp.rowcount()
		if act_fin<>dw_temp.getitemstring(j,'cod_activid') then
			act_fin=dw_temp.getitemstring(j,'cod_activid')
			dw_getar.setfilter('cod_activid="'+act_fin+'"')
			dw_getar.filter()
			dw_getar.sort()
		end if
		donde=dw_getar.find('('+string(dw_temp.getitemnumber(j,'edad'))+' between edmin and edmax) and (sexo="T" or sexo="'+dw_temp.getitemstring(j,'sexo')+'")',1,dw_getar.rowcount())
		if donde=0 then
			dw_temp.setitem(j,'porcentaje',100)
			dw_temp.setitem(j,'getar',nul)
		else
			dw_temp.setitem(j,'porcentaje',dw_getar.getitemnumber(donde,'porcentaje'))
			dw_temp.setitem(j,'getar',dw_getar.getitemstring(donde,'codgetareo'))
		end if
	next
	dw.object.num_radicacion.primary= dw_temp.object.nradica.primary
	dw.object.clugar.primary= dw_temp.object.clugar_rad.primary
	dw.object.cod_activid.primary= dw_temp.object.cod_activid.primary
	dw.object.codgetareo.primary= dw_temp.object.getar.primary
	dw.object.nfact.primary= dw_temp.object.nfact.primary
	dw.object.clugar_fact.primary= dw_temp.object.clugar.primary
	dw.object.nitem_fact.primary=dw_temp.object.nitem.primary
	dw.object.edad_dias.primary=dw_temp.object.edad.primary
	dw.object.diagprin.primary=dw_temp.object.diagprin.primary
	dw.object.valor_tot.primary=dw_temp.object.valor.primary
	dw.object.porcentaje.primary=dw_temp.object.porcentaje.primary
	dw.object.nfactu.primary=dw_temp.object.nfact.primary
	dw.object.clug_factu.primary=dw_temp.object.clugar.primary
	dw.object.item.primary=dw_temp.object.fila.primary
	if dw.update()=-1 then return -1
	dw.reset()
end if
van+=cuantos
dw_temp.dataobject='dw_actfinal_t'
dw_temp.settransobject(sqlca)
cuantos=dw_temp.retrieve(p_nrad,p_clug_rad,van)
if cuantos=-1 then return -1
if cuantos>0 then
	act_fin=''
	for j=1 to dw_temp.rowcount()
		if act_fin<>dw_temp.getitemstring(j,'cod_activid') then
			act_fin=dw_temp.getitemstring(j,'cod_activid')
			dw_getar.setfilter('cod_activid="'+act_fin+'"')
			dw_getar.filter()
			dw_getar.sort()
		end if
		donde=dw_getar.find('('+string(dw_temp.getitemnumber(j,'edad'))+' between edmin and edmax) and (sexo="T" or sexo="'+dw_temp.getitemstring(j,'sexo')+'")',1,dw_getar.rowcount())
		if donde=0 then
			dw_temp.setitem(j,'porcentaje',100)
			dw_temp.setitem(j,'getar',nul)
		else
			dw_temp.setitem(j,'porcentaje',dw_getar.getitemnumber(donde,'porcentaje'))
			dw_temp.setitem(j,'getar',dw_getar.getitemstring(donde,'codgetareo'))
		end if
	next
	dw.object.num_radicacion.primary=dw_temp.object.nradica.primary
	dw.object.clugar.primary=+dw_temp.object.clugar_rad.primary
	dw.object.cod_activid.primary=dw_temp.object.cod_activid.primary
	dw.object.codgetareo.primary=dw_temp.object.getar.primary
	dw.object.ntratamiento.primary=dw_temp.object.ntratamiento.primary
	dw.object.clugar_tot.primary=dw_temp.object.clug_odon.primary
	dw.object.edad_dias.primary=dw_temp.object.edad.primary
	dw.object.diagprin.primary=dw_temp.object.diag.primary
	dw.object.valor_tot.primary=dw_temp.object.valor.primary
	dw.object.porcentaje.primary=dw_temp.object.porcentaje.primary
	dw.object.nfactu.primary=dw_temp.object.nfact.primary
	dw.object.clug_factu.primary=dw_temp.object.clug_fact.primary
	dw.object.item.primary=dw_temp.object.fila.primary
	if dw.update()=-1 then return -1
	dw.reset()
end if
dw_temp.dataobject='dw_actfinal_u_e'
dw_temp.settransobject(sqlca)
van+=cuantos
if dw_temp.retrieve(p_nrad,p_clug_rad,van)>0 then
	act_fin=''
	for j=1 to dw_temp.rowcount()
		if act_fin<>dw_temp.getitemstring(j,'cod_activid') then
			act_fin=dw_temp.getitemstring(j,'cod_activid')
			dw_getar.setfilter('cod_activid="'+act_fin+'"')
			dw_getar.filter()
			dw_getar.sort()
		end if
		donde=dw_getar.find('('+string(dw_temp.getitemnumber(j,'edad'))+' between edmin and edmax) and (sexo="T" or sexo="'+dw_temp.getitemstring(j,'sexo')+'")',1,dw_getar.rowcount())
		if donde=0 then
			dw_temp.setitem(j,'porcentaje',100)
			dw_temp.setitem(j,'getar',nul)
		else
			dw_temp.setitem(j,'porcentaje',dw_getar.getitemnumber(donde,'porcentaje'))
			dw_temp.setitem(j,'getar',dw_getar.getitemstring(donde,'codgetareo'))
		end if
	next
	dw.object.num_radicacion.primary=dw_temp.object.nradica.primary
	dw.object.clugar.primary=dw_temp.object.clugar_rad.primary
	dw.object.cod_activid.primary=dw_temp.object.cod_activid.primary
	dw.object.codgetareo.primary=dw_temp.object.getar.primary
	dw.object.nh.primary=dw_temp.object.nh.primary
	dw.object.clugar_nh.primary=dw_temp.object.clugar.primary
	dw.object.codtingre.primary=dw_temp.object.codtingre.primary
	dw.object.edad_dias.primary=dw_temp.object.edad.primary
	dw.object.diagprin.primary=dw_temp.object.diagingre.primary
	dw.object.valor_tot.primary=dw_temp.object.valor.primary
	dw.object.porcentaje.primary=dw_temp.object.porcentaje.primary
	dw.object.nfactu.primary=dw_temp.object.nfact.primary
	dw.object.clug_factu.primary=dw_temp.object.clug_fact.primary
	dw.object.item.primary=dw_temp.object.fila.primary
	if dw.update()=-1 then return -1
	dw.reset()
end if
dw.retrieve(p_nrad,p_clug_rad)
return 1
end function

public function integer genera_furips (double p_nrad, string p_clug_rad, datetime p_fecha_fin, boolean p_faltan, string p_tipo_rad);string nom_arch,docname,real_name[3],habi,dia,mes,anyo
long j,i,nro_regs[3]
boolean hubo=false

if day(date(p_fecha_fin)) <10 then 
	dia='0'+string(day(date(p_fecha_fin))) 
else 
	dia=string(day(date(p_fecha_fin))) 
end if

if month(date(p_fecha_fin)) <10 then 
	mes='0'+string(month(date(p_fecha_fin))) 
else 
	mes=string(month(date(p_fecha_fin))) 
end if

anyo=string(year(date(p_fecha_fin)))

////////////////////// furips01
if g_motor='postgres' then
	dw_trae.dataobject="dw_furips_01_postgres"
else
	dw_trae.dataobject="dw_furips_01"
end if
dw_trae.settransobject(sqlca)

if dw_trae.retrieve(p_nrad,p_clug_rad,p_tipo_rad)>0 then
	habi=dw_trae.getitemstring(1,'Codhabi')
	nro_regs[1]=dw_trae.rowcount()
	hubo=true
	dw_export.dataobject="dr_export_furips_01"
	for j=1 to dw_trae.rowcount()
		i=dw_export.insertrow(0)
		
		//CIRCULAR 22
		//5/09/2023
		//DATOS RECLAMACION
		//1 de 102
		dw_export.setitem(i,'rad_ant',dw_trae.getitemstring(j,'rg')) 
		
		//2 de 102
		dw_export.setitem(i,'rg',dw_trae.getitemstring(j,'rgr'))
		
		//3 de 102
		if is_concatena_fac="1" then
			 if not isnull(dw_trae.getitemstring(j,"prefijo")) then 
				dw_export.setitem(i,'factura',dw_trae.getitemstring(j,'prefijo')+dw_trae.getitemstring(j,'nfact') )
			else
				dw_export.setitem(i,'factura',dw_trae.getitemstring(j,'clugar_fac')+dw_trae.getitemstring(j,'nfact') )
			end if
		else
			 if not isnull(dw_trae.getitemstring(j,"prefijo")) then 
				dw_export.setitem(i,'factura',dw_trae.getitemstring(j,'prefijo')+dw_trae.getitemstring(j,'nfact') )
			 else
				dw_export.setitem(i,'factura',dw_trae.getitemstring(j,'nfact'))
			end if
		end if

		//4 de 102
		dw_export.setitem(i,'reclamacion',dw_trae.getitemstring(j,'conse'))
		//DATOS PRESTADOR
		//5 de 102
		dw_export.setitem(i,'prestador',dw_trae.getitemstring(j,'codhabi'))
		
		//DATOS VICTIMA
		//6 de 102
		dw_export.setitem(i,'Papell_vic',f_quita_basura(dw_trae.getitemstring(j,'apellido1'),1))
		//7 de 102
		dw_export.setitem(i,'sapell_vic',f_quita_basura(dw_trae.getitemstring(j,'apellido2'),1))
		//8 de 102
		dw_export.setitem(i,'pnom_vic',f_quita_basura(dw_trae.getitemstring(j,'nombre1'),1))
		//9 de 102
		dw_export.setitem(i,'snom_vic',f_quita_basura(dw_trae.getitemstring(j,'nombre2'),1))
		//10 de 102		
		dw_export.setitem(i,'td',dw_trae.getitemstring(j,'TDOC_PAC'))
		//11 de 102
		dw_export.setitem(i,'doc',dw_trae.getitemstring(j,'DOCU_PACIENTE'))
		//12 de 102		
		dw_export.setitem(i,'fechanac',dw_trae.getitemstring(j,'fnacimiento'))
		//13 de 102		
		dw_export.setitem(i,'fechadef',dw_trae.getitemstring(j,'fecha_muerte'))
		//14 de 102			
		dw_export.setitem(i,'sexo',dw_trae.getitemstring(j,'sexo'))
		//15 de 102			
		dw_export.setitem(i,'dir_vic',left(f_quita_basura(dw_trae.getitemstring(j,'DIR_PACIENTE'),0),100))
		//16 de 102			
		dw_export.setitem(i,'depto_vic',dw_trae.getitemstring(j,'cdpto_pac'))
		//17 de 102	
		dw_export.setitem(i,'mcpio_vic',dw_trae.getitemstring(j,'CdCIUD_pac'))
		//18 de 102			
		dw_export.setitem(i,'tele_vic',left(f_quita_basura(dw_trae.getitemstring(j,'TEL_PACIENTE'),0),10))
		//19 de 102
		dw_export.setitem(i,'cond',dw_trae.getitemstring(j,'cod_acci'))
		
		//DATOS DE SITIO ACCIDENTE
		//20 de 102					
		dw_export.setitem(i,'natura',dw_trae.getitemstring(j,'natura'))
		//21 de 102
		if dw_trae.getitemstring(j,'natura')='17' then
			dw_export.setitem(i,'desrip_otr',dw_trae.getitemstring(j,'descp_evento'))
		end if
		//22 de 102							
		dw_export.setitem(i,'dir_eve',left(f_quita_basura(dw_trae.getitemstring(j,'sitio_acc'),0),40))
		//23 de 102							
		dw_export.setitem(i,'fecha_eve',dw_trae.getitemstring(j,'fechaacc'))
		//24 de 102				
		dw_export.setitem(i,'hora_eve',dw_trae.getitemstring(j,'horaacc'))
		//25 de 102				
		dw_export.setitem(i,'depto_eve',dw_trae.getitemstring(j,'cd_Dpto_acci'))
		//26 de 102				
		dw_export.setitem(i,'mcpio_eve',dw_trae.getitemstring(j,'cd_ciud_acci'))
		//27 de 102					
		dw_export.setitem(i,'zona_eve',dw_trae.getitemstring(j,'zona'))
		
		//DATOS VEHICULO
		//28 de 102
		dw_export.setitem(i,'estado',dw_trae.getitemstring(j,'asegurado'))
		//29 de 102		
		dw_export.setitem(i,'marca',dw_trae.getitemstring(j,'marca'))
		//30 de 102		
		dw_export.setitem(i,'placa',f_quita_basura(dw_trae.getitemstring(j,'placa_acc'),0))
		//31 de 102
		dw_export.setitem(i,'Tvehi',dw_trae.getitemstring(j,'tipo_vehi'))
		//32 de 102		
		dw_export.setitem(i,'cod_aseg',dw_trae.getitemstring(j,'cod_ase'))
		//33 de 102		
		dw_export.setitem(i,'poliza',f_quita_basura(dw_trae.getitemstring(j,'npoliza'),0))
		//34 de 102		
		dw_export.setitem(i,'fecha_ini',dw_trae.getitemstring(j,'desde'))
		//35 de 102		
		dw_export.setitem(i,'fecha_ven',dw_trae.getitemstring(j,'hasta'))
		//36 de 102
		dw_export.setitem(i,'siras',dw_trae.getitemstring(j,'siras'))
		//37 de 102		
		dw_export.setitem(i,'excedente',dw_trae.getitemstring(j,'cexc'))
		
		//DATOS ATENCION 
		//38 de 102
		dw_export.setitem(i,'chpppal',dw_trae.getitemstring(j,'chp'))	
		//39 de 102
		dw_export.setitem(i,'complejidad',dw_trae.getitemstring(j,'com'))
		//40 de 102
		dw_export.setitem(i,'cqxppal',dw_trae.getitemstring(j,'cqxp'))
		//41 de 102
		dw_export.setitem(i,'cqxsec',dw_trae.getitemstring(j,'cqxs'))		
		//42 de 102
		dw_export.setitem(i,'uci',string(dw_trae.getitemnumber(j,'uci')))
		//43 de 102
		dw_export.setitem(i,'diasuci',string(dw_trae.getitemnumber(j,'duci')))
		
		//DATOS PROPIETARIO
		//44 de 102
		dw_export.setitem(i,'td_pro',dw_trae.getitemstring(j,'tdoc_prop'))
		//45 de 102		
		dw_export.setitem(i,'doc_pro',dw_trae.getitemstring(j,'docu_prop'))
		//46 de 102		
		dw_export.setitem(i,'Papell_pro',f_quita_basura(dw_trae.getitemstring(j,'ape1_prop'),1))
		//47 de 102		
		dw_export.setitem(i,'sapell_pro',f_quita_basura(dw_trae.getitemstring(j,'ape2_prop'),1))
		//48 de 102		
		dw_export.setitem(i,'pnom_pro',f_quita_basura(dw_trae.getitemstring(j,'nom1_prop'),1))
		//49 de 102		
		dw_export.setitem(i,'snom_pro',f_quita_basura(dw_trae.getitemstring(j,'nom2_prop'),1))
		//50 de 102		
		dw_export.setitem(i,'dir_pro',left(f_quita_basura(dw_trae.getitemstring(j,'direcc_prop'),0),40))
		//51 de 102		
		dw_export.setitem(i,'tel_pro',dw_trae.getitemstring(j,'tel_prop'))
		//52 de 102		
		dw_export.setitem(i,'depto_pro',dw_trae.getitemstring(j,'dept_prop'))
		//53 de 102		
		dw_export.setitem(i,'mcpio_pro',dw_trae.getitemstring(j,'coddp_pro'))
		
		//DATOS CONDUCTOR
		//54 de 102			
		dw_export.setitem(i,'Papell_con',f_quita_basura(dw_trae.getitemstring(j,'apellidos_cond'),1))
		//55 de 102
		dw_export.setitem(i,'sapell_con',f_quita_basura(dw_trae.getitemstring(j,'ape2_cond'),1))
		//56 de 102		
		dw_export.setitem(i,'pnom_con',f_quita_basura(dw_trae.getitemstring(j,'nombres_cond'),1))
		//57 de 102		
		dw_export.setitem(i,'snom_con',f_quita_basura(dw_trae.getitemstring(j,'nom2_cond'),1))
		//58 de 102		
		dw_export.setitem(i,'td_con',dw_trae.getitemstring(j,'tdoc_cond'))
		//59 de 102		
		dw_export.setitem(i,'doc_con',dw_trae.getitemstring(j,'docu_cond'))
		//60 de 102
		dw_export.setitem(i,'dir_con',left(f_quita_basura(dw_trae.getitemstring(j,'direcc_cond'),0),100))
		//61 de 102		
		dw_export.setitem(i,'depto_con',dw_trae.getitemstring(j,'coddp_cod'))
		//62 de 102		
		dw_export.setitem(i,'mcpio_con',dw_trae.getitemstring(j,'cod_ciu_con'))
		//63 de 102		
		dw_export.setitem(i,'tel_con',dw_trae.getitemstring(j,'tel_cond'))
		
		//DATOS REMSION
		//64 de 102
		dw_export.setitem(i,'referen',dw_trae.getitemstring(j,'tiref'))
		//65 de 102		
		dw_export.setitem(i,'fecha_remi',dw_trae.getitemstring(j,'feremi'))
		//66 de 102		
		dw_export.setitem(i,'hora_salida',dw_trae.getitemstring(j,'horemi'))
		//67 de 102		
		dw_export.setitem(i,'prestador_rem',dw_trae.getitemstring(j,'codhabirem'))
		//68 de 102		
		dw_export.setitem(i,'profe_remite',dw_trae.getitemstring(j,'prof_rem'))
		//69 de 102
		dw_export.setitem(i,'cargo_remite',f_quita_basura(dw_trae.getitemstring(j,'desesp'),0))
		//70 de 102
		dw_export.setitem(i,'fecha_ingreso_rem',dw_trae.getitemstring(j,'fe_ing_rem'))
		//71 de 102
		dw_export.setitem(i,'hora_ingreso_rem',dw_trae.getitemstring(j,'ho_ing_rem'))
		//72 de 102
		dw_export.setitem(i,'prestador_recibe',dw_trae.getitemstring(j,'csupe_ipsrem'))
		//73 de 102
		dw_export.setitem(i,'profe_recibe',dw_trae.getitemstring(j,'prof_recibe'))
		//74 de 102
		dw_export.setitem(i,'placa_remi',f_quita_basura(dw_trae.getitemstring(j,'placa_trans'),0))
		
		//MOVILIZACION
		//75 de 102
		dw_export.setitem(i,'placa_mov',dw_trae.getitemstring(j,'placa_trans'))
		//76 de 102
		dw_export.setitem(i,'recorrido_1',dw_trae.getitemstring(j,'trans_desde'))
		//77 de 102
		dw_export.setitem(i,'recorrido_2',dw_trae.getitemstring(j,'trans_hasta'))
		//78 de 102
		dw_export.setitem(i,'ambulancia',dw_trae.getitemstring(j,'tipo_trans'))
		//79 de 102
		dw_export.setitem(i,'zona_recoge',dw_trae.getitemstring(j,'zona_t'))
		
		//CERTIFICACION
		//80 de 102
		dw_export.setitem(i,'fecha_ingreso',dw_trae.getitemstring(j,'fing'))
		//81 de 102
		dw_export.setitem(i,'hora__ingreso',dw_trae.getitemstring(j,'hing'))
		//82 de 102
		dw_export.setitem(i,'fecha_egreso',dw_trae.getitemstring(j,'feg'))
		//83 de 102
		dw_export.setitem(i,'hora_egreso',dw_trae.getitemstring(j,'heg'))
		//84 de 102
		dw_export.setitem(i,'dxip',dw_trae.getitemstring(j,'diaing'))
		//85 de 102
		dw_export.setitem(i,'dxi1',dw_trae.getitemstring(j,'di1'))
		//86 de 102
		dw_export.setitem(i,'dxi2',dw_trae.getitemstring(j,'di2'))
		//87 de 102
		dw_export.setitem(i,'dxep',dw_trae.getitemstring(j,'deg'))
		//88 de 102
		dw_export.setitem(i,'dxe1',dw_trae.getitemstring(j,'ge1'))
		//89 de 102
		dw_export.setitem(i,'dex2',dw_trae.getitemstring(j,'de2'))
		
		//MEDICO
		//90 de 102
		dw_export.setitem(i,'Papell_med',dw_trae.getitemstring(j,'pro_at_a1'))
		//91 de 102
		dw_export.setitem(i,'sapell_med',dw_trae.getitemstring(j,'pro_at_a2'))
		//92 de 102
		dw_export.setitem(i,'pnom_med',dw_trae.getitemstring(j,'pro_at_n1'))
		//93 de 102
		dw_export.setitem(i,'snom_med',dw_trae.getitemstring(j,'pro_at_n2'))
		//94 de 102
		dw_export.setitem(i,'td_med',dw_trae.getitemstring(j,'pro_at_td'))
		//95 de 102
		dw_export.setitem(i,'doc_med',dw_trae.getitemstring(j,'pro_at_doc'))
		//96 de 102
		dw_export.setitem(i,'reg_med',f_quita_basura(dw_trae.getitemstring(j,'pro_at_reg'),0))
		
		//AMPAROS
		//97 de 102
		dw_export.setitem(i,'fact_gas_med',dw_trae.getitemstring(j,'vtproce'))
		//98 de 102
		dw_export.setitem(i,'total_gas_med',dw_trae.getitemstring(j,'vtemp'))
		//99 de 102		
		dw_export.setitem(i,'fac_mov',dw_trae.getitemstring(j,'gt1'))
		//100 de 102		
		dw_export.setitem(i,'total_mov',dw_trae.getitemstring(j,'gt2'))
		//101 de 102
		dw_export.setitem(i,'servicios','1')
		//102 de 102
		string jaer
		jaer=dw_trae.getitemstring(j,'descp_evento')
		dw_export.setitem(i,'descrip',dw_trae.getitemstring(j,'descp_evento'))
	next
	
	if hubo then
		nom_arch="FURIPS1"+habi+dia+mes+anyo
		docname=nom_arch
		docname=tab_2.tp2_1.sle_dir.text+'\'+nom_arch+'.txt'
		nom_arch+='.txt'
		if dw_export.saveas(docname,CSV!,false)=-1 then
			if p_faltan then
				Messagebox("Error guardando furips1","No se puede guardar el archivo, revise el espacio o el estado del disco.~r~nLa radiciación generará aún así.")
			else
				Messagebox("Error guardando Furips1","No se puede guardar el archivo, revise el espacio o el estado del disco.")
			end if
		else
			f_quita_espacio_rips(docname)
		end if
		real_name[1]=mid(nom_arch,1,len(nom_arch) -4)

	end if
	////////////////////// fin furips1

	////////////////////// furips02
	hubo=false
	if g_motor='postgres' then
		dw_trae.dataobject="dw_furips_02_postgres"
	else
		dw_trae.dataobject="dw_furips_02"
	end if
	dw_trae.settransobject(sqlca)
	
	if dw_trae.retrieve(p_nrad,p_clug_rad,p_tipo_rad)>0 then
		nro_regs[2]=dw_trae.rowcount()
		hubo=true
		dw_export.dataobject="dr_export_furips_02"
		for j=1 to dw_trae.rowcount()
			i=dw_export.insertrow(0)
			//DATOS RECLAMACION
			//1 de 9
			if is_concatena_fac="1" then
				 if not isnull(dw_trae.getitemstring(j,"prefijo")) then 
					dw_export.setitem(i,'factura',dw_trae.getitemstring(j,'prefijo')+dw_trae.getitemstring(j,'nfact') )
				else
					dw_export.setitem(i,'factura',dw_trae.getitemstring(j,'clugar')+dw_trae.getitemstring(j,'nfact') )
				end if
			else
				if not isnull(dw_trae.getitemstring(j,"prefijo")) then 
					dw_export.setitem(i,'factura',dw_trae.getitemstring(j,'prefijo')+dw_trae.getitemstring(j,'nfact') )
				else
					dw_export.setitem(i,'factura',dw_trae.getitemstring(j,'nfact'))
				end if				
			end if
			//2 de 9			
			dw_export.setitem(i,'consecu',dw_trae.getitemstring(j,'conse'))
			
			//FACTURA
			//3 de 9			
			dw_export.setitem(i,'tipo_serv',dw_trae.getitemstring(j,'furips'))
			
			//4 de 9
			if dw_trae.getitemstring(j,'furips')='3' or dw_trae.getitemstring(j,'furips')='4' &
			 or dw_trae.getitemstring(j,'furips')='5' or dw_trae.getitemstring(j,'furips')='7' &
			 or dw_trae.getitemstring(j,'furips')='8' &
			then
				dw_export.setitem(i,'codigo_serv','')
			else			
				dw_export.setitem(i,'codigo_serv',dw_trae.getitemstring(j,'codigo'))
			end if
			
			//5 de 9
			if  dw_trae.getitemstring(j,'furips')<>'2' then
				dw_export.setitem(i,'descripcion',left(dw_trae.getitemstring(j,'descrip'),100))
			else
				dw_export.setitem(i,'descripcion','')
			end if
			
			//6 de 9			
			dw_export.setitem(i,'cantidad',dw_trae.getitemstring(j,'cant'))
			//7 de 9			
			dw_export.setitem(i,'valor_unitario',dw_trae.getitemstring(j,'Vunit'))
			//8 de 9			
			dw_export.setitem(i,'valor_facturado',dw_trae.getitemstring(j,'vfactu'))
			//9 de 9			
			dw_export.setitem(i,'valor_reclamado',dw_trae.getitemstring(j,'vfsyga'))
		next
		if hubo then
			nom_arch="FURIPS2"+habi+dia+mes+anyo
			docname=nom_arch
			docname=tab_2.tp2_1.sle_dir.text+'\'+nom_arch+'.txt'
			nom_arch+='.txt'
			if dw_export.saveas(docname,CSV!,false)=-1 then
				if p_faltan then
					Messagebox("Error guardando Furips2","No se puede guardar el archivo, revise el espacio o el estado del disco.~r~nLa radiciación generará aún así.")
				else
					Messagebox("Error guardando Furips2","No se puede guardar el archivo, revise el espacio o el estado del disco.")
				end if
			else
				f_quita_espacio_rips(docname)
			end if
			real_name[2]=mid(nom_arch,1,len(nom_arch) -4)
		end if
		////////////////////// fin furips2
	end if
		
	
	////////////////////// furtran
	hubo=false	
	if g_motor='postgres' then
		dw_trae.dataobject="dw_furips_furtra_postgres"
	else
		dw_trae.dataobject="dw_furips_furtra"
	end if
	dw_trae.settransobject(sqlca)
	if dw_trae.rowcount()>0 then
		nro_regs[3]=dw_trae.rowcount()
		hubo=true
		dw_export.dataobject="dr_export_furips_furtran"
		/*for j=1 to dw_trae.rowcount()
			if not isnull(dw_trae.getitemstring(j,'placa_trans')) and dw_trae.getitemstring(j,'placa_trans')<>''  then
				i=dw_export.insertrow(0)
				dw_export.setitem(i,'rad_ant',dw_trae.getitemstring(j,'rg'))
				dw_export.setitem(i,'rg',dw_trae.getitemstring(j,'rgr'))
				dw_export.setitem(i,'nomempresa',f_quita_basura(dw_trae.getitemstring(j,'ipsn'),0))
				dw_export.setitem(i,'prestador',dw_trae.getitemstring(j,'codhabi'))
				dw_export.setitem(i,'papell_rec','')
				dw_export.setitem(i,'sapell_rec','')
				dw_export.setitem(i,'pnom_rec','')
				dw_export.setitem(i,'snom_rec','')
				dw_export.setitem(i,'td_rec',dw_trae.getitemstring(j,'ips_td'))
				dw_export.setitem(i,'doc_rec',dw_trae.getitemstring(j,'ips_doc'))
				dw_export.setitem(i,'tiposerv',dw_trae.getitemstring(j,'tipo_trans'))
				dw_export.setitem(i,'otro','')
				dw_export.setitem(i,'placaa',dw_trae.getitemstring(j,'placa_trans'))
				dw_export.setitem(i,'direcc',f_quita_basura(dw_trae.getitemstring(j,'dir_ips'),0))
				dw_export.setitem(i,'tele',left(f_quita_basura(dw_trae.getitemstring(j,'tel_ips'),0),10))
				dw_export.setitem(i,'cod_dep',dw_trae.getitemstring(j,'depto_ips'))
				dw_export.setitem(i,'cod_mcpio',dw_trae.getitemstring(j,'ciudad_ips'))
				dw_export.setitem(i,'td_v',dw_trae.getitemstring(j,'TDOC_PAC'))
				dw_export.setitem(i,'docu_vic',dw_trae.getitemstring(j,'DOCU_PACIENTE'))
				dw_export.setitem(i,'papell_v',f_quita_basura(dw_trae.getitemstring(j,'apellido1'),1))
				dw_export.setitem(i,'sapell_v',f_quita_basura(dw_trae.getitemstring(j,'apellido2'),1))
				dw_export.setitem(i,'pnom_v',f_quita_basura(dw_trae.getitemstring(j,'nombre1'),1))
				dw_export.setitem(i,'snom_v',f_quita_basura(dw_trae.getitemstring(j,'nombre2'),1))
				dw_export.setitem(i,'tipoevento','1')
				dw_export.setitem(i,'dir_reg',left(f_quita_basura(dw_trae.getitemstring(j,'sitio_acc'),0),40))
				dw_export.setitem(i,'cod_dep_reg',dw_trae.getitemstring(j,'cd_Dpto_acci'))
				dw_export.setitem(i,'cod_mcpio_reg',dw_trae.getitemstring(j,'cd_ciud_acci'))
				dw_export.setitem(i,'zona_reg',dw_trae.getitemstring(j,'zona'))
				dw_export.setitem(i,'fecha_tra',dw_trae.getitemstring(j,'fing'))
				dw_export.setitem(i,'hora_tra',dw_trae.getitemstring(j,'hing'))
				dw_export.setitem(i,'cod_hab_ips',dw_trae.getitemstring(j,'codhabi'))
				dw_export.setitem(i,'cod_dep_ips',dw_trae.getitemstring(j,'depto_ips'))
				dw_export.setitem(i,'cod_mcpio_ips',dw_trae.getitemstring(j,'ciudad_ips'))
				if isnull(dw_trae.getitemstring(j,'folios')) or dw_trae.getitemstring(j,'folios')=''  then
					dw_export.setitem(i,'folios','1')
				else
					dw_export.setitem(i,'folios',dw_trae.getitemstring(j,'folios'))
				end if
			end if
		next*/
		if hubo then
			nom_arch="FURTRAN"+habi+dia+mes+anyo
			docname=nom_arch
			docname=tab_2.tp2_1.sle_dir.text+'\'+nom_arch+'.txt'
			nom_arch+='.txt'
			if dw_export.saveas(docname,CSV!,false)=-1 then
				if p_faltan then
					Messagebox("Error guardando furtran","No se puede guardar el archivo, revise el espacio o el estado del disco.~r~nLa radiciación generará aún así.")
				else
					Messagebox("Error guardando furtran","No se puede guardar el archivo, revise el espacio o el estado del disco.")
				end if
			else
				f_quita_espacio_rips(docname)
			end if
			real_name[3]=mid(nom_arch,1,len(nom_arch) -4)
		end if
		////////////////////// fin furtran
	end if
else
	messagebox('Atención','No hay registros para generar archivos')
end if
return 1	

end function

public function st_nradica lf_trae_ndoc (string p_decual, string p_cdoc);long ndoc,n_ini,n_fin,cuantos
int l_caut
string err,por_lug,p_desdoc='Radicaciones',p_clug,reso
st_nradica l_doc
p_clug=clugar
select por_lugar,numini,numfin,nactual,resol into :por_lug,:n_ini,:n_fin,:ndoc,:reso from documentos_gral where coddoc=:p_cdoc;
if sqlca.sqlcode=-1 then 
	err=sqlca.sqlerrtext
	rollback;
	if p_decual='lote' then
		filewrite(i_numarc,'Error leyendo documentos_gral '+err)
	else
		messagebox('Error leyendo documentos_gral',err)
	end if
	l_doc.ndoc=-1
	return l_doc
end if
if sqlca.sqlnrows=0 then
	rollback;
	if p_decual='lote' then
		filewrite(i_numarc,'El Documento ('+p_cdoc+')'+p_desdoc+' no existe en la tabla Documentos_gral, debe crearlo para continuar~r~n')
	else
		messagebox('Atención','El Documento ('+p_cdoc+')'+p_desdoc+' no existe en la tabla Documentos_gral, debe crearlo para continuar')
	end if
	l_doc.ndoc=-1
	return l_doc
end if
if isnull(ndoc) then ndoc=0
if por_lug='1' then
	select nactual,numini,numfin into :ndoc ,:n_ini ,:n_fin from documentos where coddoc=:p_cdoc and clugar=:p_clug;
	if sqlca.sqlcode=-1 then 
		err=sqlca.sqlerrtext
		rollback;
		if p_decual='lote' then
			filewrite(i_numarc,'Error leyendo documentos: '+err)
		else
			messagebox('Error leyendo documentos',err)
		end if
		l_doc.ndoc=-1
		return l_doc
	end if
	if sqlca.sqlnrows=0 then
		rollback;
		if p_decual='lote' then
			filewrite(i_numarc,'El Documento ('+p_cdoc+')'+p_desdoc+' no existe en la tabla Documentos, debe crearlo para continuar')
		else
			messagebox('Atención','El Documento ('+p_cdoc+')'+p_desdoc+' no existe en la tabla Documentos, debe crearlo para continuar')
		end if
		l_doc.ndoc=-1
		return l_doc
	end if
	if isnull(ndoc) then ndoc=0
end if
ndoc++
if ndoc<n_ini or ndoc>n_fin then
	rollback;
	if p_decual='lote' then
		filewrite(i_numarc,'El número que se generará no está dentro del rando definido para el documento: '+p_cdoc)
	else
		messagebox('Atención','El número que se generará no está dentro del rando definido para el documento: '+p_cdoc)
	end if
	l_doc.ndoc=-1
	return l_doc
end if
if por_lug='1' then
	update documentos set nactual=:ndoc where coddoc=:p_cdoc and clugar=:p_clug and nactual=:ndoc -1 ;
else
	update documentos_gral set nactual=:ndoc where coddoc=:p_cdoc and nactual=:ndoc -1 ;
end if
if sqlca.sqlcode=-1 then
	err=sqlca.sqlerrtext
	rollback;
	if p_decual='lote' then
		filewrite(i_numarc,'Error actualizando documentos '+err)
	else
		messagebox('Error actualizando documentos',err)
	end if
	l_doc.ndoc=-1
	return l_doc
end if
if sqlca.sqlnrows=0 then
	rollback;
	if p_decual='lote' then
		filewrite(i_numarc,'Error generando nuevo Documento. Es posible que el número ya haya sido utilizado, intente nuevamente')
	else
		messagebox('Error generando nuevo Documento','Es posible que el número ya haya sido utilizado, intente nuevamente')
	end if
	l_doc.ndoc=-1
	return l_doc
end if
setnull(l_caut)
if reso='1' then
	select count(*) into :cuantos from documentos_autfact
	where coddoc=:p_cdoc and clugar=:p_clug and estado='1';
	if cuantos<>1 then
		messagebox("Atención",'Esta Documento no tiene autorizaciones activas revise esto para continuar')
		 l_doc.ndoc=-1
		return l_doc
	end if

	select c_aut into :l_caut
	from documentos_autfact
	where coddoc=:p_cdoc and clugar=:p_clug and estado='1';
	if sqlca.sqlcode=-1 then
		messagebox('Error leyendo Documento autorizaciones' ,sqlca.sqlerrtext)
		 l_doc.ndoc=-1
		return l_doc
	end if
end if
l_doc.ndoc=ndoc
l_doc.c_aut=l_caut
return l_doc
end function

public function long f_rips (boolean p_faltan, long p_nradica, string p_clug_rad, datawindow p_dw_conts, string p_decual, boolean p_cups, long p_cero, string p_por_lugar, string p_reserva, string p_tipo_rad);string cual,param,nom_arch,emp,docname,realn[12],formato,log_txt ,cips,tipo_rad,l_cont,l_deta
string ls_objeto
long j,i,filas,arch,num_af,num_ad,num_us,n_reg[7],factus,p_at=0
st_nradica num_radica

dec tot_evento,tot_capita
datetime fecha_radica,fecha_ini,fecha_fin

if tab_2.tp2_1.cbx_7.checked then 
	l_deta='1'
else 
	l_deta='0'
end if

if tab_2.tp2_1.cbx_5.checked then 
	is_capiv='1'
else 
	is_capiv='0'
end if

if p_decual='emp' then
	if p_faltan and  p_nradica=0 then
		fecha_ini=datetime(date(tab_2.tp2_1.tab_1.tp_1.em_1.text))
		fecha_fin=datetime(date(tab_2.tp2_1.tab_1.tp_1.em_2.text))
	else
		fecha_ini=tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemdatetime(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),'fecha_inicial')
		fecha_fin=tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemdatetime(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),'fecha_final')
		fecha_radica=tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemdatetime(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),'fecha_radica')
	end if
else
	fecha_ini=datetime(date(tab_2.tp2_2.em_3.text))
	fecha_fin=datetime(date(tab_2.tp2_2.em_4.text))
end if

string clug,cser
if tab_2.tp2_1.cbx_at.checked then p_at=1
clug=dw_lug.getitemstring(1,1)
if rb_9.checked then 
	cser='%'
else
	cser=dw_tipin.getitemstring(1,1)
end if
if p_faltan then
	dw_trae.dataobject='dw_guarda_radica_rips'
	dw_trae.settransobject(sqlca)
	emp=p_dw_conts.getitemstring(1,"cemp")
	fecha_radica=datetime(today(),now())
	if rb_7.checked then clug='%'
	for j=1 to p_dw_conts.rowcount()
		w_principal.SetMicroHelp ( 'Leyendo Datos Contrato '+string(j) )
		if dw_trae.retrieve(emp,p_dw_conts.getitemstring(j,"ccontrato"),fecha_ini,fecha_fin,p_cero,j,clug,cser)=-1 then return -1
		dw_trae.setfilter('num='+string(j)) //toca filtrarlo porque tiene return 2 en retrievestart
		dw_trae.filter()
		if dw_trae.rowcount()>0 then 
			p_dw_conts.setitem(j,'valor_evento',round(dw_trae.getitemdecimal(1,'vtot_rad'),2))
			p_dw_conts.setitem(j,'nro_factu',dw_trae.rowcount())
		end if
	next
	dw_trae.setfilter('')
	dw_trae.filter()
	
	if dw_trae.rowcount()=0 and p_reserva='0'  then 
		if p_decual='lote' then //escribir en el log
			filewrite(i_numarc,'				N O   H A Y   R E G I S T R O S   P A R A   G E N E R A R~r~n')
		else
			messagebox("Atención",'No hay registros para generar')
		end if
		return 0
	end if
	if p_nradica=0 then
		if p_dw_conts.getitemstring(1,'ctipo')='1' then 
			num_radica=lf_trae_ndoc(p_decual,'RA')
			tipo_rad='R'
			formato=""
			for j=1 to i_nro_dig -1
				formato+="0"
			next
			formato+="#"			
		end if
		if p_dw_conts.getitemstring(1,'ctipo')='2' then
			num_radica=lf_trae_ndoc(p_decual,'RV')
			tipo_rad='F'
			formato=""
		end if
		if num_radica.ndoc<0 then return -10//error grave
		factus=p_dw_conts.getitemnumber(1,'t_factus')
		tot_evento=round(p_dw_conts.getitemdecimal(1,'t_evento'),l_dec_fact)
		tot_capita=round(p_dw_conts.getitemdecimal(1,'t_capita'),l_dec_fact)
		is_objeto=tab_2.tp2_1.tab_1.tp_1.mle_objeto.text
		If clug='%' then
			INSERT INTO ripsradica ( num_radicacion,clugar,tipo, cemp , fecha_radica, fecha_inicial, fecha_final ,usuario,valor_capita,valor_evento,nro_factu,por_lugar,reserva,c_aut,lugar_s,objeto,valor_ncr,valor_ndb) 
			values (:num_radica.ndoc,:clugar,:tipo_rad,:emp,:fecha_radica,:fecha_ini,:fecha_fin,:usuario,:tot_capita,:tot_evento,:factus,:p_por_lugar,:p_reserva,:num_radica.c_aut,null,:is_objeto,0,0);
		else
			INSERT INTO ripsradica ( num_radicacion,clugar,tipo, cemp , fecha_radica, fecha_inicial, fecha_final ,usuario,valor_capita,valor_evento,nro_factu,por_lugar,reserva,c_aut,lugar_s,objeto,valor_ncr,valor_ndb) 
			values (:num_radica.ndoc,:clugar,:tipo_rad,:emp,:fecha_radica,:fecha_ini,:fecha_fin,:usuario,:tot_capita,:tot_evento,:factus,:p_por_lugar,:p_reserva,:num_radica.c_aut,:clug,:is_objeto,0,0);
		end if
		
		if sqlca.sqlcode=-1 then
			if p_decual='lote' then //escribir en el log
				log_txt="Error insertando en Ripsradica"+sqlca.sqlerrtext
				filewrite(i_numarc,log_txt)
			else
				messagebox("Error insertando en Ripsradica",sqlca.sqlerrtext)
			end if
			return -1
		end if
		for j=1 to p_dw_conts.rowcount()
			p_dw_conts.setitem(j,'num_radicacion',num_radica.ndoc)
			p_dw_conts.setitem(j,'clugar',clugar)
			p_dw_conts.setitem(j,'tipo',tipo_rad)
		next
		w_principal.SetMicroHelp ( 'Insertando en RispRadicaDet' )
		if p_dw_conts.update()=-1 then //no se escribe aqui en el log se hace en el dberror del dw
			return -1
		end if
	else
		num_radica.ndoc= p_nradica
		tipo_rad=p_tipo_rad
	end if
	if p_reserva='1' and p_nradica=0 then return num_radica.ndoc

	w_principal.SetMicroHelp ( 'Actualizando Factcab '+string(dw_trae.rowcount())+' regs.' )
	for j=1 to dw_trae.rowcount()
		dw_trae.setitem(j,'nradica',num_radica.ndoc)
		dw_trae.setitem(j,'clugar_rad',clugar)
		dw_trae.setitem(j,'tipo_rad',tipo_rad)
	next
	w_principal.SetMicroHelp ( 'Guardando en Factcab' )
	if dw_trae.update()=-1 then return -1
	p_nradica=num_radica.ndoc
	p_clug_rad=clugar
	p_tipo_rad=tipo_rad
	
	if p_dw_conts.find('ctipo="3"',1,p_dw_conts.rowcount())>0 then
		if lf_genera_act_final(p_nradica,p_clug_rad)=-1 then return -1
	end if
	commit;
end if// fin los que faltan (nuevos)

////////////////////////////////de aqui pa'lla es como si fueran radicaciones pasadas
if dw_trae.rowcount()>=0 and (p_reserva='0' or p_reserva='1') then 
	if p_dw_conts.getitemnumber(1,'forecat')=0 or isnull(p_dw_conts.getitemnumber(1,'forecat')) then //son los rips normales
		for arch=1 to 7
			choose case arch 
				case 1
					cual="Consulta"
				case 2
					cual="Procedimientos"
				case 3
					cual="Recien Nacido"
				case 4
					cual="Hospitalización"
				case 5
					cual="Medicamentos"
				case 6
					cual="Otros"
				case 7
					cual="Urgencias"
			end choose
			choose case cual
				case "Consulta"  //archivo/empresa/contrato/fechas
					dw_trae.dataobject="dr_rips_consulta_viejo"
					dw_export.dataobject="dr_export_rips_consulta"
					nom_arch="AC"
				case "Procedimientos"
					dw_trae.dataobject="dr_rips_procedimientos_viejo"
					dw_export.dataobject="dr_export_rips_proc"
					nom_arch="AP"
				case "Urgencias"
					dw_trae.dataobject="dr_rips_urg_viejo"
					dw_export.dataobject="dr_export_rips_urg"
					nom_arch="AU"
				case "Hospitalización"
					dw_trae.dataobject="dr_rips_hosp_viejo"
					dw_export.dataobject="dr_export_rips_hosp"
					nom_arch="AH"
				case "Recien Nacido"
					dw_trae.dataobject="dr_rips_rn_viejo"
					dw_export.dataobject="dr_export_rips_rn"
					nom_arch="AN"
				case "Medicamentos"
					dw_trae.dataobject="dr_rips_medica_viejo"
					dw_export.dataobject="dr_export_rips_medica"
					nom_arch="AM"
				case "Otros"
					dw_trae.dataobject="dr_rips_otros_viejo"
					dw_export.dataobject="dr_export_rips_otros"
					nom_arch="AT"
			end choose
			dw_trae.settransobject(sqlca)
			w_principal.SetMicroHelp ( 'Leyendo Archivo '+cual )
			dw_trae.reset()
			if dw_trae.retrieve(p_nradica,p_clug_rad,p_por_lugar,cser,p_tipo_rad,is_capiv)<>-1 then
				dw_export.reset()
				if dw_trae.rowcount()=0 then
					if p_decual='emp' then
					//	if tab_2.tp2_1.rb_names.checked then messagebox("Atención","No hay registros de "+cual+" para generar con estas condiciones")
					else//escribir en el log
						log_txt='~t~t~t'+nom_arch+': 0 registros (OK)'
						filewrite(i_numarc,log_txt)
					end if
					n_reg[arch]=dw_trae.rowcount()
				else
					filas=dw_trae.rowcount()
					n_reg[arch]=filas
					for j=1 to filas
						i=dw_export.insertrow(0)
						choose case cual
							case "Consulta"  //archivo/empresa/contrato/fechas (Parémetros de Entrada del DataWindow)	
								if is_concatena_fac="1" then
									if p_dw_conts.getitemstring(1,'ctipo')='1' then  
										if  p_por_lugar<>'1' then
											 if not isnull(dw_trae.getitemstring(j,"prefijo")) then 
												dw_export.setitem(i,1,dw_trae.getitemstring(j,"prefijo")+string(dw_trae.getitemnumber(j,1),formato)) //factura
											else
												dw_export.setitem(i,1,dw_trae.getitemstring(j,"clugar_fac")+string(dw_trae.getitemnumber(j,1),formato)) //factura
											end if
										else
											 if not isnull(dw_trae.getitemstring(j,"prefijo")) then 
												dw_export.setitem(i,1,dw_trae.getitemstring(j,"prefijo")+string(dw_trae.getitemnumber(j,1),formato)) //factura
											else
												dw_export.setitem(i,1,dw_trae.getitemstring(j,"clugar_fac")+string(dw_trae.getitemnumber(j,1),formato)) //factura
											end if
										end if
									else
										 if not isnull(dw_trae.getitemstring(j,"prefijo")) then 
											dw_export.setitem(i,1,dw_trae.getitemstring(j,"prefijo")+string(p_nradica,formato)) //factura
										else
											dw_export.setitem(i,1,string(p_nradica,formato))
										end if
										
									end if
								else
									dw_export.setitem(i,1,string(dw_trae.getitemnumber(j,1))) //factura
								end if
								if l_deta='0' then
									dw_export.setitem(i,2,dw_trae.getitemstring(j,'este_codigo')) //cod_ips
								else
									dw_export.setitem(i,2,dw_trae.getitemstring(j,'c_supersalud')) //cod_ips
								end if
								dw_export.setitem(i,3,dw_trae.getitemstring(j,3)) //tipo_doc
								if isnull(dw_trae.getitemstring(j,22)) or dw_trae.getitemstring(j,22)='' then 
									dw_export.setitem(i,4,dw_trae.getitemstring(j,4)) //documento
								else
									dw_export.setitem(i,4,dw_trae.getitemstring(j,22)+dw_trae.getitemstring(j,4)) //documento
								end if
								dw_export.setitem(i,5,string(dw_trae.getitemdatetime(j,5),"dd/mm/yyyy")) //fecha
								dw_export.setitem(i,6,dw_trae.getitemstring(j,6)) //nro_autoriza
								if p_cups then
									dw_export.setitem(i,7,dw_trae.getitemstring(j,'cod_cups'))									
								else
									dw_export.setitem(i,7,dw_trae.getitemstring(j,7)) //cproced
								end if
								dw_export.setitem(i,8,dw_trae.getitemstring(j,8)) //finalidad consulta
								dw_export.setitem(i,9,dw_trae.getitemstring(j,9)) //causa externa
								dw_export.setitem(i,10,dw_trae.getitemstring(j,10)) //diag_prin
								dw_export.setitem(i,11,dw_trae.getitemstring(j,11)) //diagrel1
								dw_export.setitem(i,12,dw_trae.getitemstring(j,12)) //diagrel2
								dw_export.setitem(i,13,dw_trae.getitemstring(j,13)) //diagrel3
								dw_export.setitem(i,14,dw_trae.getitemstring(j,14)) //tipo_diag_prin
								if is_rips_cd='0' then 
									dw_export.setitem(i,15,string(dw_trae.getitemnumber(j,15),"#####0")) //vproced
									dw_export.setitem(i,16,string(dw_trae.getitemnumber(j,"cuota_modera"),"#####0")) //cuota moder
									dw_export.setitem(i,17,string(dw_trae.getitemnumber(j,16),"#####0")) //valor a pagar v_emp
								else
									dw_export.setitem(i,15,string(dw_trae.getitemnumber(j,15),"#####0.00")) //vproced
									dw_export.setitem(i,16,string(dw_trae.getitemnumber(j,"cuota_modera"),"#####0.00")) //cuota moder
									dw_export.setitem(i,17,string(dw_trae.getitemnumber(j,16),"#####0.00")) //valor a pagar v_emp
								end if
								
							case "Procedimientos"
								if is_concatena_fac="1" then
									if p_dw_conts.getitemstring(1,'ctipo')='1' then  
										if  p_por_lugar<>'1' then
											 if not isnull(dw_trae.getitemstring(j,"prefijo")) then 
												dw_export.setitem(i,1,dw_trae.getitemstring(j,"prefijo")+string(dw_trae.getitemnumber(j,1),formato)) //factura
											else
												dw_export.setitem(i,1,dw_trae.getitemstring(j,"clugar_fac")+string(dw_trae.getitemnumber(j,1),formato)) //factura
											end if
										else
											 if not isnull(dw_trae.getitemstring(j,"prefijo")) then 
												dw_export.setitem(i,1,dw_trae.getitemstring(j,"prefijo")+string(dw_trae.getitemnumber(j,1),formato)) //factura
											else
												dw_export.setitem(i,1,dw_trae.getitemstring(j,"clugar_fac")+string(dw_trae.getitemnumber(j,1),formato)) //factura
											end if
										end if
									else
										 if not isnull(dw_trae.getitemstring(j,"prefijo")) then 
											dw_export.setitem(i,1,dw_trae.getitemstring(j,"prefijo")+string(p_nradica,formato)) //factura
										else
											dw_export.setitem(i,1,string(p_nradica,formato))
										end if
									end if
								else
									dw_export.setitem(i,1,string(dw_trae.getitemnumber(j,1))) //factura
								end if
								if l_deta='0' then
									dw_export.setitem(i,2,dw_trae.getitemstring(j,'este_codigo')) //cod_ips
								else
									dw_export.setitem(i,2,dw_trae.getitemstring(j,'c_supersalud')) //cod_ips
								end if
								dw_export.setitem(i,3,dw_trae.getitemstring(j,3)) //tipo_doc
								if isnull(dw_trae.getitemstring(j,20)) or dw_trae.getitemstring(j,20)='' then 
									dw_export.setitem(i,4,dw_trae.getitemstring(j,4)) //documento
								else
									dw_export.setitem(i,4,dw_trae.getitemstring(j,20)+dw_trae.getitemstring(j,4)) //documento
								end if
								dw_export.setitem(i,5,string(dw_trae.getitemdatetime(j,5),"dd/mm/yyyy")) //fecha
								dw_export.setitem(i,6,dw_trae.getitemstring(j,6)) //nro_autoriza
								if p_cups then
									dw_export.setitem(i,7,dw_trae.getitemstring(j,'cod_cups'))
								else
									dw_export.setitem(i,7,dw_trae.getitemstring(j,7)) //cproced
								end if
								dw_export.setitem(i,8,dw_trae.getitemstring(j,8)) //ambito procedim
								dw_export.setitem(i,9,dw_trae.getitemstring(j,9)) //finalidad procedim	
								if dw_trae.getitemstring(j,'parto')='1' then 
									dw_export.setitem(i,10,dw_trae.getitemstring(j,10)) //personal que atiende
								else
									dw_export.setitem(i,10,'') //personal que atiende
								end if
								dw_export.setitem(i,11,dw_trae.getitemstring(j,11)) //diagprin
								dw_export.setitem(i,12,dw_trae.getitemstring(j,12)) //diagrel1
								dw_export.setitem(i,13,dw_trae.getitemstring(j,13)) //diag complicación
								dw_export.setitem(i,14,dw_trae.getitemstring(j,14)) //forma tipo acto quir
								if is_rips_cd='0' then 
									dw_export.setitem(i,15,string(dw_trae.getitemnumber(j,15),"#####0")) //vproced
								else
									dw_export.setitem(i,15,string(dw_trae.getitemnumber(j,15),"#####0.00")) //vproced
								end if
								
							case "Urgencias"
								if is_concatena_fac="1" then
									if p_dw_conts.getitemstring(1,'ctipo')='1' then  
										if  p_por_lugar<>'1' then
											 if not isnull(dw_trae.getitemstring(j,"prefijo")) then 
												dw_export.setitem(i,1,dw_trae.getitemstring(j,"prefijo")+string(dw_trae.getitemnumber(j,1),formato)) //factura
											 else
												dw_export.setitem(i,1,dw_trae.getitemstring(j,"clugar_fac")+string(dw_trae.getitemnumber(j,1),formato)) //factura
											end if
										else
											 if not isnull(dw_trae.getitemstring(j,"prefijo")) then 
												dw_export.setitem(i,1,dw_trae.getitemstring(j,"prefijo")+string(dw_trae.getitemnumber(j,1),formato)) //factura
											else
												dw_export.setitem(i,1,dw_trae.getitemstring(j,"clugar_fac")+string(dw_trae.getitemnumber(j,1),formato)) //factura
											end if
										end if
									else
										 if not isnull(dw_trae.getitemstring(j,"prefijo")) then 
											dw_export.setitem(i,1,dw_trae.getitemstring(j,"prefijo")+string(p_nradica,formato)) //factura
										else
											dw_export.setitem(i,1,string(p_nradica,formato))
										end if										
									end if
								else
									dw_export.setitem(i,1,string(dw_trae.getitemnumber(j,1))) //factura
								end if
								if l_deta='0' then
									dw_export.setitem(i,2,dw_trae.getitemstring(j,'este_codigo')) //cod_ips
								else
									dw_export.setitem(i,2,dw_trae.getitemstring(j,'c_ips')) //cod_ips
								end if
								dw_export.setitem(i,3,dw_trae.getitemstring(j,3))
								if isnull(dw_trae.getitemstring(j,32)) or dw_trae.getitemstring(j,32)='' then 
									dw_export.setitem(i,4,dw_trae.getitemstring(j,4))
								else
									dw_export.setitem(i,4,dw_trae.getitemstring(j,32)+dw_trae.getitemstring(j,4))
								end if
								dw_export.setitem(i,5,string(dw_trae.getitemdatetime(j,5),"dd/mm/yyyy"))
								dw_export.setitem(i,6,string(dw_trae.getitemdatetime(j,6),"HH:mm"))
								dw_export.setitem(i,7,left(dw_trae.getitemstring(j,7),15))//autoriza
								dw_export.setitem(i,8,dw_trae.getitemstring(j,8))//causaext
								dw_export.setitem(i,9,dw_trae.getitemstring(j,25))//diagsal
								dw_export.setitem(i,10,dw_trae.getitemstring(j,26))//drel1
								dw_export.setitem(i,11,dw_trae.getitemstring(j,27))//drel2
								dw_export.setitem(i,12,dw_trae.getitemstring(j,28))//drel3
								dw_export.setitem(i,13,dw_trae.getitemstring(j,13))//destino
								dw_export.setitem(i,14,dw_trae.getitemstring(j,14))//estado sal
								dw_export.setitem(i,15,dw_trae.getitemstring(j,29))//causamuerte
								dw_export.setitem(i,16,string(dw_trae.getitemdatetime(j,16),"dd/mm/yyyy"))
								dw_export.setitem(i,17,string(dw_trae.getitemdatetime(j,17),"HH:mm"))
								
							case "Hospitalización"
								if is_concatena_fac="1" then
									 if p_dw_conts.getitemstring(1,'ctipo')='1' then  
										if  p_por_lugar<>'1' then
											 if not isnull(dw_trae.getitemstring(j,"prefijo")) then 
												dw_export.setitem(i,1,dw_trae.getitemstring(j,"prefijo")+string(dw_trae.getitemnumber(j,1),formato)) //factura								
											 else
												dw_export.setitem(i,1,dw_trae.getitemstring(j,"clugar_fac")+string(dw_trae.getitemnumber(j,1),formato)) //factura
											end if
										else
											 if not isnull(dw_trae.getitemstring(j,"prefijo")) then 
												dw_export.setitem(i,1,dw_trae.getitemstring(j,"prefijo")+string(dw_trae.getitemnumber(j,1),formato)) //factura
											else
												dw_export.setitem(i,1,dw_trae.getitemstring(j,"clugar_fac")+string(dw_trae.getitemnumber(j,1),formato)) //factura
											end if
										end if
									else
										 if not isnull(dw_trae.getitemstring(j,"prefijo")) then 
											dw_export.setitem(i,1,dw_trae.getitemstring(j,"prefijo")+string(p_nradica,formato)) //factura
										else
											dw_export.setitem(i,1,string(p_nradica,formato))
										end if
									end if										
								else
									dw_export.setitem(i,1,string(dw_trae.getitemnumber(j,1))) //factura
								end if
								if l_deta='0' then
									dw_export.setitem(i,2,dw_trae.getitemstring(j,'este_codigo')) //cod_ips
								else
									dw_export.setitem(i,2,dw_trae.getitemstring(j,'c_ips')) //cod_ips
								end if
								
								dw_export.setitem(i,3,dw_trae.getitemstring(j,3))//tdoc
								if isnull(dw_trae.getitemstring(j,36)) or dw_trae.getitemstring(j,36)='' then 
									dw_export.setitem(i,4,dw_trae.getitemstring(j,4))//docu
								else
									dw_export.setitem(i,4,dw_trae.getitemstring(j,36)+dw_trae.getitemstring(j,4))//docu									
								end if
								dw_export.setitem(i,5,dw_trae.getitemstring(j,5))//via ing
								dw_export.setitem(i,6,string(dw_trae.getitemdatetime(j,6),"dd/mm/yyyy"))
								dw_export.setitem(i,7,string(dw_trae.getitemdatetime(j,7),"HH:mm"))
								dw_export.setitem(i,8,left(dw_trae.getitemstring(j,8),15))//autoriza
								dw_export.setitem(i,9,dw_trae.getitemstring(j,9))//causaext
								dw_export.setitem(i,10,dw_trae.getitemstring(j,27))//diag prin ing
								dw_export.setitem(i,11,dw_trae.getitemstring(j,28))//diag prin egre
								dw_export.setitem(i,12,dw_trae.getitemstring(j,29))//diag rel1
								dw_export.setitem(i,13,dw_trae.getitemstring(j,30))//diag rel2
								dw_export.setitem(i,14,dw_trae.getitemstring(j,31))//diag rel3
								dw_export.setitem(i,15,dw_trae.getitemstring(j,32))//diag compl
								dw_export.setitem(i,16,dw_trae.getitemstring(j,16))//estado sal
								dw_export.setitem(i,17,dw_trae.getitemstring(j,33))//diag muerte
								dw_export.setitem(i,18,string(dw_trae.getitemdatetime(j,18),"dd/mm/yyyy"))
								dw_export.setitem(i,19,string(dw_trae.getitemdatetime(j,19),"HH:mm"))
								
							case "Recien Nacido"
								if is_concatena_fac="1" then
									if p_dw_conts.getitemstring(1,'ctipo')='1' then  
										if  p_por_lugar<>'1' then
											 if not isnull(dw_trae.getitemstring(j,"prefijo")) then 
												dw_export.setitem(i,1,dw_trae.getitemstring(j,"prefijo")+string(dw_trae.getitemnumber(j,1),formato)) //factura
											 else
												dw_export.setitem(i,1,dw_trae.getitemstring(j,"clugar_fac")+string(dw_trae.getitemnumber(j,1),formato)) //factura
											end if
										else
											 if not isnull(dw_trae.getitemstring(j,"prefijo")) then 
												dw_export.setitem(i,1,dw_trae.getitemstring(j,"prefijo")+string(dw_trae.getitemnumber(j,1),formato)) //factura
											else
												dw_export.setitem(i,1,dw_trae.getitemstring(j,"clugar_fac")+string(dw_trae.getitemnumber(j,1),formato)) //factura
											end if
										end if
									else
										 if not isnull(dw_trae.getitemstring(j,"prefijo")) then 
											dw_export.setitem(i,1,dw_trae.getitemstring(j,"prefijo")+string(p_nradica,formato)) //factura
										else
											dw_export.setitem(i,1,string(p_nradica,formato))
										end if
									end if
								else
									dw_export.setitem(i,1,string(dw_trae.getitemnumber(j,1))) //factura
								end if
								if l_deta='0' then
									dw_export.setitem(i,2,dw_trae.getitemstring(j,'este_codigo')) //cod_ips
								else
									dw_export.setitem(i,2,dw_trae.getitemstring(j,'c_supersalud')) //cod_ips
								end if
								dw_export.setitem(i,3,dw_trae.getitemstring(j,3))//tdoc
								if isnull(dw_trae.getitemstring(j,19)) or dw_trae.getitemstring(j,19)='' then 								
									dw_export.setitem(i,4,dw_trae.getitemstring(j,4))//docu
								else
									dw_export.setitem(i,4,dw_trae.getitemstring(j,19)+dw_trae.getitemstring(j,4))//docu									
								end if
								dw_export.setitem(i,5,string(dw_trae.getitemdatetime(j,5),"dd/mm/yyyy"))//fecha_nac
								dw_export.setitem(i,6,string(dw_trae.getitemdatetime(j,5),"HH:mm"))//horanac
								dw_export.setitem(i,7,string(dw_trae.getitemnumber(j,6)))//edad gesta
								dw_export.setitem(i,8,dw_trae.getitemstring(j,7))//control prenatal
								dw_export.setitem(i,9,dw_trae.getitemstring(j,8))//sexo
								dw_export.setitem(i,10,string(dw_trae.getitemnumber(j,9)))//peso
								dw_export.setitem(i,11,dw_trae.getitemstring(j,15))//diag rn
								
								dw_export.setitem(i,12,dw_trae.getitemstring(j,16))//diag muerte
								if not isnull(dw_export.setitem(i,12,dw_trae.getitemstring(j,16))) then 
									dw_export.setitem(i,13,string(dw_trae.getitemdatetime(j,12),"dd/mm/yyyy"))
									dw_export.setitem(i,14,string(dw_trae.getitemdatetime(j,12),"HH:mm"))
								end if
								
							case "Medicamentos"
								if is_concatena_fac="1" then
									if p_dw_conts.getitemstring(1,'ctipo')='1' then  
										if  p_por_lugar<>'1' then
											 if not isnull(dw_trae.getitemstring(j,"prefijo")) then 
												dw_export.setitem(i,1,dw_trae.getitemstring(j,"prefijo")+string(dw_trae.getitemnumber(j,1),formato)) //factura
											 else
												dw_export.setitem(i,1,dw_trae.getitemstring(j,"clugar_fac")+string(dw_trae.getitemnumber(j,1),formato)) //factura
											end if
										else
											 if not isnull(dw_trae.getitemstring(j,"prefijo")) then 
												dw_export.setitem(i,1,dw_trae.getitemstring(j,"prefijo")+string(dw_trae.getitemnumber(j,1),formato)) //factura
											else
												dw_export.setitem(i,1,dw_trae.getitemstring(j,"clugar_fac")+string(dw_trae.getitemnumber(j,1),formato)) //factura
											end if
										end if
									else
										 if not isnull(dw_trae.getitemstring(j,"prefijo")) then 
											dw_export.setitem(i,1,dw_trae.getitemstring(j,"prefijo")+string(p_nradica,formato)) //factura
										else
											dw_export.setitem(i,1,string(p_nradica,formato))
										end if
									end if
								else
									dw_export.setitem(i,1,string(dw_trae.getitemnumber(j,1))) //factura
								end if
								if l_deta='0' then
									dw_export.setitem(i,2,dw_trae.getitemstring(j,'este_codigo')) //cod_ips
								else
									dw_export.setitem(i,2,dw_trae.getitemstring(j,'c_supersalud')) //cod_ips
								end if
								dw_export.setitem(i,'tdoc',dw_trae.getitemstring(j,3))//tdoc
								if isnull(dw_trae.getitemstring(j,23)) or dw_trae.getitemstring(j,23)='' then 											
									dw_export.setitem(i,'docu',dw_trae.getitemstring(j,4))//docu
								else
									dw_export.setitem(i,'docu', dw_trae.getitemstring(j,23)+dw_trae.getitemstring(j,4))//docu
								end if
								dw_export.setitem(i,'autoriza',left(dw_trae.getitemstring(j,5),15))//autoriza
								dw_export.setitem(i,'c_medica',dw_trae.getitemstring(j,"codigo_unif"))//cmedica
								dw_export.setitem(i,'nombre',left(dw_trae.getitemstring(j,8),30))//nombre med
								dw_export.setitem(i,'tipo_med',dw_trae.getitemstring(j,7))//tipo med
								dw_export.setitem(i,'forma_far',left(dw_trae.getitemstring(j,"formafarma"),20))//forma far
								dw_export.setitem(i,'concentracion',left(dw_trae.getitemstring(j,"concentracion"),20))//concentra
								dw_export.setitem(i,'u_medida',left(dw_trae.getitemstring(j,"unidadmed"),20))//umed
								dw_export.setitem(i,'cantidad',string(dw_trae.getitemnumber(j,12)))//cant
								if is_rips_cd='0' then 
									dw_export.setitem(i,'vunit',string(dw_trae.getitemnumber(j,13),"#####0"))//vunit
									dw_export.setitem(i,'vtotal',string(dw_trae.getitemnumber(j,14),"#####0"))//vtotal
								else
									dw_export.setitem(i,'vunit',string(dw_trae.getitemnumber(j,13),"#####0.00"))//vunit
									dw_export.setitem(i,'vtotal',string(dw_trae.getitemnumber(j,14),"#####0.00"))//vtotal						
								end if
									
							case "Otros"
								if is_concatena_fac="1" then
									if p_dw_conts.getitemstring(1,'ctipo')='1' then  
										if  p_por_lugar<>'1' then
											 if not isnull(dw_trae.getitemstring(j,"prefijo")) then 
												dw_export.setitem(i,1,dw_trae.getitemstring(j,"prefijo")+string(dw_trae.getitemnumber(j,1),formato)) //factura
											 else
												dw_export.setitem(i,1,dw_trae.getitemstring(j,"clugar")+string(dw_trae.getitemnumber(j,1),formato)) //factura
											end if
										else
											 if not isnull(dw_trae.getitemstring(j,"prefijo")) then 
												dw_export.setitem(i,1,dw_trae.getitemstring(j,"prefijo")+string(dw_trae.getitemnumber(j,1),formato)) //factura
											else
												dw_export.setitem(i,1,dw_trae.getitemstring(j,"clugar")+string(dw_trae.getitemnumber(j,1),formato)) //factura
											end if
										end if
									else
										 if not isnull(dw_trae.getitemstring(j,"prefijo")) then 
											dw_export.setitem(i,1,dw_trae.getitemstring(j,"prefijo")+string(p_nradica,formato)) //factura
										else
											dw_export.setitem(i,1,string(p_nradica,formato))
										end if
									end if																	
								else
									dw_export.setitem(i,1,string(dw_trae.getitemnumber(j,1))) //factura
								end if
								if l_deta='0' then
									dw_export.setitem(i,2,dw_trae.getitemstring(j,'este_codigo')) //cod_ips
								else
									dw_export.setitem(i,2,dw_trae.getitemstring(j,'c_supersalud')) //cod_ips
								end if
								dw_export.setitem(i,3,dw_trae.getitemstring(j,3))//tdoc
								if isnull(dw_trae.getitemstring(j,20)) or dw_trae.getitemstring(j,20)='' then 								
									dw_export.setitem(i,4,dw_trae.getitemstring(j,4))//docu
								else
									dw_export.setitem(i,4, dw_trae.getitemstring(j,20)+dw_trae.getitemstring(j,4))//docu
								end if
								dw_export.setitem(i,5,left(dw_trae.getitemstring(j,5),15))//autoriza
								dw_export.setitem(i,6,dw_trae.getitemstring(j,6))//tipo_serv
								if p_cups then
									if isnull(dw_trae.getitemstring(j,'c_medica')) then
										dw_export.setitem(i,7,dw_trae.getitemstring(j,'cod_cups'))//codigo										
									else
										if p_at=1 then dw_export.setitem(i,7,dw_trae.getitemstring(j,'c_medica'))//c_medica									
									end if
								else
									if isnull(dw_trae.getitemstring(j,'c_medica')) then
										dw_export.setitem(i,7,dw_trae.getitemstring(j,7))//codigo
									else
										if p_at=1 then dw_export.setitem(i,7,dw_trae.getitemstring(j,'c_medica'))//c_medica
									end if
								end if
								dw_export.setitem(i,8,left(dw_trae.getitemstring(j,8),60))//nombre
								dw_export.setitem(i,9,string(dw_trae.getitemnumber(j,9)))//cantidad
								if is_rips_cd='0' then 
									dw_export.setitem(i,10,string(dw_trae.getitemnumber(j,10),"#####0"))//vuni
									dw_export.setitem(i,11,string(dw_trae.getitemnumber(j,11),"#####0"))//vtotal
								else
									dw_export.setitem(i,10,string(dw_trae.getitemnumber(j,10),"#####0.00"))//vuni
									dw_export.setitem(i,11,string(dw_trae.getitemnumber(j,11),"#####0.00"))//vtotal
									
								end if
						end choose
						w_principal.SetMicroHelp ( 'Copiando '+cual+'(reg. '+string(j)+' de '+string(filas)+')' )
						if p_decual='emp' then tab_2.tp2_1.t1.tp1.barra.position= 25 + Int((j * 75)/filas)
					next
					//nom_arch+=right(fill('0',6)+string(p_nradica),6)+'_'+p_tipo_rad
					nom_arch+=right(fill('0',6)+string(p_nradica),6)
					docname=nom_arch
					w_principal.SetMicroHelp ( 'Exportando Archivo '+cual )
					if p_decual='emp' then
//						if tab_2.tp2_1.rb_names.checked then//preguntar una a uno
//							//docname es el largo y nom_arc el solo archivito
//							if GetFileSaveName("Archivo de "+cual+" ("+nom_arch+")",docname, nom_arch, "txt", "Archivos de Texto (*.txt),*.txt" )<>1 then
//								if p_faltan then messagebox("Atención",'De todas formas fue generada la radicación Nro: '+string(p_nradica))
//								return 0
//							end if
//						else//mandarlos todos al directorio
							docname=tab_2.tp2_1.sle_dir.text+'\'+nom_arch+'.txt'
							nom_arch+='.txt'
	//					end if
					else //de lote
						docname=tab_2.tp2_2.sle_sale.text+'\'+nom_arch+'.txt'
						nom_arch+='.txt'
					end if
					if dw_export.saveas(docname,CSV!,false)=-1 then
						if p_decual='emp' then 
							Messagebox("Error guardando archivo "+cual,"No se puede guardar el archivo, revise el espacio o el estado del disco")
						else
							log_txt="Error guardando archivo "+cual+" .No se puede guardar el archivo, revise el espacio o el estado del disco. El proceso continua"
							filewrite(i_numarc,log_txt)
						end if
					else
						w_principal.SetMicroHelp ( 'Quitando espacio a '+cual )
						f_quita_espacio_rips(docname)
						if p_decual='lote' then//escribir enm el log
							log_txt='~t~t~t'+nom_arch+' :'+string(dw_export.rowcount())+' Registro(s) (OK)'
							filewrite(i_numarc,log_txt)
						end if
					end if
					realn[arch]=mid(nom_arch,1,len(nom_arch) -4)
					tab_2.tp2_1.t1.tp1.barra.position=0
				end if
			end if
		next
		////// 2
		w_principal.SetMicroHelp ( 'Leyendo AF' )
		dw_trae.dataobject="dr_rips_af_transacc_viejo"
		dw_trae.settransobject(sqlca)
		dw_trae.reset()
		dw_trae.retrieve(p_nradica,p_clug_rad,p_por_lugar,p_tipo_rad)
		dw_export.dataobject="dr_export_rips_af_transac"
		filas=dw_trae.rowcount()
		dec comis
		for j=1 to filas
			i=dw_export.insertrow(0)
			If  p_por_lugar='0' then
				dw_export.setitem(i,'c_ips',dw_trae.getitemstring(j,"este_codigo"))				
				dw_export.setitem(i,'nombre_ips',left(dw_trae.getitemstring(j,"ips_nombre"),60))
				dw_export.setitem(i,'tipodoc_ips',dw_trae.getitemstring(j,"td_ips"))
				if tab_2.tp2_1.cbx_6.checked then 
					dw_export.setitem(i,'iden_ips',dw_trae.getitemstring(j,"doc_ips")/*+'-'+dw_trae.getitemstring(j,"ips_dv")*/)
				else
					dw_export.setitem(i,'iden_ips',dw_trae.getitemstring(j,"doc_ips"))
				end if
			else
				dw_export.setitem(i,'c_ips',dw_trae.getitemstring(j,"csuper_ips"))	
				dw_export.setitem(i,'nombre_ips',left(dw_trae.getitemstring(j,"ips_lugar"),60))
				dw_export.setitem(i,'tipodoc_ips',dw_trae.getitemstring(j,"tipo_doc"))
				if tab_2.tp2_1.cbx_6.checked then 
					dw_export.setitem(i,'iden_ips',dw_trae.getitemstring(j,"documento")/*+'-'+dw_trae.getitemstring(j,"l_dv")*/)
				else
					dw_export.setitem(i,'iden_ips',dw_trae.getitemstring(j,"documento"))
				end if
			end if

			if is_concatena_fac="1" then
			    if p_dw_conts.getitemstring(1,'ctipo')='1' then  
					if  p_por_lugar<>'1' then
						 if not isnull(dw_trae.getitemstring(j,"prefijo")) then 
							dw_export.setitem(i,'factura',dw_trae.getitemstring(j,"prefijo")+string(dw_trae.getitemnumber(j,"nfact"),formato)) //factura
						else
							dw_export.setitem(i,'factura',dw_trae.getitemstring(j,"clugar")+string(dw_trae.getitemnumber(j,"nfact"),formato)) //factura
						end if
					else
						 if not isnull(dw_trae.getitemstring(j,"prefijo")) then 
							dw_export.setitem(i,'factura',dw_trae.getitemstring(j,"prefijo")+string(dw_trae.getitemnumber(j,"nfact"),formato)) //factura
						else
							dw_export.setitem(i,'factura',dw_trae.getitemstring(j,"clugar")+string(dw_trae.getitemnumber(j,"nfact"),formato)) //factura
						end if
					end if				
				else
					 if not isnull(dw_trae.getitemstring(j,"prefijo")) then 
						dw_export.setitem(i,'factura',dw_trae.getitemstring(j,"prefijo")+string(p_nradica,formato)) //factura
					else
						dw_export.setitem(i,'factura',string(p_nradica,formato))
					end if
				end if				
			else
				dw_export.setitem(i,'factura',string(dw_trae.getitemnumber(j,"nfact"))) //factura
			end if
			dw_export.setitem(i,'fecha_fact',string(dw_trae.getitemdatetime(j,"fecha"),"dd/mm/yyyy"))
			dw_export.setitem(i,'fecha_inicio',string(fecha_ini,'dd/mm/yyyy'))
			dw_export.setitem(i,8,string(fecha_fin,'dd/mm/yyyy'))
			dw_export.setitem(i,'cod_ars',dw_trae.getitemstring(j,"codsuper"))
			dw_export.setitem(i,10,left(dw_trae.getitemstring(j,"desemp"),30))
			dw_export.setitem(i,11,dw_trae.getitemstring(j,"nro_contrato"))
			dw_export.setitem(i,12,dw_trae.getitemstring(j,"plan"))
			dw_export.setitem(i,13,dw_trae.getitemstring(j,"npoliza"))
			if is_rips_cd='0' then 
				if dw_trae.getitemnumber(j,"vtpaciente")<>0 and dw_trae.getitemnumber(j,"vtcopago")=0 then
					dw_export.setitem(i,14,string(dw_trae.getitemnumber(j,"vtpaciente"),"#####0"))
				else
					dw_export.setitem(i,14,string(dw_trae.getitemnumber(j,"vtcopago"),"#####0"))
				end if
				comis=dw_trae.getitemnumber(j,"vtcomision") 
				if isnull(comis) then comis=0
				dw_export.setitem(i,15,string(comis,"#####0"))
				dw_export.setitem(i,16,string(dw_trae.getitemnumber(j,"vtdescuentos"),"#####0"))		
				dw_export.setitem(i,17,string(dw_trae.getitemnumber(j,"vtemp"),"#####0"))		
			else
				if dw_trae.getitemnumber(j,"vtpaciente")<>0 and dw_trae.getitemnumber(j,"vtcopago")=0 then
					dw_export.setitem(i,14,string(dw_trae.getitemnumber(j,"vtpaciente"),"#####0.00"))
				else
					dw_export.setitem(i,14,string(dw_trae.getitemnumber(j,"vtcopago"),"#####0.00"))
				end if
				comis=dw_trae.getitemnumber(j,"vtcomision") 
				if isnull(comis) then comis=0
				dw_export.setitem(i,15,string(comis,"#####0.00"))
				dw_export.setitem(i,16,string(dw_trae.getitemnumber(j,"vtdescuentos"),"#####0.00"))		
				dw_export.setitem(i,17,string(dw_trae.getitemnumber(j,"vtemp"),"#####0.00"))		
			end if
			w_principal.SetMicroHelp ( 'Copiando AF reg. '+string(j)+' de '+string(filas) )
		next
		num_af=dw_export.rowcount()
		//nom_arch="AF"+right(fill('0',6)+string(p_nradica),6)+'_'+p_tipo_rad
		nom_arch="AF"+right(fill('0',6)+string(p_nradica),6)
		docname=nom_arch
		if dw_export.rowcount()>0 then
			w_principal.SetMicroHelp ( 'Exportando AF' )
			if p_decual='emp' then
//				if tab_2.tp2_1.rb_names.checked then//preguntar una a uno
//					//docname es el largo y nom_arc el solo archivito
//					if GetFileSaveName("Archivo de Transacciones ("+nom_arch+")",docname, nom_arch, "txt", "Archivos de Texto (*.txt),*.txt" )<>1 then 
//						if p_faltan then messagebox("Atención",'Aún así se generó la radicación Nro:'+string(p_nradica))
//						return 0
//					end if
//				else//mandarlos todos al directorio
					docname=tab_2.tp2_1.sle_dir.text+'\'+nom_arch+'.txt'
					nom_arch+='.txt'
		//		end if
			else
				docname=tab_2.tp2_2.sle_sale.text+'\'+nom_arch+'.txt'
				nom_arch+='.txt'
			end if
			if dw_export.saveas(docname,CSV!,false)=-1 then
				if p_decual='emp' then
					if p_faltan then
						Messagebox("Error guardando archivo de Transacciones","No se puede guardar el archivo, revise el espacio o el estado del disco.~r~nLa radicación se generará aún así.")
					else
						Messagebox("Error guardando archivo de Transacciones","No se puede guardar el archivo, revise el espacio o el estado del disco.")
					end if
				else
					log_txt="Error guardando archivo de Transacciones revise el espacio o el estado del disco.La radicación se generará aún así."
					filewrite(i_numarc,log_txt)
				end if	
				tab_2.tp2_1.t1.tp1.barra.position=0
			else
				f_quita_espacio_rips(docname)
				if p_decual='lote' then
					log_txt='~t~t~tAF'+string(p_nradica)+'.txt :'+string(dw_export.rowcount())+' Registro(s) (OK)'
					filewrite(i_numarc,log_txt)
				end if
			end if
			realn[8]=mid(nom_arch,1,len(nom_arch) -4)
		end if
		///// 2
		///// 3

		dw_trae.dataobject="dr_rips_us_usuarios"
		dw_export.dataobject="dr_export_rips_us"
		w_principal.SetMicroHelp ( 'Leyendo US' )
		dw_trae.settransobject(sqlca)
		dw_trae.reset()
		dw_trae.retrieve(p_nradica,fecha_fin,p_clug_rad,p_tipo_rad)
		//nom_arch="US"+right(fill('0',6)+string(p_nradica),6)+'_'+p_tipo_rad
		nom_arch="US"+right(fill('0',6)+string(p_nradica),6)
		docname=nom_arch
		dw_export.reset()
		filas=dw_trae.rowcount()
		for j=1 to filas
			i=dw_export.insertrow(0)
			dw_export.setitem(i,'cod_ars',dw_trae.getitemstring(j,"codsuper"))
			dw_export.setitem(i,'tipo_doc',dw_trae.getitemstring(j,"tipodoc"))
			if isnull(dw_trae.getitemstring(j,'pais')) or dw_trae.getitemstring(j,'pais')='' then 	
				dw_export.setitem(i,'doc',RightTrim(LeftTrim(dw_trae.getitemstring(j,"documento"))))
			else
				dw_export.setitem(i,'doc',dw_trae.getitemstring(j,'pais')+RightTrim(LeftTrim(dw_trae.getitemstring(j,"documento"))	))
			end if
			dw_export.setitem(i,'tip_usu',dw_trae.getitemstring(j,"tu"))
			dw_export.setitem(i,'apellido1',RightTrim(LeftTrim(dw_trae.getitemstring(j,"apellido1"))))
			dw_export.setitem(i,'apellido2',RightTrim(LeftTrim(dw_trae.getitemstring(j,"apellido2"))))
			dw_export.setitem(i,'nombre1',RightTrim(LeftTrim(dw_trae.getitemstring(j,"nombre1"))))
			dw_export.setitem(i,'nombre2',RightTrim(LeftTrim(dw_trae.getitemstring(j,"nombre2"))))
			dw_export.setitem(i,'edad',string(dw_trae.getitemnumber(j,"edad")))
			dw_export.setitem(i,'umed_edad',dw_trae.getitemstring(j,"u_med"))
			dw_export.setitem(i,'sexo',dw_trae.getitemstring(j,"sexo"))
			dw_export.setitem(i,'departa',dw_trae.getitemstring(j,"cdepto"))
			dw_export.setitem(i,'municip',dw_trae.getitemstring(j,"cciudad"))
			dw_export.setitem(i,'zona_r',dw_trae.getitemstring(j,"zonar"))
			w_principal.SetMicroHelp ( 'Copiando US reg. '+string(j) + ' de '+string(filas))
		next
		num_us=dw_export.rowcount()
		if dw_export.rowcount()>0 then
			w_principal.SetMicroHelp ( 'Exportando US' )
			if p_decual='emp' then
//				if tab_2.tp2_1.rb_names.checked then//preguntar una a uno
//					//docname es el largo y nom_arc el solo archivito
//					if GetFileSaveName("Archivo de Usuarios ("+nom_arch+")",docname, nom_arch, "txt", "Archivos de Texto (*.txt),*.txt" )<>1 then
//						if p_faltan then messagebox("Atención",'Aún así se generó la radicación Nro:'+string(p_nradica))
//						return 0
//					end if
//				else//mandarlos todos al directorio
					docname=tab_2.tp2_1.sle_dir.text+'\'+nom_arch+'.txt'
					nom_arch+='.txt'
	//			end if
			else
				docname=tab_2.tp2_2.sle_sale.text+'\'+nom_arch+'.txt'
				nom_arch+='.txt'
			end if
			if dw_export.saveas(docname,CSV!,false)=-1 then
				if p_decual='emp' then 
					if p_faltan then
						Messagebox("Error guardando archivo de usuarios","No se puede guardar el archivo, revise el espacio o el estado del disco.~r~nLa radiciación generará aún así.")
					else
						Messagebox("Error guardando archivo de usuarios","No se puede guardar el archivo, revise el espacio o el estado del disco.")
					end if
				else
					log_txt="Error guardando archivo de usuarios revise el espacio o el estado del disco.La radicación se generará aún así."
					filewrite(i_numarc,log_txt)
				end if
			else
				f_quita_espacio_rips(docname)
				if p_decual='lote' then
					log_txt='~t~t~tUS'+string(p_nradica)+'.txt :'+string(dw_export.rowcount())+' Registro(s) (OK)'
					filewrite(i_numarc,log_txt)
				end if
			end if
			realn[10]=mid(nom_arch,1,len(nom_arch) -4)
		end if
		
		dw_export.dataobject="dr_export_rips_ac"
		dw_export.reset()
		string fecha_rad
		w_principal.SetMicroHelp ( 'Copiando CT' )
		if p_faltan then 
			fecha_rad=string(today(),"dd/mm/yyyy")
		else
			fecha_rad=string(tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemdatetime(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),"fecha_radica"),"dd/mm/yyyy")
		end if
		if rb_7.checked then 
			select c_supersalud into :cips from ips where c_ips='01'; //ahi solo puede estar este código
		else
			select c_supersalud into :cips from lugar where codlugar=:clug; //ahi solo puede estar este código
		end if
		if num_ad>0 then
			dw_export.insertrow(1)
			dw_export.setitem(1,1,cips)
			dw_export.setitem(1,2,fecha_rad)
			dw_export.setitem(1,3,realn[9]) //ad
			dw_export.setitem(1,4,string(num_ad))
		end if
		if num_af>0 then
			dw_export.insertrow(1)
			dw_export.setitem(1,1,cips)
			dw_export.setitem(1,2,fecha_rad)
			dw_export.setitem(1,3,realn[8]) //af
			dw_export.setitem(1,4,string(num_af))
		end if
		if num_us>0 then
			dw_export.insertrow(1)
			dw_export.setitem(1,1,cips)
			dw_export.setitem(1,2,fecha_rad)
			dw_export.setitem(1,3,realn[10])//us
			dw_export.setitem(1,4,string(num_us))
		end if
		for j=1 to 7
			if n_reg[j]>0 then
				i=dw_export.insertrow(0)
				dw_export.setitem(i,1,cips)
				dw_export.setitem(i,2,fecha_rad)
				dw_export.setitem(i,3,realn[j])
				dw_export.setitem(i,4,string(n_reg[j]))
			end if
		next
		w_principal.SetMicroHelp ( 'Exportando CT' )
		//nom_arch="CT"+right(fill('0',6)+string(p_nradica),6)+'_'+p_tipo_rad
		nom_arch="CT"+right(fill('0',6)+string(p_nradica),6)
		docname=nom_arch
		if dw_export.rowcount()>0 then
			if p_decual='emp' then
				docname=tab_2.tp2_1.sle_dir.text+'\'+nom_arch+'.txt'
				nom_arch+='.txt'
			else
				docname=tab_2.tp2_2.sle_sale.text+'\'+nom_arch+'.txt'
				nom_arch+='.txt'
			end if
			if dw_export.saveas(docname,CSV!,false)=-1 then
				if p_decual='emp' then
					if p_faltan then
						Messagebox("Error guardando archivo","No se puede guardar el archivo, revise el espacio o el estado del disco.~r~nLa radicación fue genarada aún así.")
					else
						Messagebox("Error guardando archivo","No se puede guardar el archivo, revise el espacio o el estado del disco.")
					end if
				else
					log_txt="Error guardando archivo de Control revise el espacio o el estado del disco.La radicación se generará aún así."
					filewrite(i_numarc,log_txt)
				end if
			else
				f_quita_espacio_rips(docname)
				if p_decual='lote' then
					log_txt='~t~t~tCT'+string(p_nradica)+'.txt :'+string(dw_export.rowcount())+' Registro(s) (OK)'
					filewrite(i_numarc,log_txt)
				end if
			end if
		end if
		if p_decual='lote' and p_nradica>0  then
			log_txt='NRO RADICACIÓN: '+right(fill('0',6)+string(p_nradica),6)+'_'+p_tipo_rad+'~r~n'
			filewrite(i_numarc,log_txt)
		end if
		////// 1
	else //son los de forecat
		//genera_forecat(p_nradica,p_clug_rad,fecha_fin,p_faltan)
		genera_furips(p_nradica,p_clug_rad,fecha_radica,p_faltan,p_tipo_rad)
	end if
	w_principal.SetMicroHelp ( 'Gestión Clínica Integrada' )
	if p_reserva='1' and p_nradica<>0 then
		tot_evento=round(p_dw_conts.getitemdecimal(1,'t_evento'),l_dec_fact)
		factus=p_dw_conts.getitemdecimal(1,'t_factus')
		UPDATE ripsradica SET reserva = '0', valor_evento=:tot_evento,nro_factu=:factus,reserva_cap=cast(cast( reserva_cap as integer) + 1 as varchar)
		WHERE (((ripsradica.num_radicacion)=:p_nradica) AND ((ripsradica.clugar)=:p_clug_rad) AND ((ripsradica.TIPO)=:p_tipo_rad));
		if sqlca.sqlcode=-1 then
			messagebox("Error Actualizando en Ripsradica",sqlca.sqlerrtext)
			return -1
		end if
		for j=1 to p_dw_conts.rowcount()
			tot_evento=round(p_dw_conts.getitemdecimal(j,'valor_evento'),2)
			factus=p_dw_conts.getitemdecimal(j,'nro_factu')
			l_cont=p_dw_conts.getitemstring(j,"ccontrato")	
			UPDATE ripsradicadet SET  valor_evento=:tot_evento,nro_factu=:factus
			WHERE (((ripsradicadet.num_radicacion)=:p_nradica) AND ((ripsradicadet.clugar)=:p_clug_rad) AND ((ripsradicadet.TIPO)=:p_tipo_rad) AND ((ripsradicadet.CEMP)=:emp) AND ((ripsradicadet.CCONTRATO)=:l_cont));
			if sqlca.sqlcode=-1 then
				messagebox("Error Actualizando en Ripsradicadet",sqlca.sqlerrtext)
				return -1
			end if
		next
	end if
else
	messagebox("Atención",'No hay registros para generar')
	return 0
end if
return p_nradica
end function

on w_rias.create
this.dw_electronica=create dw_electronica
this.gb_1=create gb_1
this.gb_4=create gb_4
this.dw_getar=create dw_getar
this.dw_temp=create dw_temp
this.dw_det_lote=create dw_det_lote
this.dw_export=create dw_export
this.dw_trae=create dw_trae
this.rb_10=create rb_10
this.rb_9=create rb_9
this.dw_tipin=create dw_tipin
this.tab_2=create tab_2
this.rb_7=create rb_7
this.rb_8=create rb_8
this.dw_lug=create dw_lug
this.Control[]={this.dw_electronica,&
this.gb_1,&
this.gb_4,&
this.dw_getar,&
this.dw_temp,&
this.dw_det_lote,&
this.dw_export,&
this.dw_trae,&
this.rb_10,&
this.rb_9,&
this.dw_tipin,&
this.tab_2,&
this.rb_7,&
this.rb_8,&
this.dw_lug}
end on

on w_rias.destroy
destroy(this.dw_electronica)
destroy(this.gb_1)
destroy(this.gb_4)
destroy(this.dw_getar)
destroy(this.dw_temp)
destroy(this.dw_det_lote)
destroy(this.dw_export)
destroy(this.dw_trae)
destroy(this.rb_10)
destroy(this.rb_9)
destroy(this.dw_tipin)
destroy(this.tab_2)
destroy(this.rb_7)
destroy(this.rb_8)
destroy(this.dw_lug)
end on

event open;SELECT cadena into :is_concatena_fac
FROM parametros_gen
WHERE (((codigo_para)=13));
if sqlca.sqlnrows=0 then
	messagebox('Atencíon','No hay parametro 13')
	return 
end if

SELECT entero into :i_nro_dig
FROM parametros_gen
WHERE (((codigo_para)=14));
if sqlca.sqlnrows=0 then
	messagebox('Atencíon','No hay parametro 14')
	return 
end if

SELECT entero into :l_dec_fact
FROM parametros_gen
WHERE (((codigo_para)=17));
if sqlca.sqlnrows=0 then
	messagebox('Atencíon','No hay parametro 17')
	return
end if

SELECT cadena into :is_rips_cd
FROM parametros_gen
WHERE (((codigo_para)=53));
if sqlca.sqlnrows=0 then
	messagebox('Atencíon','No hay parametro 53')
	return 
end if

SELECT cadena into :is_elec
FROM parametros_gen
WHERE (((codigo_para)=66));
if sqlca.sqlnrows=0 then
	messagebox('Atencíon','No hay parametro 66')
	return
end if

i_rep=create uo_report

w_principal.ArrangeSheets ( layer!)

end event

type dw_electronica from uo_datawindow within w_rias
boolean visible = false
integer x = 5243
integer y = 40
integer width = 754
integer height = 60
integer taborder = 50
string dataobject = "asis_int_factura_ele_cap"
end type

type gb_1 from groupbox within w_rias
integer x = 1893
integer width = 1865
integer height = 128
integer taborder = 30
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Lugares"
end type

type gb_4 from groupbox within w_rias
integer x = 3831
integer width = 1614
integer height = 128
integer taborder = 40
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Servicio"
end type

type dw_getar from datawindow within w_rias
boolean visible = false
integer x = 6194
integer y = 16
integer width = 69
integer height = 68
integer taborder = 60
string title = "none"
string dataobject = "dw_act_getareo"
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event dberror; if is_decual='lote' then 
	filewrite(i_numarc,sqlerrtext)
	return 1 //para que no muestre el error en pantalla
end if
end event

event constructor;settransobject(sqlca)
end event

type dw_temp from datawindow within w_rias
string tag = "para armar los de actividad final"
boolean visible = false
integer x = 6277
integer y = 20
integer width = 69
integer height = 68
integer taborder = 20
string title = "none"
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event dberror; if is_decual='lote' then 
	filewrite(i_numarc,sqlerrtext)
	return 1 //para que no muestre el error en pantalla
end if
end event

type dw_det_lote from datawindow within w_rias
boolean visible = false
integer x = 6373
integer y = 24
integer width = 69
integer height = 68
integer taborder = 50
boolean enabled = false
string title = "none"
string dataobject = "dw_contratos_pa_rias"
boolean resizable = true
boolean livescroll = true
end type

event dberror;filewrite(i_numarc,sqlerrtext)
return 1 //para que no muestre el error en pantalla
end event

event constructor;settransobject(sqlca)
end event

type dw_export from datawindow within w_rias
boolean visible = false
integer x = 6080
integer y = 20
integer width = 87
integer height = 64
boolean bringtotop = true
boolean enabled = false
string title = "none"
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

type dw_trae from datawindow within w_rias
boolean visible = false
integer x = 6469
integer y = 28
integer width = 69
integer height = 76
boolean bringtotop = true
boolean enabled = false
string title = "none"
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event retrievestart;return 2
end event

event dberror; if is_decual='lote' then 
	filewrite(i_numarc,sqlerrtext)
	return 1 //para que no muestre el error en pantalla
else
	rollback;
end if
end event

type rb_10 from radiobutton within w_rias
integer x = 4128
integer y = 52
integer width = 224
integer height = 60
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Solo:"
end type

type rb_9 from radiobutton within w_rias
integer x = 3895
integer y = 52
integer width = 224
integer height = 60
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Todos"
boolean checked = true
end type

type dw_tipin from datawindow within w_rias
integer x = 4366
integer y = 40
integer width = 1070
integer height = 76
integer taborder = 70
boolean bringtotop = true
string title = "none"
string dataobject = "dw_tip_ingres_drop"
boolean border = false
boolean livescroll = true
end type

event constructor;settransobject(sqlca)
insertrow(1)
setitem(1,1,'1')
end event

event itemchanged;rb_10.checked=true
end event

type tab_2 from tab within w_rias
event create ( )
event destroy ( )
integer x = 18
integer y = 28
integer width = 6917
integer height = 2540
integer taborder = 10
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long backcolor = 67108864
boolean fixedwidth = true
boolean raggedright = true
boolean focusonbuttondown = true
boolean powertips = true
alignment alignment = center!
integer selectedtab = 1
tp2_1 tp2_1
tp2_3 tp2_3
tp2_2 tp2_2
end type

on tab_2.create
this.tp2_1=create tp2_1
this.tp2_3=create tp2_3
this.tp2_2=create tp2_2
this.Control[]={this.tp2_1,&
this.tp2_3,&
this.tp2_2}
end on

on tab_2.destroy
destroy(this.tp2_1)
destroy(this.tp2_3)
destroy(this.tp2_2)
end on

event selectionchanged;Choose Case newindex
	Case 1
		gb_1.visible=true
		rb_7.visible=true
		rb_8.visible=true
		dw_lug.visible=true
		gb_4.visible=true
		rb_9.visible=true
		rb_10.visible=true
		dw_tipin.visible=true
	Case 2
		gb_1.visible=true
		rb_7.visible=true
		rb_8.visible=true
		dw_lug.visible=true
		gb_4.visible=false
		rb_9.visible=false
		rb_10.visible=false
		dw_tipin.visible=false		
	Case 3
		gb_1.visible=false
		rb_7.visible=false
		rb_8.visible=false
		dw_lug.visible=false
		gb_4.visible=false
		rb_9.visible=false
		rb_10.visible=false
		dw_tipin.visible=false
end choose
end event

type tp2_1 from userobject within tab_2
event create ( )
event destroy ( )
integer x = 18
integer y = 112
integer width = 6880
integer height = 2412
long backcolor = 67108864
string text = "Por Empresa"
long tabtextcolor = 33554432
string picturename = "guardar.ico"
long picturemaskcolor = 536870912
string powertiptext = "Generar RIPS por Empresa"
rb_json rb_json
rb_txt rb_txt
cbx_7 cbx_7
cbx_at cbx_at
cbx_6 cbx_6
cbx_5 cbx_5
cbx_2 cbx_2
t1 t1
rb_4 rb_4
rb_3 rb_3
tab_1 tab_1
rb_defecto rb_defecto
cb_dir cb_dir
gb_8 gb_8
gb_5 gb_5
sle_dir sle_dir
gb_12 gb_12
end type

on tp2_1.create
this.rb_json=create rb_json
this.rb_txt=create rb_txt
this.cbx_7=create cbx_7
this.cbx_at=create cbx_at
this.cbx_6=create cbx_6
this.cbx_5=create cbx_5
this.cbx_2=create cbx_2
this.t1=create t1
this.rb_4=create rb_4
this.rb_3=create rb_3
this.tab_1=create tab_1
this.rb_defecto=create rb_defecto
this.cb_dir=create cb_dir
this.gb_8=create gb_8
this.gb_5=create gb_5
this.sle_dir=create sle_dir
this.gb_12=create gb_12
this.Control[]={this.rb_json,&
this.rb_txt,&
this.cbx_7,&
this.cbx_at,&
this.cbx_6,&
this.cbx_5,&
this.cbx_2,&
this.t1,&
this.rb_4,&
this.rb_3,&
this.tab_1,&
this.rb_defecto,&
this.cb_dir,&
this.gb_8,&
this.gb_5,&
this.sle_dir,&
this.gb_12}
end on

on tp2_1.destroy
destroy(this.rb_json)
destroy(this.rb_txt)
destroy(this.cbx_7)
destroy(this.cbx_at)
destroy(this.cbx_6)
destroy(this.cbx_5)
destroy(this.cbx_2)
destroy(this.t1)
destroy(this.rb_4)
destroy(this.rb_3)
destroy(this.tab_1)
destroy(this.rb_defecto)
destroy(this.cb_dir)
destroy(this.gb_8)
destroy(this.gb_5)
destroy(this.sle_dir)
destroy(this.gb_12)
end on

type rb_json from radiobutton within tp2_1
integer x = 4498
integer y = 40
integer width = 210
integer height = 64
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Json"
end type

type rb_txt from radiobutton within tp2_1
integer x = 4288
integer y = 44
integer width = 183
integer height = 56
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Txt"
boolean checked = true
end type

type cbx_7 from checkbox within tp2_1
integer x = 3607
integer y = 36
integer width = 402
integer height = 64
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Detalle x Sitio"
end type

type cbx_at from checkbox within tp2_1
integer x = 3168
integer y = 36
integer width = 384
integer height = 72
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 67108864
string text = "AT/c_medica"
end type

type cbx_6 from checkbox within tp2_1
integer x = 2757
integer y = 36
integer width = 370
integer height = 64
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Nit Completo"
end type

type cbx_5 from checkbox within tp2_1
integer x = 2286
integer y = 36
integer width = 457
integer height = 64
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Capitación Valor"
end type

type cbx_2 from checkbox within tp2_1
integer x = 1637
integer y = 36
integer width = 622
integer height = 64
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Incluir facturas en Cero"
end type

type t1 from tab within tp2_1
event create ( )
event destroy ( )
integer y = 1036
integer width = 6834
integer height = 1348
integer taborder = 110
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long backcolor = 67108864
boolean fixedwidth = true
boolean raggedright = true
boolean focusonbuttondown = true
alignment alignment = center!
integer selectedtab = 1
tp1 tp1
fac fac
tmod tmod
tp2 tp2
end type

on t1.create
this.tp1=create tp1
this.fac=create fac
this.tmod=create tmod
this.tp2=create tp2
this.Control[]={this.tp1,&
this.fac,&
this.tmod,&
this.tp2}
end on

on t1.destroy
destroy(this.tp1)
destroy(this.fac)
destroy(this.tmod)
destroy(this.tp2)
end on

event selectionchanged;string ls_objetor,ls_lug,ls_tipo
double ldb_nrad

ldb_nrad=tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemnumber(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),'num_radicacion')
ls_lug=tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemstring(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),'clugar')
ls_tipo=tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemstring(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),'tipo')

If newindex=2 then
	tab_2.tp2_1.t1.fac.dw_fact.retrieve(ldb_nrad,ls_lug,ls_tipo)
end if

If newindex=2 then
	tab_2.tp2_1.t1.tmod.dw_mod.retrieve(ldb_nrad,ls_lug,ls_tipo)
end if
end event

type tp1 from userobject within t1
event create ( )
event destroy ( )
integer x = 18
integer y = 112
integer width = 6798
integer height = 1220
long backcolor = 67108864
string text = "Detalle RIPS"
long tabtextcolor = 33554432
string picturename = "guardar.ico"
long picturemaskcolor = 536870912
dw_ria dw_ria
cbx_replica cbx_replica
st_10 st_10
st_2 st_2
st_3 st_3
st_4 st_4
st_5 st_5
st_6 st_6
pb_buscar pb_buscar
st_cuantos st_cuantos
st_11 st_11
stt_diag stt_diag
rb_completo rb_completo
rb_incompleto rb_incompleto
rb_todos rb_todos
barra barra
cbx_1 cbx_1
em_21 em_21
sle_7 sle_7
rb_2 rb_2
rb_1 rb_1
pb_ayuda pb_ayuda
pb_guardar pb_guardar
pb_trae pb_trae
drop_tipo drop_tipo
st_7 st_7
gb_6 gb_6
gb_3 gb_3
gb_2 gb_2
st_tdoc st_tdoc
st_docu st_docu
st_paciente st_paciente
st_sexo st_sexo
st_edad st_edad
st_nfact st_nfact
dw_1 dw_1
em_11 em_11
sle_6 sle_6
end type

on tp1.create
this.dw_ria=create dw_ria
this.cbx_replica=create cbx_replica
this.st_10=create st_10
this.st_2=create st_2
this.st_3=create st_3
this.st_4=create st_4
this.st_5=create st_5
this.st_6=create st_6
this.pb_buscar=create pb_buscar
this.st_cuantos=create st_cuantos
this.st_11=create st_11
this.stt_diag=create stt_diag
this.rb_completo=create rb_completo
this.rb_incompleto=create rb_incompleto
this.rb_todos=create rb_todos
this.barra=create barra
this.cbx_1=create cbx_1
this.em_21=create em_21
this.sle_7=create sle_7
this.rb_2=create rb_2
this.rb_1=create rb_1
this.pb_ayuda=create pb_ayuda
this.pb_guardar=create pb_guardar
this.pb_trae=create pb_trae
this.drop_tipo=create drop_tipo
this.st_7=create st_7
this.gb_6=create gb_6
this.gb_3=create gb_3
this.gb_2=create gb_2
this.st_tdoc=create st_tdoc
this.st_docu=create st_docu
this.st_paciente=create st_paciente
this.st_sexo=create st_sexo
this.st_edad=create st_edad
this.st_nfact=create st_nfact
this.dw_1=create dw_1
this.em_11=create em_11
this.sle_6=create sle_6
this.Control[]={this.dw_ria,&
this.cbx_replica,&
this.st_10,&
this.st_2,&
this.st_3,&
this.st_4,&
this.st_5,&
this.st_6,&
this.pb_buscar,&
this.st_cuantos,&
this.st_11,&
this.stt_diag,&
this.rb_completo,&
this.rb_incompleto,&
this.rb_todos,&
this.barra,&
this.cbx_1,&
this.em_21,&
this.sle_7,&
this.rb_2,&
this.rb_1,&
this.pb_ayuda,&
this.pb_guardar,&
this.pb_trae,&
this.drop_tipo,&
this.st_7,&
this.gb_6,&
this.gb_3,&
this.gb_2,&
this.st_tdoc,&
this.st_docu,&
this.st_paciente,&
this.st_sexo,&
this.st_edad,&
this.st_nfact,&
this.dw_1,&
this.em_11,&
this.sle_6}
end on

on tp1.destroy
destroy(this.dw_ria)
destroy(this.cbx_replica)
destroy(this.st_10)
destroy(this.st_2)
destroy(this.st_3)
destroy(this.st_4)
destroy(this.st_5)
destroy(this.st_6)
destroy(this.pb_buscar)
destroy(this.st_cuantos)
destroy(this.st_11)
destroy(this.stt_diag)
destroy(this.rb_completo)
destroy(this.rb_incompleto)
destroy(this.rb_todos)
destroy(this.barra)
destroy(this.cbx_1)
destroy(this.em_21)
destroy(this.sle_7)
destroy(this.rb_2)
destroy(this.rb_1)
destroy(this.pb_ayuda)
destroy(this.pb_guardar)
destroy(this.pb_trae)
destroy(this.drop_tipo)
destroy(this.st_7)
destroy(this.gb_6)
destroy(this.gb_3)
destroy(this.gb_2)
destroy(this.st_tdoc)
destroy(this.st_docu)
destroy(this.st_paciente)
destroy(this.st_sexo)
destroy(this.st_edad)
destroy(this.st_nfact)
destroy(this.dw_1)
destroy(this.em_11)
destroy(this.sle_6)
end on

type dw_ria from datawindow within tp1
event clickup pbm_dwnlbuttonup
integer x = 14
integer y = 384
integer width = 6738
integer height = 816
integer taborder = 250
string title = "none"
string dataobject = "dw_genera_rips"
boolean hscrollbar = true
boolean vscrollbar = true
boolean hsplitscroll = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event clickup;string ls_cual
if dwo.type="text" then
	modify(string(dwo.name)+".border=6")
	ls_cual=dwo.name
	ls_cual=mid(ls_cual,1,len(ls_cual) -2)
	if is_anterior=ls_cual then
		if is_orden="A" then
			is_orden="D"
		else
			is_orden="A"
		end if
	else
		is_orden="A"
	end if
	dw_ria.setsort(ls_cual+" "+is_orden)
	dw_ria.sort()
	is_anterior=ls_cual
end if
end event

event clicked;if dwo.type="text" then
	modify(string(dwo.name)+".border=5")
end if
end event

event constructor;settransobject(sqlca)
end event

event doubleclicked;string colu,carreta,resu,cual,temp
colu= dwo.name
cual="r_" + mid(colu,3)
if right(cual,1)='_' then cual=left(cual,len(cual)-1)
if describe(cual+".id")="!" then return
carreta="evaluate ('if ("+ cual +'="0", 1, 0 )'+"'," +string(row) +")"
resu=describe(carreta)
if resu="1" then return
if colu="s_diagprin_" or colu="s_diagrel1_" or colu="s_diagrel2_" or colu="s_diagrel3_" or colu="s_diagcompli_" then
	st_edadsexo st_es
	st_diag st_d
	st_es.sexo=getitemstring(row,"sexo")
	st_es.edad=getitemnumber(row,"dias")
	st_es.antece='0'
	openwithparm(w_busca_diag,st_es)
	st_d=message.powerobjectparm
	if not isValid(st_d) then return
	if not isNull(st_d.codrip) then
		setitem(row,left(colu,len(colu)-1),st_d.codgeral)
		setitem(row,colu,st_d.codrip)
		stt_diag.text=st_d.descripcion
	end if
end if
if colu="s_codespecialidad" then
	open (w_busca_espe)
end if
end event

event itemchanged;accepttext()
string cod,col,nulo
long colum,i,veri
st_return_diags st

setnull(nulo)
colum=getcolumn()
col=getcolumnname()
if dataobject<>"dw_genera_rips" and dataobject<>"dw_genera_rips2" then return
if colum=13 then
	select desesp into :stt_diag.text from especialidades where codesp= :data;
	if stt_diag.text="" then return 1
end if
choose case colum
	case 7
		if cbx_replica.checked then
			for i=1 to rowcount()
				if i<>row then
					if isnull(getitemstring(i,string(dwo.name))) then
						setitem(i,dwo.name,data)
					end if
				end if
			next
		end if
	case 13, 15, 17, 33, 35, 37
		if cbx_replica.checked then
			for i=1 to rowcount()
				if i<>row and not isnull(getitemstring(i,"r_"+mid(dwo.name,3))) then
					if isnull(getitemstring(i,string(dwo.name))) then
						if (this.getitemstring(row,'s_fin_consulta') >='01' and this.getitemstring(row,'s_fin_consulta') <= '08') then 
							this.setitem(row,'s_causaexterna',"15")
						else
							this.setitem(row,'s_causaexterna',nulo)
						end if 
						veri=f_valida_fin_con(this.getitemstring(i,'s_fin_consulta'),this.getitemstring(i,'s_causaexterna'),this.getitemstring(i,"sexo"),this.getitemnumber(i,"dias"),this.getitemstring(i,'s_diagprin'))
						if veri=-1 then
							this.setitem(i,dwo.name,'')
							return 1
						end if
						setitem(i,dwo.name,data)
					end if
				end if
			next
		end if
		if (this.getitemstring(row,'s_fin_consulta') >='01' and this.getitemstring(row,'s_fin_consulta') <= '08') then 
			this.setitem(row,'s_causaexterna',"15")
		else
			this.setitem(row,'s_causaexterna',nulo)
		end if 
		veri=f_valida_fin_con(this.getitemstring(row,'s_fin_consulta'),this.getitemstring(row,'s_causaexterna'),this.getitemstring(row,"sexo"),this.getitemnumber(row,"dias"),this.getitemstring(row,'s_diagprin'))
		if veri=-1 then
			this.setitem(row,colum,"")
			return 1
		end if
	
		
	case 62,63,64,65,66
		string este=''
		setnull(nulo)
		if data<>"" then
			st=f_check_diag(data,getitemstring(row,"sexo"),getitemnumber(row,"dias"),este,'0')
			if st.descrip_diag="" then
				setitem(row,colum,"")
				setitem(row,left(col,len(col)-1),nulo)
				return 1
			end if
			stt_diag.text=st.descrip_diag
			setitem(row,left(col,len(col)-1),este)
		else
			stt_diag.text=''
			setitem(row,left(col,len(col)-1),nulo)
		end if
end choose
end event

event itemfocuschanged;accepttext()
string cod,ojo,este,col,nulo
long colum
st_return_diags st

setnull(nulo)
colum=getcolumn()
col=getcolumnname()
if dataobject="dr_rips_rn" or dataobject="dr_rips_rn_viejo" then
	choose case colum
	case 15,16
		if getitemstring(row,colum)<>"" then
			este=getitemstring(row,left(col,len(col)-1))
			st=f_check_diag(getitemstring(row,colum),getitemstring(row,"sexorn"),1,este,'0')
			if st.descrip_diag="" then
				setitem(row,colum,"")
				setitem(row,left(col,len(col)-1),nulo)
				return 1
			end if
			stt_diag.text=st.descrip_diag
		else
			stt_diag.text=""
		end if
end choose
end if
if dataobject<>"dw_genera_rips" and dataobject<>"dw_genera_rips2" then return
choose case colum
	case 13
		ojo=getitemstring(row,colum)
		if ojo<>"" then
			select desesp into :stt_diag.text from especialidades where codesp= :ojo;
		end if
	case 3
		ojo=getitemstring(row,colum)
		if ojo<>"" then
			select descripcion into :stt_diag.text from proced where codproced= :ojo;
		end if
	case 10	
	case 62,63,64,65,66
		if getitemstring(row,colum)<>"" then
			este=getitemstring(row,left(col,len(col)-1))
			st=f_check_diag(getitemstring(row,colum),getitemstring(row,"sexo"),getitemnumber(row,"dias"),este,'0')
			if st.descrip_diag="" then
				setitem(row,colum,"")
				setitem(row,left(col,len(col)-1),nulo)
				return 1
			end if
			stt_diag.text=st.descrip_diag
		else
			stt_diag.text=""
		end if
end choose
end event

event retrieveend;if dataobject<>"dw_genera_rips" and dataobject<>"dw_genera_rips2" then return
if update() = 1 then 
	commit;
	cuenta()
end if
end event

event retrievestart;if tab_2.tp2_1.tab_1.selectedtab=1 then return 2
end event

event rowfocuschanged;long fila
if dataobject<>"dw_genera_rips" and dataobject<>"dw_genera_rips2" then return
fila=getrow()
if fila<=0 then return
st_tdoc.text=getitemstring(fila,"tipodoc")
st_docu.text=getitemstring(fila,"documento")
st_paciente.text=getitemstring(fila,"paciente")
st_sexo.text=getitemstring(fila,"sexo")
st_edad.text=getitemstring(fila,"edad")
st_nfact.text=string(getitemnumber(fila,"s_nfactura"))
end event

event updatestart;if dataobject<>"dw_genera_rips" and dataobject<>"dw_genera_rips2" then return
long i , filas
string nv_est,estr
filas=rowcount()
for i=1 to filas
	nv_est=getitemstring(i,'estado')
	if nv_est<>"Anulado" then 
		choose case nv_est
			case "Completo"
				estr="1"
			case "Incompleto"
				estr="2"
		end choose
		setitem(i,"estria",estr)
	end if
next
end event

event itemerror;return 1
end event

type cbx_replica from checkbox within tp1
integer x = 32
integer y = 176
integer width = 535
integer height = 52
integer taborder = 220
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Replicar para Todos"
end type

type st_10 from statictext within tp1
integer x = 2661
integer y = 312
integer width = 279
integer height = 52
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Diagnóstico:"
boolean focusrectangle = false
end type

type st_2 from statictext within tp1
integer x = 18
integer y = 316
integer width = 270
integer height = 48
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Documento:"
boolean focusrectangle = false
end type

type st_3 from statictext within tp1
integer x = 539
integer y = 312
integer width = 219
integer height = 48
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Nombre:"
boolean focusrectangle = false
end type

type st_4 from statictext within tp1
integer x = 1801
integer y = 312
integer width = 142
integer height = 48
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Sexo:"
boolean focusrectangle = false
end type

type st_5 from statictext within tp1
integer x = 1943
integer y = 312
integer width = 133
integer height = 48
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Edad:"
boolean focusrectangle = false
end type

type st_6 from statictext within tp1
integer x = 2290
integer y = 320
integer width = 343
integer height = 48
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Nro Factura:"
boolean focusrectangle = false
end type

type pb_buscar from picturebutton within tp1
event mousemove pbm_mousemove
integer x = 4754
integer y = 76
integer width = 142
integer height = 124
integer taborder = 240
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
string text = "          &u"
string picturename = "buscar2.GIF"
string disabledname = "d_buscar2.GIF"
alignment htextalign = left!
string powertiptext = "Buscar dentro de Registros [Alt+U]"
end type

event clicked;if dw_ria.rowcount()=0 then return
open(w_busca_rias)
end event

type st_cuantos from statictext within tp1
integer x = 6386
integer y = 84
integer width = 343
integer height = 68
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long backcolor = 15793151
alignment alignment = center!
boolean border = true
borderstyle borderstyle = stylelowered!
boolean focusrectangle = false
end type

type st_11 from statictext within tp1
integer x = 6103
integer y = 76
integer width = 229
integer height = 52
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Registros:"
boolean focusrectangle = false
end type

type stt_diag from statictext within tp1
integer x = 2661
integer y = 244
integer width = 4087
integer height = 68
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
boolean border = true
borderstyle borderstyle = stylelowered!
boolean focusrectangle = false
end type

type rb_completo from radiobutton within tp1
integer x = 5691
integer y = 88
integer width = 315
integer height = 64
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Completos"
end type

event clicked;cbx_1.triggerevent(clicked!)
end event

type rb_incompleto from radiobutton within tp1
integer x = 5266
integer y = 88
integer width = 347
integer height = 64
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Incompletos"
end type

event clicked;cbx_1.triggerevent(clicked!)
end event

type rb_todos from radiobutton within tp1
integer x = 4965
integer y = 88
integer width = 219
integer height = 64
integer taborder = 200
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Todos"
boolean checked = true
end type

event clicked;cbx_1.triggerevent(clicked!)
end event

type barra from hprogressbar within tp1
integer x = 3246
integer y = 156
integer width = 1463
integer height = 56
boolean bringtotop = true
unsignedinteger maxposition = 100
integer setstep = 10
end type

type cbx_1 from checkbox within tp1
integer x = 2665
integer y = 84
integer width = 553
integer height = 60
integer taborder = 180
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 79741120
string text = "Filtrar por profesional"
boolean checked = true
end type

event clicked;string filtro
filtro=""

if rb_completo.checked and (dw_ria.dataobject="dw_genera_rips" or dw_ria.dataobject="dw_genera_rips2") then filtro=" estado='Completo' "
if rb_incompleto.checked and (dw_ria.dataobject="dw_genera_rips" or dw_ria.dataobject="dw_genera_rips2") then filtro=" estado='Incompleto' "
if rb_1.checked and (isdate(em_11.text) and isdate(em_21.text)) then 
	if filtro<>"" then filtro+="and "
	filtro+=" date(s_fecha) >= date('"+em_11.text+"') and date(s_fecha) <= date('"+em_21.text+"') "
end if
if rb_2.checked and (isnumber(sle_6.text) and isnumber(sle_7.text)) then 
	if filtro<>"" then filtro+="and "
	filtro+=" s_nfactura >= "+sle_6.text+" and s_nfactura <= "+sle_7.text+" "
end if
if this.checked then
	if not isnull(dw_1.getitemstring(1,1))and (dw_ria.dataobject="dw_genera_rips" or dw_ria.dataobject="dw_genera_rips2") then 
		if filtro<>"" then filtro+="and "
		filtro+=" cprof='"+dw_1.getitemstring(1,1)+"'"
	end if
end if
dw_ria.setfilter(filtro)
dw_ria.filter()
cuenta()
end event

type em_21 from editmask within tp1
integer x = 2226
integer y = 72
integer width = 389
integer height = 76
integer taborder = 180
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 16777215
string text = "none"
borderstyle borderstyle = stylelowered!
maskdatatype maskdatatype = datemask!
string mask = "dd/mm/yyyy"
boolean autoskip = true
boolean spin = true
double increment = 1
end type

event constructor;if isdate("31/"+string(today(),"mm/yyyy")) then
	this.text="31/"+string(today(),"mm/yyyy")
else
	if isdate("30/"+string(today(),"mm/yyyy")) then
		this.text="30/"+string(today(),"mm/yyyy")
	else
		if isdate("29/"+string(today(),"mm/yyyy")) then
			this.text="29/"+string(today(),"mm/yyyy")
		else
			this.text="28/"+string(today(),"mm/yyyy")
		end if
	end if
end if
end event

event modified;cbx_1.triggerevent(clicked!)
end event

type sle_7 from singlelineedit within tp1
boolean visible = false
integer x = 2226
integer y = 72
integer width = 283
integer height = 76
integer taborder = 170
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 16777215
boolean enabled = false
borderstyle borderstyle = stylelowered!
end type

event modified;cbx_1.triggerevent(clicked!)
end event

type rb_2 from radiobutton within tp1
integer x = 1573
integer y = 160
integer width = 311
integer height = 52
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 79741120
string text = "Facturas"
end type

event clicked;em_11.enabled=false
em_21.enabled=false
sle_6.enabled=true
sle_7.enabled=true
em_11.visible=false
em_21.visible=false
sle_6.visible=true
sle_7.visible=true
cbx_1.triggerevent(clicked!)
end event

type rb_1 from radiobutton within tp1
integer x = 1568
integer y = 88
integer width = 261
integer height = 52
integer taborder = 130
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 79741120
string text = "Fechas"
boolean checked = true
end type

event clicked;em_11.enabled=true
em_21.enabled=true
sle_6.enabled=false
sle_7.enabled=false
em_11.visible=true
em_21.visible=true
sle_6.visible=false
sle_7.visible=false
cbx_1.triggerevent(clicked!)
end event

type pb_ayuda from picturebutton within tp1
event mousemove pbm_mousemove
integer x = 1362
integer y = 56
integer width = 146
integer height = 128
integer taborder = 130
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
string text = "        &y"
boolean originalsize = true
string picturename = "ayuda.gif"
string disabledname = "d_ayuda.gif"
alignment htextalign = left!
string powertiptext = "Ayuda sobre generación de RIPS [Alt+Y]"
end type

event clicked;showhelp("E:\AYUDA GESTIÓN CLÍNICA INTEGRADA\!SSL!\Microsoft_HTML_Help\AYUDA-GESTI-N-CL-NICA-INTEGRADA.chm",keyword!,'Recuerde')
end event

type pb_guardar from picturebutton within tp1
event mousemove pbm_mousemove
integer x = 1207
integer y = 56
integer width = 146
integer height = 128
integer taborder = 120
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
string text = "             &g"
boolean originalsize = true
string picturename = "guardar2.GIF"
string disabledname = "d_guardar2.GIF"
alignment htextalign = left!
string powertiptext = "Guardar Datos [Alt+G]"
end type

event clicked;if dw_ria.update()=-1 then
	rollback;
else
	commit;
end if
end event

type pb_trae from picturebutton within tp1
event mousemove pbm_mousemove
integer x = 1051
integer y = 56
integer width = 146
integer height = 128
integer taborder = 110
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
string text = "                 &t"
boolean originalsize = true
string picturename = "refrescar.GIF"
string disabledname = "d_refrescar.GIF"
alignment htextalign = left!
string powertiptext = "Traer Registros [Alt+T]"
end type

event clicked;string cual,param
long j
cual=drop_tipo.text
if cual="none" then 
	messagebox("Error","Elija el tipo de RIA a generar")
	return
end if
choose case cual
	case "Consulta"  //archivo/empresa/contrato/fechas
		if tab_2.tp2_1.tab_1.selectedtab=1 then
			if tab_2.tp2_1.tab_1.tp_1.dw_contgenera.rowcount()=0 then
				messagebox("Error","Elija la empresa y los contratos a generar diskette")
				return
			end if
			param="AC"
			dw_ria.dataobject="dw_genera_rips"
			if tab_2.tp2_1.tab_1.selectedtab=2 then dw_ria.dataobject+="2"
			dw_ria.settransobject(sqlca)
		else
			dw_ria.dataobject="dr_rips_consulta_viejo"
			dw_ria.settransobject(sqlca)
			dw_ria.retrieve(tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemnumber(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),"num_radicacion"),tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemstring(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),"clugar"),'%','%',tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemstring(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),"tipo"),is_capiv)
			return
		end if
		pb_guardar.enabled=true
	case "Procedimientos"
		if tab_2.tp2_1.tab_1.selectedtab=1 then
			if tab_2.tp2_1.tab_1.tp_1.dw_contgenera.rowcount()=0 then
				messagebox("Error","Elija la empresa y los contratos a generar diskette")
				return
			end if
			param="AP"
			dw_ria.dataobject="dw_genera_rips"
			if tab_2.tp2_1.tab_1.selectedtab=2  then dw_ria.dataobject+="2"	
			dw_ria.settransobject(sqlca)
		else
			dw_ria.dataobject="dr_rips_procedimientos_viejo"
			dw_ria.settransobject(sqlca)
			dw_ria.retrieve(tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemnumber(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),"num_radicacion"),tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemstring(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),"clugar"),'%','%',tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemstring(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),"tipo"),is_capiv)
			return
		end if
		pb_guardar.enabled=true
case "Urgencias"
		if tab_2.tp2_1.tab_1.selectedtab=1 then
			if tab_2.tp2_1.tab_1.tp_1.dw_contgenera.rowcount()=0 then
				messagebox("Error","Elija la empresa y los contratos a generar diskette")
				return
			end if
			dw_ria.dataobject="dr_rips_urg"
			dw_ria.settransobject(sqlca)
			for j= 1 to tab_2.tp2_1.tab_1.tp_1.dw_contgenera.rowcount()
				dw_ria.retrieve(tab_2.tp2_1.tab_1.tp_1.dw_contgenera.getitemstring(j,"cemp"),tab_2.tp2_1.tab_1.tp_1.dw_contgenera.getitemstring(j,"ccontrato"),datetime(date(tab_2.tp2_1.tab_1.tp_1.em_1.text)),datetime(date(tab_2.tp2_1.tab_1.tp_1.em_2.text)),clugar)
			next
			return
		else
			dw_ria.dataobject="dr_rips_urg_viejo"
			dw_ria.settransobject(sqlca)
			dw_ria.retrieve(tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemnumber(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),"num_radicacion"),tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemstring(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),"clugar"),'','%',tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemstring(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),"tipo"))
			return
		end if
		pb_guardar.enabled=false
	case "Hospitalización"
		if tab_2.tp2_1.tab_1.selectedtab=1 then
			if tab_2.tp2_1.tab_1.tp_1.dw_contgenera.rowcount()=0 then
				messagebox("Error","Elija la empresa y los contratos a generar diskette")
				return
			end if
			dw_ria.dataobject="dr_rips_hosp"
			dw_ria.settransobject(sqlca)
			for j= 1 to tab_2.tp2_1.tab_1.tp_1.dw_contgenera.rowcount()
				dw_ria.retrieve(tab_2.tp2_1.tab_1.tp_1.dw_contgenera.getitemstring(j,"cemp"),tab_2.tp2_1.tab_1.tp_1.dw_contgenera.getitemstring(j,"ccontrato"),datetime(date(tab_2.tp2_1.tab_1.tp_1.em_1.text)),datetime(date(tab_2.tp2_1.tab_1.tp_1.em_2.text)),clugar,'%',tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemstring(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),"tipo"))
			next
			return
		else
			dw_ria.dataobject="dr_rips_hosp_viejo"
			dw_ria.settransobject(sqlca)
			dw_ria.retrieve(tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemnumber(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),"num_radicacion"),tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemstring(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),"clugar"),'%',tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemstring(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),"tipo"),'')
			return
		end if
		pb_guardar.enabled=false
	case "Recien Nacido"
		if tab_2.tp2_1.tab_1.selectedtab=1 then
			if tab_2.tp2_1.tab_1.tp_1.dw_contgenera.rowcount()=0 then
				messagebox("Error","Elija la empresa y los contratos a generar diskette")
				return
			end if
			dw_ria.dataobject="dr_rips_rn"
			dw_ria.settransobject(sqlca)
			for j= 1 to tab_2.tp2_1.tab_1.tp_1.dw_contgenera.rowcount()
				dw_ria.retrieve(tab_2.tp2_1.tab_1.tp_1.dw_contgenera.getitemstring(j,"cemp"),tab_2.tp2_1.tab_1.tp_1.dw_contgenera.getitemstring(j,"ccontrato"),datetime(date(tab_2.tp2_1.tab_1.tp_1.em_1.text)),datetime(date(tab_2.tp2_1.tab_1.tp_1.em_2.text)),clugar,tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemstring(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),"tipo"))
			next
			return
		else
			dw_ria.dataobject="dr_rips_rn_viejo"
			dw_ria.settransobject(sqlca)
			dw_ria.retrieve(tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemnumber(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),"num_radicacion"),tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemstring(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),"clugar"),'','%',tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemstring(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),"tipo"))
			return
		end if
		pb_guardar.enabled=false
	case "Medicamentos"
		if tab_2.tp2_1.tab_1.selectedtab=1 then
			if tab_2.tp2_1.tab_1.tp_1.dw_contgenera.rowcount()=0 then
				messagebox("Error","Elija la empresa y los contratos a generar diskette")
				return
			end if
			dw_ria.dataobject="dr_rips_medica"
			dw_ria.settransobject(sqlca)
			for j= 1 to tab_2.tp2_1.tab_1.tp_1.dw_contgenera.rowcount()
				dw_ria.retrieve(tab_2.tp2_1.tab_1.tp_1.dw_contgenera.getitemstring(j,"cemp"),tab_2.tp2_1.tab_1.tp_1.dw_contgenera.getitemstring(j,"ccontrato"),datetime(date(tab_2.tp2_1.tab_1.tp_1.em_1.text)),datetime(date(tab_2.tp2_1.tab_1.tp_1.em_2.text)),clugar)
			next
			return
		else
			dw_ria.dataobject="dr_rips_medica_viejo"
			dw_ria.settransobject(sqlca)
			dw_ria.retrieve(tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemnumber(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),"num_radicacion"),tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemstring(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),"clugar"),'%','%',tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemstring(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),"tipo"),is_capiv)
			return
		end if
		pb_guardar.enabled=false
	case "Otros Servicios"
		if tab_2.tp2_1.tab_1.selectedtab=1 then
			if tab_2.tp2_1.tab_1.tp_1.dw_contgenera.rowcount()=0 then
				messagebox("Error","Elija la empresa y los contratos a generar diskette")
				return
			end if
			dw_ria.dataobject="dr_rips_otros"
			dw_ria.settransobject(sqlca)
			for j= 1 to tab_2.tp2_1.tab_1.tp_1.dw_contgenera.rowcount()
				dw_ria.retrieve(tab_2.tp2_1.tab_1.tp_1.dw_contgenera.getitemstring(j,"cemp"),tab_2.tp2_1.tab_1.tp_1.dw_contgenera.getitemstring(j,"ccontrato"),datetime(date(tab_2.tp2_1.tab_1.tp_1.em_1.text)),datetime(date(tab_2.tp2_1.tab_1.tp_1.em_2.text)),clugar)
			next
			return
		else
			dw_ria.dataobject="dr_rips_otros_viejo"
			dw_ria.settransobject(sqlca)
			dw_ria.retrieve(tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemnumber(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),"num_radicacion"),tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemstring(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),"clugar"),'%','%',tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemstring(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),"tipo"),is_capiv)
			return
		end if
		pb_guardar.enabled=false
end choose
if tab_2.tp2_1.tab_1.selectedtab=1 then
	if tab_2.tp2_1.tab_1.tp_1.dw_contgenera.rowcount()=0 then
		messagebox("Error","Elija la empresa y los contratos a generar diskette")
		return
	end if
	dw_ria.reset()
	for j= 1 to tab_2.tp2_1.tab_1.tp_1.dw_contgenera.rowcount()
		dw_ria.retrieve(param,tab_2.tp2_1.tab_1.tp_1.dw_contgenera.getitemstring(j,"cemp"),tab_2.tp2_1.tab_1.tp_1.dw_contgenera.getitemstring(j,"ccontrato"),datetime(date(tab_2.tp2_1.tab_1.tp_1.em_1.text)),datetime(date(tab_2.tp2_1.tab_1.tp_1.em_2.text)),clugar)
	next
end if
if tab_2.tp2_1.tab_1.selectedtab=2 then
	dw_ria.retrieve(param,tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemnumber(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),"num_radicacion"),tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemstring(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),"clugar"),tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemstring(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),"tipo"))
	em_11.text=string(tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemdatetime(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),"fecha_inicial"))
	em_21.text=string(tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemdatetime(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),"fecha_final"))
end if
rb_todos.checked=true
rb_todos.triggerevent(clicked!)

end event

type drop_tipo from dropdownlistbox within tp1
integer x = 343
integer y = 72
integer width = 663
integer height = 624
integer taborder = 100
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 16777215
string text = "none"
boolean vscrollbar = true
string item[] = {"Consulta","Procedimientos","Urgencias","Hospitalización","Recien Nacido","Medicamentos","Otros Servicios"}
borderstyle borderstyle = stylelowered!
end type

event selectionchanged;pb_trae.triggerevent(clicked!)
end event

type st_7 from statictext within tp1
integer x = 23
integer y = 80
integer width = 325
integer height = 56
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Tipo de RIPS:"
boolean focusrectangle = false
end type

type gb_6 from groupbox within tp1
integer x = 1527
integer y = 40
integer width = 3401
integer height = 188
integer taborder = 51
integer textsize = -7
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Small Fonts"
long textcolor = 33554432
long backcolor = 67108864
string text = "Filtrar Por:"
end type

type gb_3 from groupbox within tp1
integer x = 4933
integer y = 40
integer width = 1824
integer height = 188
integer taborder = 51
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Mostrar"
end type

type gb_2 from groupbox within tp1
integer y = 12
integer width = 6789
integer height = 1200
integer taborder = 41
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Consulta / Modificación:"
end type

type st_tdoc from statictext within tp1
integer x = 14
integer y = 248
integer width = 119
integer height = 68
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
boolean border = true
borderstyle borderstyle = stylelowered!
boolean focusrectangle = false
end type

type st_docu from statictext within tp1
integer x = 155
integer y = 248
integer width = 343
integer height = 68
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
boolean border = true
borderstyle borderstyle = stylelowered!
boolean focusrectangle = false
end type

type st_paciente from statictext within tp1
integer x = 530
integer y = 248
integer width = 1248
integer height = 68
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
boolean border = true
borderstyle borderstyle = stylelowered!
boolean focusrectangle = false
end type

type st_sexo from statictext within tp1
integer x = 1801
integer y = 248
integer width = 110
integer height = 68
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
alignment alignment = center!
boolean border = true
borderstyle borderstyle = stylelowered!
boolean focusrectangle = false
end type

type st_edad from statictext within tp1
integer x = 1934
integer y = 248
integer width = 343
integer height = 68
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
alignment alignment = center!
boolean border = true
borderstyle borderstyle = stylelowered!
boolean focusrectangle = false
end type

type st_nfact from statictext within tp1
integer x = 2290
integer y = 248
integer width = 343
integer height = 68
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
alignment alignment = center!
boolean border = true
borderstyle borderstyle = stylelowered!
boolean focusrectangle = false
end type

type dw_1 from datawindow within tp1
integer x = 3218
integer y = 72
integer width = 1527
integer height = 84
integer taborder = 200
boolean bringtotop = true
string title = "none"
string dataobject = "dw_combo_profe"
boolean border = false
boolean livescroll = true
end type

event constructor;this.settransobject(sqlca)
this.insertrow(1)
end event

event itemchanged;this.accepttext()
cbx_1.triggerevent(clicked!)
end event

type em_11 from editmask within tp1
integer x = 1824
integer y = 72
integer width = 389
integer height = 76
integer taborder = 160
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 16777215
string text = "none"
borderstyle borderstyle = stylelowered!
maskdatatype maskdatatype = datemask!
string mask = "dd/mm/yyyy"
boolean autoskip = true
boolean spin = true
double increment = 1
end type

event constructor;this.text="01/"+string(today(),"mm/yyyy")


end event

event modified;cbx_1.triggerevent(clicked!)
end event

type sle_6 from singlelineedit within tp1
boolean visible = false
integer x = 1829
integer y = 72
integer width = 283
integer height = 76
integer taborder = 150
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 16777215
boolean enabled = false
borderstyle borderstyle = stylelowered!
end type

event modified;cbx_1.triggerevent(clicked!)
end event

type fac from userobject within t1
integer x = 18
integer y = 112
integer width = 6798
integer height = 1220
boolean enabled = false
long backcolor = 67108864
string text = "Facturas Asociadas"
long tabtextcolor = 33554432
string picturename = "rips_3.ico"
long picturemaskcolor = 536870912
pb_7 pb_7
dw_fact dw_fact
end type

on fac.create
this.pb_7=create pb_7
this.dw_fact=create dw_fact
this.Control[]={this.pb_7,&
this.dw_fact}
end on

on fac.destroy
destroy(this.pb_7)
destroy(this.dw_fact)
end on

type pb_7 from picturebutton within fac
integer x = 6309
integer y = 12
integer width = 146
integer height = 128
integer taborder = 41
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean originalsize = true
string picturename = "guardar.GIF"
string powertiptext = "Modificar Radicación"
end type

event clicked;int li,dd
long ln_rad,ln_nfac
string ls_emp,ls_cont,ls_tipo,ls_clg
string ls_clf,ls_tif
dec vemp

if messageBox('Aviso','Esta seguro de liberar los documento seleccionados?',QUESTION!,YESNO!) = 2 then
	Return
end if
st_xa_anular st_anula
st_anula.tipo='DV'
openwithparm (w_motiv_anula,st_anula)
st_anula=message.powerobjectparm
if not isValid(st_anula) then return -1

dw_fact.setfilter("radicar='0'")
dw_fact.filter()

for li=1 to dw_fact.rowcount()
	dd=tab_2.tp2_1.t1.tmod.dw_mod.insertrow(0)

	tab_2.tp2_1.t1.tmod.dw_mod.setitem(dd,'nradica',dw_fact.getitemnumber(li,'nradica'))
	tab_2.tp2_1.t1.tmod.dw_mod.setitem(dd,'clugar_rad',dw_fact.getitemstring(li,'clugar_rad'))
	tab_2.tp2_1.t1.tmod.dw_mod.setitem(dd,'tipo_rad',dw_fact.getitemstring(li,'tipo_rad'))
	tab_2.tp2_1.t1.tmod.dw_mod.setitem(dd,'nfact',dw_fact.getitemnumber(li,'nfact'))
	tab_2.tp2_1.t1.tmod.dw_mod.setitem(dd,'clugar',dw_fact.getitemstring(li,'clugar'))
	tab_2.tp2_1.t1.tmod.dw_mod.setitem(dd,'tipo',dw_fact.getitemstring(li,'tipo'))
	tab_2.tp2_1.t1.tmod.dw_mod.setitem(dd,'estado_revisa',dw_fact.getitemstring(li,'estado_revisa'))
	tab_2.tp2_1.t1.tmod.dw_mod.setitem(dd,'fecha_hora',today())
	tab_2.tp2_1.t1.tmod.dw_mod.setitem(dd,'usuario',usuario)
	tab_2.tp2_1.t1.tmod.dw_mod.setitem(dd,'cod_anula',st_anula.motivo)
	tab_2.tp2_1.t1.tmod.dw_mod.setitem(dd,'motivo_anula',st_anula.observacion)
	
	ln_rad=dw_fact.getitemnumber(li,'nradica')
	ls_clg=dw_fact.getitemstring(li,'clugar_rad')
	ls_tipo=dw_fact.getitemstring(li,'tipo_rad')
	ls_emp=dw_fact.getitemstring(li,'cemp')
	ls_cont=dw_fact.getitemstring(li,'ccontrato')
	vemp=dw_fact.getitemnumber(li,'vtemp')
	update ripsradicadet set valor_evento=valor_evento - :vemp, nro_factu=nro_factu -1
	where num_radicacion=:ln_rad and clugar=:ls_clg and tipo=:ls_tipo and cemp=:ls_emp and ccontrato=:ls_cont;
	if sqlca.sqlcode=-1 then
		messagebox('Error ripsradicadet',sqlca.sqlerrtext)
		rollback;
	end if
	update ripsradica set valor_evento=valor_evento - :vemp, nro_factu=nro_factu -1
	where num_radicacion=:ln_rad and clugar=:ls_clg and tipo=:ls_tipo;	
	if sqlca.sqlcode=-1 then
		messagebox('Error ripsradicadet',sqlca.sqlerrtext)
		rollback;
	end if

	ln_nfac=dw_fact.getitemnumber(li,'nfact')
	ls_clf=dw_fact.getitemstring(li,'clugar')
	ls_tif=dw_fact.getitemstring(li,'tipo')
	update factcab set estado_revisa=null, nradica=null,clugar_rad=null,tipo_rad=null
	where nfact=:ln_nfac and clugar=:ls_clf and tipo=:ls_tif and nradica=:ln_rad and clugar_rad=:ls_clg and tipo_rad=:ls_tipo;
	if sqlca.sqlcode=-1 then
		messagebox('Error ripsradicadet',sqlca.sqlerrtext)
		rollback;
	end if
next
dw_fact.setfilter('')
dw_fact.filter()
if tab_2.tp2_1.t1.tmod.dw_mod.update()=-1 then
	rollback;
	return
end if
commit;
end event

type dw_fact from datawindow within fac
integer x = 46
integer y = 28
integer width = 6231
integer height = 1160
integer taborder = 140
boolean enabled = false
string title = "none"
string dataobject = "dw_facturas_radica_deselec"
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;settransobject(sqlca)
end event

event itemchanged;long fila
fila=this.getrow()
if fila<1 then return
if this.getcolumnname()='radicar' then
	if not isnull(this.getitemnumber(fila,'estado_revisa')) and this.gettext()='0' then
		long nulo
		setnull(nulo)
		if messagebox("Atención",'Esta factura ya se había revisado, desa cambiar su estado?',question!,yesno!,2)=2 then return 1
		this.accepttext()
	end if
end if
this.accepttext()

end event

type tmod from userobject within t1
integer x = 18
integer y = 112
integer width = 6798
integer height = 1220
boolean enabled = false
long backcolor = 67108864
string text = "Auditoria a Modificaciones"
long tabtextcolor = 33554432
string picturename = "audita.ico"
long picturemaskcolor = 536870912
string powertiptext = "Facturas sacadas de radicación"
dw_mod dw_mod
end type

on tmod.create
this.dw_mod=create dw_mod
this.Control[]={this.dw_mod}
end on

on tmod.destroy
destroy(this.dw_mod)
end on

type dw_mod from datawindow within tmod
integer x = 41
integer y = 20
integer width = 6368
integer height = 1160
integer taborder = 190
string title = "none"
string dataobject = "dw_factura_sale"
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;settransobject(sqlca)
end event

type tp2 from userobject within t1
integer x = 18
integer y = 112
integer width = 6798
integer height = 1220
long backcolor = 67108864
string text = "Actividades finales"
long tabtextcolor = 33554432
string picturename = "rips_4.ico"
long picturemaskcolor = 536870912
string powertiptext = "Detalle de las actividades finales de la cuenta"
pb_4 pb_4
dw_act_final dw_act_final
end type

on tp2.create
this.pb_4=create pb_4
this.dw_act_final=create dw_act_final
this.Control[]={this.pb_4,&
this.dw_act_final}
end on

on tp2.destroy
destroy(this.pb_4)
destroy(this.dw_act_final)
end on

type pb_4 from picturebutton within tp2
integer x = 6139
integer y = 44
integer width = 146
integer height = 128
integer taborder = 30
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
boolean flatstyle = true
boolean originalsize = true
string picturename = "guardar2.gif"
string disabledname = "d_guardar2.gif"
alignment htextalign = left!
string powertiptext = "Generar Archivo plano FFD"
end type

event clicked;if dw_act_final.rowcount()=0 then return
uo_datastore ds_trae,ds_export
ds_trae=create uo_datastore
ds_export=create uo_datastore
ds_trae.dataobject='dw_trae_act_fin_pa_export'
ds_trae.settransobject(sqlca)
datawindow dw
dw=tab_2.tp2_1.tab_1.tp_p.dw_radica
string nit,nomarch,camino,actual
select documento into:nit from ips;
ds_trae.retrieve(dw.getitemnumber(dw.getrow(),'num_radicacion'),dw.getitemstring(dw.getrow(),'clugar'),nit)
ds_export.dataobject='dw_export_act_fin'
ds_export.object.todo.primary=ds_trae.object.exportar.primary

actual=getcurrentdirectory()
if GetFileSaveName ( 'Guardar reporte como', camino, nomarch , 'txt' , 'Archivos de texto (*.txt),*.txt' )<=0 then return
ds_export.saveas(nomarch,CSV!	,false)
changedirectory(actual)
end event

type dw_act_final from datawindow within tp2
integer x = 14
integer y = 48
integer width = 6043
integer height = 1140
integer taborder = 31
string title = "none"
string dataobject = "dw_radica_act_fin"
boolean hscrollbar = true
boolean vscrollbar = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;settransobject(sqlca)
end event

event dberror; if is_decual='lote' then 
	filewrite(i_numarc,sqlerrtext)
	return 1 //para que no muestre el error en pantalla
end if
end event

type rb_4 from radiobutton within tp2_1
integer x = 791
integer y = 36
integer width = 233
integer height = 52
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "CUPS"
boolean checked = true
end type

type rb_3 from radiobutton within tp2_1
integer x = 329
integer y = 36
integer width = 421
integer height = 52
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Manual Tarifario"
end type

type tab_1 from tab within tp2_1
event create ( )
event destroy ( )
integer x = 14
integer y = 136
integer width = 6825
integer height = 888
integer taborder = 70
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long backcolor = 67108864
boolean fixedwidth = true
boolean raggedright = true
boolean focusonbuttondown = true
boolean powertips = true
boolean pictureonright = true
tabposition tabposition = tabsonleft!
integer selectedtab = 1
tp_1 tp_1
tp_p tp_p
end type

on tab_1.create
this.tp_1=create tp_1
this.tp_p=create tp_p
this.Control[]={this.tp_1,&
this.tp_p}
end on

on tab_1.destroy
destroy(this.tp_1)
destroy(this.tp_p)
end on

event selectionchanged;If newindex=2 then
	rb_10.enabled=false
	dw_tipin.enabled=false
	if tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemstring(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),'tipo')='F' then
		tab_2.tp2_1.cbx_5.enabled=true
		tab_2.tp2_1.cbx_5.checked=true
		is_capiv='1'
	else
		tab_2.tp2_1.cbx_5.enabled=false
		tab_2.tp2_1.cbx_5.checked=false
		is_capiv='0'
	end if
else
	rb_10.enabled=true
	dw_tipin.enabled=true
	tab_2.tp2_1.cbx_5.enabled=true
	tab_2.tp2_1.cbx_5.checked=true
	is_capiv='1'
end if
tab_2.tp2_1.tab_1.tp_p.dw_radica.retrieve(CLUGAR)
end event

type tp_1 from userobject within tab_1
event create ( )
event destroy ( )
integer x = 128
integer y = 16
integer width = 6679
integer height = 856
long backcolor = 67108864
long tabtextcolor = 33554432
string picturename = "guardar.ico"
long picturemaskcolor = 536870912
string powertiptext = "Generar Radicaciones de una Sola Empresa"
cbx_4 cbx_4
pb_2 pb_2
pb_1 pb_1
em_2 em_2
st_9 st_9
em_1 em_1
st_8 st_8
dw_empresa dw_empresa
pb_3 pb_3
st_1 st_1
cbx_activos cbx_activos
mle_objeto mle_objeto
dw_contgenera dw_contgenera
end type

on tp_1.create
this.cbx_4=create cbx_4
this.pb_2=create pb_2
this.pb_1=create pb_1
this.em_2=create em_2
this.st_9=create st_9
this.em_1=create em_1
this.st_8=create st_8
this.dw_empresa=create dw_empresa
this.pb_3=create pb_3
this.st_1=create st_1
this.cbx_activos=create cbx_activos
this.mle_objeto=create mle_objeto
this.dw_contgenera=create dw_contgenera
this.Control[]={this.cbx_4,&
this.pb_2,&
this.pb_1,&
this.em_2,&
this.st_9,&
this.em_1,&
this.st_8,&
this.dw_empresa,&
this.pb_3,&
this.st_1,&
this.cbx_activos,&
this.mle_objeto,&
this.dw_contgenera}
end on

on tp_1.destroy
destroy(this.cbx_4)
destroy(this.pb_2)
destroy(this.pb_1)
destroy(this.em_2)
destroy(this.st_9)
destroy(this.em_1)
destroy(this.st_8)
destroy(this.dw_empresa)
destroy(this.pb_3)
destroy(this.st_1)
destroy(this.cbx_activos)
destroy(this.mle_objeto)
destroy(this.dw_contgenera)
end on

type cbx_4 from checkbox within tp_1
integer x = 2354
integer width = 343
integer height = 64
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Reservar"
end type

type pb_2 from picturebutton within tp_1
event mousemove pbm_mousemove
integer x = 6519
integer y = 200
integer width = 146
integer height = 128
integer taborder = 80
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
string text = "           &b"
boolean originalsize = true
string picturename = "borrar_fila.GIF"
string disabledname = "d_borrar_fila.GIF"
alignment htextalign = left!
string powertiptext = "Borrar Contrato a generar [Alt+B]"
end type

event clicked;if dw_contgenera.rowcount()=0 then 
	return 
end if
dw_contgenera.deleterow(dw_contgenera.getrow())
if dw_contgenera.rowcount()=0 then 
	ibn_paso=false
	mle_objeto.enabled=false
	mle_objeto.visible=false
	dw_contgenera.height=660	
end if
end event

type pb_1 from picturebutton within tp_1
event mousemove pbm_mousemove
integer x = 869
integer y = 392
integer width = 146
integer height = 128
integer taborder = 70
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
string text = "            &c"
boolean originalsize = true
string picturename = "insertar.GIF"
string disabledname = "d_insertar.GIF"
alignment htextalign = left!
string powertiptext = "Incluir todos los Contratos [Alt+C]"
end type

event clicked;//if dw_empresa.getitemstring(1,1)="" or isnull(dw_empresa.getitemstring(1,1)) then return
//long j
//for j=1 to idw_contrato.rowcount()
//	if dw_contgenera.find("cemp='"+idw_contrato.getitemstring(j,3)+"' and ccontrato='"+idw_contrato.getitemstring(j,2)+"'",1,dw_contgenera.rowcount())=0 then 
//		long donde
//		string tipo
//		donde=dw_contgenera.insertrow(0)
//		dw_contgenera.setitem(donde,'cemp',idw_contrato.getitemstring(j,'codemp'))
//		dw_contgenera.setitem(donde,'ccontrato',idw_contrato.getitemstring(j,'codcontrato'))
//		dw_contgenera.setitem(donde,'contrato',idw_contrato.getitemstring(j,'descontrato'))
//		dw_contgenera.setitem(donde,'ctipo',idw_contrato.getitemstring(j,'ctcontra'))
//		if idw_contrato.getitemstring(j,'ctcontra')='1' then dw_contgenera.setitem(donde,'tipo','R')
//		if idw_contrato.getitemstring(j,'ctcontra')='2' then dw_contgenera.setitem(donde,'tipo','F')
//	end if
//next
//
end event

type em_2 from editmask within tp_1
integer x = 453
integer y = 396
integer width = 389
integer height = 76
integer taborder = 80
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 16777215
borderstyle borderstyle = stylelowered!
maskdatatype maskdatatype = datemask!
string mask = "dd/mm/yyyy"
boolean autoskip = true
boolean spin = true
double increment = 1
string minmax = "01/01/2000~~31/12/2020"
end type

event constructor;if isdate("31/"+string(today(),"mm/yyyy")) then
	text="31/"+string(today(),"mm/yyyy")
else
	if isdate("30/"+string(today(),"mm/yyyy")) then
		text="30/"+string(today(),"mm/yyyy")
	else
		if isdate("29/"+string(today(),"mm/yyyy")) then
			text="29/"+string(today(),"mm/yyyy")
		else
			text="28/"+string(today(),"mm/yyyy")
		end if
	end if
end if

end event

type st_9 from statictext within tp_1
integer x = 453
integer y = 472
integer width = 105
integer height = 48
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Fin"
boolean focusrectangle = false
end type

type em_1 from editmask within tp_1
integer x = 27
integer y = 396
integer width = 384
integer height = 76
integer taborder = 70
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 16777215
borderstyle borderstyle = stylelowered!
maskdatatype maskdatatype = datemask!
string mask = "dd/mm/yyyy"
boolean autoskip = true
boolean spin = true
double increment = 1
string minmax = "01/01/2000~~31/12/2020"
end type

event constructor;text="01/"+string(today(),"mm/yyyy")
end event

type st_8 from statictext within tp_1
integer x = 27
integer y = 472
integer width = 123
integer height = 48
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Inicio"
boolean focusrectangle = false
end type

type dw_empresa from datawindow within tp_1
integer x = 27
integer width = 1335
integer height = 396
integer taborder = 50
boolean bringtotop = true
string title = "none"
string dataobject = "dw_empresa_contrato"
boolean border = false
boolean livescroll = true
end type

event constructor;settransobject(sqlca)
getchild('ctreg',gc_regimen)
gc_regimen.settransobject(sqlca)
getchild("codcontrato",idw_contrato)
idw_contrato.settransobject(sqlca)
getchild('codemp',idw_emp)
idw_emp.settransobject(sqlca)
idw_emp.retrieve('%')
insertrow(1)

end event

event itemchanged;this.accepttext()
string ls_codem,ls_null,ls_regim
integer li_fila

setnull(ls_null)
if this.getcolumnname() = "codemp" then
	this.accepttext()
	setitem(1,'ctreg',ls_null)
	setitem(1,'codcontrato',ls_null)
	ls_codem=this.getitemstring(1,"codemp")
	gc_regimen.retrieve(ls_codem)
end if

if this.getcolumnname() = "ctreg" then
	this.accepttext()
	ls_codem=this.getitemstring(1,"codemp")
	setitem(row,'codcontrato',ls_null)
	ls_regim=this.getitemstring(1,"ctreg")
	idw_contrato.retrieve(ls_codem,ls_regim)	
end if

cbx_activos.triggerevent(clicked!)

if this.getcolumnname() = 'codcontrato' then
	if dw_contgenera.find("cemp='"+getitemstring(1,1)+"' and ccontrato='"+data+"'",1,dw_contgenera.rowcount())=0 then 
		long donde
		if ( dw_contgenera.getitemstring(1,'ctipo')=idw_contrato.getitemstring(idw_contrato.getrow(),'ctcontra')) or (isnull(dw_contgenera.getitemstring(1,'ctipo'))) or dw_contgenera.getitemstring(1,'ctipo')='' then
			donde=dw_contgenera.insertrow(0)
			if ibn_paso=false then 
				if idw_contrato.getitemstring(idw_contrato.getrow(),'ctcontra')='2'  then
					dw_contgenera.height=460
					mle_objeto.visible=true					
					mle_objeto.enabled=true
				else
					mle_objeto.enabled=false
					mle_objeto.visible=false
					dw_contgenera.height=660
				end if
				ibn_paso=true
			end if
			dw_contgenera.setitem(donde,'cemp',getitemstring(1,'codemp'))
			dw_contgenera.setitem(donde,'ccontrato',data)
			dw_contgenera.setitem(donde,'contrato',idw_contrato.getitemstring(idw_contrato.getrow(),'descontrato'))
			dw_contgenera.setitem(donde,'ctipo',idw_contrato.getitemstring(idw_contrato.getrow(),'ctcontra'))
			dw_contgenera.setitem(donde,'soat',idw_contrato.getitemstring(idw_contrato.getrow(),'soat'))
			dw_contgenera.setitem(donde,'catastrofe',idw_contrato.getitemstring(idw_contrato.getrow(),'catastrofe'))
		else
			messagebox('','No se puede incluir en la Radicación Contratos de diferente Tipo')
		end if
	end if		
end if

end event

type pb_3 from picturebutton within tp_1
event mousemove pbm_mousemove
integer x = 6519
integer y = 56
integer width = 146
integer height = 128
integer taborder = 31
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
string text = "            &k"
string picturename = "guardar.GIF"
string disabledname = "d_guardar.GIF"
alignment htextalign = left!
string powertiptext = "Generar Diskete [Alt+K]"
end type

event clicked;if not f_hasta() then 
	messagebox("Atención","Su periodo de validez ha caducado, comuníquese con GCI Ltda. para reactivarlo")
	return
end if
////////////// ojo para que no metan goles ^
setpointer(hourglass!)
is_decual='emp'
long nrad
if dw_contgenera.rowcount()=0 then
	messagebox("Error","Elija la empresa y los contratos a generar diskette")
	return
end if
if dw_contgenera.find('forecat=1',1,dw_contgenera.rowcount())>0 and dw_contgenera.find('forecat=0',1,dw_contgenera.rowcount())>0 then
	messagebox('Atención','No puede radicar dos contratos al tiempo si uno de ellos es de SOAT o evento catastrófico')
	return
end if
long cero=0

if not tab_2.tp2_1.cbx_2.checked then cero=-1

string por_lug='1', l_reserva='0'
if cbx_4.checked then l_reserva='1'
if rb_7.checked then por_lug='0'
nrad=f_rips(true,0,'',dw_contgenera,'emp',tab_2.tp2_1.rb_4.checked,cero,por_lug,l_reserva,'0' )
choose case nrad
	case -1,-10
		rollback;
	case 0
	case else
		dw_empresa.setcolumn(1)
		dw_empresa.event itemchanged(1,dw_empresa.object.codemp,dw_empresa.getitemstring(1,'codemp'))
		messagebox("Atención",'Radicación Nro: '+string(nrad)+' generada con éxito')
end choose
commit;
tab_2.tp2_1.t1.tp1.barra.position=0
tab_2.tp2_1.tab_1.tp_1.dw_contgenera.reset()
tab_2.tp2_1.tab_1.tp_p.dw_radica.retrieve(CLUGAR)
end event

type st_1 from statictext within tp_1
integer x = 1399
integer width = 754
integer height = 52
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Contratos a generar Diskette:"
boolean focusrectangle = false
end type

type cbx_activos from checkbox within tp_1
integer x = 823
integer y = 244
integer width = 430
integer height = 52
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Solo los Activos"
boolean checked = true
end type

event clicked;if checked then
	idw_emp.retrieve('1')
	if not isnull(dw_empresa.getitemstring(1,'codemp')) then
		if idw_emp.find('codemp="'+dw_empresa.getitemstring(1,'codemp')+'"',1,idw_emp.rowcount())=0 then
			dw_empresa.reset()
			dw_empresa.insertrow(1)
		end if
	end if
	idw_contrato.setfilter('estado="1"')
else
	idw_emp.retrieve('%')
	idw_contrato.setfilter('')
end if
idw_contrato.filter()
end event

type mle_objeto from multilineedit within tp_1
boolean visible = false
integer x = 1399
integer y = 536
integer width = 5083
integer height = 288
integer taborder = 80
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 15793151
boolean hscrollbar = true
boolean vscrollbar = true
textcase textcase = upper!
integer limit = 700
borderstyle borderstyle = stylelowered!
end type

type dw_contgenera from datawindow within tp_1
integer x = 1394
integer y = 60
integer width = 5102
integer height = 460
integer taborder = 31
string title = "none"
string dataobject = "dw_contratos_pa_rias"
boolean hscrollbar = true
boolean vscrollbar = true
boolean hsplitscroll = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;settransobject(sqlca)

end event

event itemchanged;accepttext()
If getitemstring(row,'ctipo')='2' then
  setitem(row,'valor_capita',getitemnumber(row,'nusuarios')*getitemnumber(row,'upc'))
End if

end event

event doubleclicked;st_anula anular
if isvalid(w_rias) then
	anular.de_donde='objeto'
	openwithparm(w_motivos_notas,anular)
end if
end event

type tp_p from userobject within tab_1
event create ( )
event destroy ( )
integer x = 128
integer y = 16
integer width = 6679
integer height = 856
long backcolor = 67108864
long tabtextcolor = 33554432
string picturename = "cambia_doc.ico"
long picturemaskcolor = 536870912
string powertiptext = "Volver a generar diskettes de Radicaciones Pasadas"
rb_16 rb_16
rb_15 rb_15
rb_14 rb_14
dw_facturas dw_facturas
st_19 st_19
dw_radica dw_radica
tab_3 tab_3
end type

on tp_p.create
this.rb_16=create rb_16
this.rb_15=create rb_15
this.rb_14=create rb_14
this.dw_facturas=create dw_facturas
this.st_19=create st_19
this.dw_radica=create dw_radica
this.tab_3=create tab_3
this.Control[]={this.rb_16,&
this.rb_15,&
this.rb_14,&
this.dw_facturas,&
this.st_19,&
this.dw_radica,&
this.tab_3}
end on

on tp_p.destroy
destroy(this.rb_16)
destroy(this.rb_15)
destroy(this.rb_14)
destroy(this.dw_facturas)
destroy(this.st_19)
destroy(this.dw_radica)
destroy(this.tab_3)
end on

type rb_16 from radiobutton within tp_p
integer x = 1536
integer width = 343
integer height = 76
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Ambos"
boolean checked = true
end type

event clicked;dw_radica.setfilter("")
dw_radica.filter()
dw_radica.triggerevent(rowfocuschanged!)
rb_14.checked=false
rb_15.checked=false
rb_16.checked=true

end event

type rb_15 from radiobutton within tp_p
integer x = 1143
integer width = 343
integer height = 64
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Relaciones"
boolean automatic = false
end type

event clicked;dw_radica.setfilter("tipo='R'")
dw_radica.filter()
dw_radica.triggerevent(rowfocuschanged!)
rb_14.checked=false
rb_15.checked=true
rb_16.checked=false


end event

type rb_14 from radiobutton within tp_p
integer x = 777
integer width = 270
integer height = 64
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Facturas"
boolean automatic = false
end type

event clicked;dw_radica.setfilter("tipo='F'")
dw_radica.filter()
dw_radica.triggerevent(rowfocuschanged!)
rb_14.checked=true
rb_15.checked=false
rb_16.checked=false

end event

type dw_facturas from datawindow within tp_p
boolean visible = false
integer x = 5714
integer y = 32
integer width = 151
integer height = 72
integer taborder = 41
string title = "none"
string dataobject = "dw_facts_radica"
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

type st_19 from statictext within tp_p
integer x = 18
integer y = 4
integer width = 553
integer height = 64
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Radicaciones Anteriores:"
boolean focusrectangle = false
end type

type dw_radica from datawindow within tp_p
integer x = 9
integer y = 76
integer width = 3506
integer height = 756
integer taborder = 90
boolean bringtotop = true
string title = "none"
string dataobject = "dw_radica_rips"
boolean hscrollbar = true
boolean vscrollbar = true
boolean hsplitscroll = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;settransobject(sqlca)
tab_2.tp2_1.tab_1.tp_p.tab_3.det.dw_det.settransobject(sqlca)
tab_2.tp2_1.tab_1.tp_p.tab_3.nota.dw_nc.settransobject(sqlca)
retrieve(CLUGAR)
end event

event rowfocuschanged;if getrow()<1 then return
string ls_objetor,ls_lug,ls_tipo
double ldb_nrad

if getitemstring(getrow(),'tipo')='F' then
	tab_2.tp2_1.cbx_5.enabled=true
	tab_2.tp2_1.cbx_5.checked=true
	tab_2.tp2_1.rb_txt.enabled=true
	tab_2.tp2_1.rb_json.enabled=true	
	is_capiv='1'
	tab_2.tp2_1.tab_1.tp_p.tab_3.det.pb_dian.enabled=true
	tab_2.tp2_1.tab_1.tp_p.tab_3.det.pb_diac.enabled=false
	tab_2.tp2_1.tab_1.tp_p.tab_3.det.pb_diacc.enabled=true
	tab_2.tp2_1.tab_1.tp_p.tab_3.nota.enabled=true
	if isnull(getitemstring(getrow(),'estado')) then 
		tab_2.tp2_1.tab_1.tp_p.tab_3.nota.pb_insn.enabled=true
	else
		tab_2.tp2_1.tab_1.tp_p.tab_3.nota.pb_insn.enabled=False
	end if
else
	tab_2.tp2_1.cbx_5.enabled=false
	tab_2.tp2_1.cbx_5.checked=false
	tab_2.tp2_1.rb_txt.enabled=true
	tab_2.tp2_1.rb_json.enabled=false
	is_capiv='0'
	tab_2.tp2_1.tab_1.tp_p.tab_3.det.pb_dian.enabled=false
	tab_2.tp2_1.tab_1.tp_p.tab_3.det.pb_diac.enabled=true
	tab_2.tp2_1.tab_1.tp_p.tab_3.det.pb_diacc.enabled=false	
	tab_2.tp2_1.tab_1.tp_p.tab_3.nota.enabled=false	
	tab_2.tp2_1.tab_1.tp_p.tab_3.nota.pb_insn.enabled=False	
end if

ldb_nrad=getitemnumber(getrow(),'num_radicacion')
ls_lug=getitemstring(getrow(),'clugar')
ls_tipo=getitemstring(getrow(),'tipo')

tab_2.tp2_1.tab_1.tp_p.tab_3.det.dw_det.retrieve(ldb_nrad,ls_lug,ls_tipo)
tab_2.tp2_1.tab_1.tp_p.tab_3.nota.dw_nc.retrieve(ldb_nrad,ls_lug,ls_tipo)
tab_2.tp2_1.t1.tp2.dw_act_final.retrieve(ldb_nrad,ls_lug,ls_tipo)
//tab_2.tp2_1.t1.fac.dw_fact.retrieve(ldb_nrad,ls_lug,ls_tipo)
//tab_2.tp2_1.t1.tmod.dw_mod.retrieve(ldb_nrad,ls_lug,ls_tipo)

select objeto into :ls_objetor from ripsradica where num_radicacion=:ldb_nrad and clugar=:ls_lug and tipo=:ls_tipo;


//tab_2.tp2_1.tab_1.tp_p.mle_objetor.text=ls_objetor
tab_2.tp2_1.t1.tp1.em_11.text=left(string(getitemdatetime(getrow(),'fecha_inicial')),10)
tab_2.tp2_1.t1.tp1.em_21.text=left(string(getitemdatetime(getrow(),'fecha_final')),10)
if getitemstring(getrow(),'en_destino')='1'  or getitemstring(getrow(),'tipo')='F' or tab_2.tp2_1.t1.fac.dw_fact.rowcount()=1 then
	tab_2.tp2_1.t1.fac.enabled=false
	tab_2.tp2_1.t1.fac.dw_fact.enabled=false
	tab_2.tp2_1.t1.tmod.enabled=false
	tab_2.tp2_1.t1.tmod.dw_mod.enabled=false
else
	tab_2.tp2_1.t1.fac.enabled=true
	tab_2.tp2_1.t1.fac.dw_fact.enabled=true
	tab_2.tp2_1.t1.tmod.enabled=true
	tab_2.tp2_1.t1.tmod.dw_mod.enabled=true	
end if

end event

event rbuttondown;st_dw_xa_funciones st_dw
st_dw.dw=this
st_dw.dwo=dwo
st_dw.row=row
st_dw.color_fondo=string(rgb(255,255,255))
openwithparm(w_funcion_dw,st_dw)
end event

type tab_3 from tab within tp_p
event create ( )
event destroy ( )
integer x = 3575
integer y = 20
integer width = 3077
integer height = 816
integer taborder = 50
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long backcolor = 67108864
boolean raggedright = true
boolean focusonbuttondown = true
boolean showtext = false
integer selectedtab = 1
det det
nota nota
end type

on tab_3.create
this.det=create det
this.nota=create nota
this.Control[]={this.det,&
this.nota}
end on

on tab_3.destroy
destroy(this.det)
destroy(this.nota)
end on

type det from userobject within tab_3
event create ( )
event destroy ( )
integer x = 18
integer y = 112
integer width = 3040
integer height = 688
long backcolor = 67108864
string text = "Detalle"
long tabtextcolor = 33554432
string picturename = "deta_rad.ico"
long picturemaskcolor = 536870912
pb_diacc pb_diacc
pb_8 pb_8
pb_diac pb_diac
pb_anula pb_anula
pb_dian pb_dian
pb_radvi pb_radvi
dw_det dw_det
end type

on det.create
this.pb_diacc=create pb_diacc
this.pb_8=create pb_8
this.pb_diac=create pb_diac
this.pb_anula=create pb_anula
this.pb_dian=create pb_dian
this.pb_radvi=create pb_radvi
this.dw_det=create dw_det
this.Control[]={this.pb_diacc,&
this.pb_8,&
this.pb_diac,&
this.pb_anula,&
this.pb_dian,&
this.pb_radvi,&
this.dw_det}
end on

on det.destroy
destroy(this.pb_diacc)
destroy(this.pb_8)
destroy(this.pb_diac)
destroy(this.pb_anula)
destroy(this.pb_dian)
destroy(this.pb_radvi)
destroy(this.dw_det)
end on

type pb_diacc from picturebutton within det
integer x = 2871
integer y = 292
integer width = 146
integer height = 128
integer taborder = 250
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean originalsize = true
string picturename = "dian_zip.gif"
string disabledname = "d_dian_zip.gif"
alignment htextalign = left!
string powertiptext = "Contenedor Capita"
end type

event clicked;////////ELECTRONICA	
if is_elec='2' then
	double l_i,l_nfactura,num_radica
	string ls_clugar,ls_tfac,clugar_rad,tipo_rad
	nvo_factura_electronica u_eleccc
	st_ret_dian    lst_lle
		
	u_eleccc=create nvo_factura_electronica
	num_radica=tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemnumber(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),'num_radicacion')
	clugar_rad=tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemstring(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),"clugar")
	tipo_rad=tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemstring(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),"tipo")
	if tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemstring(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),'estado_dian')<>'1' then return
	if tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemstring(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),'file_name_fact')='' or isnull(tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemstring(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),'file_name_fact')) then return
	
	if u_eleccc.of_enviar_new_correo(num_radica,clugar_rad,tipo_rad,0,'',tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemstring(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),'file_name_fact'),'C')=-1 then
		messagebox('','Proceso con errores')
	else
		messagebox('','Proceso Finalizado')
	end if
	destroy u_eleccc

else
	messagebox('','No hay parametro Habilitado')
end if
//////ELECTRONICA	
end event

type pb_8 from picturebutton within det
integer x = 2715
integer y = 292
integer width = 146
integer height = 128
integer taborder = 80
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean originalsize = true
string picturename = "print2.gif"
alignment htextalign = left!
string powertiptext = "Imprimir"
end type

event clicked;long fila
string ls_elec1
any par[3]

fila=tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow()
if fila< 1 then return


SELECT cadena into :ls_elec1
FROM parametros_gen
WHERE (((codigo_para)=66));
if sqlca.sqlnrows=0 then
	messagebox('Atencíon','No hay parametro 66')
	return
end if

i_rep.v_preliminar=true
i_rep.dialogo=false
i_rep.cambiar_prop=false
i_rep.tipo_rep='documento!'
if tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemstring(fila,"tipo")='R' then 
	i_rep.nombre_rep='Impresión Relación Envio'
	i_rep.cod_rep='RA'
else
	i_rep.nombre_rep='Impresión de Factura Capita'
	i_rep.cod_rep='RV'
end If

if i_rep.inicia()=-1 then return
par[1]=tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemnumber(fila,"num_radicacion")
par[2]=tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemstring(fila,"clugar")
par[3]=tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemstring(fila,"ripsradica_tipo")

if i_rep.cod_rep='RV' and ls_elec1<>'0' then
	i_rep.imprimir(par,'','1')
else
	i_rep.imprimir(par,'','0')
end if

end event

type pb_diac from picturebutton within det
integer x = 2871
integer y = 156
integer width = 146
integer height = 128
integer taborder = 40
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean originalsize = true
string picturename = "dian.gif"
string disabledname = "d_dian.gif"
alignment htextalign = left!
string powertiptext = "Envio"
end type

event clicked;////////ELECTRONICA	
if is_elec='2' then
	double l_i,l_nfactura,num_radica
	string ls_clugar,ls_tfac,clugar_rad,tipo_rad
	nvo_factura_electronica u_elecco
	st_ret_dian  lst_lle
		
	u_elecco=create nvo_factura_electronica

	num_radica=tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemnumber(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),'num_radicacion')
	clugar_rad=tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemstring(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),"clugar")
	tipo_rad=tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemstring(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),"tipo")
	tab_2.tp2_1.tab_1.tp_p.dw_facturas.settransobject(sqlca)
	tab_2.tp2_1.tab_1.tp_p.dw_facturas.retrieve(num_radica,clugar_rad,tipo_rad)
		
	for l_i =1 to tab_2.tp2_1.tab_1.tp_p.dw_facturas.rowcount()
		if g_motor='postgres' then
			dw_electronica.dataobject='dw_factura_electronica_postgres'
		else
			dw_electronica.dataobject='dw_factura_electronica_cap_sql' 
		end if	
		dw_electronica.settransobject(sqlca)

		
		if tab_2.tp2_1.tab_1.tp_p.dw_facturas.getitemstring(l_i,'estado_dian')<>'1' then continue
		if tab_2.tp2_1.tab_1.tp_p.dw_facturas.getitemstring(l_i,'file_name_fact')='' or isnull(tab_2.tp2_1.tab_1.tp_p.dw_facturas.getitemstring(l_i,'file_name_fact')) then continue
		
		l_nfactura=tab_2.tp2_1.tab_1.tp_p.dw_facturas.getitemnumber(l_i,'nfact')
		ls_clugar=tab_2.tp2_1.tab_1.tp_p.dw_facturas.getitemstring(l_i,'clugar')
		ls_tfac=tab_2.tp2_1.tab_1.tp_p.dw_facturas.getitemstring(l_i,'tipo')
		
		u_elecco.of_enviar_new_correo(l_nfactura,ls_clugar,ls_tfac,0,'',tab_2.tp2_1.tab_1.tp_p.dw_facturas.getitemstring(l_i,'file_name_fact'),'F')
		
	next
	destroy u_elecco
	messagebox('','Proceso Finalizado')
else
	messagebox('','No hay parametro Habilitado')
end if
//////ELECTRONICA	
end event

type pb_anula from picturebutton within det
integer x = 2715
integer y = 152
integer width = 146
integer height = 128
integer taborder = 41
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean originalsize = true
string picturename = "borrador.GIF"
string disabledname = "d_borrador.GIF"
alignment htextalign = left!
end type

event clicked;if tag='1' then
	if f_permiso_boton(this,'RA')=0 then return
end if
if isnull(tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemstring(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),"estado")) then 
	if tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemstring(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),"contabil")<>'C' then
		open(w_anula_radica)
	end if
end if	
end event

type pb_dian from picturebutton within det
integer x = 2871
integer y = 16
integer width = 146
integer height = 128
integer taborder = 41
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean originalsize = true
string picturename = "dian.gif"
string disabledname = "d_dian.gif"
alignment htextalign = left!
string powertiptext = "Envio Electronica Capita"
end type

event clicked;nvo_factura_electronica u_elec
st_ret_dian    lst_lle
double facturas


u_elec=create nvo_factura_electronica

if g_motor='postgres' then
	dw_electronica.dataobject='asis_int_factura_ele_cap'
else
	dw_electronica.dataobject='dw_factura_electronica_cap_sql' 
end if	
dw_electronica.settransobject(sqlca)

if tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemstring(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),'estado_dian')='1' then 
	messagebox('Atención','Ya fue envia a Dian')
	return
End if

facturas=tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemnumber(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),'num_radicacion')
lst_lle=u_elec.sign_chilkat(dw_electronica,facturas,clugar,'F',0,'f','RV')
destroy u_elec
////////ELECTRONICA	
end event

type pb_radvi from picturebutton within det
integer x = 2715
integer y = 16
integer width = 146
integer height = 128
integer taborder = 41
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
boolean originalsize = true
string picturename = "guardar2.gif"
string disabledname = "d_guardar2.gif"
alignment htextalign = left!
string powertiptext = "Generar Diskettes de Radicaciones Pasadas"
end type

event clicked;if not f_hasta() then 
	messagebox("Atención","Su periodo de validez ha caducado, comuníquese con GCI Ltda. para reactivarlo")
	return
end if
//////////// ojo para que no metan goles ^
if tab_2.tp2_1.tab_1.tp_p.tab_3.det.dw_det.find('forecat=1',1,tab_2.tp2_1.tab_1.tp_p.tab_3.det.dw_det.rowcount())>0 and tab_2.tp2_1.tab_1.tp_p.tab_3.det.dw_det.find('forecat=0',1,tab_2.tp2_1.tab_1.tp_p.tab_3.det.dw_det.rowcount())>0 then
	messagebox('Atención','No puede generar dos contratos al tiempo con formato FORECAT si uno de ellos no es de SOAT o evento catastrófico')
	return
end if
setpointer(hourglass!)
is_decual='emp'
long nrad
if tab_2.tp2_1.tab_1.tp_p.dw_radica.rowcount()>0 then
	if not isnull(tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemstring(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),"estado")) then
		Messagebox("Atención","Este número de radicación está anulado.~r~nNo hay registros para generar")
	else
		if tab_2.tp2_1.rb_txt.checked=true then
			if tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemstring(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),"reserva")='0' then
				nrad=f_rips(false,tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemnumber(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),"num_radicacion"),tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemstring(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),"clugar"),tab_2.tp2_1.tab_1.tp_p.tab_3.det.dw_det,'emp',tab_2.tp2_1.rb_4.checked,-1,tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemstring(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),"por_lugar"),tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemstring(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),"reserva"),tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemstring(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),"tipo"))
			else
				nrad=f_rips(true,tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemnumber(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),"num_radicacion"),tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemstring(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),"clugar"),tab_2.tp2_1.tab_1.tp_p.tab_3.det.dw_det,'emp',tab_2.tp2_1.rb_4.checked,-1,tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemstring(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),"por_lugar"),tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemstring(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),"reserva"),tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemstring(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),"tipo"))
			end if
		
			choose case nrad
				case -1,-10
					rollback;
				case 0
				case else
					messagebox("Atención",'Archivos generados con éxito')
			end choose
		else
			nvo_rips_json u_rips
			string ls_nomarch
			
			u_rips=create nvo_rips_json
			if  isnull(tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemstring(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),'prefijo')) then
				ls_nomarch=tab_2.tp2_1.sle_dir.text+'\'+string(tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemnumber(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),"num_radicacion"))+'.json'
			else
				ls_nomarch=tab_2.tp2_1.sle_dir.text+'\'+tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemstring(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),'prefijo')+string(tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemnumber(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),"num_radicacion"))+'.json'
			end if
			u_rips.emite_json_capita(tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemnumber(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),'num_radicacion'),tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemstring(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),'clugar'),tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemstring(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),'tipo'),'f','FV',ls_nomarch)
			destroy 	u_rips
		end if
		tab_2.tp2_1.t1.tp1.barra.position=0
	end if
end if
tab_2.tp2_1.tab_1.tp_p.dw_radica.retrieve(CLUGAR)




end event

type dw_det from datawindow within det
integer x = 23
integer y = 12
integer width = 2670
integer height = 652
integer taborder = 41
string title = "none"
string dataobject = "dw_contratos_pa_rias"
boolean hscrollbar = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event doubleclicked;if tab_2.tp2_1.tab_1.tp_p.tab_3.det.dw_det.getitemstring(tab_2.tp2_1.tab_1.tp_p.tab_3.det.dw_det.getrow(),'ctipo')='2' then
	st_deta_rips st_envia
	string ls_ret
	
	st_envia.nrad=dw_det.getitemnumber(dw_det.getrow(),'num_radicacion')
	st_envia.clug=dw_det.getitemstring(dw_det.getrow(),'clugar')
	st_envia.tipo=dw_det.getitemstring(dw_det.getrow(),'tipo')
	st_envia.cemp=dw_det.getitemstring(dw_det.getrow(),'cemp')
	st_envia.ccont=dw_det.getitemstring(dw_det.getrow(),'ccontrato')
	st_envia.capita=dw_det.getitemnumber(dw_det.getrow(),'valor_capita')
	st_envia.eapb=tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemstring(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),'desemp')
	st_envia.ncont=tab_2.tp2_1.tab_1.tp_p.tab_3.det.dw_det.getitemstring(tab_2.tp2_1.tab_1.tp_p.tab_3.det.dw_det.getrow(),'contrato')
	st_envia.nusuario=dw_det.getitemnumber(dw_det.getrow(),'nusuarios')
	if dw_det.getitemstring(dw_det.getrow(),'dist')='1' then 
		st_envia.contabil='C'
	else
		st_envia.contabil=tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemstring(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),'contabil')
	end if
	openwithparm(w_ripsdetalle_desagrega,st_envia)
	ls_ret=message.stringparm
	if ls_ret='ok' then 
		UPDATE ripsradicadet SET  dist='1'
		WHERE (((ripsradicadet.num_radicacion)=:st_envia.nrad) AND ((ripsradicadet.clugar)=:st_envia.clug) AND ((ripsradicadet.TIPO)=:st_envia.tipo) AND ((ripsradicadet.CEMP)=:st_envia.cemp) AND ((ripsradicadet.CCONTRATO)=:st_envia.ccont));
		if sqlca.sqlcode=-1 then
			messagebox("Error Actualizando en Ripsradicadet dist",sqlca.sqlerrtext)
			return -1
		end if
		commit;
	end if
end if
end event

event itemchanged;if dwo.name='valor_capita' then
	if messagebox("Atención",'Está seguro que desea cambiar el monto de lo radicado.?',question!,yesno!,2)=2 then 
		settext(string(getitemnumber(getrow(),'valor_capita')))
		return 1
	end if	
	accepttext()
	tab_2.tp2_1.tab_1.tp_p.dw_radica.setitem(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),'valor_capita',getitemnumber(1,'t_capita'))
	if tab_2.tp2_1.tab_1.tp_p.dw_radica.update(true,false)=-1 then
		rollback;
		return 1
	end if
	if update(true,false)=-1 then
		rollback;
	else
		commit;
		resetupdate()
		tab_2.tp2_1.tab_1.tp_p.dw_radica.resetupdate()
	end if
end if

end event

type nota from userobject within tab_3
integer x = 18
integer y = 112
integer width = 3040
integer height = 688
long backcolor = 67108864
string text = "Notas"
long tabtextcolor = 33554432
string picturename = "nota_dc.ico"
long picturemaskcolor = 536870912
pb_impnota pb_impnota
pb_connota pb_connota
pb_gnota pb_gnota
pb_brr pb_brr
pb_diann pb_diann
pb_insn pb_insn
dw_nc dw_nc
end type

on nota.create
this.pb_impnota=create pb_impnota
this.pb_connota=create pb_connota
this.pb_gnota=create pb_gnota
this.pb_brr=create pb_brr
this.pb_diann=create pb_diann
this.pb_insn=create pb_insn
this.dw_nc=create dw_nc
this.Control[]={this.pb_impnota,&
this.pb_connota,&
this.pb_gnota,&
this.pb_brr,&
this.pb_diann,&
this.pb_insn,&
this.dw_nc}
end on

on nota.destroy
destroy(this.pb_impnota)
destroy(this.pb_connota)
destroy(this.pb_gnota)
destroy(this.pb_brr)
destroy(this.pb_diann)
destroy(this.pb_insn)
destroy(this.dw_nc)
end on

type pb_impnota from picturebutton within nota
integer x = 2885
integer y = 292
integer width = 146
integer height = 128
integer taborder = 90
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean originalsize = true
string picturename = "print2.gif"
alignment htextalign = left!
string powertiptext = "Imprime Nota"
end type

event clicked;long ldb_fila
any par[4]
string ls_elec1

ldb_fila=dw_nc.getrow()
if ldb_fila< 1 then return

SELECT cadena into :ls_elec1
FROM parametros_gen
WHERE (((codigo_para)=66));
if sqlca.sqlnrows=0 then
	messagebox('Atencíon','No hay parametro 66')
	return
end if

i_rep.v_preliminar=true
i_rep.dialogo=false
i_rep.cambiar_prop=false
i_rep.tipo_rep='documento!'
if dw_nc.getitemstring(ldb_fila,"tipo_nota")='C' then
	i_rep.nombre_rep='Impresión de Nota Credito'
	i_rep.cod_rep='CRA'
else
	i_rep.nombre_rep='Impresión de Nota Debito'
	i_rep.cod_rep='DRA'
end if

if i_rep.inicia()=-1 then return
par[1]=dw_nc.getitemnumber(ldb_fila,"num_radicacion")
par[2]=dw_nc.getitemstring(ldb_fila,"clugar")
par[3]=dw_nc.getitemstring(ldb_fila,"tipo")
par[4]=dw_nc.getitemnumber(ldb_fila,"nro_nota")

if  ls_elec1<>'0' then
	i_rep.imprimir(par,'','1')
else
	i_rep.imprimir(par,'','0')
end if
end event

type pb_connota from picturebutton within nota
integer x = 2880
integer y = 152
integer width = 146
integer height = 128
integer taborder = 50
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean originalsize = true
string picturename = "dian_zip.gif"
string disabledname = "d_dian_zip.gif"
alignment htextalign = left!
string powertiptext = "Envio Contenedor"
end type

event clicked;////////ELECTRONICA	
if is_elec='2' then
	double ldb_i,ldb_nfactura,ldb_numradica
	int li_nnota
	string ls_clugar,ls_tfac,ls_clugarrad,ls_tiporad,ls_tnota
	nvo_factura_electronica u_eleccc
	st_ret_dian    lst_lle
		
	u_eleccc=create nvo_factura_electronica
	ldb_numradica=dw_nc.getitemnumber(dw_nc.getrow(),'num_radicacion')
	ls_clugarrad=dw_nc.getitemstring(dw_nc.getrow(),"clugar")
	ls_tiporad=dw_nc.getitemstring(dw_nc.getrow(),"tipo")
	li_nnota=dw_nc.getitemnumber(dw_nc.getrow(),'nro_nota')
	ls_tnota=dw_nc.getitemstring(dw_nc.getrow(),"tipo_nota")
	if dw_nc.getitemstring(dw_nc.getrow(),'estado_dian_nota')<>'1' then return
	if dw_nc.getitemstring(dw_nc.getrow(),'file_name_nota')='' or isnull(dw_nc.getitemstring(dw_nc.getrow(),'file_name_nota')) then return
	
	u_eleccc.of_enviar_new_correo(ldb_numradica,ls_clugarrad,ls_tiporad,li_nnota,ls_tnota,dw_nc.getitemstring(dw_nc.getrow(),'file_name_nota'),'C')
	destroy u_eleccc
	messagebox('','Proceso Finalizado')
else
	messagebox('','No hay parametro Habilitado')
end if
//////ELECTRONICA	


end event

type pb_gnota from picturebutton within nota
integer x = 2720
integer y = 288
integer width = 146
integer height = 128
integer taborder = 90
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean enabled = false
boolean originalsize = true
string picturename = "guardar.GIF"
string disabledname = "d_guardar.GIF"
alignment htextalign = left!
string powertiptext = "Guarda Nota"
end type

event clicked;if dw_nc.update(true,false)=-1 then
	rollback;
	return 
else
	commit;
end if

if tab_2.tp2_1.tab_1.tp_p.tab_3.det.dw_det.update(true,false)=-1 then
	rollback;
	return 
else
	commit;
end if	

pb_insn.enabled=true
pb_gnota.enabled=false
pb_diann.enabled=true

end event

type pb_brr from picturebutton within nota
integer x = 2720
integer y = 152
integer width = 146
integer height = 128
integer taborder = 51
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean enabled = false
boolean originalsize = true
string picturename = "borrar_fila.gif"
string disabledname = "d_borrar_fila.gif"
alignment htextalign = left!
end type

event clicked;if dw_nc.GetItemStatus(dw_nc.getrow(),0,Primary!) = NewModified! or  dw_nc.GetItemStatus(dw_nc.getrow(),0,Primary!) = NewModified!  then
	dw_nc.deleterow(dw_nc.getrow())
end if

end event

type pb_diann from picturebutton within nota
integer x = 2880
integer y = 24
integer width = 146
integer height = 128
integer taborder = 250
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean enabled = false
boolean originalsize = true
string picturename = "dian.gif"
string disabledname = "d_dian.gif"
alignment htextalign = left!
string powertiptext = "Envio Nota"
end type

event clicked;long ldb_numradica
datetime ldt_ahora
string ls_clugarrad,ls_tiporad,ls_anula,ls_tiponota
int li_nnota

dw_nc.accepttext()
pb_brr.enabled=false
pb_diann.enabled=false
ldb_numradica=dw_nc.getitemnumber(dw_nc.getrow(),'num_radicacion')
ls_clugarrad=dw_nc.getitemstring(dw_nc.getrow(),"clugar")
ls_tiporad=dw_nc.getitemstring(dw_nc.getrow(),"tipo")
li_nnota=dw_nc.getitemnumber(dw_nc.getrow(),'nro_nota')
ls_tiponota=lower(dw_nc.getitemstring(dw_nc.getrow(),'tipo_nota'))

if ls_tiporad='F' and isnull(dw_nc.getitemstring(dw_nc.getrow(),'estado_dian_nota')) then
	st_ret_dian    lst_lle
	nvo_factura_electronica u_eleca
	u_eleca=create nvo_factura_electronica
	
	if g_motor='postgres' then
		if ls_tiponota='c' then
			dw_electronica.dataobject='dw_factura_electronica_cap_postgres_ncredito'	
		else
			dw_electronica.dataobject='dw_factura_electronica_cap_postgres_ndebito'
		end if
	end if	
	dw_electronica.settransobject(sqlca)
		
	lst_lle=u_eleca.sign_chilkat(dw_electronica,ldb_numradica,ls_clugarrad,ls_tiporad,li_nnota,ls_tiponota,'RV')
	if lst_lle.as_estado<>'1' then
		destroy u_eleca
		return
	end if
	messagebox('','Proceso Finalizado')
	destroy u_eleca
end if
end event

type pb_insn from picturebutton within nota
integer x = 2720
integer y = 16
integer width = 146
integer height = 128
integer taborder = 41
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean enabled = false
boolean originalsize = true
string picturename = "insertar.gif"
string disabledname = "d_insertar.gif"
alignment htextalign = left!
string powertiptext = "Inserta Nota"
end type

event clicked;if tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemstring(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),'en_destino')='1' then 
	messagebox("Atención",'La factura ya se encuentra en cartera, no la puede hacer Nota debe hacer proceso por objecciones')
	return
end if
if not isnull(tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemstring(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),'estado')) then 
	messagebox('Atencion', 'Ya esta Anulada')
	return
end if
if  tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemstring(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),"presupuesto")='1' then
	messagebox("Atención",'La factura ya se encuentra en Reconocimiento Presupuestal, no puede hacer nota')
	return
end if
int li_fila,li_nnota

li_fila=dw_nc.insertrow(0)
dw_nc.scrolltorow(li_fila)
dw_nc.setfocus()

li_nnota=dw_nc.getitemnumber(1,'nnotas')
if isnull(li_nnota) then li_nnota=0
li_nnota++
dw_nc.setitem(li_fila,'num_radicacion', tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemnumber(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),'num_radicacion'))
dw_nc.setitem(li_fila,'clugar', tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemstring(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),'clugar'))
dw_nc.setitem(li_fila,'tipo', tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemstring(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),'tipo'))
dw_nc.setitem(li_fila,'valor_capita', tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemnumber(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),'valor_capita'))
dw_nc.setitem(li_fila,'valor_evento', tab_2.tp2_1.tab_1.tp_p.dw_radica.getitemnumber(tab_2.tp2_1.tab_1.tp_p.dw_radica.getrow(),'valor_evento'))


dw_nc.setitem(li_fila,'fecha_nota',datetime(today(), Now()))
dw_nc.setitem(li_fila,'cod_usuario',usuario)
dw_nc.setitem(li_fila,'nro_nota',li_nnota)

pb_brr.enabled=true
pb_insn.enabled=False
pb_gnota.enabled=true

end event

type dw_nc from datawindow within nota
integer x = 27
integer y = 20
integer width = 2665
integer height = 652
integer taborder = 190
string title = "none"
string dataobject = "dw_ripsradica_nota"
boolean hscrollbar = true
boolean vscrollbar = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event rowfocuschanged;if getitemstring(currentrow,'estado_dian_nota')='1' then
	pb_brr.enabled=false
	pb_diann.enabled=false
	pb_connota.enabled=false
else
	pb_brr.enabled=false
	pb_diann.enabled=true
	pb_connota.enabled=true
end if
end event

event itemchanged;if dwo.name='valor_nota' then
	if messagebox("Atención",'Está seguro que desea cambiar el monto la nota.?',question!,yesno!,2)=2 then 
		settext(string(getitemnumber(getrow(),'valor_nota')))
		return 1
	end if	
	accepttext()
	int li_rec
	decimal ln_valorn,ln_valorc,ln_valora
	ln_valorn=getitemnumber(getrow(),'valor_nota')
	for li_rec=1 to tab_2.tp2_1.tab_1.tp_p.tab_3.det.dw_det.rowcount()
		ln_valorc=ln_valorn*tab_2.tp2_1.tab_1.tp_p.tab_3.det.dw_det.getitemnumber(li_rec,'porcen')
		if getitemstring(getrow(),'tipo_nota')='C' then
			ln_valora=tab_2.tp2_1.tab_1.tp_p.tab_3.det.dw_det.getitemnumber(li_rec,'valor_ncr')
			tab_2.tp2_1.tab_1.tp_p.tab_3.det.dw_det.setitem(li_rec,'valor_ncr',ln_valora+ln_valorc)
		else
			ln_valora=tab_2.tp2_1.tab_1.tp_p.tab_3.det.dw_det.getitemnumber(li_rec,'valor_ndb')			
			tab_2.tp2_1.tab_1.tp_p.tab_3.det.dw_det.setitem(li_rec,'valor_ndb',ln_valora+ln_valorc)
		end if
	next
end if
end event

type rb_defecto from radiobutton within tp2_1
integer x = 5070
integer y = 32
integer width = 315
integer height = 64
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Emitir en:"
end type

event clicked;sle_dir.enabled=true
cb_dir.enabled=true
end event

type cb_dir from commandbutton within tp2_1
integer x = 5390
integer y = 28
integer width = 82
integer height = 72
integer taborder = 90
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean enabled = false
string text = "..."
end type

event clicked;GetFolder ( 'Directorio a Colocar RIPS', sle_dir.text )

end event

type gb_8 from groupbox within tp2_1
integer x = 9
integer width = 1102
integer height = 116
integer taborder = 10
integer textsize = -7
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Small Fonts"
long textcolor = 33554432
long backcolor = 67108864
string text = "Codificación"
end type

type gb_5 from groupbox within tp2_1
integer x = 1143
integer width = 2885
integer height = 116
integer taborder = 61
integer textsize = -7
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Small Fonts"
long textcolor = 33554432
long backcolor = 67108864
string text = "Opciones en Emisión"
end type

type sle_dir from singlelineedit within tp2_1
integer x = 5481
integer y = 28
integer width = 1051
integer height = 76
integer taborder = 80
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
boolean enabled = false
boolean displayonly = true
borderstyle borderstyle = stylelowered!
end type

event constructor;string ruta_rips

SELECT cadena into :ruta_rips
FROM parametros_gen
WHERE (((codigo_para)=1));
if sqlca.sqlnrows=0 then
	messagebox('Atencíon','No hay parametro 1')
	return 
end if
text=ruta_rips
end event

type gb_12 from groupbox within tp2_1
integer x = 4101
integer width = 640
integer height = 116
integer taborder = 60
integer textsize = -7
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Small Fonts"
long textcolor = 33554432
long backcolor = 67108864
string text = "Rips en"
end type

type tp2_3 from userobject within tab_2
integer x = 18
integer y = 112
integer width = 6880
integer height = 2412
long backcolor = 67108864
string text = "Por Empresa Reemitir"
long tabtextcolor = 33554432
string picturename = "rips_3.ico"
long picturemaskcolor = 536870912
string powertiptext = "Reemite RIPS por Empresa Periodo"
pb_6 pb_6
pb_5 pb_5
sle_ant sle_ant
cb_2 cb_2
rb_13 rb_13
cbx_12 cbx_12
cbx_11 cbx_11
cbx_10 cbx_10
cbx_9 cbx_9
cbx_8 cbx_8
rb_12 rb_12
rb_11 rb_11
dw_radica_ant dw_radica_ant
dw_empre dw_empre
em_6 em_6
em_5 em_5
st_21 st_21
gb_10 gb_10
gb_11 gb_11
end type

on tp2_3.create
this.pb_6=create pb_6
this.pb_5=create pb_5
this.sle_ant=create sle_ant
this.cb_2=create cb_2
this.rb_13=create rb_13
this.cbx_12=create cbx_12
this.cbx_11=create cbx_11
this.cbx_10=create cbx_10
this.cbx_9=create cbx_9
this.cbx_8=create cbx_8
this.rb_12=create rb_12
this.rb_11=create rb_11
this.dw_radica_ant=create dw_radica_ant
this.dw_empre=create dw_empre
this.em_6=create em_6
this.em_5=create em_5
this.st_21=create st_21
this.gb_10=create gb_10
this.gb_11=create gb_11
this.Control[]={this.pb_6,&
this.pb_5,&
this.sle_ant,&
this.cb_2,&
this.rb_13,&
this.cbx_12,&
this.cbx_11,&
this.cbx_10,&
this.cbx_9,&
this.cbx_8,&
this.rb_12,&
this.rb_11,&
this.dw_radica_ant,&
this.dw_empre,&
this.em_6,&
this.em_5,&
this.st_21,&
this.gb_10,&
this.gb_11}
end on

on tp2_3.destroy
destroy(this.pb_6)
destroy(this.pb_5)
destroy(this.sle_ant)
destroy(this.cb_2)
destroy(this.rb_13)
destroy(this.cbx_12)
destroy(this.cbx_11)
destroy(this.cbx_10)
destroy(this.cbx_9)
destroy(this.cbx_8)
destroy(this.rb_12)
destroy(this.rb_11)
destroy(this.dw_radica_ant)
destroy(this.dw_empre)
destroy(this.em_6)
destroy(this.em_5)
destroy(this.st_21)
destroy(this.gb_10)
destroy(this.gb_11)
end on

type pb_6 from picturebutton within tp2_3
integer x = 2757
integer y = 132
integer width = 146
integer height = 128
integer taborder = 210
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean originalsize = true
string picturename = "refrescar.GIF"
string disabledname = "d_refrescar.GIF"
end type

event clicked;datetime lfecha_ini,lfecha_fin
string lclug

lfecha_ini=datetime(date(em_5.text))
lfecha_fin=datetime(date(em_6.text))
dw_radica_ant.retrieve('%',lfecha_ini,lfecha_fin,dw_empre.getitemstring(1,1))
lclug=dw_lug.getitemstring(1,1)
if rb_7.checked then
	dw_radica_ant.setfilter("")
else
	dw_radica_ant.setfilter("lugar_s ='"+lclug+"'")	
end if
dw_radica_ant.filter()


end event

type pb_5 from picturebutton within tp2_3
integer x = 2917
integer y = 132
integer width = 146
integer height = 128
integer taborder = 51
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
boolean originalsize = true
string picturename = "guardar.gif"
string disabledname = "d_guardar.gif"
alignment htextalign = left!
string powertiptext = "Generar Diskettes de Radicaciones Pasadas"
end type

event clicked;string dir_sale,l_deta,p_tipo_rad,p_clug_rad,formato,l_cual,por_lugar,cips,lclug,realn[9]
string lnom_c='AC',lnom_p='AP',lnom_u='AU',lnom_rn='AN',lnom_m='AM',lnom_h='AH',lnom_o='AT',lnom_us='US',lnom_t='AF'
long p_nradica,l_i,l_j,l_k,l_arch,l_filas,p_at=0,comis,n_reg[9]
uo_datastore dw_conts,dw_exportc,dw_exportp,dw_exportu,dw_exportrn,dw_exportm,dw_exporth,dw_exporto
uo_datastore dw_exportt,dw_exportus
boolean p_cups
datetime lfecha_ini,lfecha_fin

lfecha_ini=datetime(date(em_5.text))
lfecha_fin=datetime(date(em_6.text))
lclug=dw_lug.getitemstring(1,1)

dw_conts=create uo_datastore
dw_conts.dataobject="dw_contratos_pa_rias"
dw_conts.settransobject(sqlca)

dw_exportc=create uo_datastore
dw_exportc.dataobject="dr_export_rips_consulta"
dw_exportc.settransobject(sqlca)
dw_exportc.reset()

dw_exportp=create uo_datastore
dw_exportp.dataobject="dr_export_rips_proc"
dw_exportp.settransobject(sqlca)
dw_exportp.reset()

dw_exportu=create uo_datastore
dw_exportu.dataobject="dr_export_rips_urg"
dw_exportu.settransobject(sqlca)
dw_exportu.reset()

dw_exporth=create uo_datastore
dw_exporth.dataobject="dr_export_rips_hosp"
dw_exporth.settransobject(sqlca)
dw_exporth.reset()

dw_exportrn=create uo_datastore
dw_exportrn.dataobject="dr_export_rips_rn"
dw_exportrn.settransobject(sqlca)
dw_exportrn.reset()

dw_exportm=create uo_datastore
dw_exportm.dataobject="dr_export_rips_medica"
dw_exportm.settransobject(sqlca)
dw_exportm.reset()

dw_exporto=create uo_datastore
dw_exporto.dataobject="dr_export_rips_otros"
dw_exporto.settransobject(sqlca)
dw_exporto.reset()

dw_exportt=create uo_datastore
dw_exportt.dataobject="dr_export_rips_af_transac"
dw_exportt.settransobject(sqlca)
dw_exportt.reset()

dw_exportus=create uo_datastore
dw_exportus.dataobject="dr_export_rips_us"
dw_exportus.settransobject(sqlca)
dw_exportus.reset()

dir_sale=sle_ant.text
if cbx_11.checked then p_at=1
if rb_12.checked then 
	p_cups=true
else
	p_cups=false
end if
if cbx_12.checked then 
	l_deta='1'
else 
	l_deta='0'
end if

if cbx_9.checked then 
	is_capiv='1'
else 
	is_capiv='0'
end if

formato=""
for l_j=1 to i_nro_dig -1
	formato+="0"
next
formato+="#"
For l_i=1 to dw_radica_ant.rowcount()
	if dw_radica_ant.getitemstring(l_i,'escog')='1' then
		p_nradica=dw_radica_ant.getitemnumber(l_i,'num_radicacion')
		p_tipo_rad=dw_radica_ant.getitemstring(l_i,'ripsradica_tipo')
		p_clug_rad=dw_radica_ant.getitemstring(l_i,'clugar')
		por_lugar=dw_radica_ant.getitemstring(l_i,"por_lugar")
		for l_arch=1 to 9
			choose case l_arch 
				case 1
					l_cual="Consulta"
				case 2
					l_cual="Procedimientos"
				case 3
					l_cual="Recien Nacido"
				case 4
					l_cual="Hospitalización"
				case 5
					l_cual="Medicamentos"
				case 6
					l_cual="Otros"
				case 7
					l_cual="Urgencias"
				case 8
					l_cual="Usu"
				case 9
					l_cual="Tx"			
			end choose
			choose case l_cual
				case "Consulta"
					dw_trae.dataobject="dr_rips_consulta_viejo"
				case "Procedimientos"
					dw_trae.dataobject="dr_rips_procedimientos_viejo"
				case "Urgencias"
					dw_trae.dataobject="dr_rips_urg_viejo"
				case "Hospitalización"
					dw_trae.dataobject="dr_rips_hosp_viejo"
				case "Recien Nacido"
					dw_trae.dataobject="dr_rips_rn_viejo"
				case "Medicamentos"
					dw_trae.dataobject="dr_rips_medica_viejo"
				case "Otros"
					dw_trae.dataobject="dr_rips_otros_viejo"
				case "Tx"	
					dw_trae.dataobject="dr_rips_af_transacc_viejo"
				case "Usu"
					dw_trae.dataobject="dr_rips_us_usuarios"
			end choose
			dw_trae.settransobject(sqlca)
			w_principal.SetMicroHelp ( 'Leyendo archivo '+l_cual )
			dw_trae.reset()
			if  l_arch  <=7 then 
				dw_trae.retrieve(p_nradica,p_clug_rad,por_lugar,'%',p_tipo_rad,is_capiv)
			end if
			if l_arch=8 then
				dw_trae.retrieve(p_nradica,lfecha_fin,p_clug_rad,p_tipo_rad)
			end if
			if l_arch=9 then
				dw_trae.retrieve(p_nradica,p_clug_rad,por_lugar,p_tipo_rad)
			end if		
			if dw_trae.rowcount()>0 then
				dw_conts.retrieve(p_nradica,p_clug_rad,p_tipo_rad)
				l_filas=dw_trae.rowcount()
				if isnull(n_reg[l_arch]) then n_reg[l_arch]=0
				n_reg[l_arch]=n_reg[l_arch]+l_filas		
				for l_j=1 to l_filas
					choose case l_cual
						case "Consulta"  //l_archivo/empresa/contrato/fechas (Parémetros de Entrada del DataWindow)	
							l_k=dw_exportc.insertrow(0)
							if is_concatena_fac="1" then
								if dw_conts.getitemstring(1,'ctipo')='1' then  
									if por_lugar<>'1' then
										 if not isnull(dw_trae.getitemstring(l_j,"prefijo")) then 
											dw_exportc.setitem(l_k,1,dw_trae.getitemstring(l_j,"prefijo")+string(dw_trae.getitemnumber(l_j,1),formato)) //factura
										else
											dw_export.setitem(l_k,1,dw_trae.getitemstring(l_j,"clugar_fac")+string(dw_trae.getitemnumber(l_j,1),formato)) //factura
										end if
									else
										 if not isnull(dw_trae.getitemstring(l_j,"prefijo")) then 
											dw_exportc.setitem(l_k,1,dw_trae.getitemstring(l_j,"prefijo")+string(dw_trae.getitemnumber(l_j,1),formato)) //factura
										else
											dw_exportc.setitem(l_k,1,dw_trae.getitemstring(l_j,"clugar_fac")+string(dw_trae.getitemnumber(l_j,1),formato)) //factura
										end if
									end if
								else
									dw_exportc.setitem(l_k,1,string(p_nradica,formato))
								end if
							else
								dw_exportc.setitem(l_k,1,string(dw_trae.getitemnumber(l_j,1))) //factura
							end if
							if l_deta='0' then
								dw_exportc.setitem(l_k,2,dw_trae.getitemstring(l_j,'este_codigo')) //cod_ips
							else
								dw_exportc.setitem(l_k,2,dw_trae.getitemstring(l_j,'c_supersalud')) //cod_ips
							end if
							dw_exportc.setitem(l_k,3,dw_trae.getitemstring(l_j,3)) //tipo_doc
							if isnull(dw_trae.getitemstring(l_j,22)) or dw_trae.getitemstring(l_j,22)='' then 
								dw_exportc.setitem(l_k,4,dw_trae.getitemstring(l_j,4)) //documento
							else
								dw_exportc.setitem(l_k,4,dw_trae.getitemstring(l_j,22)+dw_trae.getitemstring(l_j,4)) //documento
							end if
							dw_exportc.setitem(l_k,5,string(dw_trae.getitemdatetime(l_j,5),"dd/mm/yyyy")) //fecha
							dw_exportc.setitem(l_k,6,dw_trae.getitemstring(l_j,6)) //nro_autoriza
							if p_cups then
								dw_exportc.setitem(l_k,7,dw_trae.getitemstring(l_j,'cod_cups'))									
							else
								dw_exportc.setitem(l_k,7,dw_trae.getitemstring(l_j,7)) //cproced
							end if
							dw_exportc.setitem(l_k,8,dw_trae.getitemstring(l_j,8)) //finalidad consulta
							dw_exportc.setitem(l_k,9,dw_trae.getitemstring(l_j,9)) //causa externa
							dw_exportc.setitem(l_k,10,dw_trae.getitemstring(l_j,10)) //diag_prin
							dw_exportc.setitem(l_k,11,dw_trae.getitemstring(l_j,11)) //diagrel1
							dw_exportc.setitem(l_k,12,dw_trae.getitemstring(l_j,12)) //diagrel2
							dw_exportc.setitem(l_k,13,dw_trae.getitemstring(l_j,13)) //diagrel3
							dw_exportc.setitem(l_k,14,dw_trae.getitemstring(l_j,14)) //tipo_diag_prin
							dw_exportc.setitem(l_k,15,string(dw_trae.getitemnumber(l_j,15),"#####0")) //vproced
							dw_exportc.setitem(l_k,16,string(dw_trae.getitemnumber(l_j,"cuota_modera"),"#####0")) //cuota moder
							dw_exportc.setitem(l_k,17,string(dw_trae.getitemnumber(l_j,16),"#####0")) //valor a pagar v_emp
							
						case "Procedimientos"
							l_k=dw_exportp.insertrow(0)
							if is_concatena_fac="1" then
								if dw_conts.getitemstring(1,'ctipo')='1' then  
									if  por_lugar<>'1' then
										 if not isnull(dw_trae.getitemstring(l_j,"prefijo")) then 
											dw_exportp.setitem(l_k,1,dw_trae.getitemstring(l_j,"prefijo")+string(dw_trae.getitemnumber(l_j,1),formato)) //factura
										else
											dw_exportp.setitem(l_k,1,dw_trae.getitemstring(l_j,"clugar_fac")+string(dw_trae.getitemnumber(l_j,1),formato)) //factura
										end if
									else
										 if not isnull(dw_trae.getitemstring(l_j,"prefijo")) then 
											dw_exportp.setitem(l_k,1,dw_trae.getitemstring(l_j,"prefijo")+string(dw_trae.getitemnumber(l_j,1),formato)) //factura
										else
											dw_exportp.setitem(l_k,1,dw_trae.getitemstring(l_j,"clugar_fac")+string(dw_trae.getitemnumber(l_j,1),formato)) //factura
										end if
									end if
								else
									dw_exportp.setitem(l_k,1,string(p_nradica,formato))
								end if
							else
								dw_exportp.setitem(l_k,1,string(dw_trae.getitemnumber(l_j,1))) //factura
							end if
							if l_deta='0' then
								dw_exportp.setitem(l_k,2,dw_trae.getitemstring(l_j,'este_codigo')) //cod_ips
							else
								dw_exportp.setitem(l_k,2,dw_trae.getitemstring(l_j,'c_supersalud')) //cod_ips
							end if
							dw_exportp.setitem(l_k,3,dw_trae.getitemstring(l_j,3)) //tipo_doc
							if isnull(dw_trae.getitemstring(l_j,20)) or dw_trae.getitemstring(l_j,20)='' then 
								dw_exportp.setitem(l_k,4,dw_trae.getitemstring(l_j,4)) //documento
							else
								dw_exportp.setitem(l_k,4,dw_trae.getitemstring(l_j,20)+dw_trae.getitemstring(l_j,4)) //documento
							end if
							dw_exportp.setitem(l_k,5,string(dw_trae.getitemdatetime(l_j,5),"dd/mm/yyyy")) //fecha
							dw_exportp.setitem(l_k,6,dw_trae.getitemstring(l_j,6)) //nro_autoriza
							if p_cups then
								dw_exportp.setitem(l_k,7,dw_trae.getitemstring(l_j,'cod_cups'))
							else
								dw_exportp.setitem(l_k,7,dw_trae.getitemstring(l_j,7)) //cproced
							end if
							dw_exportp.setitem(l_k,8,dw_trae.getitemstring(l_j,8)) //ambito procedim
							dw_exportp.setitem(l_k,9,dw_trae.getitemstring(l_j,9)) //finalidad procedim	
							if dw_trae.getitemstring(l_j,'parto')='1' then 
								dw_exportp.setitem(l_k,10,dw_trae.getitemstring(l_j,10)) //personal que atiende
							else
								dw_exportp.setitem(l_k,10,'') //personal que atiende
							end if
							dw_exportp.setitem(l_k,11,dw_trae.getitemstring(l_j,11)) //diagprin
							dw_exportp.setitem(l_k,12,dw_trae.getitemstring(l_j,12)) //diagrel1
							dw_exportp.setitem(l_k,13,dw_trae.getitemstring(l_j,13)) //diag complicación
							dw_exportp.setitem(l_k,14,dw_trae.getitemstring(l_j,14)) //forma tipo acto quir
							dw_exportp.setitem(l_k,15,string(dw_trae.getitemnumber(l_j,15),"#####0")) //vproced
							
						case "Urgencias"
							l_k=dw_exportu.insertrow(0)
							if is_concatena_fac="1" then
								if dw_conts.getitemstring(1,'ctipo')='1' then  
									if  por_lugar<>'1' then
										 if not isnull(dw_trae.getitemstring(l_j,"prefijo")) then 
											dw_exportu.setitem(l_i,1,dw_trae.getitemstring(l_j,"prefijo")+string(dw_trae.getitemnumber(l_j,1),formato)) //factura
										 else
											dw_exportu.setitem(l_i,1,dw_trae.getitemstring(l_j,"clugar_fac")+string(dw_trae.getitemnumber(l_j,1),formato)) //factura
										end if
									else
										 if not isnull(dw_trae.getitemstring(l_j,"prefijo")) then 
											dw_exportu.setitem(l_i,1,dw_trae.getitemstring(l_j,"prefijo")+string(dw_trae.getitemnumber(l_j,1),formato)) //factura
										else
											dw_exportu.setitem(l_i,1,dw_trae.getitemstring(l_j,"clugar_fac")+string(dw_trae.getitemnumber(l_j,1),formato)) //factura
										end if
									end if
								else
									dw_exportu.setitem(l_i,1,string(p_nradica,formato)) 
								end if
							else
								dw_exportu.setitem(l_i,1,string(dw_trae.getitemnumber(l_j,1))) //factura
							end if
							if l_deta='0' then
								dw_exportu.setitem(l_i,2,dw_trae.getitemstring(l_j,'este_codigo')) //cod_ips
							else
								dw_exportu.setitem(l_i,2,dw_trae.getitemstring(l_j,'c_ips')) //cod_ips
							end if
							dw_exportu.setitem(l_i,3,dw_trae.getitemstring(l_j,3))
							if isnull(dw_trae.getitemstring(l_j,32)) or dw_trae.getitemstring(l_j,32)='' then 
								dw_exportu.setitem(l_i,4,dw_trae.getitemstring(l_j,4))
							else
								dw_exportu.setitem(l_i,4,dw_trae.getitemstring(l_j,32)+dw_trae.getitemstring(l_j,4))
							end if
							dw_exportu.setitem(l_k,5,string(dw_trae.getitemdatetime(l_j,5),"dd/mm/yyyy"))
							dw_exportu.setitem(l_k,6,string(dw_trae.getitemdatetime(l_j,6),"HH:mm"))
							dw_exportu.setitem(l_k,7,left(dw_trae.getitemstring(l_j,7),15))//autoriza
							dw_exportu.setitem(l_k,8,dw_trae.getitemstring(l_j,8))//causaext
							dw_exportu.setitem(l_k,9,dw_trae.getitemstring(l_j,25))//diagsal
							dw_exportu.setitem(l_k,10,dw_trae.getitemstring(l_j,26))//drel1
							dw_exportu.setitem(l_k,11,dw_trae.getitemstring(l_j,27))//drel2
							dw_exportu.setitem(l_k,12,dw_trae.getitemstring(l_j,28))//drel3
							dw_exportu.setitem(l_k,13,dw_trae.getitemstring(l_j,13))//destino
							dw_exportu.setitem(l_k,14,dw_trae.getitemstring(l_j,14))//estado sal
							dw_exportu.setitem(l_k,15,dw_trae.getitemstring(l_j,29))//causamuerte
							dw_exportu.setitem(l_k,16,string(dw_trae.getitemdatetime(l_j,16),"dd/mm/yyyy"))
							dw_exportu.setitem(l_k,17,string(dw_trae.getitemdatetime(l_j,17),"HH:mm"))
							
						case "Hospitalización"
							l_k=dw_exporth.insertrow(0)
							if is_concatena_fac="1" then
								 if dw_conts.getitemstring(1,'ctipo')='1' then  
									if  por_lugar<>'1' then
										 if not isnull(dw_trae.getitemstring(l_k,"prefijo")) then 
											dw_exporth.setitem(l_k,1,dw_trae.getitemstring(l_j,"prefijo")+string(dw_trae.getitemnumber(l_j,1),formato)) //factura								
										 else
											dw_exporth.setitem(l_k,1,dw_trae.getitemstring(l_j,"clugar_fac")+string(dw_trae.getitemnumber(l_j,1),formato)) //factura
										end if
									else
										 if not isnull(dw_trae.getitemstring(l_j,"prefijo")) then 
											dw_exporth.setitem(l_k,1,dw_trae.getitemstring(l_j,"prefijo")+string(dw_trae.getitemnumber(l_j,1),formato)) //factura
										else
											dw_exporth.setitem(l_k,1,dw_trae.getitemstring(l_j,"clugar_fac")+string(dw_trae.getitemnumber(l_j,1),formato)) //factura
										end if
									end if
								else
									dw_exporth.setitem(l_k,1,string(p_nradica,formato)) 
								end if										
							else
								dw_exporth.setitem(l_k,1,string(dw_trae.getitemnumber(l_j,1))) //factura
							end if
							if l_deta='0' then
								dw_exporth.setitem(l_k,2,dw_trae.getitemstring(l_j,'este_codigo')) //cod_ips
							else
								dw_exporth.setitem(l_k,2,dw_trae.getitemstring(l_j,'c_ips')) //cod_ips
							end if
							
							dw_export.setitem(l_k,3,dw_trae.getitemstring(l_j,3))//tdoc
							if isnull(dw_trae.getitemstring(l_k,37)) or dw_trae.getitemstring(l_j,37)='' then 
								dw_exporth.setitem(l_k,4,dw_trae.getitemstring(l_j,4))//docu
							else
								dw_exporth.setitem(l_k,4,dw_trae.getitemstring(l_j,37)+dw_trae.getitemstring(l_j,4))//docu									
							end if
							dw_exporth.setitem(l_k,5,dw_trae.getitemstring(l_j,5))//via ing
							dw_exporth.setitem(l_k,6,string(dw_trae.getitemdatetime(l_j,6),"dd/mm/yyyy"))
							dw_exporth.setitem(l_k,7,string(dw_trae.getitemdatetime(l_j,7),"HH:mm"))
							dw_exporth.setitem(l_k,8,left(dw_trae.getitemstring(l_j,8),15))//autoriza
							dw_exporth.setitem(l_k,9,dw_trae.getitemstring(l_j,9))//causaext
							dw_exporth.setitem(l_k,10,dw_trae.getitemstring(l_j,27))//diag prin ing
							dw_exporth.setitem(l_k,11,dw_trae.getitemstring(l_j,28))//diag prin egre
							dw_exporth.setitem(l_k,12,dw_trae.getitemstring(l_j,29))//diag rel1
							dw_exporth.setitem(l_k,13,dw_trae.getitemstring(l_j,30))//diag rel2
							dw_exporth.setitem(l_k,14,dw_trae.getitemstring(l_j,31))//diag rel3
							dw_exporth.setitem(l_k,15,dw_trae.getitemstring(l_j,32))//diag compl
							dw_exporth.setitem(l_k,16,dw_trae.getitemstring(l_j,16))//estado sal
							dw_exporth.setitem(l_k,17,dw_trae.getitemstring(l_j,33))//diag muerte
							dw_exporth.setitem(l_k,18,string(dw_trae.getitemdatetime(l_j,18),"dd/mm/yyyy"))
							dw_exporth.setitem(l_k,19,string(dw_trae.getitemdatetime(l_j,19),"HH:mm"))
								
						case "Recien Nacido"
							l_k=dw_exportrn.insertrow(0)
							if is_concatena_fac="1" then
								if dw_conts.getitemstring(1,'ctipo')='1' then  
									if  por_lugar<>'1' then
										 if not isnull(dw_trae.getitemstring(l_j,"prefijo")) then 
											dw_exportrn.setitem(l_k,1,dw_trae.getitemstring(l_j,"prefijo")+string(dw_trae.getitemnumber(l_j,1),formato)) //factura
										 else
											dw_exportrn.setitem(l_k,1,dw_trae.getitemstring(l_j,"clugar_fac")+string(dw_trae.getitemnumber(l_j,1),formato)) //factura
										end if
									else
										 if not isnull(dw_trae.getitemstring(l_j,"prefijo")) then 
											dw_exportrn.setitem(l_k,1,dw_trae.getitemstring(l_j,"prefijo")+string(dw_trae.getitemnumber(l_j,1),formato)) //factura
										else
											dw_exportrn.setitem(l_k,1,dw_trae.getitemstring(l_j,"clugar_fac")+string(dw_trae.getitemnumber(l_j,1),formato)) //factura
										end if
									end if
								else
									dw_exportrn.setitem(l_k,1,string(p_nradica,formato))
								end if
							else
								dw_exportrn.setitem(l_k,1,string(dw_trae.getitemnumber(l_j,1))) //factura
							end if
							if l_deta='0' then
								dw_exportrn.setitem(l_k,2,dw_trae.getitemstring(l_j,'este_codigo')) //cod_ips
							else
								dw_exportrn.setitem(l_k,2,dw_trae.getitemstring(l_j,'c_supersalud')) //cod_ips
							end if
							dw_exportrn.setitem(l_k,3,dw_trae.getitemstring(l_j,3))//tdoc
							if isnull(dw_trae.getitemstring(l_j,19)) or dw_trae.getitemstring(l_j,19)='' then 								
								dw_exportrn.setitem(l_k,4,dw_trae.getitemstring(l_j,4))//docu
							else
								dw_exportrn.setitem(l_k,4,dw_trae.getitemstring(l_j,19)+dw_trae.getitemstring(l_j,4))//docu									
							end if
							dw_exportrn.setitem(l_k,5,string(dw_trae.getitemdatetime(l_j,5),"dd/mm/yyyy"))//fecha_nac
							dw_exportrn.setitem(l_k,6,string(dw_trae.getitemdatetime(l_j,5),"HH:mm"))//horanac
							dw_exportrn.setitem(l_k,7,string(dw_trae.getitemnumber(l_j,6)))//edad gesta
							dw_exportrn.setitem(l_k,8,dw_trae.getitemstring(l_j,7))//control prenatal
							dw_exportrn.setitem(l_k,9,dw_trae.getitemstring(l_j,8))//sexo
							dw_exportrn.setitem(l_k,10,string(dw_trae.getitemnumber(l_j,9)))//peso
							dw_exportrn.setitem(l_k,11,dw_trae.getitemstring(l_j,15))//diag rn
							dw_exportrn.setitem(l_k,12,dw_trae.getitemstring(l_j,16))//diag muerte
							dw_exportrn.setitem(l_k,13,string(dw_trae.getitemdatetime(l_j,12),"dd/mm/yyyy"))
							dw_exportrn.setitem(l_k,14,string(dw_trae.getitemdatetime(l_j,12),"HH:mm"))
								
						case "Medicamentos"
							l_k=dw_exportm.insertrow(0)
							if is_concatena_fac="1" then
								if dw_conts.getitemstring(1,'ctipo')='1' then  
									if  por_lugar<>'1' then
										 if not isnull(dw_trae.getitemstring(l_j,"prefijo")) then 
											dw_exportm.setitem(l_k,1,dw_trae.getitemstring(l_j,"prefijo")+string(dw_trae.getitemnumber(l_j,1),formato)) //factura
										 else
											dw_exportm.setitem(l_k,1,dw_trae.getitemstring(l_j,"clugar_fac")+string(dw_trae.getitemnumber(l_j,1),formato)) //factura
										end if
									else
										 if not isnull(dw_trae.getitemstring(l_k,"prefijo")) then 
											dw_exportm.setitem(l_k,1,dw_trae.getitemstring(l_j,"prefijo")+string(dw_trae.getitemnumber(l_j,1),formato)) //factura
										else
											dw_exportm.setitem(l_k,1,dw_trae.getitemstring(l_j,"clugar_fac")+string(dw_trae.getitemnumber(l_j,1),formato)) //factura
										end if
									end if
								else
									dw_exportm.setitem(l_k,1,string(p_nradica,formato))
								end if
							else
								dw_exportm.setitem(l_k,1,string(dw_trae.getitemnumber(l_j,1))) //factura
							end if
							if l_deta='0' then
								dw_exportm.setitem(l_k,2,dw_trae.getitemstring(l_j,'este_codigo')) //cod_ips
							else
								dw_exportm.setitem(l_k,2,dw_trae.getitemstring(l_j,'c_supersalud')) //cod_ips
							end if
							dw_exportm.setitem(l_k,'tdoc',dw_trae.getitemstring(l_j,3))//tdoc
							if isnull(dw_trae.getitemstring(l_j,23)) or dw_trae.getitemstring(l_j,23)='' then 											
								dw_exportm.setitem(l_k,'docu',dw_trae.getitemstring(l_j,4))//docu
							else
								dw_exportm.setitem(l_k,'docu', dw_trae.getitemstring(l_j,23)+dw_trae.getitemstring(l_j,4))//docu
							end if
							dw_exportm.setitem(l_k,'autoriza',left(dw_trae.getitemstring(l_j,5),15))//autoriza
							dw_exportm.setitem(l_k,'c_medica',dw_trae.getitemstring(l_j,"codigo_unif"))//cmedica
							dw_exportm.setitem(l_k,'nombre',left(dw_trae.getitemstring(l_j,8),30))//nombre med
							dw_exportm.setitem(l_k,'tipo_med',dw_trae.getitemstring(l_j,7))//tipo med
							dw_exportm.setitem(l_k,'forma_far',left(dw_trae.getitemstring(l_j,"formafarma"),20))//forma far
							dw_exportm.setitem(l_k,'concentracion',left(dw_trae.getitemstring(l_j,"concentracion"),20))//concentra
							dw_exportm.setitem(l_k,'u_medida',left(dw_trae.getitemstring(l_j,"unidadmed"),20))//umed
							dw_exportm.setitem(l_k,'cantidad',string(dw_trae.getitemnumber(l_j,12)))//cant
							dw_exportm.setitem(l_k,'vunit',string(dw_trae.getitemnumber(l_j,13),"#####0"))//vunit
							dw_exportm.setitem(l_k,'vtotal',string(dw_trae.getitemnumber(l_j,14),"#####0"))//vtotal
						
						case "Otros"
							l_k=dw_exporto.insertrow(0)
							if is_concatena_fac="1" then
								if dw_conts.getitemstring(1,'ctipo')='1' then  
									if  por_lugar<>'1' then
										 if not isnull(dw_trae.getitemstring(l_j,"prefijo")) then 
											dw_exporto.setitem(l_k,1,dw_trae.getitemstring(l_j,"prefijo")+string(dw_trae.getitemnumber(l_j,1),formato)) //factura
										 else
											dw_exporto.setitem(l_k,1,dw_trae.getitemstring(l_j,"clugar")+string(dw_trae.getitemnumber(l_j,1),formato)) //factura
										end if
									else
										 if not isnull(dw_trae.getitemstring(l_j,"prefijo")) then 
											dw_exporto.setitem(l_k,1,dw_trae.getitemstring(l_j,"prefijo")+string(dw_trae.getitemnumber(l_j,1),formato)) //factura
										else
											dw_exporto.setitem(l_k,1,dw_trae.getitemstring(l_j,"clugar")+string(dw_trae.getitemnumber(l_j,1),formato)) //factura
										end if
									end if
								else
									dw_exporto.setitem(l_k,1,string(p_nradica,formato))
								end if																	
							else
								dw_exporto.setitem(l_k,1,string(dw_trae.getitemnumber(l_j,1))) //factura
							end if
							if l_deta='0' then
								dw_exporto.setitem(l_k,2,dw_trae.getitemstring(l_j,'este_codigo')) //cod_ips
							else
								dw_exporto.setitem(l_k,2,dw_trae.getitemstring(l_j,'c_supersalud')) //cod_ips
							end if
							dw_exporto.setitem(l_k,3,dw_trae.getitemstring(l_j,3))//tdoc
							if isnull(dw_trae.getitemstring(l_j,20)) or dw_trae.getitemstring(l_j,20)='' then 								
								dw_exporto.setitem(l_k,4,dw_trae.getitemstring(l_j,4))//docu
							else
							dw_exporto.setitem(l_k,4, dw_trae.getitemstring(l_j,20)+dw_trae.getitemstring(l_j,4))//docu
							end if
							dw_exporto.setitem(l_k,5,left(dw_trae.getitemstring(l_j,5),15))//autoriza
							dw_exporto.setitem(l_k,6,dw_trae.getitemstring(l_j,6))//tipo_serv
							if p_cups then
								if isnull(dw_trae.getitemstring(l_j,'c_medica')) then
								dw_exporto.setitem(l_k,7,dw_trae.getitemstring(l_j,'cod_cups'))//codigo										
								else
									if p_at=1 then dw_exporto.setitem(l_k,7,dw_trae.getitemstring(l_j,'c_medica'))//c_medica									
								end if
							else
								if isnull(dw_trae.getitemstring(l_j,'c_medica')) then
									dw_exporto.setitem(l_k,7,dw_trae.getitemstring(l_j,7))//codigo
								else
									if p_at=1 then dw_exporto.setitem(l_k,7,dw_trae.getitemstring(l_j,'c_medica'))//c_medica
								end if
							end if
							dw_exporto.setitem(l_k,8,left(dw_trae.getitemstring(l_j,8),60))//nombre
							dw_exporto.setitem(l_k,9,string(dw_trae.getitemnumber(l_j,9)))//cantidad
							dw_exporto.setitem(l_k,10,string(dw_trae.getitemnumber(l_j,10),"#####0"))//vuni
							dw_exporto.setitem(l_k,11,string(dw_trae.getitemnumber(l_j,11),"#####0"))//vtotal

						case "Tx"							
							l_k=dw_exportt.insertrow(0)
							dw_exportt.setitem(l_k,1,dw_trae.getitemstring(l_j,"este_codigo"))
							If  por_lugar='0' then
								dw_exportt.setitem(l_k,2,left(dw_trae.getitemstring(l_j,"ips_nombre"),60))
								dw_exportt.setitem(l_k,3,dw_trae.getitemstring(l_j,"td_ips"))
								if cbx_10.checked then 
									dw_exportt.setitem(l_k,4,dw_trae.getitemstring(l_j,"doc_ips")+'-'+dw_trae.getitemstring(l_j,"ips_dv"))
								else
									dw_exportt.setitem(l_k,4,dw_trae.getitemstring(l_j,"doc_ips"))
								end if
							else
								dw_exportt.setitem(l_k,2,left(dw_trae.getitemstring(l_j,"ips_lugar"),60))	
								dw_exportt.setitem(l_k,3,dw_trae.getitemstring(l_j,"tipo_doc"))
								if tab_2.tp2_1.cbx_6.checked then 
									dw_exportt.setitem(l_k,4,dw_trae.getitemstring(l_j,"documento")+'-'+dw_trae.getitemstring(l_j,"l_dv"))
								else
									dw_exportt.setitem(l_k,4,dw_trae.getitemstring(l_j,"documento"))
								end if
							end if
				
							if is_concatena_fac="1" then
								 if dw_conts.getitemstring(1,'ctipo')='1' then  
									if por_lugar<>'1' then
										 if not isnull(dw_trae.getitemstring(l_j,"prefijo")) then 
											dw_exportt.setitem(l_k,5,dw_trae.getitemstring(l_j,"prefijo")+string(dw_trae.getitemnumber(l_j,"nfact"),formato)) //factura
										else
											dw_exportt.setitem(l_k,5,dw_trae.getitemstring(l_j,"clugar")+string(dw_trae.getitemnumber(l_j,"nfact"),formato)) //factura
										end if
									else
										 if not isnull(dw_trae.getitemstring(l_j,"prefijo")) then 
											dw_exportt.setitem(l_k,5,dw_trae.getitemstring(l_j,"prefijo")+string(dw_trae.getitemnumber(l_j,"nfact"),formato)) //factura
										else
											dw_exportt.setitem(l_k,5,dw_trae.getitemstring(l_j,"clugar")+string(dw_trae.getitemnumber(l_j,"nfact"),formato)) //factura
										end if
									end if				
								else
									dw_exportt.setitem(l_k,5,string(p_nradica,formato))
								end if				
							else
								dw_exportt.setitem(l_k,5,string(dw_trae.getitemnumber(l_j,"nfact"))) //factura
							end if
							dw_exportt.setitem(l_k,6,string(dw_trae.getitemdatetime(l_j,"fecha"),"dd/mm/yyyy"))
							dw_exportt.setitem(l_k,7,string(lfecha_ini,'dd/mm/yyyy'))
							dw_exportt.setitem(l_k,8,string(lfecha_fin,'dd/mm/yyyy'))
							dw_exportt.setitem(l_k,9,dw_trae.getitemstring(l_j,"codsuper"))
							dw_exportt.setitem(l_k,10,left(dw_trae.getitemstring(l_j,"desemp"),30))
							dw_exportt.setitem(l_k,11,dw_trae.getitemstring(l_j,"nro_contrato"))
							dw_exportt.setitem(l_k,12,dw_trae.getitemstring(l_j,"plan"))
							dw_exportt.setitem(l_k,13,dw_trae.getitemstring(l_j,"npoliza"))
							dw_exportt.setitem(l_k,14,string(dw_trae.getitemnumber(l_j,"vtcopago"),"#####0"))
							comis=dw_trae.getitemnumber(l_j,"vtcomision") 
							if isnull(comis) then comis=0
							dw_exportt.setitem(l_k,15,string(comis,"#####0"))
							dw_exportt.setitem(l_k,16,string(dw_trae.getitemnumber(l_j,"vtdescuentos"),"#####0"))		
							dw_exportt.setitem(l_k,17,string(dw_trae.getitemnumber(l_j,"vtemp"),"#####0"))			
						
						case "Usu"
							l_k=dw_exportus.insertrow(0)
							dw_exportus.setitem(l_k,'cod_ars',dw_trae.getitemstring(l_j,"codsuper"))
							dw_exportus.setitem(l_k,'tipo_doc',dw_trae.getitemstring(l_j,"tipodoc"))
							if isnull(dw_trae.getitemstring(l_j,'pais')) or dw_trae.getitemstring(l_j,'pais')='' then 	
								dw_exportus.setitem(l_k,'doc',dw_trae.getitemstring(l_j,"documento"))
							else
								dw_exportus.setitem(l_k,'doc',dw_trae.getitemstring(l_j,'pais')+dw_trae.getitemstring(l_j,"documento"))				
							end if
							dw_exportus.setitem(l_k,'tip_usu',dw_trae.getitemstring(l_j,"tu"))
							dw_exportus.setitem(l_k,'apellido1',dw_trae.getitemstring(l_j,"apellido1"))
							dw_exportus.setitem(l_k,'apellido2',dw_trae.getitemstring(l_j,"apellido2"))
							dw_exportus.setitem(l_k,'nombre1',dw_trae.getitemstring(l_j,"nombre1"))
							dw_exportus.setitem(l_k,'nombre2',dw_trae.getitemstring(l_j,"nombre2"))
							dw_exportus.setitem(l_k,'edad',string(dw_trae.getitemnumber(l_j,"edad")))
							dw_exportus.setitem(l_k,'umed_edad',dw_trae.getitemstring(l_j,"u_med"))
							dw_exportus.setitem(l_k,'sexo',dw_trae.getitemstring(l_j,"sexo"))
							dw_exportus.setitem(l_k,'departa',dw_trae.getitemstring(l_j,"cdepto"))
							dw_exportus.setitem(l_k,'municip',dw_trae.getitemstring(l_j,"cciudad"))
							dw_exportus.setitem(l_k,'zona_r',dw_trae.getitemstring(l_j,"zonar"))		
						end choose
						w_principal.SetMicroHelp ( 'Copiando '+l_cual+'(reg. '+string(l_j)+' de '+string(l_filas)+')' )
				next
			end if //dw_trae>0
		next
	end if //'escog)='1'
Next

if dw_exportc.rowcount()>0 then	
	realn[1]=lnom_c+'_TOTAL'
	lnom_c=sle_ant.text+'\'+lnom_c+'_TOTAL.txt'
	dw_exportc.saveas(lnom_c,CSV!,false)
end if
if dw_exportp.rowcount()>0 then	
	realn[2]=lnom_p+'_TOTAL'
	lnom_p=sle_ant.text+'\'+lnom_p+'_TOTAL.txt'
	dw_exportp.saveas(lnom_p,CSV!,false)
end if
if dw_exportrn.rowcount()>0 then	
	realn[3]=lnom_rn+'_TOTAL'
	lnom_rn=sle_ant.text+'\'+lnom_rn+'_TOTAL.txt'
	dw_exportrn.saveas(lnom_rn,CSV!,false)
end if
if dw_exporth.rowcount()>0 then	
	realn[4]=lnom_h+'_TOTAL'
	lnom_h=sle_ant.text+'\'+lnom_h+'_TOTAL.txt'
	dw_exporth.saveas(lnom_h,CSV!,false)
end if
if dw_exportm.rowcount()>0 then	
	realn[5]=lnom_m+'_TOTAL'	
	lnom_m=sle_ant.text+'\'+lnom_m+'_TOTAL.txt'
	dw_exportm.saveas(lnom_m,CSV!,false)
end if
if dw_exporto.rowcount()>0 then	
	realn[6]=lnom_o+'_TOTAL'	
	lnom_o=sle_ant.text+'\'+lnom_o+'_TOTAL.txt'
	dw_exporto.saveas(lnom_o,CSV!,false)
end if
if dw_exportu.rowcount()>0 then	
	realn[7]=lnom_u+'_TOTAL'
	lnom_u=sle_ant.text+'\'+lnom_u+'_TOTAL.txt'
	dw_exportu.saveas(lnom_u,CSV!,false)
end if
if dw_exportus.rowcount()>0 then	
	realn[8]=lnom_us+'_TOTAL'
	lnom_us=sle_ant.text+'\'+lnom_us+'_TOTAL.txt'
	dw_exportus.saveas(lnom_us,CSV!,false)
end if
if dw_exportt.rowcount()>0 then	
	realn[9]=lnom_t+'_TOTAL'	
	lnom_t=sle_ant.text+'\'+lnom_t+'_TOTAL.txt'
	dw_exportt.saveas(lnom_t,CSV!,false)
end if

dw_export.dataobject="dr_export_rips_ac"
dw_export.reset()
string fecha_rad

fecha_rad=string(today(),"dd/mm/yyyy")
w_principal.SetMicroHelp ( 'Copiando CT' )
if rb_7.checked then 
	select c_supersalud into :cips from ips where c_ips='01'; //ahi solo puede estar este código
else
	select c_supersalud into :cips from lugar where codlugar=:lclug; //ahi solo puede estar este código
end if
for l_j=1 to 9
	if n_reg[l_j]>0 then
		l_k=dw_export.insertrow(0)
		dw_export.setitem(l_k,1,cips)
		dw_export.setitem(l_k,2,fecha_rad)
		dw_export.setitem(l_k,3,realn[l_j])
		dw_export.setitem(l_k,4,string(n_reg[l_j]))
	end if
next
w_principal.SetMicroHelp ( 'Exportando CT' )
if dw_exportus.rowcount()>0 then	
	lnom_us=sle_ant.text+'\'+'CT'+'_TOTAL.txt'
	dw_export.saveas(lnom_us,CSV!,false)
end if
messagebox("Atención",'Archivos generados con éxito')
pb_6.triggerevent(clicked!)
end event

type sle_ant from singlelineedit within tp2_3
integer x = 4041
integer y = 28
integer width = 1015
integer height = 76
integer taborder = 100
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
boolean enabled = false
boolean displayonly = true
borderstyle borderstyle = stylelowered!
end type

event constructor;string ruta_rips

SELECT cadena into :ruta_rips
FROM parametros_gen
WHERE (((codigo_para)=1));
if sqlca.sqlnrows=0 then
	messagebox('Atencíon','No hay parametro 1')
	return 
end if
text=ruta_rips
end event

type cb_2 from commandbutton within tp2_3
integer x = 3950
integer y = 28
integer width = 82
integer height = 72
integer taborder = 100
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean enabled = false
string text = "..."
end type

event clicked;GetFolder ( 'Directorio a Colocar RIPS', sle_ant.text )

end event

type rb_13 from radiobutton within tp2_3
integer x = 3634
integer y = 32
integer width = 302
integer height = 64
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Emitir en:"
end type

event clicked;sle_ant.enabled=true
cb_2.enabled=true
end event

type cbx_12 from checkbox within tp2_3
integer x = 3177
integer y = 36
integer width = 425
integer height = 64
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Detalle x Sitio"
end type

type cbx_11 from checkbox within tp2_3
integer x = 2738
integer y = 36
integer width = 384
integer height = 72
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 67108864
string text = "AT/c_medica"
end type

type cbx_10 from checkbox within tp2_3
integer x = 2327
integer y = 36
integer width = 370
integer height = 64
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Nit Completo"
end type

type cbx_9 from checkbox within tp2_3
integer x = 1856
integer y = 36
integer width = 457
integer height = 64
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Capitación Valor"
end type

type cbx_8 from checkbox within tp2_3
integer x = 1207
integer y = 36
integer width = 622
integer height = 64
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Incluir facturas en Cero"
end type

type rb_12 from radiobutton within tp2_3
integer x = 649
integer y = 36
integer width = 233
integer height = 52
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "CUPS"
boolean checked = true
end type

type rb_11 from radiobutton within tp2_3
integer x = 265
integer y = 36
integer width = 361
integer height = 52
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Manual Tarif."
end type

type dw_radica_ant from datawindow within tp2_3
integer x = 14
integer y = 296
integer width = 5033
integer height = 1712
integer taborder = 80
string title = "none"
string dataobject = "dw_radica_rips_reemitir"
boolean vscrollbar = true
boolean hsplitscroll = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;settransobject(sqlca)
end event

event buttonclicked;long j
for j=1 to rowcount()
	if dwo.text='Escoger' then
		setrow(j)
		setitem(j,'escog','1')
	else
		setitem(j,'escog','0')
	end if
next
if dwo.name<>'b_1' then 
	if dwo.text='Escoger' then modify(string(dwo.name)+'.text="No Escog."') else 	modify(string(dwo.name)+'.text="Escoger"')
end if
end event

type dw_empre from datawindow within tp2_3
integer x = 873
integer y = 116
integer width = 1856
integer height = 152
integer taborder = 190
string title = "none"
string dataobject = "dw_empre_activas"
boolean border = false
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;settransobject(sqlca)
this.insertrow(1)
end event

event itemchanged;this.accepttext()

end event

type em_6 from editmask within tp2_3
integer x = 457
integer y = 180
integer width = 375
integer height = 80
integer taborder = 30
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 16777215
string text = "none"
borderstyle borderstyle = stylelowered!
maskdatatype maskdatatype = datemask!
string mask = "dd/mm/yyyy"
boolean autoskip = true
boolean spin = true
double increment = 1
string minmax = "2000-01-01~~2010-12-31"
end type

event constructor;if isdate("31/"+string(today(),"mm/yyyy")) then
	this.text="31/"+string(today(),"mm/yyyy")
else
	if isdate("30/"+string(today(),"mm/yyyy")) then
		this.text="30/"+string(today(),"mm/yyyy")
	else
		if isdate("29/"+string(today(),"mm/yyyy")) then
			this.text="29/"+string(today(),"mm/yyyy")
		else
			this.text="28/"+string(today(),"mm/yyyy")
		end if
	end if
end if

end event

type em_5 from editmask within tp2_3
integer x = 23
integer y = 180
integer width = 375
integer height = 80
integer taborder = 30
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 16777215
string text = "none"
borderstyle borderstyle = stylelowered!
maskdatatype maskdatatype = datemask!
string mask = "dd/mm/yyyy"
boolean autoskip = true
boolean spin = true
double increment = 1
string minmax = "2000-01-01~~2010-12-31"
end type

event constructor;this.text="01/"+string(today(),"mm/yyyy")
end event

type st_21 from statictext within tp2_3
integer x = 18
integer y = 120
integer width = 640
integer height = 52
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Rango de Fechas a Emitidos:"
boolean focusrectangle = false
end type

type gb_10 from groupbox within tp2_3
integer x = 9
integer width = 882
integer height = 116
integer taborder = 10
integer textsize = -7
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Small Fonts"
long textcolor = 33554432
long backcolor = 67108864
string text = "Codificación"
end type

type gb_11 from groupbox within tp2_3
integer x = 905
integer width = 2706
integer height = 116
integer taborder = 60
integer textsize = -7
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Small Fonts"
long textcolor = 33554432
long backcolor = 67108864
string text = "Opciones en Emisión"
end type

type tp2_2 from userobject within tab_2
integer x = 18
integer y = 112
integer width = 6880
integer height = 2412
long backcolor = 67108864
string text = "Por Lotes"
long tabtextcolor = 33554432
string picturename = "rips_4.ico"
long picturemaskcolor = 536870912
string powertiptext = "Generar RIPS por Grupos"
cbx_3 cbx_3
rb_6 rb_6
rb_5 rb_5
pb_lote pb_lote
st_18 st_18
st_17 st_17
sle_log sle_log
st_16 st_16
cb_1 cb_1
st_15 st_15
sle_sale sle_sale
rb_tod rb_tod
rb_activ rb_activ
st_14 st_14
dw_cont dw_cont
st_13 st_13
dw_emp dw_emp
st_12 st_12
em_4 em_4
em_3 em_3
gb_7 gb_7
gb_9 gb_9
end type

on tp2_2.create
this.cbx_3=create cbx_3
this.rb_6=create rb_6
this.rb_5=create rb_5
this.pb_lote=create pb_lote
this.st_18=create st_18
this.st_17=create st_17
this.sle_log=create sle_log
this.st_16=create st_16
this.cb_1=create cb_1
this.st_15=create st_15
this.sle_sale=create sle_sale
this.rb_tod=create rb_tod
this.rb_activ=create rb_activ
this.st_14=create st_14
this.dw_cont=create dw_cont
this.st_13=create st_13
this.dw_emp=create dw_emp
this.st_12=create st_12
this.em_4=create em_4
this.em_3=create em_3
this.gb_7=create gb_7
this.gb_9=create gb_9
this.Control[]={this.cbx_3,&
this.rb_6,&
this.rb_5,&
this.pb_lote,&
this.st_18,&
this.st_17,&
this.sle_log,&
this.st_16,&
this.cb_1,&
this.st_15,&
this.sle_sale,&
this.rb_tod,&
this.rb_activ,&
this.st_14,&
this.dw_cont,&
this.st_13,&
this.dw_emp,&
this.st_12,&
this.em_4,&
this.em_3,&
this.gb_7,&
this.gb_9}
end on

on tp2_2.destroy
destroy(this.cbx_3)
destroy(this.rb_6)
destroy(this.rb_5)
destroy(this.pb_lote)
destroy(this.st_18)
destroy(this.st_17)
destroy(this.sle_log)
destroy(this.st_16)
destroy(this.cb_1)
destroy(this.st_15)
destroy(this.sle_sale)
destroy(this.rb_tod)
destroy(this.rb_activ)
destroy(this.st_14)
destroy(this.dw_cont)
destroy(this.st_13)
destroy(this.dw_emp)
destroy(this.st_12)
destroy(this.em_4)
destroy(this.em_3)
destroy(this.gb_7)
destroy(this.gb_9)
end on

type cbx_3 from checkbox within tp2_2
integer x = 878
integer y = 264
integer width = 599
integer height = 64
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Incluir facturas en cero"
end type

type rb_6 from radiobutton within tp2_2
integer x = 910
integer y = 176
integer width = 343
integer height = 64
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "CUPS"
end type

type rb_5 from radiobutton within tp2_2
integer x = 910
integer y = 104
integer width = 430
integer height = 64
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Manual tarifario"
boolean checked = true
end type

type pb_lote from picturebutton within tp2_2
integer x = 2400
integer y = 1696
integer width = 146
integer height = 128
integer taborder = 100
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean originalsize = true
string picturename = "guardar2.gif"
alignment htextalign = left!
string powertiptext = "Generar RIPS de Empresas seleccionadas"
end type

event clicked;if not f_hasta() then 
	messagebox("Atención","Su periodo de validez ha caducado, comuníquese con GCI Ltda. para reactivarlo")
	return
end if
////////////// ojo para que no metan goles ^
if dw_emp.rowcount()=0 then return
is_decual='lote'
if dw_emp.getitemnumber(1,'t_emp')=0 then
	messagebox("Atencíon",'Elija contratos a radicar')
	return
end if
long j,k,arc,l,nrad,cuantas_rad=0,copia
string archivo,dir_sale,log_txt
i_numarc=-1
dir_sale=sle_sale.text+'\'
archivo =dir_sale+sle_log.text
i_numarc = fileopen(archivo,LineMode!,write!)
if i_numarc=-1 then
	messagebox("Atención",'No se puede crear el archivo de log')
	return
end if
filewrite(i_numarc,String(Today(), "d/mm/yyyy hh:mm:ss"))
setpointer(hourglass!)
string por_lug='1',por_ser='1'
if rb_7.checked then por_lug='0'
if rb_9.checked then por_ser='%'
for j=1 to dw_emp.rowcount()
	if dw_emp.getitemnumber(j,'todos')<>0 then
		log_txt='~r~nEmpresa: '+dw_emp.getitemstring(j,'desemp')+'-'+dw_emp.getitemstring(j,'codemp')
		if filewrite(i_numarc,log_txt)>0 then
			dw_emp.scrolltorow(j)
			k=1
			arc=1
			sle_sale.text=dir_sale+left(dw_emp.getitemstring(j,'desemp'),26)+'-'+dw_emp.getitemstring(j,'codemp')
			if CreateDirectory(sle_sale.text)=1 then
				log_txt='~tCrear Directorio: '+sle_sale.text+'(OK)'
				filewrite(i_numarc,log_txt)
				do while k<= dw_emp.getitemnumber(j,'nro_arc')
					if dw_cont.find('arch='+string(arc),1,dw_cont.rowcount())<>0 then
						if CreateDirectory(dir_sale+left(dw_emp.getitemstring(j,'desemp'),26)+'-'+dw_emp.getitemstring(j,'codemp')+'\'+string(arc))=1 then
							sle_sale.text=dir_sale+left(dw_emp.getitemstring(j,'desemp'),26)+'-'+dw_emp.getitemstring(j,'codemp')+'\'+string(arc)
							log_txt='~t~tArchivo '+string(arc)+' :Crear Directorio: '+sle_sale.text+'(OK)'
							filewrite(i_numarc,log_txt)
							dw_cont.setfilter('codemp="'+dw_emp.getitemstring(j,'codemp')+'" and arch='+string(arc))
							dw_cont.filter()
							log_txt='~t~t~t'+string(dw_cont.rowcount())+' Contrato(s)~r~n'
							for l=1 to dw_cont.rowcount()
								log_txt+='~t~t~t'+string(dw_cont.getitemstring(l,'descontrato'))+'~r~n'
							next
							filewrite(i_numarc,log_txt)
							dw_det_lote.reset()
							for copia=1 to dw_cont.rowcount()
								dw_det_lote.insertrow(copia)
								dw_det_lote.setitem(copia,'cemp',dw_cont.getitemstring(copia,'codemp'))
								dw_det_lote.setitem(copia,'ccontrato',dw_cont.getitemstring(copia,'codcontrato'))
								dw_det_lote.setitem(copia,'valor_capita',dw_cont.getitemnumber(copia,'v_capita'))
								dw_det_lote.setitem(copia,'ctipo',dw_cont.getitemstring(copia,'ctcontra'))
							next
							
							if cbx_3.checked then
								nrad=f_rips(true,0,'',dw_det_lote,'lote',rb_6.checked,-1,por_lug,'0','verifica')
							else
								nrad=f_rips(true,0,'',dw_det_lote,'lote',rb_6.checked,0,por_lug,'0','verifica')
							end if
							dw_cont.setfilter('codemp="'+dw_emp.getitemstring(j,'codemp')+'"')
							dw_cont.filter()
							choose case nrad
								case -10
									rollback;
									messagebox("Error de Base de Datos",'No se puede seguir generando los archivos.Revise el log para conocer los detalles')
									return
								case -1
									rollback;
								case 0 
								case else
									if nrad>0 then cuantas_rad++
							end choose
							tab_2.tp2_1.tab_1.tp_p.dw_radica.retrieve(clugar)
							k++
						else //error creando subdirectorio de archivo
							log_txt='Error creando SubDirectorio: '+sle_sale.text+'\'+string(arc)
							filewrite(i_numarc,log_txt)
						end if
					end if
					arc++
				loop
			else//error creando directorio
				log_txt='Error creando Directorio: '+sle_sale.text
				filewrite(i_numarc,log_txt)
			end if
		else //error escribiendo en el log
			log_txt='Error escribiendo en Log:'+log_txt
			filewrite(i_numarc,log_txt)
		end if
	end if
next
sle_sale.text=left(dir_sale, len(dir_sale) -1)
filewrite(i_numarc,'Radicaciones generadas: '+string(cuantas_rad)+'~r~n'+String(Today(), "d/mm/yyyy hh:mm:ss")+'~r~n')
fileclose(i_numarc)
messagebox("Proceso terminado",'Revise el archivo de log para ver Resultados')

end event

type st_18 from statictext within tp2_2
integer x = 448
integer y = 184
integer width = 343
integer height = 52
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Hasta"
boolean focusrectangle = false
end type

type st_17 from statictext within tp2_2
integer x = 18
integer y = 184
integer width = 343
integer height = 52
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Desde:"
boolean focusrectangle = false
end type

type sle_log from singlelineedit within tp2_2
integer x = 1929
integer y = 176
integer width = 1221
integer height = 88
integer taborder = 50
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 16777215
borderstyle borderstyle = stylelowered!
end type

event constructor;text='Log'+string(today(),'dd-mm-yyyy')+'.txt'
end event

type st_16 from statictext within tp2_2
integer x = 1568
integer y = 192
integer width = 352
integer height = 52
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Archivo de Log:"
boolean focusrectangle = false
end type

type cb_1 from commandbutton within tp2_2
integer x = 3442
integer y = 64
integer width = 91
integer height = 80
integer taborder = 40
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
string text = "..."
end type

event clicked;GetFolder ( 'Directorio a Colocar RIPS', sle_sale.text )
end event

type st_15 from statictext within tp2_2
integer x = 1481
integer y = 72
integer width = 443
integer height = 52
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Directorio de salida:"
boolean focusrectangle = false
end type

type sle_sale from singlelineedit within tp2_2
integer x = 1929
integer y = 64
integer width = 1499
integer height = 80
integer taborder = 30
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
boolean displayonly = true
borderstyle borderstyle = stylelowered!
end type

event constructor;string ruta_rips

SELECT cadena into :ruta_rips
FROM parametros_gen
WHERE (((codigo_para)=1));
if sqlca.sqlnrows=0 then
	messagebox('Atencíon','No hay parametro 1')
	return 
end if
text=ruta_rips
end event

type rb_tod from radiobutton within tp2_2
integer x = 3351
integer y = 1608
integer width = 558
integer height = 56
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Todos los Contratos"
end type

event clicked;dw_emp.setredraw(false)
dw_cont.setredraw(false)
dw_emp.reset()
dw_cont.reset()
dw_cont.retrieve('%')
dw_emp.retrieve('%')
dw_emp.setredraw(true)
dw_cont.setredraw(true)
dw_emp.modify("b_1.text='Todas'")
end event

type rb_activ from radiobutton within tp2_2
integer x = 2427
integer y = 1604
integer width = 658
integer height = 60
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Solo los Contratos Activos"
boolean checked = true
end type

event clicked;dw_emp.setredraw(false)
dw_cont.setredraw(false)
dw_emp.reset()
dw_cont.reset()
dw_cont.retrieve('1')
dw_emp.retrieve('1')
dw_emp.setredraw(true)
dw_cont.setredraw(true)
dw_emp.modify("b_1.text='Todas'")
end event

type st_14 from statictext within tp2_2
integer x = 2373
integer y = 284
integer width = 343
integer height = 52
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Contratos"
boolean focusrectangle = false
end type

type dw_cont from datawindow within tp2_2
event pe_cambio ( )
integer x = 2373
integer y = 340
integer width = 2377
integer height = 1152
integer taborder = 70
string title = "none"
string dataobject = "dw_cont_lote"
boolean hscrollbar = true
boolean vscrollbar = true
boolean hsplitscroll = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event pe_cambio();long cuantos,t_no
cuantos=getitemnumber(1,'total')
t_no=getitemnumber(1,'t_no')
if cuantos=rowcount() or t_no=0 then
	dw_emp.setitem(dw_emp.getrow(),'todos',1)
	dw_emp.setitem(dw_emp.getrow(),'nro_arc',cuantos)
	return
end if
if cuantos=0 then
	dw_emp.setitem(dw_emp.getrow(),'todos',0)
	dw_emp.setitem(dw_emp.getrow(),'nro_arc',0)
	return
end if
if cuantos<rowcount() then
	dw_emp.setitem(dw_emp.getrow(),'todos',2)
	dw_emp.setitem(dw_emp.getrow(),'nro_arc',cuantos)
end if
end event

event itemchanged;accepttext()
post event pe_cambio()
end event

event retrieveend;long j,nulo
setnull(nulo)
for j=1 to rowcount()
	setitem(j,'arch',nulo)
next
end event

type st_13 from statictext within tp2_2
integer x = 14
integer y = 284
integer width = 343
integer height = 52
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Empresas"
boolean focusrectangle = false
end type

type dw_emp from datawindow within tp2_2
event pe_cambio ( long actual )
integer x = 9
integer y = 340
integer width = 2277
integer height = 1464
integer taborder = 60
string title = "none"
string dataobject = "dw_emp_lote"
boolean hscrollbar = true
boolean vscrollbar = true
boolean hsplitscroll = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event pe_cambio(long actual);long j,cuantos,nulo
setnull(nulo)
cuantos=dw_cont.rowcount()
choose case getcolumnName()
	case 'todos'
		choose case actual
			case 0//ninguno pasarlo a todos
				for j=1 to cuantos
					dw_cont.setitem(j,'arch',j)
				next
				setitem(getrow(),'nro_arc',cuantos)
				setitem(getrow(),'todos',1)
				settext('1')
			case 1,2//todos,algunos pasarlo a ninguno
				for j=1 to cuantos
					dw_cont.setitem(j,'arch',nulo)
				next
				setitem(getrow(),'nro_arc',0)
				setitem(getrow(),'todos',0)
				settext('0')
		end choose
end choose
accepttext()
end event

event itemchanged;post event pe_cambio(getitemnumber(getrow(),'todos'))
end event

event constructor;dw_cont.settransobject(sqlca)
dw_cont.retrieve('1')
settransobject(sqlca)
retrieve('1')
end event

event rowfocuschanged;if getrow()<1 then return
dw_cont.setfilter('codemp="'+getitemstring(getrow(),'codemp')+'"')
dw_cont.filter()
end event

event buttonclicked;long j,k,l,actual
if Describe('b_1.text')='Todas' then
	modify("b_1.text='Ning.'")
	k=1
	l=0
else
	modify("b_1.text='Todas'")
	k=0
	l=1
end if
setredraw(false)
dw_cont.setredraw(false)
setcolumn('todos')
actual=getrow()
for j=1 to rowcount()
	setitem(j,'todos',k)
	scrolltorow(j)
	event pe_cambio(l)
next
scrolltorow(actual)
setredraw(true)
dw_cont.setredraw(true)
end event

type st_12 from statictext within tp2_2
integer x = 23
integer y = 40
integer width = 640
integer height = 52
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Rango de Fechas a Generar:"
boolean focusrectangle = false
end type

type em_4 from editmask within tp2_2
integer x = 443
integer y = 104
integer width = 375
integer height = 80
integer taborder = 20
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 16777215
string text = "none"
borderstyle borderstyle = stylelowered!
maskdatatype maskdatatype = datemask!
string mask = "dd/mm/yyyy"
boolean autoskip = true
boolean spin = true
double increment = 1
string minmax = "2000-01-01~~2010-12-31"
end type

event constructor;if isdate("31/"+string(today(),"mm/yyyy")) then
	this.text="31/"+string(today(),"mm/yyyy")
else
	if isdate("30/"+string(today(),"mm/yyyy")) then
		this.text="30/"+string(today(),"mm/yyyy")
	else
		if isdate("29/"+string(today(),"mm/yyyy")) then
			this.text="29/"+string(today(),"mm/yyyy")
		else
			this.text="28/"+string(today(),"mm/yyyy")
		end if
	end if
end if

end event

type em_3 from editmask within tp2_2
integer x = 9
integer y = 104
integer width = 375
integer height = 80
integer taborder = 10
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 16777215
string text = "none"
borderstyle borderstyle = stylelowered!
maskdatatype maskdatatype = datemask!
string mask = "dd/mm/yyyy"
boolean autoskip = true
boolean spin = true
double increment = 1
string minmax = "2000-01-01~~2010-12-31"
end type

event constructor;this.text="01/"+string(today(),"mm/yyyy")
end event

type gb_7 from groupbox within tp2_2
integer x = 2391
integer y = 1544
integer width = 1595
integer height = 132
integer taborder = 90
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Mostrar:"
end type

type gb_9 from groupbox within tp2_2
integer x = 878
integer y = 40
integer width = 599
integer height = 220
integer taborder = 21
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Codificación:"
end type

type rb_7 from radiobutton within w_rias
integer x = 1915
integer y = 52
integer width = 238
integer height = 60
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Todos"
boolean checked = true
end type

type rb_8 from radiobutton within w_rias
integer x = 2144
integer y = 52
integer width = 233
integer height = 60
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Solo el:"
end type

type dw_lug from datawindow within w_rias
integer x = 2373
integer y = 40
integer width = 1353
integer height = 76
integer taborder = 80
boolean bringtotop = true
string title = "none"
string dataobject = "dw_combo_lugar"
boolean border = false
boolean livescroll = true
end type

event constructor;settransobject(sqlca)
insertrow(1)
setitem(1,1,clugar)
end event

event itemchanged;rb_8.checked=true
end event


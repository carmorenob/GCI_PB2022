$PBExportHeader$w_teso_cartera.srw
forward
global type w_teso_cartera from w_center
end type
type gb_1 from groupbox within w_teso_cartera
end type
type st_1 from statictext within w_teso_cartera
end type
type dw_hist from datawindow within w_teso_cartera
end type
type dw_cab from datawindow within w_teso_cartera
end type
type pb_new from picturebutton within w_teso_cartera
end type
type pb_anula from picturebutton within w_teso_cartera
end type
type dw_tot from datawindow within w_teso_cartera
end type
type tab_1 from tab within w_teso_cartera
end type
type tp_det from userobject within tab_1
end type
type dw_det from datawindow within tp_det
end type
type tp_det from userobject within tab_1
dw_det dw_det
end type
type tab_fact from userobject within tab_1
end type
type dw_im from datawindow within tab_fact
end type
type pb_impo from picturebutton within tab_fact
end type
type dw_sale from datawindow within tab_fact
end type
type pb_4 from picturebutton within tab_fact
end type
type pb_ce from picturebutton within tab_fact
end type
type dw_fact from datawindow within tab_fact
end type
type tab_fact from userobject within tab_1
dw_im dw_im
pb_impo pb_impo
dw_sale dw_sale
pb_4 pb_4
pb_ce pb_ce
dw_fact dw_fact
end type
type tp_1a from userobject within tab_1
end type
type dw_anti_nota from datawindow within tp_1a
end type
type dw_anti_pagodir from datawindow within tp_1a
end type
type tp_1a from userobject within tab_1
dw_anti_nota dw_anti_nota
dw_anti_pagodir dw_anti_pagodir
end type
type tp_des from userobject within tab_1
end type
type pb_impnota from picturebutton within tp_des
end type
type pb_connota from picturebutton within tp_des
end type
type pb_diann from picturebutton within tp_des
end type
type pb_dist_desc from picturebutton within tp_des
end type
type mle_1 from multilineedit within tp_des
end type
type st_6 from statictext within tp_des
end type
type pb_deldes from picturebutton within tp_des
end type
type pb_newdes from picturebutton within tp_des
end type
type dw_des from datawindow within tp_des
end type
type tp_des from userobject within tab_1
pb_impnota pb_impnota
pb_connota pb_connota
pb_diann pb_diann
pb_dist_desc pb_dist_desc
mle_1 mle_1
st_6 st_6
pb_deldes pb_deldes
pb_newdes pb_newdes
dw_des dw_des
end type
type tp_pag from userobject within tab_1
end type
type tab_2 from tab within tp_pag
end type
type tp_0 from userobject within tab_2
end type
type pb_5 from picturebutton within tp_0
end type
type st_5 from statictext within tp_0
end type
type d1 from dropdownlistbox within tp_0
end type
type pb_new_pago from picturebutton within tp_0
end type
type dw_pend from datawindow within tp_0
end type
type tp_0 from userobject within tab_2
pb_5 pb_5
st_5 st_5
d1 d1
pb_new_pago pb_new_pago
dw_pend dw_pend
end type
type tp_1 from userobject within tab_2
end type
type pb_dist_pago from picturebutton within tp_1
end type
type st_4 from statictext within tp_1
end type
type st_3 from statictext within tp_1
end type
type pb_delpago from picturebutton within tp_1
end type
type dw_pagos from datawindow within tp_1
end type
type dw_det_pag_nota from datawindow within tp_1
end type
type dw_ing from datawindow within tp_1
end type
type dw_det_pag_manu from datawindow within tp_1
end type
type dw_det_abono from datawindow within tp_1
end type
type tp_1 from userobject within tab_2
pb_dist_pago pb_dist_pago
st_4 st_4
st_3 st_3
pb_delpago pb_delpago
dw_pagos dw_pagos
dw_det_pag_nota dw_det_pag_nota
dw_ing dw_ing
dw_det_pag_manu dw_det_pag_manu
dw_det_abono dw_det_abono
end type
type tp_2 from userobject within tab_2
end type
type pb_deldet from picturebutton within tp_2
end type
type pb_newdet from picturebutton within tp_2
end type
type dw_pago from datawindow within tp_2
end type
type tp_2 from userobject within tab_2
pb_deldet pb_deldet
pb_newdet pb_newdet
dw_pago dw_pago
end type
type tab_2 from tab within tp_pag
tp_0 tp_0
tp_1 tp_1
tp_2 tp_2
end type
type tp_pag from userobject within tab_1
tab_2 tab_2
end type
type tp_glo from userobject within tab_1
end type
type pb_6 from picturebutton within tp_glo
end type
type pb_3 from picturebutton within tp_glo
end type
type pb_2 from picturebutton within tp_glo
end type
type pb_1 from picturebutton within tp_glo
end type
type dw_glosas from datawindow within tp_glo
end type
type tp_glo from userobject within tab_1
pb_6 pb_6
pb_3 pb_3
pb_2 pb_2
pb_1 pb_1
dw_glosas dw_glosas
end type
type tab_1 from tab within w_teso_cartera
tp_det tp_det
tab_fact tab_fact
tp_1a tp_1a
tp_des tp_des
tp_pag tp_pag
tp_glo tp_glo
end type
type st_2 from statictext within w_teso_cartera
end type
type dw_amtz from datawindow within w_teso_cartera
end type
type dw_cierres from datawindow within w_teso_cartera
end type
type dw_lugar from datawindow within w_teso_cartera
end type
type em_desde from editmask within w_teso_cartera
end type
type em_hasta from editmask within w_teso_cartera
end type
type pb_consultar from picturebutton within w_teso_cartera
end type
type st_7 from statictext within w_teso_cartera
end type
type st_8 from statictext within w_teso_cartera
end type
type dw_pag from datawindow within w_teso_cartera
end type
type hpb_1 from hprogressbar within w_teso_cartera
end type
type dw_gloa from datawindow within w_teso_cartera
end type
type pb_7 from picturebutton within w_teso_cartera
end type
type dw_nc from datawindow within w_teso_cartera
end type
type dw_detc from datawindow within w_teso_cartera
end type
type dw_electronica from uo_datawindow within w_teso_cartera
end type
end forward

global type w_teso_cartera from w_center
string tag = "Realizó cambios a un Cobro, desea guardarlos ?"
integer width = 6903
integer height = 2528
string title = "Cartera - Movimientos"
boolean maxbox = false
boolean resizable = false
windowtype windowtype = popup!
windowstate windowstate = maximized!
string icon = "ribon_cartera.ico"
boolean center = false
gb_1 gb_1
st_1 st_1
dw_hist dw_hist
dw_cab dw_cab
pb_new pb_new
pb_anula pb_anula
dw_tot dw_tot
tab_1 tab_1
st_2 st_2
dw_amtz dw_amtz
dw_cierres dw_cierres
dw_lugar dw_lugar
em_desde em_desde
em_hasta em_hasta
pb_consultar pb_consultar
st_7 st_7
st_8 st_8
dw_pag dw_pag
hpb_1 hpb_1
dw_gloa dw_gloa
pb_7 pb_7
dw_nc dw_nc
dw_detc dw_detc
dw_electronica dw_electronica
end type
global w_teso_cartera w_teso_cartera

type variables

string i_emp,i_clug,i_coddoc='CXC',is_elec
long i_fila,i_ndoc
datawindowchild idw_tipocart,idw_des,idw_glo,idw_pago,idw_caja,idw_caja2,idw_cuenta, idw_lugar
boolean i_nuevo=false
int i_dec_teso
uo_report i_rep
end variables

forward prototypes
public subroutine insert_tot (datawindow dw)
public function integer grabar ()
public function decimal calc_totales ()
public function integer f_valida_fecha (datetime fech_valida)
end prototypes

public subroutine insert_tot (datawindow dw);long j,donde
string ctipo
for j=1 to dw.rowcount()
	if not isnull(dw.getitemstring(j,'estado')) then continue
	ctipo=dw.getitemstring(j,'cartipo')
	donde=dw_tot.find('cartipo="'+ctipo+'"',1,dw_tot.rowcount())
	if donde=0 then donde=dw_tot.insertrow(0)
	dw_tot.setitem(donde,'cartipo',ctipo)
	if dw.dataobject='dw_car_cpo_pagos' then
		dw_tot.setitem(donde,'valor',dw_tot.getitemnumber(donde,'valor') + dw.getitemnumber(j,'valor')+dw.getitemnumber(j,'a_amortizar'))
	else
		dw_tot.setitem(donde,'valor',dw_tot.getitemnumber(donde,'valor') + dw.getitemnumber(j,'valor'))
	end if
next

end subroutine

public function integer grabar ();long j,k
if dw_cab.accepttext()=-1 then return -1
if dw_tot.accepttext()=-1 then return -1
if tab_1.tp_det.dw_det.accepttext()=-1 then return -1
if tab_1.tp_des.dw_des.accepttext()=-1 then return -1
if tab_1.tp_glo.dw_glosas.accepttext()=-1 then return -1
tab_1.tp_pag.tab_2.tp_1.dw_det_pag_manu.visible=true
if tab_1.tp_pag.tab_2.tp_1.dw_pagos.accepttext()=-1 then return -1
if tab_1.tp_pag.tab_2.tp_2.dw_pago.accepttext()=-1 then return -1

if tab_1.tp_des.dw_des.find('valor=0 and isrownew()',1,tab_1.tp_des.dw_des.rowcount())<>0 then
	messagebox("Atención",'No pueden existir valores en cero en descuentos')
	return -1
end if
if tab_1.tp_des.dw_des.find('isnull(cartipo) and isrownew()',1,tab_1.tp_des.dw_des.rowcount())<>0 then
	messagebox("Atención",'No pueden existir tipos de cartera nulos en Descuentos')
	return -1
end if
if tab_1.tp_glo.dw_glosas.find('valor=0 and isrownew()',1,tab_1.tp_glo.dw_glosas.rowcount())<>0 then
	messagebox("Atención",'No pueden existir valores en cero en Glosas')
	return -1
end if
if tab_1.tp_glo.dw_glosas.find('isnull(cartipo) and isrownew()',1,tab_1.tp_glo.dw_glosas.rowcount())<>0 then
	messagebox("Atención",'No pueden existir tipos de cartera nulos en Glosas')
	return -1
end if
//if  tab_1.tp_glo.dw_glosas.rowcount()>0 then
//	if tab_1.tp_glo.dw_glosas.find(" valor ="+string(tab_1.tp_glo.dw_glosas.getitemnumber(tab_1.tp_glo.dw_glosas.getrow(),'valor')) +" and isnull( num_glosa ) and getrow()<>currentRow() and  isnull(estado) and codtipo='3' and operacion=0",1,tab_1.tp_glo.dw_glosas.rowcount())<>0 then
//		messagebox("Atención",'Exister Objección por el mismo valor sin Responder')
//		return -1
//	end if
//end if

if tab_1.tp_pag.tab_2.tp_1.dw_pagos.find('valor=0 and isrownew()',1,tab_1.tp_pag.tab_2.tp_1.dw_pagos.rowcount())<>0 then
	messagebox("Atención",'No pueden existir valores en cero en Pagos')
	return -1
end if
if tab_1.tp_pag.tab_2.tp_1.dw_pagos.find('isnull(cartipo) and isrownew()',1,tab_1.tp_pag.tab_2.tp_1.dw_pagos.rowcount())<>0 then
	messagebox("Atención",'No pueden existir tipos de cartera nulos en Pagos')
	return -1
end if
if i_nuevo then
	if f_valida_fecha(dw_cab.getitemdatetime(dw_cab.getrow(),'fecha'))=-1  then return -1
	if (dw_cab.getitemstring(1,'cxp')='2' or dw_cab.getitemstring(1,'cxp')='3' )and dw_cab.getitemnumber(1,'vtcancelar')=0 then
		messagebox("Atención",'El valor a cancelar no puede ser cero')
		return -1
	end if
	
	i_ndoc=f_trae_ndoc(i_coddoc,i_clug,'Cuentas de Cobro')
	if i_ndoc=-1 then return -1
	if dw_cab.getitemstring(1,'cxp')='3' or dw_cab.getitemstring(1,'cxp')='2' then //machete pa los saldos iniciales
		dw_cab.setitem(1,'vtcobro',dw_cab.getitemnumber(1,'vtcancelar'))
	end if
	dw_cab.setitem(1,'num_cobro',i_ndoc)
	dw_cab.setitem(1,'clugar',i_clug)
	dw_cab.setitem(1,'coddoc',i_coddoc)
	long nrad
	string clug_rad,tipo_rad

	for j=1 to tab_1.tp_det.dw_det.rowcount()
		tab_1.tp_det.dw_det.setitem(j,'num_cobro',i_ndoc)
		tab_1.tp_det.dw_det.setitem(j,'item',j)
		tab_1.tp_det.dw_det.setitem(j,'clugar',i_clug)
		tab_1.tp_det.dw_det.setitem(j,'coddoc',i_coddoc)
		if dw_cab.getitemstring(1,'cxp')='0' then
			nrad=tab_1.tp_det.dw_det.getitemnumber(j,'num_radicacion')
			clug_rad=tab_1.tp_det.dw_det.getitemstring(j,'clugar_rad')
			tipo_rad=tab_1.tp_det.dw_det.getitemstring(j,'tipo_rad')
			update ripsradica set en_destino='1' where num_radicacion=:nrad and clugar=:clug_rad and tipo=:tipo_rad;
			if sqlca.sqlcode=-1 then
				messagebox("Error actualizando estado de ripsradica",sqlca.sqlerrtext)
				return -1
			end if
		end if
	next
	for j=1 to tab_1.tp_des.dw_des.rowcount()
		tab_1.tp_des.dw_des.setitem(j,'num_cobro',i_ndoc)
	next
	for j=1 to tab_1.tp_glo.dw_glosas.rowcount()
		tab_1.tp_glo.dw_glosas.setitem(j,'num_cobro',i_ndoc)
	next
	if dw_cab.getitemstring(1,'cxp')='3' then
		long npag
		string clug_pag
		npag=dw_cab.getitemnumber(1,'npagare')
		clug_pag=dw_cab.getitemstring(1,'clug_pag')
		update tesopagarecab set en_destino='1'
		where npagare=:npag and clugar=:clug_pag;
		if sqlca.sqlcode=-1 then
			messagebox("Error actualizando en_destino de tesopagarecab",sqlca.sqlerrtext)
			return -1
		end if
	elseif dw_cab.getitemstring(1,'cxp')='1' then //anticipos
		string cban,tcuent,ncuent,ccaj,clugpag,cdocpag
		long npago,it
		dec va
		for j=1 to tab_1.tp_1a.dw_anti_pagodir.rowcount()
			tab_1.tp_1a.dw_anti_pagodir.setitem(j,'num_cobro',i_ndoc)
			tab_1.tp_1a.dw_anti_pagodir.setitem(j,'item_pag',1)
			tab_1.tp_1a.dw_anti_pagodir.setitem(j,'clugar_pag',i_clug)
			tab_1.tp_1a.dw_anti_pagodir.setitem(j,'coddoc_pag',i_coddoc)
			ccaj=tab_1.tp_1a.dw_anti_pagodir.getitemstring(j,'codcaja')
			clugpag=tab_1.tp_1a.dw_anti_pagodir.getitemstring(j,'clugar')
			cdocpag=tab_1.tp_1a.dw_anti_pagodir.getitemstring(j,'coddoc')
			npago=tab_1.tp_1a.dw_anti_pagodir.getitemnumber(j,'ningreso')
			va=tab_1.tp_1a.dw_anti_pagodir.getitemnumber(j,'valor')
			update tesocajaingreso set valor_cartera=valor_cartera +:va where 
			codcaja =:ccaj and clugar =:clugpag and coddoc =:cdocpag and ningreso=:npago;
			if sqlca.sqlcode=-1 then
				messagebox("Error actualizando tesocajaingreso",sqlca.sqlerrtext)
				return -1
			end if
		next
		for j=1 to tab_1.tp_1a.dw_anti_nota.rowcount()
			tab_1.tp_1a.dw_anti_nota.setitem(j,'num_cobro',i_ndoc)
			tab_1.tp_1a.dw_anti_nota.setitem(j,'item_pag',1)
			tab_1.tp_1a.dw_anti_nota.setitem(j,'clugar_pag',i_clug)
			tab_1.tp_1a.dw_anti_nota.setitem(j,'coddoc_pag',i_coddoc)
			cban=tab_1.tp_1a.dw_anti_nota.getitemstring(j,'codbanco')
			tcuent=tab_1.tp_1a.dw_anti_nota.getitemstring(j,'tipo_cuenta')
			ncuent=tab_1.tp_1a.dw_anti_nota.getitemstring(j,'numcuenta')
			it=tab_1.tp_1a.dw_anti_nota.getitemnumber(j,'item')
			va=tab_1.tp_1a.dw_anti_nota.getitemnumber(j,'valor')
			update tesocuentasmovi set valor_cartera=valor_cartera + :va where
			codbanco=:cban and tipo_cuenta=:tcuent and numcuenta =:ncuent and item=:it;
			if sqlca.sqlcode=-1 then
				messagebox("Error actualizando tesocuentasmovi",sqlca.sqlerrtext)
				return -1
			end if
		next
	end if
end if //fin nuevo

///Para notas a Cartera DIAN
long ning
dec valor
string concep

tab_1.tp_des.dw_des.setredraw(false)
tab_1.tp_des.dw_des.setfilter('isrownew()')
tab_1.tp_des.dw_des.filter()
for j=1 to tab_1.tp_des.dw_des.rowcount()
	if tab_1.tp_des.dw_des.getitemstring(j,'dian')='1' then
			int li_fila,li_nnota, li_rec
			decimal ln_valorn,ln_valorc,ln_valora
			long ldb_nrad
			string ls_tprad,ls_lgrad
		
			ldb_nrad = tab_1.tp_det.dw_det.getItemNumber(tab_1.tp_det.dw_det.getrow(),'num_radicacion')
			ls_lgrad= tab_1.tp_det.dw_det.getItemString(tab_1.tp_det.dw_det.getrow(),'clugar_rad')
			ls_tprad= tab_1.tp_det.dw_det.getItemString(tab_1.tp_det.dw_det.getrow(),'tipo_rad')
			ln_valorc=tab_1.tp_det.dw_det.getItemnumber(tab_1.tp_det.dw_det.getrow(),'valor_capita')
			ln_valora= tab_1.tp_det.dw_det.getItemnumber(tab_1.tp_det.dw_det.getrow(),'valor_evento')
			ln_valorn=tab_1.tp_des.dw_des.getitemnumber(j,'valor')

			
			dw_nc.retrieve(ldb_nrad,ls_lgrad,ls_tprad)
			dw_detc.retrieve(ldb_nrad,ls_lgrad,ls_tprad)
			
			li_fila=dw_nc.insertrow(0)
			dw_nc.scrolltorow(li_fila)
			dw_nc.setfocus()
			
			li_nnota=dw_nc.getitemnumber(1,'nnotas')
			if isnull(li_nnota) then li_nnota=0
			li_nnota++
			dw_nc.setitem(li_fila,'num_radicacion', ldb_nrad)
			dw_nc.setitem(li_fila,'clugar', ls_lgrad)
			dw_nc.setitem(li_fila,'tipo', ls_tprad)		
			dw_nc.setitem(li_fila,'fecha_nota', tab_1.tp_des.dw_des.getitemdatetime(j,'fecha'))
			dw_nc.setitem(li_fila,'cod_usuario',usuario)
			dw_nc.setitem(li_fila,'nro_nota',li_nnota)
			dw_nc.setitem(li_fila,'valor_nota',ln_valorn)
			dw_nc.setitem(li_fila,'valor_capita', ln_valorc)
			dw_nc.setitem(li_fila,'valor_evento', ln_valora)
			if tab_1.tp_des.dw_des.getitemnumber(j,'operacion')= -1 then
				dw_nc.setitem(li_fila,'tipo_nota', 'C')
			end if
			if tab_1.tp_des.dw_des.getitemnumber(j,'operacion')= 1 then
				dw_nc.setitem(li_fila,'tipo_nota', 'D')
			end if			
			setnull(ln_valorc)
			setnull(ln_valora)
			tab_1.tp_des.dw_des.setitem(j,'nradica_nota', ldb_nrad)
			tab_1.tp_des.dw_des.setitem(j,'clugar_nota', ls_lgrad)
			tab_1.tp_des.dw_des.setitem(j,'trad_nota', ls_tprad)
			tab_1.tp_des.dw_des.setitem(j,'tipo_nota',dw_nc.getitemstring(li_fila,'tipo_nota'))
			tab_1.tp_des.dw_des.setitem(j,'nro_nota',li_nnota)

			for li_rec=1 to dw_detc.rowcount()
				ln_valorc=ln_valorn*dw_detc.getitemnumber(li_rec,'porcen')
				if tab_1.tp_des.dw_des.getitemnumber(j,'operacion')= -1 then
					ln_valora=dw_detc.getitemnumber(li_rec,'valor_ncr')
					dw_detc.setitem(li_rec,'valor_ncr',ln_valora+ln_valorc)
				else
					ln_valora=dw_detc.getitemnumber(li_rec,'valor_ndb')			
					dw_detc.setitem(li_rec,'valor_ndb',ln_valora+ln_valorc)
				end if
			next	
	end if
next
tab_1.tp_des.dw_des.setfilter('')
tab_1.tp_des.dw_des.filter()
tab_1.tp_des.dw_des.setredraw(true)
///Fin Notas cartera DIAN

tab_1.tp_pag.tab_2.tp_1.dw_pagos.setredraw(false)
tab_1.tp_pag.tab_2.tp_1.dw_pagos.setfilter('isrownew()')
tab_1.tp_pag.tab_2.tp_1.dw_pagos.filter()
for j=1 to tab_1.tp_pag.tab_2.tp_1.dw_pagos.rowcount()
	valor=round(tab_1.tp_pag.tab_2.tp_1.dw_pagos.getitemdecimal(j,'valor'),i_dec_gral_car)
	concep=tab_1.tp_pag.tab_2.tp_1.dw_pagos.getitemstring(j,'cartipo')
	tab_1.tp_pag.tab_2.tp_1.dw_pagos.setitem(j,'num_cobro',i_ndoc)
	tab_1.tp_pag.tab_2.tp_1.dw_pagos.scrolltorow(j)

	for k=1 to tab_1.tp_pag.tab_2.tp_2.dw_pago.rowcount()
		tab_1.tp_pag.tab_2.tp_2.dw_pago.setitem(k,'num_cobro',i_ndoc)
	next
	//los 4 del deta
	for k=1 to tab_1.tp_pag.tab_2.tp_1.dw_ing.rowcount()
		tab_1.tp_pag.tab_2.tp_1.dw_ing.setitem(k,'cartipo',concep)
	next
	for k=1 to tab_1.tp_pag.tab_2.tp_1.dw_det_abono.rowcount()
		tab_1.tp_pag.tab_2.tp_1.dw_det_abono.setitem(k,'cartipo',concep)
	next
	for k=1 to tab_1.tp_pag.tab_2.tp_1.dw_det_pag_manu.rowcount()
		tab_1.tp_pag.tab_2.tp_1.dw_det_pag_manu.setitem(k,'cartipo',concep)
	next
	for k=1 to tab_1.tp_pag.tab_2.tp_1.dw_det_pag_nota.rowcount()
		tab_1.tp_pag.tab_2.tp_1.dw_det_pag_nota.setitem(k,'cartipo',concep)
	next
	//fin los 4 del deta
	if tab_1.tp_pag.tab_2.tp_1.dw_pagos.getitemstring(j,'origen_pag')<>'M' then //en el manual no debe hacerlo
		for k=1 to tab_1.tp_pag.tab_2.tp_0.dw_pend.rowcount()
			if dw_cab.getitemstring(1,'cxp')='3' then
				if tab_1.tp_pag.tab_2.tp_0.dw_pend.getitemnumber(k,'esco')=1 then
					tab_1.tp_pag.tab_2.tp_0.dw_pend.setitem(k,'clug_cob',i_clug)
					tab_1.tp_pag.tab_2.tp_0.dw_pend.setitem(k,'cdoc_cob',i_coddoc)
					tab_1.tp_pag.tab_2.tp_0.dw_pend.setitem(k,'num_cobro',dw_cab.getitemnumber(1,'num_cobro'))
					tab_1.tp_pag.tab_2.tp_0.dw_pend.setitem(k,'cartipo',tab_1.tp_pag.tab_2.tp_1.dw_pagos.getitemstring(j,'cartipo'))
					tab_1.tp_pag.tab_2.tp_0.dw_pend.setitem(k,'item_cob',tab_1.tp_pag.tab_2.tp_1.dw_pagos.getitemnumber(j,'item'))
				end if
			else
				if tab_1.tp_pag.tab_2.tp_0.dw_pend.getitemnumber(k,'registrar')>0 then
					tab_1.tp_pag.tab_2.tp_0.dw_pend.setitem(k,'valor_cartera',tab_1.tp_pag.tab_2.tp_0.dw_pend.getitemnumber(k,'cart_ori')+tab_1.tp_pag.tab_2.tp_0.dw_pend.getitemnumber(k,'registrar'))
				end if
			end if
		next
	end if
next

string clug_anti,cdoc_anti
long nanti
dec val
for j=1 to dw_amtz.rowcount()
	if dw_amtz.getitemstatus(j,0,primary!)=notmodified! or dw_amtz.getitemstatus(j,0,primary!)=datamodified!  then continue
	clug_anti=dw_amtz.getitemstring(j,'clug_anti')
	cdoc_anti=dw_amtz.getitemstring(j,'coddoc_anti')
	nanti=dw_amtz.getitemnumber(j,'num_cobro_anti')
	val=round(dw_amtz.getitemnumber(j,'valor'),i_dec_gral_car)
	update car_cobro_cab set v_amortizado=v_amortizado + :val where
	clugar=:clug_anti and coddoc=:cdoc_anti and num_cobro=:nanti;
	if sqlca.sqlcode=-1 then
		messagebox("Error actualizando v_amortizado en Car_cobro_cab",sqlca.sqlerrtext)
		return -1
	end if
next
tab_1.tp_pag.tab_2.tp_1.dw_pagos.setfilter('')
tab_1.tp_pag.tab_2.tp_1.dw_pagos.filter()
tab_1.tp_pag.tab_2.tp_1.dw_pagos.setredraw(true)
for j=1 to dw_tot.rowcount()
	dw_tot.setitem(j,'num_cobro',i_ndoc)
	dw_tot.setitem(j,'coddoc',i_coddoc)
	dw_tot.setitem(j,'clugar',i_clug)
next
if dw_cab.update(true,false)=-1 then return -1
if dw_tot.update(true,false)=-1 then return -1
if tab_1.tp_det.dw_det.update(true,false)=-1 then return -1
if dw_nc.update(true,false)=-1 then return -1
if tab_1.tp_des.dw_des.update(true,false)=-1 then return -1
if dw_detc.update(true,false)=-1 then return -1
if tab_1.tp_glo.dw_glosas.update(true,false)=-1 then return -1
if tab_1.tp_pag.tab_2.tp_1.dw_pagos.update(true,false)=-1 then return -1
if tab_1.tp_pag.tab_2.tp_2.dw_pago.update(true,false)=-1 then return -1
if tab_1.tp_pag.tab_2.tp_1.dw_ing.update(true,false)=-1 then return -1
if tab_1.tp_pag.tab_2.tp_1.dw_det_abono.update(true,false)=-1 then return -1
//if tab_1.tp_pag.tab_2.tp_1.dw_det_pag_manu.update(true,false)=-1 then return -1
if tab_1.tp_pag.tab_2.tp_1.dw_det_pag_nota.update(true,false)=-1 then return -1
if tab_1.tp_pag.tab_2.tp_0.dw_pend.dataobject<>'dw_pago_cart_manual' then 
	if tab_1.tp_pag.tab_2.tp_0.dw_pend.update(true,false)=-1 then return -1
end if
if dw_amtz.update(true,false)=-1 then return -1
if tab_1.tp_1a.dw_anti_nota.update(true,false)=-1 then return -1
if tab_1.tp_1a.dw_anti_pagodir.update(true,false)=-1 then return -1
commit;
tab_1.enabled=true
cambio=false
dw_cab.resetupdate()
dw_tot.resetupdate()
tab_1.tp_det.dw_det.resetupdate()
tab_1.tp_des.dw_des.resetupdate()
dw_nc.resetupdate()
dw_detc.resetupdate()
for j = 1 to tab_1.tp_glo.dw_glosas.RowCount()
	tab_1.tp_glo.dw_glosas.SetItem(j,'nuevo',0)
next
tab_1.tp_glo.dw_glosas.resetupdate()
tab_1.tp_pag.tab_2.tp_1.dw_pagos.resetupdate()
tab_1.tp_pag.tab_2.tp_2.dw_pago.resetupdate()
tab_1.tp_pag.tab_2.tp_1.dw_ing.resetupdate()
tab_1.tp_pag.tab_2.tp_1.dw_det_abono.resetupdate()
tab_1.tp_pag.tab_2.tp_1.dw_det_pag_manu.resetupdate()
tab_1.tp_pag.tab_2.tp_1.dw_det_pag_nota.resetupdate()
tab_1.tp_pag.tab_2.tp_0.dw_pend.resetupdate()
tab_1.tp_1a.dw_anti_nota.resetupdate()
tab_1.tp_1a.dw_anti_pagodir.resetupdate()

dw_amtz.resetupdate()
if dw_hist.rowcount()>0 then
	if dw_hist.getitemstring(i_fila,'cxp')='3' then
		tab_1.tp_pag.tab_2.tp_0.dw_pend.retrieve(dw_hist.getitemnumber(i_fila,'npagare'),dw_hist.getitemstring(i_fila,'clug_pag'))
	else
		tab_1.tp_pag.tab_2.tp_0.d1.triggerevent(selectionchanged!)
	end if
end if
if i_nuevo then
	i_nuevo=false
	dw_lugar.triggerevent(itemchanged!)
end if
tab_1.tp_pag.tab_2.tp_0.pb_new_pago.enabled=true
tab_1.tp_des.pb_newdes.enabled=true
tab_1.tp_pag.tab_2.tp_1.dw_pagos.event rowfocuschanged(tab_1.tp_pag.tab_2.tp_1.dw_pagos.getrow())
tab_1.tp_des.dw_des.event rowfocuschanged(tab_1.tp_des.dw_des.getrow())
tab_1.setredraw(true)
return 1

end function

public function decimal calc_totales ();dw_tot.setredraw(false)
do while dw_tot.rowcount()>0
	dw_tot.deleterow(0)
loop
long j,donde,operacion
string ctipo,codtipo
tab_1.tp_det.dw_det.accepttext()
tab_1.tp_des.dw_des.accepttext()
tab_1.tp_glo.dw_glosas.accepttext()
tab_1.tp_pag.tab_2.tp_1.dw_pagos.accepttext()
insert_tot(tab_1.tp_det.dw_det)
insert_tot(tab_1.tp_des.dw_des)
insert_tot(tab_1.tp_glo.dw_glosas)
insert_tot(tab_1.tp_pag.tab_2.tp_1.dw_pagos)
dw_tot.setredraw(true)
dw_cab.setitem(1,'vtanticipo',0)
dw_cab.setitem(1,'vtcobro',0)
dw_cab.setitem(1,'vtcancelar',0)
dw_cab.setitem(1,'vtcancelado',0)
dw_cab.setredraw(false)
for j=1 to dw_tot.rowcount()
	ctipo=dw_tot.getitemstring(j,'cartipo')
	donde=idw_tipocart.find('cartipo="'+ctipo+'"',1,idw_tipocart.rowcount())
	if donde=0 then
		messagebox('Atención','No ha creado el tipo '+ctipo+' en la tabla car_tipo')
		dw_cab.setredraw(true)
		return -1
	end if
	operacion=idw_tipocart.getitemnumber(donde,'operacion')
	codtipo=idw_tipocart.getitemstring(donde,'codtipo')
	choose case codtipo
		case 'A'
			dw_cab.setitem(1,'vtanticipo',dw_cab.getitemnumber(1,'vtanticipo')+ operacion*dw_tot.getitemnumber(j,'valor'))			
			dw_cab.setitem(1,'vtcancelar',dw_cab.getitemnumber(1,'vtcancelar')+ operacion*dw_tot.getitemnumber(j,'valor'))
			//dw_cab.setitem(1,'vtcancelado',dw_cab.getitemnumber(1,'vtcancelado')+ operacion*dw_tot.getitemnumber(j,'valor'))
		case '0','P'
			dw_cab.setitem(1,'vtcobro',dw_cab.getitemnumber(1,'vtcobro')+ operacion*dw_tot.getitemnumber(j,'valor'))						
			dw_cab.setitem(1,'vtcancelar',dw_cab.getitemnumber(1,'vtcancelar')+ operacion*dw_tot.getitemnumber(j,'valor'))
		case '1'//pagos
			dw_cab.setitem(1,'vtcancelado',dw_cab.getitemnumber(1,'vtcancelado')+ operacion*dw_tot.getitemnumber(j,'valor'))						
		case '2','3','J'//descuentos,glosas,ajustes
			dw_cab.setitem(1,'vtcancelar',dw_cab.getitemnumber(1,'vtcancelar')+ operacion*dw_tot.getitemnumber(j,'valor'))			
	end choose
next
dw_cab.setredraw(true)
return(dw_cab.getitemnumber(1,'pendiente'))
end function

public function integer f_valida_fecha (datetime fech_valida);int l_mes, l_anyo,l_cerrado,fila_mes

l_anyo=year(date(fech_valida))
l_mes=month(date(fech_valida))

fila_mes=dw_cierres.find("ano="+string(l_anyo)+" and mes="+string(l_mes),1,dw_cierres.rowcount())
if fila_mes=0 then
	messagebox("Atención","Este mes en cartera no ha sido creado, debe crearlo primero para poder continuar")
	return -1
else
	if dw_cierres.getitemstring(fila_mes,'estado')='1' then 
		messagebox("Atención","Este mes en cartera esta cerrado")
		return -1
	end if
end if
return 0



end function

on w_teso_cartera.create
int iCurrent
call super::create
this.gb_1=create gb_1
this.st_1=create st_1
this.dw_hist=create dw_hist
this.dw_cab=create dw_cab
this.pb_new=create pb_new
this.pb_anula=create pb_anula
this.dw_tot=create dw_tot
this.tab_1=create tab_1
this.st_2=create st_2
this.dw_amtz=create dw_amtz
this.dw_cierres=create dw_cierres
this.dw_lugar=create dw_lugar
this.em_desde=create em_desde
this.em_hasta=create em_hasta
this.pb_consultar=create pb_consultar
this.st_7=create st_7
this.st_8=create st_8
this.dw_pag=create dw_pag
this.hpb_1=create hpb_1
this.dw_gloa=create dw_gloa
this.pb_7=create pb_7
this.dw_nc=create dw_nc
this.dw_detc=create dw_detc
this.dw_electronica=create dw_electronica
iCurrent=UpperBound(this.Control)
this.Control[iCurrent+1]=this.gb_1
this.Control[iCurrent+2]=this.st_1
this.Control[iCurrent+3]=this.dw_hist
this.Control[iCurrent+4]=this.dw_cab
this.Control[iCurrent+5]=this.pb_new
this.Control[iCurrent+6]=this.pb_anula
this.Control[iCurrent+7]=this.dw_tot
this.Control[iCurrent+8]=this.tab_1
this.Control[iCurrent+9]=this.st_2
this.Control[iCurrent+10]=this.dw_amtz
this.Control[iCurrent+11]=this.dw_cierres
this.Control[iCurrent+12]=this.dw_lugar
this.Control[iCurrent+13]=this.em_desde
this.Control[iCurrent+14]=this.em_hasta
this.Control[iCurrent+15]=this.pb_consultar
this.Control[iCurrent+16]=this.st_7
this.Control[iCurrent+17]=this.st_8
this.Control[iCurrent+18]=this.dw_pag
this.Control[iCurrent+19]=this.hpb_1
this.Control[iCurrent+20]=this.dw_gloa
this.Control[iCurrent+21]=this.pb_7
this.Control[iCurrent+22]=this.dw_nc
this.Control[iCurrent+23]=this.dw_detc
this.Control[iCurrent+24]=this.dw_electronica
end on

on w_teso_cartera.destroy
call super::destroy
destroy(this.gb_1)
destroy(this.st_1)
destroy(this.dw_hist)
destroy(this.dw_cab)
destroy(this.pb_new)
destroy(this.pb_anula)
destroy(this.dw_tot)
destroy(this.tab_1)
destroy(this.st_2)
destroy(this.dw_amtz)
destroy(this.dw_cierres)
destroy(this.dw_lugar)
destroy(this.em_desde)
destroy(this.em_hasta)
destroy(this.pb_consultar)
destroy(this.st_7)
destroy(this.st_8)
destroy(this.dw_pag)
destroy(this.hpb_1)
destroy(this.dw_gloa)
destroy(this.pb_7)
destroy(this.dw_nc)
destroy(this.dw_detc)
destroy(this.dw_electronica)
end on

event timer;call super::timer;if i_fila=dw_hist.getrow() then return
timer(0)
i_fila=dw_hist.getrow()   
dw_cab.reset()
dw_tot.reset()
if i_fila=0 then return
i_ndoc = dw_hist.getitemnumber(i_fila,'num_cobro')
dw_cab.retrieve(i_clug,i_coddoc,i_ndoc)
dw_tot.retrieve(i_clug,i_coddoc,i_ndoc)
string tipo1,tipo2
tab_1.tp_1a.dw_anti_pagodir.reset()
tab_1.tp_1a.dw_anti_nota.reset()
choose case dw_hist.getitemstring(dw_hist.getrow(),'cxp')
	case '1' //anticipo
		tab_1.tp_det.dw_det.dataobject='dw_car_cpo_anti'
		tipo1='A'
		tab_1.tp_1a.visible=true
		tab_1.tab_fact.visible=false
		tab_1.tp_1a.dw_anti_pagodir.retrieve(i_clug,i_coddoc,i_ndoc)//en el retrieveend se pone invisible si no hay filas
		tab_1.tp_1a.dw_anti_nota.retrieve(i_clug,i_coddoc,i_ndoc)//en el retrieveend se pone invisible si no hay filas
	case '0' //radicacion
		tab_1.tp_det.dw_det.dataobject='dw_car_cpo_radica'
		tipo1='0'
		tab_1.tab_fact.visible=true
		if tab_1.selectedtab=2 and tab_1.tp_1a.visible then tab_1.selectedtab=1
		tab_1.tp_1a.visible=false
	case '2' //saldo inicial
		tab_1.tp_det.dw_det.dataobject='dw_car_cpo_si'
		tipo1='0'
		tab_1.tab_fact.visible=true		
		if tab_1.selectedtab=2 and tab_1.tp_1a.visible then tab_1.selectedtab=1
		tab_1.tp_1a.visible=false
	case '3' //pagare
		tab_1.tp_det.dw_det.dataobject='dw_car_cpo_pagare'
		tipo1='P'
		tab_1.tab_fact.visible=true		
		if tab_1.selectedtab=2 and tab_1.tp_1a.visible then tab_1.selectedtab=1
		tab_1.tp_1a.visible=false
end choose

tab_1.tp_det.dw_det.settransobject(sqlca)
tab_1.tp_det.dw_det.retrieve(i_clug,i_coddoc,i_ndoc,tipo1,tipo1)
tab_1.tp_pag.tab_2.tp_0.dw_pend.reset()
tab_1.tp_pag.tab_2.tp_1.dw_pagos.reset()
tab_1.tp_pag.tab_2.tp_2.dw_pago.reset()
tab_1.tp_pag.tab_2.tp_1.dw_det_abono.reset()
tab_1.tp_pag.tab_2.tp_1.dw_ing.reset()
tab_1.tp_pag.tab_2.tp_1.dw_det_pag_manu.reset()
tab_1.tp_pag.tab_2.tp_1.dw_det_pag_nota.reset()
tab_1.tp_pag.tab_2.tp_1.dw_ing.reset()
tab_1.tp_des.dw_des.reset()
dw_amtz.reset()

tab_1.tp_pag.tab_2.tp_1.dw_det_abono.retrieve(i_clug,i_coddoc,i_ndoc)
tab_1.tp_pag.tab_2.tp_1.dw_ing.retrieve(i_clug,i_coddoc,i_ndoc)
tab_1.tp_pag.tab_2.tp_1.dw_det_pag_manu.retrieve(i_clug,i_coddoc,i_ndoc)
tab_1.tp_pag.tab_2.tp_1.dw_det_pag_nota.retrieve(i_clug,i_coddoc,i_ndoc)
dw_amtz.retrieve(i_clug,i_coddoc,i_ndoc)

tab_1.tp_pag.tab_2.tp_1.dw_pagos.retrieve(i_clug,i_coddoc,i_ndoc,'1')
tab_1.tp_des.dw_des.retrieve(i_clug,i_coddoc,i_ndoc)
tab_1.tp_glo.dw_glosas.retrieve(i_clug,i_coddoc,i_ndoc,'3','4')
if dw_hist.getitemstring(dw_hist.getrow(),'cxp')='3' then
	if tab_1.tp_pag.tab_2.tp_0.dw_pend.dataobject<>'dw_abonospag_a_cart' then
		tab_1.tp_pag.tab_2.tp_0.dw_pend.dataobject='dw_abonospag_a_cart'
		tab_1.tp_pag.tab_2.tp_0.dw_pend.settransobject(sqlca)
	end if
	tab_1.tp_pag.tab_2.tp_0.dw_pend.retrieve(dw_hist.getitemnumber(i_fila,'npagare'),dw_hist.getitemstring(i_fila,'clug_pag'))
	tab_1.tp_pag.tab_2.tp_0.d1.visible=false
else
	tab_1.tp_pag.tab_2.tp_0.d1.visible=true
	tab_1.tp_pag.tab_2.tp_0.d1.triggerevent(selectionchanged!)
end if

//para facturas
if dw_hist.getitemstring(dw_hist.getrow(),'cxp')='0' then
	if tab_1.tp_det.dw_det.rowcount()>0 then 
		tab_1.tab_fact.dw_fact.retrieve(tab_1.tp_det.dw_det.getitemnumber(tab_1.tp_det.dw_det.getrow(),'num_radicacion'),tab_1.tp_det.dw_det.getitemstring(tab_1.tp_det.dw_det.getrow(),'clugar_rad'),tab_1.tp_det.dw_det.getitemstring(tab_1.tp_det.dw_det.getrow(),'tipo_rad'))
	end if
End If

if dw_hist.getitemstring(dw_hist.getrow(),'cxp')='2' or dw_hist.getitemstring(dw_hist.getrow(),'cxp') ='A' then
	tab_1.tab_fact.dw_fact.retrieve(0,clugar,'F')
end if
end event

event closequery;call super::closequery;rollback;
end event

event open;call super::open;SELECT entero into :i_dec_teso
FROM parametros_gen
WHERE (((codigo_para)=28));
if sqlca.sqlnrows=0 then
	messagebox('Atencíon','No hay parametro 28')
	return
end if

em_desde.text = string(RelativeDate(today(), -30 ),'dd/mm/yyyy')
em_hasta.text = string(today(),'dd/mm/yyyy')

if idw_lugar.rowCount() = 1 then
	dw_lugar.setItem(1,'codlugar', idw_lugar.getItemString(1,'codlugar'))
	dw_lugar.Triggerevent( itemchanged!)
	pb_consultar.TriggerEvent(clicked!)
end if

SELECT cadena into :is_elec
FROM parametros_gen
WHERE (((codigo_para)=66));
if sqlca.sqlnrows=0 then
	messagebox('Atencíon','No hay parametro 66')
	return
end if

i_rep=create uo_report


end event

event resize;call super::resize;tab_1.resize((newwidth - 50) , (newheight * 0.55))
tab_1.tp_det.dw_det.resize((newwidth - 150),(tab_1.height *0.80))
tab_1.tab_fact.dw_fact.resize((newwidth - 350),(tab_1.height *0.80))
tab_1.tab_fact.pb_ce.x=(newwidth - 250)
tab_1.tab_fact.pb_4.x=(newwidth - 250)
tab_1.tab_fact.pb_impo.x=(newwidth -250)
tab_1.tp_des.dw_des.resize(4233,(tab_1.height *0.80))
tab_1.tp_des.mle_1.resize(1518,(tab_1.height *0.70))
tab_1.tp_pag.tab_2.resize((newwidth - 50),(tab_1.height *0.90))
tab_1.tp_pag.tab_2.tp_0.resize((newwidth - 100),(tab_1.height *0.90))
tab_1.tp_pag.tab_2.tp_0.dw_pend.resize((newwidth - 300),(tab_1.height *0.65))
tab_1.tp_pag.tab_2.tp_0.pb_new_pago.x=(newwidth - 270)
tab_1.tp_pag.tab_2.tp_0.pb_5.x=(newwidth - 270)
tab_1.tp_pag.tab_2.tp_1.dw_pagos.resize(3323,(tab_1.height *0.75))
tab_1.tp_pag.tab_2.tp_1.dw_det_abono.resize(3323,(tab_1.height *0.75))
tab_1.tp_pag.tab_2.tp_1.dw_det_pag_nota.resize(3250,(tab_1.height *0.75))
tab_1.tp_pag.tab_2.tp_1.pb_dist_pago.x=tab_1.tp_pag.tab_2.tp_1.dw_pagos.x+tab_1.tp_pag.tab_2.tp_1.dw_pagos.width + 30
tab_1.tp_pag.tab_2.tp_1.pb_delpago.x=tab_1.tp_pag.tab_2.tp_1.dw_pagos.x+tab_1.tp_pag.tab_2.tp_1.dw_pagos.width + 30
tab_1.tp_glo.dw_glosas.resize((newwidth - 350),(tab_1.height *0.90))
tab_1.tp_glo.pb_1.x=(newwidth - 250)
tab_1.tp_glo.pb_2.x=(newwidth - 250)
tab_1.tp_glo.pb_3.x=(newwidth - 250)
tab_1.tp_glo.pb_6.x=(newwidth - 250)
end event

type pb_grabar from w_center`pb_grabar within w_teso_cartera
integer x = 4338
integer y = 424
integer taborder = 70
string picturename = "guardar.gif"
string disabledname = "d_guardar.gif"
end type

event pb_grabar::clicked;call super::clicked;if grabar()=-1 then
	rollback;
else
	commit;
end if
end event

type gb_1 from groupbox within w_teso_cartera
integer x = 4315
integer y = 904
integer width = 2537
integer height = 288
integer taborder = 160
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Resumen de Totales:"
end type

type st_1 from statictext within w_teso_cartera
integer x = 50
integer y = 16
integer width = 146
integer height = 64
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Lugar:"
boolean focusrectangle = false
end type

type dw_hist from datawindow within w_teso_cartera
integer x = 37
integer y = 152
integer width = 4251
integer height = 1000
integer taborder = 80
boolean bringtotop = true
string title = "none"
string dataobject = "dw_car_cobro_cab2"
boolean hscrollbar = true
boolean vscrollbar = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;settransobject(sqlca)
end event

event rowfocuschanged;if currentrow<1  then return
timer(0.3)
end event

event rbuttondown;st_dw_xa_funciones st_dw
st_dw.dw=this
st_dw.dwo=dwo
st_dw.row=row
st_dw.color_fondo=string(rgb(255,255,255))
i_fila=-1
openwithparm(w_funcion_dw,st_dw)

end event

event rowfocuschanging;choose case f_pregunta()
	case 1
		if grabar()=-1 then
			rollback;
			return 1
		end if
	case 2
		cambio=false
		i_nuevo=false
		tab_1.tp_pag.tab_2.tp_0.pb_new_pago.enabled=true
	case 3
		return 1
end choose
return 0
end event

type dw_cab from datawindow within w_teso_cartera
event keyup pbm_dwnkey
integer x = 4512
integer y = 32
integer width = 2363
integer height = 884
integer taborder = 60
boolean bringtotop = true
string title = "none"
string dataobject = "dw_carcobro_cab"
boolean border = false
boolean livescroll = true
end type

event keyup;choose case getcolumnname()
	case 'cta_contable'
		f_busca_cuenta(key,i_emp,this)
	case 'codtotal'
		if isnull(getitemnumber(1,'cod_vigencia')) then return
		if dw_cab.RowCount() = 0 then Return
		//if dw_cab.getitemstring(1,'estado')<>'0' then return
		string este="!"
		
		st_ppto st_parm
		st_parm.cod_vigencia = getitemnumber(1,'cod_vigencia')
		choose case key
			case KeyNumpad0!,key0!
				este='0'
			case KeyNumpad1!,key1!
				este='1'
			case KeyNumpad2!,key2!
				este='2'
			case KeyNumpad3!,key3!
				este='3'
			case KeyNumpad4!,key4!
				este='4'
			case KeyNumpad5!,key5!
				este='5'
			case KeyNumpad6!,key6!
				este='6'
			case KeyNumpad7!,key7!
				este='7'
			case KeyNumpad8!,key8!
				este='8'
			case KeyNumpad9!,key9!
				este='9'
			case KeyNumpad0!,key0!
				este='0'
			case KeyEnter!
				if isValid(w_buscactapre) then close(w_buscactapre)
				TriggerEvent(itemchanged!)
				Return
			case keya!
				este='a'
			case keyb!
				este='b'
			case keyc!
				este='c'
			case keyd!
				este='d'
			case keye!
				este='e'
			case keyf!
				este='f'
			case keyg!
				este='g'
			case keyh!
				este='h'
			case keyi!
				este='i'
			case keyj!
				este='j'
			case keyk!
				este='k'
			case keyl!
				este='l'
			case keym!
				este='m'
			case keyn!
				este='n'
			case keyo!
				este='o'
			case keyp!
				este='p'
			case keyq!
				este='q'
			case keyr!
				este='r'
			case keys!
				este='s'
			case keyt!
				este='t'
			case keyu!
				este='u'
			case keyv!
				este='v'
			case keyw!
				este='w'
			case keyx!
				este='x'
			case keyy!
				este='y'
			case keyz!
				este='z'//	case keyback!
		//		este = GetText()
		//		if len(este) > 1 then
		//			este=left(este, len(este) - 1)
		//		else
		//			setNull(este)
		//		end if
			case else
				if keyDown(keycontrol!) then
					return
				end if
		end choose
		if este <> "!" then
			if not isnull(GetText()) then este=GetText() + este
		end if
		if key = keyback! then
			este = GetText()
			if len(este) > 1 then
				este=left(este, len(este) - 1)
			else
				este=''
			end if
		end if
		
		st_parm.filtro = "(lower(codtotal) like '" + lower(este) + "%') and (tipo='0' and movimiento='1')"
		st_parm.dw_sle = this
		if isValid(w_buscactapre) then
			w_buscactapre.st_parm.dw_sle=this
			w_buscactapre.dw_1.SetFilter(st_parm.filtro)
			w_buscactapre.dw_1.Filter()
		else
			openwithparm(w_buscactapre,st_parm)
		end if
		SetFocus()
end choose

		


end event

event itemchanged;string nulo
long donde,nnulo

setnull(nulo)
setnull(nnulo)
donde=getrow()
choose case getcolumnname()
	case "fecha"
		if f_docu_cartera(datetime(data))=-1 then return 1
	case "cta_contable"
		string revisa,otro
		otro=gettext()
		setnull(revisa)
		select descrip into :revisa from cont_plan where codtotal=:otro and cod_empresa=:i_emp and movimiento='1';
		if isnull(revisa) then
			setitem(getrow(),getcolumnname(),revisa)
			setitem(getrow(),"descrip",revisa)
			return 1
		else
			accepttext()
			setitem(getrow(),"descrip",revisa)
			if isnull(getitemstring(getrow(),'cod_empresa')) then setitem(getrow(),'cod_empresa',i_emp)
		end if
	case "tipodoc"
		setitem(donde,"documento",nulo)
		accepttext()
	case "documento"
		string tdoc,doc,persona,nom1,nom2,ape1,ape2,rsoc,dverif
		tdoc=getitemstring(donde,"tipodoc")
		if isnull(tdoc) then
			setnull(nulo)
			setitem(donde,"documento",nulo)
			setitem(donde,"dverificacion",nulo)
			setcolumn("tipodoc")
			return 1
		end if
		doc=gettext()
		setnull(persona)
		SELECT TERCEROS.Persona, TERCEROS.nombre1, TERCEROS.nombre2, TERCEROS.apellido1, 
			TERCEROS.APELLIDO2, TERCEROS.razon_social,terceros.dverificacion
		into :persona,:nom1,:nom2,:ape1,:ape2,:rsoc,:dverif
		FROM TERCEROS
		WHERE TERCEROS.TipoDoc=:tdoc AND TERCEROS.documento=:doc;
		if isnull(persona) then
			if messagebox("Atención","Este Tercero no se encuentra, desea crearlo?",question!,yesno!,2)=2 then
				settext(getitemstring(getrow(),getcolumn()))
				return 1
			else
				st_general messObj
				messObj.valor = getitemstring(getrow(),'tipodoc')
				messObj.documento = doc
				messObj.dw_obj = this
				openwithparm(w_cfgterceros, messObj)
				if message.stringparm='' then 
					settext(getitemstring(getrow(),getcolumn()))
					return 1
				end if
			end if
		else
			setitem(donde,"nombre1",nom1)
			setitem(donde,"nombre2",nom2)
			setitem(donde,"apellido1",ape1)
			setitem(donde,"apellido2",ape2)
			setitem(donde,"razon_social",rsoc)
			setitem(donde,"persona",persona)
			setitem(donde,"dverificacion",dverif)
		end if
	case 'cxp' //origen
		if i_nuevo and not isnull(getitemnumber(1,'num_cobro')) then 
			settext(getitemstring(1,'cxp'))
			return 1
		end if
		if not i_nuevo then 
			settext(getitemstring(1,'cxp'))
			return 1
		end if
		if isnull(getitemstring(1,'documento')) then
			setitem(1,'cxp',getitemstring(1,'cxp'))
			settext(getitemstring(1,'cxp'))
			return 1
		end if
		if data='1' then //anticipos
			tab_1.tp_1a.visible=true
		else
			tab_1.tp_1a.visible=false
		end if
		tab_1.selectedtab=1
		if data='2' then
			
		else
			st_int_cartera param
			param.tdoc=getitemstring(1,'tipodoc')
			param.docu=getitemstring(1,'documento')
			param.origen=data
			openwithparm(w_interface_cartera,param)
		end if
		
	case 'cod_vigencia'
		setitem(1,'codtotal',nulo)
	case 'codtotal'
		string codtotal,  descripcion, texto
		long  vigen
		vigen=getitemnumber(1,'cod_vigencia')
		texto = gettext()
		if texto = '' then Return
		SELECT pre_plan.CodTotal, pre_plan.descrip
		into :codTotal, :descripcion 
		FROM pre_plan 
		WHERE (((pre_plan.CodTotal)=:Texto) AND ((pre_plan.cod_vigencia)=:vigen) AND ((pre_plan.tipo)='0') AND ((pre_plan.movimiento)='1'));
		
		if SQLCA.SQLCode = -1 then
			MessageBox("SQL error", SQLCA.SQLErrText)
			Return
		elseif SQLCA.SQLCode = 100 then
			Messagebox('Error','La cuenta no aparece en el Plan de Presupuesto o no es de movimiento')
			Return
		end if

	SetItem(1,'descrip_presup',descripcion)
	case 'val_bruto','tdescuentos','anticipo'
end choose

end event

event doubleclicked;string columna
columna=getcolumnname() 
if columna="tipodoc" or columna="documento" or columna='dverificacion' then
	g_tercerodesde=13
	openwithparm(w_buscater, this)
	if getitemstring(getrow(),"documento")<>"" then
		setcolumn("documento")
		triggerevent(itemchanged!)
	end if
end if
end event

event constructor;settransobject(sqlca)
end event

event dberror;return f_dw_error(sqldbcode,sqlsyntax,sqlerrtext,classname())
end event

type pb_new from picturebutton within w_teso_cartera
integer x = 4338
integer y = 160
integer width = 146
integer height = 128
integer taborder = 50
boolean bringtotop = true
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
boolean originalsize = true
string picturename = "insertar.gif"
string disabledname = "d_insertar.gif"
alignment htextalign = left!
string powertiptext = "Insertar Cuenta"
end type

event clicked;if cambio then return
dw_cab.reset()
dw_tot.reset()
tab_1.tp_det.dw_det.reset()
tab_1.tp_des.dw_des.reset()
tab_1.tp_pag.tab_2.tp_1.dw_pagos.reset()
tab_1.tp_pag.tab_2.tp_2.dw_pago.reset()
tab_1.tp_glo.dw_glosas.reset()
dw_cab.insertrow(1)
dw_cab.setitem(1,'fecha_crea',datetime(today(),now()))
dw_cab.setitem(1,'fecha',datetime(today()))
dw_cab.setitem(1,'cod_empresa',i_emp)
dw_cab.setitem(1,'contabil','P')
dw_cab.setitem(1,'usuario',usuario)
cambio=true
i_nuevo=true

end event

type pb_anula from picturebutton within w_teso_cartera
integer x = 4338
integer y = 288
integer width = 146
integer height = 128
integer taborder = 60
boolean bringtotop = true
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "         &a"
boolean originalsize = true
string picturename = "borrar_fila.gif"
string disabledname = "d_borrar_fila.gif"
alignment htextalign = left!
string powertiptext = "Anular Pago"
end type

event clicked;if i_nuevo then return
if not isnull(dw_hist.getitemstring(dw_hist.getrow(),'estado')) then
	messagebox("Atención",'Este cobro ya se encuentra anulado')
	return
end if
if dw_cab.getitemstring(1,'presupuesto')='1' then
	messagebox("Atención",'Este cobro ya se encuentra en un reconocimiento presupuestal, no lo puede anular')
	return
end if
if dw_hist.getitemstring(dw_hist.getrow(),'contabil')='C' then
	messagebox("Atención",'Este cobro ya se encuentra Contabilizado, no lo puede anular')
	return
end if
datawindow dw_temp
dw_temp=tab_1.tp_det.dw_det
if dw_temp.find('contabil="C"',1,dw_temp.rowcount())>0 then
	messagebox("Atención",'Este cobro ya se encuentra Contabilizado, no lo puede anular')
	return
end if
dw_temp=tab_1.tp_des.dw_des
if dw_temp.find('contabil="C"',1,dw_temp.rowcount())>0 then
	messagebox("Atención",'Este cobro ya se encuentra Contabilizado, no lo puede anular')
	return
end if
dw_temp=tab_1.tp_pag.tab_2.tp_1.dw_pagos
//if dw_temp.find("contabil='C' or (not isnull( estado ))" ,1,dw_temp.rowcount())>0 then
//	messagebox("Atención",'Este cobro ya tiene pagos Contabilizados o no anulados, no lo puede anular')
//	return
//end if
dw_temp=tab_1.tp_glo.dw_glosas
if dw_temp.find('contabil="C"',1,dw_temp.rowcount())>0 then
	messagebox("Atención",'Este cobro ya se encuentra Contabilizado, no lo puede anular')
	return
end if

st_xa_anular st_anula
st_anula.tipo='CA'
openwithparm (w_motiv_anula,st_anula)
st_anula=message.powerobjectparm
if not isValid(st_anula) then return

long j,nrad
string clug_rad
if dw_cab.getitemstring(1,'cxp')='0' then//de radicaciones
	dw_temp=tab_1.tp_det.dw_det
	for j=1 to dw_temp.rowcount()
		nrad=dw_temp.getitemnumber(j,'num_radicacion')
		clug_rad=dw_temp.getitemstring(j,'clugar_rad')
		update ripsradica set en_destino='0' where num_radicacion=:nrad and clugar=:clug_rad;
		if sqlca.sqlcode=-1 then
			messagebox("Error actualizando RispRadica",sqlca.sqlerrtext)
			rollback;
			return
		end if
	next
end if
if dw_cab.getitemstring(1,'cxp')='3' then
	long npag
	string clug_pag
	npag=dw_cab.getitemnumber(1,'npagare')
	clug_pag=dw_cab.getitemstring(1,'clug_pag')
	update tesopagarecab set en_destino='0'
	where npagare=:npag and clugar=:clug_pag;
	if sqlca.sqlcode=-1 then
		messagebox("Error actualizando en_destino de tesopagarecab",sqlca.sqlerrtext)
		rollback;
		return 
	end if
end if
if dw_cab.getitemstring(1,'cxp')='1' then //anticipos
	string cban,tcuent,ncuent,ccaj,clugpag,cdocpag
	long npago,it
	dec va
	for j=1 to tab_1.tp_1a.dw_anti_pagodir.rowcount()
		ccaj=tab_1.tp_1a.dw_anti_pagodir.getitemstring(j,'codcaja')
		clugpag=tab_1.tp_1a.dw_anti_pagodir.getitemstring(j,'clugar')
		cdocpag=tab_1.tp_1a.dw_anti_pagodir.getitemstring(j,'coddoc')
		npago=tab_1.tp_1a.dw_anti_pagodir.getitemnumber(j,'ningreso')
		va=tab_1.tp_1a.dw_anti_pagodir.getitemnumber(j,'valor')
		update tesocajaingreso set valor_cartera=valor_cartera -:va where 
		codcaja =:ccaj and clugar =:clugpag and coddoc =:cdocpag and ningreso=:npago;
		if sqlca.sqlcode=-1 then
			messagebox("Error actualizando tesocajaingreso",sqlca.sqlerrtext)
			rollback;
			return -1
		end if
	next
	for j=1 to tab_1.tp_1a.dw_anti_nota.rowcount()
		cban=tab_1.tp_1a.dw_anti_nota.getitemstring(j,'codbanco')
		tcuent=tab_1.tp_1a.dw_anti_nota.getitemstring(j,'tipo_cuenta')
		ncuent=tab_1.tp_1a.dw_anti_nota.getitemstring(j,'numcuenta')
		it=tab_1.tp_1a.dw_anti_nota.getitemnumber(j,'item')
		va=tab_1.tp_1a.dw_anti_nota.getitemnumber(j,'valor')
		update tesocuentasmovi set valor_cartera=valor_cartera - :va where
		codbanco=:cban and tipo_cuenta=:tcuent and numcuenta =:ncuent and item=:it;
		if sqlca.sqlcode=-1 then
			messagebox("Error actualizando tesocuentasmovi",sqlca.sqlerrtext)
			rollback;
			return -1
		end if
	next
end if
dw_cab.setitem(1,'estado',usuario)
dw_cab.setitem(1,'fecha_anula',datetime(today(),now()))
dw_cab.setitem(1,'motiv_anula',st_anula.observacion)
dw_cab.setitem(1,'cod_anula',st_anula.motivo)
if dw_cab.update(true,false)=-1 then
	rollback;
else
	commit;
	dw_cab.resetupdate()
	dw_hist.setitem(dw_hist.getrow(),'estado',usuario)
end if
end event

type dw_tot from datawindow within w_teso_cartera
integer x = 4361
integer y = 956
integer width = 2482
integer height = 228
integer taborder = 150
boolean bringtotop = true
string title = "none"
string dataobject = "dw_car_tot"
boolean vscrollbar = true
boolean border = false
boolean livescroll = true
end type

event constructor;settransobject(sqlca)
getchild('cartipo_1',idw_tipocart)
idw_tipocart.settransobject(sqlca)
idw_tipocart.retrieve()
end event

event dberror;return f_dw_error(sqldbcode,sqlsyntax,sqlerrtext,classname())
end event

type tab_1 from tab within w_teso_cartera
integer x = 41
integer y = 1188
integer width = 6825
integer height = 1240
integer taborder = 170
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long backcolor = 67108864
boolean raggedright = true
boolean focusonbuttondown = true
boolean powertips = true
alignment alignment = center!
integer selectedtab = 1
tp_det tp_det
tab_fact tab_fact
tp_1a tp_1a
tp_des tp_des
tp_pag tp_pag
tp_glo tp_glo
end type

on tab_1.create
this.tp_det=create tp_det
this.tab_fact=create tab_fact
this.tp_1a=create tp_1a
this.tp_des=create tp_des
this.tp_pag=create tp_pag
this.tp_glo=create tp_glo
this.Control[]={this.tp_det,&
this.tab_fact,&
this.tp_1a,&
this.tp_des,&
this.tp_pag,&
this.tp_glo}
end on

on tab_1.destroy
destroy(this.tp_det)
destroy(this.tab_fact)
destroy(this.tp_1a)
destroy(this.tp_des)
destroy(this.tp_pag)
destroy(this.tp_glo)
end on

type tp_det from userobject within tab_1
integer x = 18
integer y = 112
integer width = 6789
integer height = 1112
long backcolor = 67108864
string text = "Detalle"
long tabtextcolor = 33554432
string picturename = "arq_deta.ico"
long picturemaskcolor = 536870912
string powertiptext = "Detalle del cobro"
dw_det dw_det
end type

on tp_det.create
this.dw_det=create dw_det
this.Control[]={this.dw_det}
end on

on tp_det.destroy
destroy(this.dw_det)
end on

type dw_det from datawindow within tp_det
integer x = 32
integer y = 32
integer width = 5851
integer height = 1064
integer taborder = 30
string title = "none"
string dataobject = "dw_car_cpo_radica"
boolean hscrollbar = true
boolean vscrollbar = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;settransobject(sqlca)

end event

event dberror;return f_dw_error(sqldbcode,sqlsyntax,sqlerrtext,classname())
end event

event itemchanged;accepttext()
if dwo.name='fecha' then
	date fec_rad, fec_hoy
   	fec_hoy=date(today())
	fec_rad=date(dw_cab.GetItemDatetime(dw_cab.getrow(),"fecha"))
	if f_valida_fecha(getitemdatetime(getrow(),'fecha'))=-1  then return 1
	if date(data)>fec_hoy or  date(data)<fec_rad then
		messagebox("Atención",'Fecha debe estar entre '+string(fec_rad,'dd/mm/yyyy')+' y el '+string(fec_hoy,'dd/mm/yyyy')+' verifique')
		return 1
	End If
	if f_docu_cartera(datetime(data))=-1 then return 1
End If
end event

type tab_fact from userobject within tab_1
integer x = 18
integer y = 112
integer width = 6789
integer height = 1112
long backcolor = 67108864
string text = "Facturas"
long tabtextcolor = 33554432
string picturename = "facturas.ico"
long picturemaskcolor = 536870912
dw_im dw_im
pb_impo pb_impo
dw_sale dw_sale
pb_4 pb_4
pb_ce pb_ce
dw_fact dw_fact
end type

on tab_fact.create
this.dw_im=create dw_im
this.pb_impo=create pb_impo
this.dw_sale=create dw_sale
this.pb_4=create pb_4
this.pb_ce=create pb_ce
this.dw_fact=create dw_fact
this.Control[]={this.dw_im,&
this.pb_impo,&
this.dw_sale,&
this.pb_4,&
this.pb_ce,&
this.dw_fact}
end on

on tab_fact.destroy
destroy(this.dw_im)
destroy(this.pb_impo)
destroy(this.dw_sale)
destroy(this.pb_4)
destroy(this.pb_ce)
destroy(this.dw_fact)
end on

type dw_im from datawindow within tab_fact
boolean visible = false
integer x = 5742
integer y = 500
integer width = 110
integer height = 316
integer taborder = 40
string title = "none"
string dataobject = "dw_imp_radicaciones"
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;SetTransObject(SQLCA)
end event

type pb_impo from picturebutton within tab_fact
string tag = "Importa Archivo"
integer x = 5742
integer y = 332
integer width = 146
integer height = 128
integer taborder = 30
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean originalsize = true
string picturename = "import.gif"
string disabledname = "d_import.gif"
end type

event clicked;if dw_fact.rowCount() = 0 then return 0

long value, i, l_fac,n_rad,ll_found 
string docname,named,l_lug,l_tipof,tipo_rad,l_rad
date l_fec
double valores

value = GetFileOpenName("Importar de:", docname, named,"*.TXT","Text files, *.TXT, CSV files, *.CSV") 
IF value = 1 THEN
	value = dw_im.ImportFile(csv!,docname)
	if value = -1  then MessageBox('Atención','No se encontraron filas')
	if value = -2  then MessageBox('Atención','Archivo vacio')
	if value = -3  then MessageBox('Atención','Argumento inválido')
	if value = -4  then MessageBox('Atención','Entrada inválida')
	if value = -5  then MessageBox('Atención','No se puede abrir el archivo')
	if value = -6  then MessageBox('Atención','No se puede cerrar el archivo')
	if value = -7  then MessageBox('Atención','Error leyendo el texto')
	if value = -8  then MessageBox('Atención','Sufijo de archivo no soportado (debe ser *.txt, *.csv, *.dbf or *.xml)')
	if value = -10 then MessageBox('Atención','Formato de archivo dBase no soportado  (solo version 2 or 3)')
	if value = -13 then MessageBox('Atención','Estilo de DataWindow no soportado para importación')
	if value = -14 then MessageBox('Atención','Error resolviendo anidamiento de DataWindow')
	if value < 0 then REturn -1
end if


for i = 1 to dw_im.RowCount()
	if i=1 then 
	  	n_rad=dw_im.GetItemnumber(1,'nradica')
	 	l_rad=dw_im.GetItemstring(1,'clug_rad')
	   	tipo_rad=dw_im.GetItemString(1,'tipo_rad')
		ll_found =dw_fact.Find("nradica ="+string(n_rad)+" and clugar_rad ='"+l_rad+"' and tipo_rad='"+tipo_rad+"'",1,dw_fact.RowCount()) 	
	    	if ll_found = 0 then
			MessageBox('Atención','No corresponde facturas con radicación')	
		 	return 0
		end if
	end if
	l_fac = dw_im.GetItemnumber(i,'factura')
	l_lug = dw_im.GetItemString(i,'lugar')
	l_tipof = dw_im.GetItemString(i,'tipo_fac')
	l_fec= dw_im.GetItemdate(i,'fecha')
	ll_found =dw_fact.Find("nfact ="+string(l_fac)+" and clugar ='"+l_lug+"' and tipo_fac='"+l_tipof+"' and string(fecha)='"+string(l_fec)+"'",1,dw_fact.RowCount()) 
	if ll_found > 0 then
		dw_fact.SetItem(ll_found ,'radica_cartera',dw_im.GetItemstring(i,'numero'))
	end if
next

end event

type dw_sale from datawindow within tab_fact
boolean visible = false
integer x = 5093
integer y = 924
integer width = 137
integer height = 96
integer taborder = 60
string dataobject = "dw_facturas_relacion"
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;settransobject(sqlca)

end event

type pb_4 from picturebutton within tab_fact
integer x = 5737
integer y = 184
integer width = 146
integer height = 128
integer taborder = 60
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
string picturename = "export.gif"
string powertiptext = "Genera Relacion Facturas"
end type

event clicked;if tab_1.tp_det.dw_det.rowcount()>0 then
	long nradica
	string clugar_rad,tipo_rad
	nradica = tab_1.tp_det.dw_det.getItemNumber(tab_1.tp_det.dw_det.getrow(),'num_radicacion')
	clugar_rad = tab_1.tp_det.dw_det.getItemString(tab_1.tp_det.dw_det.getrow(),'clugar_rad')
	tipo_rad = tab_1.tp_det.dw_det.getItemString(tab_1.tp_det.dw_det.getrow(),'tipo_rad')
	dw_sale.retrieve(nradica,clugar_rad,tipo_rad)
	openwithparm(w_export,dw_sale)
end if
end event

type pb_ce from picturebutton within tab_fact
string tag = "Numero de Radicacion Todas"
integer x = 5737
integer y = 36
integer width = 142
integer height = 128
integer taborder = 80
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
string picturename = "distrib.gif"
end type

event clicked;st_pagos st_radica
if  tab_1.tp_det.dw_det.rowcount()>0 then
	st_radica.nradica = tab_1.tp_det.dw_det.getItemNumber(tab_1.tp_det.dw_det.getrow(),'num_radicacion')
	st_radica.clugar_rad = tab_1.tp_det.dw_det.getItemString(tab_1.tp_det.dw_det.getrow(),'clugar_rad')
	st_radica.tipo_rad = tab_1.tp_det.dw_det.getItemString(tab_1.tp_det.dw_det.getrow(),'tipo_rad')
	st_radica.dw_pagos =tab_1.tab_fact.dw_fact
	st_radica.decimales=i_dec_teso
	openwithparm(w_acepta_radicacion,st_radica)
	tab_1.tab_fact.dw_fact.retrieve(st_radica.nradica,st_radica.clugar_rad ,st_radica.tipo_rad )
End If
end event

type dw_fact from datawindow within tab_fact
integer x = 32
integer y = 32
integer width = 5659
integer height = 1068
integer taborder = 50
boolean bringtotop = true
string dataobject = "dw_facts_radica"
boolean hscrollbar = true
boolean vscrollbar = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;settransobject(sqlca)


end event

event dberror;return f_dw_error(sqldbcode,sqlsyntax,sqlerrtext,classname())
end event

type tp_1a from userobject within tab_1
string tag = "Det. anticipo"
boolean visible = false
integer x = 18
integer y = 112
integer width = 6789
integer height = 1112
long backcolor = 67108864
string text = "Det. Ant."
long tabtextcolor = 33554432
string picturename = "ajuste.ico"
long picturemaskcolor = 536870912
string powertiptext = "Detalle de Anticipos"
dw_anti_nota dw_anti_nota
dw_anti_pagodir dw_anti_pagodir
end type

on tp_1a.create
this.dw_anti_nota=create dw_anti_nota
this.dw_anti_pagodir=create dw_anti_pagodir
this.Control[]={this.dw_anti_nota,&
this.dw_anti_pagodir}
end on

on tp_1a.destroy
destroy(this.dw_anti_nota)
destroy(this.dw_anti_pagodir)
end on

type dw_anti_nota from datawindow within tp_1a
string tag = "Nota bancaria N"
boolean visible = false
integer x = 32
integer y = 32
integer width = 3355
integer height = 1052
integer taborder = 110
string title = "none"
string dataobject = "dw_tesbanconot_carpago"
boolean hscrollbar = true
boolean vscrollbar = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;settransobject(sqlca)
end event

event dberror;return f_dw_error(sqldbcode,sqlsyntax,sqlerrtext,classname())
end event

event retrieveend;if rowcount=0 then 
	visible=false
else
	visible=true
end if
end event

type dw_anti_pagodir from datawindow within tp_1a
string tag = "ingresos directos I"
boolean visible = false
integer x = 32
integer y = 32
integer width = 2889
integer height = 1056
integer taborder = 30
string title = "none"
string dataobject = "dw_ing_cobros"
boolean hscrollbar = true
boolean vscrollbar = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;settransobject(sqlca)
getchild('codcaja',idw_caja2)
idw_caja2.settransobject(sqlca)
end event

event dberror;return f_dw_error(sqldbcode,sqlsyntax,sqlerrtext,classname())
end event

event retrieveend;if rowcount=0 then 
	visible=false
else
	visible=true
end if
end event

type tp_des from userobject within tab_1
integer x = 18
integer y = 112
integer width = 6789
integer height = 1112
long backcolor = 67108864
string text = "Desc./Ajustes"
long tabtextcolor = 33554432
string picturename = "nota_dc.ico"
long picturemaskcolor = 536870912
string powertiptext = "Descuentos o Ajustes hechos al cobro original"
pb_impnota pb_impnota
pb_connota pb_connota
pb_diann pb_diann
pb_dist_desc pb_dist_desc
mle_1 mle_1
st_6 st_6
pb_deldes pb_deldes
pb_newdes pb_newdes
dw_des dw_des
end type

on tp_des.create
this.pb_impnota=create pb_impnota
this.pb_connota=create pb_connota
this.pb_diann=create pb_diann
this.pb_dist_desc=create pb_dist_desc
this.mle_1=create mle_1
this.st_6=create st_6
this.pb_deldes=create pb_deldes
this.pb_newdes=create pb_newdes
this.dw_des=create dw_des
this.Control[]={this.pb_impnota,&
this.pb_connota,&
this.pb_diann,&
this.pb_dist_desc,&
this.mle_1,&
this.st_6,&
this.pb_deldes,&
this.pb_newdes,&
this.dw_des}
end on

on tp_des.destroy
destroy(this.pb_impnota)
destroy(this.pb_connota)
destroy(this.pb_diann)
destroy(this.pb_dist_desc)
destroy(this.mle_1)
destroy(this.st_6)
destroy(this.pb_deldes)
destroy(this.pb_newdes)
destroy(this.dw_des)
end on

type pb_impnota from picturebutton within tp_des
integer x = 4297
integer y = 712
integer width = 146
integer height = 128
integer taborder = 80
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean enabled = false
boolean originalsize = true
string picturename = "print2.gif"
string disabledname = "d_print2.gif"
end type

event clicked;long ldb_fila
any par[4]
string ls_elec1

ldb_fila=dw_des.getrow()
if ldb_fila< 1 then return

SELECT cadena into :ls_elec1
FROM parametros_gen
WHERE (((codigo_para)=66));
if sqlca.sqlnrows=0 then
	messagebox('Atencíon','No hay parametro 66')
	return
end if

i_rep.v_preliminar=true
i_rep.dialogo=false
i_rep.cambiar_prop=false
i_rep.tipo_rep='documento!'
if dw_des.getitemstring(ldb_fila,"tipo_nota")='C' then
	i_rep.nombre_rep='Impresión de Nota Credito'
	i_rep.cod_rep='CRA'
else
	i_rep.nombre_rep='Impresión de Nota Debito'
	i_rep.cod_rep='DRA'
end if

if i_rep.inicia()=-1 then return
par[1]=dw_des.getitemnumber(ldb_fila,'nradica_nota')
par[2]=dw_des.getitemstring(ldb_fila,"clugar_nota")
par[3]=dw_des.getitemstring(ldb_fila,"trad_nota")
par[4]=dw_des.getitemnumber(ldb_fila,"nro_nota")

if  ls_elec1<>'0' then
	i_rep.imprimir(par,'','1')
else
	i_rep.imprimir(par,'','0')
end if
end event

type pb_connota from picturebutton within tp_des
integer x = 4297
integer y = 580
integer width = 146
integer height = 128
integer taborder = 90
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean enabled = false
boolean originalsize = true
string picturename = "dian_zip.gif"
string disabledname = "d_dian_zip.gif"
string powertiptext = "Envio Contenedor"
end type

event clicked;////////ELECTRONICA	
if is_elec='2' then
	double ldb_i,ldb_nfactura,ldb_numradica
	int li_nnota
	string ls_clugar,ls_tfac,ls_clugarrad,ls_tiporad,ls_tnota
	nvo_factura_electronica u_eleccc
	st_ret_dian    lst_lle
		
	u_eleccc=create nvo_factura_electronica
	ldb_numradica=dw_des.getitemnumber(dw_des.getrow(),'nradica_nota')
	ls_clugarrad=dw_des.getitemstring(dw_des.getrow(),"clugar_nota")
	ls_tiporad=dw_des.getitemstring(dw_des.getrow(),"trad_nota")
	li_nnota=dw_des.getitemnumber(dw_des.getrow(),'nro_nota')
	ls_tnota=lower(dw_des.getitemstring(dw_des.getrow(),'tipo_nota'))
	if dw_des.getitemstring(dw_des.getrow(),'estado_dian_nota')<>'1' then return
	if dw_des.getitemstring(dw_des.getrow(),'estado_dian_nota')='' or isnull(dw_des.getitemstring(dw_des.getrow(),'estado_dian_nota')) then return
	
	u_eleccc.of_enviar_new_correo(ldb_numradica,ls_clugarrad,ls_tiporad,li_nnota,ls_tnota,dw_des.getitemstring(dw_des.getrow(),'file_name_nota'),'C')
	destroy u_eleccc
	messagebox('','Proceso Finalizado')
else
	messagebox('','No hay parametro Habilitado')
end if
//////ELECTRONICA	


end event

type pb_diann from picturebutton within tp_des
integer x = 4297
integer y = 444
integer width = 146
integer height = 128
integer taborder = 50
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean enabled = false
boolean originalsize = true
string picturename = "dian.gif"
string disabledname = "d_dian.gif"
string powertiptext = "Envio Nota Dian"
end type

event clicked;long ldb_numradica
datetime ldt_ahora
string ls_clugarrad,ls_tiporad,ls_anula,ls_tiponota
int li_nnota

dw_nc.accepttext()
pb_deldes.enabled=false
pb_diann.enabled=false
ldb_numradica=dw_des.getitemnumber(dw_des.getrow(),'nradica_nota')
ls_clugarrad=dw_des.getitemstring(dw_des.getrow(),"clugar_nota")
ls_tiporad=dw_des.getitemstring(dw_des.getrow(),"trad_nota")
li_nnota=dw_des.getitemnumber(dw_des.getrow(),'nro_nota')
ls_tiponota=lower(dw_des.getitemstring(dw_des.getrow(),'tipo_nota'))

if ls_tiporad='F' and isnull(dw_des.getitemstring(dw_des.getrow(),'estado_dian_nota')) then
	st_ret_dian    lst_lle
	nvo_factura_electronica u_eleca
	u_eleca=create nvo_factura_electronica
	
	if g_motor='postgres' then
		if ls_tiponota='c' then
			dw_electronica.dataobject='dw_factura_electronica_cap_postgres_ncredito'	
		else
			dw_electronica.dataobject='dw_factura_electronica_cap_postgres_ndebito'
		end if
	end if	
	dw_electronica.settransobject(sqlca)
		
	lst_lle=u_eleca.sign_chilkat(dw_electronica,ldb_numradica,ls_clugarrad,ls_tiporad,li_nnota,ls_tiponota,'RV')
	if lst_lle.as_estado<>'1' then
		destroy u_eleca
		return
	end if
	messagebox('','Proceso Finalizado')
	destroy u_eleca
end if
end event

type pb_dist_desc from picturebutton within tp_des
integer x = 4297
integer y = 292
integer width = 146
integer height = 128
integer taborder = 90
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean originalsize = true
string picturename = "contrato.gif"
string powertiptext = "Distribuir Descuento"
end type

event clicked;dwItemStatus l_status
long fila
fila = tab_1.tp_det.dw_det.Find("cartipo='CR'",1,tab_1.tp_det.dw_det.rowCount())
l_status = dw_des.GetItemStatus(dw_des.getRow(), 0, Primary!)
if l_status = NotModified! and fila > 0 then
	st_pagos st_p
	st_p.coddoc = dw_cab.getItemString(dw_cab.getrow(),'coddoc')
	st_p.clugar = dw_cab.getItemString(dw_cab.getrow(),'clugar')
	st_p.num_cobro = dw_cab.getItemNumber(dw_cab.getrow(),'num_cobro')
	st_p.cartipo = dw_des.getItemString(dw_des.getrow(),'cartipo')	
	st_p.item = dw_des.getItemNumber(dw_des.getrow(),'item')
//	st_p.nradica = dw_cab.getItemNumber(dw_cab.getrow(),'nradica')
//	st_p.clugar_rad = dw_cab.getItemString(dw_cab.getrow(),'clugar_rad')
	st_p.nradica = tab_1.tp_det.dw_det.getItemNumber(fila,'num_radicacion')
	st_p.clugar_rad = tab_1.tp_det.dw_det.getItemString(fila,'clugar_rad')
	st_p.tipo_rad = tab_1.tp_det.dw_det.getItemString(fila,'tipo_rad')
	st_p.dw_pagos = dw_des
	st_p.origen='D'
	st_p.decimales=i_dec_teso
	openwithparm(w_dist_pagos,st_p)
else
	MessageBox('Atención','Debe guardar para distribuir montos entre facturas')
end if

end event

type mle_1 from multilineedit within tp_des
integer x = 4530
integer y = 84
integer width = 2199
integer height = 1012
integer taborder = 30
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
boolean hscrollbar = true
boolean vscrollbar = true
boolean autohscroll = true
boolean autovscroll = true
borderstyle borderstyle = stylelowered!
end type

event modified;if dw_des.rowcount()=0 then return
if (isnull(dw_des.getitemstring(dw_des.getrow(),'observaciones')) and text<>'' ) or (dw_des.getitemstring(dw_des.getrow(),'observaciones')<>text) then
	dw_des.setitem(dw_des.getrow(),'observaciones',text)
	cambio=true
end if
end event

event losefocus;event modified()
end event

type st_6 from statictext within tp_des
integer x = 4526
integer y = 16
integer width = 864
integer height = 60
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Observaciones del Descuento / Ajuste:"
boolean focusrectangle = false
end type

type pb_deldes from picturebutton within tp_des
integer x = 4297
integer y = 160
integer width = 146
integer height = 128
integer taborder = 50
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
boolean originalsize = true
string picturename = "borrar_fila.gif"
alignment htextalign = left!
string powertiptext = "Anular o Borrar Descuento"
end type

event clicked;long fila,j
fila=dw_des.getrow()
if fila<1 then return
if dw_des.getitemstring(fila,'estado_dian_nota')='1' then
	messagebox("Atención",'Esta Nota ya se encuentra en DIAN, no lo puede anular')
	return
end if
if dw_des.getitemstring(fila,'contabil')='C' then
	messagebox("Atención",'Este descuento ya se encuentra contabilizado, no lo puede anular')
	return
end if
if dw_des.describe("evaluate('IsRowNew()',"+string(fila)+')')='true' then
	dw_des.deleterow(fila)
else
	st_xa_anular st_anula
	st_anula.tipo='CA'
	openwithparm (w_motiv_anula,st_anula)
	st_anula=message.powerobjectparm
	if not isValid(st_anula) then return
	dw_des.setitem(fila,'estado',usuario)
	dw_des.setitem(fila,'fecha_anula',datetime(today(),now()))
	dw_des.setitem(fila,'motiv_anula',st_anula.observacion)
	dw_des.setitem(fila,'cod_anula',st_anula.motivo)	
end if
calc_totales()
cambio=true

end event

type pb_newdes from picturebutton within tp_des
integer x = 4297
integer y = 28
integer width = 146
integer height = 128
integer taborder = 50
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
boolean originalsize = true
string picturename = "insertar.gif"
string disabledname = "d_insertar.gif"
alignment htextalign = left!
string powertiptext = "Nuevo descuento / Ajuste"
end type

event clicked;long donde,j
if dw_cab.rowcount()=0 then return
if not isnull(dw_cab.getitemstring(1,'estado')) then return

if dw_cab.getitemstring(1,'cxp')='1' then return
if (dw_cab.getitemstring(1,'cxp')='2' or dw_cab.getitemstring(1,'cxp')='3') and i_nuevo then
	messagebox("Atención",'Debe primero guardar para poder insertar un registro de descuentos')
	return -1
end if
donde=dw_des.insertrow(0)
for j=1 to dw_des.rowcount()
	if dw_des.find('item='+string(j),1,dw_des.rowcount())=0 then exit
next
dw_des.setitem(donde,'usuario',usuario)
dw_des.setitem(donde,'item',j)
dw_des.setitem(donde,'num_cobro',i_ndoc)
dw_des.setitem(donde,'coddoc',i_coddoc)
dw_des.setitem(donde,'clugar',i_clug)
dw_des.setitem(donde,'fecha',datetime(today(),now()))
dw_des.setitem(donde,'fecha_audita',datetime(today(),now()))
dw_des.scrolltorow(donde)
if idw_des.rowcount()=1 then dw_des.setitem(donde,'cartipo',idw_des.getitemstring(1,1))
dw_des.setfocus()
pb_newdes.enabled=false
calc_totales()
cambio=true
return donde
end event

type dw_des from datawindow within tp_des
integer x = 32
integer y = 32
integer width = 4233
integer height = 1056
integer taborder = 40
string title = "none"
string dataobject = "dw_car_cpo_desc_ajus"
boolean hscrollbar = true
boolean vscrollbar = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;settransobject(sqlca)
getchild('cartipo',idw_des)
idw_des.settransobject(sqlca)
string traer[2]
traer[1]='2'
traer[2]='J'
idw_des.retrieve(traer)
object.compute_2.visible=0

end event

event itemchanged;accepttext()
cambio=true
if dwo.name='valor' or dwo.name='cartipo' then 
	
	if tab_1.tp_det.dw_det.dataobject='dw_car_cpo_radica'	 then 
		if dwo.name='cartipo' and  tab_1.tp_det.dw_det.getItemString(tab_1.tp_det.dw_det.getrow(),'tipo_rad')='F' then
			string ls_crt
			int li_fila

			ls_crt=getitemstring(getrow(),'cartipo')
			li_fila=idw_des.find("cartipo='"+ls_crt+"'",1,idw_des.rowcount())
			if li_fila>0 then 
				setitem(getrow(),'operacion',idw_des.getitemnumber(li_fila,'operacion'))
				if idw_des.getitemstring(li_fila,'dian')='1' then
					setitem(getrow(),'dian','1')
				end if
			end if
		end if
	end if
	
	if dwo.name='valor' then
		if dec(data)>dw_cab.getitemnumber(1,'pendiente') then
			setitem(getrow(),'valor',0)
			settext(string(getitemnumber(getrow(),'valor')))
			return 1
		end if	
	end if // pa que no valide esto se coloco en comentarios 2006-06-23

	if dwo.name='fecha' then
		datetime fec_rad,fec_hoy
   		fec_hoy=datetime(today(),now())
		fec_rad=dw_cab.GetItemDateTime(dw_cab.getrow(),"fecha")
		if f_valida_fecha(getitemdatetime(getrow(),'fecha'))=-1  then return 1
		if datetime(data)>fec_hoy or datetime(data)<fec_rad then
			messagebox("Atención",'Fecha debe estar entre '+string(fec_rad,'dd/mm/yyyy')+' y el '+string(fec_hoy,'dd/mm/yyyy')+' verifique')
			return 1
		End If
		if f_docu_cartera(datetime(data))=-1 then return 1
	End If
	IF calc_totales()<0 then 
		messagebox("Atención",'El saldo no puede ser negativo verifique los datos')
		setitem(getrow(),'valor',0)
		return 1
	End If
end if

end event

event rowfocuschanged;mle_1.text=''
if getrow()<1 then return
mle_1.text=getitemstring(getrow(),'observaciones')

string ls_crt
int li_fila
if tab_1.tp_det.dw_det.rowcount()>0 then
	if tab_1.tp_det.dw_det.dataobject='dw_car_cpo_radica'	 then 	
		if  tab_1.tp_det.dw_det.getItemString(tab_1.tp_det.dw_det.getrow(),'tipo_rad')='F' then
			ls_crt=getitemstring(getrow(),'cartipo')
			li_fila=idw_des.find("cartipo='"+ls_crt+"'",1,idw_des.rowcount())
			if idw_des.getitemstring(li_fila,'dian')='1' then
				if isnull(getitemstring(getrow(),'estado_dian_nota')) or getitemstring(getrow(),'estado_dian_nota')='2'  or getitemstring(getrow(),'estado_dian_nota')='0 'then
					pb_diann.enabled=true
				else
					pb_diann.enabled=false
				end if
				pb_connota.enabled=true
				pb_impnota.enabled=true
			else
				pb_diann.enabled=false
				pb_connota.enabled=false
				pb_impnota.enabled=false
			end if
		end if
	end if
end if
end event

event dberror;return f_dw_error(sqldbcode,sqlsyntax,sqlerrtext,classname())
end event

event sqlpreview;if sqlType = PreviewUpdate!	then
	if pos(sqlsyntax,'fecha_anula') = 0 then Return 0
	string cd, cl, ct, msg
	double nc, it
	cd = dw_des.getItemString(row,'coddoc')
	cl = dw_des.getItemString(row,'clugar')
	nc = dw_des.getItemNumber(row,'num_cobro')
	ct = dw_des.getItemString(row,'cartipo')
	it = dw_des.getItemNumber(row,'item')
	delete from car_cobro_rad where coddoc=:cd and clugar=:cl and num_cobro=:nc and
	cartipo=:ct and item=:it;
	IF SQLCA.SQLCode = -1 THEN
		msg = SQLCA.SQLErrText
		rollback;
		MessageBox("SQL error", msg)
		Return -1
	END IF
end if

end event

type tp_pag from userobject within tab_1
integer x = 18
integer y = 112
integer width = 6789
integer height = 1112
long backcolor = 67108864
string text = "Pagos"
long tabtextcolor = 33554432
string picturename = "factura.ico"
long picturemaskcolor = 536870912
string powertiptext = "Historial de pagos realizados al cobro"
tab_2 tab_2
end type

on tp_pag.create
this.tab_2=create tab_2
this.Control[]={this.tab_2}
end on

on tp_pag.destroy
destroy(this.tab_2)
end on

type tab_2 from tab within tp_pag
event create ( )
event destroy ( )
integer width = 6766
integer height = 1096
integer taborder = 10
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long backcolor = 67108864
boolean fixedwidth = true
boolean raggedright = true
boolean focusonbuttondown = true
boolean powertips = true
alignment alignment = center!
integer selectedtab = 1
tp_0 tp_0
tp_1 tp_1
tp_2 tp_2
end type

on tab_2.create
this.tp_0=create tp_0
this.tp_1=create tp_1
this.tp_2=create tp_2
this.Control[]={this.tp_0,&
this.tp_1,&
this.tp_2}
end on

on tab_2.destroy
destroy(this.tp_0)
destroy(this.tp_1)
destroy(this.tp_2)
end on

type tp_0 from userobject within tab_2
integer x = 18
integer y = 112
integer width = 6729
integer height = 968
long backcolor = 67108864
string text = "Ingresos"
long tabtextcolor = 33554432
string picturename = "devolucion.ico"
long picturemaskcolor = 536870912
string powertiptext = "Ingresos del Tercero pendientes de Distribuir"
pb_5 pb_5
st_5 st_5
d1 d1
pb_new_pago pb_new_pago
dw_pend dw_pend
end type

on tp_0.create
this.pb_5=create pb_5
this.st_5=create st_5
this.d1=create d1
this.pb_new_pago=create pb_new_pago
this.dw_pend=create dw_pend
this.Control[]={this.pb_5,&
this.st_5,&
this.d1,&
this.pb_new_pago,&
this.dw_pend}
end on

on tp_0.destroy
destroy(this.pb_5)
destroy(this.st_5)
destroy(this.d1)
destroy(this.pb_new_pago)
destroy(this.dw_pend)
end on

type pb_5 from picturebutton within tp_0
integer x = 5733
integer y = 272
integer width = 146
integer height = 128
integer taborder = 70
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean originalsize = true
string picturename = "import.gif"
string disabledname = "d_import.gif"
string powertiptext = "Sube Pagos Archivo"
end type

event clicked;dw_pag.reset()
if messageBox('Aviso','Esta seguro de comparar el documento seleccionado modificara datos?',QUESTION!,YESNO!) = 2 then
	Return
end if

string ls_range ,ls_path, ls_file,ls_ban,ls_cta
string ls_lfac,ls_tfac,ls_td,ls_doc,ls_return
string log_txt
datetime ld_fecp
integer ll_rc,li_item,l_cols,ll_rows,i_numar=-1
double ld_nfac
dec ld_valor
oleobject loo_excel

//crear excel
if  GetFileOpenName("Abrir" ,ls_path, ls_file," ","Excel 2007 o posterior (*.xlsx)*.xlsx") <> 1 then
	return
end if
loo_excel = create OLEObject
loo_excel.ConnectToNewobject("excel.application")
loo_excel.visible = false
loo_excel.workbooks.open( ls_path )
loo_excel.worksheets(1).Activate
ll_rows =loo_excel.worksheets(1).Usedrange.rows.count

// Copy the used range of data to the clipboard
ls_range = "A1:" + "K" + string(ll_rows)
loo_excel.Worksheets(1).Range(ls_range).Copy
ll_rc = dw_pag.importclipboard() 
clipboard(' ')
loo_excel.workbooks.close
loo_excel.disconnectobject()
Destroy loo_excel

if ll_rc<0 then return

hpb_1.visible=true
hpb_1.Position = 0
hpb_1.MinPosition = 0
dw_pend.SetRedraw(FALSE)

//Abre log
log_txt=mid(ls_path,1,pos(ls_path,'.') -1)+'.txt'
i_numar=fileopen(log_txt,LineMode!,write!)
if i_numar=-1 then
	messagebox("Atención",'No se puede crear el archivo de log')
	return
end if
filewrite(i_numar,'Inicia proceso'+String(Today(), "dd/mm/yyyy hh:mm:ss"))
for  ll_rc=1 to dw_pag.rowcount()
	ls_ban=dw_pag.getitemstring(ll_rc,'codbanco')
	ls_cta=LeftTrim(RightTrim(dw_pag.getitemstring(ll_rc,'numcuenta')))
	li_item=dw_pag.getitemnumber(ll_rc,'item')
	ld_nfac=dw_pag.getitemnumber(ll_rc,'n_fac')
	ls_lfac=dw_pag.getitemstring(ll_rc,'l_fac')
	ls_tfac=dw_pag.getitemstring(ll_rc,'t_fac')
	ld_fecp=dw_pag.getitemdatetime(ll_rc,'fecha')
	ld_valor=dw_pag.getitemnumber(ll_rc,'valor')
	ls_td=dw_pag.getitemstring(ll_rc,'td')
	ls_doc=dw_pag.getitemstring(ll_rc,'docu')	
	if g_motor='postgres' then 
		SELECT * into :ls_return from sp_pagos_cartera_aplica(:ls_ban,:ls_cta,:li_item,:ld_nfac,:ls_lfac,:ls_tfac,:ld_fecp,:ld_valor,:ls_td,:ls_doc,:usuario);
	end if
	ls_return='Fila '+string(ll_rc)+' ----> '+ls_return
	filewrite(i_numar,ls_return)
	hpb_1.Position =ll_rc
next
filewrite(i_numar,'Fin proceso'+String(Today(), "dd/mm/yyyy hh:mm:ss"))
fileclose(i_numar)
hpb_1.visible=false
messagebox('Atención', 'Proceso finalizado') 
end event

type st_5 from statictext within tp_0
integer x = 27
integer y = 24
integer width = 197
integer height = 52
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Origen:"
boolean focusrectangle = false
end type

type d1 from dropdownlistbox within tp_0
integer x = 320
integer y = 16
integer width = 837
integer height = 324
integer taborder = 20
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
string item[] = {"CAJA MAYOR","NOTAS BANCARIAS"}
borderstyle borderstyle = stylelowered!
end type

event selectionchanged;if dw_hist.rowcount()=0 then return
dw_pend.border=true
choose case text
	case 'CAJA MAYOR' //ing directos
		if dw_pend.dataobject<>'dw_ingresos_a_cartera' then
			dw_pend.dataobject='dw_ingresos_a_cartera'
			dw_pend.settransobject(sqlca)
		end if
	case 'NOTAS BANCARIAS' //Notas
		if dw_pend.dataobject<>'dw_notas_a_cart_2' then
			dw_pend.dataobject='dw_notas_a_cart_2'
			dw_pend.settransobject(sqlca)
		end if
//	case 'MANUAL'
//		dw_pend.border=false
//		if dw_pend.dataobject<>'dw_pago_cart_manual' then
//			dw_pend.dataobject='dw_pago_cart_manual'
//			dw_pend.settransobject(sqlca)
//			dw_pend.getchild("cuenta_che",idw_cuenta)
//			idw_cuenta.settransobject(sqlca)
//		end if
//		dw_pend.reset()
//		dw_pend.insertrow(1)
//		dw_pend.setitem(1,'fecha',datetime(today()))
//		return
end choose
dw_pend.retrieve(dw_hist.getitemstring(i_fila,'tipodoc'),dw_hist.getitemstring(i_fila,'documento'))

end event

event constructor;text='NOTAS BANCARIAS'
end event

type pb_new_pago from picturebutton within tp_0
integer x = 5728
integer y = 124
integer width = 146
integer height = 128
integer taborder = 60
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean originalsize = true
string picturename = "llevar.gif"
string disabledname = "d_llevar.gif"
string powertiptext = "Registrar Nuevo Pago"
end type

event clicked;long donde,j,k
if dw_cab.rowcount()=0 then return
if not isnull(dw_cab.getitemstring(1,'estado')) then return
if dw_cab.getitemstring(1,'cxp')='1' then 
	messagebox("Atención",'No puede realizar pagos a un Anticipo')
	return
end if
if (dw_cab.getitemstring(1,'cxp')='2' or dw_cab.getitemstring(1,'cxp')='3')and i_nuevo then
	messagebox("Atención",'Debe primero guardar para poder insertar un registro de Pagos')
	return -1
end if
if dw_pend.rowcount()=0 then return -1
if dw_pend.accepttext()=-1 then return -1
if dw_pend.getitemnumber(1,'total')<=0 then return -1
//If dw_pend.getitemnumber(1,'total') > dw_cab.getitemnumber(1,'vtcancelar') then
If dw_pend.getitemnumber(1,'total') > dw_cab.getitemnumber(1,'pendiente') then
	messagebox("Atención",'El total de los Pagos no puede ser superior al valor de cobro verifique los datos')
	return -1
End If
if dw_pend.dataobject='dw_pago_cart_manual' then
	if isnull(dw_pend.getitemdatetime(1,'fecha')) then
		messagebox('Atención','No puede tener la fecha nula')
		return -1
	end if
	if dw_pend.getitemdatetime(1,'fecha')<dw_hist.getitemdatetime(dw_hist.getrow(),'fecha') or date(dw_pend.getitemdatetime(1,'fecha'))>today()  then
		messagebox('Atención','La fecha del pago no debe ser menor a la fecha del cobro ni posterior a hoy')
		return -1
	end if
	if isnull(dw_pend.getitemstring(1,'num_che')) then
		messagebox('Atención','debe digitar el nro del cheque o transferencia')
		return -1
	end if
end if

donde=tab_1.tp_pag.tab_2.tp_1.dw_pagos.insertrow(0)
tab_1.tp_pag.tab_2.tp_1.dw_pagos.setrow(donde)
for j=1 to tab_1.tp_pag.tab_2.tp_1.dw_pagos.rowcount()
	if tab_1.tp_pag.tab_2.tp_1.dw_pagos.find('item='+string(j),1,tab_1.tp_pag.tab_2.tp_1.dw_pagos.rowcount())=0 then exit
next

tab_1.tp_pag.tab_2.tp_1.dw_pagos.setitem(donde,'item',j)
tab_1.tp_pag.tab_2.tp_1.dw_pagos.setitem(donde,'num_cobro',i_ndoc)
tab_1.tp_pag.tab_2.tp_1.dw_pagos.setitem(donde,'coddoc',i_coddoc)
tab_1.tp_pag.tab_2.tp_1.dw_pagos.setitem(donde,'clugar',i_clug)
if dw_pend.dataobject='dw_pago_cart_manual' then
	tab_1.tp_pag.tab_2.tp_1.dw_pagos.setitem(donde,'fecha',dw_pend.getitemdatetime(1,'fecha'))
else
	tab_1.tp_pag.tab_2.tp_1.dw_pagos.setitem(donde,'fecha',datetime(today(),now()))
end if
tab_1.tp_pag.tab_2.tp_1.dw_pagos.setitem(donde,'fecha_audita',datetime(today(),now()))
tab_1.tp_pag.tab_2.tp_1.dw_pagos.setitem(donde,'valor',dw_pend.getitemnumber(1,'total'))
if idw_pago.rowcount()=1 then tab_1.tp_pag.tab_2.tp_1.dw_pagos.setitem(donde,'cartipo',idw_pago.getitemstring(1,1))
tab_1.tp_pag.tab_2.tp_1.dw_pagos.setfocus()
tab_1.tp_pag.tab_2.tp_1.dw_pagos.setitem(donde,'origen_pag','P')
datawindow dw_t
if dw_pend.dataobject='dw_pago_cart_manual' then
	dw_t=tab_1.tp_pag.tab_2.tp_1.dw_det_pag_manu
	tab_1.tp_pag.tab_2.tp_1.dw_pagos.setitem(donde,'origen_pag','M')
	dw_t.insertrow(1)
	dw_t.setitem(1,'clugar',i_clug)
	dw_t.setitem(1,'coddoc',i_coddoc)
	dw_t.setitem(1,'num_cobro',i_ndoc)
	dw_t.setitem(1,'item',j)
	dw_t.setitem(1,'subitem',1)
	if dw_pend.getitemstring(1,'forma')='C' then
		dw_t.setitem(1,'forma','2')
	else
		dw_t.setitem(1,'forma','4')
	end if
	dw_t.setitem(1,'valor',dw_pend.getitemnumber(1,'valor'))
	dw_t.setitem(1,'banco_che',dw_pend.getitemstring(1,'banco_che'))
	dw_t.setitem(1,'cuenta_che',dw_pend.getitemstring(1,'cuenta_che'))
	dw_t.setitem(1,'num_che',dw_pend.getitemstring(1,'num_che'))
	dw_t.setitem(1,'banco_trans',dw_pend.getitemstring(1,'banco_trans'))
	dw_t.setitem(1,'tipo_cuenta_trans',dw_pend.getitemstring(1,'tipo_cuenta_trans'))
	dw_t.setitem(1,'cuenta_trans',dw_pend.getitemstring(1,'cuenta_trans'))
	dw_t.setitem(1,'descripcion',dw_pend.getitemstring(1,'descripcion'))
	tab_1.tp_pag.tab_2.selectedtab=2
	tab_1.tp_pag.tab_2.tp_1.dw_pagos.event rowfocuschanged(donde)
	calc_totales()
	return donde
end if
if dw_cab.getitemstring(1,'cxp')<>'3' then//3 son pagares	
	if d1.text='NOTAS BANCARIAS' then
		tab_1.tp_pag.tab_2.tp_1.dw_pagos.setitem(donde,'origen_pag','N')
		dw_t=tab_1.tp_pag.tab_2.tp_1.dw_det_pag_nota
	else
		tab_1.tp_pag.tab_2.tp_1.dw_pagos.setitem(donde,'origen_pag','I')
		dw_t=tab_1.tp_pag.tab_2.tp_1.dw_ing
	end if
	for j=1 to dw_pend.rowcount()
		if dw_pend.getitemnumber(j,'registrar')>0 then
			k=dw_t.insertrow(0)
			if d1.text='NOTAS BANCARIAS' then
				dw_t.setitem(k,'codbanco',dw_pend.getitemstring(j,'codbanco'))
				dw_t.setitem(k,'tipo_cuenta',dw_pend.getitemstring(j,'tipo_cuenta'))
				dw_t.setitem(k,'numcuenta',dw_pend.getitemstring(j,'numcuenta'))
				dw_t.setitem(k,'clugar',clugar)
				dw_t.setitem(k,'item',dw_pend.getitemnumber(j,'item'))
			else
				dw_t.setitem(k,'codcaja',dw_pend.getitemstring(j,'codcaja'))
				dw_t.setitem(k,'clugar',dw_pend.getitemstring(j,'clugar'))
				dw_t.setitem(k,'coddoc',dw_pend.getitemstring(j,'coddoc'))
				dw_t.setitem(k,'ningreso',dw_pend.getitemnumber(j,'ningreso'))
			end if
			dw_t.setitem(k,'valor',dw_pend.getitemnumber(j,'registrar'))
			dw_t.setitem(k,'item_pag',tab_1.tp_pag.tab_2.tp_1.dw_pagos.getitemnumber(donde,'item'))
			dw_t.setitem(k,'clugar_pag',i_clug)
			dw_t.setitem(k,'coddoc_pag',i_coddoc)
			dw_t.setitem(k,'num_cobro',i_ndoc)
		end if
	next
end if
tab_1.tp_pag.tab_2.tp_1.dw_pagos.event rowfocuschanged(donde)
IF calc_totales()<0 then 
	messagebox("Atención",'El saldo no puede ser negativo verifique los datos')
	return 1
End If
tab_1.tp_pag.tab_2.selectedtab=2
calc_totales()
enabled=false
cambio=true
return donde
end event

type dw_pend from datawindow within tp_0
integer x = 18
integer y = 120
integer width = 5659
integer height = 808
integer taborder = 60
string title = "none"
string dataobject = "dw_notas_a_cart_2"
boolean hscrollbar = true
boolean vscrollbar = true
borderstyle borderstyle = stylelowered!
end type

event constructor;settransobject(sqlca)
getchild('codcaja',idw_caja)
idw_caja.settransobject(sqlca)


end event

event rbuttondown;st_dw_xa_funciones st_dw
st_dw.dw=this
st_dw.dwo=dwo
st_dw.row=row
st_dw.color_fondo=string(rgb(255,255,255))
openwithparm(w_funcion_dw,st_dw)
end event

event itemchanged;if dataobject='dw_pago_cart_manual' then
	if dwo.name='banco_che' then
		string nulo
		setnull(nulo)
		setitem(row,'cuenta_che',nulo)
		idw_cuenta.retrieve(data)
	end if
end if
if dwo.name='registrar' then
	AcceptText()
	If dw_pend.getitemnumber(1,'total') > dw_cab.getitemnumber(1,'vtcancelar') then
		messagebox("Atención",'El total de los Pagos no puede ser superior al valor de cobro verifique los datos')
		return -1
	End If
End if

end event

type tp_1 from userobject within tab_2
event create ( )
event destroy ( )
integer x = 18
integer y = 112
integer width = 6729
integer height = 968
long backcolor = 67108864
string text = "Pagos"
long tabtextcolor = 33554432
string picturename = "pagos.ico"
long picturemaskcolor = 536870912
string powertiptext = "Historial de Pagos realizados al cobro"
pb_dist_pago pb_dist_pago
st_4 st_4
st_3 st_3
pb_delpago pb_delpago
dw_pagos dw_pagos
dw_det_pag_nota dw_det_pag_nota
dw_ing dw_ing
dw_det_pag_manu dw_det_pag_manu
dw_det_abono dw_det_abono
end type

on tp_1.create
this.pb_dist_pago=create pb_dist_pago
this.st_4=create st_4
this.st_3=create st_3
this.pb_delpago=create pb_delpago
this.dw_pagos=create dw_pagos
this.dw_det_pag_nota=create dw_det_pag_nota
this.dw_ing=create dw_ing
this.dw_det_pag_manu=create dw_det_pag_manu
this.dw_det_abono=create dw_det_abono
this.Control[]={this.pb_dist_pago,&
this.st_4,&
this.st_3,&
this.pb_delpago,&
this.dw_pagos,&
this.dw_det_pag_nota,&
this.dw_ing,&
this.dw_det_pag_manu,&
this.dw_det_abono}
end on

on tp_1.destroy
destroy(this.pb_dist_pago)
destroy(this.st_4)
destroy(this.st_3)
destroy(this.pb_delpago)
destroy(this.dw_pagos)
destroy(this.dw_det_pag_nota)
destroy(this.dw_ing)
destroy(this.dw_det_pag_manu)
destroy(this.dw_det_abono)
end on

type pb_dist_pago from picturebutton within tp_1
integer x = 3355
integer y = 52
integer width = 146
integer height = 128
integer taborder = 80
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean originalsize = true
string picturename = "distrib.gif"
string powertiptext = "Distribuir Pago"
end type

event clicked;dwItemStatus l_status
long fila
fila = tab_1.tp_det.dw_det.Find("cartipo='CR'",1,tab_1.tp_det.dw_det.rowCount())
l_status = dw_pagos.GetItemStatus(dw_pagos.getRow(), 0, Primary!)
if l_status = NotModified! and fila > 0 then
	st_pagos st_p
	st_p.coddoc = dw_cab.getItemString(dw_cab.getrow(),'coddoc')
	st_p.clugar = dw_cab.getItemString(dw_cab.getrow(),'clugar')
	st_p.num_cobro = dw_cab.getItemNumber(dw_cab.getrow(),'num_cobro')
	st_p.cartipo = dw_pagos.getItemString(dw_pagos.getrow(),'cartipo')	
	st_p.item = dw_pagos.getItemNumber(dw_pagos.getrow(),'item')
//	st_p.nradica = dw_cab.getItemNumber(dw_cab.getrow(),'nradica')
//	st_p.clugar_rad = dw_cab.getItemString(dw_cab.getrow(),'clugar_rad')
	st_p.nradica = tab_1.tp_det.dw_det.getItemNumber(fila,'num_radicacion')
	st_p.clugar_rad = tab_1.tp_det.dw_det.getItemString(fila,'clugar_rad')
	st_p.tipo_rad = tab_1.tp_det.dw_det.getItemString(fila,'tipo_rad')
	st_p.dw_pagos = dw_pagos
	st_p.origen='P'
	st_p.decimales=i_dec_gral_car
	openwithparm(w_dist_pagos,st_p)
else
	MessageBox('Atención','Debe guardar para distribuir montos entre facturas')
end if

end event

type st_4 from statictext within tp_1
integer x = 3538
integer y = 4
integer width = 453
integer height = 52
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Detalle de Ingresos:"
alignment alignment = center!
boolean focusrectangle = false
end type

type st_3 from statictext within tp_1
integer x = 9
integer width = 366
integer height = 52
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Pagos del Cobro"
alignment alignment = center!
boolean focusrectangle = false
end type

type pb_delpago from picturebutton within tp_1
integer x = 3355
integer y = 200
integer width = 146
integer height = 128
integer taborder = 70
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
string picturename = "borrar_fila.gif"
alignment htextalign = right!
string powertiptext = "Anular Pago"
end type

event clicked;long fila,j
	
fila=dw_pagos.getrow()
if fila<1 then return
if isnull(dw_pagos.getitemstring(fila,'estado')) = false then 
	messagebox('Atención','Este pago ya se encuentra anulado no lo puede anular')
	return
end if
if dw_pagos.describe("evaluate('IsRowNew()',"+string(fila)+')')='true' then
	choose case dw_pagos.getitemstring(fila,'origen_pag')
		case 'P' //pagare
			do while dw_det_abono.rowcount()>0
				dw_det_abono.deleterow(0)
			loop
		case 'I' //ingreso caja mayor
			do while dw_ing.rowcount()>0
				dw_ing.deleterow(0)
			loop
		case 'N'// nota
			do while dw_det_pag_nota.rowcount()>0
				do while dw_amtz.rowcount()>0
					dw_amtz.deleterow(0)
				loop
				dw_det_pag_nota.deleterow(0)
			loop
		case 'M'//manual
			do while dw_det_pag_manu.rowcount()>0
				dw_det_pag_manu.deleterow(0)
			loop
	end choose
	dw_pagos.deleterow(fila)
else
	string ls_clug,ls_cdoc,ls_cart,ls_cemp
	double ldb_ncob,ldb_item
	int li_año
	
	if dw_pagos.getitemstring(fila,'contabil')='C' then 
		ls_clug=dw_pagos.getitemstring(fila,'clugar')
		ls_cdoc=dw_pagos.getitemstring(fila,'coddoc')
		ldb_ncob=dw_pagos.getitemnumber(fila,'num_cobro')
		ls_cart=dw_pagos.getitemstring(fila,'cartipo')
		ldb_item=dw_pagos.getitemnumber(fila,'item')

		//Para Validar que este ne la vigencia de la anulacion
		select distinct 
			cont_doc_cab.cod_empresa, cont_doc_cab.ano into :ls_cemp,:li_año
		FROM 
			cont_doc_cab INNER JOIN cont_doc_cp ON (cont_doc_cab.ndoc = cont_doc_cp.ndoc) 
			AND (cont_doc_cab.cdoc = cont_doc_cp.cdoc) AND (cont_doc_cab.mes = cont_doc_cp.mes) 
			AND (cont_doc_cab.ano = cont_doc_cp.ano) AND (cont_doc_cab.cod_empresa = cont_doc_cp.cod_empresa)
		WHERE 
			(((cont_doc_cab.estado)='3') 
			AND ((cont_doc_cp.clugar_doc)=:ls_clug) 
			AND ((cont_doc_cp.cdocr)=:ls_cdoc) 
			AND ((cont_doc_cp.ndocr)=:ldb_ncob) 
			AND ((cont_doc_cp.llave4)=:ls_cart) 
			AND ((cont_doc_cp.llave5)=:ldb_item));
			
		setnull(ls_clug)
		select 
			cierre_anyo into :ls_clug
		from
			cont_cierre
		where 
				(((cont_cierre.cod_empresa)=:ls_cemp) AND ((cont_cierre.ano)=:li_año) AND ((cont_cierre.cierre_anyo)='1'));
 
		if ls_clug='1' then
			messagebox('Atención','Este pago ya se encuentra contabilizado y el año contable esta cerrado')
			return
		end if
	end if

	st_xa_anular st_anula
	st_anula.tipo='CA'
	openwithparm (w_motiv_anula,st_anula)
	st_anula=message.powerobjectparm
	if not isValid(st_anula) then return
	datetime fecha
	fecha=datetime(today(),now())
	dw_pagos.setitem(fila,'estado',usuario)
	dw_pagos.setitem(fila,'fecha_anula',fecha)
	dw_pagos.setitem(fila,'motiv_anula',st_anula.observacion)
	dw_pagos.setitem(fila,'cod_anula',st_anula.motivo)
	if dw_pagos.getitemstring(fila,'contabil')='C' then 
		dw_pagos.setitem(fila,'contabil_anul','P')
	end if

	string cod_cajam,clug_cajam,motiv1,coddoc_cajam,cbanco,tcuenta,ncuenta
	long ning_cajam,item
	dec valor
	long nnulo
	string snulo
	setnull(nnulo)
	setnull(snulo)
	
	if dw_pagos.getitemstring(fila,'presupuesto')='1' then 
			
		
	end if	
		
	choose case dw_pagos.getitemstring(fila,'origen_pag')
		case 'P' //pagare
			for j=1 to dw_det_abono.rowcount()
				dw_det_abono.setitem(j,'clug_cob',snulo)
				dw_det_abono.setitem(j,'cdoc_cob',snulo)
				dw_det_abono.setitem(j,'num_cobro',nnulo)
				dw_det_abono.setitem(j,'cartipo',snulo)
				dw_det_abono.setitem(j,'item_pag',nnulo)
			next
		case 'I' //ingreso caja mayor
			for j=1 to dw_ing.rowcount()
				valor=dw_ing.getitemnumber(j,'valor')
				cod_cajam=dw_ing.getitemstring(j,'codcaja')
				clug_cajam=dw_ing.getitemstring(j,'clugar')
				coddoc_cajam=dw_ing.getitemstring(j,'coddoc')
				ning_cajam=dw_ing.getitemnumber(j,'ningreso')
				update tesocajaingreso set valor_cartera=valor_cartera - :valor
				where codcaja=:cod_cajam and clugar=:clug_cajam and coddoc=:coddoc_cajam and ningreso=:ning_cajam;
				if sqlca.sqlcode=-1 then
					messagebox("Error actualizando TesoCajaIngreso",sqlca.sqlerrtext)
					rollback;
					return
				end if
			next
		case 'N'// nota
			for j=1 to dw_det_pag_nota.rowcount()
				valor=dw_det_pag_nota.getitemnumber(j,'valor')
				cbanco=dw_det_pag_nota.getitemstring(j,'codbanco')
				tcuenta=dw_det_pag_nota.getitemstring(j,'tipo_cuenta')
				ncuenta=dw_det_pag_nota.getitemstring(j,'numcuenta')
				item=dw_det_pag_nota.getitemnumber(j,'item')
				update tesocuentasmovi set valor_cartera=valor_cartera - :valor
				where codbanco=:cbanco and tipo_cuenta=:tcuenta and numcuenta=:ncuenta and item=:item and clugar=:clugar;
				if sqlca.sqlcode=-1 then
					messagebox("Error actualizando TesoCuentasmovi",sqlca.sqlerrtext)
					rollback;
					return
				end if
			next
		case 'M'//manual
	end choose
	
	string clug_anti,cdoc_anti
	long nanti
	dec val
	for j=1 to dw_amtz.rowcount()
		clug_anti=dw_amtz.getitemstring(j,'clug_anti')
		cdoc_anti=dw_amtz.getitemstring(j,'coddoc_anti')
		nanti=dw_amtz.getitemnumber(j,'num_cobro_anti')
		val=dw_amtz.getitemnumber(j,'valor')
		update car_cobro_cab set v_amortizado=v_amortizado - :val where
		clugar=:clug_anti and coddoc=:cdoc_anti and num_cobro=:nanti;
		if sqlca.sqlcode=-1 then
			messagebox("Error actualizando v_amortizado en Car_cobro_cab",sqlca.sqlerrtext)
			goto error
		end if
	next
	do while dw_amtz.rowcount()>0
		dw_amtz.deleterow(0)
	loop
	
	if dw_pagos.update()=-1 then goto error
	if dw_ing.dataobject<>'dw_ing_cobros' then
		if dw_ing.update()=-1 then goto error
	end if
	
	choose case dw_pagos.getitemstring(fila,'origen_pag')
		case 'P' //pagare
			if dw_det_abono.update()=-1 then goto error
		case 'I' //ingreso caja mayor
		case 'N'// nota
			if dw_det_pag_nota.update()=-1 then goto error
		case 'M'//manual
			if dw_det_pag_manu.update()=-1 then goto error
	end choose
end if

if dw_hist.getitemstring(i_fila,'cxp')='3' then
	tab_1.tp_pag.tab_2.tp_0.dw_pend.retrieve(dw_hist.getitemnumber(i_fila,'npagare'),dw_hist.getitemstring(i_fila,'clug_pag'))
else
	tab_1.tp_pag.tab_2.tp_0.d1.triggerevent(selectionchanged!)
end if
calc_totales()
if grabar()=-1 then 
	rollback;
else
	commit;
end if
return

error:
rollback;
string nulo
setnull(nulo)
dw_pagos.setitem(fila,'estado',nulo)

end event

type dw_pagos from datawindow within tp_1
integer x = 9
integer y = 52
integer width = 3323
integer height = 892
integer taborder = 30
string title = "none"
string dataobject = "dw_car_cpo_pagos"
boolean hscrollbar = true
boolean vscrollbar = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;settransobject(sqlca)
getchild('cartipo',idw_pago)
idw_pago.settransobject(sqlca)
idw_pago.retrieve('1')
end event

event itemchanged;cambio=true
accepttext()
long donde,j
datawindow dw
dw=tab_1.tp_pag.tab_2.tp_2.dw_pago
st_amortizar st
string snulo
setnull(snulo)
setitem(getrow(),'usuario',usuario)
if dwo.name='valor' or dwo.name='cartipo' then
	if getitemnumber(getrow(),'valor')>dw_cab.getitemnumber(1,'pendiente') then
		setitem(getrow(),'valor',0)
		settext(string(getitemnumber(getrow(),'valor')))
		messagebox("Atención",'Supera el valor Pendiente de la Radicación')
		return 1
	end if	
	dw.reset()
	donde=tab_1.tp_pag.tab_2.tp_2.pb_newdet.event clicked()
	dw.setitem(donde,'valor',dec(data))
	setitem(row,'a_amortizar',0)
	if idw_pago.getitemstring(idw_pago.find('cartipo="'+getitemstring(row,'cartipo')+'"',1,idw_pago.rowcount()),'amortizar')='1' then
		st.dw_cab=dw_cab
		st.dw_cpo=this
		openwithparm(w_amortiza_pago,st)
		if message.stringparm='!' then 
			setitem(row,'cartipo',snulo)
		end if
	end if
end if
if dwo.name='cartipo' then
	setitem(row,'a_amortizar',0)
	do while dw_amtz.rowcount()>0
		dw_amtz.deleterow(0)
	loop
	if idw_pago.getitemstring(idw_pago.getrow(),'amortizar')='1' then
		st.dw_cab=dw_cab
		st.dw_cpo=this
		openwithparm(w_amortiza_pago,st)
		if message.stringparm='!'then
			setitem(row,'cartipo',snulo)
			settext(snulo)
			return 1
		end if
	end if
	for j=1 to dw.rowcount()
		dw.setitem(j,'cartipo',data)
	next
end if
if dwo.name='valor' or dwo.name='cartipo' then calc_totales()
if dwo.name='codcaja' then
	for j=1 to rowcount()
		if row=j then continue
		if describe("evaluate('isrownew()',"+string(j)+")")='true' then
			setitem(j,'codcaja',data)
		end if
	next
end if

if dwo.name='fecha' then
	datetime fec_rad,fec_hoy
   	fec_hoy=datetime(today(),now())
	fec_rad=dw_cab.GetItemDateTime(dw_cab.getrow(),"fecha")
	if f_valida_fecha(getitemdatetime(getrow(),'fecha'))=-1  then return 1
	if datetime(data)>fec_hoy or datetime(data)<fec_rad then
		messagebox("Atención",'Fecha debe estar entre '+string(fec_rad,'dd/mm/yyyy')+' y el '+string(fec_hoy,'dd/mm/yyyy')+' verifique')
		return 1
	End If
	if f_docu_cartera(datetime(data))=-1 then return 1
End If
end event

event rowfocuschanged;if getrow()=0 or rowcount()=0 or dw_hist.rowcount()=0 then return
if isnull(getitemnumber(currentrow,'item')) then return
if dw_hist.getitemstring(dw_hist.getrow(),'cxp')='3' then
	tab_1.tp_pag.tab_2.tp_1.dw_det_abono.visible=true
	tab_1.tp_pag.tab_2.tp_1.dw_det_abono.setfilter('item_pag='+string(getitemnumber(currentrow,'item')))
	tab_1.tp_pag.tab_2.tp_1.dw_det_abono.filter()
	tab_1.tp_pag.tab_2.tp_1.dw_ing.visible=false
	tab_1.tp_pag.tab_2.tp_1.dw_det_pag_manu.visible=false
	tab_1.tp_pag.tab_2.tp_1.dw_det_pag_nota.visible=false
elseif getitemstring(getrow(),'origen_pag')='I' then 
	tab_1.tp_pag.tab_2.tp_1.dw_ing.visible=true
	tab_1.tp_pag.tab_2.tp_1.dw_ing.setfilter('item_pag='+string(getitemnumber(currentrow,'item')))
	tab_1.tp_pag.tab_2.tp_1.dw_ing.filter()
	tab_1.tp_pag.tab_2.tp_1.dw_det_abono.visible=false
	tab_1.tp_pag.tab_2.tp_1.dw_det_pag_manu.visible=false
	tab_1.tp_pag.tab_2.tp_1.dw_det_pag_nota.visible=false
elseif getitemstring(getrow(),'origen_pag')='M' then 
	tab_1.tp_pag.tab_2.tp_1.dw_det_pag_manu.visible=true
	tab_1.tp_pag.tab_2.tp_1.dw_det_pag_manu.setfilter('item='+string(getitemnumber(currentrow,'item')))
	tab_1.tp_pag.tab_2.tp_1.dw_det_pag_manu.filter()
	tab_1.tp_pag.tab_2.tp_1.dw_det_abono.visible=false
	tab_1.tp_pag.tab_2.tp_1.dw_ing.visible=false
	tab_1.tp_pag.tab_2.tp_1.dw_det_pag_nota.visible=false
else
	tab_1.tp_pag.tab_2.tp_1.dw_det_pag_nota.visible=true
	tab_1.tp_pag.tab_2.tp_1.dw_det_pag_nota.setfilter('item_pag='+string(getitemnumber(currentrow,'item')))
	tab_1.tp_pag.tab_2.tp_1.dw_det_pag_nota.filter()
	tab_1.tp_pag.tab_2.tp_1.dw_det_abono.visible=false
	tab_1.tp_pag.tab_2.tp_1.dw_ing.visible=false
	tab_1.tp_pag.tab_2.tp_1.dw_det_pag_manu.visible=false
end if
if isnull(getitemnumber(currentrow,'item')) or isnull(getitemstring(currentrow,'cartipo'))	then
	dw_amtz.setfilter('isnull(item_pago)')
else
	dw_amtz.setfilter('item_pago='+string(getitemnumber(currentrow,'item'))+' and cartipo_pago="'+getitemstring(currentrow,'cartipo')+'"')
end if
dw_amtz.filter()

end event

event dberror;return f_dw_error(sqldbcode,sqlsyntax,sqlerrtext,classname())
end event

event clicked;if row > 0 and getrow() <> row then setRow(row)

end event

event sqlpreview;if sqlType = PreviewUpdate!	then
	if pos(sqlsyntax,'fecha_anula') = 0 then Return 0
	string cd, cl, ct, msg
	double nc, it
	cd = getItemString(row,'coddoc')
	cl = getItemString(row,'clugar')
	nc = getItemNumber(row,'num_cobro')
	ct = getItemString(row,'cartipo')
	it = getItemNumber(row,'item')
	delete from car_cobro_rad where coddoc=:cd and clugar=:cl and num_cobro=:nc and
	cartipo=:ct and item=:it;
	IF SQLCA.SQLCode = -1 THEN
		msg = SQLCA.SQLErrText
		rollback;
		MessageBox("SQL error", msg)
		Return -1
	END IF
end if

end event

type dw_det_pag_nota from datawindow within tp_1
string tag = "Nota bancaria N"
boolean visible = false
integer x = 3538
integer y = 60
integer width = 3150
integer height = 888
integer taborder = 100
string title = "none"
string dataobject = "dw_tesbanconot_carpago"
boolean hscrollbar = true
boolean vscrollbar = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;settransobject(sqlca)
end event

event dberror;return f_dw_error(sqldbcode,sqlsyntax,sqlerrtext,classname())
end event

type dw_ing from datawindow within tp_1
string tag = "ingresos directos I"
boolean visible = false
integer x = 3538
integer y = 60
integer width = 2903
integer height = 832
integer taborder = 20
string title = "none"
string dataobject = "dw_ing_cobros"
boolean hscrollbar = true
boolean vscrollbar = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;settransobject(sqlca)
getchild('codcaja',idw_caja2)
idw_caja2.settransobject(sqlca)
end event

event dberror;return f_dw_error(sqldbcode,sqlsyntax,sqlerrtext,classname())
end event

type dw_det_pag_manu from datawindow within tp_1
string tag = "manual M"
boolean visible = false
integer x = 3538
integer y = 60
integer width = 3150
integer height = 832
integer taborder = 90
string title = "none"
string dataobject = "dw_car_pago_cpo"
boolean hscrollbar = true
boolean vscrollbar = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;settransobject(sqlca)
end event

event dberror;return f_dw_error(sqldbcode,sqlsyntax,sqlerrtext,classname())
end event

type dw_det_abono from datawindow within tp_1
string tag = "Pagares P"
boolean visible = false
integer x = 3538
integer y = 60
integer width = 3150
integer height = 888
integer taborder = 80
string title = "none"
string dataobject = "dw_abonos_anula"
boolean hscrollbar = true
boolean vscrollbar = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;settransobject(sqlca)
end event

event dberror;return f_dw_error(sqldbcode,sqlsyntax,sqlerrtext,classname())
end event

type tp_2 from userobject within tab_2
boolean visible = false
integer x = 18
integer y = 112
integer width = 6729
integer height = 968
long backcolor = 67108864
string text = "Detalle"
long tabtextcolor = 33554432
string picturename = "pesos_deta.ico"
long picturemaskcolor = 536870912
string powertiptext = "Forma de pago"
pb_deldet pb_deldet
pb_newdet pb_newdet
dw_pago dw_pago
end type

on tp_2.create
this.pb_deldet=create pb_deldet
this.pb_newdet=create pb_newdet
this.dw_pago=create dw_pago
this.Control[]={this.pb_deldet,&
this.pb_newdet,&
this.dw_pago}
end on

on tp_2.destroy
destroy(this.pb_deldet)
destroy(this.pb_newdet)
destroy(this.dw_pago)
end on

type pb_deldet from picturebutton within tp_2
event mousemove pbm_mousemove
integer x = 6565
integer y = 144
integer width = 142
integer height = 124
integer taborder = 120
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
string picturename = "borrar_fila.GIF"
string disabledname = "d_borrar_fila.GIF"
alignment htextalign = left!
string powertiptext = "Borrar detalle de Ingreso Directo"
end type

event clicked;if tab_1.tp_pag.tab_2.tp_1.dw_pagos.describe("evaluate('isrownew()',"+string(tab_1.tp_pag.tab_2.tp_1.dw_pagos.getrow())+")")='false' then return
dw_pago.deleterow(0)
long j
for j=1 to dw_pago.rowcount()
	dw_pago.setitem(j,"subitem",j)
next
end event

type pb_newdet from picturebutton within tp_2
event mousemove pbm_mousemove
integer x = 6565
integer y = 12
integer width = 142
integer height = 124
integer taborder = 130
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
string picturename = "insertar.GIF"
string disabledname = "d_print.GIF"
alignment htextalign = left!
string powertiptext = "Nuevo detalle de Ingreso Directo"
end type

event clicked;if tab_1.tp_pag.tab_2.tp_1.dw_pagos.describe("evaluate('isrownew()',"+string(tab_1.tp_pag.tab_2.tp_1.dw_pagos.getrow())+")")='false' then return
long j
j=dw_pago.insertrow(0)
dw_pago.setitem(j,"coddoc",i_coddoc)
dw_pago.setitem(j,"clugar",clugar)
dw_pago.setitem(j,"cartipo",tab_1.tp_pag.tab_2.tp_1.dw_pagos.getitemstring(tab_1.tp_pag.tab_2.tp_1.dw_pagos.getrow(),'cartipo'))
dw_pago.setitem(j,"item",tab_1.tp_pag.tab_2.tp_1.dw_pagos.getitemnumber(tab_1.tp_pag.tab_2.tp_1.dw_pagos.getrow(),'item'))
dw_pago.setitem(j,"subitem",j)
return j
end event

type dw_pago from datawindow within tp_2
integer y = 36
integer width = 6473
integer height = 872
integer taborder = 40
string title = "none"
string dataobject = "dw_car_pago_cpo"
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;settransobject(sqlca)
end event

event dberror;return f_dw_error(sqldbcode,sqlsyntax,sqlerrtext,classname())
end event

type tp_glo from userobject within tab_1
integer x = 18
integer y = 112
integer width = 6789
integer height = 1112
long backcolor = 67108864
string text = "Glosas"
long tabtextcolor = 33554432
string picturename = "glosa.ico"
long picturemaskcolor = 536870912
string powertiptext = "Historial de Glosas realizadoas al cobro"
pb_6 pb_6
pb_3 pb_3
pb_2 pb_2
pb_1 pb_1
dw_glosas dw_glosas
end type

on tp_glo.create
this.pb_6=create pb_6
this.pb_3=create pb_3
this.pb_2=create pb_2
this.pb_1=create pb_1
this.dw_glosas=create dw_glosas
this.Control[]={this.pb_6,&
this.pb_3,&
this.pb_2,&
this.pb_1,&
this.dw_glosas}
end on

on tp_glo.destroy
destroy(this.pb_6)
destroy(this.pb_3)
destroy(this.pb_2)
destroy(this.pb_1)
destroy(this.dw_glosas)
end on

type pb_6 from picturebutton within tp_glo
integer x = 6569
integer y = 420
integer width = 146
integer height = 128
integer taborder = 30
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean originalsize = true
string picturename = "import.gif"
string disabledname = "d_import.gif"
string powertiptext = "Sube Objecciones Archivo"
end type

event clicked;dw_gloa.reset()
if messageBox('Aviso','Esta seguro de comparar el documento seleccionado modificara datos?',QUESTION!,YESNO!) = 2 then
	Return
end if

string ls_range ,ls_path, ls_file,ls_tipo
string ls_lfac,ls_tfac,ls_td,ls_doc,ls_return
string log_txt
datetime ld_fecp
integer ll_rc,l_cols,ll_rows,i_numar=-1
double ld_nfac
dec ld_valor
oleobject loo_excel

//crear excel
if  GetFileOpenName("Abrir" ,ls_path, ls_file," ","Excel 2007 o posterior (*.xlsx)*.xlsx") <> 1 then
	return
end if
loo_excel = create OLEObject
loo_excel.ConnectToNewobject("excel.application")
loo_excel.visible = false
loo_excel.workbooks.open( ls_path )
loo_excel.worksheets(1).Activate
ll_rows =loo_excel.worksheets(1).Usedrange.rows.count

// Copy the used range of data to the clipboard
ls_range = "A1:" + "H" + string(ll_rows)
loo_excel.Worksheets(1).Range(ls_range).Copy
ll_rc =dw_gloa.importclipboard() 
clipboard(' ')
loo_excel.workbooks.close
loo_excel.disconnectobject()
Destroy loo_excel

if ll_rc<0 then return

hpb_1.visible=true
hpb_1.Position = 0
hpb_1.MinPosition = 0
dw_gloa.SetRedraw(FALSE)

//Abre log
log_txt=mid(ls_path,1,pos(ls_path,'.') -1)+'.txt'
i_numar=fileopen(log_txt,LineMode!,write!)
if i_numar=-1 then
	messagebox("Atención",'No se puede crear el archivo de log')
	return
end if
filewrite(i_numar,'Inicia proceso'+String(Today(), "dd/mm/yyyy hh:mm:ss"))
for  ll_rc=1 to dw_gloa.rowcount()
	ld_nfac=dw_gloa.getitemnumber(ll_rc,'n_fac')
	ls_lfac=dw_gloa.getitemstring(ll_rc,'l_fac')
	ls_tfac=dw_gloa.getitemstring(ll_rc,'t_fac')
	ld_fecp=dw_gloa.getitemdatetime(ll_rc,'fecha')
	ld_valor=dw_gloa.getitemnumber(ll_rc,'valor')
	ls_tipo=dw_gloa.getitemstring(ll_rc,'tipo')
	ls_td=dw_gloa.getitemstring(ll_rc,'td')
	ls_doc=dw_gloa.getitemstring(ll_rc,'docu')	
	if g_motor='postgres' then 
		SELECT * into :ls_return from sp_objglo_cartera_aplica(:ld_nfac,:ls_lfac,:ls_tfac,:ld_fecp,:ld_valor,:ls_tipo,:ls_td,:ls_doc,:usuario);
	end if
	ls_return='Fila '+string(ll_rc)+' ----> '+ls_return
	filewrite(i_numar,ls_return)
	hpb_1.Position =ll_rc
next
filewrite(i_numar,'Fin proceso'+String(Today(), "dd/mm/yyyy hh:mm:ss"))
fileclose(i_numar)
hpb_1.visible=false
messagebox('Atención', 'Proceso finalizado') 
end event

type pb_3 from picturebutton within tp_glo
integer x = 6569
integer y = 288
integer width = 146
integer height = 128
integer taborder = 70
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
boolean italic = true
boolean originalsize = true
string picturename = "ojo.gif"
string disabledname = "d_ojo.gif"
alignment htextalign = left!
string powertiptext = "Ver detalle glosas"
end type

event clicked;if dw_cab.rowcount()=0 then return
if not isnull(dw_cab.getitemstring(1,'estado')) then return
if dw_glosas.RowCount() = 0 then Return
st_amortizar st_p
if dw_glosas.GetItemNumber(dw_glosas.GetRow(),'nuevo') = 0 and (dw_glosas.GetItemNumber(dw_glosas.GetRow(),'num_glosa') = 0 or isNull(dw_glosas.GetItemNumber(dw_glosas.GetRow(),'num_glosa')))  then
	if MessageBox('Atención','Desea crear nuevo documento en manejo de glosas?',Question!,yesno!) = 2 then Return 0
	st_p.dw_cab = dw_cab
	st_p.dw_cpo = dw_glosas
	opensheetwithparm(w_maneja_glosas,st_p,w_principal,11,layered!)	
end if
if dw_glosas.GetItemNumber(dw_glosas.GetRow(),'num_glosa') > 0 then
	st_p.dw_cpo = dw_glosas
	opensheetwithparm(w_maneja_glosas,st_p,w_principal,11,layered!)
end if

end event

type pb_2 from picturebutton within tp_glo
integer x = 6569
integer y = 156
integer width = 146
integer height = 128
integer taborder = 60
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
boolean originalsize = true
string picturename = "borrar_fila.gif"
string disabledname = "d_borrar_fila.gif"
alignment htextalign = left!
string powertiptext = "Anular o Borrar Registro"
end type

event clicked;long fila,j
fila=dw_glosas.getrow()
if fila<1 then return
if dw_cab.rowcount()=0 then return
if not isnull(dw_cab.getitemstring(1,'estado')) then return
if not isnull(dw_glosas.getitemstring(fila,'estado')) then return
if dw_glosas.getitemstring(fila,'contabil')='C' then
	messagebox("Atención",'Esta Objecion/Glosa ya se encuentra contabilizada, no la puede anular')
	return
end if
if dw_glosas.getitemnumber(fila,'operacion')=0 then //objecion
	if not isnull(dw_glosas.getitemnumber(fila,'num_glosa')) then
		messagebox("Atención",'Esta Objecion ya se encuentra en el módulo de glosas, no la puede anular')
		return
	end if
else
	if  not isnull(dw_glosas.getitemnumber(fila,'num_glosa')=0) then
		messagebox("Atención",'Este Registro corresponde a una glosa, solo la puede anular en el modulo de Objeciones/Glosas')
		return
	end if
end if
if dw_glosas.describe("evaluate('IsRowNew()',"+string(fila)+')')='true' then
	dw_glosas.deleterow(fila)
else
	st_xa_anular st_anula
	st_anula.tipo='CA'
	openwithparm (w_motiv_anula,st_anula)
	st_anula=message.powerobjectparm
	if not isValid(st_anula) then return
	dw_glosas.setitem(fila,'estado',usuario)
	dw_glosas.setitem(fila,'fecha_anula',datetime(today(),now()))
	dw_glosas.setitem(fila,'motiv_anula',st_anula.observacion)
	dw_glosas.setitem(fila,'cod_anula',st_anula.motivo)
end if
calc_totales()
cambio=true
end event

type pb_1 from picturebutton within tp_glo
integer x = 6569
integer y = 24
integer width = 146
integer height = 128
integer taborder = 60
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
boolean italic = true
boolean originalsize = true
string picturename = "insertar.gif"
string disabledname = "d_insertar.gif"
alignment htextalign = left!
string powertiptext = "Adicionar registro"
end type

event clicked;if dw_cab.rowcount()=0 then return
if not isnull(dw_cab.getitemstring(1,'estado')) then return
if dw_cab.getitemstring(1,'cxp')='1' or dw_cab.getitemstring(1,'cxp')='3' /*or dw_cab.getitemstring(1,'cxp')='0'*/ then return
if dw_cab.getitemstring(1,'cxp')='2' and i_nuevo then
	messagebox("Atención",'Debe primero guardar para poder insertar un registro de Pagos')
	return -1
end if

if dw_cab.getitemstring(1,'cxp')='2' then 
	idw_glo.setfilter('operacion=0 or operacion=-1 or operacion=1' )
end if
if dw_cab.getitemstring(1,'cxp')='0' then 
	idw_glo.setfilter('operacion=0 or operacion=1' )
end if
idw_glo.filter()

long donde,j
donde=dw_glosas.insertrow(0)
for j=1 to dw_glosas.rowcount()
	if dw_glosas.find('item='+string(j),1,dw_glosas.rowcount())=0 then exit
next
dw_glosas.setitem(donde,'item',j)
dw_glosas.setitem(donde,'usuario',usuario)
dw_glosas.setitem(donde,'num_cobro',i_ndoc)
dw_glosas.setitem(donde,'coddoc',i_coddoc)
dw_glosas.setitem(donde,'clugar',i_clug)
dw_glosas.setitem(donde,'fecha',datetime(today(),now()))
dw_glosas.setitem(donde,'fecha_audita',datetime(today(),now()))
dw_glosas.scrolltorow(donde)
if idw_glo.rowcount()=1 then dw_glosas.setitem(donde,'cartipo',idw_glo.getitemstring(1,1))
dw_glosas.setfocus()
calc_totales()
cambio=true
return donde
end event

type dw_glosas from datawindow within tp_glo
integer x = 32
integer y = 32
integer width = 6478
integer height = 1048
integer taborder = 20
string title = "none"
string dataobject = "dw_car_cpo_desc"
boolean hscrollbar = true
boolean vscrollbar = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;settransobject(sqlca)
getchild('cartipo',idw_glo)
idw_glo.settransobject(sqlca)
idw_glo.retrieve('3')

end event

event itemchanged;cambio=true
if dwo.name='valor' or dwo.name='cartipo' then
	if dwo.name='valor' then
		if long(data)>dw_cab.getitemnumber(1,'pendiente') then
			setitem(getrow(),'valor',0)
			settext(string(getitemnumber(getrow(),'valor')))
			messagebox("Atención",'Supera el valor Pendiente de la Radicación')			
			return 1
		end if
	else
		setitem(row,'operacion',idw_glo.getitemnumber(idw_glo.getrow(),'operacion'))
	end if
	if dwo.name='fecha' then
		datetime fec_rad,fec_hoy
		fec_hoy=datetime(today(),now())
		fec_rad=dw_cab.GetItemDateTime(dw_cab.getrow(),"fecha")
		if f_valida_fecha(datetime(data))=-1  then return 1
		if datetime(data)>fec_hoy or datetime(data)<fec_rad then
			messagebox("Atención",'Fecha debe estar entre '+string(fec_rad,'dd/mm/yyyy')+' y el '+string(fec_hoy,'dd/mm/yyyy')+' verifique')
			return 1
		End If
		if f_docu_cartera(datetime(data))=-1 then return 1
	End If
	IF calc_totales()<0 then 
		messagebox("Atención",'El saldo no puede ser negativo verifique los datos')
		setitem(getrow(),'valor',0)
		return 1
	End If
end if
end event

event dberror;return f_dw_error(sqldbcode,sqlsyntax,sqlerrtext,classname())
end event

event clicked;if row < 1 then return
if getRow() <> row then scrolltorow(row)

end event

event rbuttondown;st_dw_xa_funciones st_dw
st_dw.dw=this
st_dw.dwo=dwo
st_dw.row=row
st_dw.color_fondo=string(rgb(255,255,255))
openwithparm(w_funcion_dw,st_dw)
end event

type st_2 from statictext within w_teso_cartera
integer x = 41
integer y = 92
integer width = 805
integer height = 56
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Cobros Realizados (Ingresos):"
boolean focusrectangle = false
end type

type dw_amtz from datawindow within w_teso_cartera
boolean visible = false
integer x = 4146
integer y = 40
integer width = 119
integer height = 92
integer taborder = 70
boolean bringtotop = true
string title = "none"
string dataobject = "dw_cartera_amtz"
boolean hscrollbar = true
boolean vscrollbar = true
boolean resizable = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;settransobject(sqlca)
end event

event dberror;return f_dw_error(sqldbcode,sqlsyntax,sqlerrtext,classname())
end event

type dw_cierres from datawindow within w_teso_cartera
boolean visible = false
integer x = 3877
integer y = 24
integer width = 82
integer height = 100
integer taborder = 120
boolean bringtotop = true
string title = "none"
string dataobject = "dw_cierre_cart"
boolean border = false
boolean livescroll = true
end type

event constructor;this.settransobject(sqlca)
retrieve()
end event

type dw_lugar from datawindow within w_teso_cartera
integer x = 201
integer width = 1280
integer height = 92
integer taborder = 10
string title = "none"
string dataobject = "dw_combo_lugar_cartera"
boolean border = false
boolean livescroll = true
end type

event constructor;settransobject(sqlca)
modify('datawindow.header.height=0')
modify('#1.width=1266')
insertrow(1)
getChild('codlugar', idw_lugar)

end event

event itemchanged;string actual
actual=getitemstring(1,1)
choose case f_pregunta()
	case 1
		if grabar()=-1 then
			rollback;
			setitem(1,1,actual)
			return 1
		end if
	case 2
		cambio=false
		tab_1.tp_pag.tab_2.tp_0.pb_new_pago.enabled=true
	case 3
		setitem(1,1,actual)
		return 1
end choose
accepttext()
dw_hist.reset()
i_fila=0
dw_cab.reset()
dw_tot.reset()
tab_1.tp_det.dw_det.reset()
tab_1.tp_des.dw_des.reset()
tab_1.tp_pag.tab_2.tp_0.dw_pend.reset()
tab_1.tp_pag.tab_2.tp_1.dw_pagos.reset()
tab_1.tp_pag.tab_2.tp_1.dw_ing.reset()
tab_1.tp_pag.tab_2.tp_2.dw_pago.reset()
tab_1.tab_fact.dw_fact.reset()
tab_1.tp_glo.dw_glosas.reset()
i_clug=getitemstring(1,1)
select cod_empresa into :i_emp from lugar where codlugar=:i_clug;
if sqlca.sqlcode=-1 then
	messagebox("Error leyendo Lugar",sqlca.sqlerrtext)
end if
//dw_hist.retrieve(i_clug)
idw_caja.retrieve(i_clug)
idw_caja2.retrieve(i_clug)

end event

type em_desde from editmask within w_teso_cartera
integer x = 1719
integer y = 24
integer width = 398
integer height = 80
integer taborder = 20
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
string text = "none"
borderstyle borderstyle = stylelowered!
maskdatatype maskdatatype = datemask!
string mask = "dd/mm/yyyy"
boolean dropdowncalendar = true
end type

type em_hasta from editmask within w_teso_cartera
integer x = 2304
integer y = 24
integer width = 389
integer height = 80
integer taborder = 30
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
borderstyle borderstyle = stylelowered!
maskdatatype maskdatatype = datemask!
string mask = "dd/mm/yyyy"
boolean dropdowncalendar = true
end type

type pb_consultar from picturebutton within w_teso_cartera
integer x = 2811
integer y = 8
integer width = 146
integer height = 128
integer taborder = 40
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
boolean originalsize = true
string picturename = "refrescar.GIF"
alignment htextalign = left!
string powertiptext = "Consultar"
end type

event clicked;string actual
date ld_desde, ld_hasta

actual = dw_lugar.getitemstring(1,1)
choose case f_pregunta()
	case 1
		if grabar()=-1 then
			rollback;
			return 1
		end if
	case 2
		cambio=false
		tab_1.tp_pag.tab_2.tp_0.pb_new_pago.enabled=true
	case 3
		return 1
end choose
dw_lugar.accepttext()
dw_hist.reset()
i_fila=0
dw_cab.reset()
dw_tot.reset()
tab_1.tp_det.dw_det.reset()
tab_1.tp_des.dw_des.reset()
tab_1.tp_pag.tab_2.tp_0.dw_pend.reset()
tab_1.tp_pag.tab_2.tp_1.dw_pagos.reset()
tab_1.tp_pag.tab_2.tp_1.dw_ing.reset()
tab_1.tp_pag.tab_2.tp_2.dw_pago.reset()
tab_1.tab_fact.dw_fact.reset()
tab_1.tp_glo.dw_glosas.reset()

em_desde.getData( ld_desde)
em_hasta.getData( ld_hasta)

dw_hist.retrieve(i_clug, ld_desde, ld_hasta)

end event

type st_7 from statictext within w_teso_cartera
integer x = 1541
integer y = 32
integer width = 178
integer height = 64
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Desde:"
boolean focusrectangle = false
end type

type st_8 from statictext within w_teso_cartera
integer x = 2139
integer y = 32
integer width = 160
integer height = 80
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
string text = "Hasta:"
boolean focusrectangle = false
end type

type dw_pag from datawindow within w_teso_cartera
boolean visible = false
integer x = 3982
integer y = 32
integer width = 151
integer height = 76
integer taborder = 90
boolean bringtotop = true
string title = "none"
string dataobject = "dw_pagos_archivo"
boolean hscrollbar = true
boolean vscrollbar = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;settransobject(sqlca)
end event

type hpb_1 from hprogressbar within w_teso_cartera
boolean visible = false
integer x = 2615
integer y = 1204
integer width = 1669
integer height = 68
boolean bringtotop = true
unsignedinteger maxposition = 100
unsignedinteger position = 50
integer setstep = 10
end type

type dw_gloa from datawindow within w_teso_cartera
boolean visible = false
integer x = 2862
integer y = 988
integer width = 229
integer height = 112
integer taborder = 130
boolean bringtotop = true
string title = "none"
string dataobject = "dw_objeini_archivo"
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;settransobject(sqlca)
end event

type pb_7 from picturebutton within w_teso_cartera
integer x = 4338
integer y = 560
integer width = 146
integer height = 128
integer taborder = 80
boolean bringtotop = true
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
boolean originalsize = true
string picturename = "buscar2.GIF"
alignment htextalign = left!
vtextalign vtextalign = multiline!
string powertiptext = "bUSCA fACTURA"
end type

event clicked;st_xa_buscar_pre st

st.dw_histo=dw_hist
st.cdoc='factu'
openwithparm(w_busca_fact_cartera,st)
end event

type dw_nc from datawindow within w_teso_cartera
boolean visible = false
integer x = 3941
integer y = 2444
integer width = 686
integer height = 84
integer taborder = 180
boolean bringtotop = true
string dataobject = "dw_ripsradica_nota"
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;settransobject(sqlca)
end event

type dw_detc from datawindow within w_teso_cartera
boolean visible = false
integer x = 4695
integer y = 2444
integer width = 686
integer height = 88
integer taborder = 180
boolean bringtotop = true
string dataobject = "dw_contratos_pa_rias"
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;settransobject(sqlca)
end event

type dw_electronica from uo_datawindow within w_teso_cartera
boolean visible = false
integer x = 2944
integer y = 2448
integer width = 754
integer height = 60
integer taborder = 60
boolean bringtotop = true
string dataobject = "asis_int_factura_ele_cap"
end type


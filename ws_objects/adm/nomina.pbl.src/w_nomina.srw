$PBExportHeader$w_nomina.srw
forward
global type w_nomina from w_center
end type
type pb_anular from picturebutton within w_nomina
end type
type pb_cancelar from picturebutton within w_nomina
end type
type pb_2 from picturebutton within w_nomina
end type
type cb_1 from commandbutton within w_nomina
end type
type cbx_1 from checkbox within w_nomina
end type
type hpb_1 from hprogressbar within w_nomina
end type
type dw_apemp from datawindow within w_nomina
end type
type sle_fila from singlelineedit within w_nomina
end type
type tab_1 from tab within w_nomina
end type
type p_1 from userobject within tab_1
end type
type sle_3 from editmask within p_1
end type
type sle_2 from editmask within p_1
end type
type sle_1 from editmask within p_1
end type
type st_2 from statictext within p_1
end type
type st_1 from statictext within p_1
end type
type dw_devenga from datawindow within p_1
end type
type dw_deduce from datawindow within p_1
end type
type st_6 from statictext within p_1
end type
type p_1 from userobject within tab_1
sle_3 sle_3
sle_2 sle_2
sle_1 sle_1
st_2 st_2
st_1 st_1
dw_devenga dw_devenga
dw_deduce dw_deduce
st_6 st_6
end type
type p_2 from userobject within tab_1
end type
type rb_nov from radiobutton within p_2
end type
type gb_1 from groupbox within p_2
end type
type cbx_cal from checkbox within p_2
end type
type pb_3 from picturebutton within p_2
end type
type em_1 from editmask within p_2
end type
type dw_emp from datawindow within p_2
end type
type pb_borranov from picturebutton within p_2
end type
type pb_addnov from picturebutton within p_2
end type
type rb_amb from radiobutton within p_2
end type
type rb_ded from radiobutton within p_2
end type
type rb_nin from radiobutton within p_2
end type
type dw_novedad from datawindow within p_2
end type
type st_7 from statictext within p_2
end type
type p_2 from userobject within tab_1
rb_nov rb_nov
gb_1 gb_1
cbx_cal cbx_cal
pb_3 pb_3
em_1 em_1
dw_emp dw_emp
pb_borranov pb_borranov
pb_addnov pb_addnov
rb_amb rb_amb
rb_ded rb_ded
rb_nin rb_nin
dw_novedad dw_novedad
st_7 st_7
end type
type p_5 from userobject within tab_1
end type
type dw_ap from datawindow within p_5
end type
type p_5 from userobject within tab_1
dw_ap dw_ap
end type
type p_7 from userobject within tab_1
end type
type dw_2 from datawindow within p_7
end type
type p_7 from userobject within tab_1
dw_2 dw_2
end type
type p_3 from userobject within tab_1
end type
type st_5 from statictext within p_3
end type
type st_4 from statictext within p_3
end type
type st_3 from statictext within p_3
end type
type dw_cuotas from datawindow within p_3
end type
type dw_plan from datawindow within p_3
end type
type dw_presta from datawindow within p_3
end type
type pb_1 from picturebutton within p_3
end type
type p_3 from userobject within tab_1
st_5 st_5
st_4 st_4
st_3 st_3
dw_cuotas dw_cuotas
dw_plan dw_plan
dw_presta dw_presta
pb_1 pb_1
end type
type p_4 from userobject within tab_1
end type
type st_9 from statictext within p_4
end type
type st_8 from statictext within p_4
end type
type dw_acpo from datawindow within p_4
end type
type dw_acab from datawindow within p_4
end type
type p_4 from userobject within tab_1
st_9 st_9
st_8 st_8
dw_acpo dw_acpo
dw_acab dw_acab
end type
type p8 from userobject within tab_1
end type
type pb_dian from picturebutton within p8
end type
type dw_electronica from datawindow within p8
end type
type p8 from userobject within tab_1
pb_dian pb_dian
dw_electronica dw_electronica
end type
type p_6 from userobject within tab_1
end type
type pb_8 from picturebutton within p_6
end type
type st_13 from statictext within p_6
end type
type pb_import from picturebutton within p_6
end type
type dw_im from datawindow within p_6
end type
type pb_7 from picturebutton within p_6
end type
type p_6 from userobject within tab_1
pb_8 pb_8
st_13 st_13
pb_import pb_import
dw_im dw_im
pb_7 pb_7
end type
type tab_1 from tab within w_nomina
p_1 p_1
p_2 p_2
p_5 p_5
p_7 p_7
p_3 p_3
p_4 p_4
p8 p8
p_6 p_6
end type
type dw_tsup from datawindow within w_nomina
end type
type dw_1 from datawindow within w_nomina
end type
type dw_tipoincap from datawindow within w_nomina
end type
type tab_n from tab within w_nomina
end type
type tpn_1 from userobject within tab_n
end type
type dw_anyos from datawindow within tpn_1
end type
type pb_des from picturebutton within tpn_1
end type
type pb_retro from picturebutton within tpn_1
end type
type pb_nuevo from picturebutton within tpn_1
end type
type dw_nomcab from datawindow within tpn_1
end type
type dw_3 from datawindow within tpn_1
end type
type tpn_1 from userobject within tab_n
dw_anyos dw_anyos
pb_des pb_des
pb_retro pb_retro
pb_nuevo pb_nuevo
dw_nomcab dw_nomcab
dw_3 dw_3
end type
type tpn_2 from userobject within tab_n
end type
type pb_5 from picturebutton within tpn_2
end type
type pb_4 from picturebutton within tpn_2
end type
type pb_6 from picturebutton within tpn_2
end type
type dw_empnom from datawindow within tpn_2
end type
type st_12 from statictext within tpn_2
end type
type tpn_2 from userobject within tab_n
pb_5 pb_5
pb_4 pb_4
pb_6 pb_6
dw_empnom dw_empnom
st_12 st_12
end type
type tab_n from tab within w_nomina
tpn_1 tpn_1
tpn_2 tpn_2
end type
type st_15 from statictext within w_nomina
end type
type mle_1 from multilineedit within w_nomina
end type
type sle_4 from singlelineedit within w_nomina
end type
type pb_calcula from picturebutton within w_nomina
end type
type dw_ausend from datawindow within w_nomina
end type
type st_14 from statictext within w_nomina
end type
type st_16 from statictext within w_nomina
end type
type pb_pila from picturebutton within w_nomina
end type
type dw_nelec from uo_datawindow within w_nomina
end type
type lb_1 from listbox within w_nomina
end type
type dw_pila from datawindow within w_nomina
end type
type pb_9 from picturebutton within w_nomina
end type
type dw_empact from datawindow within w_nomina
end type
type dw_aus from datawindow within w_nomina
end type
type dw_historia_bak from datawindow within w_nomina
end type
end forward

global type w_nomina from w_center
string tag = "Desea guardar los cambios?"
integer width = 7150
integer height = 2356
string title = "Liquidación Nómina"
boolean maxbox = false
windowtype windowtype = popup!
string icon = "nomina.ico"
boolean center = false
event type integer cargar ( )
pb_anular pb_anular
pb_cancelar pb_cancelar
pb_2 pb_2
cb_1 cb_1
cbx_1 cbx_1
hpb_1 hpb_1
dw_apemp dw_apemp
sle_fila sle_fila
tab_1 tab_1
dw_tsup dw_tsup
dw_1 dw_1
dw_tipoincap dw_tipoincap
tab_n tab_n
st_15 st_15
mle_1 mle_1
sle_4 sle_4
pb_calcula pb_calcula
dw_ausend dw_ausend
st_14 st_14
st_16 st_16
pb_pila pb_pila
dw_nelec dw_nelec
lb_1 lb_1
dw_pila dw_pila
pb_9 pb_9
dw_empact dw_empact
dw_aus dw_aus
dw_historia_bak dw_historia_bak
end type
global w_nomina w_nomina

type variables
uo_dataStore dw_conceptos, dw_contra, dw_concep_cargo
long periodo, il_nuevo, borrar, vac, lm, ln, ctrl,lp,l_sus,l_inc,l_incp,l_perm,l_luto,l_asjc
DataWindowChild dwc_novedad, dwc_cp,dwc_ce,dwc_ce_bas
int l_periodo
string cod_conceppresta, cod_concepahorro, operacion, i_cemp,l_nesp,l_kry='1'
string is_path="c:\windows\temp\",is_tnom,ls_vac,ls_vpriprev, ls_vpagdo0
boolean ibn_calculando, ibn_cancelar, ibn_actualizado
uo_datastore dw_historia, ids_req , ids_novedad, dw_histoall, dw_prestaact
//uo_datastore dw_aus_all, dw_presta_all, dw_tsup_all

n_log log

string dwSyntax 


end variables

forward prototypes
public function integer deselect (string tipodoc, string documento)
public function integer calctotal ()
public function long dias_vac (datetime fecini, datetime fecfin)
public function integer get_values (string tipodoc, string documento)
public function integer grabar (string tipo)
public function integer grabar ()
public function long ausentismo (string tipodoc, string documento, st_interfec interv, integer filahist)
public function integer calc_dias (string tipodoc, string documento, st_interfec interv, integer filahist)
public function integer calc_afilia (string tipodoc, string documento, string cod_clase)
public function integer f_tiempos ()
public function integer checkconcep (datawindow dw_obj)
public function integer f_checkconcep (integer fila)
public function string f_get_ctrl (string sigla)
public function integer f_retrieveend ()
public function integer nomcalc (string tipodoc, string documento, string pesp, string ptnom)
public function string get_parm_nov (string sigla)
public function integer f_addcompute (string concep, string form_calculo, string form_base, decimal tarifa, decimal tarifa_esp, integer litem)
public function string wf_vac_anticipada ()
public subroutine filtrar (string td, string doc)
public function integer calc_prestamos (string tipodoc, string documento, integer filahist)
public function integer calc_ahorros (string tipodoc, string documento, integer filahist)
public function integer calc_tsuplementario (string tipodoc, string documento, integer filahist)
public subroutine redraw (boolean valor)
public function integer datos_empleado (string tipodoc, string documento)
public function integer datos_ausentismo (string tipodoc, string documento, string cod_ausentismo)
public function integer datos_prestamos (string tipodoc, string documento)
public function integer datos_tsuplementario (string tipodoc, string documento)
public function integer datos_concep_cargo (string codrela, string tipoemple, string cargo)
public function integer recalcula (string tipodoc, string documento)
public subroutine actualizardatos ()
public function integer datos_apemp (string tipodoc, string documento, string cod_clase)
public function long f_addnovedad ()
end prototypes

event type integer cargar();
dw_historia = create uo_datastore
dw_historia.DataObject = 'dw_historia'
dw_historia.SetTransObject(SQLCA)

dw_histoall = create uo_datastore
dw_histoall.DataObject = 'dw_historia_all'
dw_histoall.SetTransObject(SQLCA)

dw_prestaact = create uo_datastore
dw_prestaact.DataObject = "dw_prestaact_all"
dw_prestaact.SetTransObject(SQLCA)

dw_contra = create uo_datastore
dw_contra.DataObject = "dw_fpago_act"
dw_contra.SetTransObject(SQLCA)

ids_req = create uo_datastore
ids_req.DataObject = "dw_concep_req"
ids_req.SetTransObject(SQLCA)
ids_req.retrieve()

ids_novedad = create uo_datastore
ids_novedad.DataObject = "dw_pm_novedad"
ids_novedad.SetTransObject(SQLCA)
ids_novedad.retrieve()

ibn_actualizado = false

if g_motor='postgres' then
	tab_n.tpn_2.dw_empnom.DataObject ='dw_empnom_postgres'
	dw_empact.DataObject ='dw_empact_postgres'
else
	tab_n.tpn_2.dw_empnom.DataObject ='dw_empnom'
	dw_empact.DataObject ='dw_empact'
end if
tab_n.tpn_2.dw_empnom.SetTransObject(SQLCA)
dw_empact.SetTransObject(SQLCA)

tab_1.p_2.dw_novedad.GetChild('sigla', dwc_novedad)
dwc_novedad.SetTransObject(SQLCA)
dwc_novedad.Retrieve('%','%','%','1')
tab_n.tpn_1.dw_nomcab.SetTransObject(SQLCA)
tab_n.tpn_2.dw_empnom.SetTransObject(SQLCA)

tab_1.p_1.dw_devenga.SetTransObject(SQLCA)
tab_1.p_1.dw_deduce.SetTransObject(SQLCA)
tab_1.p_2.dw_novedad.SetTransObject(SQLCA)
tab_1.p_2.dw_emp.SetTransObject(SQLCA)
tab_1.p_2.dw_emp.InsertRow(0)
tab_1.p_3.dw_presta.SetTransObject(SQLCA)
tab_1.p_3.dw_plan.SetTransObject(SQLCA)
tab_1.p_3.dw_cuotas.SetTransObject(SQLCA)
tab_1.p_4.dw_acab.SetTransObject(SQLCA)
tab_1.p_4.dw_acpo.SetTransObject(SQLCA)
dw_ausend.SetTransObject(SQLCA)
il_nuevo = 0
borrar = 0
ctrl =80
long i

dw_conceptos = Create uo_datastore
dw_conceptos.DataObject = "dw_conceptos"
dw_conceptos.SetTransObject(SQLCA)

dw_concep_cargo = Create uo_datastore
dw_concep_cargo.DataObject = "dw_conceptos_cargo_all"
dw_concep_cargo.SetTransObject(SQLCA)

dw_conceptos.Retrieve()
 
for i =  1 to dw_conceptos.RowCount()
	w_principal.SetMicroHelp ( 'Creando concepto:'+dw_conceptos.GetItemString(i,'sigla') )

	if dw_conceptos.GetItemString(i,'novedad') = '0'  then
		if f_addcompute( dw_conceptos.GetItemString(i,'sigla'), dw_conceptos.GetItemString(i,'form_calculo'), dw_conceptos.GetItemString(i,'form_verifica'), dw_conceptos.GetItemnumber(i,'tarifa'), dw_conceptos.GetItemnumber(i,'tarifa_esp'),1) = -1 then 
			messageBox('Error agregando concepto', dw_conceptos.GetItemString(i,'sigla'))
			Return -1
		end if
	end if
next

tab_n.tpn_1.dw_anyos.setitem(1,1,year(today()))

tab_n.tpn_1.dw_anyos.post event itemchanged(1,tab_n.tpn_1.dw_anyos.object.anyo, string(year(today())))

tab_n.tpn_1.dw_nomcab.post setfocus()
dw_contra.DataObject = 'dw_fpago_act'
dw_contra.SetTransObject(SQLCA)

SELECT cadena into :ls_vac
FROM parametros_gen
WHERE (((codigo_para)=51));
if sqlca.sqlnrows=0 then
	messagebox('Atencíon','No hay parametro 51')
	return -1
end if

SELECT cadena into :ls_vpriprev
FROM parametros_gen
WHERE (((codigo_para)=52));
if sqlca.sqlnrows=0 then
	messagebox('Atencíon','No hay parametro 52')
	return -1
end if

SELECT cadena into :ls_vpagdo0
FROM parametros_gen
WHERE (((codigo_para)=63));
if sqlca.sqlnrows=0 then
	messagebox('Atencíon','No hay parametro 63')
	return -1
end if

log = create n_log
log.inicia('l_nomina.log')
log.info("Se inicia Nómina")
return 1
end event

public function integer deselect (string tipodoc, string documento);long i
for i = tab_1.p_1.dw_devenga.RowCount() to 1 step -1
	tab_1.p_1.dw_devenga.DeleteRow(i)
next
for i = tab_1.p_1.dw_deduce.RowCount() to 1 step -1
	tab_1.p_1.dw_deduce.DeleteRow(i)
next

return 0
end function

public function integer calctotal ();decimal res,dev,ded,nov
long i, a
res = 0
dev = 0
for i = 1 to tab_1.p_1.dw_devenga.RowCount()
	if tab_1.p_1.dw_devenga.GetItemNumber(i,'selec') = 1 then
		dev = dev + tab_1.p_1.dw_devenga.GetItemNumber(i,'pagado')
	end if
next

tab_1.p_1.sle_1.Text = string(round(dev,0))
res = dev
ded = 0
for i = 1 to tab_1.p_1.dw_deduce.RowCount()
	if tab_1.p_1.dw_deduce.GetItemNumber(i,'selec') = 1 then
		ded = ded + tab_1.p_1.dw_deduce.GetItemNumber(i,'pagado')
	end if
next
tab_1.p_1.sle_2.Text = string(round(ded,0))
res = res - ded 
nov = 0
for i = 1 to tab_1.p_2.dw_novedad.RowCount()
	if tab_1.p_2.dw_novedad.GetItemString(i,'tipo') = '0' or tab_1.p_2.dw_novedad.GetItemString(i,'tipo') = 'L' then a=1 else a= -1
	if not isNull(tab_1.p_2.dw_novedad.GetItemstring(i,'pagado')) then
		nov = nov + a*tab_1.p_2.dw_novedad.GetItemNumber(i,'pagado')
	end if
next
tab_1.p_2.em_1.Text = string(round(nov,0))
res = dev - ded  + nov
tab_1.p_1.sle_3.Text = string(round(res,0))
Return 0

end function

public function long dias_vac (datetime fecini, datetime fecfin);long dias
date fecha

fecha = date(fecfin)
do while fecha >= date(fecini)
	if string(fecha,'dd/mm') = '28/02' then
		dias = dias + 3
	elseif string(fecha,'dd/mm') = '29/02' then
		dias = dias + 2
	elseif day(fecha) < 31 then
		dias = dias + 1
	end if
	fecha = RelativeDate(fecha, -1)
loop

Return dias

end function

public function integer get_values (string tipodoc, string documento);long k, i, fila, f, fcontra, p, dias, dias_vinc,tari,ll_fila
string sigla
boolean contra, afiliado
double valor,base

st_interfec iper, iret
datawindow dw_obj

l_nesp=tab_n.tpn_1.dw_nomcab.GetItemstring(tab_n.tpn_1.dw_nomcab.GetRow(),'esp')
fcontra = dw_contra.Find("tipodoc='"+tipodoc+"' and documento='"+documento+"'",1,dw_contra.RowCount()) 
int jaer
jaer=dw_historia.RowCount()
for k = 1 to dw_historia.RowCount()
	iper.x = dw_historia.GetItemDateTime(k,'interv_ini')
	iper.y = dw_historia.GetItemDateTime(k,'interv_fin')
	datos_concep_cargo(dw_historia.GetItemString(k,'codrela'),dw_historia.GetItemString(k,'tipoemple'),dw_historia.GetItemString(k,'cargo'))
	
	for i =  1 to dw_concep_cargo.RowCount()	
		dias_vinc = dw_historia.GetItemNumber(k,'diasvinculado')		
		sigla =dw_concep_cargo.GetItemString(i,'sigla')
		if	is_tnom='V' and dw_concep_cargo.GetItemString(i,'tipo')='0' and dw_concep_cargo.GetItemString(i,'novedad')='0' then continue
		if	is_tnom='V' and dw_concep_cargo.GetItemString(i,'tipo')='P' then continue
		if	is_tnom='V' and dw_concep_cargo.GetItemString(i,'tipo')='1' then continue
		if dw_historia.Describe(sigla + '.Coltype') = "?" then
			messageBox('Error Get values','El concepto ' + sigla + ' necesita otro concepto que no esta relacionado con el cargo del empleado')
			Return -1
		end if
		if dw_historia.Describe(sigla + '.Coltype') = "!" then CONTINUE
		if dw_historia.GetItemNumber(k,'ctr_'+sigla) = 0 then CONTINUE
		if dw_historia.Describe('b_'+sigla + '.Coltype') = "!" then CONTINUE	
		valor = round(dw_historia.GetItemNumber(k,sigla),0)
		base = round(dw_historia.GetItemNumber(k,'b_'+sigla),0)	
		if valor = 0 then CONTINUE
		if base = 0 then CONTINUE		
		if dw_concep_cargo.GetItemString(i,'novedad') = '1' then
			dw_obj = tab_1.p_2.dw_novedad			
			setnull(ll_fila)
			ll_fila= dwc_novedad.Find("cod_concep='"+dw_concep_cargo.GetItemString(i,'cod_concep')+"'",1,dwc_novedad.RowCount())
			if ll_fila > 0 then dwc_novedad.ScrolltoRow(ll_fila)		
			if dwc_novedad.GetItemString(ll_fila,'incap')='1' then continue		
			f = dw_obj.Find("sigla='"+sigla+"'",1,dw_obj.RowCount())
			if f > 0 then
				if dw_obj.GetItemNumber(f,'pagado') <>  valor then
					dw_obj.SetItem(f,'valor_c',valor)
					dw_obj.SetItem(f,'pagado',valor)
					if base <>1 then 
						dw_obj.SetItem(f,'base',base)
					end if
					if  lm<>0 then 
						f =dw_ausend.Find("tipodoc='"+tipodoc+"' and documento='"+documento+"' and cod_ausen='LM' and ncargo="+string(dw_historia.getitemnumber(1,'ncargo'))+" and cod_concep='"+dw_concep_cargo.GetItemString(i,'cod_concep')+"' and dias="+string(lm),1,dw_ausend.RowCount())
						if f>0 then dw_ausend.setitem(f,'valor',valor)
					end if
					if  lp<>0 then 
						f =dw_ausend.Find("tipodoc='"+tipodoc+"' and documento='"+documento+"' and cod_ausen='LM' and ncargo="+string(dw_historia.getitemnumber(1,'ncargo'))+" and cod_concep='"+dw_concep_cargo.GetItemString(i,'cod_concep')+"' and dias="+string(lp),1,dw_ausend.RowCount())
						if f>0 then dw_ausend.setitem(f,'valor',valor)
					end if					
				end if
				
				Continue
			end if
		else	
			choose case dw_concep_cargo.GetItemString(i,'tipo')
				case '0'
					dw_obj = tab_1.p_1.dw_devenga
				case '1','X'
					dw_obj = tab_1.p_1.dw_deduce
				case 'P','V','S'
					dw_obj = tab_1.p_5.dw_ap
				case else
					Continue
			end choose
		end if
		
		if dw_concep_cargo.GetItemString(i,'tercero') = '2' then
			afiliado = FALSE
			datos_apemp(tipodoc, documento, dw_concep_cargo.GetItemString(i,'cod_tipo_concep'))
			for p = 1 to dw_apemp.RowCount()
				iret.x = dw_apemp.GetItemDateTime(p,'inicio')
				iret.y = dw_apemp.GetItemDateTime(p,'retiro')
				iret = interseccion(iper,iret)
				if (not isNull(iret.x)) and (not isNull(iret.y)) then
					if iret.x = iper.x and iret.y = iper.y then
						dias = dw_historia.GetItemNumber(k,'diasvinculado')
					else	
						if day(date(iret.y)) = 31 then iret.y = datetime(RelativeDate(date(iret.y), -1))
						if month(date(iret.y)) = 2 and iret.y = iper.y and day(date(iper.y)) > 27 then
							dias = DaysAfter(date(iret.x),date(iret.y)) + 1 + (30 - day(date(iper.y)))
						else
							dias = DaysAfter(date(iret.x),date(iret.y)) + 1
						end if
					end if
					
					afiliado = TRUE
					setnull(fila)
					fila = dw_obj.InsertRow(0)
					dw_obj.SetItem(fila, 'item', long(string(k)+string(p)))
					dw_obj.SetItem(fila, 'num_nomina', tab_n.tpn_1.dw_nomcab.GetItemNumber(tab_n.tpn_1.dw_nomcab.GetRow(),'num_nomina'))
					dw_obj.SetItem(fila, 'tipodoc', tipodoc)
					dw_obj.SetItem(fila, 'documento', documento)
					dw_obj.SetItem(fila, 'ncargo', dw_historia.GetItemNumber(k,'ncargo'))
					dw_obj.SetItem(fila, 'ntraslado', dw_historia.GetItemNumber(k,'ntraslado'))
					dw_obj.SetItem(fila, 'nsalario', dw_historia.GetItemNumber(k,'nsalario'))
					dw_obj.SetItem(fila, 'cod_concep', dw_concep_cargo.GetItemString(i,'cod_concep'))
					dw_obj.SetItem(fila, 'des_concep', dw_concep_cargo.GetItemString(i,'des_concep'))
					dw_obj.SetItem(fila, 'selec', 1)
					if dias=0 then
						dias=	f_dias_ultimo_pagado( tipodoc,documento,"SUELDO")
					end if
					if ls_vac='1' then 
						dw_obj.SetItem(fila, 'cantidad_ac', dw_historia.GetItemNumber(k,'dias'))
					else
						if dw_concep_cargo.GetItemnumber(i,'para')=1 then
							if l_sus>0 then
								dw_obj.SetItem(fila, 'cantidad_ac', l_sus)
								dias=l_sus
								dias_vinc=l_sus
							else
								dw_obj.SetItem(fila, 'cantidad_ac', dw_historia.GetItemNumber(k,'dias')+vac+l_inc+l_incp+lm+ln)
							end if
						else					
							dw_obj.SetItem(fila, 'cantidad_ac', dw_historia.GetItemNumber(k,'dias'))
						end if
					end if
					dw_obj.SetItem(fila, 'cod_tipo_concep', dw_concep_cargo.GetItemString(i,'cod_tipo_concep'))
					dw_obj.SetItem(fila, 'sigla', sigla)
					if l_nesp='1' then
						dw_obj.SetItem(fila, 'tarifa',dw_concep_cargo.GetItemdecimal(i,'tarifa_esp'))
					else
						dw_obj.SetItem(fila, 'tarifa',dw_concep_cargo.GetItemdecimal(i,'tarifa'))
					end if
					if dias_vinc <> 0 then
						dw_obj.SetItem(fila, 'valor_c', round(valor * dias/dias_vinc,0))
						dw_obj.SetItem(fila, 'pagado', round(valor * dias/dias_vinc,0))
						dw_obj.SetItem(fila, 'base', base)				
					else
						dw_obj.SetItem(fila, 'valor_c', valor)
						dw_obj.SetItem(fila, 'pagado',valor)
						dw_obj.SetItem(fila, 'base',base)	
					end if
					dw_obj.SetItem(fila, 'tipodoc_clase', dw_apemp.GetItemString(p,'tipodoc'))
					dw_obj.SetItem(fila, 'documento_clase', dw_apemp.GetItemString(p,'documento'))
					dw_obj.SetItem(fila, 'cod_clase', dw_apemp.GetItemString(p,'cod_clase'))
					dw_obj.SetItem(fila, 'item_clase', dw_apemp.GetItemNumber(p,'item'))					
				end if
				
			next
			if not afiliado then
				MessageBox('Atención','El empleado ' +tipodoc+documento+ ' no tiene afiliación para la clase de concepto '+dw_concep_cargo.GetItemString(i,'cod_tipo_concep')+'-'+dw_concep_cargo.GetItemString(i,'des_clase'))
				Return -1
			end if
		else
			fila = dw_obj.InsertRow(0)
			dw_obj.SetItem(fila, 'num_nomina', tab_n.tpn_1.dw_nomcab.GetItemNumber(tab_n.tpn_1.dw_nomcab.GetRow(),'num_nomina'))
			dw_obj.SetItem(fila, 'tipodoc', tipodoc)
			dw_obj.SetItem(fila, 'documento',documento)
			dw_obj.SetItem(fila, 'ncargo',dw_historia.GetItemNumber(k,'ncargo'))
			dw_obj.SetItem(fila, 'ntraslado',dw_historia.GetItemNumber(k,'ntraslado'))
			dw_obj.SetItem(fila, 'nsalario', dw_historia.GetItemNumber(k,'nsalario'))
			dw_obj.SetItem(fila, 'cod_concep',dw_concep_cargo.GetItemString(i,'cod_concep'))
			dw_obj.SetItem(fila, 'des_concep',dw_concep_cargo.GetItemString(i,'des_concep'))
			dw_obj.SetItem(fila, 'item', k)
			dw_obj.SetItem(fila, 'selec', 1)
			if dw_historia.GetItemNumber(k,'dias')=0 then
				//dw_obj.SetItem(fila, 'cantidad_ac', 1)
			else
				if ls_vac='1' then 
					dw_obj.SetItem(fila, 'cantidad_ac', dw_historia.GetItemNumber(k,'dias'))
				else
					if dw_concep_cargo.GetItemnumber(i,'para')=1  then
						if dw_concep_cargo.GetItemString(i,'tipo')='S' then
							dw_obj.SetItem(fila, 'cantidad_ac', l_sus)
							dias=l_sus
							dias_vinc=l_sus
						else
							dw_obj.SetItem(fila, 'cantidad_ac', dw_historia.GetItemNumber(k,'dias')+vac+l_inc+l_incp+lm+ln + l_perm)
						end if
					else
						dw_obj.SetItem(fila, 'cantidad_ac', dw_historia.GetItemNumber(k,'dias'))
					end if
				end if
			end if
			dw_obj.SetItem(fila, 'cod_tipo_concep', dw_concep_cargo.GetItemString(i,'cod_tipo_concep'))
			dw_obj.SetItem(fila, 'sigla', sigla)
			dw_obj.SetItem(fila, 'valor_c',valor)
			if ls_vac='1' and ls_vpagdo0='1'  and dw_concep_cargo.GetItemString(i,'vac') = '1' then 
				dw_obj.SetItem(fila, 'pagado',0)	
			else
				dw_obj.SetItem(fila, 'pagado',valor)	
			end if
			dw_obj.SetItem(fila, 'base',base)
			if l_nesp='1' then
				dw_obj.SetItem(fila, 'tarifa',dw_concep_cargo.GetItemdecimal(i,'tarifa_esp'))
			else
				dw_obj.SetItem(fila, 'tarifa',dw_concep_cargo.GetItemdecimal(i,'tarifa'))
			end if
			if fcontra > 0 and not contra and dw_concep_cargo.GetItemString(i,'tipo') = '0' then
				dw_obj.SetItem(fila, 'ano', dw_contra.GetItemNumber(fcontra,'ano'))
				dw_obj.SetItem(fila, 'ncontrato', dw_contra.GetItemNumber(fcontra,'ncontrato'))
				dw_obj.SetItem(fila, 'otrosi', dw_contra.GetItemNumber(fcontra,'otrosi'))
				dw_obj.SetItem(fila, 'item_fp', dw_contra.GetItemNumber(fcontra,'item'))
				contra = TRUE
			end if
			
		end if
		if dw_concep_cargo.GetItemString(i,'tipo') = 'P' or dw_concep_cargo.GetItemString(i,'tipo') = 'S' then
			tab_1.p_5.dw_ap.SetItem(fila, 'dias_vacaciones', vac)
			tab_1.p_5.dw_ap.SetItem(fila, 'dias_incapacidad',l_inc)
			tab_1.p_5.dw_ap.SetItem(fila, 'dias_incapacidadp',l_incp)
			tab_1.p_5.dw_ap.SetItem(fila, 'dias_lmaterna', lm)
			tab_1.p_5.dw_ap.SetItem(fila, 'dias_licencianr', ln)
			tab_1.p_5.dw_ap.SetItem(fila, 'dias_sus',l_sus)
			tab_1.p_5.dw_ap.SetItem(fila, 'dias_perm',l_perm)
			tab_1.p_5.dw_ap.SetItem(fila, 'dias_luto',l_luto)			
			if dw_historia.GetItemDateTime(k,'fecha_ingreso_empre') >= dw_historia.GetItemDateTime(k,'fecini_nom') and dw_historia.GetItemDateTime(k,'fecha_ingreso_empre') <= dw_historia.GetItemDateTime(k,'fecfin_nom') then
				tab_1.p_5.dw_ap.SetItem(fila, 'ingreso', '1')
			end if
			if dw_historia.GetItemDateTime(k,'fecha_retiro') >= dw_historia.GetItemDateTime(k,'fecini_nom') and dw_historia.GetItemDateTime(k,'fecha_retiro') <= dw_historia.GetItemDateTime(k,'fecfin_nom') then
				tab_1.p_5.dw_ap.SetItem(fila, 'retiro', '1')
			end if
		end if
		
	Next
	//log.info("Ciclo get_values historia k "+string(k)+" - agregados "+string(agregados)+"  - diasVinc "+string(dw_historia.GetItemNumber(k,'diasvinculado')	) +"  - "+tipodoc+documento)
Next	
Return 0

end function

public function integer grabar (string tipo);if not f_demo('ter') then Return -1
long  inicial, final, i
st_nfact numdoc
string msg

if il_nuevo > 0 then
	numdoc =f_trae_factura('NM',clugar,'Nomina')
	if numdoc.ndoc=-1 then 
		Rollback;
		Return -1
	end if
	tab_n.tpn_1.dw_nomcab.setItem(il_nuevo,'num_nomina', numdoc.ndoc)
	tab_n.tpn_1.dw_nomcab.setItem(il_nuevo,'c_aut', numdoc.c_aut)
	tab_1.p_1.dw_devenga.SetRedraw(FALSE)
	tab_1.p_1.dw_devenga.SetFilter("")
	tab_1.p_1.dw_devenga.Filter()
	for i = 1 to tab_1.p_1.dw_devenga.RowCount()
		tab_1.p_1.dw_devenga.SetItem(i,'num_nomina',numdoc.ndoc)
	Next
	tab_1.p_1.dw_deduce.SetRedraw(FALSE)
	tab_1.p_1.dw_deduce.SetFilter("")
	tab_1.p_1.dw_deduce.Filter()
	for i = 1 to tab_1.p_1.dw_deduce.RowCount()
		tab_1.p_1.dw_deduce.SetItem(i,'num_nomina',numdoc.ndoc)
	Next
	tab_1.p_2.dw_novedad.SetRedraw(FALSE)
	dw_ausend.setfilter("")
	dw_ausend.filter()
	for i = 1 to dw_ausend.RowCount()
		dw_ausend.SetItem(i,'num_nomina',numdoc.ndoc)
	Next	
	
	tab_1.p_2.dw_novedad.SetFilter("")
	tab_1.p_2.dw_novedad.Filter()
	for i = 1 to tab_1.p_2.dw_novedad.RowCount()
		tab_1.p_2.dw_novedad.SetItem(i,'num_nomina',numdoc.ndoc)
	Next
	tab_1.p_5.dw_ap.SetRedraw(FALSE)
	tab_1.p_5.dw_ap.SetFilter("")
	tab_1.p_5.dw_ap.Filter()
	for i = 1 to tab_1.p_5.dw_ap.RowCount()
		tab_1.p_5.dw_ap.SetItem(i,'num_nomina',numdoc.ndoc)
	Next
	tab_n.tpn_2.dw_empnom.TriggerEvent(RowFocusChanged!)
	tab_1.p_5.dw_ap.SetRedraw(TRUE)
	tab_1.p_2.dw_novedad.SetRedraw(TRUE)
	tab_1.p_1.dw_deduce.SetRedraw(TRUE)
	tab_1.p_1.dw_devenga.SetRedraw(TRUE)
	if ibn_calculando then redraw(FALSE)
end if
if tab_n.tpn_1.dw_nomcab.update(TRUE,FALSE) = -1 then
	rollback;
	Return -1
end if

operacion = 'Delete' 
if tab_1.p_1.dw_devenga.update(TRUE,FALSE) = -1 then
	rollback;
	Return -1
end if
if tab_1.p_1.dw_deduce.update(TRUE,FALSE) = -1 then
	rollback;
	Return -1
end if
if dw_ausend.update(TRUE,FALSE) = -1 then
	rollback;
	Return -1
end if
if tab_1.p_2.dw_novedad.update(TRUE,FALSE) = -1 then
	rollback;
	Return -1
end if
if tab_1.p_5.dw_ap.update(TRUE,FALSE) = -1 then
	rollback;
	Return -1
end if

operacion = 'Insert' 
if tab_1.p_1.dw_devenga.update(TRUE,FALSE) = -1 then
	rollback;
	Return -1
end if
if tab_1.p_1.dw_deduce.update(TRUE,FALSE) = -1 then
	rollback;
	Return -1
end if
if tab_1.p_2.dw_novedad.update(TRUE,FALSE) = -1 then
	rollback;
	Return -1
end if
if tab_1.p_5.dw_ap.update(TRUE,FALSE) = -1 then
	rollback;
	Return -1
end if
if dw_ausend.update(TRUE,FALSE) = -1 then
	rollback;
	Return -1
end if

if tipo = 'definitivo' then
	string filtro, tipodoc, documento, cod_concep, concep_sueldo
	long fcontra, fila, num_doc, ncuota, ncargo, item, plan, num_nomina, ano, mes, nc, it, ot, cantidad
	double valor
	dateTime fecha
	uo_datastore dw_nov
	dw_nov = CREATE uo_datastore
	dw_nov.DataObject = "dw_novedades"
	filtro = tab_1.p_2.dw_novedad.Describe("DataWindow.Table.Filter")
	tab_1.p_2.dw_novedad.SetFilter("")
	tab_1.p_2.dw_novedad.Filter()
	if tab_1.p_2.dw_novedad.RowCount() > 0 then
		dw_nov.Object.Data = tab_1.p_2.dw_novedad.Object.Data
	end if
	tab_1.p_2.dw_novedad.SetFilter(filtro)
	tab_1.p_2.dw_novedad.Filter()
	ano = year(date(tab_n.tpn_1.dw_nomcab.GetItemDateTime(tab_n.tpn_1.dw_nomcab.GetRow(),'inicia')))
	mes = month(date(tab_n.tpn_1.dw_nomcab.GetItemDateTime(tab_n.tpn_1.dw_nomcab.GetRow(),'inicia')))
	
	for i = 1 to dw_nov.RowCount()
		num_doc = dw_nov.GetItemNumber(i,'numdoc')
		plan = dw_nov.GetItemNumber(i,'num_plan')
		ncuota = dw_nov.GetItemNumber(i,'cuota')
		valor = dw_nov.GetItemNumber(i,'pagado')
		cantidad = dw_nov.GetItemNumber(i,'cantidad_ac')
		num_nomina = dw_nov.GetItemNumber(i,'num_nomina')
		tipodoc = dw_nov.GetItemString(i,'tipodoc')
		documento = dw_nov.GetItemString(i,'documento')
		item = dw_nov.GetItemNumber(i,'item')
		cod_concep = dw_nov.GetItemString(i,'cod_concep')
		ncargo= dw_nov.GetItemnumber(i,'ncargo')
		fecha = tab_n.tpn_1.dw_nomcab.GetItemDateTime(tab_n.tpn_1.dw_nomcab.GetRow(),'termina')

		// AHORRO- Ojo no debe cambiar
		if dw_nov.GetItemString(i,'cod_tipo_concep') = '8' then 
			insert into nom_ahorro_cp (num_ahorro,ncuota,fecha,valor,estado,num_nomina,tipodoc,documento,cod_concep,item,ncargo)
			values(:num_doc,:ncuota,:fecha,:valor,'1',:num_nomina,:tipodoc,:documento,:cod_concep,:item,:ncargo);
			IF SQLCA.SQLCode = -1 THEN
				msg = SQLCA.SQLErrText
				Rollback;
				MessageBox("SQL error", msg)
				Return -1
			END IF
		end if
		 // PRESTAMO
		if dw_nov.GetItemString(i,'cod_tipo_concep') = '7' then
			update nom_coope_plan_cp set num_nomina=:num_nomina,tipodoc=:tipodoc, valor=:valor,
			documento=:documento, cod_concep=:cod_concep, item=:item, estado = '1',ncargo=:ncargo
			where num_prescoopera=:num_doc and num_plan=:plan and ncuota=:ncuota;
			IF SQLCA.SQLCode = -1 THEN
				msg = SQLCA.SQLErrText
				Rollback;
				MessageBox("SQL error", msg)
				Return -1
			END IF
		end if
		/// TRABAJO SUPLEMENTARIO
		update nom_tsup set num_nomina=:num_nomina, tipodoc_nom=:tipodoc, documento_nom=:documento, cod_concep_nom=:cod_concep, item_nom=:item, valor=:valor*(horas/:cantidad),ncargo_nom=:ncargo
		where tipodoc=:tipodoc and documento=:documento and ano=:ano and mes=:mes and cod_concep=:cod_concep;
		IF SQLCA.SQLCode = -1 THEN
			msg = SQLCA.SQLErrText
			Rollback;
			MessageBox("SQL error", msg)
			Return -1
		END IF
	Next
	
	//// CONTRATOS
	tab_1.p_1.dw_devenga.SetRedraw(FALSE)
	tab_1.p_1.dw_devenga.SetFilter("")
	tab_1.p_1.dw_devenga.Filter()
	num_nomina = tab_n.tpn_1.dw_nomcab.GetItemNumber(tab_n.tpn_1.dw_nomcab.Getrow(),'num_nomina')
	fcontra = tab_1.p_1.dw_devenga.Find('ncontrato > 0 ',1,tab_1.p_1.dw_devenga.RowCount())
	do while fcontra > 0
		ano = tab_1.p_1.dw_devenga.GetItemNumber(fcontra,'ano')
		nc = tab_1.p_1.dw_devenga.GetItemNumber(fcontra,'ncontrato')
		ot = tab_1.p_1.dw_devenga.GetItemNumber(fcontra,'otrosi')
		it = tab_1.p_1.dw_devenga.GetItemNumber(fcontra,'item_fp')
		update contra_f_pago set num_nomina = :num_nomina, pagado='1', autorizado='1'
		where ano=:ano and ncontrato=:nc and otrosi=:ot and item=:it;
		IF SQLCA.SQLCode = -1 THEN
			msg = SQLCA.SQLErrText
			Rollback;
			MessageBox("SQL error", msg)
			Return -1
		END IF
		if fcontra = tab_1.p_1.dw_devenga.RowCount() then EXIT
		fcontra = tab_1.p_1.dw_devenga.Find('ncontrato > 0',fcontra + 1,tab_1.p_1.dw_devenga.RowCount())
	loop
	tab_n.tpn_2.dw_empnom.TriggerEvent(rowFocuschanged!)
	tab_1.p_1.dw_devenga.SetRedraw(TRUE)

	tab_n.tpn_1.dw_nomcab.setItem(tab_n.tpn_1.dw_nomcab.GetRow(),'estado', '1')
	if tab_n.tpn_1.dw_nomcab.update() = -1 then
		rollback;
		Return -1
	end if
	///////////////////////////RETRO
	if tab_n.tpn_1.dw_nomcab.GetItemString(tab_n.tpn_1.dw_nomcab.GetRow(),'tipo') = 'R' then
			if g_motor='postgres' then
				UPDATE nom_cpo set 
					valorc_org=valor_c ,pagado_org=pagado,
					valor_c = actual_ncpo.difvalorc, pagado = actual_ncpo.difpagado
				FROM 
						(
							SELECT 
								nom_cpo1.num_nomina, nom_cpo1.tipodoc, nom_cpo1.documento, 
								nom_cpo1.ncargo, nom_cpo1.cod_concep, nom_cpo1.item,
								(nom_cpo1.valor_c-nom_cpo2.valor_c) AS difvalorc, 
								(nom_cpo1.pagado-nom_cpo2.pagado) AS difpagado, 
								nom_concep.equ_retro, nom_cpo1.num_nomina AS norg, 
								nom_cpo1.item AS itemorg
							FROM 
								nom_cpo AS nom_cpo1 INNER JOIN (nom_cpo AS nom_cpo2 INNER JOIN nom_concep 
								ON nom_cpo2.cod_concep = nom_concep.cod_concep) 
								ON (nom_cpo1.nomina_org = nom_cpo2.num_nomina) AND (nom_cpo1.tipodoc_org = nom_cpo2.tipodoc) 
								AND (nom_cpo1.documento_org = nom_cpo2.documento) AND (nom_cpo1.ncargo_org = nom_cpo2.ncargo) 
								AND (nom_cpo1.concep_org = nom_cpo2.cod_concep) AND (nom_cpo1.item_org = nom_cpo2.item)
							WHERE 
								(((nom_cpo1.num_nomina)=:num_nomina))
						) 	as actual_ncpo 
					WHERE 
						(nom_cpo.cod_concep = actual_ncpo.cod_concep) 
						and (nom_cpo.item = actual_ncpo.item) 
						and (nom_cpo.ncargo = actual_ncpo.ncargo) 
						and (nom_cpo.documento = actual_ncpo.documento) 
						and (nom_cpo.tipodoc = actual_ncpo.tipodoc) 
						and (nom_cpo.num_nomina = actual_ncpo.num_nomina) ;
		
				if sqlca.sqlcode=-1 then
					messagebox("Error Actualizando retro postgres",sqlca.sqlerrtext)
					rollback;
					Return -1
				end if
			//	
			//	DELETE FROM 
			//		nom_cpo 
			//	WHERE 
			//		  EXISTS(
			//			select 
			//				1
			//			from 
			//				(nom_cpo as nom_cpo1  inner join nom_cpo as nom_cpo2 on (nom_cpo1.tipodoc = nom_cpo2.tipodoc) 
			//				 and (nom_cpo1.documento = nom_cpo2.documento) and (nom_cpo1.ncargo = nom_cpo2.ncargo) 
			//				 and (nom_cpo1.cod_concep = nom_cpo2.cod_concep)) inner join nom_concep on nom_cpo2.cod_concep = nom_concep.cod_concep
			//				where 
			//					(((nom_cpo2.num_nomina)=:numdoc) and ((nom_cpo1.num_nomina)=:nomina)) 
			//					AND (((nom_cpo2.valor_c - nom_cpo1.valor_c)<=0) or (((nom_cpo2.pagado - nom_cpo1.pagado))<=0)) 
			//					AND (nom_cpo.cod_concep = nom_cpo1.cod_concep) 
			//					and (nom_cpo.item = nom_cpo2.item) 
			//					and (nom_cpo.ncargo = nom_cpo2.ncargo) 
			//					and (nom_cpo.documento = nom_cpo2.documento) 
			//					and (nom_cpo.tipodoc = nom_cpo2.tipodoc) 
			//					and (nom_cpo.num_nomina = nom_cpo2.num_nomina)
			//		);		
			//		
			//	if sqlca.sqlcode=-1 then
			//		messagebox("Error Borrando",sqlca.sqlerrtext)
			//		rollback;
			//	//	goto ERRORES
			//		return	
			//	end if
		Else
			UPDATE nom_cpo set 
				valorc_org=valor_c ,pagado_org=pagado,
				valor_c = actual_ncpo.difvalorc, pagado = actual_ncpo.difpagado
			FROM 
				(
					SELECT 
						nom_cpo1.num_nomina, nom_cpo1.tipodoc, nom_cpo1.documento, 
						nom_cpo1.ncargo, nom_cpo1.cod_concep, nom_cpo1.item,
						(nom_cpo1.valor_c-nom_cpo2.valor_c) AS difvalorc, 
						(nom_cpo1.pagado-nom_cpo2.pagado) AS difpagado, 
						nom_concep.equ_retro, nom_cpo1.num_nomina AS norg, 
						nom_cpo1.item AS itemorg
					FROM 
						nom_cpo AS nom_cpo1 INNER JOIN (nom_cpo AS nom_cpo2 INNER JOIN nom_concep 
						ON nom_cpo2.cod_concep = nom_concep.cod_concep) 
						ON (nom_cpo1.nomina_org = nom_cpo2.num_nomina) AND (nom_cpo1.tipodoc_org = nom_cpo2.tipodoc) 
						AND (nom_cpo1.documento_org = nom_cpo2.documento) AND (nom_cpo1.ncargo_org = nom_cpo2.ncargo) 
						AND (nom_cpo1.concep_org = nom_cpo2.cod_concep) AND (nom_cpo1.item_org = nom_cpo2.item)
					WHERE 
					(((nom_cpo1.num_nomina)=:num_nomina))
				) 	as actual_ncpo 
			WHERE 
				(nom_cpo.cod_concep = actual_ncpo.cod_concep) 
				and (nom_cpo.item = actual_ncpo.item) 
				and (nom_cpo.ncargo = actual_ncpo.ncargo) 
				and (nom_cpo.documento = actual_ncpo.documento) 
				and (nom_cpo.tipodoc = actual_ncpo.tipodoc) 
				and (nom_cpo.num_nomina = actual_ncpo.num_nomina) ;
			if sqlca.sqlcode=-1 then
				messagebox("Error Actualizando retro no postgres",sqlca.sqlerrtext)
				rollback;
				Return -1
			end if
		//	DELETE nom_cpo 
		//	FROM 
		//		nom_cpo inner join 
		//		(	select nom_cpo2.num_nomina, nom_cpo2.tipodoc, nom_cpo2.documento, nom_cpo2.ncargo, nom_cpo1.cod_concep, nom_cpo2.item, (nom_cpo2.valor_c - nom_cpo1.valor_c) as difvalorc, (nom_cpo2.pagado - nom_cpo1.pagado) as difpagado, nom_concep.equ_retro
		//			from (nom_cpo as nom_cpo1  inner join nom_cpo as nom_cpo2 on (nom_cpo1.tipodoc = nom_cpo2.tipodoc) and (nom_cpo1.documento = nom_cpo2.documento) and (nom_cpo1.ncargo = nom_cpo2.ncargo) and (nom_cpo1.cod_concep = nom_cpo2.cod_concep)) inner join nom_concep on nom_cpo2.cod_concep = nom_concep.cod_concep
		//			where (((nom_cpo2.num_nomina)=:numdoc) and ((nom_cpo1.num_nomina)=:nomina)) 
		//		) as actual_ncpo on (nom_cpo.cod_concep = actual_ncpo.cod_concep) and (nom_cpo.item = actual_ncpo.item) and (nom_cpo.ncargo = actual_ncpo.ncargo) and (nom_cpo.documento = actual_ncpo.documento) and (nom_cpo.tipodoc = actual_ncpo.tipodoc) and (nom_cpo.num_nomina = actual_ncpo.num_nomina)
		//	WHERE (((actual_ncpo.difvalorc)<=0) or ((actual_ncpo.difpagado)<=0));
		//	if sqlca.sqlcode=-1 then
		//		messagebox("Error Borrando",sqlca.sqlerrtext)
		//		rollback;
		//	//	goto ERRORES
		//		return
		//	end if
		//end if
		//
		//UPDATE nom_cab set retro='1'
		//WHERE num_nomina=:nomina;
		//if sqlca.sqlcode=-1 then
		//	messagebox("Error Actualizando Retro",sqlca.sqlerrtext)
		//	rollback;
		//	goto ERRORES
		//	return
		//end if
		//UPDATE nom_cab set estado='1',nomina_retro=:nomina
		//WHERE num_nomina=:numdoc;
		//if sqlca.sqlcode=-1 then
		//	messagebox("Error Estado",sqlca.sqlerrtext)
		//	rollback;
		//	return
		end if //postgres
	End if // retroactivo
	
	////////////////////////////////
end if //definitivo
il_nuevo = 0
commit;
tab_n.tpn_1.dw_nomcab.ResetUpdate() 
tab_1.p_1.dw_devenga.ResetUpdate() 
tab_1.p_1.dw_deduce.ResetUpdate()
tab_1.p_2.dw_novedad.ResetUpdate()
tab_1.p_5.dw_ap.ResetUpdate()
dw_ausend.ResetUpdate()
cambio = FALSE
Return 0

end function

public function integer grabar ();Return grabar('temporal')

end function

public function long ausentismo (string tipodoc, string documento, st_interfec interv, integer filahist);long dias, i, fila,filan, inc_t,l_j,inc,l_x,dias_incpt,inc_tt,calculado,dias_incptini
st_interfec ivac, iret, iper
string incap,tipo_nomina,incap_bas,ls_filtro
int xitem, yitem, ciclo, li_diasbase
boolean inicial

vac = 0
l_inc = 0
l_incp = 0
lm = 0 
ln = 0
lp=0
l_sus=0
l_perm=0
l_luto=0
dias_incpt=0
l_asjc=0

log.info("Inicia ausentismo "+ tipodoc+documento)

iper.x = tab_n.tpn_1.dw_nomcab.GetItemDateTime(tab_n.tpn_1.dw_nomcab.GetRow(),'inicia')
iper.y = tab_n.tpn_1.dw_nomcab.GetItemDateTime(tab_n.tpn_1.dw_nomcab.GetRow(),'termina')
tipo_nomina=tab_n.tpn_1.dw_nomcab.GetItemstring(tab_n.tpn_1.dw_nomcab.GetRow(),'tipo')
if ibn_calculando then
	///////////////////////////////////
	// VACACIONES
	//dw_aus.Retrieve(tipodoc,documento,'VA',iper.x,datetime(relativedate(date(iper.y),30) ))
	datos_ausentismo(tipodoc, documento, 'VA')
	long ano,mes
	boolean pasov=false
	for i = 1 to dw_aus.RowCount()
		////////////  INICIO PUBLICO
		if tipodoc<>dw_aus.GetItemString(i,'tipodoc') and documento<>dw_aus.GetItemString(i,'documento') then
			pasov=true
		end if
		inc_t = 0
		inc_tt=0
		if ls_vac='1' then 
			ano = tab_n.tpn_1.dw_nomcab.GetItemNumber(tab_n.tpn_1.dw_nomcab.GetRow(),'ano')
			mes = tab_n.tpn_1.dw_nomcab.GetItemNumber(tab_n.tpn_1.dw_nomcab.GetRow(),'mes') + 1
			if mes > 12 then
				ano = ano + 1
				mes = 1
			end if
			if month(date(dw_aus.GetItemDate(i,'fechaini'))) = mes and year(date(dw_aus.GetItemDate(i,'fechaini'))) = ano and ibn_calculando  then
				filan = tab_1.p_2.dw_novedad.Find("sigla='"+dw_aus.GetItemString(i,'sigla')+"'",1,tab_1.p_2.dw_novedad.RowCount())
				if filan = 0  then
					filan = tab_1.p_2.pb_addnov.Event clicked()
					tab_1.p_2.dw_novedad.SetItem(filan,'tipodoc', tipodoc)
					tab_1.p_2.dw_novedad.SetItem(filan,'documento', documento)

					tab_1.p_2.dw_novedad.SetItem(filan,'nsalario',dw_historia.getitemnumber(filahist,'nsalario'))
					tab_1.p_2.dw_novedad.SetItem(filan,'ncargo',dw_historia.getitemnumber(filahist,'ncargo'))
					tab_1.p_2.dw_novedad.SetItem(filan,'ntraslado',dw_historia.getitemnumber(filahist,'ntraslado'))
					tab_1.p_2.dw_novedad.SetItem(filan,'cod_concep',dw_aus.GetItemString(i,'cod_concep'))
					tab_1.p_2.dw_novedad.SetItem(filan,'sigla',dw_aus.GetItemString(i,'sigla'))
					tab_1.p_2.dw_novedad.SetItem(filan,'des_concep',dw_aus.GetItemString(i,'des_concep'))
					tab_1.p_2.dw_novedad.SetItem(filan,'tipo',dw_aus.GetItemString(i,'tipo_concep'))
					tab_1.p_2.dw_novedad.SetItem(filan,'form_calculo',dw_aus.GetItemString(i,'form_calculo'))
					tab_1.p_2.dw_novedad.SetItem(filan,'cod_tipo_concep',dw_aus.GetItemString(i,'cod_tipo_concep'))
					tab_1.p_2.dw_novedad.SetItem(filan,'cantidad_ac',dias_vac(datetime(dw_aus.GetItemDate(i,'fechaini')),datetime(dw_aus.GetItemDate(i,'fechafin'))))
					if f_addcompute( dw_aus.GetItemString(i,'sigla'), dw_aus.GetItemString(i,'form_calculo'), dw_aus.GetItemString(i,'form_verifica'), dw_aus.GetItemnumber(i,'tarifa'),dw_aus.GetItemnumber(i,'tarifa_esp'),1) = -1 then Return -1	
			
					fila =dw_ausend.Find("tipodoc='"+tipodoc+"' and documento='"+documento+"' and cod_ausen='"+dw_aus.GetItemString(i,'cod_ausen')+"' and ncargo="+string(dw_historia.getitemnumber(filahist,'ncargo'))+" and cod_concep='"+dw_aus.GetItemString(i,'cod_concep')+"' and dias="+string(vac),1,dw_ausend.RowCount())
					if fila=0 then fila=dw_ausend.insertrow(0)
					dw_ausend.setitem(fila,'tipodoc',tipodoc)
					dw_ausend.setitem(fila,'documento',documento )
					dw_ausend.setitem(fila,'cod_ausen',dw_aus.GetItemString(i,'cod_ausen'))
					dw_ausend.setitem(fila,'item',dw_aus.GetItemnumber(i,'item'))		
					dw_ausend.setitem(fila,'tipodoc_n',tipodoc)
					dw_ausend.setitem(fila,'documento_n',documento )
					dw_ausend.setitem(fila,'ncargo',dw_historia.getitemnumber(filahist,'ncargo'))
					dw_ausend.setitem(fila,'cod_concep',dw_aus.GetItemString(i,'cod_concep') )
					dw_ausend.setitem(fila,'dias',dias_vac(datetime(dw_aus.GetItemDate(i,'fechaini')),datetime(dw_aus.GetItemDate(i,'fechafin'))))
					dw_ausend.setitem(fila,'fecha_audita',datetime(today(),now()))	 
					dw_ausend.setitem(fila,'item_n',tab_1.p_2.dw_novedad.getitemnumber(filan,'item'))
					dw_ausend.setitem(fila,'num_nomina',tab_1.p_2.dw_novedad.getitemnumber(filan,'num_nomina'))
				end if
			end if
			ivac.x = datetime(dw_aus.GetItemDate(i,'fechaini'))
			ivac.y = datetime(dw_aus.GetItemDate(i,'fechafin'))
			iret = interseccion(interv,ivac)
			if (not isNull(iret.x)) and (not isNull(iret.y)) then
				if day(date(iret.y)) = 31 then
					inc_t = DaysAfter(date(iret.x),date(iret.y))
				else
					if month(date(iret.y)) = 2 and iret.y = iper.y then
						inc_t = DaysAfter(date(iret.x),date(iret.y)) + 1 + (30 - day(date(iper.y)))
					else
						inc_t = DaysAfter(date(iret.x),date(iret.y)) + 1
					end if
				end if
			end if
			vac=vac+inc_t
			 ///FIN PUBLICO
		else 
			 ///INICIA PRIVADO
			ano = tab_n.tpn_1.dw_nomcab.GetItemNumber(tab_n.tpn_1.dw_nomcab.GetRow(),'ano')
			mes = tab_n.tpn_1.dw_nomcab.GetItemNumber(tab_n.tpn_1.dw_nomcab.GetRow(),'mes')
			if mes > 12 then
				ano = ano + 1
				mes = 1
			end if	
			ivac.x = datetime(dw_aus.GetItemDate(i,'fechaini'))
			ivac.y = datetime(dw_aus.GetItemDate(i,'fechafin'))
			iret = interseccion(interv,ivac)
			if (not isNull(iret.x)) and (not isNull(iret.y)) then
				if iret = iper then
					inc_t = periodo
				elseif day(date(iret.y)) = 31 then
					inc_t=DaysAfter(date(iret.x),date(iret.y))
				else
				//	if month(date(iret.y)) = 2 and iret.y = iper.y then
				//		inc_t = DaysAfter(date(iret.x),date(iret.y)) + 1 + (30 - day(date(iper.y)))
				//	else
						inc_t= DaysAfter(date(iret.x),date(iret.y)) + 1
				//	end if
				end if
			end if	
			vac=vac+inc_t
			if tipo_nomina='V' then
				if  vac> 0 and ibn_calculando  then
					if iret.x<=ivac.x then 
						filan = tab_1.p_2.dw_novedad.Find("sigla='"+dw_aus.GetItemString(i,'sigla')+"'",1,tab_1.p_2.dw_novedad.RowCount())
						if filan = 0 then
							filan = tab_1.p_2.pb_addnov.Event clicked()
							tab_1.p_2.dw_novedad.SetItem(filan,'tipodoc', tipodoc)
							tab_1.p_2.dw_novedad.SetItem(filan,'documento', documento)

							tab_1.p_2.dw_novedad.SetItem(filan,'nsalario',dw_historia.getitemnumber(filahist,'nsalario'))
							tab_1.p_2.dw_novedad.SetItem(filan,'ncargo',dw_historia.getitemnumber(filahist,'ncargo'))
							tab_1.p_2.dw_novedad.SetItem(filan,'ntraslado',dw_historia.getitemnumber(filahist,'ntraslado'))
							tab_1.p_2.dw_novedad.SetItem(filan,'cod_concep',dw_aus.GetItemString(i,'cod_concep'))
							tab_1.p_2.dw_novedad.SetItem(filan,'sigla',dw_aus.GetItemString(i,'sigla'))
							tab_1.p_2.dw_novedad.SetItem(filan,'des_concep',dw_aus.GetItemString(i,'des_concep'))
							tab_1.p_2.dw_novedad.SetItem(filan,'tipo',dw_aus.GetItemString(i,'tipo_concep'))
							tab_1.p_2.dw_novedad.SetItem(filan,'form_calculo',dw_aus.GetItemString(i,'form_calculo'))
							tab_1.p_2.dw_novedad.SetItem(filan,'cod_tipo_concep',dw_aus.GetItemString(i,'cod_tipo_concep'))
							if ls_vpriprev='1' then
								inc_t=dias_vac(datetime(dw_aus.GetItemDate(i,'fechaini')),datetime(dw_aus.GetItemDate(i,'fechafin')))
								tab_1.p_2.dw_novedad.SetItem(filan,'cantidad_ac',inc_t)
							else
								tab_1.p_2.dw_novedad.SetItem(filan,'cantidad_ac',vac)
							end if
							if f_addcompute( dw_aus.GetItemString(i,'sigla'), dw_aus.GetItemString(i,'form_calculo'), dw_aus.GetItemString(i,'form_verifica'), dw_aus.GetItemnumber(i,'tarifa'),dw_aus.GetItemnumber(i,'tarifa_esp'),1) = -1 then Return -1	
						else
							if ls_vpriprev='1' then
								inc_tt=dias_vac(datetime(dw_aus.GetItemDate(i,'fechaini')),datetime(dw_aus.GetItemDate(i,'fechafin')))
								if pasov then 
									inc_tt=inc_tt+tab_1.p_2.dw_novedad.getitemnumber(filan,'cantidad_ac')
								else
									pasov=true
								end if
								tab_1.p_2.dw_novedad.SetItem(filan,'cantidad_ac',inc_tt)
							else
								tab_1.p_2.dw_novedad.SetItem(filan,'cantidad_ac',vac)
							end if			
						end if
						fila =dw_ausend.Find("tipodoc='"+tipodoc+"' and documento='"+documento+"' and cod_ausen='"+dw_aus.GetItemString(i,'cod_ausen')+"' and ncargo="+string(dw_historia.getitemnumber(filahist,'ncargo'))+" and cod_concep='"+dw_aus.GetItemString(i,'cod_concep')+"' and dias="+string(inc_t),1,dw_ausend.RowCount())
						if fila=0 then fila=dw_ausend.insertrow(0)
						dw_ausend.setitem(fila,'tipodoc',tipodoc)
						dw_ausend.setitem(fila,'documento',documento )
						dw_ausend.setitem(fila,'cod_ausen',dw_aus.GetItemString(i,'cod_ausen'))
						dw_ausend.setitem(fila,'item',dw_aus.GetItemnumber(i,'item'))		
						dw_ausend.setitem(fila,'tipodoc_n',tipodoc)
						dw_ausend.setitem(fila,'documento_n',documento )
						dw_ausend.setitem(fila,'ncargo',dw_historia.getitemnumber(filahist,'ncargo'))
						dw_ausend.setitem(fila,'cod_concep',dw_aus.GetItemString(i,'cod_concep') )
						dw_ausend.setitem(fila,'dias',inc_t)
						dw_ausend.setitem(fila,'fecha_audita',datetime(today(),now()))	 
						dw_ausend.setitem(fila,'item_n',tab_1.p_2.dw_novedad.getitemnumber(filan,'item'))
						dw_ausend.setitem(fila,'num_nomina',tab_1.p_2.dw_novedad.getitemnumber(filan,'num_nomina'))
					end if
				end if
			end if 
			//FIN PRIVADO
		end if
	next
	
	if filahist > 0 then
		dw_historia.SetItem(filahist,'diasvac',vac)
		if vac > 0 then	dw_historia.SetItem(filahist,get_parm_nov(dw_aus.GetItemString(dw_aus.GetRow(),'sigla')),vac)
	end if
	
	if tipo_nomina<>'V' then 
		///////////////////////////////////
		// INCAPACIDADES
		dw_tipoincap.GetChild('cod_concep', dwc_ce)
		dw_tipoincap.GetChild('cod_concep_base', dwc_ce_bas)
		dwc_ce.SetTransObject(SQLCA)
		dwc_ce_bas.SetTransObject(SQLCA)
		dwc_ce.Retrieve(i_cemp)
		dwc_ce_bas.Retrieve(i_cemp)
		dw_tipoincap.retrieve()
		dw_tipoincap.setfilter("estado ='1' and incap='1'")
		dw_tipoincap.filter()
		for l_j = 1 to dw_tipoincap.RowCount()
			incap=dw_tipoincap.getitemstring(l_j,'cod_ausen')
			//dw_aus.Retrieve(tipodoc,documento,incap,iper.x,iper.y)
			datos_ausentismo(tipodoc, documento, incap)
			if dw_aus.rowcount()=0 then continue 
			/// INICIA BORRA LO existente
			setnull(ls_filtro)
			if not isnull(dw_aus.GetItemString(dw_aus.GetRow(),'cod_concep_base')) then
				ls_filtro="((cod_concep='"+dw_aus.GetItemString(dw_aus.GetRow(),'cod_concep_base')+"'"
				if not isnull(dw_aus.GetItemString(dw_aus.GetRow(),'cod_concep')) then
					ls_filtro=ls_filtro + " OR cod_concep='"+dw_aus.GetItemString(dw_aus.GetRow(),'cod_concep')+"')"
				end if
			else
				ls_filtro="((cod_concep='"+dw_aus.GetItemString(dw_aus.GetRow(),'cod_concep')+"')"
			end if
			ls_filtro=ls_filtro + " AND (tipodoc='"+tipodoc+"' and documento='"+documento+"'))"
			tab_1.p_2.dw_novedad.setfilter(ls_filtro)
			tab_1.p_2.dw_novedad.filter()
			setnull(ls_filtro)
			do while tab_1.p_2.dw_novedad.rowcount()>0
				if not isnull(string(tab_1.p_2.dw_novedad.getitemnumber(1,'num_nomina'))) then
					ls_filtro="num_nomina="+string(tab_1.p_2.dw_novedad.getitemnumber(1,'num_nomina'))+' and '
				end if
				ls_filtro=ls_filtro+"tipodoc_n='"+tipodoc+"' and "
				ls_filtro=ls_filtro+"documento_n='"+documento+"' and "
				ls_filtro=ls_filtro+"cod_concep='"+tab_1.p_2.dw_novedad.getitemstring(1,'cod_concep')+"' and "
				ls_filtro=ls_filtro+"item_n="+string(tab_1.p_2.dw_novedad.getitemnumber(1,'item'))
				if not isnull(ls_filtro) then
					dw_ausend.setfilter(ls_filtro)
					dw_ausend.filter()
					for i=dw_ausend.rowcount() to 1 step -1
						dw_ausend.DeleteRow(i)
					next
					dw_ausend.setfilter('')
					dw_ausend.filter()
				end if
				tab_1.p_2.dw_novedad.DeleteRow(1)
			loop	
			tab_1.p_2.dw_novedad.setfilter("tipodoc='" + tipodoc + "' and documento='" +documento + "'")
			tab_1.p_2.dw_novedad.filter()
			setnull(ls_filtro)
			/// FIN BORRA LO existente
			
			inc=0
			for i = 1 to dw_aus.RowCount()
				inc_t = 0
				ivac.x = datetime(dw_aus.GetItemDate(i,'fechaini'))
				ivac.y = datetime(dw_aus.GetItemDate(i,'fechafin'))
				ivac.dias = dw_aus.GetItemnumber(i,'dias_base')
				If isnull(Ivac.dias) then 
					MessageBox('Atención','Configurar dias base para '+ dw_aus.GetItemString(dw_aus.GetRow(),'sigla'))
					return -1
				end if
				iret = interseccion(interv,ivac)
				if (not isNull(iret.x)) and (not isNull(iret.y)) then
					if dw_aus.GetItemString(i,'tipo') = 'I'  then //Incapacidad normal
						dias_incpt=0
						dias_incptini=0
						inicial=true

						if iret = iper then
							inc_t = periodo
						elseif day(date(iret.y)) = 31 then
			
							inc_t = DaysAfter(date(iret.x),date(iret.y))
						else
							//if month(date(iret.y)) = 2 and iret.y = iper.y then
							//	inc_t = DaysAfter(date(iret.x),date(iret.y)) + 1 + (30 - day(date(iper.y)))
							//else
								inc_t = DaysAfter(date(iret.x),date(iret.y)) + 1
							//end if
						end if
						if ivac.x < iper.x and DaysAfter(date(ivac.x),date(iper.x)) < ivac.dias then
							inc_t = inc_t - (ivac.dias - DaysAfter(date(ivac.x),date(iret.x)) )
						else
							if ivac.x >= iper.x then
								/// no debe descontar debe ir por el otro concepto
								//inc_t = inc_t - ivac.dias
							
							else
								//dias_incptini = dias_incptini+ DaysAfter(date(ivac.x),date(iret.x))
							end if
						end if
						if inc_t < 0 then inc_t = 0
						dias_incptini+=inc_t
					elseif dw_aus.GetItemString(i,'tipo') = 'P' then
						xitem=dw_aus.GetItemnumber(i,'item_pro')
						yitem=dw_aus.GetItemnumber(i,'item')
						if dw_tipoincap.getitemstring(l_j,'origen')='1' then
							SELECT sum(total.dias) as dias into:dias_incpt
							from
							(
							SELECT sum(NOM_AUSENTISMO_DET.DIAS)  as dias
							FROM (nom_ausentismo INNER JOIN NOM_AUSENTISMO AS NOM_AUSENTISMO_1 ON (nom_ausentismo.ITEM = NOM_AUSENTISMO_1.ITEM_PRO) AND (nom_ausentismo.COD_AUSEN = NOM_AUSENTISMO_1.CODAUSEN_PRO) AND (nom_ausentismo.DOCUMENTO = NOM_AUSENTISMO_1.DOCUMENTO_PRO) AND (nom_ausentismo.TIPODOC = NOM_AUSENTISMO_1.TIPODOC_PRO)) INNER JOIN NOM_AUSENTISMO_DET ON (NOM_AUSENTISMO_1.ITEM = NOM_AUSENTISMO_DET.ITEM) AND (NOM_AUSENTISMO_1.COD_AUSEN = NOM_AUSENTISMO_DET.COD_AUSEN) AND (NOM_AUSENTISMO_1.DOCUMENTO = NOM_AUSENTISMO_DET.DOCUMENTO) AND (NOM_AUSENTISMO_1.TIPODOC = NOM_AUSENTISMO_DET.TIPODOC)
							WHERE (((nom_ausentismo.TIPODOC)=:tipodoc) AND ((nom_ausentismo.DOCUMENTO)=:documento) AND ((nom_ausentismo.COD_AUSEN)=:incap) AND ((nom_ausentismo.ITEM)=:xitem) AND ((NOM_AUSENTISMO_1.ESTADO)='1') AND ((NOM_AUSENTISMO_1.ITEM)<:yitem) AND ((NOM_AUSENTISMO_1.ESTADO)='1'))
							UNION ALL
							SELECT sum(NOM_AUSENTISMO_DET.DIAS)
							FROM nom_ausentismo INNER JOIN NOM_AUSENTISMO_DET ON (nom_ausentismo.ITEM = NOM_AUSENTISMO_DET.ITEM) AND (nom_ausentismo.COD_AUSEN = NOM_AUSENTISMO_DET.COD_AUSEN) AND (nom_ausentismo.DOCUMENTO = NOM_AUSENTISMO_DET.DOCUMENTO) AND (nom_ausentismo.TIPODOC = NOM_AUSENTISMO_DET.TIPODOC)
							WHERE (((nom_ausentismo.TIPODOC)=:tipodoc) AND ((nom_ausentismo.DOCUMENTO)=:documento) AND ((nom_ausentismo.COD_AUSEN)=:incap) AND ((nom_ausentismo.ITEM)=:xitem))
							) as total;
						end if		
						if iret = iper then
							inc_t = periodo
						elseif day(date(iret.y)) = 31 then
							inc_t = DaysAfter(date(iret.x),date(iret.y))
						else
							//if month(date(iret.y)) = 2 and iret.y = iper.y then
							//	inc_t = DaysAfter(date(iret.x),date(iret.y)) + 1 + (30 - day(date(iper.y)))
							//else
								inc_t = DaysAfter(date(iret.x),date(iret.y)) + 1
							//end if
						end if
					end if
						
					if dias_incptini > 0 then
						inicial = true
						if inc_t <= ivac.dias then
							li_diasbase = inc_t
						else
							li_diasbase = ivac.dias
						end if
					end if
					
//						if dias_incptini <= ivac.dias then 
//							inicial = true
//							ivac.dias = ivac.dias -  dias_incptini
//						else
//							inicial = false
//							ivac.dias=0
//						end if
			
			//		end if
					
					if  inc_t > 0 and ibn_calculando then
						ciclo=1
						//if ivac.dias=0 then ciclo=2
						if li_diasbase = 0 then ciclo = 2
						do while ciclo<=2
							// LA NOVEDAD
							if ciclo=1 and inicial then
								filan = tab_1.p_2.dw_novedad.Find("sigla='"+dw_aus.GetItemString(dw_aus.GetRow(),'sigla_base')+"'",1,tab_1.p_2.dw_novedad.RowCount())
							else
								filan = tab_1.p_2.dw_novedad.Find("sigla='"+dw_aus.GetItemString(dw_aus.GetRow(),'sigla')+"'",1,tab_1.p_2.dw_novedad.RowCount())
							end if
							if filan=0 then 
								filan = tab_1.p_2.pb_addnov.Event clicked()
								tab_1.p_2.dw_novedad.SetItem(filan,'tipodoc', tipodoc)
								tab_1.p_2.dw_novedad.SetItem(filan,'documento', documento)
								tab_1.p_2.dw_novedad.SetItem(filan,'item',filan)
							end if
							tab_1.p_2.dw_novedad.SetItem(filan,'nsalario',dw_historia.getitemnumber(filahist,'nsalario'))
							tab_1.p_2.dw_novedad.SetItem(filan,'ncargo',dw_historia.getitemnumber(filahist,'ncargo'))
							tab_1.p_2.dw_novedad.SetItem(filan,'ntraslado',dw_historia.getitemnumber(filahist,'ntraslado'))	
							tab_1.p_2.dw_novedad.SetItem(filan,'num_nomina',tab_n.tpn_1.dw_nomcab.GetItemNumber(tab_n.tpn_1.dw_nomcab.GetRow(),'num_nomina'))
							//if ciclo=1 and ivac.dias>0 and inicial then
							if ciclo=1 and inicial then
								tab_1.p_2.dw_novedad.SetItem(filan,'cod_concep',dw_aus.GetItemString(dw_aus.GetRow(),'cod_concep_base'))
								tab_1.p_2.dw_novedad.SetItem(filan,'sigla',dw_aus.GetItemString(dw_aus.GetRow(),'sigla_base'))
								tab_1.p_2.dw_novedad.SetItem(filan,'des_concep',dw_aus.GetItemString(dw_aus.GetRow(),'des_concep_base'))
								tab_1.p_2.dw_novedad.SetItem(filan,'form_calculo',dw_aus.GetItemString(dw_aus.GetRow(),'form_calculo_base'))
								tab_1.p_2.dw_novedad.SetItem(filan,'tipo',dw_aus.GetItemString(dw_aus.GetRow(),'tipo_concep_base'))
								tab_1.p_2.dw_novedad.SetItem(filan,'cod_tipo_concep',dw_aus.GetItemString(dw_aus.GetRow(),'cod_tipo_concep_base'))
								if f_addcompute( dw_aus.GetItemString(dw_aus.GetRow(),'sigla_base'), dw_aus.GetItemString(dw_aus.GetRow(),'form_calculo_base'), dw_aus.GetItemString(dw_aus.GetRow(),'form_verifica_base'), dw_aus.GetItemnumber(dw_aus.GetRow(),'tarifa_base'),dw_aus.GetItemnumber(dw_aus.GetRow(),'tarifa_esp_base'),1) = -1 then Return 1		
							else
								tab_1.p_2.dw_novedad.SetItem(filan,'cod_concep',dw_aus.GetItemString(dw_aus.GetRow(),'cod_concep'))
								tab_1.p_2.dw_novedad.SetItem(filan,'sigla',dw_aus.GetItemString(dw_aus.GetRow(),'sigla'))
								tab_1.p_2.dw_novedad.SetItem(filan,'des_concep',dw_aus.GetItemString(dw_aus.GetRow(),'des_concep'))
								tab_1.p_2.dw_novedad.SetItem(filan,'form_calculo',dw_aus.GetItemString(dw_aus.GetRow(),'form_calculo'))
								tab_1.p_2.dw_novedad.SetItem(filan,'tipo',dw_aus.GetItemString(dw_aus.GetRow(),'tipo_concep'))
								tab_1.p_2.dw_novedad.SetItem(filan,'cod_tipo_concep',dw_aus.GetItemString(dw_aus.GetRow(),'cod_tipo_concep'))
								if f_addcompute(dw_aus.GetItemString(dw_aus.GetRow(),'sigla'), dw_aus.GetItemString(dw_aus.GetRow(),'form_calculo'), dw_aus.GetItemString(dw_aus.GetRow(),'form_verifica'), dw_aus.GetItemnumber(dw_aus.GetRow(),'tarifa'),dw_aus.GetItemnumber(dw_aus.GetRow(),'tarifa_esp'),1) = -1 then Return 1
							end if
							
							///// AUSENTISMO DETALLE
							fila=dw_ausend.insertrow(0)
							dw_ausend.setitem(fila,'tipodoc',tipodoc)
							dw_ausend.setitem(fila,'documento',documento )
							dw_ausend.setitem(fila,'cod_ausen',dw_aus.GetItemString(i,'cod_ausen'))
							dw_ausend.setitem(fila,'item',dw_aus.GetItemnumber(i,'item'))		
							dw_ausend.setitem(fila,'tipodoc_n',tipodoc)
							dw_ausend.setitem(fila,'documento_n',documento )
							dw_ausend.setitem(fila,'ncargo',dw_historia.getitemnumber(filahist,'ncargo'))
							dw_ausend.setitem(fila,'item_n',tab_1.p_2.dw_novedad.getitemnumber(filan,'item'))							
							dw_ausend.setitem(fila,'num_nomina',tab_1.p_2.dw_novedad.getitemnumber(filan,'num_nomina'))											
							dw_ausend.setitem(fila,'fecha_audita',datetime(today(),now()))			
							if ciclo=1 and inicial then
								dw_ausend.setitem(fila,'cod_concep',dw_aus.GetItemString(i,'cod_concep_base') )		
								dw_historia.SetItem(filahist, f_get_ctrl(dw_aus.GetItemString(i,'sigla_base')),1)
								
								dw_ausend.setitem(fila,'dias', li_diasbase)
								dw_historia.SetItem(filahist,get_parm_nov(dw_aus.GetItemString(i,'sigla_base')), li_diasbase)

//								if  inc_t  < ivac.dias then 				
//									dw_ausend.setitem(fila,'dias', inc_t)
//									dw_historia.SetItem(filahist,get_parm_nov(dw_aus.GetItemString(i,'sigla_base')),inc_t)
//								else		
//									dw_ausend.setitem(fila,'dias', ivac.dias)
//									dw_historia.SetItem(filahist,get_parm_nov(dw_aus.GetItemString(i,'sigla_base')),ivac.dias)
//								end if
								calculado = dw_historia.GetItemNumber(filahist,dw_aus.GetItemString(i,'sigla_base'))
							else
								dw_ausend.setitem(fila,'cod_concep',dw_aus.GetItemString(i,'cod_concep') )
								dw_historia.SetItem(filahist, f_get_ctrl(dw_aus.GetItemString(i,'sigla')),1)
								dw_ausend.setitem(fila,'dias', inc_t - li_diasbase)
								dw_historia.SetItem(filahist,get_parm_nov(dw_aus.GetItemString(i,'sigla')), inc_t - li_diasbase)
								calculado = dw_historia.GetItemNumber(filahist,dw_aus.GetItemString(i,'sigla'))
							end if
							if isnull(calculado) then calculado=0
							dw_ausend.setitem(fila,'valor',calculado)
							ciclo++
							//if (inc_t - ivac.dias) <= 0  or ivac.dias=0 then ciclo=3
							if (inc_t - ivac.dias) <= 0 then ciclo = 3
						loop
					end if		
				end if
				inc = inc + inc_t
				dias_incpt+=inc_t
			next
			
			if inc > 0 and ibn_calculando  then
				filan = tab_1.p_2.dw_novedad.Find("sigla='"+dw_aus.GetItemString(dw_aus.GetRow(),'sigla_base')+"'",1,tab_1.p_2.dw_novedad.RowCount())
				if filan>0 then
					dw_ausend.setfilter("tipodoc='"+tipodoc+"' and documento='"+documento+"' and cod_concep='"+tab_1.p_2.dw_novedad.getitemstring(filan,'cod_concep')+"'")
					dw_ausend.filter()
					if dw_ausend.rowcount()>0 then 
						tab_1.p_2.dw_novedad.SetItem(filan,'cantidad_ac',dw_ausend.getitemnumber(1,'tdias'))
						tab_1.p_2.dw_novedad.SetItem(filan,'valor_c',dw_ausend.getitemnumber(1,'tvalor'))
						tab_1.p_2.dw_novedad.SetItem(filan,'pagado',dw_ausend.getitemnumber(1,'tvalor'))						
						dw_historia.SetItem(filahist,get_parm_nov(dw_aus.GetItemString(dw_aus.GetRow(),'sigla_base')),dw_ausend.getitemnumber(1,'tdias'))
					end if
				end if
			
				filan = tab_1.p_2.dw_novedad.Find("sigla='"+dw_aus.GetItemString(dw_aus.GetRow(),'sigla')+"'",1,tab_1.p_2.dw_novedad.RowCount())
				if filan>0 then
					dw_ausend.setfilter("tipodoc='"+tipodoc+"' and documento='"+documento+"' and cod_concep='"+tab_1.p_2.dw_novedad.getitemstring(filan,'cod_concep')+"'")
					dw_ausend.filter()
					if dw_ausend.rowcount()>0 then 
						tab_1.p_2.dw_novedad.SetItem(filan,'cantidad_ac',dw_ausend.getitemnumber(1,'tdias'))
						tab_1.p_2.dw_novedad.SetItem(filan,'valor_c',dw_ausend.getitemnumber(1,'tvalor'))
						tab_1.p_2.dw_novedad.SetItem(filan,'pagado',dw_ausend.getitemnumber(1,'tvalor'))									
						dw_historia.SetItem(filahist,get_parm_nov(dw_aus.GetItemString(dw_aus.GetRow(),'sigla')),dw_ausend.getitemnumber(1,'tdias'))
					end if
				end if
				dw_ausend.setfilter("")
				dw_ausend.filter()
				
				if filahist > 0 then
					if inc > 0 then	
						if dw_tipoincap.getitemstring(l_j,'origen')='1' then
							dw_historia.SetItem(filahist,'diasincap',inc)
							dw_historia.SetItem(filahist,'diasincct',dias_incpt)
							l_inc=l_inc+inc
						else
							l_incp=l_incp+inc
							dw_historia.SetItem(filahist,'diasincapprof',inc)
						end if
					end if
				end if	
			end if
		next

		
		///////////////////////////////////
		// LICENCIA MATERNIDAD
		//dw_aus.Retrieve(tipodoc,documento,'LM',iper.x,iper.y)
		datos_ausentismo(tipodoc, documento, 'LM')
		for i = 1 to dw_aus.RowCount()
			inc_t = 0
			ivac.x = datetime(dw_aus.GetItemDate(i,'fechaini'))
			ivac.y = datetime(dw_aus.GetItemDate(i,'fechafin'))
			iret = interseccion(interv,ivac)
			if (not isNull(iret.x)) and (not isNull(iret.y)) then
				if iret = iper then
					inc_t = periodo
				else
					if day(date(iret.y)) = 31 then
						inc_t = DaysAfter(date(iret.x),date(iret.y))
					else
						if month(date(iret.y)) = 2 and iret.y = iper.y then
							inc_t = DaysAfter(date(iret.x),date(iret.y)) + 1 + (30 - day(date(iper.y)))
						else
							if month(date(iret.y)) = 2 and iret.y = iper.y then
								inc_t = DaysAfter(date(iret.x),date(iret.y)) + 1 + (30 - day(date(iper.y)))
							else
								inc_t= DaysAfter(date(iret.x),date(iret.y)) + 1
							end if				
						end if
					end if
				end if
			end if
			lm = lm + inc_t
		//
			if lm > 0 and ibn_calculando then
				filan = tab_1.p_2.dw_novedad.Find("sigla='"+dw_aus.GetItemString(1,'sigla')+"'",1,tab_1.p_2.dw_novedad.RowCount())
				if filan = 0 then
					filan = tab_1.p_2.pb_addnov.Event clicked()
					tab_1.p_2.dw_novedad.SetItem(filan,'tipodoc', tipodoc)
					tab_1.p_2.dw_novedad.SetItem(filan,'documento', documento)
					tab_1.p_2.dw_novedad.SetItem(filan,'nsalario',dw_historia.getitemnumber(filahist,'nsalario'))
					tab_1.p_2.dw_novedad.SetItem(filan,'ncargo',dw_historia.getitemnumber(filahist,'ncargo'))
					tab_1.p_2.dw_novedad.SetItem(filan,'ntraslado',dw_historia.getitemnumber(filahist,'ntraslado'))
					tab_1.p_2.dw_novedad.SetItem(filan,'cod_concep',dw_aus.GetItemString(1,'cod_concep'))
					tab_1.p_2.dw_novedad.SetItem(filan,'sigla',dw_aus.GetItemString(1,'sigla'))
					tab_1.p_2.dw_novedad.SetItem(filan,'cantidad_ac',lm)
					tab_1.p_2.dw_novedad.SetItem(filan,'des_concep',dw_aus.GetItemString(1,'des_concep'))
					tab_1.p_2.dw_novedad.SetItem(filan,'form_calculo',dw_aus.GetItemString(1,'form_calculo'))
					tab_1.p_2.dw_novedad.SetItem(filan,'tipo',dw_aus.GetItemString(1,'tipo_concep'))
					tab_1.p_2.dw_novedad.SetItem(filan,'cod_tipo_concep',dw_aus.GetItemString(1,'cod_tipo_concep'))
					if f_addcompute( dw_aus.GetItemString(i,'sigla'), dw_aus.GetItemString(i,'form_calculo'), dw_aus.GetItemString(i,'form_verifica'), dw_aus.GetItemnumber(i,'tarifa'), dw_aus.GetItemnumber(i,'tarifa_esp'),1) = -1 then Return -1
				else
					tab_1.p_2.dw_novedad.SetItem(filan,'cantidad_ac',lm)
				end if
				fila =dw_ausend.Find("tipodoc='"+tipodoc+"' and documento='"+documento+"' and cod_ausen='LM' and ncargo="+string(dw_historia.getitemnumber(filahist,'ncargo'))+" and cod_concep='"+dw_aus.GetItemString(1,'cod_concep')+"' and dias="+string(inc_t),1,dw_ausend.RowCount())
				if fila=0 then fila=dw_ausend.insertrow(0)
				dw_ausend.setitem(fila,'tipodoc',tipodoc)
				dw_ausend.setitem(fila,'documento',documento )
				dw_ausend.setitem(fila,'cod_ausen',dw_aus.GetItemString(i,'cod_ausen'))	
				dw_ausend.setitem(fila,'item',dw_aus.GetItemnumber(i,'item'))			
				dw_ausend.setitem(fila,'tipodoc_n',tipodoc)
				dw_ausend.setitem(fila,'documento_n',documento )
				dw_ausend.setitem(fila,'ncargo',dw_historia.getitemnumber(filahist,'ncargo'))
				dw_ausend.setitem(fila,'cod_concep',dw_aus.GetItemString(i,'cod_concep') )	
				dw_ausend.setitem(fila,'dias',lm)
				dw_ausend.setitem(fila,'fecha_audita',datetime(today(),now()))	
				dw_ausend.setitem(fila,'item_n',tab_1.p_2.dw_novedad.getitemnumber(filan,'item'))
				dw_ausend.setitem(fila,'num_nomina',tab_1.p_2.dw_novedad.getitemnumber(filan,'num_nomina'))
			end if
		next
		if filahist > 0 then
			dw_historia.SetItem(filahist,'diasmaterna',lm)
			if lm > 0 then	dw_historia.SetItem(filahist,get_parm_nov(dw_aus.GetItemString(dw_aus.GetRow(),'sigla')),lm)
		end if
		
		///////////////////////////////////
		// LICENCIA PATERNIDAD
		//dw_aus.Retrieve(tipodoc,documento,'LP',iper.x,iper.y)
		datos_ausentismo(tipodoc, documento, 'LP')
		for i = 1 to dw_aus.RowCount()
			inc_t = 0
			ivac.x = datetime(dw_aus.GetItemDate(i,'fechaini'))
			ivac.y = datetime(dw_aus.GetItemDate(i,'fechafin'))
			iret = interseccion(interv,ivac)
			if (not isNull(iret.x)) and (not isNull(iret.y)) then
				if iret = iper then
					inc_t = periodo
				else
					if day(date(iret.y)) = 31 then
						inc_t = DaysAfter(date(iret.x),date(iret.y))
					else
						if month(date(iret.y)) = 2 and iret.y = iper.y then
							inc_t = DaysAfter(date(iret.x),date(iret.y)) + 1 + (30 - day(date(iper.y)))
						else
							if month(date(iret.y)) = 2 and iret.y = iper.y then
								inc_t = DaysAfter(date(iret.x),date(iret.y)) + 1 + (30 - day(date(iper.y)))
							else
								inc_t= DaysAfter(date(iret.x),date(iret.y)) + 1
							end if				
						end if
					end if
				end if
		
			end if
			lp = lp + inc_t
			if lp > 0 and ibn_calculando then
				filan = tab_1.p_2.dw_novedad.Find("sigla='"+dw_aus.GetItemString(1,'sigla')+"'",1,tab_1.p_2.dw_novedad.RowCount())
				if filan = 0 then
					filan= tab_1.p_2.pb_addnov.Event clicked()
					tab_1.p_2.dw_novedad.SetItem(filan,'tipodoc', tipodoc)
					tab_1.p_2.dw_novedad.SetItem(filan,'documento', documento)
					tab_1.p_2.dw_novedad.SetItem(filan,'nsalario',dw_historia.getitemnumber(filahist,'nsalario'))
					tab_1.p_2.dw_novedad.SetItem(filan,'ncargo',dw_historia.getitemnumber(filahist,'ncargo'))
					tab_1.p_2.dw_novedad.SetItem(filan,'ntraslado',dw_historia.getitemnumber(filahist,'ntraslado'))
					tab_1.p_2.dw_novedad.SetItem(filan,'cod_concep',dw_aus.GetItemString(i,'cod_concep'))
					tab_1.p_2.dw_novedad.SetItem(filan,'sigla',dw_aus.GetItemString(i,'sigla'))
					tab_1.p_2.dw_novedad.SetItem(filan,'cantidad_ac',lp)
					tab_1.p_2.dw_novedad.SetItem(filan,'des_concep',dw_aus.GetItemString(1,'des_concep'))
					tab_1.p_2.dw_novedad.SetItem(filan,'form_calculo',dw_aus.GetItemString(1,'form_calculo'))
					tab_1.p_2.dw_novedad.SetItem(filan,'tipo',dw_aus.GetItemString(1,'tipo_concep'))
					tab_1.p_2.dw_novedad.SetItem(filan,'cod_tipo_concep',dw_aus.GetItemString(i,'cod_tipo_concep'))
					if f_addcompute( dw_aus.GetItemString(i,'sigla'), dw_aus.GetItemString(i,'form_calculo'), dw_aus.GetItemString(i,'form_verifica'), dw_aus.GetItemnumber(i,'tarifa'), dw_aus.GetItemnumber(i,'tarifa_esp'),1) = -1 then Return -1
				else
					tab_1.p_2.dw_novedad.SetItem(filan,'cantidad_ac',lp)
				end if
				fila =dw_ausend.Find("tipodoc='"+tipodoc+"' and documento='"+documento+"' and cod_ausen='LP' and ncargo="+string(dw_historia.getitemnumber(filahist,'ncargo'))+" and cod_concep='"+dw_aus.GetItemString(1,'cod_concep')+"' and dias="+string(inc_t),1,dw_ausend.RowCount())
				if fila=0 then fila=dw_ausend.insertrow(0)
				dw_ausend.setitem(fila,'tipodoc',tipodoc)
				dw_ausend.setitem(fila,'documento',documento )
				dw_ausend.setitem(fila,'cod_ausen',dw_aus.GetItemString(dw_aus.Getrow(),'cod_ausen'))
				dw_ausend.setitem(fila,'item',dw_aus.GetItemnumber(dw_aus.GetRow(),'item'))		
				dw_ausend.setitem(fila,'tipodoc_n',tipodoc)
				dw_ausend.setitem(fila,'documento_n',documento )
				dw_ausend.setitem(fila,'ncargo',dw_historia.getitemnumber(filahist,'ncargo'))
				dw_ausend.setitem(fila,'cod_concep',dw_aus.GetItemString(dw_aus.GetRow(),'cod_concep') )
				dw_ausend.setitem(fila,'dias',lp)
				dw_ausend.setitem(fila,'fecha_audita',datetime(today(),now()))
				dw_ausend.setitem(fila,'item_n',tab_1.p_2.dw_novedad.getitemnumber(filan,'item'))
				dw_ausend.setitem(fila,'num_nomina',tab_1.p_2.dw_novedad.getitemnumber(filan,'num_nomina'))	
			end if
		next
		if filahist > 0 then
			dw_historia.SetItem(filahist,'diaspaterna',lp)
			if lp > 0 then dw_historia.SetItem(filahist,get_parm_nov(dw_aus.GetItemString(dw_aus.GetRow(),'sigla')),lp)
		end if
		
		///////////////////////////////////
		// LICENCIA NO REMUNERADA
		//dw_aus.Retrieve(tipodoc,documento,'LN',iper.x,iper.y)
		datos_ausentismo(tipodoc, documento, 'LN')
		for i = 1 to dw_aus.RowCount()
			inc_t = 0
			ivac.x = datetime(dw_aus.GetItemDate(i,'fechaini'))
			ivac.y = datetime(dw_aus.GetItemDate(i,'fechafin'))
			iret = interseccion(interv,ivac)
			if (not isNull(iret.x)) and (not isNull(iret.y)) then
				if iret = iper then
					inc_t = periodo
				elseif day(date(iret.y)) = 31 then
					inc_t = DaysAfter(date(iret.x),date(iret.y))
				else
					if month(date(iret.y)) = 2 and iret.y = iper.y then
						inc_t = DaysAfter(date(iret.x),date(iret.y)) + 1 + (30 - day(date(iper.y)))
					else
						inc_t= DaysAfter(date(iret.x),date(iret.y)) + 1
					end if				
				end if
			end if
			ln = ln + inc_t
		next
		if filahist > 0 then
			dw_historia.SetItem(filahist,'diaslicencia',ln)
			if ln > 0 then dw_historia.SetItem(filahist,get_parm_nov(dw_aus.GetItemString(dw_aus.GetRow(),'sigla')),ln)
		end if
		///////////////////////////////////
		// PERMISO
		//dw_aus.Retrieve(tipodoc,documento,'PE',iper.x,iper.y)
		datos_ausentismo(tipodoc, documento, 'PE')
		for i = 1 to dw_aus.RowCount()
			inc_t = 0
			ivac.x = datetime(dw_aus.GetItemDate(i,'fechaini'))
			ivac.y = datetime(dw_aus.GetItemDate(i,'fechafin'))
			iret = interseccion(interv,ivac)
			if (not isNull(iret.x)) and (not isNull(iret.y)) then
				if iret = iper then
					inc_t = periodo
				elseif day(date(iret.y)) = 31 then
					inc_t = DaysAfter(date(iret.x),date(iret.y))
				else
					if month(date(iret.y)) = 2 and iret.y = iper.y then
						inc_t = DaysAfter(date(iret.x),date(iret.y)) + 1 + (30 - day(date(iper.y)))
					else
						inc_t= DaysAfter(date(iret.x),date(iret.y)) + 1
					end if				
				end if
			end if
			 l_perm= l_perm+ inc_t
		next
		if filahist > 0 then
			if l_perm > 0 then 
				dw_historia.SetItem(filahist,get_parm_nov(dw_aus.GetItemString(dw_aus.GetRow(),'sigla')),l_perm)
				dw_historia.SetItem(filahist,'diaspermiso',l_perm)
			end if
		end if
		///////////////////////////////////
		// LUTO
		//dw_aus.Retrieve(tipodoc,documento,'LT',iper.x,iper.y)
		datos_ausentismo(tipodoc, documento, 'LT')
		for i = 1 to dw_aus.RowCount()
			inc_t = 0
			ivac.x = datetime(dw_aus.GetItemDate(i,'fechaini'))
			ivac.y = datetime(dw_aus.GetItemDate(i,'fechafin'))
			iret = interseccion(interv,ivac)
			if (not isNull(iret.x)) and (not isNull(iret.y)) then
				if iret = iper then
					inc_t = periodo
				elseif day(date(iret.y)) = 31 then
					inc_t = DaysAfter(date(iret.x),date(iret.y))
				else
					if month(date(iret.y)) = 2 and iret.y = iper.y then
						inc_t = DaysAfter(date(iret.x),date(iret.y)) + 1 + (30 - day(date(iper.y)))
					else
						inc_t= DaysAfter(date(iret.x),date(iret.y)) + 1
					end if				
				end if
			end if
			l_luto= l_luto+ inc_t
			if l_luto > 0 and ibn_calculando then
				filan = tab_1.p_2.dw_novedad.Find("sigla='"+dw_aus.GetItemString(1,'sigla')+"'",1,tab_1.p_2.dw_novedad.RowCount())
				if filan = 0 then
					filan= tab_1.p_2.pb_addnov.Event clicked()
					tab_1.p_2.dw_novedad.SetItem(filan,'tipodoc', tipodoc)
					tab_1.p_2.dw_novedad.SetItem(filan,'documento', documento)
					tab_1.p_2.dw_novedad.SetItem(filan,'nsalario',dw_historia.getitemnumber(filahist,'nsalario'))
					tab_1.p_2.dw_novedad.SetItem(filan,'ncargo',dw_historia.getitemnumber(filahist,'ncargo'))
					tab_1.p_2.dw_novedad.SetItem(filan,'ntraslado',dw_historia.getitemnumber(filahist,'ntraslado'))
					tab_1.p_2.dw_novedad.SetItem(filan,'cod_concep',dw_aus.GetItemString(i,'cod_concep'))
					tab_1.p_2.dw_novedad.SetItem(filan,'sigla',dw_aus.GetItemString(i,'sigla'))
					tab_1.p_2.dw_novedad.SetItem(filan,'cantidad_ac',l_luto)
					tab_1.p_2.dw_novedad.SetItem(filan,'des_concep',dw_aus.GetItemString(1,'des_concep'))
					tab_1.p_2.dw_novedad.SetItem(filan,'form_calculo',dw_aus.GetItemString(1,'form_calculo'))
					tab_1.p_2.dw_novedad.SetItem(filan,'tipo',dw_aus.GetItemString(1,'tipo_concep'))
					tab_1.p_2.dw_novedad.SetItem(filan,'cod_tipo_concep',dw_aus.GetItemString(i,'cod_tipo_concep'))
					if f_addcompute( dw_aus.GetItemString(i,'sigla'), dw_aus.GetItemString(i,'form_calculo'), dw_aus.GetItemString(i,'form_verifica'), dw_aus.GetItemnumber(i,'tarifa'), dw_aus.GetItemnumber(i,'tarifa_esp'),1) = -1 then Return -1
				else
					tab_1.p_2.dw_novedad.SetItem(filan,'cantidad_ac',l_luto)
				end if	
				ls_filtro="tipodoc='"+tipodoc+"' and documento='"+documento+"' and cod_ausen='LT' and ncargo="+string(dw_historia.getitemnumber(filahist,'ncargo'))+" and cod_concep='"+dw_aus.GetItemString(1,'cod_concep')+"'"
				if not isnull(string(tab_1.p_2.dw_novedad.getitemnumber(filan,'num_nomina'))) then
					ls_filtro=ls_filtro+"and num_nomina="+string(tab_1.p_2.dw_novedad.getitemnumber(filan,'num_nomina'))+' and '
				end if
				ls_filtro=ls_filtro+"tipodoc_n='"+tipodoc+"' and "
				ls_filtro=ls_filtro+"documento_n='"+documento+"' and "
				ls_filtro=ls_filtro+"cod_concep='"+tab_1.p_2.dw_novedad.getitemstring(filan,'cod_concep')+"' and "
				ls_filtro=ls_filtro+"item_n="+string(tab_1.p_2.dw_novedad.getitemnumber(filan,'item'))				
				fila =dw_ausend.Find(ls_filtro,1,dw_ausend.RowCount())
				if fila=0 then fila=dw_ausend.insertrow(0)
				dw_ausend.setitem(fila,'tipodoc',tipodoc)
				dw_ausend.setitem(fila,'documento',documento )
				dw_ausend.setitem(fila,'cod_ausen',dw_aus.GetItemString(dw_aus.Getrow(),'cod_ausen'))
				dw_ausend.setitem(fila,'item',dw_aus.GetItemnumber(dw_aus.GetRow(),'item'))		
				dw_ausend.setitem(fila,'tipodoc_n',tipodoc)
				dw_ausend.setitem(fila,'documento_n',documento )
				dw_ausend.setitem(fila,'ncargo',dw_historia.getitemnumber(filahist,'ncargo'))
				dw_ausend.setitem(fila,'cod_concep',dw_aus.GetItemString(dw_aus.GetRow(),'cod_concep') )
				dw_ausend.setitem(fila,'dias',l_luto)
				dw_ausend.setitem(fila,'fecha_audita',datetime(today(),now()))
				dw_ausend.setitem(fila,'item_n',tab_1.p_2.dw_novedad.getitemnumber(filan,'item'))
				dw_ausend.setitem(fila,'num_nomina',tab_1.p_2.dw_novedad.getitemnumber(filan,'num_nomina'))	
			end if
		next
		if filahist > 0 then
			if l_luto > 0 then 
				dw_historia.SetItem(filahist,get_parm_nov(dw_aus.GetItemString(dw_aus.GetRow(),'sigla')),l_luto)
				dw_historia.SetItem(filahist,'diasluto',l_luto)
			end if
		end if		
	
		////////////////////////
		//  SUSPENSION
		//dw_aus.Retrieve(tipodoc,documento,'SU',iper.x,iper.y)
		datos_ausentismo(tipodoc, documento, 'SU')
		for i = 1 to dw_aus.RowCount()
			inc_t = 0
			ivac.x = datetime(dw_aus.GetItemDate(i,'fechaini'))
			ivac.y = datetime(dw_aus.GetItemDate(i,'fechafin'))
			iret = interseccion(interv,ivac)
			if (not isNull(iret.x)) and (not isNull(iret.y)) then
				if iret = iper then
					inc_t = periodo
				elseif day(date(iret.y)) = 31 then
					inc_t = DaysAfter(date(iret.x),date(iret.y))
				else
					inc_t = DaysAfter(date(iret.x),date(iret.y)) + 1
				end if
			end if
			l_sus = l_sus + inc_t
		next
		if filahist > 0 then
			if l_sus>0 then
				dw_historia.SetItem(filahist,'diassuspension',l_sus)
			end if
		end if
		////////////////////////
		//  SIN JUSTA CAUSA
//		dw_aus.Retrieve(tipodoc,documento,'DC',iper.x,iper.y)
		datos_ausentismo(tipodoc, documento, 'DC')
		for i = 1 to dw_aus.RowCount()
			inc_t = 0
			ivac.x = datetime(dw_aus.GetItemDate(i,'fechaini'))
			ivac.y = datetime(dw_aus.GetItemDate(i,'fechafin'))
			iret = interseccion(interv,ivac)
			if (not isNull(iret.x)) and (not isNull(iret.y)) then
				if iret = iper then
					inc_t = periodo
				elseif day(date(iret.y)) = 31 then
					inc_t = DaysAfter(date(iret.x),date(iret.y))
				else
					inc_t = DaysAfter(date(iret.x),date(iret.y)) + 1
				end if
			end if
			l_asjc = l_asjc + inc_t
		next
		if filahist > 0 then
			if l_asjc>0 then
				dw_historia.SetItem(filahist,'diassuspension',l_asjc)
			end if
		end if
	end if ///Tipo Nomina
end if
Return vac + l_inc+ l_incp + lm + ln + lp + l_sus + l_luto +l_asjc

end function

public function integer calc_dias (string tipodoc, string documento, st_interfec interv, integer filahist);long dias, i, fila, inc_t,l_j,inct,inc, incp
st_interfec ivac, iret, iper
string incap

vac = 0
l_inc = 0
l_incp = 0
lm = 0 
ln = 0
lp=0
l_sus=0
l_perm=0
l_luto=0
l_asjc=0

iper.x = tab_n.tpn_1.dw_nomcab.GetItemDateTime(tab_n.tpn_1.dw_nomcab.GetRow(),'inicia')
iper.y = tab_n.tpn_1.dw_nomcab.GetItemDateTime(tab_n.tpn_1.dw_nomcab.GetRow(),'termina')
//////////////////////////////////
// VACACIONES
//dw_aus.Retrieve(tipodoc,documento,'VA')
datos_ausentismo(tipodoc, documento, 'VA')
long mes
for i = 1 to dw_aus.RowCount()
	ivac.x = datetime(dw_aus.GetItemDate(i,'fechaini'))
	ivac.y = datetime(dw_aus.GetItemDate(i,'fechafin'))
	iret = interseccion(interv,ivac)
	if (not isNull(iret.x)) and (not isNull(iret.y)) then
		if day(date(iret.y)) = 31 then
			vac = DaysAfter(date(iret.x),date(iret.y))
		else
			vac = DaysAfter(date(iret.x),date(iret.y)) + 1
		end if
	end if
next
if filahist > 0 then
	dw_historia.SetItem(filahist,'diasvac',vac)
end if

//////////////////////////////////
// INCAPACIDAD
dw_tipoincap.GetChild('cod_concep', dwc_ce)
dw_tipoincap.GetChild('cod_concep_base', dwc_ce_bas)
dwc_ce.SetTransObject(SQLCA)
dwc_ce_bas.SetTransObject(SQLCA)
dwc_ce.Retrieve(i_cemp)
dwc_ce_bas.Retrieve(i_cemp)
dw_tipoincap.retrieve()
dw_tipoincap.setfilter("estado ='1' and incap='1'")
dw_tipoincap.filter()
for l_j = 1 to dw_tipoincap.RowCount()
	incap=dw_tipoincap.getitemstring(l_j,'cod_ausen')
	//dw_aus.Retrieve(tipodoc,documento,incap)
	datos_ausentismo(tipodoc, documento, incap)
	for i = 1 to dw_aus.RowCount()
		inc_t = 0
		ivac.x = datetime(dw_aus.GetItemDate(i,'fechaini'))
		ivac.y = datetime(dw_aus.GetItemDate(i,'fechafin'))
		ivac.dias = dw_aus.GetItemnumber(i,'dias_base')
		If isnull(Ivac.dias) then 
			MessageBox('Atención','Configurar dias base para '+ dw_aus.GetItemString(dw_aus.GetRow(),'sigla'))
			return -1
		end if
		iret = interseccion(interv,ivac)
		if (not isNull(iret.x)) and (not isNull(iret.y)) then
			if dw_aus.GetItemString(i,'tipo') = 'I' then //Incapacidad normal
				if iret = iper then
					inc_t = periodo
				elseif day(date(iret.y)) = 31 then
					inc_t = DaysAfter(date(iret.x),date(iret.y))
				else
					if month(date(iret.y)) = 2 and iret.y = iper.y then
						inc_t = DaysAfter(date(iret.x),date(iret.y)) + 1 + (30 - day(date(iper.y)))
					else
						inc_t = DaysAfter(date(iret.x),date(iret.y)) + 1
					end if
				end if
				if ivac.x < iper.x and DaysAfter(date(ivac.x),date(iper.x)) < ivac.dias then
					inc_t = inc_t - ( ivac.dias - DaysAfter(date(ivac.x),date(iret.x)) )
				elseif ivac.x >= iper.x then
					inc_t = inc_t - ivac.dias
				end if
				if inc_t < 0 then inc_t = 0
			elseif dw_aus.GetItemString(i,'tipo') = 'P' then
				if iret = iper then
					inc_t = periodo
				elseif day(date(iret.y)) = 31 then
					inc_t = DaysAfter(date(iret.x),date(iret.y))
				else
					if month(date(iret.y)) = 2 and iret.y = iper.y then
						inc_t = DaysAfter(date(iret.x),date(iret.y)) + 1 + (30 - day(date(iper.y)))
					else
						inc_t = DaysAfter(date(iret.x),date(iret.y)) + 1
					end if
				end if
			end if
		end if
		inc = inc + inc_t	
	next
next

if filahist > 0 then
	if inc > 0 then	
		if dw_tipoincap.getitemstring(l_j,'origen')='1' then
			l_inc=l_inc+inc
			dw_historia.SetItem(filahist,'diasincap',inc)
		else
			l_incp=l_incp+inc
			dw_historia.SetItem(filahist,'diasincapprof',inc)
		end if

	end if
end if
//////////////////////////////////
// LICENCIA MATERNIDAD
//dw_aus.Retrieve(tipodoc,documento,'LM')
datos_ausentismo(tipodoc, documento, 'LM')
for i = 1 to dw_aus.RowCount()
	ivac.x = datetime(dw_aus.GetItemDate(i,'fechaini'))
	ivac.y = datetime(dw_aus.GetItemDate(i,'fechafin'))
	iret = interseccion(interv,ivac)
	if (not isNull(iret.x)) and (not isNull(iret.y)) then
		if iret = iper then
			inc_t = periodo
		else
			if day(date(iret.y)) = 31 then
				inc_t = DaysAfter(date(iret.x),date(iret.y))
			else
				if month(date(iret.y)) = 2 and iret.y = iper.y then
					inc_t = DaysAfter(date(iret.x),date(iret.y)) + 1 + (30 - day(date(iper.y)))
				else
					inc_t = DaysAfter(date(iret.x),date(iret.y)) + 1
				end if
			end if
		end if

	end if
	lm = lm + inc_t
next
if filahist > 0 then
	dw_historia.SetItem(filahist,'diasmaterna',lm)
end if
//////////////////////////////////
// LICENCIA PATERNIDAD
//dw_aus.Retrieve(tipodoc,documento,'LP')
datos_ausentismo(tipodoc, documento, 'LP')
for i = 1 to dw_aus.RowCount()
	ivac.x = datetime(dw_aus.GetItemDate(i,'fechaini'))
	ivac.y = datetime(dw_aus.GetItemDate(i,'fechafin'))
	iret = interseccion(interv,ivac)
	if (not isNull(iret.x)) and (not isNull(iret.y)) then
		if iret = iper then
			inc_t = periodo
		else
			if day(date(iret.y)) = 31 then
				inc_t = DaysAfter(date(iret.x),date(iret.y))
			else
				if month(date(iret.y)) = 2 and iret.y = iper.y then
					inc_t = DaysAfter(date(iret.x),date(iret.y)) + 1 + (30 - day(date(iper.y)))
				else
					inc_t = DaysAfter(date(iret.x),date(iret.y)) + 1
				end if
			end if
		end if

	end if
	lp= lp + inc_t
next
if filahist > 0 then
	dw_historia.SetItem(filahist,'diaspaterna',lp)
end if
//////////////////////////////////
// LICENCIA NO REMUNERADA
//dw_aus.Retrieve(tipodoc,documento,'LN')
datos_ausentismo(tipodoc, documento, 'LN')
for i = 1 to dw_aus.RowCount()
	ivac.x = datetime(dw_aus.GetItemDate(i,'fechaini'))
	ivac.y = datetime(dw_aus.GetItemDate(i,'fechafin'))
	iret = interseccion(interv,ivac)
	if (not isNull(iret.x)) and (not isNull(iret.y)) then
		if iret = iper then
			inc_t = periodo
		elseif day(date(iret.y)) = 31 then
			inc_t = DaysAfter(date(iret.x),date(iret.y))
		else
			inc_t = DaysAfter(date(iret.x),date(iret.y)) + 1
		end if
	end if
	ln =ln + inc_t
next
if filahist > 0 then
	dw_historia.SetItem(filahist,'diaslicencia',ln)
end if
//////////////////////////////////
// PERMISO
//dw_aus.Retrieve(tipodoc,documento,'PE')
datos_ausentismo(tipodoc, documento, 'PE')
for i = 1 to dw_aus.RowCount()
	ivac.x = datetime(dw_aus.GetItemDate(i,'fechaini'))
	ivac.y = datetime(dw_aus.GetItemDate(i,'fechafin'))
	iret = interseccion(interv,ivac)
	if (not isNull(iret.x)) and (not isNull(iret.y)) then
		if iret = iper then
			inc_t = periodo
		elseif day(date(iret.y)) = 31 then
			inc_t = DaysAfter(date(iret.x),date(iret.y))
		else
			inc_t = DaysAfter(date(iret.x),date(iret.y)) + 1
		end if
	end if
	l_perm =l_perm + inc_t
next
if filahist > 0 then
	dw_historia.SetItem(filahist,'diaspermiso',l_perm)
end if
//////////////////////////////////
// LUTO
//dw_aus.Retrieve(tipodoc,documento,'LT')
datos_ausentismo(tipodoc, documento, 'LT')
for i = 1 to dw_aus.RowCount()
	ivac.x = datetime(dw_aus.GetItemDate(i,'fechaini'))
	ivac.y = datetime(dw_aus.GetItemDate(i,'fechafin'))
	iret = interseccion(interv,ivac)
	if (not isNull(iret.x)) and (not isNull(iret.y)) then
		if iret = iper then
			inc_t = periodo
		elseif day(date(iret.y)) = 31 then
			inc_t = DaysAfter(date(iret.x),date(iret.y))
		else
			inc_t = DaysAfter(date(iret.x),date(iret.y)) + 1
		end if
	end if
	l_luto =l_luto + inc_t
next
if filahist > 0 then
	dw_historia.SetItem(filahist,'diasluto',l_luto)
end if

//////////////////////////////////
// SUSPENSION
//dw_aus.Retrieve(tipodoc,documento,'SU')
datos_ausentismo(tipodoc, documento, 'SU')
for i = 1 to dw_aus.RowCount()
	ivac.x = datetime(dw_aus.GetItemDate(i,'fechaini'))
	ivac.y = datetime(dw_aus.GetItemDate(i,'fechafin'))
	iret = interseccion(interv,ivac)
	if (not isNull(iret.x)) and (not isNull(iret.y)) then
		if iret = iper then
			inc_t = periodo
		elseif day(date(iret.y)) = 31 then
			inc_t = DaysAfter(date(iret.x),date(iret.y))
		else
			inc_t = DaysAfter(date(iret.x),date(iret.y)) + 1
		end if
	end if
	l_sus= l_sus + inc_t
next
if filahist > 0 then
	dw_historia.SetItem(filahist,'diassuspension',l_sus)
end if
// AUSENTISMO NO JUSTIFICA
//dw_aus.Retrieve(tipodoc,documento,'DC')
datos_ausentismo(tipodoc, documento, 'DC')
for i = 1 to dw_aus.RowCount()
	ivac.x = datetime(dw_aus.GetItemDate(i,'fechaini'))
	ivac.y = datetime(dw_aus.GetItemDate(i,'fechafin'))
	iret = interseccion(interv,ivac)
	if (not isNull(iret.x)) and (not isNull(iret.y)) then
		if iret = iper then
			inc_t = periodo
		elseif day(date(iret.y)) = 31 then
			inc_t = DaysAfter(date(iret.x),date(iret.y))
		else
			inc_t = DaysAfter(date(iret.x),date(iret.y)) + 1
		end if
	end if
	l_asjc= l_asjc+ inc_t
next
If filahist > 0 then
	dw_historia.SetItem(filahist,'diassuspension',l_asjc)
end if

Return vac + l_inc + l_incp + lm + ln +lp +l_luto+l_asjc

end function

public function integer calc_afilia (string tipodoc, string documento, string cod_clase);Return 0
end function

public function integer f_tiempos ();st_interfec iper, icar, iret
string tipodoc, documento
long i, aus

if is_tnom='C' or is_tnom='P' then return -1

log.info("Inicia TIEMPOS "+ tipodoc+documento)

iper.x = tab_n.tpn_1.dw_nomcab.GetItemDateTime(tab_n.tpn_1.dw_nomcab.GetRow(),'inicia')
iper.y = tab_n.tpn_1.dw_nomcab.GetItemDateTime(tab_n.tpn_1.dw_nomcab.GetRow(),'termina')
for i = 1 to dw_historia.RowCount()
	tipodoc = dw_historia.GetItemString(i,'tipodoc')
	documento = dw_historia.GetItemString(i,'documento')
	icar.x = dw_historia.GetItemDateTime(i,'fecha_inicio')
	icar.y = dw_historia.GetItemDateTime(i,'fecha_termina')
	iret = interseccion(iper,icar) 	
	if isNull(iret.x) and isNull(iret.y) then
		dw_historia.SetItem(i,'dias',0)
	else
		icar.x = dw_historia.GetItemDateTime(i,'salario_fecha_inicio')
		icar.y = dw_historia.GetItemDateTime(i,'salario_fecha_term')
		iret = interseccion(iret,icar)
		if (not isNull(iret.x)) and (not isNull(iret.y)) then
			icar.x = dw_historia.GetItemDateTime(i,'fec_ini_ubica')
			icar.y = dw_historia.GetItemDateTime(i,'fec_term_ubica')
			iret = interseccion(iret,icar)
			if (not isNull(iret.x)) and (not isNull(iret.y)) then
				// Intervalo Resultado
				dw_historia.SetItem(i,'interv_ini',iret.x)
				dw_historia.SetItem(i,'interv_fin',iret.y)
				// vacaciones
				aus = ausentismo(tipodoc,documento,iret,i)
				//
				if iper.x = iret.x and iper.y = iret.y then
					// Ojo en redsalud es
					dw_historia.SetItem(i,'dias',periodo - aus)
					dw_historia.SetItem(i,'diasvinculado',periodo - aus)  //Hospital
				else
					if day(date(iret.y)) = 31 then iret.y = datetime(RelativeDate(date(iret.y), -1))
					if month(date(iret.y)) = 2 and iret.y = iper.y and day(date(iper.y)) > 27 then
						dw_historia.SetItem(i,'dias',DaysAfter(date(iret.x),date(iret.y)) + 1 - aus + (30 - day(date(iper.y))))
						dw_historia.SetItem(i,'diasvinculado',DaysAfter(date(iret.x),date(iret.y)) + 1 - aus + (30 - day(date(iper.y))))
					else
						dw_historia.SetItem(i,'dias',DaysAfter(date(iret.x),date(iret.y)) + 1 - aus)
						dw_historia.SetItem(i,'diasvinculado',DaysAfter(date(iret.x),date(iret.y)) + 1 -aus)
					end if
				end if
				if dw_historia.GetItemNumber(i,'dias') < 0 or dw_historia.GetItemNumber(i,'diasvinculado') < 0 then
					MessageBox('Atención','El empleado '+tipodoc+documento+' tiene mas dias en ausentismo que laborados. Revisar Ausentismo')
					Return -1
				end if
			end if
		end if
	end if
next
Return 0
end function

public function integer checkconcep (datawindow dw_obj);string campos, tipo, s1, form_calculo, ret, novedad
long num_object, fila, i, j, f, ps, nc
uo_datastore dw_cp

dw_cp = CREATE uo_datastore
dw_cp.DataObject = "dw_conceptos"
dw_cp.SetTransObject(SQLCA)

fila = dw_historia.GetRow()
dw_cp.Retrieve(dw_historia.GetItemString(fila,'codrela'),dw_historia.GetItemString(fila,'tipoemple'),dw_historia.GetItemString(fila,'cargo'))
campos = dw_historia.Describe("DataWindow.objects")
num_object=f_count_text(campos,'	')+1
for i = 1 to num_object
	s1 = f_trae_string_num (campos,i,'	')
	tipo = dw_historia.Describe(s1+".type")
	if tipo = 'compute' then
		select novedad into :novedad from nom_concep where sigla = :s1;
		IF SQLCA.SQLCode = -1 THEN
			MessageBox("SQL error", SQLCA.SQLErrText)
			Return -1
		END IF
		fila = dw_cp.Find("sigla='" + upper(s1) + "'",1,dw_cp.RowCount()) // busca en conceptos del cargo
		if fila = 0 then  // no aparece como concepto del cargo entonces busca si es novedad
			f = tab_1.p_2.dw_novedad.Find("sigla='" + upper(s1) + "'",1,tab_1.p_2.dw_novedad.RowCount()) 
			if f = 0 then
				dw_historia.Modify(s1 + '.expression="0"')
			else
				
				blob fmla,fmla_base
				if dw_historia.Describe(s1+".expression") = '0' then
					selectblob form_calculo into :fmla from nom_concep
					where sigla=:s1;
					IF SQLCA.SQLCode = -1 THEN
						MessageBox("SQL error", SQLCA.SQLErrText)
						Return -1
					END IF
					
					form_calculo = string(fmla)
					ps = pos(form_calculo,'parm_novedad',1)
					if novedad = '1' and ps > 0 then
						nc = 1
						do while dw_historia.Describe("parm_"+string(nc)+"_t.text") <> 'parm_'+s1 and nc <= 80
							nc = nc + 1
						loop
						if nc = 80 then
							nc = 1
							do while dw_historia.Describe("parm_"+string(nc)+"_t.text") <> 'parm_'+string(nc) and nc <= 80
								nc = nc + 1
							loop
						end if
						if nc > 80 then
							MessageBox('Aviso checkconcep','Insuficientes campos parm. No se crea campo parametro para novedad '+s1)
						else
							dw_historia.Modify("parm_"+string(nc)+"_t.text='parm_"+s1+"'") 
							do while ps > 0
								form_calculo = replace(form_calculo,ps,12,"parm_"+string(nc))
								ps = pos(form_calculo,'parm_novedad',ps)
							loop
						end if
					end if
					dw_historia.Modify(s1 + ".expression='" + form_calculo + "'")
					
				end if
				
			end if
		else // Si aparece como concepto del cargo
			if dw_historia.Describe(s1+".expression") = '0' then
				dw_historia.Modify(s1 + ".expression='" + dw_cp.GetItemString(fila,'form_calculo') + "'")
			end if
		end if
	end if
next

Return 0

end function

public function integer f_checkconcep (integer fila);long  i, f, filahist

//dw_concep_cargo.Retrieve(dw_historia.GetItemString(fila,'codrela'),dw_historia.GetItemString(fila,'tipoemple'),dw_historia.GetItemString(fila,'cargo'))
datos_concep_cargo(dw_historia.GetItemString(fila,'codrela'),dw_historia.GetItemString(fila,'tipoemple'),dw_historia.GetItemString(fila,'cargo'))
for i = 0 to 99
	dw_historia.SetItem(fila,80+i,0)
next
for i = 1 to dw_concep_cargo.RowCount()
	if dw_historia.Describe(dw_concep_cargo.GetItemString(i,'sigla') + '.Coltype') = "!" then CONTINUE
	filahist = dw_historia.Find("diasvinculado > 0 ",1,dw_historia.RowCount())
	if filahist=0 and  dw_historia.rowcount()>0 then filahist=1
	if dw_concep_cargo.GetItemString(i,'novedad') = '1' then
		f = tab_1.p_2.dw_novedad.Find("sigla='" + dw_concep_cargo.GetItemString(i,'sigla') + "'",1,tab_1.p_2.dw_novedad.RowCount()) 
		if f = 0 or fila <> filahist then
		   dw_historia.SetItem(fila, f_get_ctrl(dw_concep_cargo.GetItemString(i,'sigla')), 0)
		elseif fila = filahist then
			dw_historia.SetItem(fila, f_get_ctrl(dw_concep_cargo.GetItemString(i,'sigla')),1)
			dw_historia.SetItem(fila, get_parm_nov(dw_concep_cargo.GetItemString(i,'sigla')), tab_1.p_2.dw_novedad.GetItemNumber(f,'cantidad_ac'))
		end if
	else
		if dw_historia.GetItemNumber(fila,'diasvinculado') >= 0 then
			///aca para control de deducidos
			if tab_1.p_2.rb_ded.checked = TRUE  and (dw_concep_cargo.GetItemString(i,'tipo')<>'P' and dw_concep_cargo.GetItemString(i,'tipo')<>'V' )then 	
				dw_historia.SetItem(fila, f_get_ctrl(dw_concep_cargo.GetItemString(i,'sigla')),0)
			else
				if tab_n.tpn_1.dw_nomcab.GetItemString(tab_n.tpn_1.dw_nomcab.GetRow(),'tipo')<>'R' or  dw_concep_cargo.GetItemString(i,'tipo')<>'V' then
					dw_historia.SetItem(fila, f_get_ctrl(dw_concep_cargo.GetItemString(i,'sigla')),1)
				end if
			end if
		else
			dw_historia.SetItem(fila, f_get_ctrl(dw_concep_cargo.GetItemString(i,'sigla')),0)
		end if
	end if
next

if fila = filahist then
	for i = 1 to tab_1.p_2.dw_novedad.RowCount()
		f = dw_concep_cargo.Find("cod_concep='"+tab_1.p_2.dw_novedad.GetItemString(i,'cod_concep')+"'",1,dw_concep_cargo.RowCount())
		if f = 0 then
			if messageBox('Atención check concepto','El concepto '+tab_1.p_2.dw_novedad.GetItemString(i,'cod_concep')+'-'+tab_1.p_2.dw_novedad.GetItemString(i,'des_concep')+' no esta relacionado con el tipo empleado ' +dw_historia.GetItemString(fila,'tipoemple')+ ' y el cargo '+dw_historia.GetItemString(fila,'cargo')+'. Desea Continuar?',QUESTION!,YESNO!) = 2 then Return -1
		end if
	next
end if
Return 0

end function

public function string f_get_ctrl (string sigla);long f
f = dw_conceptos.Find("sigla='"+sigla+"'",1,dw_conceptos.RowCount())
if f > 0 then
	Return dw_conceptos.GetItemString(f,'control')
else
	MessageBox('Atención','No se encuentra campo control de '+sigla)
end if
Return ''

end function

public function integer f_retrieveend ();long i, filas, sal_ant, ub_ant, sal, ub, f_sal_ant, f_ub_ant, k, car, car_ant, f_car_ant
datetime fec_sal, fec_nul, fec_ubic, fec_car

setNull(fec_nul)
setNull(fec_sal)
setNull(fec_ubic)
filas = dw_historia.RowCount()

for i = 1 to filas
	dw_historia.SetItem(i,'salario_fecha_term',fec_nul)
	dw_historia.SetItem(i,'fec_term_ubica',fec_nul)
	sal =  dw_historia.GetItemNumber(i,'nsalario')
	ub = dw_historia.GetItemNumber(i,'ntraslado')
	car = dw_historia.GetItemNumber(i,'ncargo')
	
	if car_ant <> car then
		if car_ant = 0 then
			if isNull(dw_historia.GetItemDateTime(i,'fecha_termina')) then 
				setNull(fec_car)
			else
				fec_car = dw_historia.GetItemDateTime(i,'fecha_termina')
			end if
		else
			if ABS(DaysAfter(date(dw_historia.GetItemDateTime(i,'fecha_termina')), date(dw_historia.GetItemDateTime(f_car_ant,'fecha_inicio')))) <= 1 then
				fec_car = datetime(RelativeDate(date(dw_historia.GetItemDateTime(f_car_ant,'fecha_inicio')), -1))
			else
				fec_car = dw_historia.GetItemDateTime(i,'fecha_termina')
			end if
		end if
		f_car_ant = i
	end if
	dw_historia.SetItem(i,'fecha_termina', fec_car )
	car_ant = dw_historia.GetItemNumber(i,'ncargo')

	if sal_ant <> sal then
		if sal_ant = 0 then
			setNull(fec_sal)
		else
			fec_sal = datetime(RelativeDate(date(dw_historia.GetITemDateTime(f_sal_ant,'salario_fecha_inicio')), -1))
		end if
		f_sal_ant = i
	end if
	dw_historia.SetItem(i,'salario_fecha_term', fec_sal )
	sal_ant = dw_historia.GetItemNumber(i,'nsalario')
	
	if ub_ant <> ub then
		if ub_ant = 0 then
			setNull(fec_ubic)
		elseif dw_historia.GetItemDateTime(f_ub_ant,'fec_ini_ubica') < dw_historia.GetItemDateTime(i,'fec_ini_ubica') then
			setNull(fec_ubic)
		else
			fec_ubic = datetime(RelativeDate(date(dw_historia.GetItemDateTime(f_ub_ant,'fec_ini_ubica')), -1))
		end if
		f_ub_ant = i
	end if
	dw_historia.SetItem(i,'fec_term_ubica', fec_ubic )
	ub_ant = dw_historia.GetItemNumber(i,'ntraslado')

	dw_historia.SetItem(i,'fecini_nom',tab_n.tpn_1.dw_nomcab.GetItemDateTime(tab_n.tpn_1.dw_nomcab.GetRow(),'inicia'))
	dw_historia.SetItem(i,'fecfin_nom',tab_n.tpn_1.dw_nomcab.GetItemDateTime(tab_n.tpn_1.dw_nomcab.GetRow(),'termina'))
next
if dw_historia.rowcount() > 0 then
	f_tiempos()
end if
//nuevo
//for i = 1 to dw_historia.RowCount()
//	if f_checkconcep(i) = -1 then Return -1
//next
//if get_values(dw_empnom.GetItemString(dw_empnom.GetRow(),'tipodoc'),dw_empnom.GetItemString(dw_empnom.GetRow(),'documento')) = -1 then Return -1
Return 0

end function

public function integer nomcalc (string tipodoc, string documento, string pesp, string ptnom);long fila, j, i, h, aus, dias, filahist, fcontra
string des_concep, valor, tipo,ls_tnom
uo_datastore dw_ahorroact, dw_cuotas
decimal acumulado, calculado, fpago = 0,tarifa,tarifa_esp, vrVac
integer diasVacSig = 0, diasVacAct = 0

log.info("Inicia nomcalc "+ tipodoc+documento)

fcontra = dw_contra.Find("tipodoc='"+tipodoc+"' and documento='"+documento+"'",1,dw_contra.RowCount()) 
if fcontra > 0 then
	fpago = dw_contra.GetItemNumber(fcontra,'monto')
end if

if datos_empleado(tipodoc, documento) > 0 then
	f_retrieveEnd()
	filahist = dw_historia.Find("diasvinculado > 0", 1, dw_historia.RowCount())
	if filahist > 0 and fpago > 0 then
		dw_historia.SetItem(filahist,'salario',fpago)
	end if
end if
if filahist = 0 and dw_historia.RowCount() > 0 then 
	filahist = 1
elseif dw_historia.RowCount() = 0 then
	MessageBox('Atención','El empleado ' +tipodoc+' '+documento+' no tiene registro de cargo y/o salario y/o ubicación')
	Return -1
end if

ls_tnom=tab_n.tpn_1.dw_nomcab.GetItemString(tab_n.tpn_1.dw_nomcab.GetRow(),'tipo')
if ls_tnom<>'C' and ls_tnom<>'P' then
	log.info("Inicia prestamos "+ tipodoc+documento)
	if calc_prestamos(tipodoc, documento, filahist) = -1 then return -1
	log.info("Inicia ahorros "+ tipodoc+documento)
	if calc_ahorros(tipodoc, documento, filahist) = -1 then return -1
end if
log.info("Inicia tsuplementario "+ tipodoc+documento)
if calc_tsuplementario(tipodoc, documento, filahist) = -1 then return -1

if recalcula(tipodoc, documento) = -1 then Return -1

Return 0
end function

public function string get_parm_nov (string sigla);long nc
nc = 1
do while dw_historia.Describe("parm_"+string(nc)+"_t.text") <> 'parm_'+ sigla and nc <= 80
	nc = nc + 1
loop
if nc > 80 then
	//MessageBox('Aviso Jaer','No encontró parametro para redefinir '+sigla)
	Return 'parm_novedad'
end if
Return 'parm_'+string(nc)

end function

public function integer f_addcompute (string concep, string form_calculo, string form_base, decimal tarifa, decimal tarifa_esp, integer litem);long i,nc,ps,pf,f
boolean param=false
int li_res

string ret, ls_novedad, pm

if ctrl = 228 then 
	messageBox('Atención','No pueden agregarse mas conceptos - 150')
	Return -1
end if
if litem>1 then
	form_calculo = "(" + form_calculo + ") * (ctr_" + concep + string(litem)+")"
	form_base = "(" + form_base + ") * (ctr_" + concep+string(litem) + ")"
else
	form_calculo = "(" + form_calculo + ") * (ctr_" + concep + ")"
	form_base = "(" + form_base + ") * (ctr_" + concep + ")"	
end if

li_res=ids_req.setfilter("sigla ='"+ concep+"'")
li_res=ids_req.filter()
li_res=ids_req.sort()
for i = 1 to ids_req.RowCount()
	if concep = ids_req.GetItemString(i,'sigla_req') then Return 2
	if dw_historia.Describe(ids_req.GetItemString(i,'sigla_req') + '.Coltype') = "!" then
		if f_addcompute(ids_req.GetItemString(i,'sigla_req'), ids_req.GetItemString(i,'form_calculo'), ids_req.GetItemString(i,'form_verifica'), ids_req.GetItemnumber(i,'tarifa'), ids_req.GetItemnumber(i,'tarifa_esp'),1) = -1 then 
			MessageBox('Atención','Error agregando concepto requerido '+ids_req.GetItemString(i,'sigla_req'))
			Return -1
		end if
		ids_req.setfilter("sigla ='"+ concep+"'")
		ids_req.filter()
		ids_req.sort()
	end if
next

if dw_historia.Describe(concep + '.Coltype') = "!" then
	ids_novedad.setfilter("sigla='"+concep+"'")
	ids_novedad.filter()
	ls_novedad=ids_novedad.getitemstring(1,'novedad')
	
	ps = pos(form_calculo,'parm_novedad',1)
	if ls_novedad= '1' and ps > 0 then
		nc = 1
		do while dw_historia.Describe("parm_"+string(nc)+"_t.text") <> 'parm_'+string(nc) and nc <=80
			ls_novedad=dw_historia.Describe("parm_"+string(nc)+"_t.text")
			nc = nc + 1
		loop
		if nc >80 then
			MessageBox('Aviso1','Insuficientes campos parm. No se crea campo parametro para novedad '+concep)
		else
		    dw_historia.Modify("parm_"+string(nc)+"_t.text='parm_"+concep+"'") 
			do while ps > 0
				form_calculo = replace(form_calculo,ps,12,"parm_"+string(nc))
				ps = pos(form_calculo,'parm_novedad',ps)
			loop
		end if
		param=true
	end if
	ps = pos(form_calculo,'{',1)
	pf=pos(form_calculo,'}',1)
	if ps>1 then
		do while ps > 0
			pm=mid(form_calculo,(ps+4),pf -(ps+4))
			f = dw_conceptos.Find("sigla = '"+pm+"'",1,dw_conceptos.RowCount())
			if f > 0 then
				pm=dw_conceptos.getitemstring(f,'param')
			else
				MessageBox('Atención','No se encuentra concepto '+concep)
			end if
			if not isnull(pm) then 
				form_calculo = replace(form_calculo,ps,(pf - ps )+1,pm)
			end if
			ps = pos(form_calculo,'{',1)
			pf=pos(form_calculo,'}',1)
		loop	
	end if
	
	ps = pos(form_calculo,'base',1)
	if ps>1 then
		do while ps > 0
			form_calculo = replace(form_calculo,ps,4,form_base)
			ps = pos(form_calculo,'base',ps)
		loop	
	end if
	ps = pos(form_calculo,'tarifa_esp',1)
	if ps>1 then
		do while ps > 0
			form_calculo = replace(form_calculo,ps,10,string((tarifa_esp/100),"000.0000"))
			ps = pos(form_calculo,'tarifa_esp',ps)
		loop	
	end if
	ps = pos(form_calculo,'tarifa',1)
	if ps>1 then
		do while ps > 0
			form_calculo = replace(form_calculo,ps,6,string((tarifa/100),"000.00000"))
			ps = pos(form_calculo,'tarifa',ps)
		loop	
	end if	

	ret = dw_historia.Modify("CREATE text(band=header name="+'ctr_'+string(ctrl - 80,'00') +"_t visible='1' font.charset='0' font.face='Tahoma' font.family='2' font.height='-8' font.pitch='2' font.weight='300' tooltip.enabled='0'  background.mode='2' background.color='12639424' color='0' alignment='2' border='6' x='9' y='4' height='52' width='300' text='"+'ctr_'+concep +"' html.valueishtml='0' )")
	if ret <> "" then Return -1
	ret = dw_historia.Modify("CREATE compute (band=detail alignment='0' expression='"+"ctr"+string(ctrl - 80,"00") +"'  border='0' color='0' x='9' y='4' height='56' width='300' format='[GENERAL]' html.valueishtml='0'  name=" + "ctr_"+concep + " visible='1'  font.face='Arial' font.height='-8' font.weight='300'  font.family='2' font.pitch='2' font.charset='0' background.mode='2' background.color='16777215')")
	if ret <> "" then Return -1


	ret = dw_historia.Modify("CREATE text(band=header name=fc_" +concep+"_t visible='1' font.charset='0' font.face='Tahoma' font.family='2' font.height='-8' font.pitch='2' font.weight='400' tooltip.enabled='0'  background.mode='2' background.color='15780518' color='0' alignment='2' border='6' x='9' y='4' height='52' width='300' text='fc_"+(concep)+"' html.valueishtml='0' )")
	if ret <> "" then Return -1	
	ret = dw_historia.Modify("CREATE compute (band=detail alignment='0' expression='"+ form_calculo +"'  border='0' color='0' x='9' y='4' height='56' width='300' format='[GENERAL]' html.valueishtml='0'  name=" + concep + " tag='parm_"+string(nc) +"' visible='1'  font.face='Arial' font.height='-8' font.weight='300'  font.family='2' font.pitch='2' font.charset='0' background.mode='2' background.color='16777215')")		
	if ret <> "" then Return -1
	
	ret = dw_historia.Modify("CREATE text(band=header name=fb_" +concep+"_t visible='1' font.charset='0' font.face='Tahoma' font.family='2' font.height='-8' font.pitch='2' font.weight='300' tooltip.enabled='0'  background.mode='2' background.color='12639424' color='0' alignment='2' border='6' x='9' y='4' height='52' width='300' text='fb_"+(concep)+"' html.valueishtml='0' )")
	if ret <> "" then Return -1
	ret = dw_historia.Modify("CREATE compute (band=detail alignment='0' expression='"+ form_base+"'  border='0' color='0' x='9' y='4' height='56' width='300' format='[GENERAL]' html.valueishtml='0'  name="+ "b_"+ (concep) + " tag='parm_"+string(nc) + "' visible='1'  font.face='Arial' font.height='-8' font.weight='300'  font.family='2' font.pitch='2' font.charset='0' background.mode='2' background.color='16777215')")		
	if ret <> "" then Return -1
	
	ret = dw_historia.Modify("CREATE text(band=header name=" +concep+"_t visible='1' font.charset='0' font.face='Tahoma' font.family='2' font.height='-8' font.pitch='2' font.weight='400' tooltip.enabled='0'  background.mode='2' background.color='12639424' color='0' alignment='2' border='6' x='9' y='4' height='52' width='300' text='"+(concep)+"' html.valueishtml='0' )")
	if ret <> "" then Return -1
	
	if dw_historia.Describe(concep + '.Coltype') = "!" then Return -1
	f = dw_conceptos.Find("sigla = '"+concep+"'",1,dw_conceptos.RowCount())
	if f > 0 then
		dw_conceptos.SetItem(f,'control','ctr'+string(ctrl -80,"00"))
		if param then dw_conceptos.SetItem(f,'param',"parm_"+string(nc))
	else
		MessageBox('Atención','No se encuentra concepto '+concep)
	end if
	ctrl = ctrl + 1	
else
	if dw_historia.Describe(concep+".expression") <> form_calculo then
		ps = pos(form_calculo,'parm_novedad',1)
		if ps > 0 then
			nc = 1
			do while dw_historia.Describe("parm_"+string(nc)+"_t.text") <> 'parm_'+ concep and nc <= 80
				nc = nc + 1
			loop
			if nc > 80 then
				MessageBox('Aviso2','No encontró parametro para redefinir '+concep)
			else
				do while ps > 0
					form_calculo = replace(form_calculo,ps,12,"parm_"+string(nc))
					ps = pos(form_calculo,'parm_novedad',ps)
				loop
			end if
			param=true
		end if
		f = dw_conceptos.Find("sigla = '"+concep+"'",1,dw_conceptos.RowCount())
		if f > 0 then
			if dw_conceptos.getitemstring(f,'control')='ctr' then
				dw_conceptos.SetItem(f,'control','ctr'+string(ctrl -80,"00"))
			end if
			if param then dw_conceptos.SetItem(f,'param',"parm_"+string(nc))
		else
			MessageBox('Atención','No se encuentra concepto '+concep)
		end if		
		
////		*****
		ps = pos(form_calculo, 'base', 1)
		if ps>1 then
			do while ps > 0
				form_calculo = replace(form_calculo, ps, 4, form_base)
				ps = pos(form_calculo, 'base', ps)
			loop	
		end if
		ps = pos(form_calculo,'tarifa_esp',1)
		if ps>1 then
			do while ps > 0
				form_calculo = replace(form_calculo, ps, 10, string((tarifa_esp/100), "000.0000"))
				ps = pos(form_calculo, 'tarifa_esp', ps)
			loop	
		end if
		ps = pos(form_calculo,'tarifa',1)
		if ps>1 then
			do while ps > 0
				form_calculo = replace(form_calculo, ps, 6, string((tarifa/100), "000.0000"))
				ps = pos(form_calculo, 'tarifa', ps)
			loop	
		end if
		ps = pos(form_calculo,'cantidad',1)
		if ps > 1 then
			do while ps > 0
				f = dw_conceptos.Find("sigla = '"+concep+"'",1,dw_conceptos.RowCount())
				if f > 0 then
					pm = dw_conceptos.getitemstring(f,'param')
				else
					MessageBox('Atención','No se encuentra concepto '+concep)
				end if
				form_calculo = replace(form_calculo,ps,8,pm)
				ps = pos(form_calculo,'cantidad',ps)
			loop	
	end if		
		
///		*******		
	ret = dw_historia.Modify(concep + ".expression='" + form_calculo + "'")
		ps = pos(form_base,'parm_novedad',1)
		if ps > 0 then
			nc = 1
			do while dw_historia.Describe("parm_"+string(nc)+"_t.text") <> 'parm_'+ concep and nc <= 80
				nc = nc + 1
			loop
			if nc >80 then
				MessageBox('Aviso3','No encontró parametro para redefinir '+concep)
			else
				do while ps > 0
					form_base = replace(form_base,ps,12,"parm_"+string(nc))
					ps = pos(form_base,'parm_novedad',ps)
				loop
			end if
		end if
		ret = dw_historia.Modify('b_'+concep + ".expression='" + form_base + "'")
	end if
end if
//Destroy dw_req
Return nc

end function

public function string wf_vac_anticipada ();String cadena

SELECT cadena into :cadena FROM parametros_gen WHERE codigo_para = 60;

return cadena
end function

public subroutine filtrar (string td, string doc);
tab_1.p_1.dw_devenga.SetFilter("tipodoc='" + td + "' and documento='" + doc + "'")
tab_1.p_1.dw_deduce.SetFilter("tipodoc='" + td + "' and documento='" + doc + "'")
tab_1.p_2.dw_novedad.SetFilter("tipodoc='" + td + "' and documento='" + doc + "'")
dw_ausend.SetFilter("tipodoc='" + td + "' and documento='" + doc + "'")
tab_1.p_5.dw_ap.SetFilter("tipodoc='" + td + "' and documento='" + doc + "'")
tab_1.p_7.dw_2.SetFilter("tipodoc='" + td + "' and documento='" + doc + "'")
tab_1.p_1.dw_devenga.Filter()
tab_1.p_1.dw_deduce.Filter()
tab_1.p_2.dw_novedad.Filter()
dw_ausend.Filter()
tab_1.p_5.dw_ap.Filter()
tab_1.p_7.dw_2.Filter()

end subroutine

public function integer calc_prestamos (string tipodoc, string documento, integer filahist);
string form_calculo, form_verifica, ls_codp
int li_k = 1, j, fila, diasVac, diasVacSig, diasVacAct
decimal vrVac

//if  is_tnom<>'R' and  is_tnom<>'V' and  is_tnom='C' and  is_tnom='P' then
	if datos_prestamos(tipodoc, documento) > 0 then
		ls_codp=dw_prestaact.GetItemString(1,'cod_concep')
		for j = 1 to dw_prestaact.RowCount()
			cod_conceppresta = dw_prestaact.GetItemString(j,'cod_concep')
			if ls_codp= cod_conceppresta and j<>1 then 
				ls_codp=cod_conceppresta 
				li_k++
			else
				ls_codp=dw_prestaact.GetItemString(j,'cod_concep')
				li_k=1
			end if
			fila = tab_1.p_2.dw_novedad.InsertRow(0)
			tab_1.p_2.dw_novedad.SetItem(fila,'num_nomina',tab_n.tpn_1.dw_nomcab.GetItemNumber(tab_n.tpn_1.dw_nomcab.GetRow(),'num_nomina'))
			tab_1.p_2.dw_novedad.SetItem(fila,'tipodoc',tipodoc)
			tab_1.p_2.dw_novedad.SetItem(fila,'documento', documento)
			tab_1.p_2.dw_novedad.SetItem(fila,'cod_concep',cod_conceppresta)
			tab_1.p_2.dw_novedad.SetItem(fila,'item',j)
			tab_1.p_2.dw_novedad.SetItem(fila,'cod_tipo_concep', dw_prestaact.GetItemString(j, 'cod_tipo_concep'))
			tab_1.p_2.dw_novedad.SetItem(fila,'des_concep', dw_prestaact.GetItemString(j, 'des_concep'))
			tab_1.p_2.dw_novedad.SetItem(fila,'sigla', dw_prestaact.GetItemString(j, 'sigla'))
			tab_1.p_2.dw_novedad.SetItem(fila,'tipo', dw_prestaact.GetItemString(j, 'tipo'))
			tab_1.p_2.dw_novedad.SetItem(fila,'cantidad_ac',1)
			if wf_vac_anticipada() = '1' then
				diasVacSig = f_dias_vac_per(tipodoc, documento, inicmessig(tab_n.tpn_1.dw_nomcab.GetItemDateTime(tab_n.tpn_1.dw_nomcab.GetRow(),'inicia'))  ) 
				diasVacAct = f_dias_vac_per(tipodoc, documento, tab_n.tpn_1.dw_nomcab.GetItemDateTime(tab_n.tpn_1.dw_nomcab.GetRow(),'inicia')  ) 
				//if  vac=0 then 
					diasVac = f_dias_vac(tipodoc, documento, ls_vac, tab_n.tpn_1.dw_nomcab.GetItemDateTime(tab_n.tpn_1.dw_nomcab.GetRow(),'inicia') , tab_n.tpn_1.dw_nomcab.GetItemDateTime(tab_n.tpn_1.dw_nomcab.GetRow(),'termina')  ) 
				//else
					//diasVacSig=0
				//end if
				if diasVac >0 or diasVacAct > 0 then
					vrVac = round(dw_prestaact.GetItemNumber(j,'valor') * diasVac / 30, 0) - round(dw_prestaact.GetItemNumber(j,'valor') * diasVacAct / 30, 0)
				else
					vrVac = 0
				end if
			end if
			tab_1.p_2.dw_novedad.SetItem(fila,'valor_c',round(dw_prestaact.GetItemNumber(j,'valor') + vrVac,0))
			tab_1.p_2.dw_novedad.SetItem(fila,'pagado',round(dw_prestaact.GetItemNumber(j,'valor') + vrVac,0))
			tab_1.p_2.dw_novedad.SetItem(fila,'ncargo',dw_historia.GetItemNumber(filahist,'ncargo'))
			tab_1.p_2.dw_novedad.SetItem(fila,'nsalario', dw_historia.GetItemNumber(filahist,'nsalario'))
			tab_1.p_2.dw_novedad.SetItem(fila,'ntraslado', dw_historia.GetItemNumber(filahist,'ntraslado'))
			tab_1.p_2.dw_novedad.SetItem(fila,'numdoc',dw_prestaact.GetItemNumber(j,'num_prescoopera'))
			tab_1.p_2.dw_novedad.SetItem(fila,'num_plan',dw_prestaact.GetItemNumber(j,'num_plan'))
			tab_1.p_2.dw_novedad.SetItem(fila,'cuota',dw_prestaact.GetItemNumber(j,'ncuota'))
			////se agrega para cálculos ese indias
			if f_addcompute(dw_prestaact.GetItemString(j, 'sigla'), string(round(dw_prestaact.GetItemNumber(j,'valor')+ vrVac,0)), string(round(dw_prestaact.GetItemNumber(j,'valor')+ vrVac,0)), dw_prestaact.GetItemNumber(j,'tarifa'), dw_prestaact.GetItemNumber(j,'tarifa_esp'), li_k) = -1 then Return -1	
		next
	end if
//end if	
return 0

end function

public function integer calc_ahorros (string tipodoc, string documento, integer filahist);uo_datastore dw_ahorroact, dw_cuotas
String ls_codp,  form_calculo, form_verifica, valor
Integer j, fila, li_k, diasVacSig = 0, diasVacAct = 0
decimal acumulado, calculado, fpago = 0,tarifa,tarifa_esp, vrVac
blob bfc,bfc1

//if  is_tnom<>'R' and  is_tnom<>'V' and  is_tnom='C' and  is_tnom='P' then
	dw_ahorroact = create uo_datastore
	dw_ahorroact.DataObject = "dw_ahorrocabnom"
	dw_ahorroact.SetTransObject(SQLCA)
	if dw_ahorroact.Retrieve(tipodoc, documento) > 0 then
		dw_cuotas = create uo_datastore
		dw_cuotas.DataObject = "dw_ahorrocpo"
		dw_cuotas.SetTransObject(SQLCA)
		ls_codp = dw_ahorroact.GetItemString(1,'cod_concep')
		for j = 1 to dw_ahorroact.RowCount()		
			if dw_cuotas.Retrieve(dw_ahorroact.GetItemNumber(j,'num_ahorro')) > 0 then
				acumulado = dw_cuotas.GetItemNumber(1,'compute_1')
			else
				acumulado = 0
			end if
			//if acumulado >= dw_ahorroact.GetItemNumber(j,'vfijo') and dw_ahorroact.GetItemString(j,'tipo') = '0' then CONTINUE
			//if date(dw_ahorroact.GetItemdatetime(j,'fecha'))>= date(tab_n.tpn_1.dw_nomcab.GetItemDateTime(tab_n.tpn_1.dw_nomcab.GetRow(),'inicia')) and date(dw_ahorroact.GetItemdatetime(j,'fecha'))<= date(tab_n.tpn_1.dw_nomcab.GetItemDateTime(tab_n.tpn_1.dw_nomcab.GetRow(),'termina')) then				
			fila = dw_cuotas.find("fecha >= date('" + string(tab_n.tpn_1.dw_nomcab.GetItemDateTime(tab_n.tpn_1.dw_nomcab.GetRow(),'inicia')) + &
				"') and fecha <= date('"+ string(tab_n.tpn_1.dw_nomcab.GetItemDateTime(tab_n.tpn_1.dw_nomcab.GetRow(),'termina'))+"')" ,1,dw_cuotas.Rowcount())
			if fila = 0 then
				cod_concepahorro = dw_ahorroact.GetItemString(j,'cod_concep')
				if ls_codp= cod_concepahorro and j<>1 then 
					ls_codp=cod_concepahorro
					li_k++
				else
					li_k=1
				end if	
	
				fila = tab_1.p_2.dw_novedad.InsertRow(0)
				tab_1.p_2.dw_novedad.SetItem(fila,'num_nomina',tab_n.tpn_1.dw_nomcab.GetItemNumber(tab_n.tpn_1.dw_nomcab.GetRow(),'num_nomina'))
				tab_1.p_2.dw_novedad.SetItem(fila,'tipodoc', tipodoc)
				tab_1.p_2.dw_novedad.SetItem(fila,'documento',documento)
				tab_1.p_2.dw_novedad.SetItem(fila,'cod_concep',cod_concepahorro)
				tab_1.p_2.dw_novedad.SetItem(fila,'item',j)
				tab_1.p_2.dw_novedad.SetItem(fila,'ncargo', dw_historia.GetItemNumber(filahist,'ncargo'))
				tab_1.p_2.dw_novedad.SetItem(fila,'nsalario', dw_historia.GetItemNumber(filahist,'nsalario'))
				tab_1.p_2.dw_novedad.SetItem(fila,'ntraslado', dw_historia.GetItemNumber(filahist,'ntraslado'))
				tab_1.p_2.dw_novedad.SetItem(fila,'cod_tipo_concep', dw_ahorroact.GetItemString(j,'cod_tipo_concep'))
				tab_1.p_2.dw_novedad.SetItem(fila,'des_concep', dw_ahorroact.GetItemString(j,'des_concep'))
				tab_1.p_2.dw_novedad.SetItem(fila,'sigla', dw_ahorroact.GetItemString(j,'sigla'))
				tab_1.p_2.dw_novedad.SetItem(fila,'tipo', dw_ahorroact.GetItemString(j,'tipo_concep'))
				tab_1.p_2.dw_novedad.SetItem(fila,'cantidad_ac',1)
				if dw_ahorroact.GetItemString(j,'tipo') = '0' then
					if wf_vac_anticipada() = '1' then
						//if  vac=0 then 
							diasVacSig=f_dias_vac(tipodoc, documento, ls_vac, tab_n.tpn_1.dw_nomcab.GetItemDateTime(tab_n.tpn_1.dw_nomcab.GetRow(),'inicia') , tab_n.tpn_1.dw_nomcab.GetItemDateTime(tab_n.tpn_1.dw_nomcab.GetRow(),'termina')  ) 
						//else
							//diasVacSig=0
						//end if
						diasVacAct = f_dias_vac_per(tipodoc, documento, tab_n.tpn_1.dw_nomcab.GetItemDateTime(tab_n.tpn_1.dw_nomcab.GetRow(),'inicia')  ) 
						if diasVacSig >0 or diasVacAct > 0 then
							vrVac = round(dw_ahorroact.GetItemNumber(j,'vfijo') * diasVacSig / 30, 0) - round(dw_ahorroact.GetItemNumber(j,'vfijo') * diasVacAct / 30, 0)
						else
							vrVac = 0
						end if
					end if
					tab_1.p_2.dw_novedad.SetItem(fila,'valor_c',round(dw_ahorroact.GetItemNumber(j,'vfijo') + vrVac,0))
					tab_1.p_2.dw_novedad.SetItem(fila,'pagado',round(dw_ahorroact.GetItemNumber(j,'vfijo') + vrVac,0))
					////se agrega para calculos ese indias						
					if f_addcompute(dw_ahorroact.GetItemString(j,'sigla'), string(round(dw_ahorroact.GetItemNumber(j,'vfijo') +vrVac,0)), string(round(dw_ahorroact.GetItemNumber(j,'vfijo')+vrVac,0)), tarifa, tarifa_esp, li_k) = -1 then Return -1
				else
					selectblob form_calculo into :bfc
					from nom_concep where cod_concep=:cod_concepahorro;
	
					selectblob form_verifica into :bfc1
					from nom_concep where cod_concep=:cod_concepahorro;
	
					form_calculo = string(bfc)
					form_verifica = string(bfc1)
					if  dw_ahorroact.GetItemNumber(j,'porcensal') <>0 then
						tarifa=dw_ahorroact.GetItemNumber(j,'porcensal')
						calculado = round((dw_ahorroact.GetItemNumber(j,'porcensal')/100 * calculado),0)
						tab_1.p_2.dw_novedad.SetItem(fila, 'tarifa', dw_ahorroact.GetItemNumber(j,'porcensal'))
					end if

					if f_addcompute(dw_ahorroact.GetItemString(j,'sigla'), form_calculo,form_verifica,tarifa,tarifa_esp,li_k) = -1 then Return -1
					long k
					dw_historia.SetItem(filahist, f_get_ctrl(dw_ahorroact.GetItemString(j,'sigla')), 1)
					tab_1.p_2.dw_novedad.ScrolltoRow(fila)
					tab_1.p_2.dw_novedad.SetColumn('cantidad_ac')
					dw_historia.SetItem(filahist,get_parm_nov(tab_1.p_2.dw_novedad.GetItemString(fila,'sigla')),1)
					calculado = round(dw_historia.GetItemNumber(filahist,tab_1.p_2.dw_novedad.GetItemString(fila,'sigla')),0)
					if tab_n.tpn_1.dw_nomcab.GetItemstring(tab_n.tpn_1.dw_nomcab.Getrow(),'esp')='1' then
						tab_1.p_2.dw_novedad.SetItem(fila, 'tarifa', tarifa_esp)
					else
						tab_1.p_2.dw_novedad.SetItem(fila, 'tarifa', tarifa)
					end if
					tab_1.p_2.dw_novedad.SetItem(fila, 'valor_c', calculado)
					tab_1.p_2.dw_novedad.SetItem(fila, 'pagado', calculado)
				end if
				tab_1.p_2.dw_novedad.SetItem(fila,'ncargo',dw_historia.GetItemNumber(filahist,'ncargo'))
				tab_1.p_2.dw_novedad.SetItem(fila,'numdoc',dw_ahorroact.GetItemNumber(j,'num_ahorro'))
				valor = dw_cuotas.Describe("Evaluate('max(ncuota)', 0)")
				if isNull(valor) then valor = '0'
				tab_1.p_2.dw_novedad.SetItem(fila,'cuota',long(valor) + 1)
			end if
		//	end if
		next
	end if
//end if

end function

public function integer calc_tsuplementario (string tipodoc, string documento, integer filahist);Integer i, j, fila
decimal tarifa, tarifa_esp
blob bfc, bfc1
String form_calculo, form_verifica

if cbx_1.checked then
	//dw_tsup.Retrieve(tipodoc,documento,year(date(tab_n.tpn_1.dw_nomcab.GetItemDateTime(tab_n.tpn_1.dw_nomcab.Getrow(),'inicia'))),month(date(tab_n.tpn_1.dw_nomcab.GetItemDateTime(tab_n.tpn_1.dw_nomcab.Getrow(),'inicia'))) )
	datos_tsuplementario(tipodoc, documento)
	if filahist = 0 then
		if dw_historia.RowCount() = 0 and dw_tsup.RowCount() > 0  then
			MessageBox('Atención','El empleado '+tipodoc+documento+' no tiene dias laborados en el periodo, pero tiene novedades por trabajo suplementario')
			Return 0
		end if
	end if

	for i = 1 to dw_tsup.RowCount()
		if dw_tsup.GetItemString(i,'novedad') = '0' then CONTINUE
		fila = tab_1.p_2.dw_novedad.Find("cod_concep='"+dw_tsup.GetItemString(i,'cod_concep')+"'",1,tab_1.p_2.dw_novedad.RowCount())
		if fila >= 0  then
			cod_concepahorro = dw_tsup.GetItemString(i,'cod_concep')
			sqlca.autocommit=true
			
			selectblob form_calculo into :bfc
			from nom_concep where cod_concep=:cod_concepahorro;
			
			selectblob form_verifica into :bfc1
			from nom_concep where cod_concep=:cod_concepahorro;
			
			select tarifa,tarifa_esp into :tarifa,:tarifa_esp
			from nom_concep where cod_concep=:cod_concepahorro;
			sqlca.autocommit=false
			form_calculo = string(bfc)
			form_verifica = string(bfc1)

			if dw_historia.Describe(dw_tsup.GetItemString(i,'sigla') + '.Coltype') = "!" then
				if f_addcompute(dw_tsup.GetItemString(i,'sigla'), form_calculo,form_verifica,tarifa,tarifa_esp,i) = -1 then Return -1
			end if
			if fila=0 then fila = tab_1.p_2.dw_novedad.InsertRow(0)
			tab_1.p_2.dw_novedad.SetItem(fila,'num_nomina',tab_n.tpn_1.dw_nomcab.GetItemNumber(tab_n.tpn_1.dw_nomcab.GetRow(),'num_nomina'))
			tab_1.p_2.dw_novedad.SetItem(fila,'tipodoc',tipodoc)
			tab_1.p_2.dw_novedad.SetItem(fila,'documento',documento)
			tab_1.p_2.dw_novedad.SetItem(fila,'cod_concep',dw_tsup.GetItemString(i,'cod_concep'))
			tab_1.p_2.dw_novedad.SetItem(fila,'item',i)
			if filahist=0 then 
				MessageBox('Atencion','Inconsistencia para el documento'+documento)	
			end if
			tab_1.p_2.dw_novedad.SetItem(fila,'ncargo', dw_historia.GetItemNumber(filahist,'ncargo'))
			tab_1.p_2.dw_novedad.SetItem(fila,'nsalario', dw_historia.GetItemNumber(filahist,'nsalario'))
			tab_1.p_2.dw_novedad.SetItem(fila,'ntraslado', dw_historia.GetItemNumber(filahist,'ntraslado'))
			tab_1.p_2.dw_novedad.SetItem(fila,'cod_tipo_concep',dw_tsup.GetItemString(i,'cod_tipo_concep'))
			tab_1.p_2.dw_novedad.SetItem(fila,'des_concep',dw_tsup.GetItemString(i,'des_concep'))
			tab_1.p_2.dw_novedad.SetItem(fila,'sigla',dw_tsup.GetItemString(i,'sigla'))
			tab_1.p_2.dw_novedad.SetItem(fila,'tipo',dw_tsup.GetItemString(i,'tipo'))
			tab_1.p_2.dw_novedad.SetItem(fila,'cantidad_ac',dw_tsup.GetItemNumber(i,'horas'))
			tab_1.p_2.dw_novedad.SetItem(fila,'form_calculo',form_calculo)
			for j = 1 to dw_historia.RowCount()
				if j = filahist then
					dw_historia.SetItem(j,get_parm_nov(dw_tsup.GetItemString(i,'sigla')),dw_tsup.GetItemNumber(i,'horas'))
					dw_historia.SetItem(j,f_get_ctrl(dw_tsup.GetItemString(i,'sigla')),1)
				else
					dw_historia.SetItem(j,get_parm_nov(dw_tsup.GetItemString(i,'sigla')),0)
					dw_historia.SetItem(j,f_get_ctrl(dw_tsup.GetItemString(i,'sigla')),0)
				end if
			next
		end if
	next
end if
end function

public subroutine redraw (boolean valor);tab_n.tpn_2.dw_empnom.SetRedraw(valor)
tab_1.p_1.dw_devenga.SetRedraw(valor)
tab_1.p_1.dw_deduce.SetRedraw(valor)
tab_1.p_2.dw_novedad.SetRedraw(valor)
tab_1.p_5.dw_ap.SetRedraw(valor)
end subroutine

public function integer datos_empleado (string tipodoc, string documento);
dw_historia.reset()
dw_histoall.setFilter("tipodoc = '" + tipodoc + "' and documento = '" + documento + "'")
dw_histoall.filter()
dw_histoall.Sort()
dw_histoall.RowsCopy(1, dw_histoall.rowCount(), Primary!, dw_historia, 1, primary!)

return dw_historia.rowCount()

end function

public function integer datos_ausentismo (string tipodoc, string documento, string cod_ausentismo);datetime ld_ini,ld_fin

if cod_ausentismo='VA' then
	ld_ini=tab_n.tpn_1.dw_nomcab.GetItemDateTime(tab_n.tpn_1.dw_nomcab.GetRow(),'inicia')
	ld_fin=datetime(relativedate(date(tab_n.tpn_1.dw_nomcab.GetItemDateTime(tab_n.tpn_1.dw_nomcab.GetRow(),'termina')),30))
else
	ld_ini=tab_n.tpn_1.dw_nomcab.GetItemDateTime(tab_n.tpn_1.dw_nomcab.GetRow(),'inicia')
	ld_fin=tab_n.tpn_1.dw_nomcab.GetItemDateTime(tab_n.tpn_1.dw_nomcab.GetRow(),'termina')
end if
//string jaer
//jaer="((tipodoc = '" + tipodoc + "') AND (documento = '" + documento + "') AND (cod_ausen ='" + cod_ausentismo + "') AND ((fechaini between date('" +string(ld_ini,'dd/mm/yyyy')+ "') and date('"+string(ld_fin,'dd/mm/yyyy')+"') ) or (fechafin between date('" +string(ld_ini,'dd/mm/yyyy')+ "') and date('"+string(ld_fin,'dd/mm/yyyy')+"'))))"

String filtro 
filtro = "tipodoc = '" + tipodoc+"' AND documento = '"+documento+"' AND cod_ausen ='"+cod_ausentismo+"' AND (fechaini between date('"+string(ld_ini,'dd/mm/yyyy')+"') and date('"+string(ld_fin,'dd/mm/yyyy')+"') or fechafin between date('"+string(ld_ini,'dd/mm/yyyy')+"') and date('"+string(ld_fin,'dd/mm/yyyy')+"') or (fechaini < date('"+string(ld_ini,'dd/mm/yyyy')+"') and fechafin >date('"+string(ld_fin,'dd/mm/yyyy')+"')))"
dw_aus.setFilter(filtro)
dw_aus.filter()
dw_aus.sort()

return dw_aus.rowCount()

end function

public function integer datos_prestamos (string tipodoc, string documento);
dw_prestaact.setFilter("tipodoc = '" + tipodoc + "' AND documento = '" + documento + "'")
dw_prestaact.filter()
dw_prestaact.sort()

return dw_prestaact.rowCount()

end function

public function integer datos_tsuplementario (string tipodoc, string documento);
dw_tsup.setFilter("tipodoc = '" + tipodoc + "' and documento = '" + documento + "'")
dw_tsup.filter()

return dw_tsup.rowCount()
end function

public function integer datos_concep_cargo (string codrela, string tipoemple, string cargo);
dw_concep_cargo.setFilter("codrela='"+codrela+"' and tipoemple='"+tipoemple+"' and cargo='"+cargo+"'")
dw_concep_cargo.filter()

return dw_concep_cargo.rowCount()
end function

public function integer recalcula (string tipodoc, string documento);long i, filahist, h,ll_fila
decimal cantidad
string tipo,msg

log.info("Inicia recalcula "+ tipodoc+documento)
if tab_1.p_2.rb_nin.checked = TRUE then Return 0
if tab_n.tpn_2.dw_empnom.RowCount() = 0 then Return 0
if tab_n.tpn_1.dw_nomcab.GetItemString(tab_n.tpn_1.dw_nomcab.GetRow(),'estado') <> '0' then Return 0

h=tab_n.tpn_1.dw_nomcab.GetItemNumber(tab_n.tpn_1.dw_nomcab.GetRow(),'num_nomina')
if tab_1.p_1.dw_devenga.RowCount() > 0 then
	do while tab_1.p_1.dw_devenga.RowCount() > 0
		tab_1.p_1.dw_devenga.DeleteRow(1)
	loop
end if
if tab_1.p_1.dw_deduce.RowCount() > 0 then
	do while tab_1.p_1.dw_deduce.RowCount() > 0
		tab_1.p_1.dw_deduce.DeleteRow(1)
	loop
end if
if tab_1.p_5.dw_ap.RowCount() > 0 then
	do while tab_1.p_5.dw_ap.RowCount() > 0
		tab_1.p_5.dw_ap.DeleteRow(1)
	loop
end if

filahist = dw_historia.Find("diasvinculado > 0",1,dw_historia.RowCount())
if filahist =0 and dw_historia.RowCount()>0 then filahist =1
for i = 1 to tab_1.p_2.dw_novedad.RowCount()
	tipo = tab_1.p_2.dw_novedad.GetItemString(i,'cod_tipo_concep')
	if not (tipo = '7' or tipo = '8' or tipo = '9') then 
		if dw_historia.Describe(tab_1.p_2.dw_novedad.GetItemString(i,'sigla') + '.Coltype') = "!" then
			if not isnull(tab_1.p_2.dw_novedad.GetItemString(i,'form_calculo')) then
				if f_addcompute( tab_1.p_2.dw_novedad.GetItemString(i,'sigla'), tab_1.p_2.dw_novedad.GetItemString(i,'form_calculo'), tab_1.p_2.dw_novedad.GetItemString(i,'form_verifica'), tab_1.p_2.dw_novedad.GetItemnumber(i,'tarifa'), tab_1.p_2.dw_novedad.GetItemnumber(i,'tarifa_esp'),1) = -1 then  Return -1
			end if
		end if
		if pos(dw_historia.Describe(tab_1.p_2.dw_novedad.GetItemString(i,'sigla') +".expression"),'{' )>1 then
			if f_addcompute( tab_1.p_2.dw_novedad.GetItemString(i,'sigla'), tab_1.p_2.dw_novedad.GetItemString(i,'form_calculo'), tab_1.p_2.dw_novedad.GetItemString(i,'form_verifica'), tab_1.p_2.dw_novedad.GetItemnumber(i,'tarifa'), tab_1.p_2.dw_novedad.GetItemnumber(i,'tarifa_esp'),1) = -1 then  Return -1
		end if		
		if get_parm_nov(tab_1.p_2.dw_novedad.GetItemString(i,'sigla'))='-1' then continue
		setnull(ll_fila)
		ll_fila= dwc_novedad.Find("cod_concep='"+tab_1.p_2.dw_novedad.GetItemString(i,'cod_concep')+"'",1,dwc_novedad.RowCount())
		if ll_fila > 0 then dwc_novedad.ScrolltoRow(ll_fila)		
		if dwc_novedad.GetItemString(ll_fila,'incap')='1' then continue
		cantidad = tab_1.p_2.dw_novedad.GetItemNumber(i,'cantidad_ac')
		dw_historia.SetItem(filahist,get_parm_nov(tab_1.p_2.dw_novedad.GetItemString(i,'sigla')),cantidad)
		if dw_historia.Describe(tab_1.p_2.dw_novedad.GetItemString(i,'sigla') + ".coltype") <> '!' then
			cantidad = round(dw_historia.GetItemNumber(filahist,tab_1.p_2.dw_novedad.GetItemString(i,'sigla')), 0)
			if tab_1.p_2.dw_novedad.GetItemNumber(i,'pagado') > 0 and  trim(tab_1.p_2.dw_novedad.GetItemString(i,'form_calculo')) = "0" then
				cantidad = tab_1.p_2.dw_novedad.GetItemNumber(i,'pagado')
				dw_historia.Modify(tab_1.p_2.dw_novedad.GetItemString(i,'sigla') + '.expression="'+string(cantidad)+' * if(salario_estado=~~"1~~",1,0) * ctr_'+tab_1.p_2.dw_novedad.GetItemString(i,'sigla')+'"') 
			end if
			if not isNull(cantidad) then
				tab_1.p_2.dw_novedad.SetItem(i,'valor_c',cantidad)
				tab_1.p_2.dw_novedad.SetItem(i,'pagado',cantidad)
			end if
		end if
	end if
next
for i = 1 to dw_historia.RowCount()
	log.info("Inicia checkConcep "+ tipodoc+documento)
	if f_checkconcep(i) = -1 then Return -1
next
log.info("Inicia get_values "+ tipodoc+documento)

if tab_1.p_2.rb_nov.checked = TRUE  then Return 0

if get_values(tipodoc, documento) = -1 then Return -1
calctotal()
log.info("Termina recalcula "+ tipodoc+documento)
Return 0

end function

public subroutine actualizardatos ();//// Trae datos de todos los empleados
if tab_n.tpn_1.dw_nomcab.rowCount() = 0 then return

Yield()
dw_histoall.retrieve(date(tab_n.tpn_1.dw_nomcab.GetItemDateTime(tab_n.tpn_1.dw_nomcab.GetRow(),'inicia')), date(tab_n.tpn_1.dw_nomcab.GetItemDateTime(tab_n.tpn_1.dw_nomcab.GetRow(),'termina')), l_nesp,is_tnom)
Yield()
if is_tnom<>'P' and is_tnom<>'C'  then
	dw_aus.Retrieve(tab_n.tpn_1.dw_nomcab.GetItemDateTime(tab_n.tpn_1.dw_nomcab.GetRow(),'inicia'), datetime(relativedate(date(tab_n.tpn_1.dw_nomcab.GetItemDateTime(tab_n.tpn_1.dw_nomcab.GetRow(),'termina')),30)))
	Yield()
	dw_prestaact.retrieve(tab_n.tpn_1.dw_nomcab.GetItemDateTime(tab_n.tpn_1.dw_nomcab.GetRow(),'inicia'), tab_n.tpn_1.dw_nomcab.GetItemDateTime(tab_n.tpn_1.dw_nomcab.GetRow(),'termina'))
	Yield()
	dw_tsup.retrieve( year(date(tab_n.tpn_1.dw_nomcab.GetItemDateTime(tab_n.tpn_1.dw_nomcab.Getrow(),'inicia'))),month(date(tab_n.tpn_1.dw_nomcab.GetItemDateTime(tab_n.tpn_1.dw_nomcab.Getrow(),'inicia'))) )
	Yield()
end if
dw_concep_cargo.retrieve()
Yield()
dw_apemp.retrieve()
ibn_actualizado = true
////

end subroutine

public function integer datos_apemp (string tipodoc, string documento, string cod_clase);
dw_apemp.setFilter("tipodoc='"+tipodoc+"' and documento='"+documento+"' and cod_clase='" + cod_clase +"'")
dw_apemp.filter()

return dw_apemp.rowCount()
end function

public function long f_addnovedad ();long ldb_filanov, ldb_filahistnov
string ls_tdnov, ls_docnov

if tab_n.tpn_1.dw_nomcab.GetItemString(tab_n.tpn_1.dw_nomcab.GetRow(),'Estado') <> '0' then
	messageBox('Aviso','El documento ya ha sido cerrado. No puede modificarse')
	Return -1
end if

ls_tdnov=tab_n.tpn_2.dw_empnom.GetItemString(tab_n.tpn_2.dw_empnom.GetRow(),'tipodoc')
ls_docnov=tab_n.tpn_2.dw_empnom.GetItemString(tab_n.tpn_2.dw_empnom.GetRow(),'documento')
//datos_empleado(ls_tdnov, ls_docnov)

ldb_filanov = tab_1.p_2.dw_novedad.InsertRow(0)
tab_1.p_2.dw_novedad.SetItem(ldb_filanov,'num_nomina',tab_n.tpn_1.dw_nomcab.GetItemNumber(tab_n.tpn_1.dw_nomcab.GetRow(),'num_nomina'))
tab_1.p_2.dw_novedad.SetItem(ldb_filanov,'tipodoc',ls_tdnov)
tab_1.p_2.dw_novedad.SetItem(ldb_filanov,'documento',ls_docnov)
tab_1.p_2.dw_novedad.SetItem(ldb_filanov,'item',1)
ldb_filahistnov= dw_historia.Find("diasvinculado > 0",1,dw_historia.RowCount())
if ldb_filahistnov =0 and dw_historia.RowCount()>0 then ldb_filahistnov =1
if ldb_filahistnov > 0 then
	tab_1.p_2.dw_novedad.SetItem(ldb_filanov,'ncargo',dw_historia.GetItemNumber(ldb_filahistnov,'ncargo'))
	tab_1.p_2.dw_novedad.SetItem(ldb_filanov,'nsalario',dw_historia.GetItemNumber(ldb_filahistnov,'nsalario'))
	tab_1.p_2.dw_novedad.SetItem(ldb_filanov,'ntraslado',dw_historia.GetItemNumber(ldb_filahistnov,'ntraslado'))
end if
cambio = TRUE
tab_1.p_2.dw_novedad.ScrolltoRow(ldb_filanov)
Return ldb_filanov
end function

on w_nomina.create
int iCurrent
call super::create
this.pb_anular=create pb_anular
this.pb_cancelar=create pb_cancelar
this.pb_2=create pb_2
this.cb_1=create cb_1
this.cbx_1=create cbx_1
this.hpb_1=create hpb_1
this.dw_apemp=create dw_apemp
this.sle_fila=create sle_fila
this.tab_1=create tab_1
this.dw_tsup=create dw_tsup
this.dw_1=create dw_1
this.dw_tipoincap=create dw_tipoincap
this.tab_n=create tab_n
this.st_15=create st_15
this.mle_1=create mle_1
this.sle_4=create sle_4
this.pb_calcula=create pb_calcula
this.dw_ausend=create dw_ausend
this.st_14=create st_14
this.st_16=create st_16
this.pb_pila=create pb_pila
this.dw_nelec=create dw_nelec
this.lb_1=create lb_1
this.dw_pila=create dw_pila
this.pb_9=create pb_9
this.dw_empact=create dw_empact
this.dw_aus=create dw_aus
this.dw_historia_bak=create dw_historia_bak
iCurrent=UpperBound(this.Control)
this.Control[iCurrent+1]=this.pb_anular
this.Control[iCurrent+2]=this.pb_cancelar
this.Control[iCurrent+3]=this.pb_2
this.Control[iCurrent+4]=this.cb_1
this.Control[iCurrent+5]=this.cbx_1
this.Control[iCurrent+6]=this.hpb_1
this.Control[iCurrent+7]=this.dw_apemp
this.Control[iCurrent+8]=this.sle_fila
this.Control[iCurrent+9]=this.tab_1
this.Control[iCurrent+10]=this.dw_tsup
this.Control[iCurrent+11]=this.dw_1
this.Control[iCurrent+12]=this.dw_tipoincap
this.Control[iCurrent+13]=this.tab_n
this.Control[iCurrent+14]=this.st_15
this.Control[iCurrent+15]=this.mle_1
this.Control[iCurrent+16]=this.sle_4
this.Control[iCurrent+17]=this.pb_calcula
this.Control[iCurrent+18]=this.dw_ausend
this.Control[iCurrent+19]=this.st_14
this.Control[iCurrent+20]=this.st_16
this.Control[iCurrent+21]=this.pb_pila
this.Control[iCurrent+22]=this.dw_nelec
this.Control[iCurrent+23]=this.lb_1
this.Control[iCurrent+24]=this.dw_pila
this.Control[iCurrent+25]=this.pb_9
this.Control[iCurrent+26]=this.dw_empact
this.Control[iCurrent+27]=this.dw_aus
this.Control[iCurrent+28]=this.dw_historia_bak
end on

on w_nomina.destroy
call super::destroy
destroy(this.pb_anular)
destroy(this.pb_cancelar)
destroy(this.pb_2)
destroy(this.cb_1)
destroy(this.cbx_1)
destroy(this.hpb_1)
destroy(this.dw_apemp)
destroy(this.sle_fila)
destroy(this.tab_1)
destroy(this.dw_tsup)
destroy(this.dw_1)
destroy(this.dw_tipoincap)
destroy(this.tab_n)
destroy(this.st_15)
destroy(this.mle_1)
destroy(this.sle_4)
destroy(this.pb_calcula)
destroy(this.dw_ausend)
destroy(this.st_14)
destroy(this.st_16)
destroy(this.pb_pila)
destroy(this.dw_nelec)
destroy(this.lb_1)
destroy(this.dw_pila)
destroy(this.pb_9)
destroy(this.dw_empact)
destroy(this.dw_aus)
destroy(this.dw_historia_bak)
end on

event open;call super::open;setpointer(hourglass!)
if event cargar()=-1 then 
	pb_cancelar.triggerevent(clicked!)
end if
setpointer(arrow!)
end event

event key;call super::key;if key = KeyEscape! then
	ibn_cancelar = TRUE
end if


end event

event resize;call super::resize;tab_n.event resize(4030, newheight * 0.35)

tab_1.y=tab_n.y + tab_n.height +60
tab_1.event resize(newwidth , newheight * 0.62 )

//Ubica botones
pb_2.x=tab_n.x+tab_n.width + 20
pb_cancelar.x=tab_n.x+tab_n.width + 20
pb_anular.x=tab_n.x+tab_n.width + 20
pb_grabar.x=tab_n.x+tab_n.width + 20
pb_calcula.x=tab_n.x+tab_n.width + 20
pb_pila.x=tab_n.x+tab_n.width + 20

//Ubica formulas
st_14.x=tab_n.x+tab_n.width + 190
sle_4.x=tab_n.x+tab_n.width + 190

sle_fila.x=st_14.x + st_14.width + 20
cb_1.x=sle_fila.x +sle_fila.width + 150

mle_1.x=tab_n.x+tab_n.width + 190
mle_1.width = newwidth - tab_n.x - tab_n.width - 190

//Ubica  medio ventana
cbx_1.y=tab_n.y + tab_n.height + 5
hpb_1.y=tab_n.y + tab_n.height + 5
hpb_1.width =2491

//st_16.x=pb_2.x+ 200
end event

type pb_grabar from w_center`pb_grabar within w_nomina
integer x = 3968
integer y = 24
integer taborder = 250
string powertiptext = "&Guardar Definitivo"
end type

event pb_grabar::clicked;call super::clicked;if tab_n.tpn_1.dw_nomcab.RowCount() = 0 then Return
if tab_n.tpn_1.dw_nomcab.GetItemString(tab_n.tpn_1.dw_nomcab.GetRow(),'Estado') <> '0' then
	messageBox('Aviso','El documento ya ha sido cerrado. No puede modificarse')
	Return
end if
if MessageBox('Atención','Si graba definitivo no podrá hacer cambios. Desea continuar?',QUESTION!,YESNO!) = 2 then Return 0
grabar('definitivo')

end event

type pb_anular from picturebutton within w_nomina
event mousemove pbm_mousemove
string tag = "&Anular"
integer x = 3968
integer y = 284
integer width = 146
integer height = 128
integer taborder = 230
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "                $a"
boolean originalsize = true
string picturename = "borrar_fila.gif"
string disabledname = "d_borrar_fila.gif"
string powertiptext = "&Anular"
end type

event clicked;if il_nuevo > 0 then
	tab_n.tpn_1.dw_nomcab.deleterow(il_nuevo)
	il_nuevo = 0
	tab_n.tpn_1.dw_nomcab.triggerEvent(rowfocuschanged!)
	return
end if
if tab_n.tpn_1.dw_nomcab.GetRow() < 0 then Return
if tab_n.tpn_1.dw_nomcab.GetItemString(tab_n.tpn_1.dw_nomcab.GetRow(),'contabil') = 'C' then
	MessageBox("Atención", 'Nomina Contabilizada verifique con Area contable')
	Return
end if

if messageBox('Aviso','Esta seguro de anular el documento seleccionado?',QUESTION!,YESNO!) = 2 then
	Return
end if

string filtro, msg
uo_datastore dw_nov
dw_nov = CREATE uo_datastore
dw_nov.DataObject = "dw_novedades"
filtro = tab_1.p_2.dw_novedad.Describe("DataWindow.Table.Filter")
tab_1.p_2.dw_novedad.SetFilter("")
tab_1.p_2.dw_novedad.Filter()
if tab_1.p_2.dw_novedad.RowCount() > 0 then
	dw_nov.Object.Data = tab_1.p_2.dw_novedad.Object.Data
end if
tab_1.p_2.dw_novedad.SetFilter(filtro)
tab_1.p_2.dw_novedad.Filter()

if tab_n.tpn_1.dw_nomcab.GetItemString(tab_n.tpn_1.dw_nomcab.GetRow(),'Estado') = '1' then
	long fila, ncargo, item, num_nomina, i
	double valor
	string tipodoc, documento, cod_concep
	for i = 1 to dw_nov.RowCount()
		num_nomina = dw_nov.GetItemNumber(i,'num_nomina')
		tipodoc = dw_nov.GetItemString(i,'tipodoc')
		documento = dw_nov.GetItemString(i,'documento')
		ncargo = dw_nov.GetItemNumber(i,'ncargo')
		item = dw_nov.GetItemNumber(i,'item')
		cod_concep = dw_nov.GetItemString(i,'cod_concep')
		if dw_nov.GetItemString(i,'cod_tipo_concep') = '8' then
			Delete from nom_ahorro_cp where num_nomina=:num_nomina and tipodoc=:tipodoc and documento=:documento and
			ncargo=:ncargo and cod_concep=:cod_concep and item=:item; 
			IF SQLCA.SQLCode = -1 THEN
				msg = SQLCA.SQLErrText
				Rollback;
				MessageBox("SQL error", msg)
				Return -1
			END IF
		end if

	
		Delete from nom_ausentismo_Det where num_nomina=:num_nomina and tipodoc=:tipodoc and documento=:documento and
		ncargo=:ncargo and cod_concep=:cod_concep and item_n=:item; 
		IF SQLCA.SQLCode = -1 THEN
			msg = SQLCA.SQLErrText
			Rollback;
			MessageBox("SQL error ausen_det", msg)
			Return -1
		END IF

		if dw_nov.GetItemString(i,'cod_tipo_concep') = '7' then
			update nom_coope_plan_cp set num_nomina=0,tipodoc=NULL, documento=NULL, 
			cod_concep=NULL, ncargo=NULL, item=NULL, estado = '0'
			where num_nomina=:num_nomina and tipodoc=:tipodoc and documento=:documento and
			ncargo=:ncargo and cod_concep=:cod_concep and item=:item;
			IF SQLCA.SQLCode = -1 THEN
				msg = SQLCA.SQLErrText
				Rollback;
				MessageBox("SQL error", msg)
				Return -1
			END IF
		end if
	Next
	num_nomina = tab_n.tpn_1.dw_nomcab.getItemNumber(tab_n.tpn_1.dw_nomcab.GetRow(),'num_nomina')
	update contra_f_pago set num_nomina = NULL
	where num_nomina = :num_nomina;
	IF SQLCA.SQLCode = -1 THEN
		msg = SQLCA.SQLErrText
		Rollback;
		MessageBox("SQL error", msg)
		Return -1
	END IF
	update nom_tsup set num_nomina=NULL,tipodoc_nom=NULL,documento_nom=NULL,cod_concep_nom=NULL,item_nom=NULL
	where num_nomina = :num_nomina;
	IF SQLCA.SQLCode = -1 THEN
		msg = SQLCA.SQLErrText
		Rollback;
		MessageBox("SQL error", msg)
		Return -1
	END IF
end if

setnull(i)
tab_n.tpn_1.dw_nomcab.SetItem(tab_n.tpn_1.dw_nomcab.GetRow(),'Estado','2')
tab_n.tpn_1.dw_nomcab.SetItem(tab_n.tpn_1.dw_nomcab.GetRow(),'nomina_retro',i)
tab_n.tpn_1.dw_nomcab.SetItem(tab_n.tpn_1.dw_nomcab.GetRow(),'retro','0')
tab_n.tpn_1.dw_nomcab.SetItem(tab_n.tpn_1.dw_nomcab.GetRow(),'usuario',usuario)
tab_n.tpn_1.dw_nomcab.SetItem(tab_n.tpn_1.dw_nomcab.GetRow(),'fecha_anulada',today())
if tab_n.tpn_1.dw_nomcab.Update() = 1 then
	commit;
else
	rollback;
end if

end event

type pb_cancelar from picturebutton within w_nomina
event mousemove pbm_mousemove
string tag = "&Cancelar"
integer x = 3968
integer y = 152
integer width = 146
integer height = 128
integer taborder = 220
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "                $c"
boolean originalsize = true
string picturename = "cancelar.GIF"
string disabledname = "d_cancelar.GIF"
string powertiptext = "&Cancelar"
end type

event clicked;Close(parent)
end event

type pb_2 from picturebutton within w_nomina
event mousemove pbm_mousemove
string tag = "Guardar Temporal"
integer x = 3968
integer y = 416
integer width = 146
integer height = 128
integer taborder = 240
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "                $a"
boolean originalsize = true
string picturename = "guardar.gif"
string disabledname = "d_guardar.gif"
string powertiptext = "Guardar Temporal"
end type

event clicked;if tab_n.tpn_1.dw_nomcab.RowCount() = 0 then Return
if tab_n.tpn_1.dw_nomcab.GetItemString(tab_n.tpn_1.dw_nomcab.GetRow(),'Estado') <> '0' then
	messageBox('Aviso','El documento ya ha sido cerrado. No puede modificarse')
	Return
end if
grabar('temporal')

end event

type cb_1 from commandbutton within w_nomina
boolean visible = false
integer x = 4768
integer y = 28
integer width = 288
integer height = 100
integer taborder = 280
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Evalua fmla"
end type

event clicked;string ret,fila

fila = sle_fila.Text

//string dwSyntax;
//dwSyntax = dw_historia.Describe("datawindow.syntax");	
traduceFmla(mle_1.Text,mle_1.Text,'EN')
ret = dw_historia.Describe("Evaluate('"+mle_1.Text+"',"+fila+")")
messageBox('Resultado Formula',ret)

end event

type cbx_1 from checkbox within w_nomina
integer x = 3314
integer y = 832
integer width = 608
integer height = 64
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 67108864
string text = "Chequear Horas extras"
end type

type hpb_1 from hprogressbar within w_nomina
boolean visible = false
integer x = 41
integer y = 844
integer width = 2597
integer height = 52
unsignedinteger maxposition = 100
unsignedinteger position = 50
integer setstep = 1
end type

type dw_apemp from datawindow within w_nomina
boolean visible = false
integer x = 2176
integer y = 2128
integer width = 1047
integer height = 96
integer taborder = 290
boolean bringtotop = true
boolean enabled = false
string title = "none"
string dataobject = "dw_clase_ter_all"
boolean hscrollbar = true
boolean vscrollbar = true
boolean resizable = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;setTransObject(SQLCA)

end event

type sle_fila from singlelineedit within w_nomina
boolean visible = false
integer x = 4645
integer y = 28
integer width = 105
integer height = 100
integer taborder = 260
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
string text = "1"
borderstyle borderstyle = stylelowered!
end type

type tab_1 from tab within w_nomina
event resize ( integer ai_width,  integer ai_height )
integer x = 37
integer y = 912
integer width = 5664
integer height = 1220
integer taborder = 200
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 67108864
boolean fixedwidth = true
boolean focusonbuttondown = true
boolean powertips = true
boolean boldselectedtext = true
alignment alignment = center!
integer selectedtab = 1
p_1 p_1
p_2 p_2
p_5 p_5
p_7 p_7
p_3 p_3
p_4 p_4
p8 p8
p_6 p_6
end type

event resize(integer ai_width, integer ai_height);resize(ai_width - 70 , ai_height - 70)

p_1.dw_devenga.resize(ai_width*0.477 , ai_height -350 )
p_1.st_6.y=p_1.dw_devenga.height + 80
p_1.sle_3.y=p_1.st_6.y
p_1.dw_deduce.x=p_1.dw_devenga.x + p_1.dw_devenga.width + 30
p_1.st_2.x=p_1.dw_deduce.x
p_1.dw_deduce.resize( ai_width - p_1.dw_devenga.width -120, p_1.dw_devenga.height +50)


p_2.dw_novedad.resize(ai_width -390 , ai_height - 450 )
p_2.pb_addnov.x=p_2.dw_novedad.x+p_2.dw_novedad.width + 20
p_2.pb_borranov.x=p_2.pb_addnov.x
p_2.pb_3.x=p_2.pb_addnov.x
p_2.st_7.y=p_2.dw_novedad.y + p_2.dw_novedad.height + 20
p_2.em_1.y=p_2.st_7.y

p_5.dw_ap.resize(ai_width - 220 , ai_height -300)

p_7.dw_2.resize(ai_width - 220 , ai_height -300)

p_3.dw_presta.resize(p_1.dw_devenga.width , ai_height * 0.5 )
p_3.st_4.y=p_3.dw_presta.y + p_3.dw_presta.height + 20
p_3.dw_plan.y=p_3.st_4.y + p_3.st_4.height + 8
p_3.dw_plan.resize(p_1.dw_devenga.width , ai_height - p_3.dw_plan.y -210)
p_3.dw_cuotas.x=p_3.dw_presta.x + p_3.dw_presta.width +30
p_3.dw_cuotas.width=p_3.dw_presta.width - 180
p_3.dw_cuotas.height=ai_height -290
p_3.pb_1.x=p_3.dw_cuotas.x + p_3.dw_cuotas.width + 20

p_4.dw_acab.resize(ai_width - 200 , ai_height * 0.4)
p_4.st_8.y=p_4.dw_acab.y + p_4.dw_acab.height +20
p_4.dw_acpo.y=p_4.st_8.y + p_4.st_8.height +10
p_4.dw_acpo.resize(p_4.dw_acab.width , ai_height - p_4.dw_acpo.y -220)

p8.dw_electronica.resize(ai_width - 380 , ai_height - 270 )
p8.pb_dian.x=p8.dw_electronica.x + p8.dw_electronica.width +30

p_6.dw_im.resize( ai_width - 1100 , ai_height - 300)
p_6.pb_import.x= p_6.dw_im.x + p_6.dw_im.width + 80
p_6.st_13.x=p_6.pb_import.x
p_6.pb_7.x=p_6.pb_import.x + p_6.pb_import.width + 30
p_6.pb_8.x=p_6.pb_7.x + p_6.pb_7.width +30
end event

on tab_1.create
this.p_1=create p_1
this.p_2=create p_2
this.p_5=create p_5
this.p_7=create p_7
this.p_3=create p_3
this.p_4=create p_4
this.p8=create p8
this.p_6=create p_6
this.Control[]={this.p_1,&
this.p_2,&
this.p_5,&
this.p_7,&
this.p_3,&
this.p_4,&
this.p8,&
this.p_6}
end on

on tab_1.destroy
destroy(this.p_1)
destroy(this.p_2)
destroy(this.p_5)
destroy(this.p_7)
destroy(this.p_3)
destroy(this.p_4)
destroy(this.p8)
destroy(this.p_6)
end on

type p_1 from userobject within tab_1
integer x = 18
integer y = 112
integer width = 5627
integer height = 1092
long backcolor = 67108864
string text = "Conceptos"
long tabtextcolor = 33554432
string picturename = "conceptos.ico"
long picturemaskcolor = 536870912
sle_3 sle_3
sle_2 sle_2
sle_1 sle_1
st_2 st_2
st_1 st_1
dw_devenga dw_devenga
dw_deduce dw_deduce
st_6 st_6
end type

on p_1.create
this.sle_3=create sle_3
this.sle_2=create sle_2
this.sle_1=create sle_1
this.st_2=create st_2
this.st_1=create st_1
this.dw_devenga=create dw_devenga
this.dw_deduce=create dw_deduce
this.st_6=create st_6
this.Control[]={this.sle_3,&
this.sle_2,&
this.sle_1,&
this.st_2,&
this.st_1,&
this.dw_devenga,&
this.dw_deduce,&
this.st_6}
end on

on p_1.destroy
destroy(this.sle_3)
destroy(this.sle_2)
destroy(this.sle_1)
destroy(this.st_2)
destroy(this.st_1)
destroy(this.dw_devenga)
destroy(this.dw_deduce)
destroy(this.st_6)
end on

type sle_3 from editmask within p_1
integer x = 411
integer y = 1004
integer width = 485
integer height = 72
integer taborder = 80
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
string text = "none"
alignment alignment = right!
boolean displayonly = true
borderstyle borderstyle = stylelowered!
string mask = "###,###.00"
end type

type sle_2 from editmask within p_1
boolean visible = false
integer x = 1792
integer y = 4
integer width = 471
integer height = 72
integer taborder = 80
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
string text = "none"
alignment alignment = right!
boolean displayonly = true
borderstyle borderstyle = stylelowered!
end type

type sle_1 from editmask within p_1
boolean visible = false
integer x = 430
integer y = 84
integer width = 485
integer height = 72
integer taborder = 70
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
string text = "none"
alignment alignment = right!
boolean displayonly = true
borderstyle borderstyle = stylelowered!
end type

type st_2 from statictext within p_1
integer x = 2318
integer y = 12
integer width = 334
integer height = 64
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 67108864
string text = "Deducido"
boolean focusrectangle = false
end type

type st_1 from statictext within p_1
integer x = 46
integer y = 8
integer width = 402
integer height = 64
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 67108864
string text = "Devengado"
boolean focusrectangle = false
end type

type dw_devenga from datawindow within p_1
integer x = 46
integer y = 72
integer width = 2103
integer height = 904
integer taborder = 30
boolean bringtotop = true
string title = "none"
string dataobject = "dw_devenga"
boolean hscrollbar = true
boolean vscrollbar = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event itemchanged;
if this.GetColumnName() = 'selec' then
	if data = '0' then
		this.SetItem(row,'pagado',0)
	else
		this.SetItem(row,'pagado',this.GetItemNumber(row,'valor_c'))
	end if
end if
if this.AcceptText() = -1 then Return
cambio = TRUE
calctotal()

end event

event sqlpreview;string tipo

if sqltype = PreviewSelect! then
	tipo = 'Select'
	operacion = ''
elseif sqltype = PreviewInsert! then
	tipo = 'Insert'
elseif sqltype = PreviewDelete! then
	tipo = 'Delete'
elseif sqltype = PreviewUpdate! then
	tipo = 'Update'
end if

if operacion = 'Delete' then
	if tipo = 'Delete' then
		Return 0
	else
		Return 2
	end if
elseif operacion = 'Insert' then
	if tipo = 'Insert' or tipo = 'Update' then
		Return 0
	else
		Return 2
	end if
end if

end event

event dberror;Rollback;
Return 0

end event

type dw_deduce from datawindow within p_1
integer x = 2309
integer y = 72
integer width = 3296
integer height = 1000
integer taborder = 40
boolean bringtotop = true
string title = "none"
string dataobject = "dw_deduce"
boolean hscrollbar = true
boolean vscrollbar = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event itemchanged;if this.GetColumnName() = 'selec' then
	if data = '0' then
		this.SetItem(row,'pagado',0)
	else
		this.SetItem(row,'pagado',this.GetItemNumber(row,'valor_c'))
	end if
end if
if this.AcceptText() = -1 then Return
cambio = TRUE

calctotal()
end event

event sqlpreview;string tipo

if sqltype = PreviewSelect! then
	tipo = 'Select'
	operacion = ''
elseif sqltype = PreviewInsert! then
	tipo = 'Insert'
elseif sqltype = PreviewDelete! then
	tipo = 'Delete'
elseif sqltype = PreviewUpdate! then
	tipo = 'Update'
end if

if operacion = 'Delete' then
	if tipo = 'Delete' then
		Return 0
	else
		Return 2
	end if
elseif operacion = 'Insert' then
	if tipo = 'Insert' or tipo = 'Update' then
		Return 0
	else
		Return 2
	end if
end if

end event

event dberror;Rollback;
Return 0

end event

type st_6 from statictext within p_1
integer x = 59
integer y = 1012
integer width = 311
integer height = 60
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 67108864
string text = "Valor Neto:"
boolean focusrectangle = false
end type

type p_2 from userobject within tab_1
integer x = 18
integer y = 112
integer width = 5627
integer height = 1092
long backcolor = 67108864
string text = "Novedades"
long tabtextcolor = 33554432
string picturename = "asig_cita.ico"
long picturemaskcolor = 536870912
rb_nov rb_nov
gb_1 gb_1
cbx_cal cbx_cal
pb_3 pb_3
em_1 em_1
dw_emp dw_emp
pb_borranov pb_borranov
pb_addnov pb_addnov
rb_amb rb_amb
rb_ded rb_ded
rb_nin rb_nin
dw_novedad dw_novedad
st_7 st_7
end type

on p_2.create
this.rb_nov=create rb_nov
this.gb_1=create gb_1
this.cbx_cal=create cbx_cal
this.pb_3=create pb_3
this.em_1=create em_1
this.dw_emp=create dw_emp
this.pb_borranov=create pb_borranov
this.pb_addnov=create pb_addnov
this.rb_amb=create rb_amb
this.rb_ded=create rb_ded
this.rb_nin=create rb_nin
this.dw_novedad=create dw_novedad
this.st_7=create st_7
this.Control[]={this.rb_nov,&
this.gb_1,&
this.cbx_cal,&
this.pb_3,&
this.em_1,&
this.dw_emp,&
this.pb_borranov,&
this.pb_addnov,&
this.rb_amb,&
this.rb_ded,&
this.rb_nin,&
this.dw_novedad,&
this.st_7}
end on

on p_2.destroy
destroy(this.rb_nov)
destroy(this.gb_1)
destroy(this.cbx_cal)
destroy(this.pb_3)
destroy(this.em_1)
destroy(this.dw_emp)
destroy(this.pb_borranov)
destroy(this.pb_addnov)
destroy(this.rb_amb)
destroy(this.rb_ded)
destroy(this.rb_nin)
destroy(this.dw_novedad)
destroy(this.st_7)
end on

type rb_nov from radiobutton within p_2
integer x = 4905
integer y = 56
integer width = 393
integer height = 56
integer textsize = -7
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Small Fonts"
long textcolor = 33554432
long backcolor = 67108864
string text = "Novedad"
boolean automatic = false
end type

event clicked;rb_nin.checked=false
rb_ded.checked=false
rb_amb.checked=false
rb_nov.checked=true
end event

type gb_1 from groupbox within p_2
integer x = 3337
integer y = 20
integer width = 2066
integer height = 108
integer taborder = 50
integer textsize = -5
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Small Fonts"
long textcolor = 33554432
long backcolor = 67108864
string text = "RECALCULAR"
borderstyle borderstyle = styleraised!
end type

type cbx_cal from checkbox within p_2
boolean visible = false
integer x = 2368
integer y = 32
integer width = 759
integer height = 72
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 67108864
string text = "Recalcular devengados y deducidos"
boolean checked = true
end type

type pb_3 from picturebutton within p_2
event mousemove pbm_mousemove
boolean visible = false
integer x = 5449
integer y = 416
integer width = 146
integer height = 128
integer taborder = 5
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
boolean enabled = false
string text = "                $r"
boolean originalsize = true
string picturename = "editar.GIF"
string disabledname = "d_editar.GIF"
string powertiptext = "&Recalcular Nómina para empleado Activo"
end type

event clicked;long i, filahist
decimal cantidad
string tipo

if tab_n.tpn_2.dw_empnom.RowCount() = 0 then Return
if tab_n.tpn_1.dw_nomcab.GetItemString(tab_n.tpn_1.dw_nomcab.GetRow(),'estado') <> '0' then Return

if tab_1.p_1.dw_devenga.RowCount() > 0 then
	do while tab_1.p_1.dw_devenga.RowCount() > 0
		tab_1.p_1.dw_devenga.DeleteRow(1)
	loop
end if
if tab_1.p_1.dw_deduce.RowCount() > 0 then
	do while tab_1.p_1.dw_deduce.RowCount() > 0
		tab_1.p_1.dw_deduce.DeleteRow(1)
	loop
end if
if tab_1.p_2.dw_novedad.RowCount() > 0 then
	tab_1.p_2.dw_novedad.SetFilter("tipodoc='"+tab_n.tpn_2.dw_empnom.GetItemString(tab_n.tpn_2.dw_empnom.GetRow(),'tipodoc')+"' and documento='"+tab_n.tpn_2.dw_empnom.GetItemString(tab_n.tpn_2.dw_empnom.GetRow(),'documento')+"' and (cod_tipo_concep='7' or cod_tipo_concep='8')")
	tab_1.p_2.dw_novedad.Filter()
	int l_i,li_fila
	string ls_nm,ls_filtro
	do while tab_1.p_2.dw_novedad.RowCount() > 0
		li_fila=tab_1.p_2.dw_novedad.GetRow()
		ls_filtro="num_nomina="+string(tab_1.p_2.dw_novedad.getitemnumber(li_fila,'num_nomina'))+' and '
		ls_filtro=ls_filtro+"tipodoc_n='"+tab_1.p_2.dw_novedad.getitemstring(li_fila,'tipodoc')+"' and "
		ls_filtro=ls_filtro+"documento_n='"+tab_1.p_2.dw_novedad.getitemstring(li_fila,'documento')+"' and "
		ls_filtro=ls_filtro+"cod_concep='"+tab_1.p_2.dw_novedad.getitemstring(li_fila,'cod_concep')+"' and "
		ls_filtro=ls_filtro+"item_n="+string(tab_1.p_2.dw_novedad.getitemnumber(li_fila,'item'))
		dw_ausend.setfilter(ls_filtro)
		dw_ausend.filter()
		for l_i=1 to dw_ausend.rowcount()
			dw_ausend.DeleteRow(1)
		next
		tab_1.p_2.dw_novedad.DeleteRow(1)
	loop
	tab_1.p_2.dw_novedad.SetFilter("tipodoc='"+tab_n.tpn_2.dw_empnom.GetItemString(tab_n.tpn_2.dw_empnom.GetRow(),'tipodoc')+"' and documento='"+tab_n.tpn_2.dw_empnom.GetItemString(tab_n.tpn_2.dw_empnom.GetRow(),'documento')+"'")
	tab_1.p_2.dw_novedad.Filter()
end if
if tab_1.p_5.dw_ap.RowCount() > 0 then
	do while tab_1.p_5.dw_ap.RowCount() > 0
		tab_1.p_5.dw_ap.DeleteRow(1)
	loop
end if

if tab_n.tpn_2.dw_empnom.GetItemNumber(tab_n.tpn_2.dw_empnom.GetRow(),'sel') = 1 then
	if nomcalc(tab_n.tpn_2.dw_empnom.GetItemString(tab_n.tpn_2.dw_empnom.GetRow(),'tipodoc'), tab_n.tpn_2.dw_empnom.GetItemString(tab_n.tpn_2.dw_empnom.GetRow(),'documento'),tab_n.tpn_1.dw_nomcab.getitemstring(tab_n.tpn_1.dw_nomcab.getrow(),'esp'),tab_n.tpn_1.dw_nomcab.getitemstring(tab_n.tpn_1.dw_nomcab.getrow(),'tipo')) < 0 then
		Return
	end if
end if

filahist = dw_historia.Find("cargo_estado = '1'",1,dw_historia.RowCount())
for i = 1 to tab_1.p_2.dw_novedad.RowCount()
	if not (tab_1.p_2.dw_novedad.GetItemString(i,'cod_tipo_concep') = '7' or tab_1.p_2.dw_novedad.GetItemString(i,'cod_tipo_concep') = '8') then 
		f_addcompute( tab_1.p_2.dw_novedad.GetItemString(i,'sigla'), tab_1.p_2.dw_novedad.GetItemString(i,'form_calculo'), tab_1.p_2.dw_novedad.GetItemString(i,'form_verifica'), tab_1.p_2.dw_novedad.GetItemnumber(i,'tarifa'), tab_1.p_2.dw_novedad.GetItemnumber(i,'tarifa_esp'),1)
	end if
next

for i = 1 to tab_1.p_2.dw_novedad.RowCount()
	if not (tab_1.p_2.dw_novedad.GetItemString(i,'cod_tipo_concep') = '7' or tab_1.p_2.dw_novedad.GetItemString(i,'cod_tipo_concep') = '8') then 
		dw_historia.SetItem(filahist,get_parm_nov(dw_novedad.GetItemString(i,'sigla')),tab_1.p_2.dw_novedad.GetItemNumber(i,'cantidad_ac'))
		cantidad = round(dw_historia.GetItemNumber(filahist,tab_1.p_2.dw_novedad.GetItemString(i,'sigla')),0)
		if not isNull(cantidad) then
			tab_1.p_2.dw_novedad.SetItem(i,'valor_c',cantidad)
		end if
	end if
next

calctotal()
tab_1.p_3.dw_plan.TriggerEvent(rowfocuschanged!)
tab_1.p_4.dw_acab.TriggerEvent(rowfocuschanged!)

end event

type em_1 from editmask within p_2
integer x = 553
integer y = 976
integer width = 526
integer height = 72
integer taborder = 60
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
string text = "none"
boolean displayonly = true
borderstyle borderstyle = stylelowered!
string mask = "###,###.00"
end type

type dw_emp from datawindow within p_2
integer x = 32
integer y = 28
integer width = 2162
integer height = 120
integer taborder = 1
string title = "none"
string dataobject = "dw_regla_gen_empleado"
boolean border = false
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event itemchanged;long fila
string tipodoc, documento
if this.AcceptText() = -1 then Return
if isNull(this.GetItemString(1,'documento')) or this.GetItemString(1,'documento') = '' then Return

tipodoc = this.GetItemString(1,'tipodoc')
documento = this.GetItemString(1,'documento')
if this.Retrieve(this.GetItemString(1,'tipodoc'), documento) < 1 then
	this.InsertRow(0)
	this.SetItem(1,'tipodoc',tipodoc)
	this.SetItem(1,'documento',documento)
else
	fila = tab_n.tpn_2.dw_empnom.Find("tipodoc='" + dw_emp.GetItemString(1,'tipodoc') + "' and documento='" + dw_emp.GetItemString(1,'documento') + "'",1,tab_n.tpn_2.dw_empnom.RowCount())
	if fila > 0 then
		tab_n.tpn_2.dw_empnom.ScrolltoRow(fila)
	else
		MessageBox('Atención','El empleado no está relacionado en el documento')
		setNull(Documento)
		this.SetItem(1,'documento',documento)
		this.SetItem(1,'nombre1',documento)
	end if
end if

end event

type pb_borranov from picturebutton within p_2
event mousemove pbm_mousemove
string tag = "&Borrar Novedad"
integer x = 5449
integer y = 284
integer width = 146
integer height = 128
integer taborder = 4
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "                $b"
string picturename = "borrar_fila.gif"
string disabledname = "d_borrar_fila.gif"
string powertiptext = "&Borrar Novedad"
end type

event clicked;int l_i,li_fila
string ls_nm,ls_filtro
if tab_n.tpn_1.dw_nomcab.GetItemString(tab_n.tpn_1.dw_nomcab.GetRow(),'Estado') <> '0' then
	messageBox('Aviso','El documento ya ha sido cerrado. No puede modificarse')
	Return
end if
li_fila=dw_novedad.GetRow()
if not isnull(string(dw_novedad.getitemnumber(li_fila,'num_nomina'))) then
	ls_filtro="num_nomina="+string(dw_novedad.getitemnumber(li_fila,'num_nomina'))+' and '
end if
ls_filtro=ls_filtro+"tipodoc_n='"+dw_novedad.getitemstring(li_fila,'tipodoc')+"' and "
ls_filtro=ls_filtro+"documento_n='"+dw_novedad.getitemstring(li_fila,'documento')+"' and "
ls_filtro=ls_filtro+"cod_concep='"+dw_novedad.getitemstring(li_fila,'cod_concep')+"' and "
ls_filtro=ls_filtro+"item_n="+string(dw_novedad.getitemnumber(li_fila,'item'))
if not isnull(ls_filtro) then
	dw_ausend.setfilter(ls_filtro)
	dw_ausend.filter()
	for l_i=dw_ausend.rowcount() to 1 step -1
		dw_ausend.DeleteRow(l_i)
	next
	dw_ausend.setfilter('')
	dw_ausend.filter()
end if
dw_novedad.DeleteRow(li_fila)
f_retrieveend()
if recalcula(tab_n.tpn_2.dw_empnom.getItemString(tab_n.tpn_2.dw_empnom.getRow(), 'tipodoc'), tab_n.tpn_2.dw_empnom.getItemString(tab_n.tpn_2.dw_empnom.getRow(), 'documento') ) = -1 then
	MessageBox('Atención','Error reevaluando conceptos')
	Return -1
end if
cambio = TRUE

end event

type pb_addnov from picturebutton within p_2
event mousemove pbm_mousemove
string tag = "A&dicionar Novedad"
integer x = 5449
integer y = 152
integer width = 146
integer height = 128
integer taborder = 3
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
boolean originalsize = true
string picturename = "insertar.gif"
string disabledname = "d_insertar.gif"
string powertiptext = "A&dicionar Novedad"
end type

event clicked;long ldb_filanov

 ldb_filanov=f_addnovedad()
 if ldb_filanov=-1 then return -1
 return  ldb_filanov


end event

type rb_amb from radiobutton within p_2
integer x = 3840
integer y = 60
integer width = 571
integer height = 56
boolean bringtotop = true
integer textsize = -7
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Small Fonts"
long textcolor = 33554432
long backcolor = 67108864
string text = "Devengados / Deducidos"
boolean checked = true
end type

event clicked;rb_nin.checked=false
rb_ded.checked=false
rb_amb.checked=true
end event

type rb_ded from radiobutton within p_2
integer x = 4498
integer y = 60
integer width = 343
integer height = 52
boolean bringtotop = true
integer textsize = -7
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Small Fonts"
string pointer = "Arrow!"
long textcolor = 33554432
long backcolor = 67108864
string text = "Deducidos"
end type

event clicked;rb_nin.checked=false
rb_ded.checked=true
rb_amb.checked=false

end event

type rb_nin from radiobutton within p_2
integer x = 3483
integer y = 60
integer width = 320
integer height = 52
boolean bringtotop = true
integer textsize = -7
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Small Fonts"
string pointer = "Arrow!"
long textcolor = 33554432
long backcolor = 67108864
string text = "Ninguno"
end type

event clicked;rb_nin.checked=true
rb_ded.checked=false
rb_amb.checked=false
end event

type dw_novedad from datawindow within p_2
integer x = 37
integer y = 160
integer width = 5358
integer height = 784
integer taborder = 2
string title = "none"
string dataobject = "dw_novedades"
boolean hscrollbar = true
boolean vscrollbar = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event itemchanged;long i, ldb_filaitc, ldb_filahistic, parm, l_p, fc
double cantidad,ld_ahorro,ld_tar
decimal ln_calculado,ln_base
string vnula,conp,ls_td,ls_doc
Date f_ini, f_fin

setNull(vnula)
setNull(cantidad)

ls_td = tab_n.tpn_2.dw_empnom.GetItemString(tab_n.tpn_2.dw_empnom.GetRow(),'tipodoc')
ls_doc = tab_n.tpn_2.dw_empnom.GetItemString(tab_n.tpn_2.dw_empnom.GetRow(),'documento')
f_ini = date(tab_n.tpn_1.dw_nomcab.getItemDateTime(tab_n.tpn_1.dw_nomcab.getRow(), 'inicia'))
f_fin = date(tab_n.tpn_1.dw_nomcab.getItemDateTime(tab_n.tpn_1.dw_nomcab.getRow(), 'termina'))
l_nesp = tab_n.tpn_1.dw_nomcab.GetItemstring(tab_n.tpn_1.dw_nomcab.GetRow(),'esp')

if not ibn_actualizado  then
	datos_empleado(ls_td, ls_doc)
end if

ldb_filahistic = dw_historia.Find("diasvinculado > 0",1,dw_historia.RowCount())
if ldb_filahistic =0 and dw_historia.RowCount()>0 then ldb_filahistic =1

if this.GetColumnName() = 'sigla'  or lower(dwo.name)= 'sigla' then
	if isNull(dwo) then
		if Not isNull(GetItemString(Getrow(),'cod_concep')) then
			ldb_filaitc = dwc_novedad.Find("cod_concep='"+GetItemString(Getrow(),'cod_concep')+"'",1,dwc_novedad.RowCount())
			if ldb_filaitc > 0 then dwc_novedad.ScrolltoRow(ldb_filaitc)
		end if
	else
		if Not isNull(GetItemString(Getrow(),'cod_concep')) then
			ldb_filaitc = dwc_novedad.Find("cod_concep='"+GetItemString(Getrow(),'cod_concep')+"'",1,dwc_novedad.RowCount())
			if ldb_filaitc > 0 then dwc_novedad.ScrolltoRow(ldb_filaitc)
		end if
	end if
	for i = 1 to this.RowCount()
		if i <> row then
			if this.GetItemString(i,'sigla') = data then
				messageBox('Error','La novedad seleccionada ya ha sido agregada')
				this.SetItem(row,'cod_concep',vnula)
				this.SetItem(row,'sigla',vnula)
				this.SetItem(row,'des_concep',vnula)
				this.SetItem(row,'tipo',vnula)
				Return
			end if
		end if
	Next
	this.SetItem(this.GetRow(),'des_concep',dwc_novedad.GetItemString(dwc_novedad.GetRow(),'des_concep'))
	this.SetItem(this.GetRow(),'tipo',dwc_novedad.GetItemString(dwc_novedad.GetRow(),'tipo'))
	this.SetItem(this.GetRow(),'cod_tipo_concep',dwc_novedad.GetItemString(dwc_novedad.GetRow(),'cod_tipo_concep'))
	this.SetItem(this.GetRow(),'cod_concep',dwc_novedad.GetItemString(dwc_novedad.GetRow(),'cod_concep'))
	this.SetItem(this.GetRow(),'form_calculo',dwc_novedad.GetItemString(dwc_novedad.GetRow(),'form_calculo'))
	this.SetItem(this.GetRow(),'form_verifica',dwc_novedad.GetItemString(dwc_novedad.GetRow(),'form_verifica'))
	this.SetItem(this.GetRow(),'umed',dwc_novedad.GetItemString(dwc_novedad.GetRow(),'umed'))
	if dwc_novedad.GetItemString(dwc_novedad.GetRow(),'cod_tipo_concep')='8' then
		conp=dwc_novedad.GetItemString(dwc_novedad.GetRow(),'cod_concep')
		SELECT num_ahorro,porcensal into :ld_ahorro,:ld_tar
		FROM nom_ahorro
		WHERE (((nom_ahorro.cod_concep)=:conp) AND ((nom_ahorro.tipo_doc)=:ls_td) AND ((nom_ahorro.empleado)=:ls_doc) AND ((nom_ahorro.estado)='1'));
	end if
	AcceptText()
	if ld_tar=0 then
		if f_addcompute(dwc_novedad.GetItemString(dwc_novedad.GetRow(),'sigla'), dwc_novedad.GetItemString(dwc_novedad.GetRow(),'form_calculo'), dwc_novedad.GetItemString(dwc_novedad.GetRow(),'form_verifica'), dwc_novedad.GetItemnumber(dwc_novedad.GetRow(),'tarifa'), dwc_novedad.GetItemnumber(dwc_novedad.GetRow(),'tarifa_esp'),1) = -1 then Return -1
	else
		if f_addcompute(dwc_novedad.GetItemString(dwc_novedad.GetRow(),'sigla'), dwc_novedad.GetItemString(dwc_novedad.GetRow(),'form_calculo'), dwc_novedad.GetItemString(dwc_novedad.GetRow(),'form_verifica'), ld_tar, dwc_novedad.GetItemnumber(dwc_novedad.GetRow(),'tarifa_esp'),1) = -1 then Return -1
	end if
	if ldb_filahistic >0 then
		cantidad = this.GetItemNumber(this.GetRow(),'cantidad_ac')
		if not isNull(cantidad) then
			dw_historia.SetItem(ldb_filahistic,get_parm_nov(GetItemString(GetRow(),'sigla')),cantidad)
		else
			dw_historia.SetItem(ldb_filahistic,f_get_ctrl(GetItemString(GetRow(),'sigla')),1)
		end if
	end if
	if not isNull(cantidad) then
		this.SetItem(this.GetRow(),'valor_c',round(cantidad,0))
		this.SetItem(this.GetRow(),'pagado',round(cantidad,0))
		if round(cantidad,0)>1 then this.SetItem(this.GetRow(),'base',round(cantidad,0))		
		if GetItemString(GetRow(),'tipo') <> 'L' then 
			ibn_calculando = true
			f_retrieveend()
			if recalcula(tab_n.tpn_2.dw_empnom.GetItemString(tab_n.tpn_2.dw_empnom.GetRow(),'tipodoc'), tab_n.tpn_2.dw_empnom.GetItemString(tab_n.tpn_2.dw_empnom.GetRow(),'documento')) = -1 then
				MessageBox('Atención','Error reevaluando conceptos')
				ibn_calculando = false
				Return -1
			end if
			ibn_calculando = false
		end if
	end if
	if dwc_novedad.GetItemString(dwc_novedad.GetRow(),'tercero')='2' then
		datos_apemp(ls_td, ls_doc, dwc_novedad.GetItemString(dwc_novedad.GetRow(),'cod_tipo_concep'))
		for l_p = 1 to dw_apemp.RowCount()
			this.SetItem(GetRow(), 'tipodoc_clase', dw_apemp.GetItemString(l_p,'tipodoc'))
			this.SetItem(GetRow(), 'documento_clase', dw_apemp.GetItemString(l_p,'documento'))
			this.SetItem(GetRow(), 'cod_clase', dw_apemp.GetItemString(l_p,'cod_clase'))
			this.SetItem(GetRow(), 'item_clase', dw_apemp.GetItemNumber(l_p,'item'))
		next
	end if
end if

if this.GetColumnName() = 'cantidad_ac' or lower(dwo.name)= 'cantidad_ac' then
	if AcceptText() = -1 then Return -1
	ibn_calculando = true
	f_retrieveEnd()
	ldb_filahistic = dw_historia.Find("diasvinculado > 0",1,dw_historia.RowCount())
	if ldb_filahistic =0 and dw_historia.RowCount()>0 then ldb_filahistic =1
	ibn_calculando = false
	if ldb_filahistic = 0 and GetItemString(GetRow(),'tipo') ='L' and dw_historia.RowCount() > 0 then 
		ldb_filahistic = 1
		dw_novedad.SetItem(GetRow(),'ncargo',dw_historia.GetItemNumber(ldb_filahistic,'ncargo'))
		dw_novedad.SetItem(GetRow(),'nsalario',dw_historia.GetItemNumber(ldb_filahistic,'nsalario'))
		dw_novedad.SetItem(GetRow(),'ntraslado',dw_historia.GetItemNumber(ldb_filahistic,'ntraslado'))
	end if
	if ldb_filahistic > 0 and not isNull(this.GetItemString(this.GetRow(),'cod_concep')) then
		dw_historia.SetItem(ldb_filahistic,get_parm_nov(GetItemString(GetRow(),'sigla')),GetItemNumber(Getrow(),'cantidad_ac'))
		ldb_filaitc = dwc_novedad.Find("cod_concep='" + this.GetItemString(this.GetRow(),'cod_concep') +"'",1,dwc_novedad.RowCount())
 		if dw_historia.Describe(GetItemString(GetRow(),'sigla') + '.Coltype') = "!" then
			if f_addcompute( GetItemString(GetRow(),'sigla'), GetItemString(GetRow(),'form_calculo') ,GetItemString(GetRow(),'form_verifica'), GetItemnumber(GetRow(),'tarifa'), GetItemnumber(GetRow(),'tarifa_esp'),1) = -1 then  Return
		end if

		dw_historia.SetItem(ldb_filahistic, f_get_ctrl(GetItemString(this.GetRow(),'sigla')),1)
		ln_calculado=round(dw_historia.GetItemNumber(ldb_filahistic,GetItemString(this.GetRow(),'sigla')),0)
		this.SetItem(this.GetRow(),'valor_c',ln_calculado)
		this.SetItem(this.GetRow(),'pagado',ln_calculado)
		if dw_historia.GetItemNumber(ldb_filahistic,'b_'+GetItemString(GetRow(),'sigla'))=1 then
			this.SetItem(this.GetRow(),'base',0)
		else
			this.SetItem(this.GetRow(),'base',round(dw_historia.GetItemNumber(ldb_filahistic,'b_'+GetItemString(GetRow(),'sigla')),0))		
		end if
		if GetItemString(GetRow(),'tipo') <> 'L' then 
			ibn_calculando = true
//			if recalcula( tab_n.tpn_2.dw_empnom.GetItemString(tab_n.tpn_2.dw_empnom.GetRow(),'tipodoc'),tab_n.tpn_2.dw_empnom.GetItemString(tab_n.tpn_2.dw_empnom.GetRow(),'documento') ) = -1 then
//				MessageBox('Atención','Error reevaluando conceptos')
//				ibn_calculando = false
//				Return -1
//			end if
		else
			for i = 1 to RowCount()
				if i = Getrow() then continue
				if dw_historia.Describe(GetItemString(i,'sigla') + '.Coltype') = "!" then
					if f_addcompute( GetItemString(i,'sigla'), GetItemString(i,'form_calculo'), GetItemString(i,'form_verifica'),GetItemnumber(i,'tarifa'),GetItemnumber(i,'tarifa_esp'),i) = -1 then  Return
					dw_historia.SetItem(ldb_filahistic, f_get_ctrl(GetItemString(i,'sigla')),1)
					dw_historia.SetItem(ldb_filahistic,get_parm_nov(GetItemString(i,'sigla')),GetItemNumber(i,'cantidad_ac'))
					ln_calculado=round(dw_historia.GetItemNumber(ldb_filahistic,GetItemString(i,'sigla')),0)
					
					this.SetItem(i,'valor_c',ln_calculado)
					this.SetItem(i,'pagado',ln_calculado)	
					if dw_historia.GetItemNumber(ldb_filahistic,'b_'+GetItemString(i,'sigla'))=1 then
						this.SetItem(i,'base',0)
					else
						ln_base=round(dw_historia.GetItemNumber(ldb_filahistic,'b_'+GetItemString(i,'sigla')),0)
						this.SetItem(i,'base',ln_base)
					end if
				end if	
			next
		end if
	end if
	ibn_calculando = false
end if

if this.GetColumnName() = 'pagado' then
	string ret
	if AcceptText() = -1 then Return -1
	ibn_calculando = true
	f_retrieveend()
	ldb_filahistic = dw_historia.Find("diasvinculado > 0",1,dw_historia.RowCount())
	if ldb_filahistic =0 and dw_historia.RowCount()>0 then ldb_filahistic =1
	ibn_calculando = false
	ldb_filahistic = dw_historia.Find("diasvinculado > 0",1,dw_historia.RowCount())
	if ldb_filahistic =0 and dw_historia.RowCount()>0 then ldb_filahistic =1
	if ldb_filahistic > 0 and not isNull(this.GetItemString(this.GetRow(),'cod_concep')) then
		// Agrega fórmula
		if dw_historia.Describe(ids_req.GetItemString(i,'sigla_req') + '.Coltype') = "!" then
			fc = dwc_novedad.Find("cod_concep='"+GetItemString(Getrow(),'cod_concep')+"'",1,dwc_novedad.RowCount())
			if f_addcompute( dwc_novedad.GetItemString(fc,'sigla'), dwc_novedad.GetItemString(fc,'form_calculo'), dwc_novedad.GetItemString(fc,'form_verifica'), dwc_novedad.GetItemnumber(fc,'tarifa'), dwc_novedad.GetItemnumber(fc,'tarifa_esp'),1) = -1 then  Return
		end if
	 	if round(dw_historia.GetItemNumber(ldb_filahistic,GetItemString(GetRow(),'sigla')),0) <> double(data) then
			ret = dw_historia.Modify(GetItemString(GetRow(),'sigla') + '.expression="'+data+' * if(salario_estado=~~"1~~",1,0) * ctr_'+GetItemString(GetRow(),'sigla')+'"')
		end if
		if GetItemString(GetRow(),'tipo') <> 'L' then 
			ibn_calculando = true
			if recalcula( tab_n.tpn_2.dw_empnom.GetItemString(tab_n.tpn_2.dw_empnom.GetRow(),'tipodoc'),tab_n.tpn_2.dw_empnom.GetItemString(tab_n.tpn_2.dw_empnom.GetRow(),'documento') ) = -1 then
				MessageBox('Atención','Error reevaluando conceptos')
				ibn_calculando = false
				Return -1
			end if
		end if
	end if
	ibn_calculando = false
end if
cambio = TRUE
calctotal()

end event

event sqlpreview;string tipo

if sqltype = PreviewSelect! then
	tipo = 'Select'
	operacion = ''
elseif sqltype = PreviewInsert! then
	tipo = 'Insert'
elseif sqltype = PreviewDelete! then
	tipo = 'Delete'
elseif sqltype = PreviewUpdate! then
	tipo = 'Update'
end if

if operacion = 'Delete' then
	if tipo = 'Delete' then
		Return 0
	else
		Return 2
	end if
elseif operacion = 'Insert' then
	if tipo = 'Insert' or tipo = 'Update' then
		Return 0
	else
		Return 2
	end if
end if

end event

event retrievestart;if dwc_novedad.RowCount() = 0 then
	dwc_novedad.InsertRow(0)
end if

end event

event dberror;Rollback;
Return 0

end event

type st_7 from statictext within p_2
integer x = 50
integer y = 976
integer width = 425
integer height = 76
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 67108864
string text = "Total Novedades"
boolean focusrectangle = false
end type

type p_5 from userobject within tab_1
integer x = 18
integer y = 112
integer width = 5627
integer height = 1092
long backcolor = 67108864
string text = "Aportes Patronales"
long tabtextcolor = 33554432
string picturename = "hospital.ico"
long picturemaskcolor = 536870912
dw_ap dw_ap
end type

on p_5.create
this.dw_ap=create dw_ap
this.Control[]={this.dw_ap}
end on

on p_5.destroy
destroy(this.dw_ap)
end on

type dw_ap from datawindow within p_5
integer x = 55
integer y = 60
integer width = 5504
integer height = 988
integer taborder = 21
string title = "none"
string dataobject = "dw_aportes"
boolean hscrollbar = true
boolean vscrollbar = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event sqlpreview;string tipo

if sqltype = PreviewSelect! then
	tipo = 'Select'
	operacion = ''
elseif sqltype = PreviewInsert! then
	tipo = 'Insert'
elseif sqltype = PreviewDelete! then
	tipo = 'Delete'
elseif sqltype = PreviewUpdate! then
	tipo = 'Update'
end if

if operacion = 'Delete' then
	if tipo = 'Delete' then
		Return 0
	else
		Return 2
	end if
elseif operacion = 'Insert' then
	if tipo = 'Insert' or tipo = 'Update' then
		Return 0
	else
		Return 2
	end if
end if

end event

event constructor;setTransObject(SQLCA)

end event

event dberror;Rollback;
Return 0

end event

event itemchanged;cambio = TRUE

end event

type p_7 from userobject within tab_1
integer x = 18
integer y = 112
integer width = 5627
integer height = 1092
long backcolor = 67108864
string text = "Retroactivo"
long tabtextcolor = 33554432
string picturename = "retroac.ico"
long picturemaskcolor = 536870912
dw_2 dw_2
end type

on p_7.create
this.dw_2=create dw_2
this.Control[]={this.dw_2}
end on

on p_7.destroy
destroy(this.dw_2)
end on

type dw_2 from datawindow within p_7
integer x = 55
integer y = 60
integer width = 4910
integer height = 1016
integer taborder = 20
string title = "none"
string dataobject = "dw_difretroactivo"
boolean hscrollbar = true
boolean vscrollbar = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;SetTransObject(SQLCA)
end event

type p_3 from userobject within tab_1
integer x = 18
integer y = 112
integer width = 5627
integer height = 1092
long backcolor = 67108864
string text = "Préstamos"
long tabtextcolor = 33554432
string picturename = "PRESTAMO.ICO"
long picturemaskcolor = 536870912
st_5 st_5
st_4 st_4
st_3 st_3
dw_cuotas dw_cuotas
dw_plan dw_plan
dw_presta dw_presta
pb_1 pb_1
end type

on p_3.create
this.st_5=create st_5
this.st_4=create st_4
this.st_3=create st_3
this.dw_cuotas=create dw_cuotas
this.dw_plan=create dw_plan
this.dw_presta=create dw_presta
this.pb_1=create pb_1
this.Control[]={this.st_5,&
this.st_4,&
this.st_3,&
this.dw_cuotas,&
this.dw_plan,&
this.dw_presta,&
this.pb_1}
end on

on p_3.destroy
destroy(this.st_5)
destroy(this.st_4)
destroy(this.st_3)
destroy(this.dw_cuotas)
destroy(this.dw_plan)
destroy(this.dw_presta)
destroy(this.pb_1)
end on

type st_5 from statictext within p_3
integer x = 2885
integer y = 12
integer width = 343
integer height = 56
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 67108864
string text = "Cuotas"
boolean focusrectangle = false
end type

type st_4 from statictext within p_3
integer x = 41
integer y = 640
integer width = 343
integer height = 56
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 67108864
string text = "Planes"
boolean focusrectangle = false
end type

type st_3 from statictext within p_3
integer x = 46
integer y = 16
integer width = 343
integer height = 56
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 67108864
string text = "Préstamos"
boolean focusrectangle = false
end type

type dw_cuotas from datawindow within p_3
integer x = 2880
integer y = 80
integer width = 2217
integer height = 972
integer taborder = 3
string title = "none"
string dataobject = "dw_coopresta_cpo"
boolean hscrollbar = true
boolean vscrollbar = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event rowfocuschanged;//if this.RowCount() = 0 or currentRow = 0 then Return
//
//if dw_presta.GetItemString(dw_presta.GetRow(),'estado') = '0' and &
//	dw_plan.GetItemString(dw_plan.GetRow(),'estado') = '0' and &
//	this.GetItemDateTime(this.GetRow(),'fecha') >= dw_nomcab.GetItemDateTime(dw_nomcab.GetRow(),'inicia') and &
//	this.GetItemDateTime(this.GetRow(),'fecha') <= dw_nomcab.GetItemDateTime(dw_nomcab.GetRow(),'termina') and &
//	this.GetItemNumber(this.GetRow(),'num_nomina') = 0 then
//	pb_1.Visible = TRUE
//else
//	pb_1.Visible = FALSE
//end if
//
end event

type dw_plan from datawindow within p_3
integer x = 37
integer y = 720
integer width = 2725
integer height = 336
integer taborder = 2
string title = "none"
string dataobject = "dw_coopresta_plan"
boolean hscrollbar = true
boolean vscrollbar = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event rowfocuschanged;dw_cuotas.Reset()
if this.RowCount() < 1 or currentrow = 0 then Return
dw_cuotas.Retrieve(this.GetItemNumber(this.GetRow(),'num_prescoopera'),this.GetItemNumber(this.GetRow(),'num_plan'))

if il_nuevo > 0 then
	long fila,i
	for i = 1 to tab_1.p_2.dw_novedad.RowCount()	
		if tab_1.p_2.dw_novedad.GetItemString(i,'cod_concep') = dw_presta.GetItemString(dw_presta.getRow(),'cod_concep') then
			fila = tab_1.p_3.dw_cuotas.find("num_prescoopera=" + string(tab_1.p_2.dw_novedad.GetItemNumber(i,'numdoc')) + &
					" and num_plan=" + string(tab_1.p_2.dw_novedad.GetItemNumber(i,'num_plan')) + &
					" and ncuota=" + string(tab_1.p_2.dw_novedad.GetItemNumber(i,'cuota')) ,1,tab_1.p_3.dw_cuotas.RowCount())
			if fila > 0 then
				tab_1.p_3.dw_cuotas.SetItem(fila,'num_nomina',tab_n.tpn_1.dw_nomcab.GetItemNumber(tab_n.tpn_1.dw_nomcab.GetRow(),'num_nomina'))
				tab_1.p_3.dw_cuotas.SetItem(fila,'cod_concep',tab_1.p_2.dw_novedad.GetItemString(i,'cod_concep'))
				tab_1.p_3.dw_cuotas.SetItem(fila,'sigla',tab_1.p_2.dw_novedad.GetItemString(i,'sigla'))
				tab_1.p_3.dw_cuotas.SetItem(fila,'item',tab_1.p_2.dw_novedad.GetItemNumber(i,'item'))
			end if
		end if
	Next
end if

end event

type dw_presta from datawindow within p_3
integer x = 37
integer y = 80
integer width = 2757
integer height = 540
integer taborder = 1
string title = "none"
string dataobject = "dw_prestacoopcab"
boolean hscrollbar = true
boolean vscrollbar = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event rowfocuschanged;dw_plan.Reset()
if this.RowCount() < 1 or currentrow = 0 then Return
dw_plan.Retrieve(this.GetItemNumber(this.GetRow(),'num_prescoopera'))


end event

type pb_1 from picturebutton within p_3
event mousemove pbm_mousemove
string tag = "&Pagar Cuota"
boolean visible = false
integer x = 5115
integer y = 108
integer width = 142
integer height = 124
integer taborder = 40
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
boolean enabled = false
string text = "                $p"
string picturename = "insertar.GIF"
string disabledname = "d_insertar.GIF"
string powertiptext = "&Pagar Cuota"
end type

type p_4 from userobject within tab_1
integer x = 18
integer y = 112
integer width = 5627
integer height = 1092
long backcolor = 67108864
string text = "Ahorros"
long tabtextcolor = 33554432
string picturename = "abono.ico"
long picturemaskcolor = 536870912
st_9 st_9
st_8 st_8
dw_acpo dw_acpo
dw_acab dw_acab
end type

on p_4.create
this.st_9=create st_9
this.st_8=create st_8
this.dw_acpo=create dw_acpo
this.dw_acab=create dw_acab
this.Control[]={this.st_9,&
this.st_8,&
this.dw_acpo,&
this.dw_acab}
end on

on p_4.destroy
destroy(this.st_9)
destroy(this.st_8)
destroy(this.dw_acpo)
destroy(this.dw_acab)
end on

type st_9 from statictext within p_4
integer x = 64
integer y = 8
integer width = 343
integer height = 56
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 67108864
string text = "Ahorros"
boolean focusrectangle = false
end type

type st_8 from statictext within p_4
integer x = 64
integer y = 564
integer width = 343
integer height = 56
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 67108864
string text = "Cuotas"
boolean focusrectangle = false
end type

type dw_acpo from datawindow within p_4
integer x = 64
integer y = 628
integer width = 4055
integer height = 440
integer taborder = 20
boolean bringtotop = true
string title = "none"
string dataobject = "dw_ahorrocpo"
boolean vscrollbar = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

type dw_acab from datawindow within p_4
integer x = 64
integer y = 64
integer width = 4096
integer height = 484
integer taborder = 10
boolean bringtotop = true
string title = "none"
string dataobject = "dw_ahorrocabnom"
boolean hscrollbar = true
boolean vscrollbar = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event rowfocuschanged;dw_acpo.Reset()
if this.RowCount() = 0 or currentRow = 0 then Return
dw_acpo.Retrieve(this.GetItemNumber(this.GetRow(),'num_ahorro'))

if il_nuevo > 0 then
	long i, fila
	for i = 1 to tab_1.p_2.dw_novedad.RowCount()
		if tab_1.p_2.dw_novedad.GetItemString(i,'cod_concep') = this.GetItemString(this.getRow(),'cod_concep') then
			fila = tab_1.p_4.dw_acpo.find("num_ahorro=" + string(tab_1.p_2.dw_novedad.GetItemNumber(i,'numdoc')) + &
				" and ncuota=" + string(tab_1.p_2.dw_novedad.GetItemNumber(i,'cuota')) ,1,tab_1.p_4.dw_acpo.RowCount())
			if fila > 0 then
				messageBox('Aviso','La cuota ya ha sido cancelada')
			elseif fila = 0 then
				fila = tab_1.p_4.dw_acpo.InsertRow(0)
				tab_1.p_4.dw_acpo.SetItem(fila,'num_nomina',tab_n.tpn_1.dw_nomcab.GetItemNumber(tab_n.tpn_1.dw_nomcab.GetRow(),'num_nomina'))
				tab_1.p_4.dw_acpo.SetItem(fila,'cod_concep',this.GetItemString(this.getRow(),'cod_concep'))
				tab_1.p_4.dw_acpo.SetItem(fila,'sigla',tab_1.p_2.dw_novedad.GetItemString(i,'sigla'))
				tab_1.p_4.dw_acpo.SetItem(fila,'item',tab_1.p_2.dw_novedad.GetItemNumber(i,'item'))
				tab_1.p_4.dw_acpo.SetItem(fila,'valor',tab_1.p_2.dw_novedad.GetItemNumber(i,'valor_c'))
				tab_1.p_4.dw_acpo.SetItem(fila,'fecha',tab_n.tpn_1.dw_nomcab.GetItemDateTime(tab_n.tpn_1.dw_nomcab.GetRow(),'fecha'))
				tab_1.p_4.dw_acpo.SetItem(fila,'ncuota',tab_1.p_2.dw_novedad.GetItemNumber(i,'cuota'))
				tab_1.p_4.dw_acpo.SetItem(fila,'ncargo',tab_1.p_2.dw_novedad.GetItemNumber(i,'cuota'))
			end if
		end if
	Next
end if

end event

type p8 from userobject within tab_1
integer x = 18
integer y = 112
integer width = 5627
integer height = 1092
long backcolor = 67108864
string text = "Resumen Nómina"
long tabtextcolor = 33554432
string picturename = "rnomina.ico"
long picturemaskcolor = 536870912
pb_dian pb_dian
dw_electronica dw_electronica
end type

on p8.create
this.pb_dian=create pb_dian
this.dw_electronica=create dw_electronica
this.Control[]={this.pb_dian,&
this.dw_electronica}
end on

on p8.destroy
destroy(this.pb_dian)
destroy(this.dw_electronica)
end on

type pb_dian from picturebutton within p8
integer x = 5321
integer y = 48
integer width = 146
integer height = 128
integer taborder = 14
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
boolean originalsize = true
string picturename = "dian.jpg"
string disabledname = "d_dian.jpg"
alignment htextalign = left!
string powertiptext = "Enviar Nómina Electrónica a la DIAN"
end type

event clicked;////////ELECTRONICA	
nvo_nom_electronica u_elec
st_retne_dian lst_lle
long nnom,l_i=1
string ls_doce,ls_tdoc,xlug

u_elec=create nvo_nom_electronica
dw_nelec.dataobject='dw_nomina_electronica'
dw_nelec.settransobject(sqlca)
hpb_1.Position = 0
hpb_1.MinPosition = 0
hpb_1.MaxPosition = dw_electronica.rowcount()
hpb_1.Visible = TRUE

for l_i=1 to dw_electronica.rowcount()
	IF KeyDown(KeyEnter!) THEN
		exit
	end if
	nnom=dw_electronica.getitemnumber(l_i,'num_nomina')
	ls_tdoc=dw_electronica.getitemstring(l_i,'tipodoc')
	ls_doce=dw_electronica.getitemstring(l_i,'documento')
	xlug=dw_electronica.getitemstring(l_i,'lugar')
	if ls_doce='84081378' then
		l_i=l_i
	end if
	if dw_electronica.getitemstring(l_i,'estado_dian')='1' then continue
	if dw_electronica.getitemstring(l_i,'nom_ele')='0' then continue
	lst_lle=u_elec.sign_chilkat('NM',nnom,ls_tdoc,ls_doce,dw_nelec,'n') 
	if lst_lle.as_estado='0' and dw_electronica.getitemnumber(l_i,'email')= 1 then
		u_elec.of_enviar_correo(nnom,ls_tdoc,ls_doce,lst_lle.as_qrcode,lst_lle.as_cune,lst_lle.as_zipname,lst_lle.as_filename,'NM',xlug)
	end if
	hpb_1.Position =l_i
next
messagebox('Atención','Proceso Finalizado')
hpb_1.Visible = false

//	dw_nelec.dataobject='dw_nomina_electronica_ajuste'
//	dw_nelec.settransobject(sqlca)
//	lst_lle=u_elec.sign_chilkat('NM',nnom,ls_tdoc,ls_doce,dw_nelec,'e') 
////////ELECTRONICA	
end event

type dw_electronica from datawindow within p8
integer x = 37
integer y = 44
integer width = 5211
integer height = 1024
integer taborder = 12
string title = "none"
string dataobject = "dw_nomina_envio_dian"
boolean hscrollbar = true
boolean vscrollbar = true
borderstyle borderstyle = stylelowered!
end type

event constructor;SetTransObject(SQLCA)
end event

event rbuttondown;st_dw_xa_funciones st_dw
st_dw.dw=this
st_dw.dwo=dwo
st_dw.row=row
openwithparm(w_funcion_dw,st_dw)
end event

type p_6 from userobject within tab_1
integer x = 18
integer y = 112
integer width = 5627
integer height = 1092
long backcolor = 67108864
string text = "Desde Archivo"
long tabtextcolor = 33554432
string picturename = "archivo_up.ico"
long picturemaskcolor = 536870912
pb_8 pb_8
st_13 st_13
pb_import pb_import
dw_im dw_im
pb_7 pb_7
end type

on p_6.create
this.pb_8=create pb_8
this.st_13=create st_13
this.pb_import=create pb_import
this.dw_im=create dw_im
this.pb_7=create pb_7
this.Control[]={this.pb_8,&
this.st_13,&
this.pb_import,&
this.dw_im,&
this.pb_7}
end on

on p_6.destroy
destroy(this.pb_8)
destroy(this.st_13)
destroy(this.pb_import)
destroy(this.dw_im)
destroy(this.pb_7)
end on

type pb_8 from picturebutton within p_6
event mousemove pbm_mousemove
string tag = "&Anular"
integer x = 4014
integer y = 60
integer width = 146
integer height = 128
integer taborder = 80
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "                $a"
boolean originalsize = true
string picturename = "borrar_fila.gif"
string disabledname = "d_borrar_fila.gif"
string powertiptext = "Borrar todos los Registros"
end type

event clicked;do while dw_im.RowCount() > 0
	dw_im.DeleteRow(1)
loop

end event

type st_13 from statictext within p_6
integer x = 3685
integer y = 340
integer width = 699
integer height = 580
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 134217752
string text = "Al importar el archivo, son seleccionados los items de empleados listados en Empleados. Quedan Las filas que no se llevaron porque el empleado no aparece en Empleados (Empnolistado) o el concepto ya existe en las novedades del empleado (ConceptoExiste)"
boolean focusrectangle = false
end type

type pb_import from picturebutton within p_6
event mousemove pbm_mousemove
integer x = 3680
integer y = 60
integer width = 151
integer height = 128
integer taborder = 22
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string picturename = "import.gif"
string disabledname = "d_import.gif"
string powertiptext = "Importar archivo"
end type

event clicked;long value, i
string docname,named,td,doc
if tab_n.tpn_1.dw_nomcab.GetItemString(tab_n.tpn_1.dw_nomcab.GetRow(),'Estado') <> '0' then
	messageBox('Aviso','El documento ya ha sido cerrado. No puede modificarse')
	Return
end if

value = GetFileOpenName("Importar de:", docname, named,"*.TXT","Text files, *.TXT, CVS files, *.CVS, XML Files, *.XML, DBase2, *.dbf") 

IF value = 1 THEN
	value = dw_im.ImportFile(docname,1,99999,1,4,2)
	if value = -1  then MessageBox('Atención','No se encontraron filas')
	if value = -2  then MessageBox('Atención','Archivo vacio')
	if value = -3  then MessageBox('Atención','Argumento inválido')
	if value = -4  then MessageBox('Atención','Entrada inválida')
	if value = -5  then MessageBox('Atención','No se puede abrir el archivo')
	if value = -6  then MessageBox('Atención','No se puede cerrar el archivo')
	if value = -7  then MessageBox('Atención','Error leyendo el texto')
	if value = -8  then MessageBox('Atención','Sufijo de archivo no soportado (debe ser *.txt, *.csv, *.dbf or *.xml)')
	if value = -10 then MessageBox('Atención','Formato de archivo dBase no soportado  (solo version 2 or 3)')
	if value = -11 then MessageBox('Atención','XML Error de interpretación; Librerias XML parser no encontradaso XML incorrecto')
	if value = -12 then MessageBox('Atención','XML Template no existe o no coincide con el formato definido para la importación')
	if value = -13 then MessageBox('Atención','Estilo de DataWindow no soportado para importación')
	if value = -14 then MessageBox('Atención','Error resolviendo anidamiento de DataWindow')
	if value < 0 then REturn -1
end if

for i = 1 to dw_im.RowCount()
	td = dw_im.GetItemString(i,'tipodoc')
	doc = dw_im.GetItemString(i,'documento')
	if tab_n.tpn_2.dw_empnom.Find("tipodoc='"+td+"' and documento='"+doc+"'",1,tab_n.tpn_2.dw_empnom.RowCount()) > 0 then
		dw_im.SetItem(i,'selec',1)
	end if
next

end event

type dw_im from datawindow within p_6
integer x = 55
integer y = 68
integer width = 3506
integer height = 1000
integer taborder = 14
string title = "none"
string dataobject = "dw_import_nov"
boolean vscrollbar = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;SetTransObject(SQLCA)
select cod_empresa into :i_cemp from lugar where codlugar=:clugar;
if sqlca.sqlcode=-1 then
	messagebox("Error leyendo la tabla lugar",sqlca.sqlerrtext)
	return -1
end if
if isnull(i_cemp) then
	messagebox("Error Código Empresa",'No existe el código de la empresa en la tabla lugar, debe colocarlo allí para poder continuar')
	return -1
end if
GetChild('cod_concep',dwc_cp)
dwc_cp.SetTransObject(SQLCA)
dwc_cp.Retrieve(i_cemp)

end event

type pb_7 from picturebutton within p_6
event mousemove pbm_mousemove
integer x = 3845
integer y = 60
integer width = 146
integer height = 128
integer taborder = 32
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
boolean originalsize = true
string picturename = "llevar.gif"
string disabledname = "d_llevar.gif"
string powertiptext = "Llevar a Novedades"
end type

event clicked;long i,fila, filahist, fc,tarifa,tarifa_esp,j
string td,doc,concep,sigla,bfc,bfc1,form_calculo,form_verifica 

if tab_n.tpn_1.dw_nomcab.GetItemString(tab_n.tpn_1.dw_nomcab.GetRow(),'Estado') <> '0' then
	messageBox('Aviso','El documento ya ha sido cerrado. No puede modificarse')
	Return
end if

tab_1.p_2.dw_novedad.SetRedraw(FALSE)
tab_1.p_1.dw_devenga.SetRedraw(FALSE)
tab_1.p_1.dw_deduce.SetRedraw(FALSE)
tab_n.tpn_2.dw_empnom.SetRedraw(FALSE)
i = dw_im.RowCount()

do while i > 0
	if isNull(dw_im.GetItemNumber(i,'selec')) or (dw_im.GetItemNumber(i,'selec') = 0) then 
		i = i -1
		CONTINUE
	end if
	td = dw_im.GetItemString(i,'tipodoc')
	doc = dw_im.GetItemString(i,'documento')
	concep = dw_im.GetItemString(i,'cod_concep')
	fc = dwc_cp.Find("cod_concep='"+concep+"'",1,dwc_cp.RowCount())
	if fc > 0 then
		sigla = dwc_cp.GetItemString(fc,'sigla')
	else
		i = i -1
		CONTINUE
	end if
	fila = tab_n.tpn_2.dw_empnom.Find("tipodoc='"+td+"' and documento='"+doc+"'",1,tab_n.tpn_2.dw_empnom.RowCount()) 
	if fila > 0 then
		tab_n.tpn_2.dw_empnom.ScrolltoRow(fila)
		if tab_1.p_2.dw_novedad.Find("cod_concep='"+concep+"'",1,tab_1.p_2.dw_novedad.RowCount()) > 0 then 
			dw_im.SetItem(i,'conceptoexiste','1')
			i = i -1
			CONTINUE
		end if
		fila = tab_1.p_2.dw_novedad.InsertRow(0)
		tab_1.p_2.dw_novedad.SetItem(fila,'num_nomina',tab_n.tpn_1.dw_nomcab.GetItemNumber(tab_n.tpn_1.dw_nomcab.GetRow(),'num_nomina'))
		tab_1.p_2.dw_novedad.SetItem(fila,'tipodoc',td)
		tab_1.p_2.dw_novedad.SetItem(fila,'documento',doc)
		tab_1.p_2.dw_novedad.SetItem(fila,'item',1)
		tab_1.p_2.dw_novedad.SetItem(fila,'cod_concep',concep)
		tab_1.p_2.dw_novedad.SetItem(fila,'sigla',sigla)
		tab_1.p_2.dw_novedad.SetItem(fila,'tipo',dwc_cp.GetItemString(fc,'tipo'))
		tab_1.p_2.dw_novedad.SetItem(fila,'cod_tipo_concep',dwc_cp.GetItemString(fc,'cod_tipo_concep'))
		tab_1.p_2.dw_novedad.SetItem(fila,'cantidad_ac',dw_im.GetItemNumber(i,'horas'))
		tab_1.p_2.dw_novedad.SetItem(fila,'valor_c',dw_im.GetItemNumber(i,'valor'))
		tab_1.p_2.dw_novedad.SetItem(fila,'pagado',dw_im.GetItemNumber(i,'valor'))
		filahist = dw_historia.Find("cargo_estado = '1'",1,dw_historia.RowCount())
		if filahist > 0 then
			log.info("pb_addnov"+string(dw_historia.GetItemNumber(filahist,'ncargo')))
			tab_1.p_2.dw_novedad.SetItem(fila,'ncargo',dw_historia.GetItemNumber(filahist,'ncargo'))
			tab_1.p_2.dw_novedad.SetItem(fila,'nsalario',dw_historia.GetItemNumber(filahist,'nsalario'))
			tab_1.p_2.dw_novedad.SetItem(fila,'ntraslado',dw_historia.GetItemNumber(filahist,'ntraslado'))
		else
			tab_1.p_2.dw_novedad.DeleteRow(fila)			
			MessageBox('Atención','El empleado no tiene cargo activo ' + td + doc)
			Return -1
		end if
		/// Para el calculo
		selectblob form_calculo into :bfc
		from nom_concep where cod_concep=:concep;
		
		selectblob form_verifica into :bfc1
		from nom_concep where cod_concep=:concep;
		
		select tarifa,tarifa_esp into :tarifa,:tarifa_esp
		from nom_concep where cod_concep=:concep;
		
		form_calculo = string(bfc)
		form_verifica = string(bfc1)
		if dw_historia.Describe(sigla + '.Coltype') = "!" then
			if f_addcompute(sigla, form_calculo,form_verifica,tarifa,tarifa_esp,1) = -1 then Return -1
		end if
		tab_1.p_2.dw_novedad.SetItem(fila,'form_calculo',form_calculo)
		for j = 1 to dw_historia.RowCount()
			if j = filahist then
				dw_historia.SetItem(j,get_parm_nov(sigla) ,dw_im.GetItemNumber(i,'horas'))
				dw_historia.SetItem(j,f_get_ctrl(sigla) ,1)
			else
				dw_historia.SetItem(j,get_parm_nov(sigla) ,0)
				dw_historia.SetItem(j,f_get_ctrl(sigla) ,0)
			end if
		next
		//////
		if recalcula( tab_n.tpn_2.dw_empnom.GetItemString(tab_n.tpn_2.dw_empnom.GetRow(),'tipodoc'),tab_n.tpn_2.dw_empnom.GetItemString(tab_n.tpn_2.dw_empnom.GetRow(),'documento') ) = -1 then Return -1
		//
		dw_im.DeleteRow(i)
	else
		dw_im.SetItem(i,'empnolistado','1')
	end if
	i = i - 1
Loop

tab_1.p_2.dw_novedad.SetRedraw(TRUE)
tab_1.p_1.dw_devenga.SetRedraw(TRUE)
tab_1.p_1.dw_deduce.SetRedraw(TRUE)
tab_n.tpn_2.dw_empnom.SetRedraw(TRUE)
// El recalcula es por empleado
//if recalcula() = -1 then Return -1
cambio = TRUE


end event

type dw_tsup from datawindow within w_nomina
boolean visible = false
integer x = 599
integer y = 2124
integer width = 402
integer height = 108
integer taborder = 210
boolean enabled = false
string title = "none"
string dataobject = "dw_tsup_resumen_all"
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;SetTransObject(SQLCA)

end event

type dw_1 from datawindow within w_nomina
boolean visible = false
integer x = 1513
integer y = 2132
integer width = 297
integer height = 124
integer taborder = 140
boolean bringtotop = true
string dataobject = "dw_emple_regla"
boolean border = false
end type

event constructor;settransobject(SQLCA)
insertrow(1)

end event

event itemchanged;this.accepttext()
string td,doc,filtro, cl,uf,cc,cl_des,uf_des,cc_des,cr,te,car
long f
if not isNull(dwo) then
	if string(dwo.Name) <> 'documento' then Return
end if
td = getitemstring(this.getrow(),'tipodoc')
doc = getitemstring(this.getrow(),'documento')

this.retrieve(td,doc)
IF this.rowcount()=0 THEN
	this.insertrow(0)
	messageBox ("Atención","Empleado no encontrado.")
	this.SetItem(1,'tipodoc',td)
	this.SetItem(1,'documento',doc)
ELSE
	f = tab_n.tpn_2.dw_empnom.Find("tipodoc='"+getitemstring(this.getrow(),'tipodoc')+"' and documento='"+getitemstring(this.getrow(),'documento')+"'",1,tab_n.tpn_2.dw_empnom.RowCount())
	if f = 0 then
		f = tab_n.tpn_2.dw_empnom.InsertRow(0)
		tab_n.tpn_2.dw_empnom.SetItem(f,'tipodoc',dw_1.GetItemString(1,'tipodoc'))
		tab_n.tpn_2.dw_empnom.SetItem(f,'documento',dw_1.GetItemString(1,'documento'))
		tab_n.tpn_2.dw_empnom.SetItem(f,'nombre1',dw_1.GetItemString(1,'terceros_nombre1'))
		tab_n.tpn_2.dw_empnom.SetItem(f,'nombre2',dw_1.GetItemString(1,'terceros_nombre2'))
		tab_n.tpn_2.dw_empnom.SetItem(f,'apellido1',dw_1.GetItemString(1,'terceros_apellido1'))
		tab_n.tpn_2.dw_empnom.SetItem(f,'apellido2',dw_1.GetItemString(1,'terceros_apellido2'))
		tab_n.tpn_2.dw_empnom.SetItem(f,'sel',1)
		select codlugar,ufuncional,ccosto into :cl,:uf,:cc from empleubica
		where tipodoc=:td and documento=:doc and estado='1';
		IF SQLCA.SQLCode = -1 THEN
			MessageBox("SQL error recuperando lugar,U.funcional y C.Costo", SQLCA.SQLErrText)
		END IF
		select descripcion into :cl_des from lugar
		where codlugar=:cl;
		IF SQLCA.SQLCode = -1 THEN
			MessageBox("SQL error recuperando lugar", SQLCA.SQLErrText)
		END IF
		select desUfuncional into :uf_des from uFuncional
		where coduf=:uf;
		IF SQLCA.SQLCode = -1 THEN
			MessageBox("SQL error recuperando lugar", SQLCA.SQLErrText)
		END IF
		select descripcion into :cc_des from centrocostos
		where coduf=:uf and codcc=:cc;
		IF SQLCA.SQLCode = -1 THEN
			MessageBox("SQL error recuperando lugar", SQLCA.SQLErrText)
		END IF
		select codrela,tipoemple,cargo into :cr,:te,:car 
		from emplecargo
		where tipodoc=:td and documento =:doc and estado = '1';
		IF SQLCA.SQLCode = -1 THEN
			MessageBox("SQL error", SQLCA.SQLErrText)
			Return 0
		END IF
		if dwc_novedad.Retrieve(cr,te,car,'1') = 0 then
		//	MesageBox('Atención','El tipo empleado y cargo no tienen novedades asociadas')
			dwc_novedad.InsertRow(0)
		end if
		tab_n.tpn_2.dw_empnom.SetItem(f,'clugar_des',cl_des)
		tab_n.tpn_2.dw_empnom.SetItem(f,'ufun_des',uf_des)
		tab_n.tpn_2.dw_empnom.SetItem(f,'cc_des',cc_des)
		tab_n.tpn_2.dw_empnom.ScrolltoRow(f)
		ibn_calculando = TRUE
		if nomcalc(tab_n.tpn_2.dw_empnom.GetItemString(f,'tipodoc'), tab_n.tpn_2.dw_empnom.GetItemString(f,'documento'),tab_n.tpn_1.dw_nomcab.getitemstring(tab_n.tpn_1.dw_nomcab.getrow(),'esp'),tab_n.tpn_1.dw_nomcab.getitemstring(tab_n.tpn_1.dw_nomcab.getrow(),'tipo')) < 0 then
			Return
		end if
		calctotal()
		ibn_calculando = FALSE
		cambio = TRUE
	else
		tab_n.tpn_2.dw_empnom.ScrolltoRow(f)
	end if
END IF

end event

type dw_tipoincap from datawindow within w_nomina
boolean visible = false
integer x = 1865
integer y = 2132
integer width = 251
integer height = 84
integer taborder = 180
boolean bringtotop = true
string title = "none"
string dataobject = "dw_conf_ausentismo"
boolean resizable = true
boolean livescroll = true
end type

event constructor;setTransObject(SQLCA)
end event

type tab_n from tab within w_nomina
event resize ( integer ai_width,  integer ai_height )
integer x = 14
integer y = 16
integer width = 3927
integer height = 800
integer taborder = 80
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 67108864
boolean fixedwidth = true
boolean raggedright = true
boolean focusonbuttondown = true
boolean powertips = true
boolean pictureonright = true
tabposition tabposition = tabsonleft!
integer selectedtab = 1
tpn_1 tpn_1
tpn_2 tpn_2
end type

event resize(integer ai_width, integer ai_height);this.resize(ai_width,ai_height)
tpn_1.dw_nomcab.resize(ai_width - 400 , ai_height - 200 )

tpn_2.dw_empnom.resize(ai_width - 400 , ai_height - 200 )
end event

on tab_n.create
this.tpn_1=create tpn_1
this.tpn_2=create tpn_2
this.Control[]={this.tpn_1,&
this.tpn_2}
end on

on tab_n.destroy
destroy(this.tpn_1)
destroy(this.tpn_2)
end on

type tpn_1 from userobject within tab_n
event create ( )
event destroy ( )
integer x = 128
integer y = 16
integer width = 3781
integer height = 768
long backcolor = 67108864
long tabtextcolor = 33554432
string picturename = "nominas.ico"
long picturemaskcolor = 536870912
string powertiptext = "Nóminas del año seleccionado"
dw_anyos dw_anyos
pb_des pb_des
pb_retro pb_retro
pb_nuevo pb_nuevo
dw_nomcab dw_nomcab
dw_3 dw_3
end type

on tpn_1.create
this.dw_anyos=create dw_anyos
this.pb_des=create pb_des
this.pb_retro=create pb_retro
this.pb_nuevo=create pb_nuevo
this.dw_nomcab=create dw_nomcab
this.dw_3=create dw_3
this.Control[]={this.dw_anyos,&
this.pb_des,&
this.pb_retro,&
this.pb_nuevo,&
this.dw_nomcab,&
this.dw_3}
end on

on tpn_1.destroy
destroy(this.dw_anyos)
destroy(this.pb_des)
destroy(this.pb_retro)
destroy(this.pb_nuevo)
destroy(this.dw_nomcab)
destroy(this.dw_3)
end on

type dw_anyos from datawindow within tpn_1
integer x = 201
integer width = 727
integer height = 84
integer taborder = 21
string title = "none"
string dataobject = "dw_anyos"
boolean border = false
end type

event constructor;insertrow(1)

end event

event itemchanged;long ll_actual
ll_actual=getitemnumber(1,1)
if il_nuevo>0 or cambio then
	if messagebox("Atención", 'Los cambios realizados no han sido guardados, perderá los cambios. Desea continuar?',QUESTION!,YESNO!) = 1 then
		cambio=false
		il_nuevo=0
		accepttext()		
	else
		settext(string(ll_actual))
		setitem(1,1,ll_actual)
		post accepttext()
		return 2
	end if
end if
tab_n.tpn_1.dw_nomcab.reset()
tab_n.tpn_1.dw_nomcab.post retrieve(integer(data))
tab_n.tpn_1.dw_nomcab.post setfocus()



end event

type pb_des from picturebutton within tpn_1
integer x = 27
integer y = 356
integer width = 146
integer height = 128
integer taborder = 110
boolean bringtotop = true
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
boolean enabled = false
string text = "                            "
boolean originalsize = true
string picturename = "desprendible.gif"
string disabledname = "d_desprendible.gif"
alignment htextalign = left!
string powertiptext = "Envio Desprendible a email"
end type

event clicked;uo_datastore dw_trae,dw_for
string l_servidor, l_puerto,l_usuario,l_clave,l_autentica,l_conexion,l_desc, l_nombre,l_asunto
string l_email,ncom,ltd,ldocu,ls_archivo
string p_qr, l_qr,ls_ojo
long l_ci,num_n,l_mes,l_año,l_contador
decimal l_neto

if f_permiso_boton(this,'NM')=0 then return -1
sqlca.autocommit=true
dw_trae=create uo_datastore
dw_trae.dataobject='dw_envio_des_nomina'

dw_for=create uo_datastore
dw_for.dataobject='nom_desprendible'
dw_for.settransobject(sqlca)

SELECT servidor, puerto, usuario, clave, autentica, conexion 
INTO   :l_servidor, :l_puerto,:l_usuario,:l_clave,:l_autentica,:l_conexion
FROM ips_correos
WHERE c_ips='01' and ctipo='NM01';
num_n=dw_nomcab.GetItemnumber(dw_nomcab.Getrow(),'num_nomina')
l_mes=dw_nomcab.GetItemnumber(dw_nomcab.Getrow(),'mes')
l_año=dw_nomcab.GetItemnumber(dw_nomcab.Getrow(),'ano')

if isnull(l_servidor) or l_servidor='' then 
	messagebox('Atención','No hay datos configuradorados para NM01')
	return 
end if

lb_1.Reset()
dw_trae.settransobject(sqlca)
dw_trae.retrieve(num_n)
if dw_trae.rowcount()> 0 then
	l_asunto='DESPRENDIBLE DE NOMINA '+string(dw_nomcab.GetItemnumber(dw_nomcab.Getrow(),'num_nomina'))
	if dw_trae.getitemnumber(1,'sin')> 9 then 
		messagebox('Atención','Para esta nomina hay '+string(dw_trae.getitemnumber(1,'sin'))+' empleados sin email y '+ string(dw_trae.getitemnumber(1,'con'))+ ' que se podran enviar')
	end if
	dw_trae.setfilter('not isnull( email )')
	dw_trae.filter()
	hpb_1.Position = 0
	hpb_1.MinPosition = 0
	hpb_1.MaxPosition = dw_trae.rowcount()
	hpb_1.Visible = TRUE
	l_contador=0
	for l_ci=1 to dw_trae.rowcount()
  		l_email=dw_trae.getitemstring(l_ci,"email")
		ncom=dw_trae.getitemstring(l_ci,"nombret")
		ltd=dw_trae.getitemstring(l_ci,"tipodoc")
		ldocu=dw_trae.getitemstring(l_ci,"documento")
		ls_archivo = 'dn_'+string(num_n)+'_'+ltd+'_'+ldocu
		setnull(p_qr)
		dw_for.retrieve(num_n,ltd,ldocu)
		if dw_for.rowcount()>0 then 			
			l_neto=dw_for.getitemdecimal(1,'neto')
			draw_qr_code lqr_code
			lqr_code=create draw_qr_code
			p_qr=ltd+ldocu+ncom+string(num_n)+string(l_mes,'-##-')+string(l_año)+'--NETO--'+string(l_neto)
			ls_archivo=is_path+ ls_archivo+'.bmp'
			lb_1.AddItem(ls_archivo)
		
			lqr_code.draw_msg(p_qr,'L',ls_archivo)
			ls_ojo=dw_for.modify('qr_picture.filename="'+ls_archivo+'"')
			ls_archivo = 'desprendible_'+string(num_n)+'_'+ltd+'_'+ldocu
			ls_archivo= is_path+ ls_archivo+'.pdf'
			lb_1.AddItem(ls_archivo)
			dw_for.saveas(ls_archivo,pdf!,true)
			l_nombre=f_envia_mail(l_servidor, l_puerto,l_usuario,l_clave,l_autentica,l_conexion,l_email,l_asunto,l_desc,p_qr,ls_archivo,"Estimado Funcionario:~r~n~r~nAdjunto encontrarás el documento correspondiente a la desprendible nomina."+"~r~n~r~nFeliz día.")	
			l_contador++
		end if
		hpb_1.Position =l_ci
	next
	messagebox('Atencíon','Proceso Finalizado.  Se enviaron '+string(l_contador)+' emails de '+string(dw_trae.rowcount()))
end if
Integer index
For index=1 To lb_1.totalItems ( )
     FileDelete ( lb_1.text(index))
Next
lb_1.Reset()

sqlca.autocommit=false
hpb_1.Visible = false
end event

type pb_retro from picturebutton within tpn_1
string tag = "Retroactivos"
integer x = 27
integer y = 220
integer width = 146
integer height = 128
integer taborder = 160
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
boolean enabled = false
boolean originalsize = true
string picturename = "retroac.gif"
string disabledname = "d_retroac.gif"
string powertiptext = "Calculo Retroactivo"
end type

event clicked;long numdoc,nomina
string msg

if f_permiso_boton(this,'NM')=0 then return -1
if dw_nomcab.rowcount() =0 then Return
if dw_nomcab.getitemstring(dw_nomcab.GetRow(),'retro') ='1' then Return
if dw_nomcab.getitemstring(dw_nomcab.GetRow(),'tipo') ='R' then Return
if dw_nomcab.getitemnumber(dw_nomcab.GetRow(),'ano') <> year(today()) then Return

nomina=dw_nomcab.getitemnumber(dw_nomcab.getrow(),'num_nomina')
numdoc = f_trae_ndoc('NM',clugar,'NOMINA')
INSERT INTO nom_cab ( num_nomina, ano, mes, periodo, fecha, inicia, termina, estado, fecha_anulada, usuario, contabil, lugar, presupuesto, esp, tipo )
SELECT :numdoc as num_nomina, nom_cab.ano, nom_cab.mes, nom_cab.periodo, nom_cab.fecha, nom_cab.inicia, nom_cab.termina, 0 as estado, nom_cab.fecha_anulada, nom_cab.usuario, 'P' as contabil, nom_cab.lugar, nom_cab.presupuesto, nom_cab.esp, 'R' as tipo
FROM nom_cab
WHERE (((nom_cab.num_nomina)=:nomina));
if sqlca.sqlcode=-1 then
	messagebox("Error Insertando nom_cab",sqlca.sqlerrtext)
	rollback;
	goto ERRORES
	return
end if

INSERT INTO NOM_CPO  (num_nomina,tipodoc, documento, ncargo, cod_concep, item, cantidad_ac, valor_c, pagado, tipocon, cq, coop, acum_usu, gtia, numdoc, nplan, cuota, ntraslado, nsalario, tipodoc_clase, documento_clase, cod_clase, ano, ncontrato, otrosi, item_fp, dias_incapacidad, dias_incapacidadp, dias_licencianr, dias_lmaterna, dias_vacaciones, item_clase, num_plan, ingreso, retiro, trasdesde, trashacia, base,tarifa)
SELECT  
	:numdoc,nom_cpo.tipodoc, nom_cpo.documento, nom_cpo.ncargo, nom_cpo.cod_concep, nom_cpo.item, 
	nom_cpo.cantidad_ac, 	nom_cpo.valor_c, nom_cpo.pagado, nom_cpo.tipocon, nom_cpo.cq, nom_cpo.coop, 
	nom_cpo.acum_usu, nom_cpo.gtia, nom_cpo.numdoc, nom_cpo.nplan, nom_cpo.cuota, nom_cpo.ntraslado, 
		(SELECT emplesalario.nsalario
	FROM emplesalario
	WHERE 
	 (((emplesalario.tipodoc)=nom_cpo.tipodoc) 
	 AND ((emplesalario.documento)=nom_cpo.documento) 
	  AND ((emplesalario.ncargo)=nom_cpo.ncargo) AND ((emplesalario.estado)='1'))
 	) as nsalario, 
	 nom_cpo.tipodoc_clase, nom_cpo.documento_clase, nom_cpo.cod_clase, nom_cpo.ano, 
	nom_cpo.ncontrato, nom_cpo.otrosi, nom_cpo.item_fp, nom_cpo.dias_incapacidad, nom_cpo.dias_incapacidadp, 
	nom_cpo.dias_licencianr, nom_cpo.dias_lmaterna, nom_cpo.dias_vacaciones, nom_cpo.item_clase, 
	nom_cpo.num_plan, nom_cpo.ingreso, nom_cpo.retiro, nom_cpo.trasdesde, nom_cpo.trashacia, nom_cpo.base,
	nom_cpo.tarifa
FROM 
	nom_cpo inner join nom_concep on nom_cpo.cod_concep = nom_concep.cod_concep
WHERE 
	(((nom_cpo.num_nomina)=:nomina) and ((nom_concep.cod_tipo_concep)<>'4' or (nom_concep.cod_tipo_concep)<>'5' or (nom_concep.cod_tipo_concep)<>'6' or (nom_concep.cod_tipo_concep)<>'7' or (nom_concep.cod_tipo_concep)<>'8' or (nom_concep.cod_tipo_concep)<>'9'));
if sqlca.sqlcode=-1 then
	messagebox("Error Insertando nom_cpo",sqlca.sqlerrtext)
	rollback;
	goto ERRORES
	return
end if
dw_nomcab.retrieve(dw_anyos.getitemnumber(1,1))
dw_nomcab.TriggerEvent(rowfocuschanged!)
dw_nomcab.setfocus()
pb_calcula.TriggerEvent(clicked!)

grabar('temporal')

if g_motor='postgres' then
	///Actualiza todo lo que esta en nomina sin ausentismo
	UPDATE nom_cpo set 
			 nomina_org=actual_ncpo.norg,
			 tipodoc_org= actual_ncpo.tipodoc,
			 documento_org= actual_ncpo.documento,
			 ncargo_org= actual_ncpo.ncargo,
			 concep_org= actual_ncpo.cod_concep,
			 item_org=actual_ncpo.itemorg,
			 cod_concep = actual_ncpo.equ_retro, 
			 valorc_org=actual_ncpo.valorc_org,
			 pagado_org=actual_ncpo.pagado_org,
			 valorc_ret=nom_cpo.valor_c ,
			 pagado_ret=nom_cpo.pagado
	FROM 
			(	SELECT 
					nom_cpo2.num_nomina, nom_cpo2.tipodoc, nom_cpo2.documento, nom_cpo2.ncargo, 
					nom_cpo1.cod_concep, nom_cpo2.item, 
					(nom_cpo2.valor_c - nom_cpo1.valor_c) as difvalorc, 
					(nom_cpo2.pagado - nom_cpo1.pagado) as difpagado, 
					nom_concep.equ_retro,
					nom_cpo1.num_nomina as norg, 
					nom_cpo1.item as itemorg,
					nom_cpo1.valor_c as valorc_org,
					nom_cpo1.pagado as pagado_org
				FROM 
					((nom_cpo as nom_cpo1  inner join nom_cpo as nom_cpo2 on (nom_cpo1.tipodoc = nom_cpo2.tipodoc) and (nom_cpo1.documento = nom_cpo2.documento) 
					and (nom_cpo1.ncargo = nom_cpo2.ncargo) and (nom_cpo1.cod_concep = nom_cpo2.cod_concep)) 
					inner join nom_concep on nom_cpo2.cod_concep = nom_concep.cod_concep) 
					LEFT JOIN nom_ausentismo_det ON (nom_cpo2.num_nomina = nom_ausentismo_det.num_nomina) 
					AND (nom_cpo2.tipodoc = nom_ausentismo_det.tipodoc_n) 
					AND (nom_cpo2.documento = nom_ausentismo_det.documento_n) 
					AND (nom_cpo2.ncargo = nom_ausentismo_det.ncargo) 
					AND (nom_cpo2.cod_concep = nom_ausentismo_det.cod_concep) 
					AND (nom_cpo2.item = nom_ausentismo_det.item_n)
				WHERE 
			 		(((nom_cpo2.num_nomina)=:numdoc) AND ((nom_concep.equ_retro) Is Not Null) 
					 AND ((nom_cpo1.num_nomina)=:nomina) AND ((nom_ausentismo_det.num_nomina) Is Null))					
			) 	as actual_ncpo 
		WHERE 
			(nom_cpo.cod_concep = actual_ncpo.cod_concep) 
			and (nom_cpo.item = actual_ncpo.item) 
			and (nom_cpo.ncargo = actual_ncpo.ncargo) 
			and (nom_cpo.documento = actual_ncpo.documento) 
			and (nom_cpo.tipodoc = actual_ncpo.tipodoc) 
			and (nom_cpo.num_nomina = actual_ncpo.num_nomina);	
	if sqlca.sqlcode=-1 then
		messagebox("Error Actualizando",sqlca.sqlerrtext)
		rollback;
		goto ERRORES
		return
	end if
	
	/// Para lo que esta en ausentismo
	INSERT INTO NOM_CPO  (num_nomina,tipodoc, documento, ncargo, cod_concep, item, cantidad_ac, valor_c, pagado, tipocon, cq, coop, acum_usu, gtia, numdoc, nplan, cuota, ntraslado, nsalario, tipodoc_clase, documento_clase, cod_clase, ano, ncontrato, otrosi, item_fp, dias_incapacidad, dias_incapacidadp, dias_licencianr, dias_lmaterna, dias_vacaciones, item_clase, num_plan, ingreso, retiro, trasdesde, trashacia, base,tarifa)
	SELECT DISTINCT
		:numdoc,nom_cpo.tipodoc, nom_cpo.documento, nom_cpo.ncargo,  nom_concep.equ_retro, nom_cpo.item, 
		nom_cpo.cantidad_ac, nom_cpo.valor_c, nom_cpo.pagado, nom_cpo.tipocon, nom_cpo.cq, nom_cpo.coop, 
		nom_cpo.acum_usu, nom_cpo.gtia, nom_cpo.numdoc, nom_cpo.nplan, nom_cpo.cuota, nom_cpo.ntraslado, 
		nom_cpo.nsalario, nom_cpo.tipodoc_clase, nom_cpo.documento_clase, nom_cpo.cod_clase, nom_cpo.ano, 
		nom_cpo.ncontrato, nom_cpo.otrosi, nom_cpo.item_fp, nom_cpo.dias_incapacidad, nom_cpo.dias_incapacidadp, 
		nom_cpo.dias_licencianr, nom_cpo.dias_lmaterna, nom_cpo.dias_vacaciones, nom_cpo.item_clase, 
		nom_cpo.num_plan, nom_cpo.ingreso, nom_cpo.retiro, nom_cpo.trasdesde, nom_cpo.trashacia, nom_cpo.base,
		nom_cpo.tarifa
	FROM 
		(nom_cpo INNER JOIN nom_concep ON nom_cpo.cod_concep = nom_concep.cod_concep) 
		INNER JOIN nom_ausentismo_det ON (nom_cpo.item = nom_ausentismo_det.item_n) 
		AND (nom_cpo.cod_concep = nom_ausentismo_det.cod_concep) AND (nom_cpo.ncargo = nom_ausentismo_det.ncargo) 
		AND (nom_cpo.documento = nom_ausentismo_det.documento_n) AND (nom_cpo.tipodoc = nom_ausentismo_det.tipodoc_n) 
		AND (nom_cpo.num_nomina = nom_ausentismo_det.num_nomina)
	WHERE 
		(((nom_cpo.num_nomina)=:numdoc) and ((nom_concep.cod_tipo_concep)<>'4' or (nom_concep.cod_tipo_concep)<>'5' or (nom_concep.cod_tipo_concep)<>'6' or (nom_concep.cod_tipo_concep)<>'7' or (nom_concep.cod_tipo_concep)<>'8' or (nom_concep.cod_tipo_concep)<>'9'));
	if sqlca.sqlcode=-1 then
		messagebox("Error Insertando nom_cpo detalles ",sqlca.sqlerrtext)
		rollback;
		goto ERRORES
		return
	end if
	
	UPDATE nom_ausentismo_det 
	SET cod_concep = nom_concep.equ_retro
	FROM nom_concep 
	WHERE 
		(((nom_concep.equ_retro) Is Not Null) AND ((nom_ausentismo_det.num_nomina)=:numdoc)
		And (nom_ausentismo_det.cod_concep = nom_concep.cod_concep )
		);
	if sqlca.sqlcode=-1 then
		messagebox("Error Actualizando ausentismo_det",sqlca.sqlerrtext)
		rollback;
		goto ERRORES
		return
	end if
	
	UPDATE nom_cpo set 
			 nomina_org=actual_ncpo.norg,tipodoc_org= actual_ncpo.tipodoc,documento_org= actual_ncpo.documento,
			 ncargo_org= actual_ncpo.ncargo,concep_org= actual_ncpo.cod_concep,item_org=actual_ncpo.itemorg,
			 valorc_org=valor_c ,pagado_org=pagado
	FROM 
			(	SELECT 
					nom_cpo2.num_nomina, nom_cpo2.tipodoc, nom_cpo2.documento, nom_cpo2.ncargo, 
					nom_cpo1.cod_concep, nom_cpo2.item, 
					(nom_cpo2.valor_c - nom_cpo1.valor_c) as difvalorc, 
					(nom_cpo2.pagado - nom_cpo1.pagado) as difpagado, 
					nom_concep.equ_retro,
					nom_cpo1.num_nomina as norg, 
					nom_cpo1.item as itemorg
			FROM 
					((nom_cpo AS nom_cpo1 INNER JOIN nom_cpo AS nom_cpo2 ON (nom_cpo1.ncargo = nom_cpo2.ncargo) 
					AND (nom_cpo1.documento = nom_cpo2.documento) AND (nom_cpo1.tipodoc = nom_cpo2.tipodoc)) 
					INNER JOIN nom_ausentismo_det ON (nom_cpo2.item = nom_ausentismo_det.item_n) 
					AND (nom_cpo2.cod_concep = nom_ausentismo_det.cod_concep) 
					AND (nom_cpo2.ncargo = nom_ausentismo_det.ncargo) AND (nom_cpo2.documento = nom_ausentismo_det.documento_n) 
					AND (nom_cpo2.tipodoc = nom_ausentismo_det.tipodoc_n) AND (nom_cpo2.num_nomina = nom_ausentismo_det.num_nomina)) 
					INNER JOIN nom_concep ON (nom_concep.equ_retro = nom_cpo2.cod_concep) 
					AND (nom_cpo1.cod_concep = nom_concep.cod_concep)
			WHERE 
					(((nom_cpo2.num_nomina)=:numdoc) AND ((nom_concep.equ_retro) Is Not Null) 
					AND ((nom_cpo1.num_nomina)=:nomina))				
			) 	as actual_ncpo 
		WHERE 
			(nom_cpo.cod_concep = actual_ncpo.equ_retro) 
			and (nom_cpo.item = actual_ncpo.item) 
			and (nom_cpo.ncargo = actual_ncpo.ncargo) 
			and (nom_cpo.documento = actual_ncpo.documento) 
			and (nom_cpo.tipodoc = actual_ncpo.tipodoc) 
			and (nom_cpo.num_nomina = actual_ncpo.num_nomina);	
	if sqlca.sqlcode=-1 then
		messagebox("Error Actualizando detalle",sqlca.sqlerrtext)
		rollback;
		goto ERRORES
		return
	end if
	
	DELETE FROM 
			nom_cpo 
	WHERE 
	  	EXISTS
		  (
			SELECT 
			  1
			FROM 
				(nom_cpo AS nom_cpo1 INNER JOIN (nom_concep 
				INNER JOIN nom_tipo_ausentismo ON nom_concep.cod_concep = nom_tipo_ausentismo.cod_concep) 
				ON nom_cpo1.cod_concep = nom_concep.cod_concep) 
				LEFT JOIN nom_ausentismo_det ON (nom_cpo1.num_nomina = nom_ausentismo_det.num_nomina) 
				AND (nom_cpo1.tipodoc = nom_ausentismo_det.tipodoc_n) AND (nom_cpo1.documento = nom_ausentismo_det.documento_n) 
				AND (nom_cpo1.ncargo = nom_ausentismo_det.ncargo) AND (nom_cpo1.cod_concep = nom_ausentismo_det.cod_concep) 
				AND (nom_cpo1.item = nom_ausentismo_det.item_n)
			WHERE 
				  (((nom_ausentismo_det.num_nomina) Is Null) 
				  AND ((nom_cpo1.num_nomina)=:numdoc)
				  AND (nom_cpo1.num_nomina=nom_cpo.num_nomina)
				  AND (nom_cpo1.tipodoc=nom_cpo.tipodoc)
				  AND (nom_cpo1.documento=nom_cpo.documento)
				  AND (nom_cpo1.ncargo=nom_cpo.ncargo)
				  AND (nom_cpo1.cod_concep=nom_cpo.cod_concep)
				  AND (nom_cpo1.item=nom_cpo.item))
			UNION ALL
			SELECT 
			  1
			FROM 
				(nom_cpo AS nom_cpo1 INNER JOIN (nom_concep 
				INNER JOIN nom_tipo_ausentismo ON nom_concep.cod_concep = nom_tipo_ausentismo.cod_concep_base) 
				ON nom_cpo1.cod_concep = nom_concep.cod_concep) 
				LEFT JOIN nom_ausentismo_det ON (nom_cpo1.num_nomina = nom_ausentismo_det.num_nomina) 
				AND (nom_cpo1.tipodoc = nom_ausentismo_det.tipodoc_n) AND (nom_cpo1.documento = nom_ausentismo_det.documento_n) 
				AND (nom_cpo1.ncargo = nom_ausentismo_det.ncargo) AND (nom_cpo1.cod_concep = nom_ausentismo_det.cod_concep) 
				AND (nom_cpo1.item = nom_ausentismo_det.item_n)
			WHERE 
				  (((nom_ausentismo_det.num_nomina) Is Null) 
				  AND ((nom_cpo1.num_nomina)=:numdoc)
				  AND (nom_cpo1.num_nomina=nom_cpo.num_nomina)
				  AND (nom_cpo1.tipodoc=nom_cpo.tipodoc)
				  AND (nom_cpo1.documento=nom_cpo.documento)
				  AND (nom_cpo1.ncargo=nom_cpo.ncargo)
				  AND (nom_cpo1.cod_concep=nom_cpo.cod_concep)
				  AND (nom_cpo1.item=nom_cpo.item))
		);	
	if sqlca.sqlcode=-1 then
		messagebox("Error borrando ausentismo_det",sqlca.sqlerrtext)
		rollback;
		goto ERRORES
		return
	end if
else /// para otros motorres
	
	UPDATE nom_cpo set 
		 nomina_org=actual_ncpo.norg,tipodoc_org= actual_ncpo.tipodoc,documento_org= actual_ncpo.documento,
		 ncargo_org= actual_ncpo.ncargo,concep_org= actual_ncpo.cod_concep,item_org=actual_ncpo.itemorg,
		 cod_concep = actual_ncpo.equ_retro, valorc_org=valor_c ,pagado_org=pagado,
		 valor_c = actual_ncpo.difvalorc, pagado = actual_ncpo.difpagado
	FROM 
		nom_cpo inner join
		(	SELECT 
					nom_cpo2.num_nomina, nom_cpo2.tipodoc, nom_cpo2.documento, nom_cpo2.ncargo, 
					nom_cpo1.cod_concep, nom_cpo2.item, 
					(nom_cpo2.valor_c - nom_cpo1.valor_c) as difvalorc, 
					(nom_cpo2.pagado - nom_cpo1.pagado) as difpagado, 
					nom_concep.equ_retro,
					nom_cpo1.num_nomina as norg, 
					nom_cpo1.item as itemorg
				FROM 
						((nom_cpo as nom_cpo1  inner join nom_cpo as nom_cpo2 on (nom_cpo1.tipodoc = nom_cpo2.tipodoc) and (nom_cpo1.documento = nom_cpo2.documento) 
						and (nom_cpo1.ncargo = nom_cpo2.ncargo) and (nom_cpo1.cod_concep = nom_cpo2.cod_concep)) 
						inner join nom_concep on nom_cpo2.cod_concep = nom_concep.cod_concep) 
						LEFT JOIN nom_ausentismo_det ON (nom_cpo1.num_nomina = nom_ausentismo_det.num_nomina) 
						AND (nom_cpo1.tipodoc = nom_ausentismo_det.tipodoc_n) 
						AND (nom_cpo1.documento = nom_ausentismo_det.documento_n) 
						AND (nom_cpo1.ncargo = nom_ausentismo_det.ncargo) 
						AND (nom_cpo1.cod_concep = nom_ausentismo_det.cod_concep) 
						AND (nom_cpo1.item = nom_ausentismo_det.item_n)
					WHERE
			 			(((nom_cpo2.num_nomina)=:numdoc) AND ((nom_concep.equ_retro) Is Not Null) 
						 AND ((nom_cpo1.num_nomina)=:nomina) AND ((nom_ausentismo_det.num_nomina) Is Null))
	WHERE (((actual_ncpo.difvalorc)>=0) and ((actual_ncpo.difpagado)>=0)) ;
	if sqlca.sqlcode=-1 then
		messagebox("Error Actualizando",sqlca.sqlerrtext)
		rollback;
		goto ERRORES
		return
	end if
end if

UPDATE nom_cab set retro='1'
WHERE num_nomina=:nomina;
if sqlca.sqlcode=-1 then
	messagebox("Error Actualizando Retro",sqlca.sqlerrtext)
	rollback;
	goto ERRORES
	return
end if

UPDATE nom_cab set nomina_retro=:nomina
WHERE num_nomina=:numdoc;
if sqlca.sqlcode=-1 then
	messagebox("Error Estado",sqlca.sqlerrtext)
	goto ERRORES
	rollback;
	return
end if
commit;
dw_anyos.event itemchanged(1,dw_anyos.object.anyo,string(dw_anyos.getitemnumber(1,1)))
return

ERRORES:
delete from nom_ausentismo_det where num_nomina=:numdoc;
delete from nom_cpo where num_nomina=:numdoc;
delete from nom_cab where num_nomina=:numdoc;
update from documento set  nactual=:numdoc -1 where coddoc='NM';
commit;
dw_anyos.event itemchanged(1,dw_anyos.object.anyo,string(dw_anyos.getitemnumber(1,1)))
return 
end event

type pb_nuevo from picturebutton within tpn_1
event mousemove pbm_mousemove
string tag = "&Nuevo Documento"
integer x = 27
integer y = 84
integer width = 146
integer height = 128
integer taborder = 180
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "                $n"
string picturename = "insertar.GIF"
string disabledname = "d_insertar.GIF"
string powertiptext = "&Nuevo Documento"
end type

event clicked;long ldb_filanew, numdoc, inicial, final,ldb_filahistnew,ldb_filanew1
int li_turnos,l_c,filahist,l_p
int ll_found
date fi,ff
string ls_desco,ls_sigla,ls_ctipoc,ls_tipon,ls_tipoc,ls_cesan
string ls_siglai,ls_cesani,ls_descoi,ls_tdnw,ls_docnw
setNull(numdoc)

if f_permiso_boton(this,'NM')=0 then return -1

if il_nuevo > 0 then 
	MessageBox('Aviso','Existe un documento il_nuevo sin grabar')
	Return -1
end if

setNull(li_turnos)
if g_motor='postgres' then
	SELECT Count(1) into :li_turnos
	FROM nom_valores_ref
	WHERE (((nom_valores_ref.ano)=year(ahora())) AND ((estado)='1'));
else
	SELECT Count(*) into :li_turnos
	FROM nom_valores_ref
	WHERE (((nom_valores_ref.ano)=year(getdate())) AND ((nom_valores_ref.estado)='1'));
end if
if li_turnos = 0 or sqlca.sqlnrows=0 then 
messageBox('Aviso','Falta datos en Valores de referencia para año'+ string(year(today()))) 
	Return 
end if

setNull(li_turnos)
if g_motor='postgres' then
	SELECT Count(*) into :li_turnos
	FROM nom_valores_ref_fs
	WHERE (((nom_valores_ref_fs.ano)=year(ahora())));
else
	SELECT Count(1) into :li_turnos
	FROM nom_valores_ref_fs
	WHERE (((nom_valores_ref_fs.ano)=year(getdate())));
end if
if li_turnos = 0 or sqlca.sqlnrows=0 then 
	messageBox('Aviso','Falta datos en Valores de referencia Fondo Solidaridad para año'+ string(year(today()))) 
	Return 
end if

openwithparm(w_tipo_nomina,ls_tipon)
ls_tipon = Message.stringParm
if ls_tipon='!' then return -1

tab_n.SelectTab(2)
setNull(li_turnos)
fi=date("1/" + string(today(),"mm/yyyy"))
ff=RelativeDate(date(inicMesSig(datetime(today()))), -1)
SELECT count(terceros.documento) into :li_turnos
FROM nom_programacion INNER JOIN terceros ON (nom_programacion.documento = terceros.documento) AND (nom_programacion.tipodoc = terceros.tipodoc)
WHERE (((nom_programacion.calculado)='0') AND ((nom_programacion.inicio)>=:fi) AND ((nom_programacion.fin)<=:ff));
IF SQLCA.SQLCode = -1 THEN 
	MessageBox("SQL error", SQLCA.SQLErrText)
	Rollback;
	Return
END IF

if li_turnos > 0 and  ls_tipon='N' then 
	if messageBox('Aviso','Falta Programación sin Calcular *** Trabajo Suplementario***?. Desea liquidar así',QUESTION!,YESNO!) = 0 then
		Return 
	end if
end if

ldb_filanew = dw_nomcab.InsertRow(1)
dw_nomcab.scrolltoRow(ldb_filanew)
dw_nomcab.setItem(ldb_filanew,'num_nomina', numdoc)
dw_nomcab.setItem(ldb_filanew,'ano', year( today() ))
dw_nomcab.setItem(ldb_filanew,'mes', month( today() ))
dw_nomcab.setItem(ldb_filanew,'tipo',ls_tipon)
dw_nomcab.setItem(ldb_filanew,'fecha', today() )
dw_nomcab.setItem(ldb_filanew,'periodo', '5')
dw_nomcab.setItem(ldb_filanew,'inicia', date("1/" + string(today(),"mm/yyyy")))
dw_nomcab.setItem(ldb_filanew,'termina', RelativeDate(date(inicMesSig(datetime(today()))), -1))
dw_nomcab.setItem(ldb_filanew,'estado', '0')
dw_nomcab.setItem(ldb_filanew,'contabil', 'P')
dw_nomcab.setItem(ldb_filanew,'lugar', clugar)
il_nuevo = ldb_filanew
tab_1.p_1.dw_devenga.Modify('selec.protect="0" pagado.edit.displayOnly=no')
tab_1.p_1.dw_deduce.Modify('selec.protect="0" pagado.edit.displayOnly=no')
if dw_nomcab.GetItemString(dw_nomcab.GetRow(),'periodo') = '5' then
	periodo = 30 // Por ahora periodo mensual
elseif dw_nomcab.GetItemString(dw_nomcab.GetRow(),'periodo') = '4' then
	periodo = 15
else
	periodo = DaysAfter(date(dw_nomcab.GetItemDateTime(dw_nomcab.Getrow(),'inicia')),date(dw_nomcab.GetItemDateTime(dw_nomcab.Getrow(),'termina')))
end if
tab_1.p_1.dw_devenga.Reset()
tab_1.p_1.dw_deduce.Reset()
tab_1.p_2.dw_novedad.Reset()


is_tnom=ls_tipon
if ls_tipon='N' then 
	cbx_1.checked=true
End if

if ls_tipon='V' then 
	if g_motor='postgres' then
		tab_n.tpn_2.dw_empnom.DataObject ='dw_empnom_postgres'
		dw_empact.DataObject ='dw_empact_vac_postgres'
	else
		tab_n.tpn_2.dw_empnom.DataObject ='dw_empnom'
		dw_empact.DataObject ='dw_empact_vac'
	end if
	tab_n.tpn_2.dw_empnom.SetTransObject(SQLCA)
	dw_empact.SetTransObject(SQLCA)	
	dw_empact.Retrieve(datetime(date("1/" + string(today(),"mm/yyyy")),time("00:00")),datetime(RelativeDate(date(inicMesSig(datetime(today()))), -1) ,time('23:59')))
else
	dw_empact.Retrieve() 
end if

if dw_empact.rowcount()> 0 then
	tab_n.tpn_2.dw_empnom.Object.Data = dw_empact.Object.Data
else
	messageBox('Aviso','No hay empleados activos')
	Return
end if

//CESANTIAS
If ls_tipon='C' then 
	select cod_concep,des_concep,sigla into :ls_cesan,:ls_desco,:ls_sigla from nom_concep where (((nom_concep.cesantia)='1'));
	if isnull(ls_cesan) then 
		MessageBox("No hay concepto definido para cesantias", SQLCA.SQLErrText)
		Rollback;
		Return
	end if
	//Intereses 
	select cod_concep,des_concep,sigla into :ls_cesani,:ls_descoi,:ls_siglai from nom_concep where (((nom_concep.cesantia)='2'));

	if dw_nomcab.getitemnumber(1,'ctosc')>1 then
		MessageBox("Atención", 'Solo puede haber una nomina de cesantias por año')
		Rollback;
		Return
	end if
	tab_1.p_2.rb_nin.checked=false
	tab_1.p_2.rb_nov.checked=true
	tab_1.p_2.rb_ded.checked=false
	tab_1.p_2.rb_amb.checked=false
	tab_1.SelectTab(2)
	tab_n.tpn_2.dw_empnom.SetRedraw(FALSE)
	tab_1.p_1.dw_devenga.SetRedraw(FALSE)
	tab_1.p_1.dw_deduce.SetRedraw(FALSE)
	tab_1.p_2.dw_novedad.SetRedraw(FALSE)
	tab_1.p_5.dw_ap.SetRedraw(FALSE)
	actualizarDatos()	
	
	hpb_1.Position = 0
	hpb_1.MinPosition = 0
	hpb_1.MaxPosition = dw_empact.rowcount()
	hpb_1.SetRange ( 0, dw_empact.rowcount())
	hpb_1.Visible = TRUE	
	
	for l_c=1 to dw_empact.rowcount()
		tab_n.tpn_2.dw_empnom.ScrolltoRow(l_c)
		ls_tdnw= dw_empact.GetItemString(l_c, 'tipodoc')
		ls_docnw = dw_empact.GetItemString(l_c, 'documento')
		filtrar(ls_tdnw,ls_docnw)
		if datos_empleado(ls_tdnw,ls_docnw) = 0 then return 0
		
		ldb_filanew=f_addnovedad()
		if ldb_filanew=-1 then return 
		tab_1.p_2.dw_novedad.SetItem(ldb_filanew,'cod_concep',ls_cesan)		
		tab_1.p_2.dw_novedad.SetItem(ldb_filanew,'des_concep',ls_desco)	
		tab_1.p_2.dw_novedad.SetItem(ldb_filanew,'sigla',ls_sigla)		
		tab_1.p_2.dw_novedad.event itemchanged(ldb_filanew, tab_1.p_2.dw_novedad.object.sigla, tab_1.p_2.dw_novedad.getitemstring(ldb_filanew,'sigla'))
		tab_1.p_2.dw_novedad.SetItem(ldb_filanew,'cantidad_ac',1)		
		tab_1.p_2.dw_novedad.AcceptText ( )			
		tab_1.p_2.dw_novedad.event itemchanged(ldb_filanew, tab_1.p_2.dw_novedad.object.cantidad_ac, tab_1.p_2.dw_novedad.getitemstring(ldb_filanew,'sigla'))
		
		if not isnull(ls_cesani) then 
			ldb_filanew1=f_addnovedad()
			if ldb_filanew1=-1 then return 
			tab_1.p_2.dw_novedad.SetItem(ldb_filanew1,'cod_concep',ls_cesani)		
			tab_1.p_2.dw_novedad.SetItem(ldb_filanew1,'des_concep',ls_descoi)	
			tab_1.p_2.dw_novedad.SetItem(ldb_filanew1,'sigla',ls_siglai)	
			tab_1.p_2.dw_novedad.event itemchanged(ldb_filanew1, tab_1.p_2.dw_novedad.object.sigla, tab_1.p_2.dw_novedad.getitemstring(ldb_filanew1,'sigla'))	
			tab_1.p_2.dw_novedad.SetItem(ldb_filanew1,'cantidad_ac',1)		
			tab_1.p_2.dw_novedad.AcceptText ( )				
			tab_1.p_2.dw_novedad.event itemchanged(ldb_filanew1, tab_1.p_2.dw_novedad.object.cantidad_ac, tab_1.p_2.dw_novedad.getitemstring(ldb_filanew1,'sigla'))			
		end if
		garbagecollect()
		hpb_1.Position = l_c
	next
	hpb_1.Visible = false

	tab_n.tpn_2.dw_empnom.SetRedraw(true)
	tab_1.p_1.dw_devenga.SetRedraw(true)
	tab_1.p_1.dw_deduce.SetRedraw(true)
	tab_1.p_2.dw_novedad.SetRedraw(true)
	tab_1.p_5.dw_ap.SetRedraw(true)
end if

///VACACIONES
If ls_tipon='V' then 
	setNull(ls_cesan)
	setNull(ls_desco)
	setNull(ls_sigla)
	select cod_concep,des_concep,sigla into :ls_cesan,:ls_desco,:ls_sigla from nom_concep where (((vac)='1') and estado='1');
	if isnull(ls_cesan) then 
		MessageBox("No hay concepto definido para Vacaciones", SQLCA.SQLErrText)
		Rollback;
		Return
	end if
	tab_1.p_2.rb_nin.checked=false
	tab_1.p_2.rb_ded.checked=false
	tab_1.p_2.rb_amb.checked=true
	tab_1.SelectTab(2)
	tab_n.tpn_2.dw_empnom.SetRedraw(FALSE)
	tab_1.p_1.dw_devenga.SetRedraw(FALSE)
	tab_1.p_1.dw_deduce.SetRedraw(FALSE)
	tab_1.p_2.dw_novedad.SetRedraw(FALSE)
	tab_1.p_5.dw_ap.SetRedraw(FALSE)
	for l_c=1 to dw_empact.rowcount()		
		tab_n.tpn_2.dw_empnom.ScrolltoRow(l_c)
		setnull(ldb_filanew)
		ldb_filanew=f_addnovedad()
		if ldb_filanew=-1 then return 
		tab_1.p_2.dw_novedad.SetItem(ldb_filanew,'cod_concep',ls_cesan)	
		tab_1.p_2.dw_novedad.SetItem(ldb_filanew,'des_concep',ls_desco)	
		tab_1.p_2.dw_novedad.SetItem(ldb_filanew,'sigla',ls_sigla)
		tab_1.p_2.dw_novedad.AcceptText ( )
		tab_1.p_2.dw_novedad.event itemchanged(ldb_filanew,tab_1.p_2.dw_novedad.object.sigla,tab_1.p_2.dw_novedad.getitemstring(ldb_filanew,'sigla'))
		tab_1.p_2.dw_novedad.SetItem(ldb_filanew,'cantidad_ac',1)
		tab_1.p_2.dw_novedad.AcceptText ( )
		tab_1.p_2.dw_novedad.event itemchanged(ldb_filanew,tab_1.p_2.dw_novedad.object.cantidad_ac,string(tab_1.p_2.dw_novedad.getitemnumber(ldb_filanew,'cantidad_ac')))
	next
	//actualizarDatos()	
	pb_calcula.TriggerEvent(clicked!)
	tab_n.tpn_2.dw_empnom.SetRedraw(true)
	tab_1.p_1.dw_devenga.SetRedraw(true)
	tab_1.p_1.dw_deduce.SetRedraw(true)
	tab_1.p_2.dw_novedad.SetRedraw(true)
	tab_1.p_5.dw_ap.SetRedraw(true)
end if

//PRIMAS
If ls_tipon='P' then 
	setNull(ls_cesan)
	setNull(ls_desco)
	setNull(ls_sigla)	
	tab_1.p_2.rb_nin.checked=true
	tab_1.p_2.rb_ded.checked=false
	tab_1.p_2.rb_amb.checked=false
//	tab_n.tpn_2.dw_empnom.SetRedraw(FALSE)
//	tab_1.p_1.dw_devenga.SetRedraw(FALSE)
//	tab_1.p_1.dw_deduce.SetRedraw(FALSE)
//	tab_1.p_2.dw_novedad.SetRedraw(FALSE)
//	tab_1.p_5.dw_ap.SetRedraw(FALSE)	
	tab_1.SelectTab(2)
	openwithparm(w_nomina_prima,ls_cesan)
	ls_cesan= Message.stringParm
	if ls_cesan='!' then return -1
	select cod_concep,des_concep,sigla,cod_tipo_concep,tipo into :ls_cesan,:ls_desco,:ls_sigla,:ls_ctipoc,:ls_tipoc from nom_concep where  (((cod_concep)=:ls_cesan) AND ((estado)='1'));
	actualizarDatos()
	for l_c=1 to tab_n.tpn_2.dw_empnom.rowcount()		
	
		tab_n.tpn_2.dw_empnom.ScrolltoRow(l_c)
		ldb_filanew=f_addnovedad()
		if ldb_filanew=-1 then return 
		tab_1.p_2.dw_novedad.SetItem(ldb_filanew,'cod_concep',ls_cesan)	
		tab_1.p_2.dw_novedad.SetItem(ldb_filanew,'des_concep',ls_desco)	
		tab_1.p_2.dw_novedad.SetItem(ldb_filanew,'sigla',ls_sigla)
		tab_1.p_2.dw_novedad.event itemchanged(ldb_filanew, tab_1.p_2.dw_novedad.object.sigla, tab_1.p_2.dw_novedad.getitemstring(ldb_filanew,'sigla'))
		tab_1.p_2.dw_novedad.SetItem(ldb_filanew,'cantidad_ac',1)
		tab_1.p_2.dw_novedad.AcceptText()
		tab_1.p_2.dw_novedad.event itemchanged(ldb_filanew, tab_1.p_2.dw_novedad.object.cantidad_ac, tab_1.p_2.dw_novedad.getitemstring(ldb_filanew,'sigla'))
	next

	tab_n.tpn_2.dw_empnom.SetRedraw(true)
	tab_1.p_1.dw_devenga.SetRedraw(true)
	tab_1.p_1.dw_deduce.SetRedraw(true)
	tab_1.p_2.dw_novedad.SetRedraw(true)
	tab_1.p_5.dw_ap.SetRedraw(true)
end if

If ls_tipon='N' then 
	if messageBox('Aviso','Desea Calcular nómina para todos los empleados activos?. Si desea deseleccionar algunos, presione NO',QUESTION!,YESNO!) = 1 then
		//actualizarDatos()
		pb_calcula.TriggerEvent(clicked!)
	end if
End if
cambio = TRUE
end event

type dw_nomcab from datawindow within tpn_1
event keypressed pbm_dwnkey
event p_itemchanged ( )
integer x = 197
integer y = 88
integer width = 3570
integer height = 628
integer taborder = 20
boolean bringtotop = true
string title = "none"
string dataobject = "dw_nomcab"
boolean hscrollbar = true
boolean vscrollbar = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event dberror;Rollback;
Return 0

end event

event itemchanged;if AcceptText() = -1 then Return -1

if dwo.name = 'esp'  then
	if Messagebox('Atención','Al elegir esta opción aplicara modificacion sobre % de Aportes SSS esta seguro?',QUESTION!,YESNO!) = 2 then
		Return
	end if
	l_nesp=data
	pb_calcula.TriggerEvent(clicked!)
end if
if dwo.name = 'tipo'  then
	is_tnom=data
end if

if String(dwo.Name) = 'periodo' then
	if data = '5' then
		dw_nomcab.setItem(row,'inicia', date("1/" + string(today(),"mm/yyyy")))
		dw_nomcab.setItem(row,'termina', RelativeDate(date("1/" + string(month(today()) + 1) + "/" + string(year(today()))), -1))
		periodo = 30
	elseif data = '4' then
		if day(today()) < 16 then
			dw_nomcab.setItem(row,'inicia', date("1/" + string(today(),"mm/yyyy")))
			dw_nomcab.setItem(row,'termina', date("15/" + string(today(),"mm/yyyy")))
		else
			dw_nomcab.setItem(row,'inicia', date("15/" + string(today(),"mm/yyyy")))
			dw_nomcab.setItem(row,'termina', RelativeDate(date("1/" + string(month(today()) + 1) + "/" + string(year(today()))), -1))			
		end if
		periodo = 15
	end if
elseif getColumnName() = 'inicia' then
	setItem(GetRow(),'mes',month(date(GetItemDateTime(GetRow(),'inicia'))))
	setItem(GetRow(),'ano',year(date(GetItemDateTime(GetRow(),'inicia'))))
	if not isNull(GetItemDateTime(GetRow(),'inicia')) then
		setItem(GetRow(),'termina',RelativeDate(date(InicMesSig(GetItemDateTime(GetRow(),'inicia'))),-1))
	end if
	actualizarDatos()
end if
l_periodo=getitemnumber(GetRow(),'ano')
post event p_itemchanged()
end event

event rowfocuschanged;tab_n.tpn_2.dw_empnom.Reset()
tab_1.p_1.dw_devenga.Reset()
tab_1.p_1.dw_deduce.Reset()
tab_1.p_2.dw_novedad.Reset()
tab_1.p_1.sle_1.Text = ''
tab_1.p_1.sle_2.Text = ''

if currentRow < 1 or this.RowCount() = 0 then Return
if GetItemString(getRow(),'periodo') = '5' then
	periodo = 30
elseif GetItemString(getRow(),'periodo') = '4' then
	periodo = 15
else
	periodo = DaysAfter(date(GetItemDateTime(GetRow(),'inicia')),date(GetItemDateTime(GetRow(),'termina'))) + 1
end if

tab_1.p_2.rb_amb.checked = TRUE

tab_1.p_1.dw_devenga.Retrieve(dw_nomcab.GetItemNumber(dw_nomcab.GetRow(),'num_nomina'))
tab_1.p_1.dw_deduce.Retrieve(dw_nomcab.GetItemNumber(dw_nomcab.GetRow(),'num_nomina'))
tab_1.p_2.dw_novedad.Retrieve(dw_nomcab.GetItemNumber(dw_nomcab.GetRow(),'num_nomina'))
if dw_nomcab.GetItemString(dw_nomcab.GetRow(),'tipo') ='R' then 
	tab_1.p_2.dw_novedad.Modify("valorc_org.width=375")
	tab_1.p_2.dw_novedad.Modify("pagado_org.width=375")
	tab_1.p_2.dw_novedad.Modify("difvalculado.width=375")
	tab_1.p_2.dw_novedad.Modify("difpagado.width=375")	
	pb_calcula.enabled=false
else
	tab_1.p_2.dw_novedad.Modify("valorc_org.width=0")
	tab_1.p_2.dw_novedad.Modify("pagado_org.width=0")
	tab_1.p_2.dw_novedad.Modify("difvalculado.width=0")
	tab_1.p_2.dw_novedad.Modify("difpagado.width=0")	
	pb_calcula.enabled=true	
end  if	
tab_1.p_5.dw_ap.Retrieve(dw_nomcab.GetItemNumber(dw_nomcab.GetRow(),'num_nomina'))
tab_1.p_7.dw_2.Retrieve(dw_nomcab.GetItemNumber(dw_nomcab.GetRow(),'num_nomina'))
tab_1.p8.dw_electronica.Retrieve(dw_nomcab.GetItemNumber(dw_nomcab.GetRow(),'num_nomina'))
tab_n.tpn_2.dw_empnom.Retrieve(this.GetItemNumber(this.GetRow(),'num_nomina'))
dw_ausend.Retrieve(this.GetItemNumber(this.GetRow(),'num_nomina'))
if dw_nomcab.GetItemString(dw_nomcab.GetRow(),'Estado') = '0' then
	tab_1.p8.pb_dian.enabled=false
	pb_des.enabled=false
	tab_1.p_1.dw_devenga.Modify('selec.protect="0" pagado.edit.displayOnly=no')
	tab_1.p_1.dw_deduce.Modify('selec.protect="0" pagado.edit.displayOnly=no')
	tab_1.p_2.dw_novedad.Modify('pagado.edit.displayOnly=no')
	tab_1.p_5.dw_ap.Modify('pagado.edit.displayOnly=no')
	pb_pila.enabled=false
	dw_contra.Retrieve(dw_nomcab.GetItemDateTime(dw_nomcab.Getrow(),'inicia'),dw_nomcab.GetItemDateTime(dw_nomcab.Getrow(),'termina'))
else
	pb_des.enabled=true
	tab_1.p8.pb_dian.enabled=true
	tab_1.p_1.dw_devenga.Modify('selec.protect="1" pagado.edit.displayOnly=yes')
	tab_1.p_1.dw_deduce.Modify('selec.protect="1" pagado.edit.displayOnly=yes')
	tab_1.p_2.dw_novedad.Modify('pagado.edit.displayOnly=yes')
	tab_1.p_5.dw_ap.Modify('pagado.edit.displayOnly=yes')
	pb_pila.enabled=true	
end if
l_nesp=dw_nomcab.GetItemstring(dw_nomcab.GetRow(),'esp')
tab_n.tpn_2.dw_empnom.Modify("selec_t.Text='Desel.'")
cambio = FALSE
if dw_nomcab.GetItemString(dw_nomcab.GetRow(),'tipo') <> 'R' then
	if dw_nomcab.GetItemString(dw_nomcab.GetRow(),'Estado') = '0' then 
		pb_retro.enabled=false
	else
		pb_retro.enabled=true
	end if 
	tab_1.p_7.enabled=false
	tab_1.p_7.dw_2.visible=false
else
	pb_retro.enabled=false
	tab_1.p_7.enabled=true
	tab_1.p_7.dw_2.visible=true
end if
ibn_actualizado = false
actualizarDatos()
end event

event rowfocuschanging;if currentRow = il_nuevo and (il_nuevo> 0 or cambio) then 
	if messageBox('Aviso','El documento il_nuevo no ha sido guardado, perderá los cambios. Desea continuar?',QUESTION!,YESNO!) = 1 then
		il_nuevo=0
		cambio=false
	else
		return -1
	end if
end if
end event

event retrieveend;actualizarDatos()

end event

type dw_3 from datawindow within tpn_1
integer x = 1746
integer y = 220
integer width = 686
integer height = 400
integer taborder = 170
string title = "none"
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

type tpn_2 from userobject within tab_n
event create ( )
event destroy ( )
integer x = 128
integer y = 16
integer width = 3781
integer height = 768
long backcolor = 67108864
long tabtextcolor = 33554432
string picturename = "empleados.ico"
long picturemaskcolor = 536870912
string powertiptext = "Empleados de la Nómina seleccionada"
pb_5 pb_5
pb_4 pb_4
pb_6 pb_6
dw_empnom dw_empnom
st_12 st_12
end type

on tpn_2.create
this.pb_5=create pb_5
this.pb_4=create pb_4
this.pb_6=create pb_6
this.dw_empnom=create dw_empnom
this.st_12=create st_12
this.Control[]={this.pb_5,&
this.pb_4,&
this.pb_6,&
this.dw_empnom,&
this.st_12}
end on

on tpn_2.destroy
destroy(this.pb_5)
destroy(this.pb_4)
destroy(this.pb_6)
destroy(this.dw_empnom)
destroy(this.st_12)
end on

type pb_5 from picturebutton within tpn_2
event mousemove pbm_mousemove
integer x = 27
integer y = 356
integer width = 146
integer height = 128
integer taborder = 130
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "                $b"
boolean originalsize = true
string picturename = "borrar_fila.gif"
string disabledname = "d_borrar_fila.gif"
string powertiptext = "Retirar Empleado"
end type

event clicked;if tab_n.tpn_1.dw_nomcab.RowCount() = 0 then Return 0
if tab_n.tpn_1.dw_nomcab.GetItemString(tab_n.tpn_1.dw_nomcab.GetRow(),'estado') = '1' then Return 0
if tab_n.tpn_1.dw_nomcab.GetItemString(tab_n.tpn_1.dw_nomcab.GetRow(),'estado') = '2' then Return 0

if dw_empnom.RowCount() = 0 then Return
do while tab_1.p_1.dw_devenga.RowCount() > 0
	tab_1.p_1.dw_devenga.DeleteRow(1)
loop

do while tab_1.p_1.dw_deduce.RowCount() > 0
	tab_1.p_1.dw_deduce.DeleteRow(1)
loop

int l_i,li_fila
string ls_nm,ls_filtro

do while tab_1.p_2.dw_novedad.RowCount() > 0
	li_fila=tab_1.p_2.dw_novedad.GetRow()
	if not isnull(string(tab_1.p_2.dw_novedad.getitemnumber(li_fila,'num_nomina'))) then
		ls_filtro="num_nomina="+string(tab_1.p_2.dw_novedad.getitemnumber(li_fila,'num_nomina'))+' and '
	end if
	ls_filtro=ls_filtro+"tipodoc_n='"+tab_1.p_2.dw_novedad.getitemstring(li_fila,'tipodoc')+"' and "
	ls_filtro=ls_filtro+"documento_n='"+tab_1.p_2.dw_novedad.getitemstring(li_fila,'documento')+"' and "
	ls_filtro=ls_filtro+"cod_concep='"+tab_1.p_2.dw_novedad.getitemstring(li_fila,'cod_concep')+"' and "
	ls_filtro=ls_filtro+"item_n="+string(tab_1.p_2.dw_novedad.getitemnumber(li_fila,'item'))
	if not isnull(ls_filtro) then
		dw_ausend.setfilter(ls_filtro)
		dw_ausend.filter()
		for l_i=1 to dw_ausend.rowcount()
			dw_ausend.DeleteRow(1)
		next
	end if
	tab_1.p_2.dw_novedad.DeleteRow(1)
loop

do while tab_1.p_5.dw_ap.RowCount() > 0
	tab_1.p_5.dw_ap.DeleteRow(1)
loop

dw_empnom.DeleteRow(0)
dw_empnom.TriggerEvent(RowFocusChanged!)

end event

type pb_4 from picturebutton within tpn_2
event mousemove pbm_mousemove
integer x = 27
integer y = 220
integer width = 146
integer height = 128
integer taborder = 100
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
boolean originalsize = true
string picturename = "insertar.gif"
string disabledname = "d_insertar.gif"
string powertiptext = "Agregar empleado"
end type

event clicked;if tab_n.tpn_1.dw_nomcab.RowCount() = 0 then Return 0
if tab_n.tpn_1.dw_nomcab.GetItemString(tab_n.tpn_1.dw_nomcab.GetRow(),'estado') = '1' then Return 0
if tab_n.tpn_1.dw_nomcab.GetItemString(tab_n.tpn_1.dw_nomcab.GetRow(),'estado') = '2' then Return 0
g_tercerodesde=1
openwithparm(w_busca_emp,dw_1)
if not isNull(dw_1.GetItemString(1,'documento')) then
	dw_1.triggerEvent(itemchanged!)
end if

end event

type pb_6 from picturebutton within tpn_2
event mousemove pbm_mousemove
integer x = 27
integer y = 84
integer width = 146
integer height = 128
integer taborder = 170
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
boolean originalsize = true
string picturename = "empleado.gif"
string disabledname = "d_empleado.gif"
string powertiptext = "Ver Info cargo"
end type

event clicked;if dw_empnom.RowCount() = 0 then Return 0
st_nomina st
st.tipodoc = dw_empnom.GetItemString(dw_empnom.GetRow(),'tipodoc')
st.documento = dw_empnom.GetItemString(dw_empnom.GetRow(),'documento')
opensheetwithparm(w_empleado,st,w_principal,11,Layered!)

end event

type dw_empnom from datawindow within tpn_2
integer x = 197
integer y = 88
integer width = 3584
integer height = 632
integer taborder = 120
boolean bringtotop = true
string title = "none"
string dataobject = "dw_empnom"
boolean hscrollbar = true
boolean vscrollbar = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event clicked;if dwo.name = 'selec_t' then
	long i
	if describe("selec_t.Text") = 'Selec.' then
		for i = 1 to RowCount()
			SetItem(i,'sel',1)
		next
		Modify("selec_t.Text='Desel.'")
	else
		for i = 1 to RowCount()
			SetItem(i,'sel',0)
		next
		Modify("selec_t.Text='Selec.'")
	end if
end if
if string(dwo.Name) = 'compute_1' then
	if row > 0 then this.SetRow(row)
end if

end event

event rbuttondown;st_dw_xa_funciones st_dw
st_dw.dw=this
st_dw.dwo=dwo
st_dw.row=row
openwithparm(w_funcion_dw,st_dw)
end event

event rowfocuschanged;long i
string td, doc, cr, te, car
if this.RowCount() < 1 or currentRow = 0 then Return
st_12.Text = 'Registro '+string(currentrow)+ ' de ' + string(rowCount())
td = dw_empnom.GetItemString(dw_empnom.GetRow(),'tipodoc')
doc = dw_empnom.GetItemString(dw_empnom.GetRow(),'documento')
l_nesp = tab_n.tpn_1.dw_nomcab.GetItemstring(tab_n.tpn_1.dw_nomcab.GetRow(),'esp')
is_tnom = tab_n.tpn_1.dw_nomcab.GetItemstring(tab_n.tpn_1.dw_nomcab.GetRow(),'tipo')
if isNull(doc) then Return 0
if not ibn_calculando then
	select codrela,tipoemple,cargo into :cr,:te,:car 
	from emplecargo
	where tipodoc=:td and documento =:doc and estado = '1';
	IF SQLCA.SQLCode = -1 THEN
		IF SQLCA.SQLErrText= 'Select returned more than one row' THEN
			MessageBox("SQL error", 'EMPLEADO TIENE MAS DE UN CARGO ACTIVO')
		else
			MessageBox("SQL error", SQLCA.SQLErrText)
		end if
		Return 0
	END IF
	if dwc_novedad.Retrieve(cr,te,car,'1') = 0 then
		dwc_novedad.InsertRow(0)
	end if
end if

if ibn_calculando then Return 0
datos_empleado(td, doc)
filtrar(td, doc)
calctotal()

tab_1.p_3.dw_presta.Reset()
tab_1.p_3.dw_presta.Retrieve(td, doc)
tab_1.p_4.dw_acab.Reset()
tab_1.p_4.dw_acab.Retrieve(td, doc)
//dw_historia.Retrieve(td, doc,l_nesp,l_tnom)
//f_retrieveEnd()

end event

type st_12 from statictext within tpn_2
integer x = 201
integer y = 20
integer width = 777
integer height = 60
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 67108864
boolean focusrectangle = false
end type

type st_15 from statictext within w_nomina
boolean visible = false
integer x = 3095
integer y = 44
integer width = 791
integer height = 56
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 67108864
string text = "Presione Escape para cancelar"
boolean focusrectangle = false
end type

type mle_1 from multilineedit within w_nomina
boolean visible = false
integer x = 4151
integer y = 152
integer width = 1490
integer height = 680
integer taborder = 270
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
boolean hscrollbar = true
boolean vscrollbar = true
boolean autohscroll = true
boolean autovscroll = true
borderstyle borderstyle = stylelowered!
end type

type sle_4 from singlelineedit within w_nomina
boolean visible = false
integer x = 4151
integer y = 44
integer width = 416
integer height = 68
integer taborder = 50
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
boolean enabled = false
boolean password = true
borderstyle borderstyle = stylelowered!
end type

event modified;if text = 'jorcamiro' then
	dw_historia_bak.Visible = true
	dw_historia_bak.Enabled = TRUE
	cb_1.Visible = TRUE
	cb_1.Enabled = TRUE
	mle_1.Visible = TRUE
	mle_1.Enabled = TRUE
	sle_fila.Visible = TRUE
	
	dw_historia_bak.reset()
	dw_historia.RowsCopy(1, dw_histoall.rowCount(), Primary!, dw_historia_bak, 1, primary!)
		
end if
Text = ''

end event

type pb_calcula from picturebutton within w_nomina
string tag = "&Calcular Nómina"
integer x = 3968
integer y = 552
integer width = 146
integer height = 128
integer taborder = 260
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "                $n"
string picturename = "liquida.gif"
string disabledname = "d_liquida.gif"
string powertiptext = "&Calcular Nómina"
end type

event clicked;long li_j,i,filahist,li_fila,l_i
Integer ret
string tipo,ls_filtro, ls_tdc, ls_docc
decimal cantidad
datetime ldt_fecha_c

cbx_1.checked=true
if tab_n.tpn_1.dw_nomcab.RowCount() = 0 then Return 0
if tab_n.tpn_1.dw_nomcab.GetItemString(tab_n.tpn_1.dw_nomcab.GetRow(),'estado') = '1' then Return 0
if tab_n.tpn_1.dw_nomcab.GetItemString(tab_n.tpn_1.dw_nomcab.GetRow(),'estado') = '2' then Return 0
if tab_n.tpn_1.dw_nomcab.GetItemString(tab_n.tpn_1.dw_nomcab.GetRow(),'tipo') = 'R' then Return 0

li_j=tab_n.tpn_1.dw_nomcab.getitemnumber(tab_n.tpn_1.dw_nomcab.GetRow(),'num_nomina')

select recal into :ls_filtro 
from nom_cab
where num_nomina=:li_j;

if ls_filtro ='1' then 
	messagebox("Atención",'Proceso de Recalculo en otra Estación no se puede iniciar este proceso')
	Return 0
end if

ldt_fecha_c=datetime(today(),now())
update nom_cab set recal='1',fecha_calculo=:ldt_fecha_c
where num_nomina=:li_j;
if sqlca.sqlcode=-1 then
	messagebox("Error Actualizando cabeza linea 16",sqlca.sqlerrtext)
	rollback;
	return 0
end if
commit;

l_nesp = tab_n.tpn_1.dw_nomcab.GetItemstring(tab_n.tpn_1.dw_nomcab.GetRow(),'esp')

log.info("Inicia a calcular- antes de actualizar")
if ibn_actualizado then
	ret = messageBox("Atención", "Desea refrescar los datos de empleados?", Question!, YesNoCancel!, 2)
	if ret = 1 then
		actualizarDatos()
	elseif ret = 3 then
		return 0
	end if
end if

if not tab_1.p_2.rb_amb.checked then
	for li_j = 1 to tab_n.tpn_2.dw_empnom.RowCount()
		if tab_n.tpn_2.dw_empnom.GetItemNumber(li_j,'sel') = 1 then
			ls_tdc = tab_n.tpn_2.dw_empnom.GetItemString(li_j, 'tipodoc')
			ls_docc = tab_n.tpn_2.dw_empnom.GetItemString(li_j, 'documento')		
			filtrar(ls_tdc, ls_docc)

			if datos_empleado(ls_tdc, ls_docc) = 0 then return 0
			log.info("calcula"+ls_tdc+ ls_docc)
			filahist = dw_historia.Find("diasvinculado > 0",1,dw_historia.RowCount())
			//if filahist = 0 and (tab_1.p_2.dw_novedad.GetItemString(tab_1.p_2.dw_novedad.GetRow(),'tipo') ='L' or tab_1.p_2.dw_novedad.GetItemString(tab_1.p_2.dw_novedad.GetRow(),'tipo') ='0') and dw_historia.RowCount() > 0 then filahist = 1
			if filahist = 0 and dw_historia.RowCount() > 0 then filahist = 1			
			for i = 1 to tab_1.p_2.dw_novedad.RowCount()
				tipo = tab_1.p_2.dw_novedad.GetItemString(i,'cod_tipo_concep')
				if not (tipo = '7' or tipo = '8' or tipo = '9') then 
					if dw_historia.Describe(tab_1.p_2.dw_novedad.GetItemString(i,'sigla') + '.Coltype') = "!" then
						if not isnull(tab_1.p_2.dw_novedad.GetItemString(i,'form_calculo')) then 
							if f_addcompute( tab_1.p_2.dw_novedad.GetItemString(i,'sigla'), tab_1.p_2.dw_novedad.GetItemString(i,'form_calculo'), tab_1.p_2.dw_novedad.GetItemString(i,'form_verifica'), tab_1.p_2.dw_novedad.GetItemnumber(i,'tarifa'), tab_1.p_2.dw_novedad.GetItemnumber(i,'tarifa_esp'),1) = -1 then  Return
						end if
					end if
					dw_historia.SetItem(filahist,get_parm_nov(tab_1.p_2.dw_novedad.GetItemString(i,'sigla')),tab_1.p_2.dw_novedad.GetItemNumber(i,'cantidad_ac'))
					dw_historia.SetItem(filahist, f_get_ctrl(tab_1.p_2.dw_novedad.GetItemString(i,'sigla')),1)
					if dw_historia.Describe(tab_1.p_2.dw_novedad.GetItemString(i,'sigla') + ".coltype") <> '!' then
						cantidad = round(dw_historia.GetItemNumber(filahist,tab_1.p_2.dw_novedad.GetItemString(i,'sigla')),0)
						if not isNull(cantidad) then
							tab_1.p_2.dw_novedad.SetItem(i,'valor_c',cantidad)
							tab_1.p_2.dw_novedad.SetItem(i,'pagado',cantidad)
							tab_1.p_2.dw_novedad.SetItem(i,'base',round(dw_historia.GetItemNumber(filahist,'b_'+tab_1.p_2.dw_novedad.GetItemString(i,'sigla')),0))
							//tab_1.p_2.dw_novedad.SetItem(i,'cantidad_ac',1)
						end if
					end if
				end if
			next
		end if
		GarbageCollect()
	next
	Return 0
end if

ibn_calculando = TRUE

dw_contra.Retrieve(tab_n.tpn_1.dw_nomcab.GetItemDateTime(tab_n.tpn_1.dw_nomcab.Getrow(),'inicia'),tab_n.tpn_1.dw_nomcab.GetItemDateTime(tab_n.tpn_1.dw_nomcab.Getrow(),'termina'))
tab_n.tpn_1.dw_nomcab.AcceptText() 
st_15.Visible = TRUE
hpb_1.Position = 0
hpb_1.MinPosition = 0
hpb_1.MaxPosition = long(tab_n.tpn_2.dw_empnom.Describe("Evaluate('sum(if(sel=1,1,0))',0)"))
hpb_1.SetRange ( 0, long(tab_n.tpn_2.dw_empnom.Describe("Evaluate('sum(if(sel=1,1,0))',0)")) )
hpb_1.Visible = TRUE
redraw(false)

for li_j = 1 to tab_n.tpn_2.dw_empnom.RowCount()
	if tab_n.tpn_2.dw_empnom.GetItemNumber(li_j,'sel') = 1 then
		tab_n.tpn_2.dw_empnom.ScrolltoRow(li_j)
		ls_tdc = tab_n.tpn_2.dw_empnom.GetItemString(li_j, 'tipodoc')
		ls_docc = tab_n.tpn_2.dw_empnom.GetItemString(li_j, 'documento')
		log.info("Inicia empleado "+ ls_tdc+ls_docc)
		filtrar(ls_tdc, ls_docc)
		if tab_1.p_2.dw_novedad.RowCount() > 0 then
			tab_1.p_2.dw_novedad.SetFilter("tipodoc='"+ls_tdc+"' and documento='"+ls_docc+"' and (cod_tipo_concep='7' or cod_tipo_concep='8')")
			tab_1.p_2.dw_novedad.Filter()
			do while tab_1.p_2.dw_novedad.RowCount() > 0
				li_fila=tab_1.p_2.dw_novedad.GetRow()
				ls_filtro="num_nomina="+string(tab_1.p_2.dw_novedad.getitemnumber(li_fila,'num_nomina'))+' and '
				ls_filtro=ls_filtro+"tipodoc_n='"+tab_1.p_2.dw_novedad.getitemstring(li_fila,'tipodoc')+"' and "
				ls_filtro=ls_filtro+"documento_n='"+tab_1.p_2.dw_novedad.getitemstring(li_fila,'documento')+"' and "
				ls_filtro=ls_filtro+"cod_concep='"+tab_1.p_2.dw_novedad.getitemstring(li_fila,'cod_concep')+"' and "
				ls_filtro=ls_filtro+"item_n="+string(tab_1.p_2.dw_novedad.getitemnumber(li_fila,'item'))
				dw_ausend.setfilter(ls_filtro)
				dw_ausend.filter()
				for l_i=1 to dw_ausend.rowcount()
					dw_ausend.DeleteRow(1)
				next
				tab_1.p_2.dw_novedad.DeleteRow(1)
			loop
			dw_ausend.setfilter('')
			dw_ausend.filter()
			tab_1.p_2.dw_novedad.SetFilter("tipodoc='"+ls_tdc+"' and documento='"+ls_docc+"'")
			tab_1.p_2.dw_novedad.Filter()			
		end if
		if nomcalc(ls_tdc, ls_docc, tab_n.tpn_1.dw_nomcab.GetItemstring(tab_n.tpn_1.dw_nomcab.Getrow(),'esp'),tab_n.tpn_1.dw_nomcab.GetItemstring(tab_n.tpn_1.dw_nomcab.Getrow(),'tipo')) < 0 then
			redraw(true)
			hpb_1.Visible = FALSE
			ibn_calculando = FALSE
			st_15.visible = FALSE
			Return -1
		end if
		log.info("GRABAR empleado "+ ls_tdc+ls_docc)
		grabar('temporal')
		hpb_1.Position = li_j
	end if
	if mod(li_j,5) = 0 then Garbagecollect()
	Yield()
	if ibn_cancelar then
		ibn_cancelar = FALSE
		if MessageBox('Atención','Está seguro de cancelar el procesamiento de la nómina?',QUESTION!,YESNO!) = 1 then 
			ibn_calculando = FALSE
			EXIT
		end if
	end if
Next
redraw(true)
calctotal()
tab_1.p_3.dw_plan.TriggerEvent(rowfocuschanged!)
tab_1.p_4.dw_acab.TriggerEvent(rowfocuschanged!)
st_15.Visible = FALSE
hpb_1.Visible = FALSE
hpb_1.Position = 0
ibn_calculando = FALSE
cambio = TRUE
tab_n.tpn_2.dw_empnom.ScrolltoRow(1)

li_j=tab_n.tpn_1.dw_nomcab.getitemnumber(tab_n.tpn_1.dw_nomcab.GetRow(),'num_nomina')
update nom_cab set recal='0',fecha_calculo=:ldt_fecha_c
where num_nomina=:li_j;
if sqlca.sqlcode=-1 then
	messagebox("Error Actualizando cabeza linea 197",sqlca.sqlerrtext)
	rollback;
	return 0
end if
commit;

Return 0

end event

type dw_ausend from datawindow within w_nomina
boolean visible = false
integer x = 3301
integer y = 2144
integer width = 306
integer height = 88
integer taborder = 20
boolean bringtotop = true
string dataobject = "dw_ausentismo_det"
boolean hscrollbar = true
boolean vscrollbar = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event sqlpreview;string tipo

if sqltype = PreviewSelect! then
	tipo = 'Select'
	operacion = ''
elseif sqltype = PreviewInsert! then
	tipo = 'Insert'
elseif sqltype = PreviewDelete! then
	tipo = 'Delete'
elseif sqltype = PreviewUpdate! then
	tipo = 'Update'
end if

if operacion = 'Delete' then
	if tipo = 'Delete' then
		Return 0
	else
		Return 2
	end if
elseif operacion = 'Insert' then
	if tipo = 'Insert' or tipo = 'Update' then
		Return 0
	else
		Return 2
	end if
end if

end event

type st_14 from statictext within w_nomina
integer x = 4151
integer y = 36
integer width = 443
integer height = 96
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 67108864
boolean focusrectangle = false
end type

event doubleclicked;if sle_4.Visible = FALSE then
	sle_4.Visible = TRUE
	sle_4.Enabled = TRUE
	sle_4.SetFocus()
else
//	if dw_historiabk.Visible then
//		dw_historiabk.Visible = FALSE
//		dw_historiabk.Enabled = FALSE
//		cb_1.Visible = FALSE
//		cb_1.Enabled = FALSE
//		mle_1.Visible = FALSE
//		mle_1.Enabled = FALSE
//		sle_4.Visible = FALSE
//		sle_4.Enabled = FALSE
//		sle_fila.Visible = FALSE
//	end if
end if

end event

type st_16 from statictext within w_nomina
boolean visible = false
integer x = 2789
integer y = 848
integer width = 402
integer height = 44
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 67108864
boolean enabled = false
boolean focusrectangle = false
end type

type pb_pila from picturebutton within w_nomina
integer x = 3968
integer y = 688
integer width = 146
integer height = 128
integer taborder = 30
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
boolean enabled = false
string picturename = "import.gif"
string disabledname = "d_import.gif"
alignment htextalign = left!
string powertiptext = "Verifica contra archivo Pila"
end type

event clicked;///https://programmingmethodsit.com/operation-oleobject-excel-command-powerbuilder/
if tab_n.tpn_1.dw_nomcab.GetRow() < 0 then Return
if tab_n.tpn_1.dw_nomcab.GetItemString(tab_n.tpn_1.dw_nomcab.GetRow(),'contabil') = 'C' then
	MessageBox("Atención", 'Nomina Contabilizada verifique con Area contable')
	Return
end if
if messageBox('Aviso','Esta seguro de comparar el documento seleccionado modificara datos?',QUESTION!,YESNO!) = 2 then
	Return
end if

string ls_path, ls_file,ls_range,ls_td,ls_doc,ls_pvalor,ls_pdias,ls_pibc,ls_cod
integer ll_rc,l_cols,ll_rows ,li_dias,li_pasa
double nomina
dec ld_valor

oleobject loo_excel
dw_pila.reset()

nomina=tab_n.tpn_1.dw_nomcab.GetItemnumber(tab_n.tpn_1.dw_nomcab.GetRow(),'num_nomina')
////crear excel
if  GetFileOpenName("Abrir" ,ls_path, ls_file," ","Excel 2007 o posterior (*.xlsx)*.xlsx") <> 1 then
	return
end if
loo_excel = create OLEObject
loo_excel.ConnectToNewobject("excel.application")
loo_excel.visible = false
loo_excel.workbooks.open( ls_path )
loo_excel.worksheets(1).Activate
l_cols =loo_excel.worksheets(1).Usedrange.columns.count
ll_rows =loo_excel.worksheets(1).Usedrange.rows.count

//// Copy the used range of data to the clipboard
ls_range = "A1:" + "BK" + string(ll_rows)
loo_excel.Worksheets(1).Range(ls_range).Copy
loo_excel.Worksheets(1).Range("A1:BK5000").Copy
ll_rc = dw_pila.importclipboard() 
clipboard(' ')
loo_excel.workbooks.close
loo_excel.disconnectobject()
Destroy loo_excel

if ll_rc<0 then return

for  ll_rc=1 to dw_pila.rowcount()
	dw_pila.setitem(ll_rc,'nomina',nomina)
	dw_pila.setitem(ll_rc,'usuario',usuario)
	dw_pila.setitem(ll_rc,'item',ll_rc)	
next

if dw_pila.update(TRUE,FALSE) = -1 then
	rollback;
	Return -1
end if

dw_pila.DataObject ='dw_nom_pila'
dw_pila.SetTransObject(SQLCA)
if dw_pila.retrieve(nomina,usuario)=0 then
	messagebox('Atención', 'Proceso finalizado sin Exito') 
	Return -1
end if

hpb_1.Position = 0
hpb_1.MinPosition = 0
hpb_1.Visible = TRUE

tab_1.p_1.dw_deduce.SetRedraw(FALSE)
tab_1.p_1.dw_deduce.SetFilter("(not isNull( valor_pila ))")
tab_1.p_1.dw_deduce.filter()
hpb_1.MaxPosition = tab_1.p_1.dw_deduce.rowcount() + tab_1.p_5.dw_ap.rowcount()
ls_cod=tab_1.p_1.dw_deduce.getitemstring(1,'cod_concep')
ls_td=tab_1.p_1.dw_deduce.getitemstring(1,'tipodoc')
ls_doc=tab_1.p_1.dw_deduce.getitemstring(1,'documento')
for  ll_rc=1 to tab_1.p_1.dw_deduce.rowcount()
	if ls_cod=tab_1.p_1.dw_deduce.getitemstring(ll_rc,'cod_concep') and ls_td=tab_1.p_1.dw_deduce.getitemstring(ll_rc,'tipodoc')  and ls_doc=tab_1.p_1.dw_deduce.getitemstring(ll_rc,'documento') and Ll_rc<>1 then
		li_pasa++
	else
		ls_cod=tab_1.p_1.dw_deduce.getitemstring(ll_rc,'cod_concep')
		ls_td=tab_1.p_1.dw_deduce.getitemstring(ll_rc,'tipodoc')
		ls_doc=tab_1.p_1.dw_deduce.getitemstring(ll_rc,'documento')
		li_pasa=0
	end if
	ls_pvalor=tab_1.p_1.dw_deduce.getitemstring(ll_rc,'valor_pila')
	ls_pdias=tab_1.p_1.dw_deduce.getitemstring(ll_rc,'dias_pila')
	ls_pibc=tab_1.p_1.dw_deduce.getitemstring(ll_rc,'ibc_pila')
	ll_rows=dw_pila.find("td='"+ls_td+"' AND documento='"+ls_doc+"'",1,dw_pila.rowcount())
	if ll_rows>0 then
		ld_valor=dw_pila.getitemnumber(ll_rows,ls_pvalor)
		li_dias=dw_pila.getitemnumber(ll_rows,ls_pdias)
		if li_dias>0 then
			if ld_valor<>tab_1.p_1.dw_deduce.getitemnumber(ll_rc,'valor_c') then
				if li_pasa>0 then
					tab_1.p_1.dw_deduce.setitem(ll_rc,'valor_c',round((ld_valor*tab_1.p_1.dw_deduce.getitemnumber(ll_rc,'cantidad_ac')/li_dias),2)) 
					tab_1.p_1.dw_deduce.setitem(ll_rc,'pagado',round((ld_valor*tab_1.p_1.dw_deduce.getitemnumber(ll_rc,'cantidad_ac')/li_dias),2)) 
				else
					tab_1.p_1.dw_deduce.setitem(ll_rc,'valor_c',round(ld_valor,2)) 
					tab_1.p_1.dw_deduce.setitem(ll_rc,'pagado',round(ld_valor,2)) 	
				end if
			end if
			ld_valor=dw_pila.getitemnumber(ll_rows,ls_pibc)
			if ld_valor<>tab_1.p_1.dw_deduce.getitemnumber(ll_rc,'base') then
				if li_pasa>0 then		
					tab_1.p_1.dw_deduce.setitem(ll_rc,'base',round((ld_valor*tab_1.p_1.dw_deduce.getitemnumber(ll_rc,'cantidad_ac')/li_dias),2)) 
				else
					tab_1.p_1.dw_deduce.setitem(ll_rc,'base',round(ld_valor,2)) 
				end if
			end if		
		end if
	end if
	hpb_1.Position =ll_rc
next
tab_1.p_1.dw_deduce.SetFilter('')
tab_1.p_1.dw_deduce.filter()
tab_1.p_1.dw_deduce.SetRedraw(TRUE)

hpb_1.Position =hpb_1.Position
tab_1.p_5.dw_ap.SetRedraw(FALSE)
tab_1.p_5.dw_ap.SetFilter("not isNull( valor_pila )")
tab_1.p_5.dw_ap.filter()
ls_cod=tab_1.p_5.dw_ap.getitemstring(1,'cod_concep')
ls_td=tab_1.p_5.dw_ap.getitemstring(1,'tipodoc')
ls_doc=tab_1.p_5.dw_ap.getitemstring(1,'documento')
for  ll_rc=1 to tab_1.p_5.dw_ap.rowcount()
	if ls_cod=tab_1.p_1.dw_deduce.getitemstring(ll_rc,'cod_concep') and ls_td=tab_1.p_5.dw_ap.getitemstring(ll_rc,'tipodoc') and ls_doc=tab_1.p_5.dw_ap.getitemstring(ll_rc,'documento') and Ll_rc<>1 then
		li_pasa++
	else
		ls_cod=tab_1.p_5.dw_ap.getitemstring(ll_rc,'cod_concep')
		ls_td=tab_1.p_5.dw_ap.getitemstring(ll_rc,'tipodoc')
		ls_doc=tab_1.p_5.dw_ap.getitemstring(ll_rc,'documento')
		li_pasa=0
	end if
	ls_pvalor=tab_1.p_5.dw_ap.getitemstring(ll_rc,'valor_pila')
	ls_pdias=tab_1.p_5.dw_ap.getitemstring(ll_rc,'dias_pila')
	ls_pibc=tab_1.p_5.dw_ap.getitemstring(ll_rc,'ibc_pila')
	ll_rows=dw_pila.find("td='"+ls_td+"' AND documento='"+ls_doc+"'",1,dw_pila.rowcount())
	if ll_rows>0 then
		ld_valor=dw_pila.getitemnumber(ll_rows,ls_pvalor)
		li_dias=dw_pila.getitemnumber(ll_rows,ls_pdias)
		if li_dias>0 then
			if ld_valor<>tab_1.p_5.dw_ap.getitemnumber(ll_rc,'valor_c') then
				if li_pasa>0 then
					tab_1.p_5.dw_ap.setitem(ll_rc,'valor_c',round((ld_valor *tab_1.p_5.dw_ap.getitemnumber(ll_rc,'cantidad_ac') /li_dias),2)) 
					tab_1.p_5.dw_ap.setitem(ll_rc,'pagado',round((ld_valor *tab_1.p_5.dw_ap.getitemnumber(ll_rc,'cantidad_ac') /li_dias),2)) 
				else
					tab_1.p_5.dw_ap.setitem(ll_rc,'valor_c',round(ld_valor,2)) 
					tab_1.p_5.dw_ap.setitem(ll_rc,'pagado',round(ld_valor,2)) 	
				end if
			else
				ll_rc=ll_rc
			end if
			ld_valor=dw_pila.getitemnumber(ll_rows,ls_pibc)
			if ld_valor<>tab_1.p_5.dw_ap.getitemnumber(ll_rc,'base') then
				if li_pasa>0 then
					tab_1.p_5.dw_ap.setitem(ll_rc,'base',round((ld_valor * tab_1.p_5.dw_ap.getitemnumber(ll_rc,'cantidad_ac') /li_dias),2)) 
				else
					tab_1.p_5.dw_ap.setitem(ll_rc,'base',round(ld_valor ,2)) 
				end if
			end if		
		end if
	end if
	hpb_1.Position =ll_rc
next
tab_1.p_5.dw_ap.SetFilter('')
tab_1.p_5.dw_ap.filter()
tab_1.p_5.dw_ap.SetRedraw(TRUE)

if tab_1.p_1.dw_deduce.update(TRUE,FALSE) = -1 then
	rollback;
	Return -1
end if
if tab_1.p_5.dw_ap.update(TRUE,FALSE) = -1 then
	rollback;
	Return -1
end if

delete from v_pila where nomina=:nomina and usuario=:usuario;
commit;

tab_n.tpn_1.dw_nomcab.triggerEvent(rowfocuschanged!)
hpb_1.Visible = false
messagebox('Atención', 'Proceso finalizado') 
end event

type dw_nelec from uo_datawindow within w_nomina
boolean visible = false
integer x = 5170
integer y = 120
integer width = 375
integer height = 92
integer taborder = 11
string dataobject = "dw_nomina_electronica"
boolean hscrollbar = true
boolean vscrollbar = true
end type

event itemchanged;call super::itemchanged;SetTransObject(SQLCA)
end event

type lb_1 from listbox within w_nomina
boolean visible = false
integer x = 5138
integer y = 12
integer width = 480
integer height = 108
integer taborder = 40
boolean bringtotop = true
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
borderstyle borderstyle = stylelowered!
end type

type dw_pila from datawindow within w_nomina
boolean visible = false
integer x = 4174
integer y = 76
integer width = 1605
integer height = 500
integer taborder = 280
boolean bringtotop = true
boolean enabled = false
string title = "none"
string dataobject = "dw_nom_vpila"
boolean hscrollbar = true
boolean vscrollbar = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;SetTransObject(SQLCA)
end event

type pb_9 from picturebutton within w_nomina
string tag = "&Calcular Nómina"
boolean visible = false
integer x = 4137
integer y = 552
integer width = 146
integer height = 128
integer taborder = 270
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "                $n"
string picturename = "liquida.gif"
string disabledname = "d_liquida.gif"
string powertiptext = "&Calcular Nómina"
end type

event clicked;long li_j,i,filahist,li_fila,l_i
string tipo,ls_filtro
decimal cantidad
datetime ldt_fecha_c

if tab_n.tpn_1.dw_nomcab.RowCount() = 0 then Return 0
if tab_n.tpn_1.dw_nomcab.GetItemString(tab_n.tpn_1.dw_nomcab.GetRow(),'estado') = '1' then Return 0
if tab_n.tpn_1.dw_nomcab.GetItemString(tab_n.tpn_1.dw_nomcab.GetRow(),'estado') = '2' then Return 0
if tab_n.tpn_1.dw_nomcab.GetItemString(tab_n.tpn_1.dw_nomcab.GetRow(),'tipo') = 'R' then Return 0

li_j=tab_n.tpn_1.dw_nomcab.getitemnumber(tab_n.tpn_1.dw_nomcab.GetRow(),'num_nomina')

select recal into :ls_filtro 
from nom_cab
where num_nomina=:li_j;

if ls_filtro ='1' then 
	messagebox("Atención",'Proceso de Recalculo en otra Estación no se puede iniciar este proceso')
	Return 0
end if

ldt_fecha_c=datetime(today(),now())
update nom_cab set recal='1',fecha_calculo=:ldt_fecha_c
where num_nomina=:li_j;
if sqlca.sqlcode=-1 then
	messagebox("Error Actualizando cabeza linea 16",sqlca.sqlerrtext)
	rollback;
	return 0
end if
commit;

if not tab_1.p_2.rb_amb.checked then
	for li_j = 1 to tab_n.tpn_2.dw_empnom.RowCount()
		if tab_n.tpn_2.dw_empnom.GetItemNumber(li_j,'sel') = 1 then
			tab_n.tpn_2.dw_empnom.ScrolltoRow(li_j)
			tab_n.tpn_2.dw_empnom.TriggerEvent(rowfocuschanged!)
			filahist = dw_historia.Find("diasvinculado > 0",1,dw_historia.RowCount())
			if filahist = 0 and tab_1.p_2.dw_novedad.GetItemString(tab_1.p_2.dw_novedad.GetRow(),'tipo') ='L' and dw_historia.RowCount() > 0 then filahist = 1
			for i = 1 to tab_1.p_2.dw_novedad.RowCount()
				tipo = tab_1.p_2.dw_novedad.GetItemString(i,'cod_tipo_concep')
				if not (tipo = '7' or tipo = '8' or tipo = '9') then 
					if dw_historia.Describe(tab_1.p_2.dw_novedad.GetItemString(i,'sigla') + '.Coltype') = "!" then
						if not isnull(tab_1.p_2.dw_novedad.GetItemString(i,'form_calculo')) then 
							if f_addcompute( tab_1.p_2.dw_novedad.GetItemString(i,'sigla'), tab_1.p_2.dw_novedad.GetItemString(i,'form_calculo'), tab_1.p_2.dw_novedad.GetItemString(i,'form_verifica'), tab_1.p_2.dw_novedad.GetItemnumber(i,'tarifa'), tab_1.p_2.dw_novedad.GetItemnumber(i,'tarifa_esp'),1) = -1 then  Return
						end if
					end if
					dw_historia.SetItem(filahist,get_parm_nov(tab_1.p_2.dw_novedad.GetItemString(i,'sigla')),tab_1.p_2.dw_novedad.GetItemNumber(i,'cantidad_ac'))
					dw_historia.SetItem(filahist, f_get_ctrl(tab_1.p_2.dw_novedad.GetItemString(i,'sigla')),1)
					if dw_historia.Describe(tab_1.p_2.dw_novedad.GetItemString(i,'sigla') + ".coltype") <> '!' then
						cantidad = round(dw_historia.GetItemNumber(filahist,tab_1.p_2.dw_novedad.GetItemString(i,'sigla')),0)
						if not isNull(cantidad) then
							tab_1.p_2.dw_novedad.SetItem(i,'valor_c',cantidad)
							tab_1.p_2.dw_novedad.SetItem(i,'pagado',cantidad)
							tab_1.p_2.dw_novedad.SetItem(i,'base',round(dw_historia.GetItemNumber(filahist,'b_'+tab_1.p_2.dw_novedad.GetItemString(i,'sigla')),0))
							//tab_1.p_2.dw_novedad.SetItem(i,'cantidad_ac',1)
						end if
					end if
				end if
			next
		end if
	next
	Return 0
end if

ibn_calculando = TRUE

dw_contra.Retrieve(tab_n.tpn_1.dw_nomcab.GetItemDateTime(tab_n.tpn_1.dw_nomcab.Getrow(),'inicia'),tab_n.tpn_1.dw_nomcab.GetItemDateTime(tab_n.tpn_1.dw_nomcab.Getrow(),'termina'))
tab_n.tpn_1.dw_nomcab.AcceptText() 
st_15.Visible = TRUE
hpb_1.Position = 0
hpb_1.MinPosition = 0
hpb_1.MaxPosition = long(tab_n.tpn_2.dw_empnom.Describe("Evaluate('sum(if(sel=1,1,0))',0)"))
hpb_1.SetRange ( 0, long(tab_n.tpn_2.dw_empnom.Describe("Evaluate('sum(if(sel=1,1,0))',0)")) )
hpb_1.Visible = TRUE
tab_n.tpn_2.dw_empnom.SetRedraw(FALSE)
tab_1.p_1.dw_devenga.SetRedraw(FALSE)
tab_1.p_1.dw_deduce.SetRedraw(FALSE)
tab_1.p_2.dw_novedad.SetRedraw(FALSE)
tab_1.p_5.dw_ap.SetRedraw(FALSE)
for li_j = 1 to tab_n.tpn_2.dw_empnom.RowCount()
	if tab_n.tpn_2.dw_empnom.GetItemNumber(li_j,'sel') = 1 then
		tab_n.tpn_2.dw_empnom.ScrolltoRow(li_j)
		tab_n.tpn_2.dw_empnom.TriggerEvent(rowfocuschanged!)
		if tab_1.p_2.dw_novedad.RowCount() > 0 then
			tab_1.p_2.dw_novedad.SetFilter("tipodoc='"+tab_n.tpn_2.dw_empnom.GetItemString(tab_n.tpn_2.dw_empnom.GetRow(),'tipodoc')+"' and documento='"+tab_n.tpn_2.dw_empnom.GetItemString(tab_n.tpn_2.dw_empnom.GetRow(),'documento')+"' and (cod_tipo_concep='7' or cod_tipo_concep='8')")
			tab_1.p_2.dw_novedad.Filter()
			do while tab_1.p_2.dw_novedad.RowCount() > 0
				li_fila=tab_1.p_2.dw_novedad.GetRow()
				ls_filtro="num_nomina="+string(tab_1.p_2.dw_novedad.getitemnumber(li_fila,'num_nomina'))+' and '
				ls_filtro=ls_filtro+"tipodoc_n='"+tab_1.p_2.dw_novedad.getitemstring(li_fila,'tipodoc')+"' and "
				ls_filtro=ls_filtro+"documento_n='"+tab_1.p_2.dw_novedad.getitemstring(li_fila,'documento')+"' and "
				ls_filtro=ls_filtro+"cod_concep='"+tab_1.p_2.dw_novedad.getitemstring(li_fila,'cod_concep')+"' and "
				ls_filtro=ls_filtro+"item_n="+string(tab_1.p_2.dw_novedad.getitemnumber(li_fila,'item'))
				dw_ausend.setfilter(ls_filtro)
				dw_ausend.filter()
				for l_i=1 to dw_ausend.rowcount()
					dw_ausend.DeleteRow(1)
				next
				tab_1.p_2.dw_novedad.DeleteRow(1)
			loop
			dw_ausend.setfilter('')
			dw_ausend.filter()
			tab_1.p_2.dw_novedad.SetFilter("tipodoc='"+tab_n.tpn_2.dw_empnom.GetItemString(tab_n.tpn_2.dw_empnom.GetRow(),'tipodoc')+"' and documento='"+tab_n.tpn_2.dw_empnom.GetItemString(tab_n.tpn_2.dw_empnom.GetRow(),'documento')+"'")
			tab_1.p_2.dw_novedad.Filter()			
		end if
		
		if nomcalc(tab_n.tpn_2.dw_empnom.GetItemString(li_j,'tipodoc'), tab_n.tpn_2.dw_empnom.GetItemString(li_j,'documento'),tab_n.tpn_1.dw_nomcab.GetItemstring(tab_n.tpn_1.dw_nomcab.Getrow(),'esp'),tab_n.tpn_1.dw_nomcab.GetItemstring(tab_n.tpn_1.dw_nomcab.Getrow(),'tipo')) < 0 then
			tab_n.tpn_2.dw_empnom.SetRedraw(TRUE)
			tab_1.p_1.dw_devenga.SetRedraw(TRUE)
			tab_1.p_1.dw_deduce.SetRedraw(TRUE)
			tab_1.p_2.dw_novedad.SetRedraw(TRUE)
			tab_1.p_5.dw_ap.SetRedraw(TRUE)
			hpb_1.Visible = FALSE
			ibn_calculando = FALSE
			st_15.visible = FALSE
			Return -1
		end if
		hpb_1.Position = li_j
	end if
	if mod(li_j,5) = 0 then Garbagecollect()
	Yield()
	if ibn_cancelar then
		ibn_cancelar= FALSE
		if MessageBox('Atención','Está seguro de cancelar el procesamiento de la nómina?',QUESTION!,YESNO!) = 1 then 
			EXIT
		end if
	end if
Next
tab_n.tpn_2.dw_empnom.SetRedraw(TRUE)
tab_1.p_1.dw_devenga.SetRedraw(TRUE)
tab_1.p_1.dw_deduce.SetRedraw(TRUE)
tab_1.p_2.dw_novedad.SetRedraw(TRUE)
tab_1.p_5.dw_ap.SetRedraw(TRUE)
calctotal()
tab_1.p_3.dw_plan.TriggerEvent(rowfocuschanged!)
tab_1.p_4.dw_acab.TriggerEvent(rowfocuschanged!)
update nom_cab set recal='0',fecha_calculo=:ldt_fecha_c
where num_nomina=:li_j;
if sqlca.sqlcode=-1 then
	messagebox("Error Actualizando cabeza linea 130",sqlca.sqlerrtext)
	rollback;
	return 0
end if
commit;

st_15.Visible = FALSE
hpb_1.Visible = FALSE
hpb_1.Position = 0
ibn_calculando = FALSE
cambio = TRUE
Return 0

end event

type dw_empact from datawindow within w_nomina
boolean visible = false
integer x = 4000
integer y = 152
integer width = 398
integer height = 164
boolean enabled = false
string dataobject = "dw_empact"
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

type dw_aus from datawindow within w_nomina
boolean visible = false
integer x = 64
integer y = 2136
integer width = 498
integer height = 100
integer taborder = 30
boolean bringtotop = true
string title = "none"
string dataobject = "dw_ausentismo_all"
boolean hscrollbar = true
boolean vscrollbar = true
boolean resizable = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;setTransObject(SQLCA)

end event

type dw_historia_bak from datawindow within w_nomina
boolean visible = false
integer x = 4151
integer y = 848
integer width = 1563
integer height = 336
string title = "none"
string dataobject = "dw_historia"
boolean hscrollbar = true
boolean vscrollbar = true
boolean resizable = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event retrieveend;long i, filas, sal_ant, ub_ant, sal, ub, f_sal_ant, f_ub_ant, k, car, car_ant, f_car_ant
datetime fec_sal, fec_nul, fec_ubic, fec_car

setNull(fec_nul)
setNull(fec_sal)
setNull(fec_ubic)
filas = this.RowCount()

for i = 1 to filas
	this.SetItem(i,'salario_fecha_term',fec_nul)
	this.SetItem(i,'fec_term_ubica',fec_nul)
	sal =  GetItemNumber(i,'nsalario')
	ub = GetItemNumber(i,'ntraslado')
	car = GetItemNumber(i,'ncargo')
	
	if car_ant <> car then
		if car_ant = 0 then
			if isNull(GetItemDateTime(i,'fecha_termina')) then 
				setNull(fec_car)
			else
				fec_car = this.GetItemDateTime(i,'fecha_termina')
			end if
		else
			fec_car = datetime(RelativeDate(date(this.GetItemDateTime(f_car_ant,'fecha_inicio')), -1))
		end if
		f_car_ant = i
	end if
	this.SetItem(i,'fecha_termina', fec_car )
	car_ant = GetItemNumber(i,'ncargo')

	if sal_ant <> sal then
		if sal_ant = 0 then
			setNull(fec_sal)
		else
			fec_sal = datetime(RelativeDate(date(this.GetITemDateTime(f_sal_ant,'salario_fecha_inicio')), -1))
		end if
		f_sal_ant = i
	end if
	this.SetItem(i,'salario_fecha_term', fec_sal )
	sal_ant = GetItemNumber(i,'nsalario')
	
	if ub_ant <> ub then
		if ub_ant = 0 then
			setNull(fec_ubic)
		elseif GetItemDateTime(f_ub_ant,'fec_ini_ubica') < GetItemDateTime(i,'fec_ini_ubica') then
			setNull(fec_ubic)
		else
			fec_ubic = datetime(RelativeDate(date(this.GetItemDateTime(f_ub_ant,'fec_ini_ubica')), -1))
		end if
		f_ub_ant = i
	end if
	this.SetItem(i,'fec_term_ubica', fec_ubic )
	ub_ant = GetItemNumber(i,'ntraslado')
	this.SetItem(i,'fecini_nom',tab_n.tpn_1.dw_nomcab.GetItemDateTime(tab_n.tpn_1.dw_nomcab.GetRow(),'inicia'))
	this.SetItem(i,'fecfin_nom',tab_n.tpn_1.dw_nomcab.GetItemDateTime(tab_n.tpn_1.dw_nomcab.GetRow(),'termina'))
next
if dw_historia.rowcount() > 0 then
	f_tiempos()
end if

end event

event constructor;SetTransObject(SQLCA)


end event

event clicked;//if not isNull(dwo) then
//	w_principal.SetMicroHelp ( string(dwo.name) + ' - '+Describe(string(dwo.name) + '.Coltype') )
//end if
//
end event

